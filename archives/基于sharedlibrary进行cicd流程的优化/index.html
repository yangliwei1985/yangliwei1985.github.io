<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ– | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ– ç”±äºå…¬å¸å†…éƒ¨é¡¹ç›®ä¼—å¤šï¼Œå¤§é‡çš„é¡¹ç›®ä½¿ç”¨åŒä¸€å¥—æµç¨‹åšCICD
 é‚£ä¹ˆåŠ¿å¿…ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤ä»£ç  ä¸€æ—¦æŸä¸ªå…¬å…±çš„åœ°æ–¹éœ€è¦åšè°ƒæ•´ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ä¿®æ”¹  å› æ­¤æœ¬ç« ä¸»è¦é€šè¿‡ä½¿ç”¨groovyå®ç°Jenkinsçš„sharedLibraryçš„å¼€å‘ï¼Œä»¥æå–é¡¹ç›®åœ¨CICDå®è·µè¿‡ç¨‹ä¸­çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ä¸€ç³»åˆ—çš„æµç¨‹çš„æ¥å£ä¾›å…¬å¸å†…å„é¡¹ç›®è°ƒç”¨ã€‚
å¼€å‘å®Œæˆåï¼Œå¯¹é¡¹ç›®è¿›è¡ŒJenkinsfileçš„æ”¹é€ ï¼Œæœ€åä»…éœ€é€šè¿‡ç®€å•çš„Jenkinsfileçš„é…ç½®ï¼Œå³å¯ä¼˜é›…çš„å®ŒæˆCICDæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ­¤æ–¹å¼å·²åœ¨å¤§å‹ä¼ä¸šå†…éƒ¨è½åœ°åº”ç”¨ã€‚
Libraryå·¥ä½œæ¨¡å¼ ç”±äºæµæ°´çº¿è¢«ç»„ç»‡ä¸­è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®æ‰€é‡‡ç”¨ï¼Œå¸¸è§çš„æ¨¡å¼å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚ åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«æµæ°´çº¿æœ‰åŠ©äºå‡å°‘å†—ä½™å¹¶ä¿æŒä»£ç  &ldquo;DRY&rdquo;ã€‚
æµæ°´çº¿æ”¯æŒå¼•ç”¨ &ldquo;å…±äº«åº“&rdquo; ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æºä»£ç æ§åˆ¶ä»“åº“ä¸­å®šä¹‰å¹¶åŠ è½½åˆ°ç°æœ‰çš„æµæ°´çº¿ä¸­ã€‚
@Library(&#39;my-shared-library&#39;) _ åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠlibraryä¸­å®šä¹‰çš„groovyåŠŸèƒ½æ·»åŠ åˆ°æ„å»ºç›®å½•ä¸­ï¼š
/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy ä½¿ç”¨libraryåï¼ŒJenkinsfileå¤§è‡´çš„æ ·å­å¦‚ä¸‹ï¼š
@Library(&#39;my-shared-library&#39;) _  ...  stages {  stage(&#39;build image&#39;) {  steps {  container(&#39;tools&#39;) {  devops.buildImage(&#34;Dockerfile&#34;,&#34;172.21.51.67:5000/demo:latest&#34;)  }  }  }  }   post {  success {  script {  container(&#39;tools&#39;) {  devops.notificationSuccess(&#34;dingTalk&#34;)  }  }  }  } .">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–" />
<meta property="og:description" content="åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ– ç”±äºå…¬å¸å†…éƒ¨é¡¹ç›®ä¼—å¤šï¼Œå¤§é‡çš„é¡¹ç›®ä½¿ç”¨åŒä¸€å¥—æµç¨‹åšCICD
 é‚£ä¹ˆåŠ¿å¿…ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤ä»£ç  ä¸€æ—¦æŸä¸ªå…¬å…±çš„åœ°æ–¹éœ€è¦åšè°ƒæ•´ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ä¿®æ”¹  å› æ­¤æœ¬ç« ä¸»è¦é€šè¿‡ä½¿ç”¨groovyå®ç°Jenkinsçš„sharedLibraryçš„å¼€å‘ï¼Œä»¥æå–é¡¹ç›®åœ¨CICDå®è·µè¿‡ç¨‹ä¸­çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ä¸€ç³»åˆ—çš„æµç¨‹çš„æ¥å£ä¾›å…¬å¸å†…å„é¡¹ç›®è°ƒç”¨ã€‚
å¼€å‘å®Œæˆåï¼Œå¯¹é¡¹ç›®è¿›è¡ŒJenkinsfileçš„æ”¹é€ ï¼Œæœ€åä»…éœ€é€šè¿‡ç®€å•çš„Jenkinsfileçš„é…ç½®ï¼Œå³å¯ä¼˜é›…çš„å®ŒæˆCICDæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ­¤æ–¹å¼å·²åœ¨å¤§å‹ä¼ä¸šå†…éƒ¨è½åœ°åº”ç”¨ã€‚
Libraryå·¥ä½œæ¨¡å¼ ç”±äºæµæ°´çº¿è¢«ç»„ç»‡ä¸­è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®æ‰€é‡‡ç”¨ï¼Œå¸¸è§çš„æ¨¡å¼å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚ åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«æµæ°´çº¿æœ‰åŠ©äºå‡å°‘å†—ä½™å¹¶ä¿æŒä»£ç  &ldquo;DRY&rdquo;ã€‚
æµæ°´çº¿æ”¯æŒå¼•ç”¨ &ldquo;å…±äº«åº“&rdquo; ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æºä»£ç æ§åˆ¶ä»“åº“ä¸­å®šä¹‰å¹¶åŠ è½½åˆ°ç°æœ‰çš„æµæ°´çº¿ä¸­ã€‚
@Library(&#39;my-shared-library&#39;) _ åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠlibraryä¸­å®šä¹‰çš„groovyåŠŸèƒ½æ·»åŠ åˆ°æ„å»ºç›®å½•ä¸­ï¼š
/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy ä½¿ç”¨libraryåï¼ŒJenkinsfileå¤§è‡´çš„æ ·å­å¦‚ä¸‹ï¼š
@Library(&#39;my-shared-library&#39;) _  ...  stages {  stage(&#39;build image&#39;) {  steps {  container(&#39;tools&#39;) {  devops.buildImage(&#34;Dockerfile&#34;,&#34;172.21.51.67:5000/demo:latest&#34;)  }  }  }  }   post {  success {  script {  container(&#39;tools&#39;) {  devops.notificationSuccess(&#34;dingTalk&#34;)  }  }  }  } ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-10T18:27:44&#43;00:00" />
<meta property="article:modified_time" content="2022-01-10T18:27:44&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–"/>
<meta name="twitter:description" content="åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ– ç”±äºå…¬å¸å†…éƒ¨é¡¹ç›®ä¼—å¤šï¼Œå¤§é‡çš„é¡¹ç›®ä½¿ç”¨åŒä¸€å¥—æµç¨‹åšCICD
 é‚£ä¹ˆåŠ¿å¿…ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤ä»£ç  ä¸€æ—¦æŸä¸ªå…¬å…±çš„åœ°æ–¹éœ€è¦åšè°ƒæ•´ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ä¿®æ”¹  å› æ­¤æœ¬ç« ä¸»è¦é€šè¿‡ä½¿ç”¨groovyå®ç°Jenkinsçš„sharedLibraryçš„å¼€å‘ï¼Œä»¥æå–é¡¹ç›®åœ¨CICDå®è·µè¿‡ç¨‹ä¸­çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ä¸€ç³»åˆ—çš„æµç¨‹çš„æ¥å£ä¾›å…¬å¸å†…å„é¡¹ç›®è°ƒç”¨ã€‚
å¼€å‘å®Œæˆåï¼Œå¯¹é¡¹ç›®è¿›è¡ŒJenkinsfileçš„æ”¹é€ ï¼Œæœ€åä»…éœ€é€šè¿‡ç®€å•çš„Jenkinsfileçš„é…ç½®ï¼Œå³å¯ä¼˜é›…çš„å®ŒæˆCICDæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ­¤æ–¹å¼å·²åœ¨å¤§å‹ä¼ä¸šå†…éƒ¨è½åœ°åº”ç”¨ã€‚
Libraryå·¥ä½œæ¨¡å¼ ç”±äºæµæ°´çº¿è¢«ç»„ç»‡ä¸­è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®æ‰€é‡‡ç”¨ï¼Œå¸¸è§çš„æ¨¡å¼å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚ åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«æµæ°´çº¿æœ‰åŠ©äºå‡å°‘å†—ä½™å¹¶ä¿æŒä»£ç  &ldquo;DRY&rdquo;ã€‚
æµæ°´çº¿æ”¯æŒå¼•ç”¨ &ldquo;å…±äº«åº“&rdquo; ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æºä»£ç æ§åˆ¶ä»“åº“ä¸­å®šä¹‰å¹¶åŠ è½½åˆ°ç°æœ‰çš„æµæ°´çº¿ä¸­ã€‚
@Library(&#39;my-shared-library&#39;) _ åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠlibraryä¸­å®šä¹‰çš„groovyåŠŸèƒ½æ·»åŠ åˆ°æ„å»ºç›®å½•ä¸­ï¼š
/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy ä½¿ç”¨libraryåï¼ŒJenkinsfileå¤§è‡´çš„æ ·å­å¦‚ä¸‹ï¼š
@Library(&#39;my-shared-library&#39;) _  ...  stages {  stage(&#39;build image&#39;) {  steps {  container(&#39;tools&#39;) {  devops.buildImage(&#34;Dockerfile&#34;,&#34;172.21.51.67:5000/demo:latest&#34;)  }  }  }  }   post {  success {  script {  container(&#39;tools&#39;) {  devops.notificationSuccess(&#34;dingTalk&#34;)  }  }  }  } ."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–",
      "item": "https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–",
  "name": "åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–",
  "description": "åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ– ç”±äºå…¬å¸å†…éƒ¨é¡¹ç›®ä¼—å¤šï¼Œå¤§é‡çš„é¡¹ç›®ä½¿ç”¨åŒä¸€å¥—æµç¨‹åšCICD\n é‚£ä¹ˆåŠ¿å¿…ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤ä»£ç  ä¸€æ—¦æŸä¸ªå…¬å…±çš„åœ°æ–¹éœ€è¦åšè°ƒæ•´ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ä¿®æ”¹  å› æ­¤æœ¬ç« ä¸»è¦é€šè¿‡ä½¿ç”¨groovyå®ç°Jenkinsçš„sharedLibraryçš„å¼€å‘ï¼Œä»¥æå–é¡¹ç›®åœ¨CICDå®è·µè¿‡ç¨‹ä¸­çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ä¸€ç³»åˆ—çš„æµç¨‹çš„æ¥å£ä¾›å…¬å¸å†…å„é¡¹ç›®è°ƒç”¨ã€‚\nå¼€å‘å®Œæˆåï¼Œå¯¹é¡¹ç›®è¿›è¡ŒJenkinsfileçš„æ”¹é€ ï¼Œæœ€åä»…éœ€é€šè¿‡ç®€å•çš„Jenkinsfileçš„é…ç½®ï¼Œå³å¯ä¼˜é›…çš„å®ŒæˆCICDæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ­¤æ–¹å¼å·²åœ¨å¤§å‹ä¼ä¸šå†…éƒ¨è½åœ°åº”ç”¨ã€‚\nLibraryå·¥ä½œæ¨¡å¼ ç”±äºæµæ°´çº¿è¢«ç»„ç»‡ä¸­è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®æ‰€é‡‡ç”¨ï¼Œå¸¸è§çš„æ¨¡å¼å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚ åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«æµæ°´çº¿æœ‰åŠ©äºå‡å°‘å†—ä½™å¹¶ä¿æŒä»£ç  \u0026ldquo;DRY\u0026rdquo;ã€‚\næµæ°´çº¿æ”¯æŒå¼•ç”¨ \u0026ldquo;å…±äº«åº“\u0026rdquo; ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æºä»£ç æ§åˆ¶ä»“åº“ä¸­å®šä¹‰å¹¶åŠ è½½åˆ°ç°æœ‰çš„æµæ°´çº¿ä¸­ã€‚\n@Library(\u0026#39;my-shared-library\u0026#39;) _ åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠlibraryä¸­å®šä¹‰çš„groovyåŠŸèƒ½æ·»åŠ åˆ°æ„å»ºç›®å½•ä¸­ï¼š\n/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy ä½¿ç”¨libraryåï¼ŒJenkinsfileå¤§è‡´çš„æ ·å­å¦‚ä¸‹ï¼š\n@Library(\u0026#39;my-shared-library\u0026#39;) _  ...  stages {  stage(\u0026#39;build image\u0026#39;) {  steps {  container(\u0026#39;tools\u0026#39;) {  devops.buildImage(\u0026#34;Dockerfile\u0026#34;,\u0026#34;172.21.51.67:5000/demo:latest\u0026#34;)  }  }  }  }   post {  success {  script {  container(\u0026#39;tools\u0026#39;) {  devops.notificationSuccess(\u0026#34;dingTalk\u0026#34;)  }  }  }  } .",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ– ç”±äºå…¬å¸å†…éƒ¨é¡¹ç›®ä¼—å¤šï¼Œå¤§é‡çš„é¡¹ç›®ä½¿ç”¨åŒä¸€å¥—æµç¨‹åšCICD\n é‚£ä¹ˆåŠ¿å¿…ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤ä»£ç  ä¸€æ—¦æŸä¸ªå…¬å…±çš„åœ°æ–¹éœ€è¦åšè°ƒæ•´ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ä¿®æ”¹  å› æ­¤æœ¬ç« ä¸»è¦é€šè¿‡ä½¿ç”¨groovyå®ç°Jenkinsçš„sharedLibraryçš„å¼€å‘ï¼Œä»¥æå–é¡¹ç›®åœ¨CICDå®è·µè¿‡ç¨‹ä¸­çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ä¸€ç³»åˆ—çš„æµç¨‹çš„æ¥å£ä¾›å…¬å¸å†…å„é¡¹ç›®è°ƒç”¨ã€‚\nå¼€å‘å®Œæˆåï¼Œå¯¹é¡¹ç›®è¿›è¡ŒJenkinsfileçš„æ”¹é€ ï¼Œæœ€åä»…éœ€é€šè¿‡ç®€å•çš„Jenkinsfileçš„é…ç½®ï¼Œå³å¯ä¼˜é›…çš„å®ŒæˆCICDæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ­¤æ–¹å¼å·²åœ¨å¤§å‹ä¼ä¸šå†…éƒ¨è½åœ°åº”ç”¨ã€‚\nLibraryå·¥ä½œæ¨¡å¼ ç”±äºæµæ°´çº¿è¢«ç»„ç»‡ä¸­è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®æ‰€é‡‡ç”¨ï¼Œå¸¸è§çš„æ¨¡å¼å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚ åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«æµæ°´çº¿æœ‰åŠ©äºå‡å°‘å†—ä½™å¹¶ä¿æŒä»£ç  â€œDRYâ€ã€‚\næµæ°´çº¿æ”¯æŒå¼•ç”¨ â€œå…±äº«åº“â€ ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æºä»£ç æ§åˆ¶ä»“åº“ä¸­å®šä¹‰å¹¶åŠ è½½åˆ°ç°æœ‰çš„æµæ°´çº¿ä¸­ã€‚\n@Library('my-shared-library') _ åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠlibraryä¸­å®šä¹‰çš„groovyåŠŸèƒ½æ·»åŠ åˆ°æ„å»ºç›®å½•ä¸­ï¼š\n/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy ä½¿ç”¨libraryåï¼ŒJenkinsfileå¤§è‡´çš„æ ·å­å¦‚ä¸‹ï¼š\n@Library('my-shared-library') _  ...  stages {  stage('build image') {  steps {  container('tools') {  devops.buildImage(\"Dockerfile\",\"172.21.51.67:5000/demo:latest\")  }  }  }  }   post {  success {  script {  container('tools') {  devops.notificationSuccess(\"dingTalk\")  }  }  }  } ... å¼€å‘ç¯å¢ƒæ­å»º è¡¥å½•ç« èŠ‚ï¼šGroovyåŠSpringBootã€SpringCloudéƒ½ä¼šä½¿ç”¨\n java groovy intelliJ idea  ä¸‹è½½å®‰è£…åŒ… é“¾æ¥ï¼šhttps://pan.baidu.com/s/1B-bg2_IsB8dU7_62IEtnTg æå–ç ï¼šwx6j\nå®‰è£…java å®‰è£…è·¯å¾„ï¼šD:\\software\\jdk\nç¯å¢ƒå˜é‡ï¼š\n JAVA_HOME D:\\software\\jdk CLASSPATH .;%JAVA_HOME%\\lib\\dt.jar;%JAVA_HOME%\\lib\\tools.jar; PATH %JAVA_HOME%\\bin  å®‰è£…groovy è§£å‹è·¯å¾„ï¼šD:\\software\\groovy-3.0.2\nç¯å¢ƒå˜é‡ï¼š\n GROOVY_PATH D:\\software\\groovy-3.0.2 PATH D:\\software\\groovy-3.0.2\\bin  å®‰è£…idea å®‰è£…è·¯å¾„ï¼šD:\\software\\IntelliJ IDEA 2019.2.3\næ–°å»ºé¡¹ç›®æµ‹è¯•\nLibraryä»£ç ç»“æ„ä»‹ç» å…±äº«åº“çš„ç›®å½•ç»“æ„å¦‚ä¸‹:\n(root) +- src # Groovy source files | +- org | +- foo | +- Bar.groovy # for org.foo.Bar class +- vars | +- foo.groovy # for global 'foo' variable | +- foo.txt # help for 'foo' variable src ç›®å½•åº”è¯¥çœ‹èµ·æ¥åƒæ ‡å‡†çš„ Java æºç›®å½•ç»“æ„ã€‚å½“æ‰§è¡Œæµæ°´çº¿æ—¶ï¼Œè¯¥ç›®å½•è¢«æ·»åŠ åˆ°ç±»è·¯å¾„ä¸‹ã€‚\nvars ç›®å½•å®šä¹‰å¯ä»æµæ°´çº¿è®¿é—®çš„å…¨å±€å˜é‡çš„è„šæœ¬ã€‚ æ¯ä¸ª *.groovy æ–‡ä»¶çš„åŸºååº”è¯¥æ˜¯ä¸€ä¸ª Groovy (~ Java) æ ‡è¯†ç¬¦, é€šå¸¸æ˜¯ camelCasedã€‚\nGroovyåŸºæœ¬è¯­æ³•ä»‹ç» æ–°å»ºGroovyé¡¹ç›®\n  å˜é‡\nä½¿ç”¨æ•°æ®ç±»å‹çš„æœ¬åœ°è¯­æ³•ï¼Œæˆ–è€…ä½¿ç”¨defå…³é”®å­—\n// Defining a variable in lowercase int x = 5;  // Defining a variable in uppercase int X = 6;  // Defining a variable with the underscore in it's name def _Name = \"Joe\";  println(x); println(X); println(_Name);   æ–¹æ³•\n  è°ƒç”¨æœ¬åœ°æ–¹æ³•\ndef sum(int a, int b){  return a + b }  println(sum(1,2))   è°ƒç”¨ç±»ä¸­çš„æ–¹æ³•\n# Hello.groovy package demo  def sayHi(String content) {  return (\"hi, \" + content) }    # Demo.groovy import demo.Hello  def demo() {  return new Hello().sayHi(\"devops\") } println(demo())    # çº§è”è°ƒç”¨ # Hello.groovy package demo  def init(String content) {  this.content = content  return this }  def sayHi() {  println(\"hi, \" + this.content)  return this }  def sayBye() {  println(\"bye \" + this.content) }   # Demo.groovy import demo.Hello  def demo() {  new Hello().init(\"devops\").sayHi().sayBye() }  demo()     å¼‚å¸¸æ•è·\ndef exceptionDemo(){  try {  def val = 10 / 0  println(val)  }catch(Exception e) {  println(e.toString())  throw e  } } exceptionDemo()   è®¡æ—¶å™¨ä¸å¾ªç¯\nimport groovy.time.TimeCategory   use( TimeCategory ) {  def endTime = TimeCategory.plus(new Date(), TimeCategory.getSeconds(15))  def counter = 0  while(true) {  println(counter++)  sleep(1000)  if (new Date() = endTime) {  println(\"done\")  break  }  } }   è§£æyamlæ–‡ä»¶\nimport org.yaml.snakeyaml.Yaml  def readYaml(){  def content = new File('myblog.yaml').text  Yaml parser = new Yaml()  def data = parser.load(content)  def kind = data[\"kind\"]  def name = data[\"metadata\"][\"name\"]  println(kind)  println(name) } readYaml()   libraryä¸Jenkinsé›†æˆ å…ˆæ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨shared libraryå®ç°æœ€ç®€å•çš„helloworldè¾“å‡ºåŠŸèƒ½ï¼Œæ¥ç†æ¸…æ¥šä½¿ç”¨shared libraryçš„æµç¨‹ã€‚\nHello.groovy package com.luffy.devops  /** * @author Yongxin * @version v0.1 */  /** * say hello * @param content */ def hello(String content) {  this.content = content  return this }   def sayHi() {  echo \"Hi, ${this.content},how are you?\"  return this }  def answer() {  echo \"${this.content}: fine, thank you, and you?\"  return this }  def sayBye() {  echo \"i am fine too , ${this.content}, Bye!\"  return this } åœ¨gitlabåˆ›å»ºé¡¹ç›®ï¼ŒæŠŠlibraryä»£ç æ¨é€åˆ°é•œåƒä»“åº“ã€‚\né…ç½®Jenkins [ç³»ç»Ÿç®¡ç†] - [ç³»ç»Ÿè®¾ç½®] - [ Global Pipeline Libraries ]\n Library Nameï¼šluffy-devops Default Versionï¼šmaster Source Code Managementï¼šGit  Jenkinsfileä¸­å¼•ç”¨ jenkins/pipelines/p11.yaml\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}   stages {  stage('hello-devops') {  steps {  script {  devops.hello(\"æ ‘å“¥\").sayHi().answer().sayBye()  }  }  }  }  post {  success {  echo 'Congratulations!'  }  failure {  echo 'Oh no!'  }  always {  echo 'I will always say Hello again!'  }  } } åˆ›å»ºvars/devops.groovy\nimport com.luffy.devops.Hello  def hello(String content) {  return new Hello().hello(content) } libraryé›†æˆé•œåƒæ„å»ºåŠæ¨é€ éœ€è¦å®ç°çš„é€»è¾‘ç‚¹ï¼š\n docker buildï¼Œdocker pushï¼Œdocker login è´¦æˆ·å¯†ç ï¼Œjenkinså‡­æ®ï¼Œï¼ˆlibraryä¸­è·å–å‡­æ®å†…å®¹ï¼‰ï¼Œ docker login 172.21.51.67:5000 try catch  é•œåƒæ„å»ºé€»è¾‘å®ç° devops.groovy\n/** * * @param repo, 172.21.51.67:5000/demo/myblog/xxx/ * @param tag, v1.0 * @param dockerfile * @param credentialsId * @param context */ def docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\") {  return new Docker().docker(repo, tag, credentialsId, dockerfile, context) } Docker.groovy\né€»è¾‘ä¸­éœ€è¦æ³¨æ„çš„ç‚¹ï¼š\n æ„å»ºå’Œæ¨é€é•œåƒï¼Œéœ€è¦ç™»å½•ä»“åº“ï¼ˆéœ€è¦è®¤è¯ï¼‰ æ„å»ºæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œéœ€è¦å°†ç»“æœæ¨ç»™gitlabç«¯ ä¸ºäº†å°†æ„å»ºè¿‡ç¨‹æ¨é€åˆ°é’‰é’‰æ¶ˆæ¯ä¸­ï¼Œéœ€è¦å°†æ„å»ºä¿¡æ¯ç»Ÿä¸€æ”¶é›†  package com.luffy.devops  /**  *  * @param repo  * @param tag  * @param credentialsId  * @param dockerfile  * @param context  * @return  */ def docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){  this.repo = repo  this.tag = tag  this.dockerfile = dockerfile  this.credentialsId = credentialsId  this.context = context  this.fullAddress = \"${this.repo}:${this.tag}\"  this.isLoggedIn = false  return this }   /**  * build image  * @return  */ def build() {  this.login()  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} \"  }catch (Exception exc) {  throw exc  }  return this  } }   /**  * push image  * @return  */ def push() {  this.login()  retry(3) {  try {  sh \"docker push ${this.fullAddress}\"  }catch (Exception exc) {  throw exc  }  }  return this }  /**  * docker registry login  * @return  */ def login() {  if(this.isLoggedIn || credentialsId == \"\"){  return this  }  // docker login  withCredentials([usernamePassword(credentialsId: this.credentialsId, usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {  def regs = this.getRegistry()  retry(3) {  try {  sh \"docker login ${regs} -u $USERNAME -p $PASSWORD\"  } catch (Exception exc) {  echo \"docker login err, \" + exc.toString()  }  }  }  this.isLoggedIn = true;  return this; }  /**  * get registry server  * @return  */ def getRegistry(){  def sp = this.repo.split(\"/\")  if (sp.size()  1) {  return sp[0]  }  return this.repo } Jenkinsfile\néœ€è¦å…ˆåœ¨Jenkinsç«¯åˆ›å»ºä»“åº“ç™»å½•å‡­æ®credential-registry\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  }  post {  success {  echo 'Congratulations!'  }  failure {  echo 'Oh no!'  }  } } ä¸°å¯Œæ„å»ºé€šçŸ¥é€»è¾‘ ç›®å‰çš„æ„å»ºé•œåƒé€»è¾‘ä¸­ç¼ºå°‘å¦‚ä¸‹å†…å®¹ï¼š\n tryé€»è¾‘ä¸­ï¼Œè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ˜¯å¦è¯¥æŠŠå¼‚å¸¸æŠ›å‡º  è‹¥ç›´æ¥æŠ›å‡ºå¼‚å¸¸å¯èƒ½ä¼šå¯¼è‡´å¤šæ¬¡é‡å¤çš„å¼‚å¸¸ä¿¡æ¯ è‹¥ä¸æŠ›å‡ºï¼Œåˆ™å¦‚æœæœªæ„å»ºæˆåŠŸé•œåƒï¼Œæµæ°´çº¿æ„ŸçŸ¥ä¸åˆ°é”™è¯¯   é€šçŸ¥gitlabç«¯æ„å»ºä»»åŠ¡åŠçŠ¶æ€ æ„å»ºé€šçŸ¥æ ¼å¼  éœ€è¦é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œåšå‡ºä¼˜åŒ–\n  ä¼˜åŒ–tryé€»è¾‘\ndef build() {  this.login()  def isSuccess = false  def errMsg  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile}\"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  // check if build success  if(isSuccess){  //todo  }else {  // throw exceptionï¼Œaborted pipeline  error errMsg  }  return this  } }   é€šçŸ¥gitlabç«¯æ„å»ºä»»åŠ¡åŠçŠ¶æ€\ndef build() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} \"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  // check if build success  def stage = env.STAGE_NAME + '-build'  if(isSuccess){  updateGitlabCommitStatus(name: '${stage}', state: 'success')  }else {  updateGitlabCommitStatus(name: '${stage}', state: 'failed')  // throw exceptionï¼Œaborted pipeline  error errMsg  }   return this  } }   é’‰é’‰æ¶ˆæ¯é€šçŸ¥æ ¼å¼\nç”±äºæ¯ä¸ªstageéƒ½éœ€è¦æ„å»ºé€šçŸ¥ä»»åŠ¡ï¼Œå› æ­¤æŠ½æˆå…¬å…±çš„é€»è¾‘ï¼Œä¸ºå„stageè°ƒç”¨\nBuildMessage.groovy\npackage com.luffy.devops  def updateBuildMessage(String source, String add) {  if(!source){  source = \"\"  }  env.BUILD_TASKS = source + add + \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  return env.BUILD_TASKS } Docker.groovy ä¸­è°ƒç”¨\ndef getObject(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){ \t...  this.msg = new BuildMessage()  return this }   ...  def build() { ...  // check if build success  def stage = env.STAGE_NAME + '-build'  if(isSuccess){  updateGitlabCommitStatus(name: '${stage}', state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} OK... âˆš\")  }else {  updateGitlabCommitStatus(name: '${stage}', state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... x\")  // throw exceptionï¼Œaborted pipeline  error errMsg  }   return this  } }   ä½¿ç”¨Jenkinsfileæ¥éªŒè¯ä¸Šè¿°ä¿®æ”¹æ˜¯å¦æ­£ç¡®ï¼š\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('git-log') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('build-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  }  post {  success {  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„ \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${env.BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  }  } } æ¥ä¸‹æ¥éœ€è¦å°†pushå’Œloginæ–¹æ³•åšåŒæ ·çš„æ”¹é€ \næœ€ç»ˆçš„Docker.groovyæ–‡ä»¶ä¸ºï¼š\npackage com.luffy.devops  /**  *  * @param repo  * @param tag  * @param credentialsId  * @param dockerfile  * @param context  * @return  */ def docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){  this.repo = repo  this.tag = tag  this.dockerfile = dockerfile  this.credentialsId = credentialsId  this.context = context  this.fullAddress = \"${this.repo}:${this.tag}\"  this.isLoggedIn = false  this.msg = new BuildMessage()  return this }   /**  * build image  * @return  */ def build() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} \"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  // check if build success  def stage = env.STAGE_NAME + '-build'  if(isSuccess){  updateGitlabCommitStatus(name: \"${stage}\", state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} OK... âˆš\")  }else {  updateGitlabCommitStatus(name: \"${stage}\", state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... x\")  // throw exceptionï¼Œaborted pipeline  error errMsg  }   return this  } }   /**  * push image  * @return  */ def push() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker push ${this.fullAddress}\"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  }  // check if build success  def stage = env.STAGE_NAME + '-push'  if(isSuccess){  updateGitlabCommitStatus(name: \"${stage}\", state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} OK... âˆš\")  }else {  updateGitlabCommitStatus(name: \"${stage}\", state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... x\")  // throw exceptionï¼Œaborted pipeline  error errMsg  }  return this }  /**  * docker registry login  * @return  */ def login() {  if(this.isLoggedIn || credentialsId == \"\"){  return this  }  // docker login  withCredentials([usernamePassword(credentialsId: this.credentialsId, usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {  def regs = this.getRegistry()  retry(3) {  try {  sh \"docker login ${regs} -u $USERNAME -p $PASSWORD\"  } catch (Exception ignored) {  echo \"docker login err, ${ignored.toString()}\"  }  }  }  this.isLoggedIn = true;  return this; }  /**  * get registry server  * @return  */ def getRegistry(){  def sp = this.repo.split(\"/\")  if (sp.size()  1) {  return sp[0]  }  return this.repo } å†æ¬¡æµ‹è¯•æ„å»º\nlibraryé›†æˆk8sæœåŠ¡éƒ¨ç½² libraryå®ç°éƒ¨ç½²ç®€å•ç‰ˆ devops.groovy\n/**  * kubernetes deployer  * @param resourcePath  */ def deploy(String resourcePath){  return new Deploy().init(resourcePath) } æ–°å¢Deploy.groovy\npackage com.luffy.devops  def init(String resourcePath){  this.resourcePath = resourcePath  this.msg = new BuildMessage()  return this }   def start(){  try{  //env.CURRENT_IMAGEç”¨æ¥å­˜å‚¨å½“å‰æ„å»ºçš„é•œåƒåœ°å€ï¼Œéœ€è¦åœ¨Docker.groovyä¸­è®¾ç½®å€¼  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  sh \"kubectl apply -f ${this.resourcePath}\"  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.stage_name} OK... âˆš\")  } catch (Exception exc){  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.stage_name} fail... âˆš\")  throw exc  } } ä¿®æ”¹Docker.groovy\ndef push() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker push ${this.fullAddress}\"  //æŠŠå½“å‰æ¨é€çš„é•œåƒåœ°å€è®°å½•åœ¨ç¯å¢ƒå˜é‡ä¸­  env.CURRENT_IMAGE = this.fullAddress  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  } Jenkinsfile ä¸­æ·»åŠ å¦‚ä¸‹éƒ¨åˆ†ï¼š\n stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\").start()  }  }  }  } libraryå®ç°è‡ªåŠ¨éƒ¨ç½²ä¼˜åŒ–ç‰ˆ ç®€å•ç‰ˆæœ¬æœ€æ˜æ˜¾çš„é—®é¢˜å°±æ˜¯æ— æ³•æ£€æµ‹éƒ¨ç½²åçš„PodçŠ¶æ€ï¼Œå¦‚æœæƒ³åšé›†æˆæµ‹è¯•ï¼Œé€šå¸¸è¦ç­‰åˆ°æœ€æ–°ç‰ˆæœ¬çš„Podå¯åŠ¨åå†å¼€å§‹ã€‚å› æ­¤æœ‰å¿…è¦åœ¨éƒ¨ç½²çš„æ—¶å€™æ£€æµ‹Podæ˜¯å¦æ­£å¸¸è¿è¡Œã€‚\næ¯”å¦‚è¦å»æ£€æŸ¥myblogåº”ç”¨çš„podæ˜¯å¦éƒ¨ç½²æ­£å¸¸ï¼Œäººå·¥æ£€æŸ¥çš„å¤§è‡´æ­¥éª¤ï¼š\n  kubectl -n luffy get podï¼ŒæŸ¥çœ‹podåˆ—è¡¨\n  æ‰¾åˆ°åˆ—è¡¨ä¸­å¸¦æœ‰myblogå…³é”®å­—çš„runningçš„pod\n  æŸ¥çœ‹ä¸Šè¿°running podæ•°ï¼Œæ˜¯å¦å’Œmyblogçš„deploymentä¸­å®šä¹‰çš„replicaså‰¯æœ¬æ•°ä¸€è‡´\n  è‹¥ä¸€è‡´ï¼Œåˆ™æ£€æŸ¥ç»“æŸï¼Œè‹¥ä¸ä¸€è‡´ï¼Œå¯èƒ½ç¨ç­‰å‡ ç§’é’Ÿï¼Œå†æ¬¡æ‰§è¡Œç›¸åŒçš„æ£€æŸ¥æ“ä½œ\n  å¦‚æœ5åˆ†é’Ÿäº†è¿˜æ²¡æœ‰æ£€æŸ¥é€šè¿‡ï¼Œåˆ™å¤§æ¦‚ç‡æ˜¯podæœ‰é—®é¢˜ï¼Œé€šè¿‡æŸ¥çœ‹æ—¥å¿—è¿›ä¸€æ­¥æ’æŸ¥\n  å¦‚ä½•é€šè¿‡libraryä»£ç å®ç°ä¸Šè¿°è¿‡ç¨‹ï¼š\n  libraryå¦‚ä½•è·å–myblogçš„podåˆ—è¡¨ï¼Ÿ\n  é¦–å…ˆè¦çŸ¥é“æœ¬æ¬¡éƒ¨ç½²çš„æ˜¯å“ªä¸ªworkloadï¼Œå› æ­¤éœ€è¦è°ƒç”¨è€…ä¼ é€’workloadçš„yamlæ–‡ä»¶è·¯å¾„\n  libraryè§£æworkload.yamlæ–‡ä»¶ï¼Œæ‰¾åˆ°å¦‚ä¸‹å€¼ï¼š\n podæ‰€åœ¨çš„namespace podä¸­ä½¿ç”¨çš„labelsæ ‡ç­¾    ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥æ‰¾è¯¥workloadå…³è”çš„pod\n$ kubectl -n  get po -l  -l   # å¦‚æŸ¥æ‰¾myblogçš„pod $ kubectl -n luffy get po -l app=myblog     å¦‚ä½•ç¡®å®šæ­¥éª¤1ä¸­çš„podçš„çŠ¶æ€ï¼Ÿ\n# æˆ–è€…å¯ä»¥ç›´æ¥è¿›è¡Œæå–çŠ¶æ€ $ kubectl -n luffy get po -l app=myblog -ojsonpath='{.items[0].status.phase}'  # ä»¥jsonæ•°ç»„çš„å½¢å¼å­˜å‚¨ $ kubectl -n luffy get po -l app=myblog -o json   å¦‚ä½•æ£€æµ‹æ‰€æœ‰çš„å‰¯æœ¬æ•°éƒ½æ˜¯æ­£å¸¸çš„ï¼Ÿ\n# ä»¥jsonæ•°ç»„çš„å½¢å¼å­˜å‚¨ $ kubectl -n luffy get po -l app=myblog -o json  # éå†æ•°ç»„ï¼Œæ£€æµ‹æ¯ä¸€ä¸ªpodæŸ¥çœ‹æ˜¯å¦å‡æ­£å¸¸ï¼ˆterminatingå’Œevictedé™¤å¤–ï¼‰   å¦‚ä½•å®ç°åœ¨5åˆ†é’Ÿçš„æ—¶é—´å†…ï¼Œè‹¥podçŠ¶æ€ç¬¦åˆé¢„æœŸï¼Œåˆ™é€€å‡ºæ£€æµ‹å¾ªç¯ï¼Œè‹¥ä¸ç¬¦åˆé¢„æœŸåˆ™ç»§ç»­æ£€æµ‹\nuse( TimeCategory ) {  def endTime = TimeCategory.plus(new Date(), TimeCategory.getMinutes(timeoutMinutes,5))  while (true) {  if (new Date() = endTime) {  //è¶…æ—¶äº†ï¼Œåˆ™å®£å‘ŠpodçŠ¶æ€ä¸å¯¹  updateGitlabCommitStatus(name: 'deploy', state: 'failed')  throw new Exception(\"deployment timed out...\")  }  //å¾ªç¯æ£€æµ‹å½“å‰deploymentä¸‹çš„podçš„çŠ¶æ€  try {  if (this.isDeploymentReady()) {  readyCount++  if(readyCount  5){  updateGitlabCommitStatus(name: 'deploy', state: 'success')  break;  }  }else {  readyCount = 0  }catch (Exception exc){  echo exc.toString()  }  //æ¯æ¬¡æ£€æµ‹è‹¥ä¸æ»¡è¶³æ‰€æœ‰podå‡æ­£å¸¸ï¼Œåˆ™sleep 5ç§’é’Ÿåç»§ç»­æ£€æµ‹  sleep(5)  }  }   devops.groovy\né€šè¿‡æ·»åŠ å‚æ•° watchæ¥æ§åˆ¶æ˜¯å¦åœ¨pipelineä¸­è§‚å¯Ÿpodçš„è¿è¡ŒçŠ¶æ€\n/** * * @param resourcePath * @param watch * @param workloadFilePath * @return */ def deploy(String resourcePath, Boolean watch = true, String workloadFilePath){  return new Deploy().init(resourcePath, watch, workloadFilePath) } å®Œæ•´ç‰ˆçš„Deploy.groovy\npackage com.luffy.devops  import org.yaml.snakeyaml.Yaml import groovy.json.JsonSlurperClassic import groovy.time.TimeCategory     def init(String resourcePath, Boolean watch, String workloadFilePath) {  this.resourcePath = resourcePath  this.msg = new BuildMessage()  this.watch = watch  this.workloadFilePath = workloadFilePath  if(!resourcePath \u0026\u0026 !workloadFilePath){  throw Exception(\"illegal resource path\")  }  return this }   def start(){  try{  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  sh \"kubectl apply -f ${this.resourcePath}\"  } catch (Exception exc){  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.stage_name} fail... âˆš\")  throw exc  }   if (this.watch) {   // åˆå§‹åŒ–workloadæ–‡ä»¶  initWorkload()  String namespace = this.workloadNamespace  String name = env.workloadName  if(env.workloadType.toLowerCase() == \"deployment\"){  echo \"begin watch pod status from deployment ${env.workloadName}...\"  monitorDeployment(namespace, name)  }else {  //todo  echo \"workload type ${env.workloadType} does not support for now...\"  }   }else {  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.STAGE_NAME} OK... âˆš\")  }  }  def initWorkload() {  try {  def content = readFile this.workloadFilePath  Yaml parser = new Yaml()  def data = parser.load(content)  def kind = data[\"kind\"]  if (!kind) {  throw Exception(\"workload file ${kind} illegal, will exit pipeline!\")  }  env.workloadType = kind  echo \"${data}\"  this.workloadNamespace = data[\"metadata\"][\"namespace\"]  if (!this.workloadNamespace){  this.workloadNamespace = \"default\"  }  env.workloadName = data[\"metadata\"][\"name\"]   } catch (Exception exc) {  echo \"failed to readFile ${this.workloadFilePath},exception: ${exc}.\"  throw exc  } }  /** * * @param namespace * @param name * @param timeoutMinutes * @param sleepTime * @return */ def monitorDeployment(String namespace, String name, int timeoutMinutes = 5, sleepTime = 3) {  def readyCount = 0  def readyTarget = 3  use( TimeCategory ) {  def endTime = TimeCategory.plus(new Date(), TimeCategory.getMinutes(timeoutMinutes))  def lastRolling  while (true) {  // checking timeout  if (new Date() = endTime) {  echo \"timeout, printing logs...\"  this.printContainerLogs(lastRolling)  updateGitlabCommitStatus(name: 'deploy', state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.STAGE_NAME} Failed... x\")  throw new Exception(\"deployment timed out...\")  }  // checking deployment status  try {  def rolling = this.getResource(namespace, name, \"deployment\")  lastRolling = rolling  if (this.isDeploymentReady(rolling)) {  readyCount++  echo \"ready total count: ${readyCount}\"  if (readyCount = readyTarget) {  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.STAGE_NAME} OK... âˆš\")  break  }   } else {  readyCount = 0  echo \"reseting ready total count: ${readyCount}ï¼Œprint pods event logs\"  this.printContainerLogs(lastRolling)  sh \"kubectl get pod -n ${namespace} -o wide\"  }  } catch (Exception exc) {  updateGitlabCommitStatus(name: 'deploy', state: 'failed')  this.msg.updateBuildMessage(env.BUILD_RESULT, \"${env.STAGE_NAME} Failed... Ã—\")  echo \"error: ${exc}\"  }  sleep(sleepTime)  }  }  return this }  def getResource(String namespace = \"default\", String name, String kind=\"deployment\") {  sh \"kubectl get ${kind} -n ${namespace} ${name} -o json  ${namespace}-${name}-yaml.yml\"  def jsonStr = readFile \"${namespace}-${name}-yaml.yml\"  def jsonSlurper = new JsonSlurperClassic()  def jsonObj = jsonSlurper.parseText(jsonStr)  return jsonObj }   def printContainerLogs(deployJson) {  if (deployJson == null) {  return;  }  def namespace = deployJson.metadata.namespace  def name = deployJson.metadata.name  def labels=\"\"  deployJson.spec.template.metadata.labels.each { k, v -  labels = \"${labels} -l=${k}=${v}\"  }  sh \"kubectl describe pods -n ${namespace} ${labels}\" }  def isDeploymentReady(deployJson) {  def status = deployJson.status  def replicas = status.replicas  def unavailable = status['unavailableReplicas']  def ready = status['readyReplicas']  if (unavailable != null) {  return false  }  def deployReady = (ready != null \u0026\u0026 ready == replicas)  // get pod information  if (deployJson.spec.template.metadata != null \u0026\u0026 deployReady) {  if (deployJson.spec.template.metadata.labels != null) {  def labels=\"\"  def namespace = deployJson.metadata.namespace  def name = deployJson.metadata.name  deployJson.spec.template.metadata.labels.each { k, v -  labels = \"${labels} -l=${k}=${v}\"  }  if (labels != \"\") {  sh \"kubectl get pods -n ${namespace} ${labels} -o json  ${namespace}-${name}-json.json\"  def jsonStr = readFile \"${namespace}-${name}-json.json\"  def jsonSlurper = new JsonSlurperClassic()  def jsonObj = jsonSlurper.parseText(jsonStr)  def totalCount = 0  def readyCount = 0  jsonObj.items.each { k, v -  echo \"pod phase ${k.status.phase}\"  if (k.status.phase != \"Terminating\" \u0026\u0026 k.status.phase != \"Evicted\") {  totalCount++;  if (k.status.phase == \"Running\") {  readyCount++;  }  }  }  echo \"Pod running count ${totalCount} == ${readyCount}\"  return totalCount  0 \u0026\u0026 totalCount == readyCount  }  }  }  return deployReady } ä¿®æ”¹Jenkinsfile è°ƒç”¨éƒ¨åˆ†ï¼š\n stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\", true, \"deploy/deployment.yaml\").start()  }  }  }  } libraryå®ç°å³æ—¶æ¶ˆæ¯æ¨é€ å®ç°æ¶ˆæ¯é€šçŸ¥ ç”±äºå‘é€æ¶ˆæ¯é€šçŸ¥å±äºé€šç”¨çš„åŠŸèƒ½ï¼Œå› æ­¤æœ‰å¿…è¦æŠŠæ¶ˆæ¯é€šçŸ¥æŠ½è±¡æˆä¸ºé€šç”¨çš„åŠŸèƒ½ã€‚\ndevops.groovy\n/**  * notificationSuccess  * @param project  * @param receiver  * @param credentialsId  * @param title  * @return  */ def notificationSuccess(String project, String receiver=\"dingTalk\", String credentialsId=\"dingTalk\", String title=\"\"){  new Notification().getObject(project, receiver, credentialsId, title).notification(\"success\") }  /**  * notificationFailed  * @param project  * @param receiver  * @param credentialsId  * @param title  * @return  */ def notificationFailed(String project, String receiver=\"dingTalk\", String credentialsId=\"dingTalk\", String title=\"\"){  new Notification().getObject(project, receiver, credentialsId, title).notification(\"failure\") } æ–°å»ºNotification.groovyæ–‡ä»¶ï¼š\npackage com.luffy.devops  /** * * @param type * @param credentialsId * @param title * @return */ def getObject(String project, String receiver, String credentialsId, String title) {  this.project = project  this.receiver = receiver  this.credentialsId = credentialsId  this.title = title  return this }   def notification(String type){  String msg =\"ğŸ˜„ğŸ‘ ${this.title} ğŸ‘ğŸ˜„\"   if (this.title == \"\") {  msg = \"ğŸ˜„ğŸ‘ æµæ°´çº¿æˆåŠŸå•¦ ğŸ‘ğŸ˜„\"  }  // failed  if (type == \"failure\") {  msg =\"ğŸ˜–âŒ ${this.title} âŒğŸ˜–\"  if (this.title == \"\") {  msg = \"ğŸ˜–âŒ æµæ°´çº¿å¤±è´¥äº† âŒğŸ˜–\"  }  } \tString title = msg  // rich notify msg  msg = genNotificationMessage(msg)  if( this.receiver == \"dingTalk\") {  try {  //new DingTalk().markDown(title, msg, this.credentialsId)  } catch (Exception ignored) {}  }else if(this.receiver == \"wechat\") {  //todo  }else if (this.receiver == \"email\"){  //todo  }else{  error \"no support notify type!\"  } }   /** * get notification msg * @param msg * @return */ def genNotificationMessage(msg) {  // project  msg = \"${msg} \\n **é¡¹ç›®åç§°**: ${this.project}\"  // get git log  def gitlog = \"\"  try {  sh \"git log --oneline -n 1  gitlog.file\"  gitlog = readFile \"gitlog.file\"  } catch (Exception ignored) {}   if (gitlog != null \u0026\u0026 gitlog != \"\") {  msg = \"${msg} \\n **Git log**: ${gitlog}\"  }  // get git branch  def gitbranch = env.BRANCH_NAME  if (gitbranch != null \u0026\u0026 gitbranch != \"\") {  msg = \"${msg} \\n **Git branch**: ${gitbranch}\"  }  // build tasks  msg = \"${msg} \\n **Build Tasks**: ${env.BUILD_TASKS}\"   // get buttons  msg = msg + getButtonMsg()  return msg } def getButtonMsg(){  String res = \"\"  def buttons = [  [  \"title\": \"æŸ¥çœ‹æµæ°´çº¿\",  \"actionURL\": \"${env.RUN_DISPLAY_URL}\"  ],  [  \"title\": \"ä»£ç æ‰«æç»“æœ\",  \"actionURL\": \"http://sonar.luffy.com/dashboard?id=${this.project}\"  ]  ]  buttons.each() {  if(res == \"\"){  res = \" \\n \"  }  res = \"${res} --- [\"+it[\"title\"]+\"](\"+it[\"actionURL\"]+\") \"  }  return res } æ–°å»ºDingTalk.groovyæ–‡ä»¶ï¼š\npackage com.luffy.devops  import groovy.json.JsonOutput   def sendRequest(method, data, credentialsId, Boolean verbose=false, codes=\"100:399\") {  def reqBody = new JsonOutput().toJson(data)  withCredentials([usernamePassword(credentialsId: credentialsId, usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {  def response = httpRequest(  httpMode:method,  url: \"https://oapi.dingtalk.com/robot/send?access_token=${PASSWORD}\",  requestBody:reqBody,  validResponseCodes: codes,  contentType: \"APPLICATION_JSON\",  quiet: !verbose  )  } }  def markDown(String title, String text, String credentialsId, Boolean verbose=false) {  def data = [  \"msgtype\": \"markdown\",  \"markdown\": [  \"title\": title,  \"text\": text  ]  ]  this.sendRequest(\"POST\", data, credentialsId, verbose) } éœ€è¦ç”¨åˆ°Http Requestæ¥å‘é€æ¶ˆæ¯ï¼Œå®‰è£…ä¸€ä¸‹æ’ä»¶ï¼šhttp_request\njenkinsfileè°ƒç”¨ @Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",true,\"deploy/deployment.yaml\").start()  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(\"myblog\",\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(\"myblog\",\"dingTalk\")  }  }  } } libraryé›†æˆä»£ç æ‰«æ sonarqubeä»£ç æ‰«æä½œä¸ºé€šç”¨åŠŸèƒ½ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨libraryå®ç°ã€‚\ndevops.groovy\n/** * sonarqube scanner * @param projectVersion * @param waitScan * @return */ def scan(String projectVersion=\"\", Boolean waitScan = true) {  return new Sonar().init(projectVersion, waitScan) } æ–°å»ºSonar.groovy\n å¯ä»¥ä¼ é€’projectVersionä½œä¸ºsonarqubeçš„æ‰«æç‰ˆæœ¬ å‚æ•°waitScanæ¥è®¾ç½®æ˜¯å¦ç­‰å¾…æœ¬æ¬¡æ‰«ææ˜¯å¦é€šè¿‡  package com.luffy.devops   def init(String projectVersion=\"\", Boolean waitScan = true) {  this.waitScan = waitScan  this.msg = new BuildMessage()  if (projectVersion == \"\"){  projectVersion = sh(returnStdout: true, script: 'git log --oneline -n 1|cut -d \" \" -f 1')  }  sh \"echo '\\nsonar.projectVersion=${projectVersion}'  sonar-project.properties\"  sh \"cat sonar-project.properties\"  return this }  def start() {  try {  this.startToSonar()  }  catch (Exception exc) {  throw exc  }  return this }  def startToSonar() {  withSonarQubeEnv('sonarqube') {  sh \"sonar-scanner -X;\"  sleep 5  }  if(this.waitScan){  //wait 3min  timeout(time: 3, unit: 'MINUTES') {  def qg = waitForQualityGate()  String stage = \"${env.stage_name}\"  if (qg.status != 'OK') {  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... Ã—\")  updateGitlabCommitStatus(name: \"${stage}\", state: 'failed')  error \"Pipeline aborted due to quality gate failure: ${qg.status}\"  }else{  this.msg.updateBuildMessage(env.BUILD_RESULT, \"${stage} OK... âˆš\")  updateGitlabCommitStatus(name: \"${stage}\", state: 'success')  }  }  }else{  echo \"skip waitScan\"  }  return this } Jenkinsfileæ–°å¢å¦‚ä¸‹éƒ¨åˆ†ï¼š\n stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  } é›†æˆrobotè‡ªåŠ¨åŒ–æµ‹è¯• å…³äºé›†æˆæµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å‡ ç‚¹:\n æµ‹è¯•äººå‘˜è¿›è¡Œç¼–å†™ ä¾§é‡äºä¸åŒæ¨¡å—çš„æ¥å£è°ƒç”¨ï¼Œå¯¹æ–°åŠ çš„åŠŸèƒ½è¿›è¡ŒéªŒè¯ æ³¨é‡æ–°ç‰ˆæœ¬å¯¹ä»¥å‰çš„é›†æˆç”¨ä¾‹è¿›è¡Œå›å½’  å› æ­¤ï¼Œæ›´å¤šçš„åº”è¯¥æ˜¯è·¨æ¨¡å—å»æµ‹è¯•ï¼Œè€Œä¸”æµ‹è¯•ç”¨ä¾‹æ˜¯æµ‹è¯•äººå‘˜å»ç»´æŠ¤ï¼Œå› æ­¤ä¸é€‚åˆæŠŠä»£ç æ”¾åœ¨å¼€å‘çš„gitä»“åº“ä¸­ã€‚\næœ¬èŠ‚è¦å®ç°çš„å·¥ä½œï¼š\n åˆ›å»ºæ–°çš„gitä»“åº“robot-casesï¼Œç”¨äºå­˜æ”¾robotæµ‹è¯•ç”¨ä¾‹ ä¸ºrobot-casesé¡¹ç›®åˆ›å»ºJenkinsfile é…ç½®Jenkinsä»»åŠ¡ï¼Œå®ç°è¯¥é¡¹ç›®çš„è‡ªåŠ¨åŒ–æ‰§è¡Œ åœ¨myblogæ¨¡å—çš„æµæ°´çº¿ä¸­ï¼Œå¯¹è¯¥æµæ°´çº¿é¡¹ç›®è¿›è¡Œè°ƒç”¨  åˆå§‹åŒ–robot-casesé¡¹ç›®   æ–°å»ºgitlabé¡¹ç›®ï¼Œåç§°ä¸ºrobot-cases\n  cloneåˆ°æœ¬åœ°\n  æœ¬åœ°æ‹·è´myblogé¡¹ç›®çš„robot.txt\nrobot-cases/ â””â”€â”€ myblog  â””â”€â”€ robot.txt   é…ç½®JenkinsfileåŠè‡ªåŠ¨åŒ–ä»»åŠ¡ robot-cases/ â”œâ”€â”€ Jenkinsfile â””â”€â”€ myblog  â””â”€â”€ robot.txt Jenkinsfile\nå¤šä¸ªä¸šåŠ¡é¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹éƒ½åœ¨ä¸€ä¸ªä»“åº“ä¸­ï¼Œå› æ­¤éœ€è¦æ ¹æ®å‚æ•°è®¾ç½®æ¥å†³å®šæ‰§è¡Œå“ªä¸ªé¡¹ç›®çš„ç”¨ä¾‹\npipeline {  agent {  label 'jnlp-slave'  }  \toptions {  timeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('Test') {  steps {  script {  container('tools'){  switch(env.comp){  case \"myblog\":  env.testDir = \"myblog\"  break  case \"business1\":  env.testDir = \"business1\"  break  default:  env.testDir = \"all\"  break  }  sh 'robot -d artifacts/ ${testDir}/*'  step([  $class : 'RobotPublisher',  outputPath: 'artifacts/',  outputFileName : \"output.xml\",  disableArchiveOutput : false,  passThreshold : 100,  unstableThreshold: 80.0,  onlyCritical : true,  otherFiles : \"*.png\"  ])  archiveArtifacts artifacts: 'artifacts/*', fingerprint: true  }  }  }  }  } } å¦‚ä½•å®ç°å°†env.comp ä¼ é€’è¿›å»ï¼Ÿ\né…ç½®æµæ°´çº¿çš„å‚æ•°åŒ–æ„å»ºä»»åŠ¡å¹¶éªŒè¯å‚æ•°åŒ–æ„å»º\nlibraryé›†æˆè§¦å‘ä»»åŠ¡ ç”±äºå¤šä¸ªé¡¹ç›®å‡éœ€è¦è§¦å‘è‡ªåŠ¨æ„å»ºï¼Œå› æ­¤å¯ä»¥åœ¨libraryä¸­æŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ¥æ”¶compå‚æ•°ï¼Œå¹¶åœ¨libraryä¸­å®ç°å¯¹robot-casesé¡¹ç›®çš„è§¦å‘ã€‚\ndevops.groovy\n/** * * @param comp * @return */ def robotTest(String comp=\"\"){  new Robot().acceptanceTest(comp) } æ–°å»ºRobot.groovyæ–‡ä»¶\npackage com.luffy.devops  def acceptanceTest(comp) {  try{  echo \"Trigger to execute Acceptance Testing\"  def rf = build job: 'robot-cases',  parameters: [  string(name: 'comp', value: comp)  ],  wait: true,  propagate: false  def result = rf.getResult()  def msg = \"${env.STAGE_NAME}... \"  if (result == \"SUCCESS\"){  msg += \"âˆš success\"  }else if(result == \"UNSTABLE\"){  msg += \"âš  unstable\"  }else{  msg += \"Ã— failure\"  }  echo rf.getAbsoluteUrl()  env.ROBOT_TEST_URL = rf.getAbsoluteUrl()  new BuildMessage().updateBuildMessage(env.BUILD_TASKS, msg)  } catch (Exception exc) {  echo \"trigger execute Acceptance Testing exception: ${exc}\"  new BuildMessage().updateBuildMessage(env.BUILD_RESULT, msg)  } } ä¿®æ”¹Jenkinsfileæµ‹è¯•è°ƒç”¨\n stage('integration test') {  steps {  container('tools') {  script{  devops.robotTest(\"myblog\")  }  }  }  } å¤šç¯å¢ƒçš„CICDè‡ªåŠ¨åŒ–å®ç° å®ç°ç›®æ ‡åŠæ•ˆæœ ç›®å‰é¡¹ç›®å­˜åœ¨developå’Œmasterä¸¤ä¸ªåˆ†æ”¯ï¼ŒJenkinsfileä¸­é…ç½®çš„éƒ½æ˜¯æ„å»ºéƒ¨ç½²åˆ°ç›¸åŒçš„ç¯å¢ƒï¼Œå®é™…çš„åœºæ™¯ä¸­ï¼Œä»£ç ä»“åº“çš„é¡¹ç›®å¾€å¾€ä¸åŒçš„åˆ†æ”¯æœ‰ä¸åŒçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ªå·¥ä½œæµç¨‹ï¼š\n  å¼€å‘äººå‘˜æäº¤ä»£ç åˆ°developåˆ†æ”¯\n  Jenkinsè‡ªåŠ¨ä½¿ç”¨developåˆ†æ”¯åšå•æµ‹ã€ä»£ç æ‰«æã€é•œåƒæ„å»ºï¼ˆä»¥commit idä¸ºé•œåƒtagï¼‰ã€æœåŠ¡éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ\n  å¼€å‘äººå‘˜ä½¿ç”¨å¼€å‘ç¯å¢ƒè‡ªæµ‹\n  æµ‹è¯•å®Œæˆåï¼Œåœ¨gitlabæäº¤merge requestè¯·æ±‚ï¼Œå°†ä»£ç åˆå¹¶è‡³masteråˆ†æ”¯\n  éœ€è¦å‘ç‰ˆæ—¶ï¼Œåœ¨gitlabç«¯åŸºäºmasteråˆ†æ”¯åˆ›å»ºtagï¼ˆv2.3.0ï¼‰\n  Jenkinsè‡ªåŠ¨æ£€æµ‹åˆ°tagï¼Œæ‹‰å–tagå…³è”çš„ä»£ç åšå•æµ‹ã€ä»£ç æ‰«æã€é•œåƒæ„å»ºï¼ˆä»¥ä»£ç çš„tagä¸ºé•œåƒçš„tagï¼‰ã€æœåŠ¡éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒã€æ‰§è¡Œé›†æˆæµ‹è¯•ç”¨ä¾‹ï¼Œè¾“å‡ºæµ‹è¯•æŠ¥å‘Š\n  æµ‹è¯•äººå‘˜è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•\n  ä¸Šçº¿\n  å®ç°æ€è·¯ ä»¥myblogé¡¹ç›®ä¸ºä¾‹ï¼Œç›®å‰å·²ç»å…·å¤‡çš„æ˜¯developåˆ†æ”¯ä»£ç æäº¤åï¼Œå¯ä»¥è‡ªåŠ¨å®ç°ï¼š\n å•å…ƒæµ‹è¯•ã€ä»£ç æ‰«æ é•œåƒæ„å»º k8sæœåŠ¡éƒ¨ç½² roboté›†æˆç”¨ä¾‹æµ‹è¯•  å’Œä¸Šè¿°ç›®æ ‡ç›¸æ¯”ï¼Œå·®å¼‚ç‚¹ï¼š\n myblogåº”ç”¨ç›®å‰åªæœ‰ä¸€å¥—ç¯å¢ƒï¼Œåœ¨luffyå‘½åç©ºé—´ä¸­ã€‚æˆ‘ä»¬æ–°å»ºä¸¤ä¸ªå‘½åç©ºé—´ï¼š  devï¼Œç”¨ä½œéƒ¨ç½²å¼€å‘ç¯å¢ƒ testï¼Œç”¨ä½œéƒ¨ç½²é›†æˆæµ‹è¯•ç¯å¢ƒ   éœ€è¦æ ¹æ®ä¸åŒçš„åˆ†æ”¯æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆå®ç°ï¼š  developå’Œmasteråˆ†æ”¯ä½¿ç”¨ä¸åŒçš„Jenkinsfile  å¯è¡Œæ€§å¾ˆå·®ï¼Œå› ä¸ºä»£ç åˆå¹¶å·¥ä½œå¾ˆç¹ç ç»´æŠ¤æˆæœ¬é«˜ï¼Œå¤šä¸ªåˆ†æ”¯éœ€è¦ç»´æŠ¤å¤šä¸ªJenkinsfile   ä½¿ç”¨åŒä¸€å¥—Jenkinsfileï¼Œé…åˆlibraryå’Œæ¨¡æ¿æ¥å®ç°ä¸€å¥—Jenkinsfileé€‚é…å¤šå¥—ç¯å¢ƒ  æ”¹é€ Jenkinsfileï¼Œå®ç°æ ¹æ®åˆ†æ”¯æ¥é€‰æ‹©ä»»åŠ¡ éœ€è¦å°†deployç›®å½•ä¸­æ‰€æœ‰å’Œç‰¹å®šç¯å¢ƒç»‘å®šçš„å†…å®¹æ¨¡æ¿åŒ– åœ¨libraryä¸­å®ç°æ ¹æ®ä¸åŒçš„åˆ†æ”¯ï¼Œæ¥æ›¿æ¢æ¨¡æ¿ä¸­çš„å†…å®¹      Jenkinsfileæ ¹æ®åˆ†æ”¯é€‰æ‹©ä»»åŠ¡ ä½¿ç”¨whenå…³é”®å­—ï¼Œé…åˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ç°åˆ†æ”¯çš„è¿‡æ»¤é€‰æ‹©ï¼š\npipeline {  agent any  stages {  stage('Example Build') {  steps {  echo 'Hello World'  }  }  stage('Example Deploy') {  when {  expression { BRANCH_NAME ==~ \"develop\" }  }  steps {  echo 'Deploying to develop env'  }  }  } } åˆ†åˆ«åœ¨developå’Œmasteråˆ†æ”¯è¿›è¡ŒéªŒè¯ã€‚\né’ˆå¯¹æœ¬ä¾‹ï¼Œå¯ä»¥å¯¹Jenkinsfileåšå¦‚ä¸‹è°ƒæ•´ï¼š\n...  stage('integration test') {  when {  expression { BRANCH_NAME ==~ /v.*/ }  }  steps {  container('tools') {  script{  devops.robotTest(PROJECT)  }  }  }  } ... æ¨¡æ¿åŒ–k8sçš„èµ„æºæ¸…å• å› ä¸ºéœ€è¦ä½¿ç”¨åŒä¸€å¥—æ¨¡æ¿å’ŒJenkinsfileæ¥éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå› æ­¤åŠ¿å¿…è¦å¯¹èµ„æºæ¸…å•è¿›è¡Œæ¨¡æ¿åŒ–ï¼Œå‰é¢çš„å†…å®¹ä¸­åªå°†deployment.yamlæ”¾åˆ°äº†é¡¹ç›®çš„deployæ¸…å•ç›®å½•ï¼Œæ­¤å¤„å°†éƒ¨ç½²myblogç”¨åˆ°çš„èµ„æºæ¸…å•å‡è¡¥å……è¿›å»ï¼ŒåŒ…å«ï¼š\n deployment.yaml service.yaml ingress.yaml configmap.yaml secret.yaml  æ¶‰åŠåˆ°éœ€è¦è¿›è¡Œæ¨¡æ¿åŒ–çš„å†…å®¹åŒ…æ‹¬ï¼š\n  é•œåƒåœ°å€\n  å‘½åç©ºé—´\n  ingressçš„åŸŸåä¿¡æ¯\n  æ¨¡æ¿åŒ–åçš„æ–‡ä»¶ï¼š\n$ cat deployment.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: myblog  namespace: {{NAMESPACE}} spec:  replicas: 1 #æŒ‡å®šPodå‰¯æœ¬æ•°  selector: #æŒ‡å®šPodçš„é€‰æ‹©å™¨  matchLabels:  app: myblog  template:  metadata:  labels: #ç»™Podæ‰“label  app: myblog  spec:  containers:  - name: myblog  image: {{IMAGE_URL}}  imagePullPolicy: IfNotPresent  env:  - name: MYSQL_HOST  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_HOST  - name: MYSQL_PORT  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_PORT  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_PASSWD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’  periodSeconds: 15 # æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡  timeoutSeconds: 2 # æ¢æµ‹è¶…æ—¶æ—¶é—´  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 15  $ cat configmap.yaml apiVersion: v1 data:  MYSQL_HOST: mysql  MYSQL_PORT: \"3306\" kind: ConfigMap metadata:  name: myblog  namespace: {{NAMESPACE}}  $ cat secret.yaml apiVersion: v1 data:  MYSQL_PASSWD: MTIzNDU2  MYSQL_USER: cm9vdA== kind: Secret metadata:  name: myblog  namespace: {{NAMESPACE}} type: Opaque  $ cat service.yaml apiVersion: v1 kind: Service metadata:  name: myblog  namespace: {{NAMESPACE}} spec:  ports:  - port: 80  protocol: TCP  targetPort: 8002  selector:  app: myblog  sessionAffinity: None  type: ClusterIP status:  loadBalancer: {}  $ cat ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: myblog  namespace: {{NAMESPACE}} spec:  rules:  - host: {{INGRESS_MYBLOG}}  http:  paths:  - backend:  serviceName: myblog  servicePort: 80  path: / status:  loadBalancer: {} å®ç°libraryé…ç½®æ›¿æ¢é€»è¾‘ æˆ‘ä»¬éœ€è¦å®ç°ä½¿ç”¨ç›¸åŒçš„æ¨¡æ¿ï¼Œåšåˆ°å¦‚ä¸‹äº‹æƒ…ï¼š\n æ ¹æ®ä»£ç åˆ†æ”¯æ¥éƒ¨ç½²åˆ°ä¸åŒçš„å‘½åç©ºé—´  developåˆ†æ”¯éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒï¼Œä½¿ç”¨å‘½åç©ºé—´ dev v.*éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨å‘½åç©ºé—´ test   ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„ingressåœ°å€æ¥è®¿é—®  å¼€å‘ç¯å¢ƒï¼Œblog-dev.luffy.com æµ‹è¯•ç¯å¢ƒï¼Œblog-test.luffy.com    å¦‚ä½•å®ç°ï¼Ÿsharedlibrary\næ‰€æœ‰çš„é€»è¾‘éƒ½ä¼šç»è¿‡libraryè¿™ä¸€å±‚ï¼Œæˆ‘ä»¬å…·æœ‰å®Œå…¨å¯æ§æƒã€‚\nå‰é¢å·²ç»æ›¿æ¢è¿‡é•œåƒåœ°å€äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å¦‚ä¸‹é€»è¾‘ï¼š\n æ£€æµ‹å½“å‰ä»£ç åˆ†æ”¯ï¼Œæ›¿æ¢å‘½åç©ºé—´ æ£€æµ‹å½“å‰ä»£ç åˆ†æ”¯ï¼Œæ›¿æ¢Ingressåœ°å€  é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•æ£€æµ‹æ„å»ºçš„è§¦å‘æ˜¯developåˆ†æ”¯è¿˜æ˜¯tagåˆ†æ”¯ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šenv.TAG_NAMEï¼Œç”±tagåˆ†æ”¯è§¦å‘çš„æ„å»ºï¼Œç¯å¢ƒå˜é‡ä¸­ä¼šå¸¦æœ‰TAG_NAMEï¼Œä¸”å€¼ä¸ºgitlabä¸­çš„tagåç§°ã€‚\nåšä¸ªæ¼”ç¤ºï¼š\nä½¿ç”¨å¦‚ä¸‹çš„Jenkinsfileï¼ŒæŸ¥çœ‹ç”±masteråˆ†æ”¯è§¦å‘å’Œç”±tagåˆ†æ”¯è§¦å‘ï¼Œprintenvçš„å€¼æœ‰ä»€ä¹ˆä¸åŒ\npipeline {  agent any  stages {  stage('Example Build') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('Example Deploy') {  when {  expression { BRANCH_NAME ==~ \"develop\" }  }  steps {  echo 'Deploying to develop env'  }  }  } } æˆ‘ä»¬å¯ä»¥é€‰æ‹©å’Œæ›¿æ¢imageé•œåƒåœ°å€ä¸€æ ·ï¼Œæ¥æ‰§è¡Œæ›¿æ¢ï¼š\ndef tplHandler(){  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  String namespace = \"dev\"  String ingress = \"blog-dev.luffy.com\"  if(env.TAG_NAME){  namespace = \"test\"  ingress = \"blog-test.luffy.com\"  }  sh \"sed -i 's#{{NAMESPACE}}#${namespace}#g' ${this.resourcePath}/*\"  sh \"sed -i 's#{{INGRESS_MYBLOG}}#${ingress}#g' ${this.resourcePath}/*\" } ä½†æ˜¯æˆ‘ä»¬çš„libraryæ˜¯è¦ä¸ºå¤šä¸ªé¡¹ç›®æä¾›æœåŠ¡çš„ï¼Œå¦‚æœé‡‡ç”¨ä¸Šè¿°æ–¹å¼ï¼Œåˆ™æ¯åŠ å…¥ä¸€ä¸ªé¡¹ç›®ï¼Œéƒ½éœ€è¦å¯¹libraryåšæ”¹åŠ¨ï¼Œå½¢æˆäº†å¼ºä¾èµ–ã€‚å› æ­¤éœ€è¦æƒ³ä¸€ç§æ›´ä¼˜é›…çš„æ–¹å¼æ¥è¿›è¡Œæ›¿æ¢ã€‚\næ€è·¯ï¼š\n  å¼€å‘ç¯å¢ƒå’Œé›†æˆæµ‹è¯•ç¯å¢ƒé‡Œå‡†å¤‡ä¸€ä¸ªconfigmapï¼Œå–åä¸º devops-config\n  configmapçš„å†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š\n  å¼€å‘ç¯å¢ƒ\nNAMESPACE=dev INGRESS_MYBLOG=blog-dev.luffy.com   æµ‹è¯•ç¯å¢ƒ\nNAMESPACE=test INGRESS_MYBLOG=blog-test.luffy.com     çº¦å®šï¼šconfigmapçš„keyå€¼ï¼Œæ‹¼æ¥{{KEY}}åˆ™ä¸ºä»£ç ä¸­éœ€è¦æ›¿æ¢çš„æ¨¡æ¿éƒ¨åˆ†ï¼Œconfigmapçš„è¯¥keyå¯¹åº”çš„valueï¼Œåˆ™ä¸ºè¯¥æ¨¡æ¿è¦è¢«æ›¿æ¢çš„å€¼çš„å†…å®¹ã€‚æ¯”å¦‚ï¼š\nNAMESPACE=dev INGRESS_MYBLOG=blog-dev.luffy.com {{NAMESPACE}} = dev {{INGRESS_MYBLOG}} - blog-dev.luffy.com æ„æ€æ˜¯çº¦å®šé¡¹ç›®çš„deployçš„èµ„æºæ¸…å•ä¸­ï¼š\n æ‰€æœ‰çš„{{NAMESPACE}}è¢«æ›¿æ¢ä¸ºdev æ‰€æœ‰çš„{{INGRESS_MYBLOG}}è¢«æ›¿æ¢ä¸ºblog-dev.luffy.com    åœ¨libraryçš„é€»è¾‘ä¸­ï¼Œå®ç°è¯»å–è§¦å‘å½“å‰æ„å»ºçš„ä»£ç åˆ†æ”¯æ‰€å…³è”çš„namespaceä¸‹çš„devops-configè¿™ä¸ªconfigmapï¼Œç„¶åéå†é‡Œé¢çš„å€¼è¿›è¡Œæ¨¡æ¿æ›¿æ¢å³å¯ã€‚\n  è¿™æ ·ï¼Œåˆ™ä»¥åå†æœ‰æ–°å¢çš„é¡¹ç›®ï¼Œåˆ™åªéœ€è¦ç»´æŠ¤devops-configé…ç½®æ–‡ä»¶å³å¯ï¼Œshared-libraryåˆ™ä¸éœ€è¦éšç€é¡¹ç›®çš„å¢åŠ è€Œè¿›è¡Œä¿®æ”¹ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å®ç°libraryå’Œå…·ä½“çš„é¡¹ç›®è§£è€¦ã€‚\ndef tplHandler(){  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  String namespace = \"dev\"  if(env.TAG_NAME){  namespace = \"test\"  }  try {  def configMapData = this.getResource(namespace, \"devops-config\", \"configmap\")[\"data\"]  configMapData.each { k, v -  echo \"key is ${k}, val is ${v}\"  sh \"sed -i 's#{{${k}}}#${v}#g' ${this.resourcePath}/*\"  }  }catch (Exception exc) {  echo \"failed to get devops-config data,exception: ${exc}.\"  throw exc  } } å‡†å¤‡å¤šç¯å¢ƒ   åˆ›å»ºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒçš„å‘½åç©ºé—´\n#  $ kubectl create namespace dev $ kubectl create namespace test   åˆ†åˆ«åœ¨devå’Œtestå‘½åç©ºé—´å‡†å¤‡mysqlæ•°æ®åº“ã€‚æ¼”ç¤ºåŠŸèƒ½ï¼Œå› æ­¤mysqlæœªä½œæŒä¹…åŒ–\n$ cat mysql-all.yaml apiVersion: v1 kind: Service metadata:  name: mysql  namespace: dev spec:  ports:  - port: 3306  protocol: TCP  targetPort: 3306  selector:  app: mysql  type: ClusterIP --- apiVersion: v1 kind: Secret metadata:  name: myblog  namespace: dev type: Opaque data:  MYSQL_USER: cm9vdA==  MYSQL_PASSWD: MTIzNDU2 --- apiVersion: apps/v1 kind: Deployment metadata:  name: mysql  namespace: dev spec:  replicas: 1 #æŒ‡å®šPodå‰¯æœ¬æ•°  selector: #æŒ‡å®šPodçš„é€‰æ‹©å™¨  matchLabels:  app: mysql  template:  metadata:  labels: #ç»™Podæ‰“label  app: mysql  spec:  containers:  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_ROOT_PASSWORD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  - name: MYSQL_DATABASE  value: \"myblog\"  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  readinessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 5  periodSeconds: 10  # åˆ›å»ºå¼€å‘ç¯å¢ƒçš„æ•°æ®åº“ $ kubectl create -f mysql-all.yaml  # æ›¿æ¢devå‘½åç©ºé—´ï¼Œåˆ›å»ºæµ‹è¯•ç¯å¢ƒçš„æ•°æ®åº“ $ sed -i 's/namespace: dev/namespace: test/g' mysql-all.yaml $ kubectl create -f mysql-all.yaml   å¯¹myblogé¡¹ç›®çš„k8sèµ„æºæ¸…å•æ¨¡æ¿åŒ–æ”¹é€ \n {{NAMESPACE}} {{INGRESS_MYBLOG}} {{IMAGE_URL}}    åˆå§‹åŒ–å¼€å‘ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒçš„devops-config\n# å¼€å‘ç¯å¢ƒ $ cat devops-config-dev.txt NAMESPACE=dev INGRESS_MYBLOG=blog-dev.luffy.com  $ kubectl -n dev create configmap devops-config --from-env-file=devops-config-dev.txt  # æµ‹è¯•ç¯å¢ƒ $ cat devops-config-test.txt NAMESPACE=test INGRESS_MYBLOG=blog-test.luffy.com  $ kubectl -n test create configmap devops-config --from-env-file=devops-config-test.txt   æäº¤æœ€æ–°çš„libraryä»£ç \n  æäº¤æœ€æ–°çš„python-demoé¡¹ç›®ä»£ç \n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  PROJECT = \"myblog\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  }  stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",true,\"deploy/deployment.yaml\").start()  }  }  }  }  stage('integration test') {  when {  expression { BRANCH_NAME ==~ /v.*/ }  }  steps {  container('tools') {  script{  devops.robotTest(PROJECT)  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(PROJECT,\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(PROJECT,\"dingTalk\")  }  }  } }   éªŒè¯å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½² æ¨¡æ‹Ÿå¦‚ä¸‹æµç¨‹ï¼š\n  æäº¤ä»£ç åˆ°developåˆ†æ”¯ï¼Œè§‚å¯Ÿæ˜¯å¦éƒ¨ç½²åˆ°devçš„å‘½åç©ºé—´ä¸­ï¼Œæ³¨æ„ï¼Œç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œéœ€è¦æ‰§è¡Œmigrateæ“ä½œï¼š\n $ kubectl -n dev exec myblog-9f9f7c8cd-k6tbj python3 manage.py migrate   é…ç½®hostsè§£æï¼Œæµ‹è¯•ä½¿ç”¨http://blog-dev.luffy.com/blog/index/è¿›è¡Œè®¿é—®åˆ°developåˆ†æ”¯æœ€æ–°ç‰ˆæœ¬\n  åˆå¹¶ä»£ç è‡³masteråˆ†æ”¯\n  åœ¨gitlabä¸­åˆ›å»ºtagï¼Œè§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨éƒ¨ç½²è‡³testçš„å‘½åç©ºé—´ä¸­ï¼Œä¸”ä½¿ç”¨myblog-test.luffy.com/blog/index/å¯ä»¥è®¿é—®åˆ°æœ€æ–°ç‰ˆæœ¬\n  å®ç°æ‰“tagåè‡ªåŠ¨éƒ¨ç½² æˆ‘ä»¬å‘ç°ï¼Œæ‰“äº†tagä»¥åï¼Œå¤šåˆ†æ”¯æµæ°´çº¿ä¸­å¯ä»¥è¯†åˆ«åˆ°è¯¥tagï¼Œä½†æ˜¯å¹¶ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²è¯¥tagçš„ä»£ç ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨ä¸€ä¸ªæ–°çš„æ’ä»¶ï¼šBasic Branch Build Strategies Plugin\nå®‰è£…å¹¶é…ç½®å¤šåˆ†æ”¯æµæ°´çº¿ï¼Œæ³¨æ„Build strategies è®¾ç½®ï¼š\n Regular branches Tags  Ignore tags newer than å¯ä»¥ä¸ç”¨è®¾ç½®ï¼Œä¸ç„¶ä¼šé»˜è®¤ä¸è‡ªåŠ¨æ„å»ºæ–°æ‰“çš„tag Ignore tags older than    ä¼˜åŒ–é•œåƒéƒ¨ç½²é€»è¾‘ é’ˆå¯¹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒçš„ä»£ç ï¼Œç”±äºå·²ç»æ‰“äº†tagäº†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æœŸæœ›æ„å»ºå‡ºæ¥çš„é•œåƒåœ°å€å¯ä»¥ç›´æ¥ä½¿ç”¨ä»£ç çš„tagä½œä¸ºé•œåƒçš„tagã€‚\næ€è·¯ä¸€ï¼šç›´æ¥åœ¨Jenkinsfileè°ƒç”¨devops.dockeræ—¶ä¼ é€’tagåç§°\næ€è·¯äºŒï¼šåœ¨shared-libraryä¸­ï¼Œæ ¹æ®env.TAG_NAMEæ¥åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯tagåˆ†æ”¯çš„æ„å»ºï¼Œè‹¥TAG_NAMEä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥åœ¨æ„å»ºé•œåƒæ—¶ä½¿ç”¨TAG_NAMEä½œä¸ºé•œåƒçš„tag\nå¾ˆæ˜æ˜¾æˆ‘ä»¬æ›´æœŸæœ›ä½¿ç”¨æ€è·¯äºŒçš„æ–¹å¼æ¥å®ç°ï¼Œå› æ­¤ï¼Œéœ€è¦è°ƒæ•´å¦‚ä¸‹é€»è¾‘ï¼š\ndef docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){  this.repo = repo  this.tag = tag  if(env.TAG_NAME){  this.tag = env.TAG_NAME  }  this.dockerfile = dockerfile  this.credentialsId = credentialsId  this.context = context  this.fullAddress = \"${this.repo}:${this.tag}\"  this.isLoggedIn = false  this.msg = new BuildMessage()  return this } æäº¤ä»£ç ï¼Œå¹¶è¿›è¡Œæµ‹è¯•ï¼Œè§‚å¯Ÿæ˜¯å¦ä½¿ç”¨tagä½œä¸ºé•œåƒæ ‡ç­¾è¿›è¡Œéƒ¨ç½²ã€‚\nå°ç»“ Jenkins-shared-libraryçš„ä»£ç åœ°å€ï¼š https://gitee.com/agagin/jenkins-shared-library\nç›®æ ‡ï¼šè®©devopsæµç¨‹æ›´å¥½ç”¨\n é¡¹ç›®æ›´ç®€ä¾¿çš„æ¥å…¥ devopsæµç¨‹æ›´æ–¹ä¾¿ç»´æŠ¤  æ€è·¯ï¼šæŠŠå„é¡¹ç›®ä¸­å…¬ç”¨çš„é€»è¾‘ï¼ŒæŠ½è±¡æˆæ–¹æ³•ï¼Œæ”¾åˆ°ç‹¬ç«‹çš„libraryé¡¹ç›®ä¸­ï¼Œåœ¨å„é¡¹ç›®ä¸­å¼•å…¥shared-libraryé¡¹ç›®ï¼Œè°ƒç”¨libraryæä¾›çš„æ–¹æ³•ã€‚\n é•œåƒæ„å»ºã€æ¨é€ k8sæœåŠ¡éƒ¨ç½²ã€ç›‘æ§ é’‰é’‰æ¶ˆæ¯æ¨é€ ä»£ç æ‰«æ roboté›†æˆæµ‹è¯•  ä¸ºäº†å…¼å®¹å¤šç¯å¢ƒçš„CICDï¼Œå› æ­¤é‡‡ç”¨æ¨¡æ¿ä¸æ•°æ®åˆ†ç¦»çš„æ–¹å¼ï¼Œé¡¹ç›®ä¸­çš„å®šä¹‰æ¨¡æ¿ï¼Œshared-libraryä¸­å®ç°æ¨¡æ¿æ›¿æ¢ã€‚ä¸ºäº†å®ç°shared-libraryä¸å„é¡¹ç›®è§£è€¦ï¼Œä½¿ç”¨configmapæ¥ç»´æŠ¤æ¨¡æ¿ä¸çœŸå®æ•°æ®çš„å€¼ï¼Œæ€è·¯æ˜¯çº¦å®šå¤§äºé…ç½®ã€‚\n",
  "wordCount" : "4314",
  "inLanguage": "zh",
  "datePublished": "2022-01-10T18:27:44Z",
  "dateModified": "2022-01-10T18:27:44Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–
    </h1>
    <div class="post-meta"><span title='2022-01-10 18:27:44 +0000 UTC'>2022-01-10</span>&nbsp;Â·&nbsp;21 åˆ†é’Ÿ

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%9f%ba%e4%ba%8esharedlibrary%e8%bf%9b%e8%a1%8ccicd%e6%b5%81%e7%a8%8b%e7%9a%84%e4%bc%98%e5%8c%96" aria-label="åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ–">åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ–</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#library%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f" aria-label="Libraryå·¥ä½œæ¨¡å¼">Libraryå·¥ä½œæ¨¡å¼</a></li>
                    <li>
                        <a href="#%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="å¼€å‘ç¯å¢ƒæ­å»º">å¼€å‘ç¯å¢ƒæ­å»º</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85%e5%8c%85" aria-label="ä¸‹è½½å®‰è£…åŒ…">ä¸‹è½½å®‰è£…åŒ…</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85java" aria-label="å®‰è£…java">å®‰è£…java</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85groovy" aria-label="å®‰è£…groovy">å®‰è£…groovy</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85idea" aria-label="å®‰è£…idea">å®‰è£…idea</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84%e4%bb%8b%e7%bb%8d" aria-label="Libraryä»£ç ç»“æ„ä»‹ç»">Libraryä»£ç ç»“æ„ä»‹ç»</a></li>
                    <li>
                        <a href="#groovy%e5%9f%ba%e6%9c%ac%e8%af%ad%e6%b3%95%e4%bb%8b%e7%bb%8d" aria-label="GroovyåŸºæœ¬è¯­æ³•ä»‹ç»">GroovyåŸºæœ¬è¯­æ³•ä»‹ç»</a></li>
                    <li>
                        <a href="#library%e4%b8%8ejenkins%e9%9b%86%e6%88%90" aria-label="libraryä¸Jenkinsé›†æˆ">libraryä¸Jenkinsé›†æˆ</a><ul>
                            
                    <li>
                        <a href="#hellogroovy" aria-label="Hello.groovy">Hello.groovy</a></li>
                    <li>
                        <a href="#%e9%85%8d%e7%bd%aejenkins" aria-label="é…ç½®Jenkins">é…ç½®Jenkins</a></li>
                    <li>
                        <a href="#jenkinsfile%e4%b8%ad%e5%bc%95%e7%94%a8" aria-label="Jenkinsfileä¸­å¼•ç”¨">Jenkinsfileä¸­å¼•ç”¨</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e5%8f%8a%e6%8e%a8%e9%80%81" aria-label="libraryé›†æˆé•œåƒæ„å»ºåŠæ¨é€">libraryé›†æˆé•œåƒæ„å»ºåŠæ¨é€</a><ul>
                            
                    <li>
                        <a href="#%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e9%80%bb%e8%be%91%e5%ae%9e%e7%8e%b0" aria-label="é•œåƒæ„å»ºé€»è¾‘å®ç°">é•œåƒæ„å»ºé€»è¾‘å®ç°</a></li>
                    <li>
                        <a href="#%e4%b8%b0%e5%af%8c%e6%9e%84%e5%bb%ba%e9%80%9a%e7%9f%a5%e9%80%bb%e8%be%91" aria-label="ä¸°å¯Œæ„å»ºé€šçŸ¥é€»è¾‘">ä¸°å¯Œæ„å»ºé€šçŸ¥é€»è¾‘</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90k8s%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2" aria-label="libraryé›†æˆk8sæœåŠ¡éƒ¨ç½²">libraryé›†æˆk8sæœåŠ¡éƒ¨ç½²</a><ul>
                            
                    <li>
                        <a href="#library%e5%ae%9e%e7%8e%b0%e9%83%a8%e7%bd%b2%e7%ae%80%e5%8d%95%e7%89%88" aria-label="libraryå®ç°éƒ¨ç½²ç®€å•ç‰ˆ">libraryå®ç°éƒ¨ç½²ç®€å•ç‰ˆ</a></li>
                    <li>
                        <a href="#library%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96%e7%89%88" aria-label="libraryå®ç°è‡ªåŠ¨éƒ¨ç½²ä¼˜åŒ–ç‰ˆ">libraryå®ç°è‡ªåŠ¨éƒ¨ç½²ä¼˜åŒ–ç‰ˆ</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e5%ae%9e%e7%8e%b0%e5%8d%b3%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81" aria-label="libraryå®ç°å³æ—¶æ¶ˆæ¯æ¨é€">libraryå®ç°å³æ—¶æ¶ˆæ¯æ¨é€</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e9%80%9a%e7%9f%a5" aria-label="å®ç°æ¶ˆæ¯é€šçŸ¥">å®ç°æ¶ˆæ¯é€šçŸ¥</a></li>
                    <li>
                        <a href="#jenkinsfile%e8%b0%83%e7%94%a8" aria-label="jenkinsfileè°ƒç”¨">jenkinsfileè°ƒç”¨</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90%e4%bb%a3%e7%a0%81%e6%89%ab%e6%8f%8f" aria-label="libraryé›†æˆä»£ç æ‰«æ">libraryé›†æˆä»£ç æ‰«æ</a></li>
                    <li>
                        <a href="#%e9%9b%86%e6%88%90robot%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95" aria-label="é›†æˆrobotè‡ªåŠ¨åŒ–æµ‹è¯•">é›†æˆrobotè‡ªåŠ¨åŒ–æµ‹è¯•</a><ul>
                            
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96robot-cases%e9%a1%b9%e7%9b%ae" aria-label="åˆå§‹åŒ–robot-casesé¡¹ç›®">åˆå§‹åŒ–robot-casesé¡¹ç›®</a></li>
                    <li>
                        <a href="#%e9%85%8d%e7%bd%aejenkinsfile%e5%8f%8a%e8%87%aa%e5%8a%a8%e5%8c%96%e4%bb%bb%e5%8a%a1" aria-label="é…ç½®JenkinsfileåŠè‡ªåŠ¨åŒ–ä»»åŠ¡">é…ç½®JenkinsfileåŠè‡ªåŠ¨åŒ–ä»»åŠ¡</a></li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90%e8%a7%a6%e5%8f%91%e4%bb%bb%e5%8a%a1" aria-label="libraryé›†æˆè§¦å‘ä»»åŠ¡">libraryé›†æˆè§¦å‘ä»»åŠ¡</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%a4%9a%e7%8e%af%e5%a2%83%e7%9a%84cicd%e8%87%aa%e5%8a%a8%e5%8c%96%e5%ae%9e%e7%8e%b0" aria-label="å¤šç¯å¢ƒçš„CICDè‡ªåŠ¨åŒ–å®ç°">å¤šç¯å¢ƒçš„CICDè‡ªåŠ¨åŒ–å®ç°</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e7%9b%ae%e6%a0%87%e5%8f%8a%e6%95%88%e6%9e%9c" aria-label="å®ç°ç›®æ ‡åŠæ•ˆæœ">å®ç°ç›®æ ‡åŠæ•ˆæœ</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af" aria-label="å®ç°æ€è·¯">å®ç°æ€è·¯</a></li>
                    <li>
                        <a href="#jenkinsfile%e6%a0%b9%e6%8d%ae%e5%88%86%e6%94%af%e9%80%89%e6%8b%a9%e4%bb%bb%e5%8a%a1" aria-label="Jenkinsfileæ ¹æ®åˆ†æ”¯é€‰æ‹©ä»»åŠ¡">Jenkinsfileæ ¹æ®åˆ†æ”¯é€‰æ‹©ä»»åŠ¡</a></li>
                    <li>
                        <a href="#%e6%a8%a1%e6%9d%bf%e5%8c%96k8s%e7%9a%84%e8%b5%84%e6%ba%90%e6%b8%85%e5%8d%95" aria-label="æ¨¡æ¿åŒ–k8sçš„èµ„æºæ¸…å•">æ¨¡æ¿åŒ–k8sçš„èµ„æºæ¸…å•</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0library%e9%85%8d%e7%bd%ae%e6%9b%bf%e6%8d%a2%e9%80%bb%e8%be%91" aria-label="å®ç°libraryé…ç½®æ›¿æ¢é€»è¾‘">å®ç°libraryé…ç½®æ›¿æ¢é€»è¾‘</a></li>
                    <li>
                        <a href="#%e5%87%86%e5%a4%87%e5%a4%9a%e7%8e%af%e5%a2%83" aria-label="å‡†å¤‡å¤šç¯å¢ƒ">å‡†å¤‡å¤šç¯å¢ƒ</a></li>
                    <li>
                        <a href="#%e9%aa%8c%e8%af%81%e5%a4%9a%e7%8e%af%e5%a2%83%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2" aria-label="éªŒè¯å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²">éªŒè¯å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e6%89%93tag%e5%90%8e%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2" aria-label="å®ç°æ‰“tagåè‡ªåŠ¨éƒ¨ç½²">å®ç°æ‰“tagåè‡ªåŠ¨éƒ¨ç½²</a></li>
                    <li>
                        <a href="#%e4%bc%98%e5%8c%96%e9%95%9c%e5%83%8f%e9%83%a8%e7%bd%b2%e9%80%bb%e8%be%91" aria-label="ä¼˜åŒ–é•œåƒéƒ¨ç½²é€»è¾‘">ä¼˜åŒ–é•œåƒéƒ¨ç½²é€»è¾‘</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="å°ç»“">å°ç»“</a>
                    </li>
                </ul>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="åŸºäºsharedlibraryè¿›è¡Œcicdæµç¨‹çš„ä¼˜åŒ–">åŸºäºsharedLibraryè¿›è¡ŒCI/CDæµç¨‹çš„ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#åŸºäºsharedlibraryè¿›è¡Œcicdæµç¨‹çš„ä¼˜åŒ–">#</a></h3>
<p>ç”±äºå…¬å¸å†…éƒ¨é¡¹ç›®ä¼—å¤šï¼Œå¤§é‡çš„é¡¹ç›®ä½¿ç”¨åŒä¸€å¥—æµç¨‹åšCICD</p>
<ul>
<li>é‚£ä¹ˆåŠ¿å¿…ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤ä»£ç </li>
<li>ä¸€æ—¦æŸä¸ªå…¬å…±çš„åœ°æ–¹éœ€è¦åšè°ƒæ•´ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦ä¿®æ”¹</li>
</ul>
<p>å› æ­¤æœ¬ç« ä¸»è¦é€šè¿‡ä½¿ç”¨groovyå®ç°Jenkinsçš„sharedLibraryçš„å¼€å‘ï¼Œä»¥æå–é¡¹ç›®åœ¨CICDå®è·µè¿‡ç¨‹ä¸­çš„å…¬å…±é€»è¾‘ï¼Œæä¾›ä¸€ç³»åˆ—çš„æµç¨‹çš„æ¥å£ä¾›å…¬å¸å†…å„é¡¹ç›®è°ƒç”¨ã€‚</p>
<p>å¼€å‘å®Œæˆåï¼Œå¯¹é¡¹ç›®è¿›è¡ŒJenkinsfileçš„æ”¹é€ ï¼Œæœ€åä»…éœ€é€šè¿‡ç®€å•çš„Jenkinsfileçš„é…ç½®ï¼Œå³å¯ä¼˜é›…çš„å®ŒæˆCICDæµç¨‹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ­¤æ–¹å¼å·²åœ¨å¤§å‹ä¼ä¸šå†…éƒ¨è½åœ°åº”ç”¨ã€‚</p>
<h5 id="libraryå·¥ä½œæ¨¡å¼">Libraryå·¥ä½œæ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#libraryå·¥ä½œæ¨¡å¼">#</a></h5>
<p>ç”±äºæµæ°´çº¿è¢«ç»„ç»‡ä¸­è¶Šæ¥è¶Šå¤šçš„é¡¹ç›®æ‰€é‡‡ç”¨ï¼Œå¸¸è§çš„æ¨¡å¼å¾ˆå¯èƒ½ä¼šå‡ºç°ã€‚ åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«æµæ°´çº¿æœ‰åŠ©äºå‡å°‘å†—ä½™å¹¶ä¿æŒä»£ç  &ldquo;DRY&rdquo;ã€‚</p>
<p>æµæ°´çº¿æ”¯æŒå¼•ç”¨ &ldquo;å…±äº«åº“&rdquo; ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æºä»£ç æ§åˆ¶ä»“åº“ä¸­å®šä¹‰å¹¶åŠ è½½åˆ°ç°æœ‰çš„æµæ°´çº¿ä¸­ã€‚</p>
<pre tabindex="0"><code>@Library(&#39;my-shared-library&#39;) _
</code></pre><p>åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠlibraryä¸­å®šä¹‰çš„groovyåŠŸèƒ½æ·»åŠ åˆ°æ„å»ºç›®å½•ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy
</span></span></code></pre></div><p>ä½¿ç”¨libraryåï¼ŒJenkinsfileå¤§è‡´çš„æ ·å­å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>@Library(<span style="color:#e6db74">&#39;my-shared-library&#39;</span>) _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  stages {
</span></span><span style="display:flex;"><span>    stage(<span style="color:#e6db74">&#39;build image&#39;</span>) {
</span></span><span style="display:flex;"><span>      steps {
</span></span><span style="display:flex;"><span>         container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>           devops.buildImage(<span style="color:#e6db74">&#34;Dockerfile&#34;</span>,<span style="color:#e6db74">&#34;172.21.51.67:5000/demo:latest&#34;</span>)
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  post {
</span></span><span style="display:flex;"><span>    success {
</span></span><span style="display:flex;"><span>      script {
</span></span><span style="display:flex;"><span>          container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>              devops.notificationSuccess(<span style="color:#e6db74">&#34;dingTalk&#34;</span>)
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="å¼€å‘ç¯å¢ƒæ­å»º">å¼€å‘ç¯å¢ƒæ­å»º<a hidden class="anchor" aria-hidden="true" href="#å¼€å‘ç¯å¢ƒæ­å»º">#</a></h5>
<p>è¡¥å½•ç« èŠ‚ï¼šGroovyåŠSpringBootã€SpringCloudéƒ½ä¼šä½¿ç”¨</p>
<ul>
<li>java</li>
<li>groovy</li>
<li>intelliJ idea</li>
</ul>
<h6 id="ä¸‹è½½å®‰è£…åŒ…">ä¸‹è½½å®‰è£…åŒ…<a hidden class="anchor" aria-hidden="true" href="#ä¸‹è½½å®‰è£…åŒ…">#</a></h6>
<p>é“¾æ¥ï¼šhttps://pan.baidu.com/s/1B-bg2_IsB8dU7_62IEtnTg
æå–ç ï¼šwx6j</p>
<h6 id="å®‰è£…java">å®‰è£…java<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…java">#</a></h6>
<p>å®‰è£…è·¯å¾„ï¼šD:\software\jdk</p>
<p>ç¯å¢ƒå˜é‡ï¼š</p>
<ul>
<li>JAVA_HOME     D:\software\jdk</li>
<li>CLASSPATH      .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</li>
<li>PATH                 %JAVA_HOME%\bin</li>
</ul>
<h6 id="å®‰è£…groovy">å®‰è£…groovy<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…groovy">#</a></h6>
<p>è§£å‹è·¯å¾„ï¼šD:\software\groovy-3.0.2</p>
<p>ç¯å¢ƒå˜é‡ï¼š</p>
<ul>
<li>GROOVY_PATH      D:\software\groovy-3.0.2</li>
<li>PATH                       D:\software\groovy-3.0.2\bin</li>
</ul>
<h6 id="å®‰è£…idea">å®‰è£…idea<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…idea">#</a></h6>
<p>å®‰è£…è·¯å¾„ï¼šD:\software\IntelliJ IDEA 2019.2.3</p>
<p>æ–°å»ºé¡¹ç›®æµ‹è¯•</p>
<h5 id="libraryä»£ç ç»“æ„ä»‹ç»">Libraryä»£ç ç»“æ„ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#libraryä»£ç ç»“æ„ä»‹ç»">#</a></h5>
<p>å…±äº«åº“çš„ç›®å½•ç»“æ„å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>(root)
</span></span><span style="display:flex;"><span>+- src                     <span style="color:#75715e"># Groovy source files</span>
</span></span><span style="display:flex;"><span>|   +- org
</span></span><span style="display:flex;"><span>|       +- foo
</span></span><span style="display:flex;"><span>|           +- Bar.groovy  <span style="color:#75715e"># for org.foo.Bar class</span>
</span></span><span style="display:flex;"><span>+- vars
</span></span><span style="display:flex;"><span>|   +- foo.groovy          <span style="color:#75715e"># for global &#39;foo&#39; variable</span>
</span></span><span style="display:flex;"><span>|   +- foo.txt             <span style="color:#75715e"># help for &#39;foo&#39; variable</span>
</span></span></code></pre></div><p><code>src</code> ç›®å½•åº”è¯¥çœ‹èµ·æ¥åƒæ ‡å‡†çš„ Java æºç›®å½•ç»“æ„ã€‚å½“æ‰§è¡Œæµæ°´çº¿æ—¶ï¼Œè¯¥ç›®å½•è¢«æ·»åŠ åˆ°ç±»è·¯å¾„ä¸‹ã€‚</p>
<p><code>vars</code> ç›®å½•å®šä¹‰å¯ä»æµæ°´çº¿è®¿é—®çš„å…¨å±€å˜é‡çš„è„šæœ¬ã€‚ æ¯ä¸ª <code>*.groovy</code> æ–‡ä»¶çš„åŸºååº”è¯¥æ˜¯ä¸€ä¸ª Groovy (~ Java) æ ‡è¯†ç¬¦, é€šå¸¸æ˜¯ <code>camelCased</code>ã€‚</p>
<h5 id="groovyåŸºæœ¬è¯­æ³•ä»‹ç»">GroovyåŸºæœ¬è¯­æ³•ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#groovyåŸºæœ¬è¯­æ³•ä»‹ç»">#</a></h5>
<p>æ–°å»ºGroovyé¡¹ç›®</p>
<ul>
<li>
<p>å˜é‡</p>
<p>ä½¿ç”¨æ•°æ®ç±»å‹çš„æœ¬åœ°è¯­æ³•ï¼Œæˆ–è€…ä½¿ç”¨defå…³é”®å­—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// Defining a variable in lowercase  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Defining a variable in uppercase  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> X <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Defining a variable with the underscore in it&#39;s name 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> _Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Joe&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println<span style="color:#f92672">(</span>x<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>println<span style="color:#f92672">(</span>X<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>println<span style="color:#f92672">(</span>_Name<span style="color:#f92672">);</span> 
</span></span></code></pre></div></li>
<li>
<p>æ–¹æ³•</p>
<ul>
<li>
<p>è°ƒç”¨æœ¬åœ°æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def sum(int a, int b){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a + b
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println(sum(1,2))
</span></span></code></pre></div></li>
<li>
<p>è°ƒç”¨ç±»ä¸­çš„æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Hello.groovy</span>
</span></span><span style="display:flex;"><span>package demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def sayHi(String content) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#34;hi, &#34;</span> + content)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Demo.groovy</span>
</span></span><span style="display:flex;"><span>import demo.Hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def demo() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new Hello().sayHi(<span style="color:#e6db74">&#34;devops&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(demo())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># çº§è”è°ƒç”¨</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Hello.groovy</span>
</span></span><span style="display:flex;"><span>package demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def init(String content) {
</span></span><span style="display:flex;"><span>    this.content = content
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def sayHi() {
</span></span><span style="display:flex;"><span>    println(<span style="color:#e6db74">&#34;hi, &#34;</span> + this.content)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def sayBye() {
</span></span><span style="display:flex;"><span>    println(<span style="color:#e6db74">&#34;bye &#34;</span> + this.content)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Demo.groovy</span>
</span></span><span style="display:flex;"><span>import demo.Hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def demo() {
</span></span><span style="display:flex;"><span>    new Hello().init(<span style="color:#e6db74">&#34;devops&#34;</span>).sayHi().sayBye()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>demo()
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>å¼‚å¸¸æ•è·</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exceptionDemo</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> val <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>val<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> e
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>exceptionDemo<span style="color:#f92672">()</span>
</span></span></code></pre></div></li>
<li>
<p>è®¡æ—¶å™¨ä¸å¾ªç¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.time.TimeCategory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">use</span><span style="color:#f92672">(</span> TimeCategory <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> endTime <span style="color:#f92672">=</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">plus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">(),</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">getSeconds</span><span style="color:#f92672">(</span><span style="color:#ae81ff">15</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>counter<span style="color:#f92672">++)</span>
</span></span><span style="display:flex;"><span>        sleep<span style="color:#f92672">(</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> endTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;done&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>è§£æyamlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>import org.yaml.snakeyaml.Yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def readYaml(){
</span></span><span style="display:flex;"><span>    def content = new File(<span style="color:#e6db74">&#39;myblog.yaml&#39;</span>).text
</span></span><span style="display:flex;"><span>    Yaml parser = new Yaml()
</span></span><span style="display:flex;"><span>    def data = parser.load(content)
</span></span><span style="display:flex;"><span>    def kind = data[<span style="color:#e6db74">&#34;kind&#34;</span>]
</span></span><span style="display:flex;"><span>    def name = data[<span style="color:#e6db74">&#34;metadata&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]
</span></span><span style="display:flex;"><span>    println(kind)
</span></span><span style="display:flex;"><span>    println(name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>readYaml()
</span></span></code></pre></div></li>
</ul>
<h5 id="libraryä¸jenkinsé›†æˆ">libraryä¸Jenkinsé›†æˆ<a hidden class="anchor" aria-hidden="true" href="#libraryä¸jenkinsé›†æˆ">#</a></h5>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨shared libraryå®ç°æœ€ç®€å•çš„helloworldè¾“å‡ºåŠŸèƒ½ï¼Œæ¥ç†æ¸…æ¥šä½¿ç”¨shared libraryçš„æµç¨‹ã€‚</p>
<h6 id="hellogroovy">Hello.groovy<a hidden class="anchor" aria-hidden="true" href="#hellogroovy">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* @author Yongxin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* @version v0.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * say hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>String content<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> content
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sayHi</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Hi, ${this.content},how are you?&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">answer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;${this.content}: fine, thank you, and you?&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sayBye</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;i am fine too , ${this.content}, Bye!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>åœ¨gitlabåˆ›å»ºé¡¹ç›®ï¼ŒæŠŠlibraryä»£ç æ¨é€åˆ°é•œåƒä»“åº“ã€‚</p>
<h6 id="é…ç½®jenkins">é…ç½®Jenkins<a hidden class="anchor" aria-hidden="true" href="#é…ç½®jenkins">#</a></h6>
<p>[ç³»ç»Ÿç®¡ç†] -&gt; [ç³»ç»Ÿè®¾ç½®] -&gt; [ <strong>Global Pipeline Libraries</strong> ]</p>
<ul>
<li>Library Nameï¼šluffy-devops</li>
<li>Default Versionï¼šmaster</li>
<li>Source Code Managementï¼šGit</li>
</ul>
<h6 id="jenkinsfileä¸­å¼•ç”¨">Jenkinsfileä¸­å¼•ç”¨<a hidden class="anchor" aria-hidden="true" href="#jenkinsfileä¸­å¼•ç”¨">#</a></h6>
<p><code>jenkins/pipelines/p11.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;hello-devops&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    devops<span style="color:#f92672">.</span><span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;æ ‘å“¥&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">sayHi</span><span style="color:#f92672">().</span><span style="color:#a6e22e">answer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">sayBye</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>åˆ›å»º<code>vars/devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.devops.Hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>String content<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Hello</span><span style="color:#f92672">().</span><span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>content<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="libraryé›†æˆé•œåƒæ„å»ºåŠæ¨é€">libraryé›†æˆé•œåƒæ„å»ºåŠæ¨é€<a hidden class="anchor" aria-hidden="true" href="#libraryé›†æˆé•œåƒæ„å»ºåŠæ¨é€">#</a></h5>
<p>éœ€è¦å®ç°çš„é€»è¾‘ç‚¹ï¼š</p>
<ul>
<li>docker buildï¼Œdocker pushï¼Œdocker login</li>
<li>è´¦æˆ·å¯†ç ï¼Œjenkinså‡­æ®ï¼Œï¼ˆlibraryä¸­è·å–å‡­æ®å†…å®¹ï¼‰ï¼Œ</li>
<li>docker login 172.21.51.67:5000</li>
<li>try catch</li>
</ul>
<h6 id="é•œåƒæ„å»ºé€»è¾‘å®ç°">é•œåƒæ„å»ºé€»è¾‘å®ç°<a hidden class="anchor" aria-hidden="true" href="#é•œåƒæ„å»ºé€»è¾‘å®ç°">#</a></h6>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param repo, 172.21.51.67:5000/demo/myblog/xxx/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param tag, v1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param dockerfile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param credentialsId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>String repo<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> String credentialsId<span style="color:#f92672">,</span> String dockerfile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Dockerfile&#34;</span><span style="color:#f92672">,</span> String context<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Docker</span><span style="color:#f92672">().</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>repo<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> credentialsId<span style="color:#f92672">,</span> dockerfile<span style="color:#f92672">,</span> context<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Docker.groovy</code></p>
<p>é€»è¾‘ä¸­éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p>
<ul>
<li>æ„å»ºå’Œæ¨é€é•œåƒï¼Œéœ€è¦ç™»å½•ä»“åº“ï¼ˆéœ€è¦è®¤è¯ï¼‰</li>
<li>æ„å»ºæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œéœ€è¦å°†ç»“æœæ¨ç»™gitlabç«¯</li>
<li>ä¸ºäº†å°†æ„å»ºè¿‡ç¨‹æ¨é€åˆ°é’‰é’‰æ¶ˆæ¯ä¸­ï¼Œéœ€è¦å°†æ„å»ºä¿¡æ¯ç»Ÿä¸€æ”¶é›†</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>package com.luffy.devops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @param repo
</span></span><span style="display:flex;"><span> * @param tag
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param dockerfile
</span></span><span style="display:flex;"><span> * @param context
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def docker(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>    this.repo = repo
</span></span><span style="display:flex;"><span>    this.tag = tag
</span></span><span style="display:flex;"><span>    this.dockerfile = dockerfile
</span></span><span style="display:flex;"><span>    this.credentialsId = credentialsId
</span></span><span style="display:flex;"><span>    this.context = context
</span></span><span style="display:flex;"><span>    this.fullAddress = <span style="color:#e6db74">&#34;${this.repo}:${this.tag}&#34;</span>
</span></span><span style="display:flex;"><span>    this.isLoggedIn = false
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * build image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} &#34;</span>
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception exc) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * push image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def push() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker push ${this.fullAddress}&#34;</span>
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception exc) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * docker registry login
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def login() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(this.isLoggedIn || credentialsId == <span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // docker login
</span></span><span style="display:flex;"><span>    withCredentials([usernamePassword(credentialsId<span style="color:#960050;background-color:#1e0010">:</span> this.credentialsId, usernameVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;USERNAME&#39;</span>, passwordVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;PASSWORD&#39;</span>)]) {
</span></span><span style="display:flex;"><span>        def regs = this.getRegistry()
</span></span><span style="display:flex;"><span>        retry(3) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;docker login ${regs} -u $USERNAME -p $PASSWORD&#34;</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception exc) {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;docker login err, &#34;</span> + exc.toString()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.isLoggedIn = true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * get registry server
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def getRegistry(){
</span></span><span style="display:flex;"><span>    def sp = this.repo.split(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sp.size() &gt; 1) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sp[0]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this.repo
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>Jenkinsfile</code></p>
<p>éœ€è¦å…ˆåœ¨Jenkinsç«¯åˆ›å»ºä»“åº“ç™»å½•å‡­æ®<code>credential-registry</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="ä¸°å¯Œæ„å»ºé€šçŸ¥é€»è¾‘">ä¸°å¯Œæ„å»ºé€šçŸ¥é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#ä¸°å¯Œæ„å»ºé€šçŸ¥é€»è¾‘">#</a></h6>
<p>ç›®å‰çš„æ„å»ºé•œåƒé€»è¾‘ä¸­ç¼ºå°‘å¦‚ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>tryé€»è¾‘ä¸­ï¼Œè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ˜¯å¦è¯¥æŠŠå¼‚å¸¸æŠ›å‡º
<ul>
<li>è‹¥ç›´æ¥æŠ›å‡ºå¼‚å¸¸å¯èƒ½ä¼šå¯¼è‡´å¤šæ¬¡é‡å¤çš„å¼‚å¸¸ä¿¡æ¯</li>
<li>è‹¥ä¸æŠ›å‡ºï¼Œåˆ™å¦‚æœæœªæ„å»ºæˆåŠŸé•œåƒï¼Œæµæ°´çº¿æ„ŸçŸ¥ä¸åˆ°é”™è¯¯</li>
</ul>
</li>
<li>é€šçŸ¥gitlabç«¯æ„å»ºä»»åŠ¡åŠçŠ¶æ€</li>
<li>æ„å»ºé€šçŸ¥æ ¼å¼</li>
</ul>
<p>éœ€è¦é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œåšå‡ºä¼˜åŒ–</p>
<ol>
<li>
<p>ä¼˜åŒ–tryé€»è¾‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile}&#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            //todo
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>é€šçŸ¥gitlabç«¯æ„å»ºä»»åŠ¡åŠçŠ¶æ€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} &#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-build&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>é’‰é’‰æ¶ˆæ¯é€šçŸ¥æ ¼å¼</p>
<p>ç”±äºæ¯ä¸ªstageéƒ½éœ€è¦æ„å»ºé€šçŸ¥ä»»åŠ¡ï¼Œå› æ­¤æŠ½æˆå…¬å…±çš„é€»è¾‘ï¼Œä¸ºå„stageè°ƒç”¨</p>
<p><code>BuildMessage.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>package com.luffy.devops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def updateBuildMessage(String source, String add) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(!source){
</span></span><span style="display:flex;"><span>        source = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    env.BUILD_TASKS = source + add + <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> env.BUILD_TASKS
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>Docker.groovy</code> ä¸­è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def getObject(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    this.msg = new BuildMessage()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-build&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} OK...  âˆš&#34;</span>)
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} Failed...  x&#34;</span>)
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<p>ä½¿ç”¨<code>Jenkinsfile</code>æ¥éªŒè¯ä¸Šè¿°ä¿®æ”¹æ˜¯å¦æ­£ç¡®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;git-log&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">GIT_LOG</span> <span style="color:#f92672">=</span> readFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;gitlog.file&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;markdown&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;title&#34;:&#34;myblog&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: &#34;ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„  \n**é¡¹ç›®åç§°**ï¼šluffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${env.BUILD_TASKS}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥éœ€è¦å°†<code>push</code>å’Œ<code>login</code>æ–¹æ³•åšåŒæ ·çš„æ”¹é€ </p>
<p>æœ€ç»ˆçš„Docker.groovyæ–‡ä»¶ä¸ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>package com.luffy.devops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @param repo
</span></span><span style="display:flex;"><span> * @param tag
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param dockerfile
</span></span><span style="display:flex;"><span> * @param context
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def docker(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>    this.repo = repo
</span></span><span style="display:flex;"><span>    this.tag = tag
</span></span><span style="display:flex;"><span>    this.dockerfile = dockerfile
</span></span><span style="display:flex;"><span>    this.credentialsId = credentialsId
</span></span><span style="display:flex;"><span>    this.context = context
</span></span><span style="display:flex;"><span>    this.fullAddress = <span style="color:#e6db74">&#34;${this.repo}:${this.tag}&#34;</span>
</span></span><span style="display:flex;"><span>    this.isLoggedIn = false
</span></span><span style="display:flex;"><span>    this.msg = new BuildMessage()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * build image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} &#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-build&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} OK...  âˆš&#34;</span>)
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} Failed...  x&#34;</span>)
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * push image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def push() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker push ${this.fullAddress}&#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>    def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-push&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} OK...  âˆš&#34;</span>)
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>        this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} Failed...  x&#34;</span>)
</span></span><span style="display:flex;"><span>        // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>aborted pipeline
</span></span><span style="display:flex;"><span>        error errMsg
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * docker registry login
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def login() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(this.isLoggedIn || credentialsId == <span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // docker login
</span></span><span style="display:flex;"><span>    withCredentials([usernamePassword(credentialsId<span style="color:#960050;background-color:#1e0010">:</span> this.credentialsId, usernameVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;USERNAME&#39;</span>, passwordVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;PASSWORD&#39;</span>)]) {
</span></span><span style="display:flex;"><span>        def regs = this.getRegistry()
</span></span><span style="display:flex;"><span>        retry(3) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;docker login ${regs} -u $USERNAME -p $PASSWORD&#34;</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception ignored) {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;docker login err, ${ignored.toString()}&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.isLoggedIn = true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * get registry server
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def getRegistry(){
</span></span><span style="display:flex;"><span>    def sp = this.repo.split(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sp.size() &gt; 1) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sp[0]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this.repo
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å†æ¬¡æµ‹è¯•æ„å»º</p>
<h5 id="libraryé›†æˆk8sæœåŠ¡éƒ¨ç½²">libraryé›†æˆk8sæœåŠ¡éƒ¨ç½²<a hidden class="anchor" aria-hidden="true" href="#libraryé›†æˆk8sæœåŠ¡éƒ¨ç½²">#</a></h5>
<h6 id="libraryå®ç°éƒ¨ç½²ç®€å•ç‰ˆ">libraryå®ç°éƒ¨ç½²ç®€å•ç‰ˆ<a hidden class="anchor" aria-hidden="true" href="#libraryå®ç°éƒ¨ç½²ç®€å•ç‰ˆ">#</a></h6>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * kubernetes deployer
</span></span><span style="display:flex;"><span> * @param resourcePath
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def deploy(String resourcePath){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new Deploy().init(resourcePath)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ–°å¢<code>Deploy.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>String resourcePath<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resourcePath</span> <span style="color:#f92672">=</span> resourcePath
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BuildMessage<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//env.CURRENT_IMAGEç”¨æ¥å­˜å‚¨å½“å‰æ„å»ºçš„é•œåƒåœ°å€ï¼Œéœ€è¦åœ¨Docker.groovyä¸­è®¾ç½®å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;kubectl apply -f ${this.resourcePath}&#34;</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.stage_name} OK...  âˆš&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.stage_name} fail...  âˆš&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹<code>Docker.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">push</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">login</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> isSuccess <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> errMsg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker push ${this.fullAddress}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//æŠŠå½“å‰æ¨é€çš„é•œåƒåœ°å€è®°å½•åœ¨ç¯å¢ƒå˜é‡ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            env<span style="color:#f92672">.</span><span style="color:#a6e22e">CURRENT_IMAGE</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fullAddress</span>
</span></span><span style="display:flex;"><span>            isSuccess <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception err<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            errMsg <span style="color:#f92672">=</span> err<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Jenkinsfile</code> ä¸­æ·»åŠ å¦‚ä¸‹éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="libraryå®ç°è‡ªåŠ¨éƒ¨ç½²ä¼˜åŒ–ç‰ˆ">libraryå®ç°è‡ªåŠ¨éƒ¨ç½²ä¼˜åŒ–ç‰ˆ<a hidden class="anchor" aria-hidden="true" href="#libraryå®ç°è‡ªåŠ¨éƒ¨ç½²ä¼˜åŒ–ç‰ˆ">#</a></h6>
<p>ç®€å•ç‰ˆæœ¬æœ€æ˜æ˜¾çš„é—®é¢˜å°±æ˜¯æ— æ³•æ£€æµ‹éƒ¨ç½²åçš„PodçŠ¶æ€ï¼Œå¦‚æœæƒ³åšé›†æˆæµ‹è¯•ï¼Œé€šå¸¸è¦ç­‰åˆ°æœ€æ–°ç‰ˆæœ¬çš„Podå¯åŠ¨åå†å¼€å§‹ã€‚å› æ­¤æœ‰å¿…è¦åœ¨éƒ¨ç½²çš„æ—¶å€™æ£€æµ‹Podæ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p>
<p>æ¯”å¦‚è¦å»æ£€æŸ¥myblogåº”ç”¨çš„podæ˜¯å¦éƒ¨ç½²æ­£å¸¸ï¼Œäººå·¥æ£€æŸ¥çš„å¤§è‡´æ­¥éª¤ï¼š</p>
<ol>
<li>
<p><code>kubectl -n luffy get pod</code>ï¼ŒæŸ¥çœ‹podåˆ—è¡¨</p>
</li>
<li>
<p>æ‰¾åˆ°åˆ—è¡¨ä¸­å¸¦æœ‰myblogå…³é”®å­—çš„runningçš„pod</p>
</li>
<li>
<p>æŸ¥çœ‹ä¸Šè¿°running  podæ•°ï¼Œæ˜¯å¦å’Œmyblogçš„deploymentä¸­å®šä¹‰çš„replicaså‰¯æœ¬æ•°ä¸€è‡´</p>
</li>
<li>
<p>è‹¥ä¸€è‡´ï¼Œåˆ™æ£€æŸ¥ç»“æŸï¼Œè‹¥ä¸ä¸€è‡´ï¼Œå¯èƒ½ç¨ç­‰å‡ ç§’é’Ÿï¼Œå†æ¬¡æ‰§è¡Œç›¸åŒçš„æ£€æŸ¥æ“ä½œ</p>
</li>
<li>
<p>å¦‚æœ5åˆ†é’Ÿäº†è¿˜æ²¡æœ‰æ£€æŸ¥é€šè¿‡ï¼Œåˆ™å¤§æ¦‚ç‡æ˜¯podæœ‰é—®é¢˜ï¼Œé€šè¿‡æŸ¥çœ‹æ—¥å¿—è¿›ä¸€æ­¥æ’æŸ¥</p>
</li>
</ol>
<p>å¦‚ä½•é€šè¿‡libraryä»£ç å®ç°ä¸Šè¿°è¿‡ç¨‹ï¼š</p>
<ol>
<li>
<p>libraryå¦‚ä½•è·å–myblogçš„podåˆ—è¡¨ï¼Ÿ</p>
<ul>
<li>
<p>é¦–å…ˆè¦çŸ¥é“æœ¬æ¬¡éƒ¨ç½²çš„æ˜¯å“ªä¸ªworkloadï¼Œå› æ­¤éœ€è¦è°ƒç”¨è€…ä¼ é€’workloadçš„yamlæ–‡ä»¶è·¯å¾„</p>
</li>
<li>
<p>libraryè§£æworkload.yamlæ–‡ä»¶ï¼Œæ‰¾åˆ°å¦‚ä¸‹å€¼ï¼š</p>
<ul>
<li>podæ‰€åœ¨çš„namespace</li>
<li>podä¸­ä½¿ç”¨çš„<code>labels</code>æ ‡ç­¾</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥æ‰¾è¯¥workloadå…³è”çš„pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n &lt;namespace&gt; get po -l &lt;key1=value1&gt; -l &lt;key2=value2&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æŸ¥æ‰¾myblogçš„pod</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>å¦‚ä½•ç¡®å®šæ­¥éª¤1ä¸­çš„podçš„çŠ¶æ€ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># æˆ–è€…å¯ä»¥ç›´æ¥è¿›è¡Œæå–çŠ¶æ€</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog -ojsonpath=<span style="color:#e6db74">&#39;{.items[0].status.phase}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä»¥jsonæ•°ç»„çš„å½¢å¼å­˜å‚¨</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog -o json
</span></span></code></pre></div></li>
<li>
<p>å¦‚ä½•æ£€æµ‹æ‰€æœ‰çš„å‰¯æœ¬æ•°éƒ½æ˜¯æ­£å¸¸çš„ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ä»¥jsonæ•°ç»„çš„å½¢å¼å­˜å‚¨</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog -o json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># éå†æ•°ç»„ï¼Œæ£€æµ‹æ¯ä¸€ä¸ªpodæŸ¥çœ‹æ˜¯å¦å‡æ­£å¸¸ï¼ˆterminatingå’Œevictedé™¤å¤–ï¼‰</span>
</span></span></code></pre></div></li>
<li>
<p>å¦‚ä½•å®ç°åœ¨5åˆ†é’Ÿçš„æ—¶é—´å†…ï¼Œè‹¥podçŠ¶æ€ç¬¦åˆé¢„æœŸï¼Œåˆ™é€€å‡ºæ£€æµ‹å¾ªç¯ï¼Œè‹¥ä¸ç¬¦åˆé¢„æœŸåˆ™ç»§ç»­æ£€æµ‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>use( TimeCategory ) {
</span></span><span style="display:flex;"><span>  def endTime = TimeCategory.plus(new Date(), TimeCategory.getMinutes(timeoutMinutes,5))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (new Date() &gt;= endTime) {
</span></span><span style="display:flex;"><span>        //è¶…æ—¶äº†<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>åˆ™å®£å‘ŠpodçŠ¶æ€ä¸å¯¹
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;deploy&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> new Exception(<span style="color:#e6db74">&#34;deployment timed out...&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    //å¾ªç¯æ£€æµ‹å½“å‰deploymentä¸‹çš„podçš„çŠ¶æ€
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (this.isDeploymentReady()) {
</span></span><span style="display:flex;"><span>          readyCount++
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span>(readyCount &gt; 5){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;deploy&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          readyCount = 0
</span></span><span style="display:flex;"><span>      }<span style="color:#66d9ef">catch</span> (Exception exc){
</span></span><span style="display:flex;"><span>          echo exc.toString()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      //æ¯æ¬¡æ£€æµ‹è‹¥ä¸æ»¡è¶³æ‰€æœ‰podå‡æ­£å¸¸<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>åˆ™sleep 5ç§’é’Ÿåç»§ç»­æ£€æµ‹
</span></span><span style="display:flex;"><span>      sleep(5)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
</ol>
<p><code>devops.groovy</code></p>
<p>é€šè¿‡æ·»åŠ å‚æ•° watchæ¥æ§åˆ¶æ˜¯å¦åœ¨pipelineä¸­è§‚å¯Ÿpodçš„è¿è¡ŒçŠ¶æ€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param resourcePath
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param watch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param workloadFilePath
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span>String resourcePath<span style="color:#f92672">,</span> Boolean watch <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> String workloadFilePath<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Deploy</span><span style="color:#f92672">().</span><span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>resourcePath<span style="color:#f92672">,</span> watch<span style="color:#f92672">,</span> workloadFilePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å®Œæ•´ç‰ˆçš„<code>Deploy.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.yaml.snakeyaml.Yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.json.JsonSlurperClassic
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.time.TimeCategory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>String resourcePath<span style="color:#f92672">,</span> Boolean watch<span style="color:#f92672">,</span> String workloadFilePath<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resourcePath</span> <span style="color:#f92672">=</span> resourcePath
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BuildMessage<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">watch</span> <span style="color:#f92672">=</span> watch
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadFilePath</span> <span style="color:#f92672">=</span> workloadFilePath
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(!</span>resourcePath <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>workloadFilePath<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">Exception</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;illegal resource path&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;kubectl apply -f ${this.resourcePath}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.stage_name} fail...  âˆš&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">watch</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆå§‹åŒ–workloadæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        initWorkload<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        String namespace <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span>
</span></span><span style="display:flex;"><span>        String name <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadName</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">toLowerCase</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;deployment&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;begin watch pod status from deployment ${env.workloadName}...&#34;</span>
</span></span><span style="display:flex;"><span>            monitorDeployment<span style="color:#f92672">(</span>namespace<span style="color:#f92672">,</span> name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//todo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            echo <span style="color:#e6db74">&#34;workload type ${env.workloadType} does not support for now...&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} OK...  âˆš&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initWorkload</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> content <span style="color:#f92672">=</span> readFile <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadFilePath</span>
</span></span><span style="display:flex;"><span>        Yaml parser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Yaml<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> data <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span><span style="color:#a6e22e">load</span><span style="color:#f92672">(</span>content<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> kind <span style="color:#f92672">=</span> data<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;kind&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>kind<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">Exception</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;workload file ${kind} illegal, will exit pipeline!&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadType</span> <span style="color:#f92672">=</span> kind
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;${data}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span> <span style="color:#f92672">=</span> data<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;metadata&#34;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#34;namespace&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadName</span> <span style="color:#f92672">=</span> data<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;metadata&#34;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;failed to readFile ${this.workloadFilePath},exception: ${exc}.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param namespace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param timeoutMinutes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param sleepTime
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">monitorDeployment</span><span style="color:#f92672">(</span>String namespace<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> timeoutMinutes <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> sleepTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> readyCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> readyTarget <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    use<span style="color:#f92672">(</span> TimeCategory <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> endTime <span style="color:#f92672">=</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">plus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">(),</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinutes</span><span style="color:#f92672">(</span>timeoutMinutes<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> lastRolling
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// checking timeout
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> endTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;timeout, printing logs...&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">printContainerLogs</span><span style="color:#f92672">(</span>lastRolling<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} Failed...  x&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deployment timed out...&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// checking deployment status
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> rolling <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>namespace<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;deployment&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                lastRolling <span style="color:#f92672">=</span> rolling
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isDeploymentReady</span><span style="color:#f92672">(</span>rolling<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    readyCount<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;ready total count: ${readyCount}&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>readyCount <span style="color:#f92672">&gt;=</span> readyTarget<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} OK...  âˆš&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    readyCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;reseting ready total count: ${readyCount}ï¼Œprint pods event logs&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">printContainerLogs</span><span style="color:#f92672">(</span>lastRolling<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl get pod -n ${namespace} -o wide&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_RESULT</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} Failed...  Ã—&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;error: ${exc}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            sleep<span style="color:#f92672">(</span>sleepTime<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>String namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span><span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;deployment&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;kubectl get ${kind} -n ${namespace} ${name} -o json &gt; ${namespace}-${name}-yaml.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> jsonStr <span style="color:#f92672">=</span> readFile <span style="color:#e6db74">&#34;${namespace}-${name}-yaml.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> jsonSlurper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonSlurperClassic<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> jsonObj <span style="color:#f92672">=</span> jsonSlurper<span style="color:#f92672">.</span><span style="color:#a6e22e">parseText</span><span style="color:#f92672">(</span>jsonStr<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonObj
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printContainerLogs</span><span style="color:#f92672">(</span>deployJson<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deployJson <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> namespace <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">namespace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> name <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> labels<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">labels</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        labels <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${labels} -l=${k}=${v}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;kubectl describe pods -n ${namespace} ${labels}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">isDeploymentReady</span><span style="color:#f92672">(</span>deployJson<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> status <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> replicas <span style="color:#f92672">=</span> status<span style="color:#f92672">.</span><span style="color:#a6e22e">replicas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> unavailable <span style="color:#f92672">=</span> status<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;unavailableReplicas&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> ready <span style="color:#f92672">=</span> status<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;readyReplicas&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>unavailable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> deployReady <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ready <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> ready <span style="color:#f92672">==</span> replicas<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get pod information
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> deployReady<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">labels</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> labels<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> namespace <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">namespace</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> name <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>            deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">labels</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>                labels <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${labels} -l=${k}=${v}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>labels <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;kubectl get pods -n ${namespace} ${labels} -o json &gt; ${namespace}-${name}-json.json&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> jsonStr <span style="color:#f92672">=</span> readFile <span style="color:#e6db74">&#34;${namespace}-${name}-json.json&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> jsonSlurper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonSlurperClassic<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> jsonObj <span style="color:#f92672">=</span> jsonSlurper<span style="color:#f92672">.</span><span style="color:#a6e22e">parseText</span><span style="color:#f92672">(</span>jsonStr<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> totalCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> readyCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                jsonObj<span style="color:#f92672">.</span><span style="color:#a6e22e">items</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;pod phase ${k.status.phase}&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">phase</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;Terminating&#34;</span> <span style="color:#f92672">&amp;&amp;</span> k<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">phase</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;Evicted&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        totalCount<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">phase</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Running&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            readyCount<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;Pod running count ${totalCount} == ${readyCount}&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> totalCount <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> totalCount <span style="color:#f92672">==</span> readyCount
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> deployReady
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹<code>Jenkinsfile</code> è°ƒç”¨éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    script{
</span></span><span style="display:flex;"><span>                    	devops.deploy(<span style="color:#e6db74">&#34;deploy&#34;</span>, true, <span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span>).start()
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h5 id="libraryå®ç°å³æ—¶æ¶ˆæ¯æ¨é€">libraryå®ç°å³æ—¶æ¶ˆæ¯æ¨é€<a hidden class="anchor" aria-hidden="true" href="#libraryå®ç°å³æ—¶æ¶ˆæ¯æ¨é€">#</a></h5>
<h6 id="å®ç°æ¶ˆæ¯é€šçŸ¥">å®ç°æ¶ˆæ¯é€šçŸ¥<a hidden class="anchor" aria-hidden="true" href="#å®ç°æ¶ˆæ¯é€šçŸ¥">#</a></h6>
<p>ç”±äºå‘é€æ¶ˆæ¯é€šçŸ¥å±äºé€šç”¨çš„åŠŸèƒ½ï¼Œå› æ­¤æœ‰å¿…è¦æŠŠæ¶ˆæ¯é€šçŸ¥æŠ½è±¡æˆä¸ºé€šç”¨çš„åŠŸèƒ½ã€‚</p>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * notificationSuccess
</span></span><span style="display:flex;"><span> * @param project
</span></span><span style="display:flex;"><span> * @param receiver
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param title
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def notificationSuccess(String project, String receiver=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String credentialsId=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String title=<span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>    new Notification().getObject(project, receiver, credentialsId, title).notification(<span style="color:#e6db74">&#34;success&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * notificationFailed
</span></span><span style="display:flex;"><span> * @param project
</span></span><span style="display:flex;"><span> * @param receiver
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param title
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def notificationFailed(String project, String receiver=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String credentialsId=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String title=<span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>    new Notification().getObject(project, receiver, credentialsId, title).notification(<span style="color:#e6db74">&#34;failure&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ–°å»º<code>Notification.groovy</code>æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param credentialsId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param title
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getObject</span><span style="color:#f92672">(</span>String project<span style="color:#f92672">,</span> String receiver<span style="color:#f92672">,</span> String credentialsId<span style="color:#f92672">,</span> String title<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">project</span> <span style="color:#f92672">=</span> project
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">=</span> receiver
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">credentialsId</span> <span style="color:#f92672">=</span> credentialsId
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">=</span> title
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notification</span><span style="color:#f92672">(</span>String type<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    String msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ğŸ˜„ğŸ‘ ${this.title} ğŸ‘ğŸ˜„&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ğŸ˜„ğŸ‘ æµæ°´çº¿æˆåŠŸå•¦ ğŸ‘ğŸ˜„&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// failed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;failure&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ğŸ˜–âŒ ${this.title} âŒğŸ˜–&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ğŸ˜–âŒ æµæ°´çº¿å¤±è´¥äº† âŒğŸ˜–&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	String title <span style="color:#f92672">=</span> msg
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rich notify msg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> genNotificationMessage<span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//new DingTalk().markDown(title, msg, this.credentialsId)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ignored<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;wechat&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//todo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//todo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        error <span style="color:#e6db74">&#34;no support notify type!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * get notification msg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param msg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">genNotificationMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// project
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **é¡¹ç›®åç§°**: ${this.project}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get git log
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">def</span> gitlog <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>        gitlog <span style="color:#f92672">=</span> readFile <span style="color:#e6db74">&#34;gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ignored<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gitlog <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> gitlog <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **Git log**: ${gitlog}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get git branch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">def</span> gitbranch <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">BRANCH_NAME</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gitbranch <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> gitbranch <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **Git branch**: ${gitbranch}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// build tasks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **Build Tasks**: ${env.BUILD_TASKS}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get buttons
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> msg <span style="color:#f92672">+</span> getButtonMsg<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> msg
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getButtonMsg</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    String res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span>  buttons <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;æŸ¥çœ‹æµæ°´çº¿&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;actionURL&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;${env.RUN_DISPLAY_URL}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ä»£ç æ‰«æç»“æœ&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;actionURL&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://sonar.luffy.com/dashboard?id=${this.project}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    buttons<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>res <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;   \n &gt;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${res} --- [&#34;</span><span style="color:#f92672">+</span>it<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">]+</span><span style="color:#e6db74">&#34;](&#34;</span><span style="color:#f92672">+</span>it<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;actionURL&#34;</span><span style="color:#f92672">]+</span><span style="color:#e6db74">&#34;) &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æ–°å»º<code>DingTalk.groovy</code>æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.json.JsonOutput
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> credentialsId<span style="color:#f92672">,</span> Boolean verbose<span style="color:#f92672">=</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> codes<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100:399&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> reqBody <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonOutput<span style="color:#f92672">().</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>data<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    withCredentials<span style="color:#f92672">([</span>usernamePassword<span style="color:#f92672">(</span>credentialsId: credentialsId<span style="color:#f92672">,</span> usernameVariable: <span style="color:#e6db74">&#39;USERNAME&#39;</span><span style="color:#f92672">,</span> passwordVariable: <span style="color:#e6db74">&#39;PASSWORD&#39;</span><span style="color:#f92672">)])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> response <span style="color:#f92672">=</span> httpRequest<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                httpMode:method<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                url: <span style="color:#e6db74">&#34;https://oapi.dingtalk.com/robot/send?access_token=${PASSWORD}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                requestBody:reqBody<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                validResponseCodes: codes<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                contentType: <span style="color:#e6db74">&#34;APPLICATION_JSON&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                quiet: <span style="color:#f92672">!</span>verbose
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">markDown</span><span style="color:#f92672">(</span>String title<span style="color:#f92672">,</span> String text<span style="color:#f92672">,</span> String credentialsId<span style="color:#f92672">,</span> Boolean verbose<span style="color:#f92672">=</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> data <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;msgtype&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;markdown&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;markdown&#34;</span><span style="color:#f92672">:</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">:</span> title<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">:</span> text
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> credentialsId<span style="color:#f92672">,</span> verbose<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>éœ€è¦ç”¨åˆ°Http Requestæ¥å‘é€æ¶ˆæ¯ï¼Œå®‰è£…ä¸€ä¸‹æ’ä»¶ï¼šhttp_request</p>
<h6 id="jenkinsfileè°ƒç”¨">jenkinsfileè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#jenkinsfileè°ƒç”¨">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationSuccess</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationFailure</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="libraryé›†æˆä»£ç æ‰«æ">libraryé›†æˆä»£ç æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#libraryé›†æˆä»£ç æ‰«æ">#</a></h5>
<p>sonarqubeä»£ç æ‰«æä½œä¸ºé€šç”¨åŠŸèƒ½ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨libraryå®ç°ã€‚</p>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * sonarqube scanner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param projectVersion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param waitScan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scan</span><span style="color:#f92672">(</span>String projectVersion<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> Boolean waitScan <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Sonar</span><span style="color:#f92672">().</span><span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>projectVersion<span style="color:#f92672">,</span> waitScan<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æ–°å»º<code>Sonar.groovy</code></p>
<ul>
<li>å¯ä»¥ä¼ é€’projectVersionä½œä¸ºsonarqubeçš„æ‰«æç‰ˆæœ¬</li>
<li>å‚æ•°waitScanæ¥è®¾ç½®æ˜¯å¦ç­‰å¾…æœ¬æ¬¡æ‰«ææ˜¯å¦é€šè¿‡</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>String projectVersion<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> Boolean waitScan <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitScan</span> <span style="color:#f92672">=</span> waitScan
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BuildMessage<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>projectVersion <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        projectVersion <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> script: <span style="color:#e6db74">&#39;git log --oneline -n 1|cut -d &#34; &#34; -f 1&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;echo &#39;\nsonar.projectVersion=${projectVersion}&#39; &gt;&gt; sonar-project.properties&#34;</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;cat sonar-project.properties&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startToSonar</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">startToSonar</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    withSonarQubeEnv<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;sonar-scanner -X;&#34;</span>
</span></span><span style="display:flex;"><span>        sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitScan</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//wait 3min
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> qg <span style="color:#f92672">=</span> waitForQualityGate<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>            String stage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${env.stage_name}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>qg<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;OK&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${stage} Failed...  Ã—&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#34;${stage}&#34;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                error <span style="color:#e6db74">&#34;Pipeline aborted due to quality gate failure: ${qg.status}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_RESULT</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${stage} OK...  âˆš&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#34;${stage}&#34;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;skip waitScan&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Jenkinsfile</code>æ–°å¢å¦‚ä¸‹éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops<span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="é›†æˆrobotè‡ªåŠ¨åŒ–æµ‹è¯•">é›†æˆrobotè‡ªåŠ¨åŒ–æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#é›†æˆrobotè‡ªåŠ¨åŒ–æµ‹è¯•">#</a></h5>
<p>å…³äºé›†æˆæµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å‡ ç‚¹:</p>
<ul>
<li>æµ‹è¯•äººå‘˜è¿›è¡Œç¼–å†™</li>
<li>ä¾§é‡äºä¸åŒæ¨¡å—çš„æ¥å£è°ƒç”¨ï¼Œå¯¹æ–°åŠ çš„åŠŸèƒ½è¿›è¡ŒéªŒè¯</li>
<li>æ³¨é‡æ–°ç‰ˆæœ¬å¯¹ä»¥å‰çš„é›†æˆç”¨ä¾‹è¿›è¡Œå›å½’</li>
</ul>
<p>å› æ­¤ï¼Œæ›´å¤šçš„åº”è¯¥æ˜¯è·¨æ¨¡å—å»æµ‹è¯•ï¼Œè€Œä¸”æµ‹è¯•ç”¨ä¾‹æ˜¯æµ‹è¯•äººå‘˜å»ç»´æŠ¤ï¼Œå› æ­¤ä¸é€‚åˆæŠŠä»£ç æ”¾åœ¨å¼€å‘çš„gitä»“åº“ä¸­ã€‚</p>
<p>æœ¬èŠ‚è¦å®ç°çš„å·¥ä½œï¼š</p>
<ol>
<li>åˆ›å»ºæ–°çš„gitä»“åº“<code>robot-cases</code>ï¼Œç”¨äºå­˜æ”¾robotæµ‹è¯•ç”¨ä¾‹</li>
<li>ä¸º<code>robot-cases</code>é¡¹ç›®åˆ›å»ºJenkinsfile</li>
<li>é…ç½®Jenkinsä»»åŠ¡ï¼Œå®ç°è¯¥é¡¹ç›®çš„è‡ªåŠ¨åŒ–æ‰§è¡Œ</li>
<li>åœ¨myblogæ¨¡å—çš„æµæ°´çº¿ä¸­ï¼Œå¯¹è¯¥æµæ°´çº¿é¡¹ç›®è¿›è¡Œè°ƒç”¨</li>
</ol>
<h6 id="åˆå§‹åŒ–robot-casesé¡¹ç›®">åˆå§‹åŒ–robot-casesé¡¹ç›®<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–robot-casesé¡¹ç›®">#</a></h6>
<ol>
<li>
<p>æ–°å»ºgitlabé¡¹ç›®ï¼Œåç§°ä¸º<code>robot-cases</code></p>
</li>
<li>
<p>cloneåˆ°æœ¬åœ°</p>
</li>
<li>
<p>æœ¬åœ°æ‹·è´myblogé¡¹ç›®çš„<code>robot.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>robot-cases/
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â””â”€â”€</span> myblog
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â””â”€â”€</span> robot.txt
</span></span></code></pre></div></li>
</ol>
<h6 id="é…ç½®jenkinsfileåŠè‡ªåŠ¨åŒ–ä»»åŠ¡">é…ç½®JenkinsfileåŠè‡ªåŠ¨åŒ–ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#é…ç½®jenkinsfileåŠè‡ªåŠ¨åŒ–ä»»åŠ¡">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>robot-cases/
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”œâ”€â”€</span> Jenkinsfile
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â””â”€â”€</span> myblog
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â””â”€â”€</span> robot.txt
</span></span></code></pre></div><p><code>Jenkinsfile</code></p>
<p>å¤šä¸ªä¸šåŠ¡é¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹éƒ½åœ¨ä¸€ä¸ªä»“åº“ä¸­ï¼Œå› æ­¤éœ€è¦æ ¹æ®å‚æ•°è®¾ç½®æ¥å†³å®šæ‰§è¡Œå“ªä¸ªé¡¹ç›®çš„ç”¨ä¾‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                env<span style="color:#f92672">.</span><span style="color:#a6e22e">testDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;business1&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                env<span style="color:#f92672">.</span><span style="color:#a6e22e">testDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;business1&#34;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                env<span style="color:#f92672">.</span><span style="color:#a6e22e">testDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;robot -d artifacts/ ${testDir}/*&#39;</span>
</span></span><span style="display:flex;"><span>                        step<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>                            $class <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;RobotPublisher&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            outputPath: <span style="color:#e6db74">&#39;artifacts/&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            outputFileName <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;output.xml&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            disableArchiveOutput <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            passThreshold <span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            unstableThreshold: <span style="color:#ae81ff">80.0</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            onlyCritical <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            otherFiles <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>                        archiveArtifacts artifacts: <span style="color:#e6db74">&#39;artifacts/*&#39;</span><span style="color:#f92672">,</span> fingerprint: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å¦‚ä½•å®ç°å°†<code>env.comp</code> ä¼ é€’è¿›å»ï¼Ÿ</p>
<p>é…ç½®æµæ°´çº¿çš„å‚æ•°åŒ–æ„å»ºä»»åŠ¡å¹¶éªŒè¯å‚æ•°åŒ–æ„å»º</p>
<h6 id="libraryé›†æˆè§¦å‘ä»»åŠ¡">libraryé›†æˆè§¦å‘ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#libraryé›†æˆè§¦å‘ä»»åŠ¡">#</a></h6>
<p>ç”±äºå¤šä¸ªé¡¹ç›®å‡éœ€è¦è§¦å‘è‡ªåŠ¨æ„å»ºï¼Œå› æ­¤å¯ä»¥åœ¨libraryä¸­æŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ¥æ”¶compå‚æ•°ï¼Œå¹¶åœ¨libraryä¸­å®ç°å¯¹<code>robot-cases</code>é¡¹ç›®çš„è§¦å‘ã€‚</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8esharedLibrary%e8%bf%9b%e8%a1%8cCICD%e6%b5%81%e7%a8%8b%e7%9a%84%e4%bc%98%e5%8c%96/robot-trigger.png" alt=""  />
</p>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param comp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">robotTest</span><span style="color:#f92672">(</span>String comp<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Robot</span><span style="color:#f92672">().</span><span style="color:#a6e22e">acceptanceTest</span><span style="color:#f92672">(</span>comp<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æ–°å»º<code>Robot.groovy</code>æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">acceptanceTest</span><span style="color:#f92672">(</span>comp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Trigger to execute Acceptance Testing&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> rf <span style="color:#f92672">=</span> build job: <span style="color:#e6db74">&#39;robot-cases&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                parameters: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        string<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;comp&#39;</span><span style="color:#f92672">,</span> value: comp<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>                wait: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                propagate: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> result <span style="color:#f92672">=</span> rf<span style="color:#f92672">.</span><span style="color:#a6e22e">getResult</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME}... &#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;SUCCESS&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;âˆš success&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;UNSTABLE&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;âš  unstable&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;Ã— failure&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        echo rf<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbsoluteUrl</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">.</span><span style="color:#a6e22e">ROBOT_TEST_URL</span> <span style="color:#f92672">=</span> rf<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbsoluteUrl</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BuildMessage</span><span style="color:#f92672">().</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;trigger  execute Acceptance Testing exception: ${exc}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BuildMessage</span><span style="color:#f92672">().</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_RESULT</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ä¿®æ”¹<code>Jenkinsfile</code>æµ‹è¯•è°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;integration test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">robotTest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="å¤šç¯å¢ƒçš„cicdè‡ªåŠ¨åŒ–å®ç°">å¤šç¯å¢ƒçš„CICDè‡ªåŠ¨åŒ–å®ç°<a hidden class="anchor" aria-hidden="true" href="#å¤šç¯å¢ƒçš„cicdè‡ªåŠ¨åŒ–å®ç°">#</a></h5>
<h6 id="å®ç°ç›®æ ‡åŠæ•ˆæœ">å®ç°ç›®æ ‡åŠæ•ˆæœ<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç›®æ ‡åŠæ•ˆæœ">#</a></h6>
<p>ç›®å‰é¡¹ç›®å­˜åœ¨<code>develop</code>å’Œ<code>master</code>ä¸¤ä¸ªåˆ†æ”¯ï¼ŒJenkinsfileä¸­é…ç½®çš„éƒ½æ˜¯æ„å»ºéƒ¨ç½²åˆ°ç›¸åŒçš„ç¯å¢ƒï¼Œå®é™…çš„åœºæ™¯ä¸­ï¼Œä»£ç ä»“åº“çš„é¡¹ç›®å¾€å¾€ä¸åŒçš„åˆ†æ”¯æœ‰ä¸åŒçš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ªå·¥ä½œæµç¨‹ï¼š</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8esharedLibrary%e8%bf%9b%e8%a1%8cCICD%e6%b5%81%e7%a8%8b%e7%9a%84%e4%bc%98%e5%8c%96/multi-envs.jpg" alt=""  />
</p>
<ul>
<li>
<p>å¼€å‘äººå‘˜æäº¤ä»£ç åˆ°developåˆ†æ”¯</p>
</li>
<li>
<p>Jenkinsè‡ªåŠ¨ä½¿ç”¨developåˆ†æ”¯åšå•æµ‹ã€ä»£ç æ‰«æã€é•œåƒæ„å»ºï¼ˆä»¥commit idä¸ºé•œåƒtagï¼‰ã€æœåŠ¡éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ</p>
</li>
<li>
<p>å¼€å‘äººå‘˜ä½¿ç”¨å¼€å‘ç¯å¢ƒè‡ªæµ‹</p>
</li>
<li>
<p>æµ‹è¯•å®Œæˆåï¼Œåœ¨gitlabæäº¤merge requestè¯·æ±‚ï¼Œå°†ä»£ç åˆå¹¶è‡³masteråˆ†æ”¯</p>
</li>
<li>
<p>éœ€è¦å‘ç‰ˆæ—¶ï¼Œåœ¨gitlabç«¯åŸºäºmasteråˆ†æ”¯åˆ›å»ºtagï¼ˆv2.3.0ï¼‰</p>
</li>
<li>
<p>Jenkinsè‡ªåŠ¨æ£€æµ‹åˆ°tagï¼Œæ‹‰å–tagå…³è”çš„ä»£ç åšå•æµ‹ã€ä»£ç æ‰«æã€é•œåƒæ„å»ºï¼ˆä»¥ä»£ç çš„tagä¸ºé•œåƒçš„tagï¼‰ã€æœåŠ¡éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒã€æ‰§è¡Œé›†æˆæµ‹è¯•ç”¨ä¾‹ï¼Œè¾“å‡ºæµ‹è¯•æŠ¥å‘Š</p>
</li>
<li>
<p>æµ‹è¯•äººå‘˜è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•</p>
</li>
<li>
<p>ä¸Šçº¿</p>
</li>
</ul>
<h6 id="å®ç°æ€è·¯">å®ç°æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#å®ç°æ€è·¯">#</a></h6>
<p>ä»¥myblogé¡¹ç›®ä¸ºä¾‹ï¼Œç›®å‰å·²ç»å…·å¤‡çš„æ˜¯developåˆ†æ”¯ä»£ç æäº¤åï¼Œå¯ä»¥è‡ªåŠ¨å®ç°ï¼š</p>
<ul>
<li>å•å…ƒæµ‹è¯•ã€ä»£ç æ‰«æ</li>
<li>é•œåƒæ„å»º</li>
<li>k8sæœåŠ¡éƒ¨ç½²</li>
<li>roboté›†æˆç”¨ä¾‹æµ‹è¯•</li>
</ul>
<p>å’Œä¸Šè¿°ç›®æ ‡ç›¸æ¯”ï¼Œå·®å¼‚ç‚¹ï¼š</p>
<ol>
<li>myblogåº”ç”¨ç›®å‰åªæœ‰ä¸€å¥—ç¯å¢ƒï¼Œåœ¨luffyå‘½åç©ºé—´ä¸­ã€‚æˆ‘ä»¬æ–°å»ºä¸¤ä¸ªå‘½åç©ºé—´ï¼š
<ul>
<li>devï¼Œç”¨ä½œéƒ¨ç½²å¼€å‘ç¯å¢ƒ</li>
<li>testï¼Œç”¨ä½œéƒ¨ç½²é›†æˆæµ‹è¯•ç¯å¢ƒ</li>
</ul>
</li>
<li>éœ€è¦æ ¹æ®ä¸åŒçš„åˆ†æ”¯æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆå®ç°ï¼š
<ul>
<li>developå’Œmasteråˆ†æ”¯ä½¿ç”¨ä¸åŒçš„Jenkinsfile
<ul>
<li>å¯è¡Œæ€§å¾ˆå·®ï¼Œå› ä¸ºä»£ç åˆå¹¶å·¥ä½œå¾ˆç¹ç</li>
<li>ç»´æŠ¤æˆæœ¬é«˜ï¼Œå¤šä¸ªåˆ†æ”¯éœ€è¦ç»´æŠ¤å¤šä¸ªJenkinsfile</li>
</ul>
</li>
<li>ä½¿ç”¨åŒä¸€å¥—Jenkinsfileï¼Œé…åˆlibraryå’Œæ¨¡æ¿æ¥å®ç°ä¸€å¥—Jenkinsfileé€‚é…å¤šå¥—ç¯å¢ƒ
<ul>
<li>æ”¹é€ Jenkinsfileï¼Œå®ç°æ ¹æ®åˆ†æ”¯æ¥é€‰æ‹©ä»»åŠ¡</li>
<li>éœ€è¦å°†deployç›®å½•ä¸­æ‰€æœ‰å’Œç‰¹å®šç¯å¢ƒç»‘å®šçš„å†…å®¹æ¨¡æ¿åŒ–</li>
<li>åœ¨libraryä¸­å®ç°æ ¹æ®ä¸åŒçš„åˆ†æ”¯ï¼Œæ¥æ›¿æ¢æ¨¡æ¿ä¸­çš„å†…å®¹</li>
</ul>
</li>
</ul>
</li>
</ol>
<h6 id="jenkinsfileæ ¹æ®åˆ†æ”¯é€‰æ‹©ä»»åŠ¡">Jenkinsfileæ ¹æ®åˆ†æ”¯é€‰æ‹©ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#jenkinsfileæ ¹æ®åˆ†æ”¯é€‰æ‹©ä»»åŠ¡">#</a></h6>
<p>ä½¿ç”¨whenå…³é”®å­—ï¼Œé…åˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ç°åˆ†æ”¯çš„è¿‡æ»¤é€‰æ‹©ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;Example Build&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;Example Deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            when {
</span></span><span style="display:flex;"><span>                expression { BRANCH_NAME ==~ <span style="color:#e6db74">&#34;develop&#34;</span> }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Deploying to develop env&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åˆ†åˆ«åœ¨developå’Œmasteråˆ†æ”¯è¿›è¡ŒéªŒè¯ã€‚</p>
<p>é’ˆå¯¹æœ¬ä¾‹ï¼Œå¯ä»¥å¯¹Jenkinsfileåšå¦‚ä¸‹è°ƒæ•´ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;integration test&#39;</span>) {
</span></span><span style="display:flex;"><span>            when {
</span></span><span style="display:flex;"><span>                expression { BRANCH_NAME ==~ /v.*/ }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    script{
</span></span><span style="display:flex;"><span>                    	devops.robotTest(PROJECT)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h6 id="æ¨¡æ¿åŒ–k8sçš„èµ„æºæ¸…å•">æ¨¡æ¿åŒ–k8sçš„èµ„æºæ¸…å•<a hidden class="anchor" aria-hidden="true" href="#æ¨¡æ¿åŒ–k8sçš„èµ„æºæ¸…å•">#</a></h6>
<p>å› ä¸ºéœ€è¦ä½¿ç”¨åŒä¸€å¥—æ¨¡æ¿å’ŒJenkinsfileæ¥éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒï¼Œå› æ­¤åŠ¿å¿…è¦å¯¹èµ„æºæ¸…å•è¿›è¡Œæ¨¡æ¿åŒ–ï¼Œå‰é¢çš„å†…å®¹ä¸­åªå°†<code>deployment.yaml</code>æ”¾åˆ°äº†é¡¹ç›®çš„<code>deploy</code>æ¸…å•ç›®å½•ï¼Œæ­¤å¤„å°†éƒ¨ç½²myblogç”¨åˆ°çš„èµ„æºæ¸…å•å‡è¡¥å……è¿›å»ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li>deployment.yaml</li>
<li>service.yaml</li>
<li>ingress.yaml</li>
<li>configmap.yaml</li>
<li>secret.yaml</li>
</ul>
<p>æ¶‰åŠåˆ°éœ€è¦è¿›è¡Œæ¨¡æ¿åŒ–çš„å†…å®¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p>é•œåƒåœ°å€</p>
</li>
<li>
<p>å‘½åç©ºé—´</p>
</li>
<li>
<p>ingressçš„åŸŸåä¿¡æ¯</p>
</li>
</ul>
<p>æ¨¡æ¿åŒ–åçš„æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat deployment.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1   <span style="color:#75715e">#æŒ‡å®šPodå‰¯æœ¬æ•°</span>
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>             <span style="color:#75715e">#æŒ‡å®šPodçš„é€‰æ‹©å™¨</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>   <span style="color:#75715e">#ç»™Podæ‰“label</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span> {{IMAGE_URL}}
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> IfNotPresent
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_HOST
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            configMapKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_HOST
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PORT
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            configMapKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PORT
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PASSWD
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PASSWD
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 500Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 100m
</span></span><span style="display:flex;"><span>        livenessProbe<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          httpGet<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            path<span style="color:#960050;background-color:#1e0010">:</span> /blog/index/
</span></span><span style="display:flex;"><span>            port<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>            scheme<span style="color:#960050;background-color:#1e0010">:</span> HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds<span style="color:#960050;background-color:#1e0010">:</span> 10  <span style="color:#75715e"># å®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’</span>
</span></span><span style="display:flex;"><span>          periodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 15     <span style="color:#75715e"># æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds<span style="color:#960050;background-color:#1e0010">:</span> 2             <span style="color:#75715e"># æ¢æµ‹è¶…æ—¶æ—¶é—´</span>
</span></span><span style="display:flex;"><span>        readinessProbe<span style="color:#960050;background-color:#1e0010">:</span> 
</span></span><span style="display:flex;"><span>          httpGet<span style="color:#960050;background-color:#1e0010">:</span> 
</span></span><span style="display:flex;"><span>            path<span style="color:#960050;background-color:#1e0010">:</span> /blog/index/
</span></span><span style="display:flex;"><span>            port<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>            scheme<span style="color:#960050;background-color:#1e0010">:</span> HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds<span style="color:#960050;background-color:#1e0010">:</span> 10 
</span></span><span style="display:flex;"><span>          timeoutSeconds<span style="color:#960050;background-color:#1e0010">:</span> 2
</span></span><span style="display:flex;"><span>          periodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 15
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat configmap.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>data<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  MYSQL_HOST<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  MYSQL_PORT<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;3306&#34;</span>
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> ConfigMap
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat secret.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>data<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  MYSQL_PASSWD<span style="color:#960050;background-color:#1e0010">:</span> MTIzNDU2
</span></span><span style="display:flex;"><span>  MYSQL_USER<span style="color:#960050;background-color:#1e0010">:</span> cm9vdA==
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Secret
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>type<span style="color:#960050;background-color:#1e0010">:</span> Opaque
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat service.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - port<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  sessionAffinity<span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>  type<span style="color:#960050;background-color:#1e0010">:</span> ClusterIP
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat ingress.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> {{INGRESS_MYBLOG}}
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span></code></pre></div><h6 id="å®ç°libraryé…ç½®æ›¿æ¢é€»è¾‘">å®ç°libraryé…ç½®æ›¿æ¢é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#å®ç°libraryé…ç½®æ›¿æ¢é€»è¾‘">#</a></h6>
<p>æˆ‘ä»¬éœ€è¦å®ç°ä½¿ç”¨ç›¸åŒçš„æ¨¡æ¿ï¼Œåšåˆ°å¦‚ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li>æ ¹æ®ä»£ç åˆ†æ”¯æ¥éƒ¨ç½²åˆ°ä¸åŒçš„å‘½åç©ºé—´
<ul>
<li>developåˆ†æ”¯éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒï¼Œä½¿ç”¨å‘½åç©ºé—´ dev</li>
<li>v.*éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨å‘½åç©ºé—´ test</li>
</ul>
</li>
<li>ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„ingressåœ°å€æ¥è®¿é—®
<ul>
<li>å¼€å‘ç¯å¢ƒï¼Œ<code>blog-dev.luffy.com</code></li>
<li>æµ‹è¯•ç¯å¢ƒï¼Œ<code>blog-test.luffy.com</code></li>
</ul>
</li>
</ul>
<p>å¦‚ä½•å®ç°ï¼Ÿsharedlibrary</p>
<p>æ‰€æœ‰çš„é€»è¾‘éƒ½ä¼šç»è¿‡libraryè¿™ä¸€å±‚ï¼Œæˆ‘ä»¬å…·æœ‰å®Œå…¨å¯æ§æƒã€‚</p>
<p>å‰é¢å·²ç»æ›¿æ¢è¿‡é•œåƒåœ°å€äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å¦‚ä¸‹é€»è¾‘ï¼š</p>
<ul>
<li>æ£€æµ‹å½“å‰ä»£ç åˆ†æ”¯ï¼Œæ›¿æ¢å‘½åç©ºé—´</li>
<li>æ£€æµ‹å½“å‰ä»£ç åˆ†æ”¯ï¼Œæ›¿æ¢Ingressåœ°å€</li>
</ul>
<p>é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•æ£€æµ‹æ„å»ºçš„è§¦å‘æ˜¯developåˆ†æ”¯è¿˜æ˜¯tagåˆ†æ”¯ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šenv.TAG_NAMEï¼Œç”±tagåˆ†æ”¯è§¦å‘çš„æ„å»ºï¼Œç¯å¢ƒå˜é‡ä¸­ä¼šå¸¦æœ‰TAG_NAMEï¼Œä¸”å€¼ä¸ºgitlabä¸­çš„tagåç§°ã€‚</p>
<p>åšä¸ªæ¼”ç¤ºï¼š</p>
<p>ä½¿ç”¨å¦‚ä¸‹çš„Jenkinsfileï¼ŒæŸ¥çœ‹ç”±masteråˆ†æ”¯è§¦å‘å’Œç”±tagåˆ†æ”¯è§¦å‘ï¼Œprintenvçš„å€¼æœ‰ä»€ä¹ˆä¸åŒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example Deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span> BRANCH_NAME <span style="color:#f92672">==~</span> <span style="color:#e6db74">&#34;develop&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Deploying to develop env&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥é€‰æ‹©å’Œæ›¿æ¢imageé•œåƒåœ°å€ä¸€æ ·ï¼Œæ¥æ‰§è¡Œæ›¿æ¢ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tplHandler</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>    String namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>    String ingress <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blog-dev.luffy.com&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAG_NAME</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>        ingress <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blog-test.luffy.com&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{NAMESPACE}}#${namespace}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{INGRESS_MYBLOG}}#${ingress}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ä½†æ˜¯æˆ‘ä»¬çš„libraryæ˜¯è¦ä¸ºå¤šä¸ªé¡¹ç›®æä¾›æœåŠ¡çš„ï¼Œå¦‚æœé‡‡ç”¨ä¸Šè¿°æ–¹å¼ï¼Œåˆ™æ¯åŠ å…¥ä¸€ä¸ªé¡¹ç›®ï¼Œéƒ½éœ€è¦å¯¹libraryåšæ”¹åŠ¨ï¼Œå½¢æˆäº†å¼ºä¾èµ–ã€‚å› æ­¤éœ€è¦æƒ³ä¸€ç§æ›´ä¼˜é›…çš„æ–¹å¼æ¥è¿›è¡Œæ›¿æ¢ã€‚</p>
<p>æ€è·¯ï¼š</p>
<ol>
<li>
<p>å¼€å‘ç¯å¢ƒå’Œé›†æˆæµ‹è¯•ç¯å¢ƒé‡Œå‡†å¤‡ä¸€ä¸ªconfigmapï¼Œå–åä¸º <code>devops-config</code></p>
</li>
<li>
<p>configmapçš„å†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>å¼€å‘ç¯å¢ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>NAMESPACE=dev
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-dev.luffy.com
</span></span></code></pre></div></li>
<li>
<p>æµ‹è¯•ç¯å¢ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>NAMESPACE=test
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-test.luffy.com
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>çº¦å®šï¼šconfigmapçš„keyå€¼ï¼Œæ‹¼æ¥{{KEY}}åˆ™ä¸ºä»£ç ä¸­éœ€è¦æ›¿æ¢çš„æ¨¡æ¿éƒ¨åˆ†ï¼Œconfigmapçš„è¯¥keyå¯¹åº”çš„valueï¼Œåˆ™ä¸ºè¯¥æ¨¡æ¿è¦è¢«æ›¿æ¢çš„å€¼çš„å†…å®¹ã€‚æ¯”å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>NAMESPACE=dev
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-dev.luffy.com
</span></span><span style="display:flex;"><span>{{NAMESPACE}} =&gt; dev
</span></span><span style="display:flex;"><span>{{INGRESS_MYBLOG}} -&gt; blog-dev.luffy.com
</span></span></code></pre></div><p>æ„æ€æ˜¯çº¦å®šé¡¹ç›®çš„deployçš„èµ„æºæ¸…å•ä¸­ï¼š</p>
<ul>
<li>æ‰€æœ‰çš„<code>{{NAMESPACE}}</code>è¢«æ›¿æ¢ä¸º<code>dev</code></li>
<li>æ‰€æœ‰çš„<code>{{INGRESS_MYBLOG}}</code>è¢«æ›¿æ¢ä¸º<code>blog-dev.luffy.com</code></li>
</ul>
</li>
<li>
<p>åœ¨libraryçš„é€»è¾‘ä¸­ï¼Œå®ç°è¯»å–è§¦å‘å½“å‰æ„å»ºçš„ä»£ç åˆ†æ”¯æ‰€å…³è”çš„namespaceä¸‹çš„<code>devops-config</code>è¿™ä¸ªconfigmapï¼Œç„¶åéå†é‡Œé¢çš„å€¼è¿›è¡Œæ¨¡æ¿æ›¿æ¢å³å¯ã€‚</p>
</li>
</ol>
<p>è¿™æ ·ï¼Œåˆ™ä»¥åå†æœ‰æ–°å¢çš„é¡¹ç›®ï¼Œåˆ™åªéœ€è¦ç»´æŠ¤<code>devops-config</code>é…ç½®æ–‡ä»¶å³å¯ï¼Œshared-libraryåˆ™ä¸éœ€è¦éšç€é¡¹ç›®çš„å¢åŠ è€Œè¿›è¡Œä¿®æ”¹ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å®ç°libraryå’Œå…·ä½“çš„é¡¹ç›®è§£è€¦ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tplHandler</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>    String namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAG_NAME</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> configMapData <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>namespace<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;devops-config&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;configmap&#34;</span><span style="color:#f92672">)[</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        configMapData<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;key is ${k}, val is ${v}&#34;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{${k}}}#${v}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;failed to get devops-config data,exception: ${exc}.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="å‡†å¤‡å¤šç¯å¢ƒ">å‡†å¤‡å¤šç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#å‡†å¤‡å¤šç¯å¢ƒ">#</a></h6>
<ol>
<li>
<p>åˆ›å»ºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒçš„å‘½åç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace dev
</span></span><span style="display:flex;"><span>$ kubectl create namespace test
</span></span></code></pre></div></li>
<li>
<p>åˆ†åˆ«åœ¨devå’Œtestå‘½åç©ºé—´å‡†å¤‡mysqlæ•°æ®åº“ã€‚æ¼”ç¤ºåŠŸèƒ½ï¼Œå› æ­¤mysqlæœªä½œæŒä¹…åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat mysql-all.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> dev
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - port<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  type<span style="color:#960050;background-color:#1e0010">:</span> ClusterIP
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Secret
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> dev
</span></span><span style="display:flex;"><span>type<span style="color:#960050;background-color:#1e0010">:</span> Opaque
</span></span><span style="display:flex;"><span>data<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  MYSQL_USER<span style="color:#960050;background-color:#1e0010">:</span> cm9vdA==
</span></span><span style="display:flex;"><span>  MYSQL_PASSWD<span style="color:#960050;background-color:#1e0010">:</span> MTIzNDU2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> dev
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1   <span style="color:#75715e">#æŒ‡å®šPodå‰¯æœ¬æ•°</span>
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>             <span style="color:#75715e">#æŒ‡å®šPodçš„é€‰æ‹©å™¨</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>   <span style="color:#75715e">#ç»™Podæ‰“label</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span> 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/mysql<span style="color:#960050;background-color:#1e0010">:</span>5.7-utf8
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_ROOT_PASSWORD
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PASSWD
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_DATABASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 500Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 100m
</span></span><span style="display:flex;"><span>        readinessProbe<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          tcpSocket<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            port<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>          initialDelaySeconds<span style="color:#960050;background-color:#1e0010">:</span> 5
</span></span><span style="display:flex;"><span>          periodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºå¼€å‘ç¯å¢ƒçš„æ•°æ®åº“</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> mysql-all.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ›¿æ¢devå‘½åç©ºé—´ï¼Œåˆ›å»ºæµ‹è¯•ç¯å¢ƒçš„æ•°æ®åº“</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/namespace: dev/namespace: test/g&#39;</span> mysql-all.yaml
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> mysql-all.yaml
</span></span></code></pre></div></li>
<li>
<p>å¯¹myblogé¡¹ç›®çš„k8sèµ„æºæ¸…å•æ¨¡æ¿åŒ–æ”¹é€ </p>
<ul>
<li>{{NAMESPACE}}</li>
<li>{{INGRESS_MYBLOG}}</li>
<li>{{IMAGE_URL}}</li>
</ul>
</li>
<li>
<p>åˆå§‹åŒ–å¼€å‘ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒçš„<code>devops-config</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># å¼€å‘ç¯å¢ƒ</span>
</span></span><span style="display:flex;"><span>$ cat devops-config-dev.txt
</span></span><span style="display:flex;"><span>NAMESPACE=dev
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-dev.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n dev create configmap devops-config --from-env<span style="color:#f92672">-file</span>=devops-config-dev.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•ç¯å¢ƒ</span>
</span></span><span style="display:flex;"><span>$ cat devops-config-test.txt
</span></span><span style="display:flex;"><span>NAMESPACE=test
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-test.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n test create configmap devops-config --from-env<span style="color:#f92672">-file</span>=devops-config-test.txt
</span></span></code></pre></div></li>
<li>
<p>æäº¤æœ€æ–°çš„libraryä»£ç </p>
</li>
<li>
<p>æäº¤æœ€æ–°çš„python-demoé¡¹ç›®ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        PROJECT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops<span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;integration test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span> BRANCH_NAME <span style="color:#f92672">==~</span> <span style="color:#e6db74">/v.*/</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">robotTest</span><span style="color:#f92672">(</span>PROJECT<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationSuccess</span><span style="color:#f92672">(</span>PROJECT<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationFailure</span><span style="color:#f92672">(</span>PROJECT<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h6 id="éªŒè¯å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²">éªŒè¯å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²<a hidden class="anchor" aria-hidden="true" href="#éªŒè¯å¤šç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²">#</a></h6>
<p>æ¨¡æ‹Ÿå¦‚ä¸‹æµç¨‹ï¼š</p>
<ol>
<li>
<p>æäº¤ä»£ç åˆ°developåˆ†æ”¯ï¼Œè§‚å¯Ÿæ˜¯å¦éƒ¨ç½²åˆ°devçš„å‘½åç©ºé—´ä¸­ï¼Œæ³¨æ„ï¼Œç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œéœ€è¦æ‰§è¡Œmigrateæ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> $ kubectl -n dev exec  myblog-9f9f7c8cd-k6tbj python3 manage.py migrate
</span></span></code></pre></div></li>
<li>
<p>é…ç½®hostsè§£æï¼Œæµ‹è¯•ä½¿ç”¨<code>http://blog-dev.luffy.com/blog/index/</code>è¿›è¡Œè®¿é—®åˆ°developåˆ†æ”¯æœ€æ–°ç‰ˆæœ¬</p>
</li>
<li>
<p>åˆå¹¶ä»£ç è‡³masteråˆ†æ”¯</p>
</li>
<li>
<p>åœ¨gitlabä¸­åˆ›å»ºtagï¼Œè§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨éƒ¨ç½²è‡³testçš„å‘½åç©ºé—´ä¸­ï¼Œä¸”ä½¿ç”¨<code>myblog-test.luffy.com/blog/index/</code>å¯ä»¥è®¿é—®åˆ°æœ€æ–°ç‰ˆæœ¬</p>
</li>
</ol>
<h6 id="å®ç°æ‰“tagåè‡ªåŠ¨éƒ¨ç½²">å®ç°æ‰“tagåè‡ªåŠ¨éƒ¨ç½²<a hidden class="anchor" aria-hidden="true" href="#å®ç°æ‰“tagåè‡ªåŠ¨éƒ¨ç½²">#</a></h6>
<p>æˆ‘ä»¬å‘ç°ï¼Œæ‰“äº†tagä»¥åï¼Œå¤šåˆ†æ”¯æµæ°´çº¿ä¸­å¯ä»¥è¯†åˆ«åˆ°è¯¥tagï¼Œä½†æ˜¯å¹¶ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²è¯¥tagçš„ä»£ç ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨ä¸€ä¸ªæ–°çš„æ’ä»¶ï¼šBasic Branch Build Strategies Plugin</p>
<p>å®‰è£…å¹¶é…ç½®å¤šåˆ†æ”¯æµæ°´çº¿ï¼Œæ³¨æ„Build strategies è®¾ç½®ï¼š</p>
<ul>
<li>Regular branches</li>
<li>Tags
<ul>
<li>Ignore tags newer than å¯ä»¥ä¸ç”¨è®¾ç½®ï¼Œä¸ç„¶ä¼šé»˜è®¤ä¸è‡ªåŠ¨æ„å»ºæ–°æ‰“çš„tag</li>
<li>Ignore tags older than</li>
</ul>
</li>
</ul>
<h6 id="ä¼˜åŒ–é•œåƒéƒ¨ç½²é€»è¾‘">ä¼˜åŒ–é•œåƒéƒ¨ç½²é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#ä¼˜åŒ–é•œåƒéƒ¨ç½²é€»è¾‘">#</a></h6>
<p>é’ˆå¯¹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒçš„ä»£ç ï¼Œç”±äºå·²ç»æ‰“äº†tagäº†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æœŸæœ›æ„å»ºå‡ºæ¥çš„é•œåƒåœ°å€å¯ä»¥ç›´æ¥ä½¿ç”¨ä»£ç çš„tagä½œä¸ºé•œåƒçš„tagã€‚</p>
<p>æ€è·¯ä¸€ï¼šç›´æ¥åœ¨Jenkinsfileè°ƒç”¨<code>devops.docker</code>æ—¶ä¼ é€’tagåç§°</p>
<p>æ€è·¯äºŒï¼šåœ¨shared-libraryä¸­ï¼Œæ ¹æ®<code>env.TAG_NAME</code>æ¥åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯tagåˆ†æ”¯çš„æ„å»ºï¼Œè‹¥TAG_NAMEä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥åœ¨æ„å»ºé•œåƒæ—¶ä½¿ç”¨TAG_NAMEä½œä¸ºé•œåƒçš„tag</p>
<p>å¾ˆæ˜æ˜¾æˆ‘ä»¬æ›´æœŸæœ›ä½¿ç”¨æ€è·¯äºŒçš„æ–¹å¼æ¥å®ç°ï¼Œå› æ­¤ï¼Œéœ€è¦è°ƒæ•´å¦‚ä¸‹é€»è¾‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def docker(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>    this.repo = repo
</span></span><span style="display:flex;"><span>    this.tag = tag
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(env.TAG_NAME){
</span></span><span style="display:flex;"><span>        this.tag = env.TAG_NAME
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.dockerfile = dockerfile
</span></span><span style="display:flex;"><span>    this.credentialsId = credentialsId
</span></span><span style="display:flex;"><span>    this.context = context
</span></span><span style="display:flex;"><span>    this.fullAddress = <span style="color:#e6db74">&#34;${this.repo}:${this.tag}&#34;</span>
</span></span><span style="display:flex;"><span>    this.isLoggedIn = false
</span></span><span style="display:flex;"><span>    this.msg = new BuildMessage()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æäº¤ä»£ç ï¼Œå¹¶è¿›è¡Œæµ‹è¯•ï¼Œè§‚å¯Ÿæ˜¯å¦ä½¿ç”¨tagä½œä¸ºé•œåƒæ ‡ç­¾è¿›è¡Œéƒ¨ç½²ã€‚</p>
<h5 id="å°ç»“">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“">#</a></h5>
<p>Jenkins-shared-libraryçš„ä»£ç åœ°å€ï¼š <a href="https://gitee.com/agagin/jenkins-shared-library">https://gitee.com/agagin/jenkins-shared-library</a></p>
<p>ç›®æ ‡ï¼šè®©devopsæµç¨‹æ›´å¥½ç”¨</p>
<ul>
<li>é¡¹ç›®æ›´ç®€ä¾¿çš„æ¥å…¥</li>
<li>devopsæµç¨‹æ›´æ–¹ä¾¿ç»´æŠ¤</li>
</ul>
<p>æ€è·¯ï¼šæŠŠå„é¡¹ç›®ä¸­å…¬ç”¨çš„é€»è¾‘ï¼ŒæŠ½è±¡æˆæ–¹æ³•ï¼Œæ”¾åˆ°ç‹¬ç«‹çš„libraryé¡¹ç›®ä¸­ï¼Œåœ¨å„é¡¹ç›®ä¸­å¼•å…¥shared-libraryé¡¹ç›®ï¼Œè°ƒç”¨libraryæä¾›çš„æ–¹æ³•ã€‚</p>
<ul>
<li>é•œåƒæ„å»ºã€æ¨é€</li>
<li>k8sæœåŠ¡éƒ¨ç½²ã€ç›‘æ§</li>
<li>é’‰é’‰æ¶ˆæ¯æ¨é€</li>
<li>ä»£ç æ‰«æ</li>
<li>roboté›†æˆæµ‹è¯•</li>
</ul>
<p>ä¸ºäº†å…¼å®¹å¤šç¯å¢ƒçš„CICDï¼Œå› æ­¤é‡‡ç”¨æ¨¡æ¿ä¸æ•°æ®åˆ†ç¦»çš„æ–¹å¼ï¼Œé¡¹ç›®ä¸­çš„å®šä¹‰æ¨¡æ¿ï¼Œshared-libraryä¸­å®ç°æ¨¡æ¿æ›¿æ¢ã€‚ä¸ºäº†å®ç°shared-libraryä¸å„é¡¹ç›®è§£è€¦ï¼Œä½¿ç”¨configmapæ¥ç»´æŠ¤æ¨¡æ¿ä¸çœŸå®æ•°æ®çš„å€¼ï¼Œæ€è·¯æ˜¯çº¦å®šå¤§äºé…ç½®ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>SpringBootä¸SpringCloudå¾®æœåŠ¡é¡¹ç›®äº¤ä»˜</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">äº¬ICPå¤‡2021039488å·</a>
    </span>

    æ€»è®¿å®¢ï¼š<span id="busuanzi_value_site_uv"></span>
    æ€»æµè§ˆé‡ï¼š<span id="busuanzi_value_site_pv"></span>
    é¡µé¢è®¿é—®é‡ï¼š<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
