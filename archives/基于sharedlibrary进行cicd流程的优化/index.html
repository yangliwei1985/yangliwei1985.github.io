<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>基于sharedLibrary进行CICD流程的优化 | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="基于sharedLibrary进行CI/CD流程的优化 由于公司内部项目众多，大量的项目使用同一套流程做CICD
 那么势必会存在大量的重复代码 一旦某个公共的地方需要做调整，每个项目都需要修改  因此本章主要通过使用groovy实现Jenkins的sharedLibrary的开发，以提取项目在CICD实践过程中的公共逻辑，提供一系列的流程的接口供公司内各项目调用。
开发完成后，对项目进行Jenkinsfile的改造，最后仅需通过简单的Jenkinsfile的配置，即可优雅的完成CICD流程的整个过程，此方式已在大型企业内部落地应用。
Library工作模式 由于流水线被组织中越来越多的项目所采用，常见的模式很可能会出现。 在多个项目之间共享流水线有助于减少冗余并保持代码 &ldquo;DRY&rdquo;。
流水线支持引用 &ldquo;共享库&rdquo; ，可以在外部源代码控制仓库中定义并加载到现有的流水线中。
@Library(&#39;my-shared-library&#39;) _ 在实际运行过程中，会把library中定义的groovy功能添加到构建目录中：
/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy 使用library后，Jenkinsfile大致的样子如下：
@Library(&#39;my-shared-library&#39;) _  ...  stages {  stage(&#39;build image&#39;) {  steps {  container(&#39;tools&#39;) {  devops.buildImage(&#34;Dockerfile&#34;,&#34;172.21.51.67:5000/demo:latest&#34;)  }  }  }  }   post {  success {  script {  container(&#39;tools&#39;) {  devops.notificationSuccess(&#34;dingTalk&#34;)  }  }  }  } .">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="基于sharedLibrary进行CICD流程的优化" />
<meta property="og:description" content="基于sharedLibrary进行CI/CD流程的优化 由于公司内部项目众多，大量的项目使用同一套流程做CICD
 那么势必会存在大量的重复代码 一旦某个公共的地方需要做调整，每个项目都需要修改  因此本章主要通过使用groovy实现Jenkins的sharedLibrary的开发，以提取项目在CICD实践过程中的公共逻辑，提供一系列的流程的接口供公司内各项目调用。
开发完成后，对项目进行Jenkinsfile的改造，最后仅需通过简单的Jenkinsfile的配置，即可优雅的完成CICD流程的整个过程，此方式已在大型企业内部落地应用。
Library工作模式 由于流水线被组织中越来越多的项目所采用，常见的模式很可能会出现。 在多个项目之间共享流水线有助于减少冗余并保持代码 &ldquo;DRY&rdquo;。
流水线支持引用 &ldquo;共享库&rdquo; ，可以在外部源代码控制仓库中定义并加载到现有的流水线中。
@Library(&#39;my-shared-library&#39;) _ 在实际运行过程中，会把library中定义的groovy功能添加到构建目录中：
/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy 使用library后，Jenkinsfile大致的样子如下：
@Library(&#39;my-shared-library&#39;) _  ...  stages {  stage(&#39;build image&#39;) {  steps {  container(&#39;tools&#39;) {  devops.buildImage(&#34;Dockerfile&#34;,&#34;172.21.51.67:5000/demo:latest&#34;)  }  }  }  }   post {  success {  script {  container(&#39;tools&#39;) {  devops.notificationSuccess(&#34;dingTalk&#34;)  }  }  }  } ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-10T18:27:44&#43;00:00" />
<meta property="article:modified_time" content="2022-01-10T18:27:44&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="基于sharedLibrary进行CICD流程的优化"/>
<meta name="twitter:description" content="基于sharedLibrary进行CI/CD流程的优化 由于公司内部项目众多，大量的项目使用同一套流程做CICD
 那么势必会存在大量的重复代码 一旦某个公共的地方需要做调整，每个项目都需要修改  因此本章主要通过使用groovy实现Jenkins的sharedLibrary的开发，以提取项目在CICD实践过程中的公共逻辑，提供一系列的流程的接口供公司内各项目调用。
开发完成后，对项目进行Jenkinsfile的改造，最后仅需通过简单的Jenkinsfile的配置，即可优雅的完成CICD流程的整个过程，此方式已在大型企业内部落地应用。
Library工作模式 由于流水线被组织中越来越多的项目所采用，常见的模式很可能会出现。 在多个项目之间共享流水线有助于减少冗余并保持代码 &ldquo;DRY&rdquo;。
流水线支持引用 &ldquo;共享库&rdquo; ，可以在外部源代码控制仓库中定义并加载到现有的流水线中。
@Library(&#39;my-shared-library&#39;) _ 在实际运行过程中，会把library中定义的groovy功能添加到构建目录中：
/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy 使用library后，Jenkinsfile大致的样子如下：
@Library(&#39;my-shared-library&#39;) _  ...  stages {  stage(&#39;build image&#39;) {  steps {  container(&#39;tools&#39;) {  devops.buildImage(&#34;Dockerfile&#34;,&#34;172.21.51.67:5000/demo:latest&#34;)  }  }  }  }   post {  success {  script {  container(&#39;tools&#39;) {  devops.notificationSuccess(&#34;dingTalk&#34;)  }  }  }  } ."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "基于sharedLibrary进行CICD流程的优化",
      "item": "https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于sharedLibrary进行CICD流程的优化",
  "name": "基于sharedLibrary进行CICD流程的优化",
  "description": "基于sharedLibrary进行CI/CD流程的优化 由于公司内部项目众多，大量的项目使用同一套流程做CICD\n 那么势必会存在大量的重复代码 一旦某个公共的地方需要做调整，每个项目都需要修改  因此本章主要通过使用groovy实现Jenkins的sharedLibrary的开发，以提取项目在CICD实践过程中的公共逻辑，提供一系列的流程的接口供公司内各项目调用。\n开发完成后，对项目进行Jenkinsfile的改造，最后仅需通过简单的Jenkinsfile的配置，即可优雅的完成CICD流程的整个过程，此方式已在大型企业内部落地应用。\nLibrary工作模式 由于流水线被组织中越来越多的项目所采用，常见的模式很可能会出现。 在多个项目之间共享流水线有助于减少冗余并保持代码 \u0026ldquo;DRY\u0026rdquo;。\n流水线支持引用 \u0026ldquo;共享库\u0026rdquo; ，可以在外部源代码控制仓库中定义并加载到现有的流水线中。\n@Library(\u0026#39;my-shared-library\u0026#39;) _ 在实际运行过程中，会把library中定义的groovy功能添加到构建目录中：\n/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy 使用library后，Jenkinsfile大致的样子如下：\n@Library(\u0026#39;my-shared-library\u0026#39;) _  ...  stages {  stage(\u0026#39;build image\u0026#39;) {  steps {  container(\u0026#39;tools\u0026#39;) {  devops.buildImage(\u0026#34;Dockerfile\u0026#34;,\u0026#34;172.21.51.67:5000/demo:latest\u0026#34;)  }  }  }  }   post {  success {  script {  container(\u0026#39;tools\u0026#39;) {  devops.notificationSuccess(\u0026#34;dingTalk\u0026#34;)  }  }  }  } .",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "基于sharedLibrary进行CI/CD流程的优化 由于公司内部项目众多，大量的项目使用同一套流程做CICD\n 那么势必会存在大量的重复代码 一旦某个公共的地方需要做调整，每个项目都需要修改  因此本章主要通过使用groovy实现Jenkins的sharedLibrary的开发，以提取项目在CICD实践过程中的公共逻辑，提供一系列的流程的接口供公司内各项目调用。\n开发完成后，对项目进行Jenkinsfile的改造，最后仅需通过简单的Jenkinsfile的配置，即可优雅的完成CICD流程的整个过程，此方式已在大型企业内部落地应用。\nLibrary工作模式 由于流水线被组织中越来越多的项目所采用，常见的模式很可能会出现。 在多个项目之间共享流水线有助于减少冗余并保持代码 “DRY”。\n流水线支持引用 “共享库” ，可以在外部源代码控制仓库中定义并加载到现有的流水线中。\n@Library('my-shared-library') _ 在实际运行过程中，会把library中定义的groovy功能添加到构建目录中：\n/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy 使用library后，Jenkinsfile大致的样子如下：\n@Library('my-shared-library') _  ...  stages {  stage('build image') {  steps {  container('tools') {  devops.buildImage(\"Dockerfile\",\"172.21.51.67:5000/demo:latest\")  }  }  }  }   post {  success {  script {  container('tools') {  devops.notificationSuccess(\"dingTalk\")  }  }  }  } ... 开发环境搭建 补录章节：Groovy及SpringBoot、SpringCloud都会使用\n java groovy intelliJ idea  下载安装包 链接：https://pan.baidu.com/s/1B-bg2_IsB8dU7_62IEtnTg 提取码：wx6j\n安装java 安装路径：D:\\software\\jdk\n环境变量：\n JAVA_HOME D:\\software\\jdk CLASSPATH .;%JAVA_HOME%\\lib\\dt.jar;%JAVA_HOME%\\lib\\tools.jar; PATH %JAVA_HOME%\\bin  安装groovy 解压路径：D:\\software\\groovy-3.0.2\n环境变量：\n GROOVY_PATH D:\\software\\groovy-3.0.2 PATH D:\\software\\groovy-3.0.2\\bin  安装idea 安装路径：D:\\software\\IntelliJ IDEA 2019.2.3\n新建项目测试\nLibrary代码结构介绍 共享库的目录结构如下:\n(root) +- src # Groovy source files | +- org | +- foo | +- Bar.groovy # for org.foo.Bar class +- vars | +- foo.groovy # for global 'foo' variable | +- foo.txt # help for 'foo' variable src 目录应该看起来像标准的 Java 源目录结构。当执行流水线时，该目录被添加到类路径下。\nvars 目录定义可从流水线访问的全局变量的脚本。 每个 *.groovy 文件的基名应该是一个 Groovy (~ Java) 标识符, 通常是 camelCased。\nGroovy基本语法介绍 新建Groovy项目\n  变量\n使用数据类型的本地语法，或者使用def关键字\n// Defining a variable in lowercase int x = 5;  // Defining a variable in uppercase int X = 6;  // Defining a variable with the underscore in it's name def _Name = \"Joe\";  println(x); println(X); println(_Name);   方法\n  调用本地方法\ndef sum(int a, int b){  return a + b }  println(sum(1,2))   调用类中的方法\n# Hello.groovy package demo  def sayHi(String content) {  return (\"hi, \" + content) }    # Demo.groovy import demo.Hello  def demo() {  return new Hello().sayHi(\"devops\") } println(demo())    # 级联调用 # Hello.groovy package demo  def init(String content) {  this.content = content  return this }  def sayHi() {  println(\"hi, \" + this.content)  return this }  def sayBye() {  println(\"bye \" + this.content) }   # Demo.groovy import demo.Hello  def demo() {  new Hello().init(\"devops\").sayHi().sayBye() }  demo()     异常捕获\ndef exceptionDemo(){  try {  def val = 10 / 0  println(val)  }catch(Exception e) {  println(e.toString())  throw e  } } exceptionDemo()   计时器与循环\nimport groovy.time.TimeCategory   use( TimeCategory ) {  def endTime = TimeCategory.plus(new Date(), TimeCategory.getSeconds(15))  def counter = 0  while(true) {  println(counter++)  sleep(1000)  if (new Date() = endTime) {  println(\"done\")  break  }  } }   解析yaml文件\nimport org.yaml.snakeyaml.Yaml  def readYaml(){  def content = new File('myblog.yaml').text  Yaml parser = new Yaml()  def data = parser.load(content)  def kind = data[\"kind\"]  def name = data[\"metadata\"][\"name\"]  println(kind)  println(name) } readYaml()   library与Jenkins集成 先来看一下如何使用shared library实现最简单的helloworld输出功能，来理清楚使用shared library的流程。\nHello.groovy package com.luffy.devops  /** * @author Yongxin * @version v0.1 */  /** * say hello * @param content */ def hello(String content) {  this.content = content  return this }   def sayHi() {  echo \"Hi, ${this.content},how are you?\"  return this }  def answer() {  echo \"${this.content}: fine, thank you, and you?\"  return this }  def sayBye() {  echo \"i am fine too , ${this.content}, Bye!\"  return this } 在gitlab创建项目，把library代码推送到镜像仓库。\n配置Jenkins [系统管理] - [系统设置] - [ Global Pipeline Libraries ]\n Library Name：luffy-devops Default Version：master Source Code Management：Git  Jenkinsfile中引用 jenkins/pipelines/p11.yaml\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}   stages {  stage('hello-devops') {  steps {  script {  devops.hello(\"树哥\").sayHi().answer().sayBye()  }  }  }  }  post {  success {  echo 'Congratulations!'  }  failure {  echo 'Oh no!'  }  always {  echo 'I will always say Hello again!'  }  } } 创建vars/devops.groovy\nimport com.luffy.devops.Hello  def hello(String content) {  return new Hello().hello(content) } library集成镜像构建及推送 需要实现的逻辑点：\n docker build，docker push，docker login 账户密码，jenkins凭据，（library中获取凭据内容）， docker login 172.21.51.67:5000 try catch  镜像构建逻辑实现 devops.groovy\n/** * * @param repo, 172.21.51.67:5000/demo/myblog/xxx/ * @param tag, v1.0 * @param dockerfile * @param credentialsId * @param context */ def docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\") {  return new Docker().docker(repo, tag, credentialsId, dockerfile, context) } Docker.groovy\n逻辑中需要注意的点：\n 构建和推送镜像，需要登录仓库（需要认证） 构建成功或者失败，需要将结果推给gitlab端 为了将构建过程推送到钉钉消息中，需要将构建信息统一收集  package com.luffy.devops  /**  *  * @param repo  * @param tag  * @param credentialsId  * @param dockerfile  * @param context  * @return  */ def docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){  this.repo = repo  this.tag = tag  this.dockerfile = dockerfile  this.credentialsId = credentialsId  this.context = context  this.fullAddress = \"${this.repo}:${this.tag}\"  this.isLoggedIn = false  return this }   /**  * build image  * @return  */ def build() {  this.login()  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} \"  }catch (Exception exc) {  throw exc  }  return this  } }   /**  * push image  * @return  */ def push() {  this.login()  retry(3) {  try {  sh \"docker push ${this.fullAddress}\"  }catch (Exception exc) {  throw exc  }  }  return this }  /**  * docker registry login  * @return  */ def login() {  if(this.isLoggedIn || credentialsId == \"\"){  return this  }  // docker login  withCredentials([usernamePassword(credentialsId: this.credentialsId, usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {  def regs = this.getRegistry()  retry(3) {  try {  sh \"docker login ${regs} -u $USERNAME -p $PASSWORD\"  } catch (Exception exc) {  echo \"docker login err, \" + exc.toString()  }  }  }  this.isLoggedIn = true;  return this; }  /**  * get registry server  * @return  */ def getRegistry(){  def sp = this.repo.split(\"/\")  if (sp.size()  1) {  return sp[0]  }  return this.repo } Jenkinsfile\n需要先在Jenkins端创建仓库登录凭据credential-registry\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  }  post {  success {  echo 'Congratulations!'  }  failure {  echo 'Oh no!'  }  } } 丰富构建通知逻辑 目前的构建镜像逻辑中缺少如下内容：\n try逻辑中，若发生异常，是否该把异常抛出  若直接抛出异常可能会导致多次重复的异常信息 若不抛出，则如果未构建成功镜像，流水线感知不到错误   通知gitlab端构建任务及状态 构建通知格式  需要针对上述问题，做出优化\n  优化try逻辑\ndef build() {  this.login()  def isSuccess = false  def errMsg  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile}\"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  // check if build success  if(isSuccess){  //todo  }else {  // throw exception，aborted pipeline  error errMsg  }  return this  } }   通知gitlab端构建任务及状态\ndef build() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} \"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  // check if build success  def stage = env.STAGE_NAME + '-build'  if(isSuccess){  updateGitlabCommitStatus(name: '${stage}', state: 'success')  }else {  updateGitlabCommitStatus(name: '${stage}', state: 'failed')  // throw exception，aborted pipeline  error errMsg  }   return this  } }   钉钉消息通知格式\n由于每个stage都需要构建通知任务，因此抽成公共的逻辑，为各stage调用\nBuildMessage.groovy\npackage com.luffy.devops  def updateBuildMessage(String source, String add) {  if(!source){  source = \"\"  }  env.BUILD_TASKS = source + add + \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  return env.BUILD_TASKS } Docker.groovy 中调用\ndef getObject(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){ \t...  this.msg = new BuildMessage()  return this }   ...  def build() { ...  // check if build success  def stage = env.STAGE_NAME + '-build'  if(isSuccess){  updateGitlabCommitStatus(name: '${stage}', state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} OK... √\")  }else {  updateGitlabCommitStatus(name: '${stage}', state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... x\")  // throw exception，aborted pipeline  error errMsg  }   return this  } }   使用Jenkinsfile来验证上述修改是否正确：\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('git-log') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('build-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  }  post {  success {  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😄👍 构建成功 👍😄 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${env.BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  }  } } 接下来需要将push和login方法做同样的改造\n最终的Docker.groovy文件为：\npackage com.luffy.devops  /**  *  * @param repo  * @param tag  * @param credentialsId  * @param dockerfile  * @param context  * @return  */ def docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){  this.repo = repo  this.tag = tag  this.dockerfile = dockerfile  this.credentialsId = credentialsId  this.context = context  this.fullAddress = \"${this.repo}:${this.tag}\"  this.isLoggedIn = false  this.msg = new BuildMessage()  return this }   /**  * build image  * @return  */ def build() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} \"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  // check if build success  def stage = env.STAGE_NAME + '-build'  if(isSuccess){  updateGitlabCommitStatus(name: \"${stage}\", state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} OK... √\")  }else {  updateGitlabCommitStatus(name: \"${stage}\", state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... x\")  // throw exception，aborted pipeline  error errMsg  }   return this  } }   /**  * push image  * @return  */ def push() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker push ${this.fullAddress}\"  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  }  }  // check if build success  def stage = env.STAGE_NAME + '-push'  if(isSuccess){  updateGitlabCommitStatus(name: \"${stage}\", state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} OK... √\")  }else {  updateGitlabCommitStatus(name: \"${stage}\", state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... x\")  // throw exception，aborted pipeline  error errMsg  }  return this }  /**  * docker registry login  * @return  */ def login() {  if(this.isLoggedIn || credentialsId == \"\"){  return this  }  // docker login  withCredentials([usernamePassword(credentialsId: this.credentialsId, usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {  def regs = this.getRegistry()  retry(3) {  try {  sh \"docker login ${regs} -u $USERNAME -p $PASSWORD\"  } catch (Exception ignored) {  echo \"docker login err, ${ignored.toString()}\"  }  }  }  this.isLoggedIn = true;  return this; }  /**  * get registry server  * @return  */ def getRegistry(){  def sp = this.repo.split(\"/\")  if (sp.size()  1) {  return sp[0]  }  return this.repo } 再次测试构建\nlibrary集成k8s服务部署 library实现部署简单版 devops.groovy\n/**  * kubernetes deployer  * @param resourcePath  */ def deploy(String resourcePath){  return new Deploy().init(resourcePath) } 新增Deploy.groovy\npackage com.luffy.devops  def init(String resourcePath){  this.resourcePath = resourcePath  this.msg = new BuildMessage()  return this }   def start(){  try{  //env.CURRENT_IMAGE用来存储当前构建的镜像地址，需要在Docker.groovy中设置值  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  sh \"kubectl apply -f ${this.resourcePath}\"  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.stage_name} OK... √\")  } catch (Exception exc){  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.stage_name} fail... √\")  throw exc  } } 修改Docker.groovy\ndef push() {  this.login()  def isSuccess = false  def errMsg = \"\"  retry(3) {  try {  sh \"docker push ${this.fullAddress}\"  //把当前推送的镜像地址记录在环境变量中  env.CURRENT_IMAGE = this.fullAddress  isSuccess = true  }catch (Exception err) {  //ignore  errMsg = err.toString()  } Jenkinsfile 中添加如下部分：\n stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\").start()  }  }  }  } library实现自动部署优化版 简单版本最明显的问题就是无法检测部署后的Pod状态，如果想做集成测试，通常要等到最新版本的Pod启动后再开始。因此有必要在部署的时候检测Pod是否正常运行。\n比如要去检查myblog应用的pod是否部署正常，人工检查的大致步骤：\n  kubectl -n luffy get pod，查看pod列表\n  找到列表中带有myblog关键字的running的pod\n  查看上述running pod数，是否和myblog的deployment中定义的replicas副本数一致\n  若一致，则检查结束，若不一致，可能稍等几秒钟，再次执行相同的检查操作\n  如果5分钟了还没有检查通过，则大概率是pod有问题，通过查看日志进一步排查\n  如何通过library代码实现上述过程：\n  library如何获取myblog的pod列表？\n  首先要知道本次部署的是哪个workload，因此需要调用者传递workload的yaml文件路径\n  library解析workload.yaml文件，找到如下值：\n pod所在的namespace pod中使用的labels标签    使用如下命令查找该workload关联的pod\n$ kubectl -n  get po -l  -l   # 如查找myblog的pod $ kubectl -n luffy get po -l app=myblog     如何确定步骤1中的pod的状态？\n# 或者可以直接进行提取状态 $ kubectl -n luffy get po -l app=myblog -ojsonpath='{.items[0].status.phase}'  # 以json数组的形式存储 $ kubectl -n luffy get po -l app=myblog -o json   如何检测所有的副本数都是正常的？\n# 以json数组的形式存储 $ kubectl -n luffy get po -l app=myblog -o json  # 遍历数组，检测每一个pod查看是否均正常（terminating和evicted除外）   如何实现在5分钟的时间内，若pod状态符合预期，则退出检测循环，若不符合预期则继续检测\nuse( TimeCategory ) {  def endTime = TimeCategory.plus(new Date(), TimeCategory.getMinutes(timeoutMinutes,5))  while (true) {  if (new Date() = endTime) {  //超时了，则宣告pod状态不对  updateGitlabCommitStatus(name: 'deploy', state: 'failed')  throw new Exception(\"deployment timed out...\")  }  //循环检测当前deployment下的pod的状态  try {  if (this.isDeploymentReady()) {  readyCount++  if(readyCount  5){  updateGitlabCommitStatus(name: 'deploy', state: 'success')  break;  }  }else {  readyCount = 0  }catch (Exception exc){  echo exc.toString()  }  //每次检测若不满足所有pod均正常，则sleep 5秒钟后继续检测  sleep(5)  }  }   devops.groovy\n通过添加参数 watch来控制是否在pipeline中观察pod的运行状态\n/** * * @param resourcePath * @param watch * @param workloadFilePath * @return */ def deploy(String resourcePath, Boolean watch = true, String workloadFilePath){  return new Deploy().init(resourcePath, watch, workloadFilePath) } 完整版的Deploy.groovy\npackage com.luffy.devops  import org.yaml.snakeyaml.Yaml import groovy.json.JsonSlurperClassic import groovy.time.TimeCategory     def init(String resourcePath, Boolean watch, String workloadFilePath) {  this.resourcePath = resourcePath  this.msg = new BuildMessage()  this.watch = watch  this.workloadFilePath = workloadFilePath  if(!resourcePath \u0026\u0026 !workloadFilePath){  throw Exception(\"illegal resource path\")  }  return this }   def start(){  try{  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  sh \"kubectl apply -f ${this.resourcePath}\"  } catch (Exception exc){  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.stage_name} fail... √\")  throw exc  }   if (this.watch) {   // 初始化workload文件  initWorkload()  String namespace = this.workloadNamespace  String name = env.workloadName  if(env.workloadType.toLowerCase() == \"deployment\"){  echo \"begin watch pod status from deployment ${env.workloadName}...\"  monitorDeployment(namespace, name)  }else {  //todo  echo \"workload type ${env.workloadType} does not support for now...\"  }   }else {  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.STAGE_NAME} OK... √\")  }  }  def initWorkload() {  try {  def content = readFile this.workloadFilePath  Yaml parser = new Yaml()  def data = parser.load(content)  def kind = data[\"kind\"]  if (!kind) {  throw Exception(\"workload file ${kind} illegal, will exit pipeline!\")  }  env.workloadType = kind  echo \"${data}\"  this.workloadNamespace = data[\"metadata\"][\"namespace\"]  if (!this.workloadNamespace){  this.workloadNamespace = \"default\"  }  env.workloadName = data[\"metadata\"][\"name\"]   } catch (Exception exc) {  echo \"failed to readFile ${this.workloadFilePath},exception: ${exc}.\"  throw exc  } }  /** * * @param namespace * @param name * @param timeoutMinutes * @param sleepTime * @return */ def monitorDeployment(String namespace, String name, int timeoutMinutes = 5, sleepTime = 3) {  def readyCount = 0  def readyTarget = 3  use( TimeCategory ) {  def endTime = TimeCategory.plus(new Date(), TimeCategory.getMinutes(timeoutMinutes))  def lastRolling  while (true) {  // checking timeout  if (new Date() = endTime) {  echo \"timeout, printing logs...\"  this.printContainerLogs(lastRolling)  updateGitlabCommitStatus(name: 'deploy', state: 'failed')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.STAGE_NAME} Failed... x\")  throw new Exception(\"deployment timed out...\")  }  // checking deployment status  try {  def rolling = this.getResource(namespace, name, \"deployment\")  lastRolling = rolling  if (this.isDeploymentReady(rolling)) {  readyCount++  echo \"ready total count: ${readyCount}\"  if (readyCount = readyTarget) {  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${env.STAGE_NAME} OK... √\")  break  }   } else {  readyCount = 0  echo \"reseting ready total count: ${readyCount}，print pods event logs\"  this.printContainerLogs(lastRolling)  sh \"kubectl get pod -n ${namespace} -o wide\"  }  } catch (Exception exc) {  updateGitlabCommitStatus(name: 'deploy', state: 'failed')  this.msg.updateBuildMessage(env.BUILD_RESULT, \"${env.STAGE_NAME} Failed... ×\")  echo \"error: ${exc}\"  }  sleep(sleepTime)  }  }  return this }  def getResource(String namespace = \"default\", String name, String kind=\"deployment\") {  sh \"kubectl get ${kind} -n ${namespace} ${name} -o json  ${namespace}-${name}-yaml.yml\"  def jsonStr = readFile \"${namespace}-${name}-yaml.yml\"  def jsonSlurper = new JsonSlurperClassic()  def jsonObj = jsonSlurper.parseText(jsonStr)  return jsonObj }   def printContainerLogs(deployJson) {  if (deployJson == null) {  return;  }  def namespace = deployJson.metadata.namespace  def name = deployJson.metadata.name  def labels=\"\"  deployJson.spec.template.metadata.labels.each { k, v -  labels = \"${labels} -l=${k}=${v}\"  }  sh \"kubectl describe pods -n ${namespace} ${labels}\" }  def isDeploymentReady(deployJson) {  def status = deployJson.status  def replicas = status.replicas  def unavailable = status['unavailableReplicas']  def ready = status['readyReplicas']  if (unavailable != null) {  return false  }  def deployReady = (ready != null \u0026\u0026 ready == replicas)  // get pod information  if (deployJson.spec.template.metadata != null \u0026\u0026 deployReady) {  if (deployJson.spec.template.metadata.labels != null) {  def labels=\"\"  def namespace = deployJson.metadata.namespace  def name = deployJson.metadata.name  deployJson.spec.template.metadata.labels.each { k, v -  labels = \"${labels} -l=${k}=${v}\"  }  if (labels != \"\") {  sh \"kubectl get pods -n ${namespace} ${labels} -o json  ${namespace}-${name}-json.json\"  def jsonStr = readFile \"${namespace}-${name}-json.json\"  def jsonSlurper = new JsonSlurperClassic()  def jsonObj = jsonSlurper.parseText(jsonStr)  def totalCount = 0  def readyCount = 0  jsonObj.items.each { k, v -  echo \"pod phase ${k.status.phase}\"  if (k.status.phase != \"Terminating\" \u0026\u0026 k.status.phase != \"Evicted\") {  totalCount++;  if (k.status.phase == \"Running\") {  readyCount++;  }  }  }  echo \"Pod running count ${totalCount} == ${readyCount}\"  return totalCount  0 \u0026\u0026 totalCount == readyCount  }  }  }  return deployReady } 修改Jenkinsfile 调用部分：\n stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\", true, \"deploy/deployment.yaml\").start()  }  }  }  } library实现即时消息推送 实现消息通知 由于发送消息通知属于通用的功能，因此有必要把消息通知抽象成为通用的功能。\ndevops.groovy\n/**  * notificationSuccess  * @param project  * @param receiver  * @param credentialsId  * @param title  * @return  */ def notificationSuccess(String project, String receiver=\"dingTalk\", String credentialsId=\"dingTalk\", String title=\"\"){  new Notification().getObject(project, receiver, credentialsId, title).notification(\"success\") }  /**  * notificationFailed  * @param project  * @param receiver  * @param credentialsId  * @param title  * @return  */ def notificationFailed(String project, String receiver=\"dingTalk\", String credentialsId=\"dingTalk\", String title=\"\"){  new Notification().getObject(project, receiver, credentialsId, title).notification(\"failure\") } 新建Notification.groovy文件：\npackage com.luffy.devops  /** * * @param type * @param credentialsId * @param title * @return */ def getObject(String project, String receiver, String credentialsId, String title) {  this.project = project  this.receiver = receiver  this.credentialsId = credentialsId  this.title = title  return this }   def notification(String type){  String msg =\"😄👍 ${this.title} 👍😄\"   if (this.title == \"\") {  msg = \"😄👍 流水线成功啦 👍😄\"  }  // failed  if (type == \"failure\") {  msg =\"😖❌ ${this.title} ❌😖\"  if (this.title == \"\") {  msg = \"😖❌ 流水线失败了 ❌😖\"  }  } \tString title = msg  // rich notify msg  msg = genNotificationMessage(msg)  if( this.receiver == \"dingTalk\") {  try {  //new DingTalk().markDown(title, msg, this.credentialsId)  } catch (Exception ignored) {}  }else if(this.receiver == \"wechat\") {  //todo  }else if (this.receiver == \"email\"){  //todo  }else{  error \"no support notify type!\"  } }   /** * get notification msg * @param msg * @return */ def genNotificationMessage(msg) {  // project  msg = \"${msg} \\n **项目名称**: ${this.project}\"  // get git log  def gitlog = \"\"  try {  sh \"git log --oneline -n 1  gitlog.file\"  gitlog = readFile \"gitlog.file\"  } catch (Exception ignored) {}   if (gitlog != null \u0026\u0026 gitlog != \"\") {  msg = \"${msg} \\n **Git log**: ${gitlog}\"  }  // get git branch  def gitbranch = env.BRANCH_NAME  if (gitbranch != null \u0026\u0026 gitbranch != \"\") {  msg = \"${msg} \\n **Git branch**: ${gitbranch}\"  }  // build tasks  msg = \"${msg} \\n **Build Tasks**: ${env.BUILD_TASKS}\"   // get buttons  msg = msg + getButtonMsg()  return msg } def getButtonMsg(){  String res = \"\"  def buttons = [  [  \"title\": \"查看流水线\",  \"actionURL\": \"${env.RUN_DISPLAY_URL}\"  ],  [  \"title\": \"代码扫描结果\",  \"actionURL\": \"http://sonar.luffy.com/dashboard?id=${this.project}\"  ]  ]  buttons.each() {  if(res == \"\"){  res = \" \\n \"  }  res = \"${res} --- [\"+it[\"title\"]+\"](\"+it[\"actionURL\"]+\") \"  }  return res } 新建DingTalk.groovy文件：\npackage com.luffy.devops  import groovy.json.JsonOutput   def sendRequest(method, data, credentialsId, Boolean verbose=false, codes=\"100:399\") {  def reqBody = new JsonOutput().toJson(data)  withCredentials([usernamePassword(credentialsId: credentialsId, usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {  def response = httpRequest(  httpMode:method,  url: \"https://oapi.dingtalk.com/robot/send?access_token=${PASSWORD}\",  requestBody:reqBody,  validResponseCodes: codes,  contentType: \"APPLICATION_JSON\",  quiet: !verbose  )  } }  def markDown(String title, String text, String credentialsId, Boolean verbose=false) {  def data = [  \"msgtype\": \"markdown\",  \"markdown\": [  \"title\": title,  \"text\": text  ]  ]  this.sendRequest(\"POST\", data, credentialsId, verbose) } 需要用到Http Request来发送消息，安装一下插件：http_request\njenkinsfile调用 @Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",true,\"deploy/deployment.yaml\").start()  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(\"myblog\",\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(\"myblog\",\"dingTalk\")  }  }  } } library集成代码扫描 sonarqube代码扫描作为通用功能，同样可以使用library实现。\ndevops.groovy\n/** * sonarqube scanner * @param projectVersion * @param waitScan * @return */ def scan(String projectVersion=\"\", Boolean waitScan = true) {  return new Sonar().init(projectVersion, waitScan) } 新建Sonar.groovy\n 可以传递projectVersion作为sonarqube的扫描版本 参数waitScan来设置是否等待本次扫描是否通过  package com.luffy.devops   def init(String projectVersion=\"\", Boolean waitScan = true) {  this.waitScan = waitScan  this.msg = new BuildMessage()  if (projectVersion == \"\"){  projectVersion = sh(returnStdout: true, script: 'git log --oneline -n 1|cut -d \" \" -f 1')  }  sh \"echo '\\nsonar.projectVersion=${projectVersion}'  sonar-project.properties\"  sh \"cat sonar-project.properties\"  return this }  def start() {  try {  this.startToSonar()  }  catch (Exception exc) {  throw exc  }  return this }  def startToSonar() {  withSonarQubeEnv('sonarqube') {  sh \"sonar-scanner -X;\"  sleep 5  }  if(this.waitScan){  //wait 3min  timeout(time: 3, unit: 'MINUTES') {  def qg = waitForQualityGate()  String stage = \"${env.stage_name}\"  if (qg.status != 'OK') {  this.msg.updateBuildMessage(env.BUILD_TASKS, \"${stage} Failed... ×\")  updateGitlabCommitStatus(name: \"${stage}\", state: 'failed')  error \"Pipeline aborted due to quality gate failure: ${qg.status}\"  }else{  this.msg.updateBuildMessage(env.BUILD_RESULT, \"${stage} OK... √\")  updateGitlabCommitStatus(name: \"${stage}\", state: 'success')  }  }  }else{  echo \"skip waitScan\"  }  return this } Jenkinsfile新增如下部分：\n stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  } 集成robot自动化测试 关于集成测试，我们需要知道的几点:\n 测试人员进行编写 侧重于不同模块的接口调用，对新加的功能进行验证 注重新版本对以前的集成用例进行回归  因此，更多的应该是跨模块去测试，而且测试用例是测试人员去维护，因此不适合把代码放在开发的git仓库中。\n本节要实现的工作：\n 创建新的git仓库robot-cases，用于存放robot测试用例 为robot-cases项目创建Jenkinsfile 配置Jenkins任务，实现该项目的自动化执行 在myblog模块的流水线中，对该流水线项目进行调用  初始化robot-cases项目   新建gitlab项目，名称为robot-cases\n  clone到本地\n  本地拷贝myblog项目的robot.txt\nrobot-cases/ └── myblog  └── robot.txt   配置Jenkinsfile及自动化任务 robot-cases/ ├── Jenkinsfile └── myblog  └── robot.txt Jenkinsfile\n多个业务项目的测试用例都在一个仓库中，因此需要根据参数设置来决定执行哪个项目的用例\npipeline {  agent {  label 'jnlp-slave'  }  \toptions {  timeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('Test') {  steps {  script {  container('tools'){  switch(env.comp){  case \"myblog\":  env.testDir = \"myblog\"  break  case \"business1\":  env.testDir = \"business1\"  break  default:  env.testDir = \"all\"  break  }  sh 'robot -d artifacts/ ${testDir}/*'  step([  $class : 'RobotPublisher',  outputPath: 'artifacts/',  outputFileName : \"output.xml\",  disableArchiveOutput : false,  passThreshold : 100,  unstableThreshold: 80.0,  onlyCritical : true,  otherFiles : \"*.png\"  ])  archiveArtifacts artifacts: 'artifacts/*', fingerprint: true  }  }  }  }  } } 如何实现将env.comp 传递进去？\n配置流水线的参数化构建任务并验证参数化构建\nlibrary集成触发任务 由于多个项目均需要触发自动构建，因此可以在library中抽象方法，实现接收comp参数，并在library中实现对robot-cases项目的触发。\ndevops.groovy\n/** * * @param comp * @return */ def robotTest(String comp=\"\"){  new Robot().acceptanceTest(comp) } 新建Robot.groovy文件\npackage com.luffy.devops  def acceptanceTest(comp) {  try{  echo \"Trigger to execute Acceptance Testing\"  def rf = build job: 'robot-cases',  parameters: [  string(name: 'comp', value: comp)  ],  wait: true,  propagate: false  def result = rf.getResult()  def msg = \"${env.STAGE_NAME}... \"  if (result == \"SUCCESS\"){  msg += \"√ success\"  }else if(result == \"UNSTABLE\"){  msg += \"⚠ unstable\"  }else{  msg += \"× failure\"  }  echo rf.getAbsoluteUrl()  env.ROBOT_TEST_URL = rf.getAbsoluteUrl()  new BuildMessage().updateBuildMessage(env.BUILD_TASKS, msg)  } catch (Exception exc) {  echo \"trigger execute Acceptance Testing exception: ${exc}\"  new BuildMessage().updateBuildMessage(env.BUILD_RESULT, msg)  } } 修改Jenkinsfile测试调用\n stage('integration test') {  steps {  container('tools') {  script{  devops.robotTest(\"myblog\")  }  }  }  } 多环境的CICD自动化实现 实现目标及效果 目前项目存在develop和master两个分支，Jenkinsfile中配置的都是构建部署到相同的环境，实际的场景中，代码仓库的项目往往不同的分支有不同的作用，我们可以抽象出一个工作流程：\n  开发人员提交代码到develop分支\n  Jenkins自动使用develop分支做单测、代码扫描、镜像构建（以commit id为镜像tag）、服务部署到开发环境\n  开发人员使用开发环境自测\n  测试完成后，在gitlab提交merge request请求，将代码合并至master分支\n  需要发版时，在gitlab端基于master分支创建tag（v2.3.0）\n  Jenkins自动检测到tag，拉取tag关联的代码做单测、代码扫描、镜像构建（以代码的tag为镜像的tag）、服务部署到测试环境、执行集成测试用例，输出测试报告\n  测试人员进行手动测试\n  上线\n  实现思路 以myblog项目为例，目前已经具备的是develop分支代码提交后，可以自动实现：\n 单元测试、代码扫描 镜像构建 k8s服务部署 robot集成用例测试  和上述目标相比，差异点：\n myblog应用目前只有一套环境，在luffy命名空间中。我们新建两个命名空间：  dev，用作部署开发环境 test，用作部署集成测试环境   需要根据不同的分支来执行不同的任务，有两种方案实现：  develop和master分支使用不同的Jenkinsfile  可行性很差，因为代码合并工作很繁琐 维护成本高，多个分支需要维护多个Jenkinsfile   使用同一套Jenkinsfile，配合library和模板来实现一套Jenkinsfile适配多套环境  改造Jenkinsfile，实现根据分支来选择任务 需要将deploy目录中所有和特定环境绑定的内容模板化 在library中实现根据不同的分支，来替换模板中的内容      Jenkinsfile根据分支选择任务 使用when关键字，配合正则表达式，实现分支的过滤选择：\npipeline {  agent any  stages {  stage('Example Build') {  steps {  echo 'Hello World'  }  }  stage('Example Deploy') {  when {  expression { BRANCH_NAME ==~ \"develop\" }  }  steps {  echo 'Deploying to develop env'  }  }  } } 分别在develop和master分支进行验证。\n针对本例，可以对Jenkinsfile做如下调整：\n...  stage('integration test') {  when {  expression { BRANCH_NAME ==~ /v.*/ }  }  steps {  container('tools') {  script{  devops.robotTest(PROJECT)  }  }  }  } ... 模板化k8s的资源清单 因为需要使用同一套模板和Jenkinsfile来部署到不同的环境，因此势必要对资源清单进行模板化，前面的内容中只将deployment.yaml放到了项目的deploy清单目录，此处将部署myblog用到的资源清单均补充进去，包含：\n deployment.yaml service.yaml ingress.yaml configmap.yaml secret.yaml  涉及到需要进行模板化的内容包括：\n  镜像地址\n  命名空间\n  ingress的域名信息\n  模板化后的文件：\n$ cat deployment.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: myblog  namespace: {{NAMESPACE}} spec:  replicas: 1 #指定Pod副本数  selector: #指定Pod的选择器  matchLabels:  app: myblog  template:  metadata:  labels: #给Pod打label  app: myblog  spec:  containers:  - name: myblog  image: {{IMAGE_URL}}  imagePullPolicy: IfNotPresent  env:  - name: MYSQL_HOST  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_HOST  - name: MYSQL_PORT  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_PORT  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_PASSWD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 15 # 执行探测的频率  timeoutSeconds: 2 # 探测超时时间  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 15  $ cat configmap.yaml apiVersion: v1 data:  MYSQL_HOST: mysql  MYSQL_PORT: \"3306\" kind: ConfigMap metadata:  name: myblog  namespace: {{NAMESPACE}}  $ cat secret.yaml apiVersion: v1 data:  MYSQL_PASSWD: MTIzNDU2  MYSQL_USER: cm9vdA== kind: Secret metadata:  name: myblog  namespace: {{NAMESPACE}} type: Opaque  $ cat service.yaml apiVersion: v1 kind: Service metadata:  name: myblog  namespace: {{NAMESPACE}} spec:  ports:  - port: 80  protocol: TCP  targetPort: 8002  selector:  app: myblog  sessionAffinity: None  type: ClusterIP status:  loadBalancer: {}  $ cat ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: myblog  namespace: {{NAMESPACE}} spec:  rules:  - host: {{INGRESS_MYBLOG}}  http:  paths:  - backend:  serviceName: myblog  servicePort: 80  path: / status:  loadBalancer: {} 实现library配置替换逻辑 我们需要实现使用相同的模板，做到如下事情：\n 根据代码分支来部署到不同的命名空间  develop分支部署到开发环境，使用命名空间 dev v.*部署到测试环境，使用命名空间 test   不同环境使用不同的ingress地址来访问  开发环境，blog-dev.luffy.com 测试环境，blog-test.luffy.com    如何实现？sharedlibrary\n所有的逻辑都会经过library这一层，我们具有完全可控权。\n前面已经替换过镜像地址了，我们只需要实现如下逻辑：\n 检测当前代码分支，替换命名空间 检测当前代码分支，替换Ingress地址  问题来了，如何检测构建的触发是develop分支还是tag分支？\n答案是：env.TAG_NAME，由tag分支触发的构建，环境变量中会带有TAG_NAME，且值为gitlab中的tag名称。\n做个演示：\n使用如下的Jenkinsfile，查看由master分支触发和由tag分支触发，printenv的值有什么不同\npipeline {  agent any  stages {  stage('Example Build') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('Example Deploy') {  when {  expression { BRANCH_NAME ==~ \"develop\" }  }  steps {  echo 'Deploying to develop env'  }  }  } } 我们可以选择和替换image镜像地址一样，来执行替换：\ndef tplHandler(){  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  String namespace = \"dev\"  String ingress = \"blog-dev.luffy.com\"  if(env.TAG_NAME){  namespace = \"test\"  ingress = \"blog-test.luffy.com\"  }  sh \"sed -i 's#{{NAMESPACE}}#${namespace}#g' ${this.resourcePath}/*\"  sh \"sed -i 's#{{INGRESS_MYBLOG}}#${ingress}#g' ${this.resourcePath}/*\" } 但是我们的library是要为多个项目提供服务的，如果采用上述方式，则每加入一个项目，都需要对library做改动，形成了强依赖。因此需要想一种更优雅的方式来进行替换。\n思路：\n  开发环境和集成测试环境里准备一个configmap，取名为 devops-config\n  configmap的内容大致如下：\n  开发环境\nNAMESPACE=dev INGRESS_MYBLOG=blog-dev.luffy.com   测试环境\nNAMESPACE=test INGRESS_MYBLOG=blog-test.luffy.com     约定：configmap的key值，拼接{{KEY}}则为代码中需要替换的模板部分，configmap的该key对应的value，则为该模板要被替换的值的内容。比如：\nNAMESPACE=dev INGRESS_MYBLOG=blog-dev.luffy.com {{NAMESPACE}} = dev {{INGRESS_MYBLOG}} - blog-dev.luffy.com 意思是约定项目的deploy的资源清单中：\n 所有的{{NAMESPACE}}被替换为dev 所有的{{INGRESS_MYBLOG}}被替换为blog-dev.luffy.com    在library的逻辑中，实现读取触发当前构建的代码分支所关联的namespace下的devops-config这个configmap，然后遍历里面的值进行模板替换即可。\n  这样，则以后再有新增的项目，则只需要维护devops-config配置文件即可，shared-library则不需要随着项目的增加而进行修改，通过这种方式实现library和具体的项目解耦。\ndef tplHandler(){  sh \"sed -i 's#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g' ${this.resourcePath}/*\"  String namespace = \"dev\"  if(env.TAG_NAME){  namespace = \"test\"  }  try {  def configMapData = this.getResource(namespace, \"devops-config\", \"configmap\")[\"data\"]  configMapData.each { k, v -  echo \"key is ${k}, val is ${v}\"  sh \"sed -i 's#{{${k}}}#${v}#g' ${this.resourcePath}/*\"  }  }catch (Exception exc) {  echo \"failed to get devops-config data,exception: ${exc}.\"  throw exc  } } 准备多环境   创建开发和测试环境的命名空间\n#  $ kubectl create namespace dev $ kubectl create namespace test   分别在dev和test命名空间准备mysql数据库。演示功能，因此mysql未作持久化\n$ cat mysql-all.yaml apiVersion: v1 kind: Service metadata:  name: mysql  namespace: dev spec:  ports:  - port: 3306  protocol: TCP  targetPort: 3306  selector:  app: mysql  type: ClusterIP --- apiVersion: v1 kind: Secret metadata:  name: myblog  namespace: dev type: Opaque data:  MYSQL_USER: cm9vdA==  MYSQL_PASSWD: MTIzNDU2 --- apiVersion: apps/v1 kind: Deployment metadata:  name: mysql  namespace: dev spec:  replicas: 1 #指定Pod副本数  selector: #指定Pod的选择器  matchLabels:  app: mysql  template:  metadata:  labels: #给Pod打label  app: mysql  spec:  containers:  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_ROOT_PASSWORD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  - name: MYSQL_DATABASE  value: \"myblog\"  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  readinessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 5  periodSeconds: 10  # 创建开发环境的数据库 $ kubectl create -f mysql-all.yaml  # 替换dev命名空间，创建测试环境的数据库 $ sed -i 's/namespace: dev/namespace: test/g' mysql-all.yaml $ kubectl create -f mysql-all.yaml   对myblog项目的k8s资源清单模板化改造\n {{NAMESPACE}} {{INGRESS_MYBLOG}} {{IMAGE_URL}}    初始化开发环境和测试环境的devops-config\n# 开发环境 $ cat devops-config-dev.txt NAMESPACE=dev INGRESS_MYBLOG=blog-dev.luffy.com  $ kubectl -n dev create configmap devops-config --from-env-file=devops-config-dev.txt  # 测试环境 $ cat devops-config-test.txt NAMESPACE=test INGRESS_MYBLOG=blog-test.luffy.com  $ kubectl -n test create configmap devops-config --from-env-file=devops-config-test.txt   提交最新的library代码\n  提交最新的python-demo项目代码\n@Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  PROJECT = \"myblog\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  }  stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",true,\"deploy/deployment.yaml\").start()  }  }  }  }  stage('integration test') {  when {  expression { BRANCH_NAME ==~ /v.*/ }  }  steps {  container('tools') {  script{  devops.robotTest(PROJECT)  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(PROJECT,\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(PROJECT,\"dingTalk\")  }  }  } }   验证多环境自动部署 模拟如下流程：\n  提交代码到develop分支，观察是否部署到dev的命名空间中，注意，第一次部署，需要执行migrate操作：\n $ kubectl -n dev exec myblog-9f9f7c8cd-k6tbj python3 manage.py migrate   配置hosts解析，测试使用http://blog-dev.luffy.com/blog/index/进行访问到develop分支最新版本\n  合并代码至master分支\n  在gitlab中创建tag，观察是否自动部署至test的命名空间中，且使用myblog-test.luffy.com/blog/index/可以访问到最新版本\n  实现打tag后自动部署 我们发现，打了tag以后，多分支流水线中可以识别到该tag，但是并不会自动部署该tag的代码。因此，我们来使用一个新的插件：Basic Branch Build Strategies Plugin\n安装并配置多分支流水线，注意Build strategies 设置：\n Regular branches Tags  Ignore tags newer than 可以不用设置，不然会默认不自动构建新打的tag Ignore tags older than    优化镜像部署逻辑 针对部署到测试环境的代码，由于已经打了tag了，因此，我们期望构建出来的镜像地址可以直接使用代码的tag作为镜像的tag。\n思路一：直接在Jenkinsfile调用devops.docker时传递tag名称\n思路二：在shared-library中，根据env.TAG_NAME来判断当前是否是tag分支的构建，若TAG_NAME不为空，则可以在构建镜像时使用TAG_NAME作为镜像的tag\n很明显我们更期望使用思路二的方式来实现，因此，需要调整如下逻辑：\ndef docker(String repo, String tag, String credentialsId, String dockerfile=\"Dockerfile\", String context=\".\"){  this.repo = repo  this.tag = tag  if(env.TAG_NAME){  this.tag = env.TAG_NAME  }  this.dockerfile = dockerfile  this.credentialsId = credentialsId  this.context = context  this.fullAddress = \"${this.repo}:${this.tag}\"  this.isLoggedIn = false  this.msg = new BuildMessage()  return this } 提交代码，并进行测试，观察是否使用tag作为镜像标签进行部署。\n小结 Jenkins-shared-library的代码地址： https://gitee.com/agagin/jenkins-shared-library\n目标：让devops流程更好用\n 项目更简便的接入 devops流程更方便维护  思路：把各项目中公用的逻辑，抽象成方法，放到独立的library项目中，在各项目中引入shared-library项目，调用library提供的方法。\n 镜像构建、推送 k8s服务部署、监控 钉钉消息推送 代码扫描 robot集成测试  为了兼容多环境的CICD，因此采用模板与数据分离的方式，项目中的定义模板，shared-library中实现模板替换。为了实现shared-library与各项目解耦，使用configmap来维护模板与真实数据的值，思路是约定大于配置。\n",
  "wordCount" : "4314",
  "inLanguage": "zh",
  "datePublished": "2022-01-10T18:27:44Z",
  "dateModified": "2022-01-10T18:27:44Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      基于sharedLibrary进行CICD流程的优化
    </h1>
    <div class="post-meta"><span title='2022-01-10 18:27:44 +0000 UTC'>2022-01-10</span>&nbsp;·&nbsp;21 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%9f%ba%e4%ba%8esharedlibrary%e8%bf%9b%e8%a1%8ccicd%e6%b5%81%e7%a8%8b%e7%9a%84%e4%bc%98%e5%8c%96" aria-label="基于sharedLibrary进行CI/CD流程的优化">基于sharedLibrary进行CI/CD流程的优化</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#library%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f" aria-label="Library工作模式">Library工作模式</a></li>
                    <li>
                        <a href="#%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="开发环境搭建">开发环境搭建</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85%e5%8c%85" aria-label="下载安装包">下载安装包</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85java" aria-label="安装java">安装java</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85groovy" aria-label="安装groovy">安装groovy</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85idea" aria-label="安装idea">安装idea</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84%e4%bb%8b%e7%bb%8d" aria-label="Library代码结构介绍">Library代码结构介绍</a></li>
                    <li>
                        <a href="#groovy%e5%9f%ba%e6%9c%ac%e8%af%ad%e6%b3%95%e4%bb%8b%e7%bb%8d" aria-label="Groovy基本语法介绍">Groovy基本语法介绍</a></li>
                    <li>
                        <a href="#library%e4%b8%8ejenkins%e9%9b%86%e6%88%90" aria-label="library与Jenkins集成">library与Jenkins集成</a><ul>
                            
                    <li>
                        <a href="#hellogroovy" aria-label="Hello.groovy">Hello.groovy</a></li>
                    <li>
                        <a href="#%e9%85%8d%e7%bd%aejenkins" aria-label="配置Jenkins">配置Jenkins</a></li>
                    <li>
                        <a href="#jenkinsfile%e4%b8%ad%e5%bc%95%e7%94%a8" aria-label="Jenkinsfile中引用">Jenkinsfile中引用</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e5%8f%8a%e6%8e%a8%e9%80%81" aria-label="library集成镜像构建及推送">library集成镜像构建及推送</a><ul>
                            
                    <li>
                        <a href="#%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e9%80%bb%e8%be%91%e5%ae%9e%e7%8e%b0" aria-label="镜像构建逻辑实现">镜像构建逻辑实现</a></li>
                    <li>
                        <a href="#%e4%b8%b0%e5%af%8c%e6%9e%84%e5%bb%ba%e9%80%9a%e7%9f%a5%e9%80%bb%e8%be%91" aria-label="丰富构建通知逻辑">丰富构建通知逻辑</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90k8s%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2" aria-label="library集成k8s服务部署">library集成k8s服务部署</a><ul>
                            
                    <li>
                        <a href="#library%e5%ae%9e%e7%8e%b0%e9%83%a8%e7%bd%b2%e7%ae%80%e5%8d%95%e7%89%88" aria-label="library实现部署简单版">library实现部署简单版</a></li>
                    <li>
                        <a href="#library%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96%e7%89%88" aria-label="library实现自动部署优化版">library实现自动部署优化版</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e5%ae%9e%e7%8e%b0%e5%8d%b3%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81" aria-label="library实现即时消息推送">library实现即时消息推送</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e9%80%9a%e7%9f%a5" aria-label="实现消息通知">实现消息通知</a></li>
                    <li>
                        <a href="#jenkinsfile%e8%b0%83%e7%94%a8" aria-label="jenkinsfile调用">jenkinsfile调用</a></li></ul>
                    </li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90%e4%bb%a3%e7%a0%81%e6%89%ab%e6%8f%8f" aria-label="library集成代码扫描">library集成代码扫描</a></li>
                    <li>
                        <a href="#%e9%9b%86%e6%88%90robot%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95" aria-label="集成robot自动化测试">集成robot自动化测试</a><ul>
                            
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96robot-cases%e9%a1%b9%e7%9b%ae" aria-label="初始化robot-cases项目">初始化robot-cases项目</a></li>
                    <li>
                        <a href="#%e9%85%8d%e7%bd%aejenkinsfile%e5%8f%8a%e8%87%aa%e5%8a%a8%e5%8c%96%e4%bb%bb%e5%8a%a1" aria-label="配置Jenkinsfile及自动化任务">配置Jenkinsfile及自动化任务</a></li>
                    <li>
                        <a href="#library%e9%9b%86%e6%88%90%e8%a7%a6%e5%8f%91%e4%bb%bb%e5%8a%a1" aria-label="library集成触发任务">library集成触发任务</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%a4%9a%e7%8e%af%e5%a2%83%e7%9a%84cicd%e8%87%aa%e5%8a%a8%e5%8c%96%e5%ae%9e%e7%8e%b0" aria-label="多环境的CICD自动化实现">多环境的CICD自动化实现</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e7%9b%ae%e6%a0%87%e5%8f%8a%e6%95%88%e6%9e%9c" aria-label="实现目标及效果">实现目标及效果</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af" aria-label="实现思路">实现思路</a></li>
                    <li>
                        <a href="#jenkinsfile%e6%a0%b9%e6%8d%ae%e5%88%86%e6%94%af%e9%80%89%e6%8b%a9%e4%bb%bb%e5%8a%a1" aria-label="Jenkinsfile根据分支选择任务">Jenkinsfile根据分支选择任务</a></li>
                    <li>
                        <a href="#%e6%a8%a1%e6%9d%bf%e5%8c%96k8s%e7%9a%84%e8%b5%84%e6%ba%90%e6%b8%85%e5%8d%95" aria-label="模板化k8s的资源清单">模板化k8s的资源清单</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0library%e9%85%8d%e7%bd%ae%e6%9b%bf%e6%8d%a2%e9%80%bb%e8%be%91" aria-label="实现library配置替换逻辑">实现library配置替换逻辑</a></li>
                    <li>
                        <a href="#%e5%87%86%e5%a4%87%e5%a4%9a%e7%8e%af%e5%a2%83" aria-label="准备多环境">准备多环境</a></li>
                    <li>
                        <a href="#%e9%aa%8c%e8%af%81%e5%a4%9a%e7%8e%af%e5%a2%83%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2" aria-label="验证多环境自动部署">验证多环境自动部署</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e6%89%93tag%e5%90%8e%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2" aria-label="实现打tag后自动部署">实现打tag后自动部署</a></li>
                    <li>
                        <a href="#%e4%bc%98%e5%8c%96%e9%95%9c%e5%83%8f%e9%83%a8%e7%bd%b2%e9%80%bb%e8%be%91" aria-label="优化镜像部署逻辑">优化镜像部署逻辑</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a>
                    </li>
                </ul>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="基于sharedlibrary进行cicd流程的优化">基于sharedLibrary进行CI/CD流程的优化<a hidden class="anchor" aria-hidden="true" href="#基于sharedlibrary进行cicd流程的优化">#</a></h3>
<p>由于公司内部项目众多，大量的项目使用同一套流程做CICD</p>
<ul>
<li>那么势必会存在大量的重复代码</li>
<li>一旦某个公共的地方需要做调整，每个项目都需要修改</li>
</ul>
<p>因此本章主要通过使用groovy实现Jenkins的sharedLibrary的开发，以提取项目在CICD实践过程中的公共逻辑，提供一系列的流程的接口供公司内各项目调用。</p>
<p>开发完成后，对项目进行Jenkinsfile的改造，最后仅需通过简单的Jenkinsfile的配置，即可优雅的完成CICD流程的整个过程，此方式已在大型企业内部落地应用。</p>
<h5 id="library工作模式">Library工作模式<a hidden class="anchor" aria-hidden="true" href="#library工作模式">#</a></h5>
<p>由于流水线被组织中越来越多的项目所采用，常见的模式很可能会出现。 在多个项目之间共享流水线有助于减少冗余并保持代码 &ldquo;DRY&rdquo;。</p>
<p>流水线支持引用 &ldquo;共享库&rdquo; ，可以在外部源代码控制仓库中定义并加载到现有的流水线中。</p>
<pre tabindex="0"><code>@Library(&#39;my-shared-library&#39;) _
</code></pre><p>在实际运行过程中，会把library中定义的groovy功能添加到构建目录中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>/var/jenkins_home/jobs/test-maven-build/branches/feature-CDN-2904.cm507o/builds/2/libs/my-shared-library/vars/devops.groovy
</span></span></code></pre></div><p>使用library后，Jenkinsfile大致的样子如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>@Library(<span style="color:#e6db74">&#39;my-shared-library&#39;</span>) _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  stages {
</span></span><span style="display:flex;"><span>    stage(<span style="color:#e6db74">&#39;build image&#39;</span>) {
</span></span><span style="display:flex;"><span>      steps {
</span></span><span style="display:flex;"><span>         container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>           devops.buildImage(<span style="color:#e6db74">&#34;Dockerfile&#34;</span>,<span style="color:#e6db74">&#34;172.21.51.67:5000/demo:latest&#34;</span>)
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  post {
</span></span><span style="display:flex;"><span>    success {
</span></span><span style="display:flex;"><span>      script {
</span></span><span style="display:flex;"><span>          container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>              devops.notificationSuccess(<span style="color:#e6db74">&#34;dingTalk&#34;</span>)
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="开发环境搭建">开发环境搭建<a hidden class="anchor" aria-hidden="true" href="#开发环境搭建">#</a></h5>
<p>补录章节：Groovy及SpringBoot、SpringCloud都会使用</p>
<ul>
<li>java</li>
<li>groovy</li>
<li>intelliJ idea</li>
</ul>
<h6 id="下载安装包">下载安装包<a hidden class="anchor" aria-hidden="true" href="#下载安装包">#</a></h6>
<p>链接：https://pan.baidu.com/s/1B-bg2_IsB8dU7_62IEtnTg
提取码：wx6j</p>
<h6 id="安装java">安装java<a hidden class="anchor" aria-hidden="true" href="#安装java">#</a></h6>
<p>安装路径：D:\software\jdk</p>
<p>环境变量：</p>
<ul>
<li>JAVA_HOME     D:\software\jdk</li>
<li>CLASSPATH      .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</li>
<li>PATH                 %JAVA_HOME%\bin</li>
</ul>
<h6 id="安装groovy">安装groovy<a hidden class="anchor" aria-hidden="true" href="#安装groovy">#</a></h6>
<p>解压路径：D:\software\groovy-3.0.2</p>
<p>环境变量：</p>
<ul>
<li>GROOVY_PATH      D:\software\groovy-3.0.2</li>
<li>PATH                       D:\software\groovy-3.0.2\bin</li>
</ul>
<h6 id="安装idea">安装idea<a hidden class="anchor" aria-hidden="true" href="#安装idea">#</a></h6>
<p>安装路径：D:\software\IntelliJ IDEA 2019.2.3</p>
<p>新建项目测试</p>
<h5 id="library代码结构介绍">Library代码结构介绍<a hidden class="anchor" aria-hidden="true" href="#library代码结构介绍">#</a></h5>
<p>共享库的目录结构如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>(root)
</span></span><span style="display:flex;"><span>+- src                     <span style="color:#75715e"># Groovy source files</span>
</span></span><span style="display:flex;"><span>|   +- org
</span></span><span style="display:flex;"><span>|       +- foo
</span></span><span style="display:flex;"><span>|           +- Bar.groovy  <span style="color:#75715e"># for org.foo.Bar class</span>
</span></span><span style="display:flex;"><span>+- vars
</span></span><span style="display:flex;"><span>|   +- foo.groovy          <span style="color:#75715e"># for global &#39;foo&#39; variable</span>
</span></span><span style="display:flex;"><span>|   +- foo.txt             <span style="color:#75715e"># help for &#39;foo&#39; variable</span>
</span></span></code></pre></div><p><code>src</code> 目录应该看起来像标准的 Java 源目录结构。当执行流水线时，该目录被添加到类路径下。</p>
<p><code>vars</code> 目录定义可从流水线访问的全局变量的脚本。 每个 <code>*.groovy</code> 文件的基名应该是一个 Groovy (~ Java) 标识符, 通常是 <code>camelCased</code>。</p>
<h5 id="groovy基本语法介绍">Groovy基本语法介绍<a hidden class="anchor" aria-hidden="true" href="#groovy基本语法介绍">#</a></h5>
<p>新建Groovy项目</p>
<ul>
<li>
<p>变量</p>
<p>使用数据类型的本地语法，或者使用def关键字</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// Defining a variable in lowercase  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Defining a variable in uppercase  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> X <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Defining a variable with the underscore in it&#39;s name 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> _Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Joe&#34;</span><span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println<span style="color:#f92672">(</span>x<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>println<span style="color:#f92672">(</span>X<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>println<span style="color:#f92672">(</span>_Name<span style="color:#f92672">);</span> 
</span></span></code></pre></div></li>
<li>
<p>方法</p>
<ul>
<li>
<p>调用本地方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def sum(int a, int b){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a + b
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>println(sum(1,2))
</span></span></code></pre></div></li>
<li>
<p>调用类中的方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Hello.groovy</span>
</span></span><span style="display:flex;"><span>package demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def sayHi(String content) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#34;hi, &#34;</span> + content)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Demo.groovy</span>
</span></span><span style="display:flex;"><span>import demo.Hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def demo() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new Hello().sayHi(<span style="color:#e6db74">&#34;devops&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>println(demo())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 级联调用</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Hello.groovy</span>
</span></span><span style="display:flex;"><span>package demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def init(String content) {
</span></span><span style="display:flex;"><span>    this.content = content
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def sayHi() {
</span></span><span style="display:flex;"><span>    println(<span style="color:#e6db74">&#34;hi, &#34;</span> + this.content)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def sayBye() {
</span></span><span style="display:flex;"><span>    println(<span style="color:#e6db74">&#34;bye &#34;</span> + this.content)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Demo.groovy</span>
</span></span><span style="display:flex;"><span>import demo.Hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def demo() {
</span></span><span style="display:flex;"><span>    new Hello().init(<span style="color:#e6db74">&#34;devops&#34;</span>).sayHi().sayBye()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>demo()
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>异常捕获</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exceptionDemo</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> val <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>val<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> e
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>exceptionDemo<span style="color:#f92672">()</span>
</span></span></code></pre></div></li>
<li>
<p>计时器与循环</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.time.TimeCategory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">use</span><span style="color:#f92672">(</span> TimeCategory <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> endTime <span style="color:#f92672">=</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">plus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">(),</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">getSeconds</span><span style="color:#f92672">(</span><span style="color:#ae81ff">15</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span>counter<span style="color:#f92672">++)</span>
</span></span><span style="display:flex;"><span>        sleep<span style="color:#f92672">(</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> endTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;done&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>解析yaml文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>import org.yaml.snakeyaml.Yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def readYaml(){
</span></span><span style="display:flex;"><span>    def content = new File(<span style="color:#e6db74">&#39;myblog.yaml&#39;</span>).text
</span></span><span style="display:flex;"><span>    Yaml parser = new Yaml()
</span></span><span style="display:flex;"><span>    def data = parser.load(content)
</span></span><span style="display:flex;"><span>    def kind = data[<span style="color:#e6db74">&#34;kind&#34;</span>]
</span></span><span style="display:flex;"><span>    def name = data[<span style="color:#e6db74">&#34;metadata&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]
</span></span><span style="display:flex;"><span>    println(kind)
</span></span><span style="display:flex;"><span>    println(name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>readYaml()
</span></span></code></pre></div></li>
</ul>
<h5 id="library与jenkins集成">library与Jenkins集成<a hidden class="anchor" aria-hidden="true" href="#library与jenkins集成">#</a></h5>
<p>先来看一下如何使用shared library实现最简单的helloworld输出功能，来理清楚使用shared library的流程。</p>
<h6 id="hellogroovy">Hello.groovy<a hidden class="anchor" aria-hidden="true" href="#hellogroovy">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* @author Yongxin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* @version v0.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * say hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>String content<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> content
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sayHi</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Hi, ${this.content},how are you?&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">answer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;${this.content}: fine, thank you, and you?&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sayBye</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;i am fine too , ${this.content}, Bye!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在gitlab创建项目，把library代码推送到镜像仓库。</p>
<h6 id="配置jenkins">配置Jenkins<a hidden class="anchor" aria-hidden="true" href="#配置jenkins">#</a></h6>
<p>[系统管理] -&gt; [系统设置] -&gt; [ <strong>Global Pipeline Libraries</strong> ]</p>
<ul>
<li>Library Name：luffy-devops</li>
<li>Default Version：master</li>
<li>Source Code Management：Git</li>
</ul>
<h6 id="jenkinsfile中引用">Jenkinsfile中引用<a hidden class="anchor" aria-hidden="true" href="#jenkinsfile中引用">#</a></h6>
<p><code>jenkins/pipelines/p11.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;hello-devops&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    devops<span style="color:#f92672">.</span><span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;树哥&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">sayHi</span><span style="color:#f92672">().</span><span style="color:#a6e22e">answer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">sayBye</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>创建<code>vars/devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.devops.Hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>String content<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Hello</span><span style="color:#f92672">().</span><span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>content<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="library集成镜像构建及推送">library集成镜像构建及推送<a hidden class="anchor" aria-hidden="true" href="#library集成镜像构建及推送">#</a></h5>
<p>需要实现的逻辑点：</p>
<ul>
<li>docker build，docker push，docker login</li>
<li>账户密码，jenkins凭据，（library中获取凭据内容），</li>
<li>docker login 172.21.51.67:5000</li>
<li>try catch</li>
</ul>
<h6 id="镜像构建逻辑实现">镜像构建逻辑实现<a hidden class="anchor" aria-hidden="true" href="#镜像构建逻辑实现">#</a></h6>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param repo, 172.21.51.67:5000/demo/myblog/xxx/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param tag, v1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param dockerfile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param credentialsId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>String repo<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> String credentialsId<span style="color:#f92672">,</span> String dockerfile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Dockerfile&#34;</span><span style="color:#f92672">,</span> String context<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Docker</span><span style="color:#f92672">().</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>repo<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> credentialsId<span style="color:#f92672">,</span> dockerfile<span style="color:#f92672">,</span> context<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Docker.groovy</code></p>
<p>逻辑中需要注意的点：</p>
<ul>
<li>构建和推送镜像，需要登录仓库（需要认证）</li>
<li>构建成功或者失败，需要将结果推给gitlab端</li>
<li>为了将构建过程推送到钉钉消息中，需要将构建信息统一收集</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>package com.luffy.devops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @param repo
</span></span><span style="display:flex;"><span> * @param tag
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param dockerfile
</span></span><span style="display:flex;"><span> * @param context
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def docker(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>    this.repo = repo
</span></span><span style="display:flex;"><span>    this.tag = tag
</span></span><span style="display:flex;"><span>    this.dockerfile = dockerfile
</span></span><span style="display:flex;"><span>    this.credentialsId = credentialsId
</span></span><span style="display:flex;"><span>    this.context = context
</span></span><span style="display:flex;"><span>    this.fullAddress = <span style="color:#e6db74">&#34;${this.repo}:${this.tag}&#34;</span>
</span></span><span style="display:flex;"><span>    this.isLoggedIn = false
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * build image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} &#34;</span>
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception exc) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * push image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def push() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker push ${this.fullAddress}&#34;</span>
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception exc) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * docker registry login
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def login() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(this.isLoggedIn || credentialsId == <span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // docker login
</span></span><span style="display:flex;"><span>    withCredentials([usernamePassword(credentialsId<span style="color:#960050;background-color:#1e0010">:</span> this.credentialsId, usernameVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;USERNAME&#39;</span>, passwordVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;PASSWORD&#39;</span>)]) {
</span></span><span style="display:flex;"><span>        def regs = this.getRegistry()
</span></span><span style="display:flex;"><span>        retry(3) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;docker login ${regs} -u $USERNAME -p $PASSWORD&#34;</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception exc) {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;docker login err, &#34;</span> + exc.toString()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.isLoggedIn = true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * get registry server
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def getRegistry(){
</span></span><span style="display:flex;"><span>    def sp = this.repo.split(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sp.size() &gt; 1) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sp[0]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this.repo
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>Jenkinsfile</code></p>
<p>需要先在Jenkins端创建仓库登录凭据<code>credential-registry</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="丰富构建通知逻辑">丰富构建通知逻辑<a hidden class="anchor" aria-hidden="true" href="#丰富构建通知逻辑">#</a></h6>
<p>目前的构建镜像逻辑中缺少如下内容：</p>
<ul>
<li>try逻辑中，若发生异常，是否该把异常抛出
<ul>
<li>若直接抛出异常可能会导致多次重复的异常信息</li>
<li>若不抛出，则如果未构建成功镜像，流水线感知不到错误</li>
</ul>
</li>
<li>通知gitlab端构建任务及状态</li>
<li>构建通知格式</li>
</ul>
<p>需要针对上述问题，做出优化</p>
<ol>
<li>
<p>优化try逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile}&#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            //todo
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">，</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>通知gitlab端构建任务及状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} &#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-build&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">，</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>钉钉消息通知格式</p>
<p>由于每个stage都需要构建通知任务，因此抽成公共的逻辑，为各stage调用</p>
<p><code>BuildMessage.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>package com.luffy.devops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def updateBuildMessage(String source, String add) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(!source){
</span></span><span style="display:flex;"><span>        source = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    env.BUILD_TASKS = source + add + <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> env.BUILD_TASKS
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>Docker.groovy</code> 中调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def getObject(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    this.msg = new BuildMessage()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-build&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} OK...  √&#34;</span>)
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${stage}&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} Failed...  x&#34;</span>)
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">，</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<p>使用<code>Jenkinsfile</code>来验证上述修改是否正确：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;git-log&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">GIT_LOG</span> <span style="color:#f92672">=</span> readFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;gitlog.file&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;markdown&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;title&#34;:&#34;myblog&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: &#34;😄👍 构建成功 👍😄  \n**项目名称**：luffy  \n**Git log**: ${GIT_LOG}   \n**构建分支**: ${BRANCH_NAME}   \n**构建地址**：${RUN_DISPLAY_URL}  \n**构建任务**：${env.BUILD_TASKS}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>接下来需要将<code>push</code>和<code>login</code>方法做同样的改造</p>
<p>最终的Docker.groovy文件为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>package com.luffy.devops
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @param repo
</span></span><span style="display:flex;"><span> * @param tag
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param dockerfile
</span></span><span style="display:flex;"><span> * @param context
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def docker(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>    this.repo = repo
</span></span><span style="display:flex;"><span>    this.tag = tag
</span></span><span style="display:flex;"><span>    this.dockerfile = dockerfile
</span></span><span style="display:flex;"><span>    this.credentialsId = credentialsId
</span></span><span style="display:flex;"><span>    this.context = context
</span></span><span style="display:flex;"><span>    this.fullAddress = <span style="color:#e6db74">&#34;${this.repo}:${this.tag}&#34;</span>
</span></span><span style="display:flex;"><span>    this.isLoggedIn = false
</span></span><span style="display:flex;"><span>    this.msg = new BuildMessage()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * build image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def build() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker build ${this.context} -t ${this.fullAddress} -f ${this.dockerfile} &#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>        def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-build&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} OK...  √&#34;</span>)
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>            this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} Failed...  x&#34;</span>)
</span></span><span style="display:flex;"><span>            // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">，</span>aborted pipeline
</span></span><span style="display:flex;"><span>            error errMsg
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * push image
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def push() {
</span></span><span style="display:flex;"><span>    this.login()
</span></span><span style="display:flex;"><span>    def isSuccess = false
</span></span><span style="display:flex;"><span>    def errMsg = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry(3) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker push ${this.fullAddress}&#34;</span>
</span></span><span style="display:flex;"><span>            isSuccess = true
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span> (Exception err) {
</span></span><span style="display:flex;"><span>            //ignore
</span></span><span style="display:flex;"><span>            errMsg = err.toString()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // check <span style="color:#66d9ef">if</span> build success
</span></span><span style="display:flex;"><span>    def stage = env.STAGE_NAME + <span style="color:#e6db74">&#39;-push&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(isSuccess){
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} OK...  √&#34;</span>)
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;${stage}&#34;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>        this.msg.updateBuildMessage(env.BUILD_TASKS, <span style="color:#e6db74">&#34;${stage} Failed...  x&#34;</span>)
</span></span><span style="display:flex;"><span>        // <span style="color:#66d9ef">throw</span> exception<span style="color:#960050;background-color:#1e0010">，</span>aborted pipeline
</span></span><span style="display:flex;"><span>        error errMsg
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * docker registry login
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def login() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(this.isLoggedIn || credentialsId == <span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    // docker login
</span></span><span style="display:flex;"><span>    withCredentials([usernamePassword(credentialsId<span style="color:#960050;background-color:#1e0010">:</span> this.credentialsId, usernameVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;USERNAME&#39;</span>, passwordVariable<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;PASSWORD&#39;</span>)]) {
</span></span><span style="display:flex;"><span>        def regs = this.getRegistry()
</span></span><span style="display:flex;"><span>        retry(3) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;docker login ${regs} -u $USERNAME -p $PASSWORD&#34;</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception ignored) {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;docker login err, ${ignored.toString()}&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.isLoggedIn = true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * get registry server
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def getRegistry(){
</span></span><span style="display:flex;"><span>    def sp = this.repo.split(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sp.size() &gt; 1) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sp[0]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this.repo
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>再次测试构建</p>
<h5 id="library集成k8s服务部署">library集成k8s服务部署<a hidden class="anchor" aria-hidden="true" href="#library集成k8s服务部署">#</a></h5>
<h6 id="library实现部署简单版">library实现部署简单版<a hidden class="anchor" aria-hidden="true" href="#library实现部署简单版">#</a></h6>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * kubernetes deployer
</span></span><span style="display:flex;"><span> * @param resourcePath
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def deploy(String resourcePath){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new Deploy().init(resourcePath)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>新增<code>Deploy.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>String resourcePath<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resourcePath</span> <span style="color:#f92672">=</span> resourcePath
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BuildMessage<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//env.CURRENT_IMAGE用来存储当前构建的镜像地址，需要在Docker.groovy中设置值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;kubectl apply -f ${this.resourcePath}&#34;</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.stage_name} OK...  √&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.stage_name} fail...  √&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改<code>Docker.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">push</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">login</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> isSuccess <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> errMsg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    retry<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;docker push ${this.fullAddress}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//把当前推送的镜像地址记录在环境变量中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            env<span style="color:#f92672">.</span><span style="color:#a6e22e">CURRENT_IMAGE</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fullAddress</span>
</span></span><span style="display:flex;"><span>            isSuccess <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception err<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            errMsg <span style="color:#f92672">=</span> err<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Jenkinsfile</code> 中添加如下部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="library实现自动部署优化版">library实现自动部署优化版<a hidden class="anchor" aria-hidden="true" href="#library实现自动部署优化版">#</a></h6>
<p>简单版本最明显的问题就是无法检测部署后的Pod状态，如果想做集成测试，通常要等到最新版本的Pod启动后再开始。因此有必要在部署的时候检测Pod是否正常运行。</p>
<p>比如要去检查myblog应用的pod是否部署正常，人工检查的大致步骤：</p>
<ol>
<li>
<p><code>kubectl -n luffy get pod</code>，查看pod列表</p>
</li>
<li>
<p>找到列表中带有myblog关键字的running的pod</p>
</li>
<li>
<p>查看上述running  pod数，是否和myblog的deployment中定义的replicas副本数一致</p>
</li>
<li>
<p>若一致，则检查结束，若不一致，可能稍等几秒钟，再次执行相同的检查操作</p>
</li>
<li>
<p>如果5分钟了还没有检查通过，则大概率是pod有问题，通过查看日志进一步排查</p>
</li>
</ol>
<p>如何通过library代码实现上述过程：</p>
<ol>
<li>
<p>library如何获取myblog的pod列表？</p>
<ul>
<li>
<p>首先要知道本次部署的是哪个workload，因此需要调用者传递workload的yaml文件路径</p>
</li>
<li>
<p>library解析workload.yaml文件，找到如下值：</p>
<ul>
<li>pod所在的namespace</li>
<li>pod中使用的<code>labels</code>标签</li>
</ul>
</li>
<li>
<p>使用如下命令查找该workload关联的pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n &lt;namespace&gt; get po -l &lt;key1=value1&gt; -l &lt;key2=value2&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如查找myblog的pod</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>如何确定步骤1中的pod的状态？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 或者可以直接进行提取状态</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog -ojsonpath=<span style="color:#e6db74">&#39;{.items[0].status.phase}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以json数组的形式存储</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog -o json
</span></span></code></pre></div></li>
<li>
<p>如何检测所有的副本数都是正常的？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 以json数组的形式存储</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -l app=myblog -o json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 遍历数组，检测每一个pod查看是否均正常（terminating和evicted除外）</span>
</span></span></code></pre></div></li>
<li>
<p>如何实现在5分钟的时间内，若pod状态符合预期，则退出检测循环，若不符合预期则继续检测</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>use( TimeCategory ) {
</span></span><span style="display:flex;"><span>  def endTime = TimeCategory.plus(new Date(), TimeCategory.getMinutes(timeoutMinutes,5))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (new Date() &gt;= endTime) {
</span></span><span style="display:flex;"><span>        //超时了<span style="color:#960050;background-color:#1e0010">，</span>则宣告pod状态不对
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;deploy&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;failed&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> new Exception(<span style="color:#e6db74">&#34;deployment timed out...&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    //循环检测当前deployment下的pod的状态
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (this.isDeploymentReady()) {
</span></span><span style="display:flex;"><span>          readyCount++
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span>(readyCount &gt; 5){
</span></span><span style="display:flex;"><span>            updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;deploy&#39;</span>, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          readyCount = 0
</span></span><span style="display:flex;"><span>      }<span style="color:#66d9ef">catch</span> (Exception exc){
</span></span><span style="display:flex;"><span>          echo exc.toString()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      //每次检测若不满足所有pod均正常<span style="color:#960050;background-color:#1e0010">，</span>则sleep 5秒钟后继续检测
</span></span><span style="display:flex;"><span>      sleep(5)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
</ol>
<p><code>devops.groovy</code></p>
<p>通过添加参数 watch来控制是否在pipeline中观察pod的运行状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param resourcePath
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param watch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param workloadFilePath
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span>String resourcePath<span style="color:#f92672">,</span> Boolean watch <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> String workloadFilePath<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Deploy</span><span style="color:#f92672">().</span><span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>resourcePath<span style="color:#f92672">,</span> watch<span style="color:#f92672">,</span> workloadFilePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>完整版的<code>Deploy.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.yaml.snakeyaml.Yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.json.JsonSlurperClassic
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.time.TimeCategory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>String resourcePath<span style="color:#f92672">,</span> Boolean watch<span style="color:#f92672">,</span> String workloadFilePath<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resourcePath</span> <span style="color:#f92672">=</span> resourcePath
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BuildMessage<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">watch</span> <span style="color:#f92672">=</span> watch
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadFilePath</span> <span style="color:#f92672">=</span> workloadFilePath
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(!</span>resourcePath <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>workloadFilePath<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">Exception</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;illegal resource path&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;kubectl apply -f ${this.resourcePath}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.stage_name} fail...  √&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">watch</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 初始化workload文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        initWorkload<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        String namespace <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span>
</span></span><span style="display:flex;"><span>        String name <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadName</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">toLowerCase</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;deployment&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;begin watch pod status from deployment ${env.workloadName}...&#34;</span>
</span></span><span style="display:flex;"><span>            monitorDeployment<span style="color:#f92672">(</span>namespace<span style="color:#f92672">,</span> name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//todo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            echo <span style="color:#e6db74">&#34;workload type ${env.workloadType} does not support for now...&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} OK...  √&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initWorkload</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> content <span style="color:#f92672">=</span> readFile <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadFilePath</span>
</span></span><span style="display:flex;"><span>        Yaml parser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Yaml<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> data <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span><span style="color:#a6e22e">load</span><span style="color:#f92672">(</span>content<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> kind <span style="color:#f92672">=</span> data<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;kind&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>kind<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">Exception</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;workload file ${kind} illegal, will exit pipeline!&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadType</span> <span style="color:#f92672">=</span> kind
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;${data}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span> <span style="color:#f92672">=</span> data<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;metadata&#34;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#34;namespace&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workloadNamespace</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">.</span><span style="color:#a6e22e">workloadName</span> <span style="color:#f92672">=</span> data<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;metadata&#34;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;failed to readFile ${this.workloadFilePath},exception: ${exc}.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param namespace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param timeoutMinutes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param sleepTime
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">monitorDeployment</span><span style="color:#f92672">(</span>String namespace<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> timeoutMinutes <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> sleepTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> readyCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> readyTarget <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    use<span style="color:#f92672">(</span> TimeCategory <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> endTime <span style="color:#f92672">=</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">plus</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">(),</span> TimeCategory<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinutes</span><span style="color:#f92672">(</span>timeoutMinutes<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> lastRolling
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// checking timeout
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> endTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;timeout, printing logs...&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">printContainerLogs</span><span style="color:#f92672">(</span>lastRolling<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} Failed...  x&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deployment timed out...&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// checking deployment status
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> rolling <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>namespace<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;deployment&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                lastRolling <span style="color:#f92672">=</span> rolling
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isDeploymentReady</span><span style="color:#f92672">(</span>rolling<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    readyCount<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;ready total count: ${readyCount}&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>readyCount <span style="color:#f92672">&gt;=</span> readyTarget<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} OK...  √&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    readyCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;reseting ready total count: ${readyCount}，print pods event logs&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">printContainerLogs</span><span style="color:#f92672">(</span>lastRolling<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl get pod -n ${namespace} -o wide&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_RESULT</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME} Failed...  ×&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;error: ${exc}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            sleep<span style="color:#f92672">(</span>sleepTime<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>String namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span><span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;deployment&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;kubectl get ${kind} -n ${namespace} ${name} -o json &gt; ${namespace}-${name}-yaml.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> jsonStr <span style="color:#f92672">=</span> readFile <span style="color:#e6db74">&#34;${namespace}-${name}-yaml.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> jsonSlurper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonSlurperClassic<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> jsonObj <span style="color:#f92672">=</span> jsonSlurper<span style="color:#f92672">.</span><span style="color:#a6e22e">parseText</span><span style="color:#f92672">(</span>jsonStr<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonObj
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printContainerLogs</span><span style="color:#f92672">(</span>deployJson<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deployJson <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> namespace <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">namespace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> name <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> labels<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">labels</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        labels <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${labels} -l=${k}=${v}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;kubectl describe pods -n ${namespace} ${labels}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">isDeploymentReady</span><span style="color:#f92672">(</span>deployJson<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> status <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> replicas <span style="color:#f92672">=</span> status<span style="color:#f92672">.</span><span style="color:#a6e22e">replicas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> unavailable <span style="color:#f92672">=</span> status<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;unavailableReplicas&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> ready <span style="color:#f92672">=</span> status<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;readyReplicas&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>unavailable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> deployReady <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ready <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> ready <span style="color:#f92672">==</span> replicas<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get pod information
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> deployReady<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">labels</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> labels<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> namespace <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">namespace</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> name <span style="color:#f92672">=</span> deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>            deployJson<span style="color:#f92672">.</span><span style="color:#a6e22e">spec</span><span style="color:#f92672">.</span><span style="color:#a6e22e">template</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">.</span><span style="color:#a6e22e">labels</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>                labels <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${labels} -l=${k}=${v}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>labels <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;kubectl get pods -n ${namespace} ${labels} -o json &gt; ${namespace}-${name}-json.json&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> jsonStr <span style="color:#f92672">=</span> readFile <span style="color:#e6db74">&#34;${namespace}-${name}-json.json&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> jsonSlurper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonSlurperClassic<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> jsonObj <span style="color:#f92672">=</span> jsonSlurper<span style="color:#f92672">.</span><span style="color:#a6e22e">parseText</span><span style="color:#f92672">(</span>jsonStr<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> totalCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> readyCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                jsonObj<span style="color:#f92672">.</span><span style="color:#a6e22e">items</span><span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;pod phase ${k.status.phase}&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">phase</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;Terminating&#34;</span> <span style="color:#f92672">&amp;&amp;</span> k<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">phase</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;Evicted&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        totalCount<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">phase</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Running&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            readyCount<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#34;Pod running count ${totalCount} == ${readyCount}&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> totalCount <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> totalCount <span style="color:#f92672">==</span> readyCount
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> deployReady
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改<code>Jenkinsfile</code> 调用部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    script{
</span></span><span style="display:flex;"><span>                    	devops.deploy(<span style="color:#e6db74">&#34;deploy&#34;</span>, true, <span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span>).start()
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h5 id="library实现即时消息推送">library实现即时消息推送<a hidden class="anchor" aria-hidden="true" href="#library实现即时消息推送">#</a></h5>
<h6 id="实现消息通知">实现消息通知<a hidden class="anchor" aria-hidden="true" href="#实现消息通知">#</a></h6>
<p>由于发送消息通知属于通用的功能，因此有必要把消息通知抽象成为通用的功能。</p>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * notificationSuccess
</span></span><span style="display:flex;"><span> * @param project
</span></span><span style="display:flex;"><span> * @param receiver
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param title
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def notificationSuccess(String project, String receiver=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String credentialsId=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String title=<span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>    new Notification().getObject(project, receiver, credentialsId, title).notification(<span style="color:#e6db74">&#34;success&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * notificationFailed
</span></span><span style="display:flex;"><span> * @param project
</span></span><span style="display:flex;"><span> * @param receiver
</span></span><span style="display:flex;"><span> * @param credentialsId
</span></span><span style="display:flex;"><span> * @param title
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>def notificationFailed(String project, String receiver=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String credentialsId=<span style="color:#e6db74">&#34;dingTalk&#34;</span>, String title=<span style="color:#e6db74">&#34;&#34;</span>){
</span></span><span style="display:flex;"><span>    new Notification().getObject(project, receiver, credentialsId, title).notification(<span style="color:#e6db74">&#34;failure&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>新建<code>Notification.groovy</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param credentialsId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param title
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getObject</span><span style="color:#f92672">(</span>String project<span style="color:#f92672">,</span> String receiver<span style="color:#f92672">,</span> String credentialsId<span style="color:#f92672">,</span> String title<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">project</span> <span style="color:#f92672">=</span> project
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">=</span> receiver
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">credentialsId</span> <span style="color:#f92672">=</span> credentialsId
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">=</span> title
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notification</span><span style="color:#f92672">(</span>String type<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    String msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;😄👍 ${this.title} 👍😄&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;😄👍 流水线成功啦 👍😄&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// failed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;failure&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;😖❌ ${this.title} ❌😖&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;😖❌ 流水线失败了 ❌😖&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	String title <span style="color:#f92672">=</span> msg
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rich notify msg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> genNotificationMessage<span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//new DingTalk().markDown(title, msg, this.credentialsId)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ignored<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;wechat&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//todo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">receiver</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//todo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        error <span style="color:#e6db74">&#34;no support notify type!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * get notification msg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param msg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">genNotificationMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// project
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **项目名称**: ${this.project}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get git log
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">def</span> gitlog <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>        gitlog <span style="color:#f92672">=</span> readFile <span style="color:#e6db74">&#34;gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ignored<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gitlog <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> gitlog <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **Git log**: ${gitlog}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get git branch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">def</span> gitbranch <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">BRANCH_NAME</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>gitbranch <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> gitbranch <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **Git branch**: ${gitbranch}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// build tasks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${msg}  \n  **Build Tasks**: ${env.BUILD_TASKS}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get buttons
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    msg <span style="color:#f92672">=</span> msg <span style="color:#f92672">+</span> getButtonMsg<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> msg
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getButtonMsg</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    String res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span>  buttons <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;查看流水线&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;actionURL&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;${env.RUN_DISPLAY_URL}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;代码扫描结果&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;actionURL&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://sonar.luffy.com/dashboard?id=${this.project}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    buttons<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>res <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;   \n &gt;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${res} --- [&#34;</span><span style="color:#f92672">+</span>it<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">]+</span><span style="color:#e6db74">&#34;](&#34;</span><span style="color:#f92672">+</span>it<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;actionURL&#34;</span><span style="color:#f92672">]+</span><span style="color:#e6db74">&#34;) &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>新建<code>DingTalk.groovy</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> groovy.json.JsonOutput
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> credentialsId<span style="color:#f92672">,</span> Boolean verbose<span style="color:#f92672">=</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> codes<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100:399&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> reqBody <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JsonOutput<span style="color:#f92672">().</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>data<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    withCredentials<span style="color:#f92672">([</span>usernamePassword<span style="color:#f92672">(</span>credentialsId: credentialsId<span style="color:#f92672">,</span> usernameVariable: <span style="color:#e6db74">&#39;USERNAME&#39;</span><span style="color:#f92672">,</span> passwordVariable: <span style="color:#e6db74">&#39;PASSWORD&#39;</span><span style="color:#f92672">)])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> response <span style="color:#f92672">=</span> httpRequest<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                httpMode:method<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                url: <span style="color:#e6db74">&#34;https://oapi.dingtalk.com/robot/send?access_token=${PASSWORD}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                requestBody:reqBody<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                validResponseCodes: codes<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                contentType: <span style="color:#e6db74">&#34;APPLICATION_JSON&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                quiet: <span style="color:#f92672">!</span>verbose
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">markDown</span><span style="color:#f92672">(</span>String title<span style="color:#f92672">,</span> String text<span style="color:#f92672">,</span> String credentialsId<span style="color:#f92672">,</span> Boolean verbose<span style="color:#f92672">=</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> data <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;msgtype&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;markdown&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;markdown&#34;</span><span style="color:#f92672">:</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">:</span> title<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">:</span> text
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> credentialsId<span style="color:#f92672">,</span> verbose<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>需要用到Http Request来发送消息，安装一下插件：http_request</p>
<h6 id="jenkinsfile调用">jenkinsfile调用<a hidden class="anchor" aria-hidden="true" href="#jenkinsfile调用">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationSuccess</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationFailure</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="library集成代码扫描">library集成代码扫描<a hidden class="anchor" aria-hidden="true" href="#library集成代码扫描">#</a></h5>
<p>sonarqube代码扫描作为通用功能，同样可以使用library实现。</p>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * sonarqube scanner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param projectVersion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param waitScan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scan</span><span style="color:#f92672">(</span>String projectVersion<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> Boolean waitScan <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Sonar</span><span style="color:#f92672">().</span><span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>projectVersion<span style="color:#f92672">,</span> waitScan<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>新建<code>Sonar.groovy</code></p>
<ul>
<li>可以传递projectVersion作为sonarqube的扫描版本</li>
<li>参数waitScan来设置是否等待本次扫描是否通过</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>String projectVersion<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> Boolean waitScan <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitScan</span> <span style="color:#f92672">=</span> waitScan
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BuildMessage<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>projectVersion <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        projectVersion <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> script: <span style="color:#e6db74">&#39;git log --oneline -n 1|cut -d &#34; &#34; -f 1&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;echo &#39;\nsonar.projectVersion=${projectVersion}&#39; &gt;&gt; sonar-project.properties&#34;</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;cat sonar-project.properties&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startToSonar</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">startToSonar</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    withSonarQubeEnv<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#34;sonar-scanner -X;&#34;</span>
</span></span><span style="display:flex;"><span>        sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitScan</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//wait 3min
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> qg <span style="color:#f92672">=</span> waitForQualityGate<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>            String stage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${env.stage_name}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>qg<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;OK&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${stage} Failed...  ×&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#34;${stage}&#34;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;failed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                error <span style="color:#e6db74">&#34;Pipeline aborted due to quality gate failure: ${qg.status}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msg</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_RESULT</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;${stage} OK...  √&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#34;${stage}&#34;</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;skip waitScan&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Jenkinsfile</code>新增如下部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops<span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="集成robot自动化测试">集成robot自动化测试<a hidden class="anchor" aria-hidden="true" href="#集成robot自动化测试">#</a></h5>
<p>关于集成测试，我们需要知道的几点:</p>
<ul>
<li>测试人员进行编写</li>
<li>侧重于不同模块的接口调用，对新加的功能进行验证</li>
<li>注重新版本对以前的集成用例进行回归</li>
</ul>
<p>因此，更多的应该是跨模块去测试，而且测试用例是测试人员去维护，因此不适合把代码放在开发的git仓库中。</p>
<p>本节要实现的工作：</p>
<ol>
<li>创建新的git仓库<code>robot-cases</code>，用于存放robot测试用例</li>
<li>为<code>robot-cases</code>项目创建Jenkinsfile</li>
<li>配置Jenkins任务，实现该项目的自动化执行</li>
<li>在myblog模块的流水线中，对该流水线项目进行调用</li>
</ol>
<h6 id="初始化robot-cases项目">初始化robot-cases项目<a hidden class="anchor" aria-hidden="true" href="#初始化robot-cases项目">#</a></h6>
<ol>
<li>
<p>新建gitlab项目，名称为<code>robot-cases</code></p>
</li>
<li>
<p>clone到本地</p>
</li>
<li>
<p>本地拷贝myblog项目的<code>robot.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>robot-cases/
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└──</span> myblog
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">└──</span> robot.txt
</span></span></code></pre></div></li>
</ol>
<h6 id="配置jenkinsfile及自动化任务">配置Jenkinsfile及自动化任务<a hidden class="anchor" aria-hidden="true" href="#配置jenkinsfile及自动化任务">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>robot-cases/
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">├──</span> Jenkinsfile
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└──</span> myblog
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">└──</span> robot.txt
</span></span></code></pre></div><p><code>Jenkinsfile</code></p>
<p>多个业务项目的测试用例都在一个仓库中，因此需要根据参数设置来决定执行哪个项目的用例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">comp</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                env<span style="color:#f92672">.</span><span style="color:#a6e22e">testDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;business1&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                env<span style="color:#f92672">.</span><span style="color:#a6e22e">testDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;business1&#34;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                env<span style="color:#f92672">.</span><span style="color:#a6e22e">testDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;robot -d artifacts/ ${testDir}/*&#39;</span>
</span></span><span style="display:flex;"><span>                        step<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>                            $class <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;RobotPublisher&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            outputPath: <span style="color:#e6db74">&#39;artifacts/&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            outputFileName <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;output.xml&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            disableArchiveOutput <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            passThreshold <span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            unstableThreshold: <span style="color:#ae81ff">80.0</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            onlyCritical <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            otherFiles <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>                        archiveArtifacts artifacts: <span style="color:#e6db74">&#39;artifacts/*&#39;</span><span style="color:#f92672">,</span> fingerprint: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>如何实现将<code>env.comp</code> 传递进去？</p>
<p>配置流水线的参数化构建任务并验证参数化构建</p>
<h6 id="library集成触发任务">library集成触发任务<a hidden class="anchor" aria-hidden="true" href="#library集成触发任务">#</a></h6>
<p>由于多个项目均需要触发自动构建，因此可以在library中抽象方法，实现接收comp参数，并在library中实现对<code>robot-cases</code>项目的触发。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8esharedLibrary%e8%bf%9b%e8%a1%8cCICD%e6%b5%81%e7%a8%8b%e7%9a%84%e4%bc%98%e5%8c%96/robot-trigger.png" alt=""  />
</p>
<p><code>devops.groovy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param comp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">robotTest</span><span style="color:#f92672">(</span>String comp<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Robot</span><span style="color:#f92672">().</span><span style="color:#a6e22e">acceptanceTest</span><span style="color:#f92672">(</span>comp<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>新建<code>Robot.groovy</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">package</span> com<span style="color:#f92672">.</span><span style="color:#a6e22e">luffy</span><span style="color:#f92672">.</span><span style="color:#a6e22e">devops</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">acceptanceTest</span><span style="color:#f92672">(</span>comp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Trigger to execute Acceptance Testing&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> rf <span style="color:#f92672">=</span> build job: <span style="color:#e6db74">&#39;robot-cases&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                parameters: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        string<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;comp&#39;</span><span style="color:#f92672">,</span> value: comp<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>                wait: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                propagate: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> result <span style="color:#f92672">=</span> rf<span style="color:#f92672">.</span><span style="color:#a6e22e">getResult</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${env.STAGE_NAME}... &#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;SUCCESS&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;√ success&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;UNSTABLE&#34;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;⚠ unstable&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            msg <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;× failure&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        echo rf<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbsoluteUrl</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#f92672">.</span><span style="color:#a6e22e">ROBOT_TEST_URL</span> <span style="color:#f92672">=</span> rf<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbsoluteUrl</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BuildMessage</span><span style="color:#f92672">().</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;trigger  execute Acceptance Testing exception: ${exc}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BuildMessage</span><span style="color:#f92672">().</span><span style="color:#a6e22e">updateBuildMessage</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_RESULT</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改<code>Jenkinsfile</code>测试调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;integration test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">robotTest</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;myblog&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="多环境的cicd自动化实现">多环境的CICD自动化实现<a hidden class="anchor" aria-hidden="true" href="#多环境的cicd自动化实现">#</a></h5>
<h6 id="实现目标及效果">实现目标及效果<a hidden class="anchor" aria-hidden="true" href="#实现目标及效果">#</a></h6>
<p>目前项目存在<code>develop</code>和<code>master</code>两个分支，Jenkinsfile中配置的都是构建部署到相同的环境，实际的场景中，代码仓库的项目往往不同的分支有不同的作用，我们可以抽象出一个工作流程：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8esharedLibrary%e8%bf%9b%e8%a1%8cCICD%e6%b5%81%e7%a8%8b%e7%9a%84%e4%bc%98%e5%8c%96/multi-envs.jpg" alt=""  />
</p>
<ul>
<li>
<p>开发人员提交代码到develop分支</p>
</li>
<li>
<p>Jenkins自动使用develop分支做单测、代码扫描、镜像构建（以commit id为镜像tag）、服务部署到开发环境</p>
</li>
<li>
<p>开发人员使用开发环境自测</p>
</li>
<li>
<p>测试完成后，在gitlab提交merge request请求，将代码合并至master分支</p>
</li>
<li>
<p>需要发版时，在gitlab端基于master分支创建tag（v2.3.0）</p>
</li>
<li>
<p>Jenkins自动检测到tag，拉取tag关联的代码做单测、代码扫描、镜像构建（以代码的tag为镜像的tag）、服务部署到测试环境、执行集成测试用例，输出测试报告</p>
</li>
<li>
<p>测试人员进行手动测试</p>
</li>
<li>
<p>上线</p>
</li>
</ul>
<h6 id="实现思路">实现思路<a hidden class="anchor" aria-hidden="true" href="#实现思路">#</a></h6>
<p>以myblog项目为例，目前已经具备的是develop分支代码提交后，可以自动实现：</p>
<ul>
<li>单元测试、代码扫描</li>
<li>镜像构建</li>
<li>k8s服务部署</li>
<li>robot集成用例测试</li>
</ul>
<p>和上述目标相比，差异点：</p>
<ol>
<li>myblog应用目前只有一套环境，在luffy命名空间中。我们新建两个命名空间：
<ul>
<li>dev，用作部署开发环境</li>
<li>test，用作部署集成测试环境</li>
</ul>
</li>
<li>需要根据不同的分支来执行不同的任务，有两种方案实现：
<ul>
<li>develop和master分支使用不同的Jenkinsfile
<ul>
<li>可行性很差，因为代码合并工作很繁琐</li>
<li>维护成本高，多个分支需要维护多个Jenkinsfile</li>
</ul>
</li>
<li>使用同一套Jenkinsfile，配合library和模板来实现一套Jenkinsfile适配多套环境
<ul>
<li>改造Jenkinsfile，实现根据分支来选择任务</li>
<li>需要将deploy目录中所有和特定环境绑定的内容模板化</li>
<li>在library中实现根据不同的分支，来替换模板中的内容</li>
</ul>
</li>
</ul>
</li>
</ol>
<h6 id="jenkinsfile根据分支选择任务">Jenkinsfile根据分支选择任务<a hidden class="anchor" aria-hidden="true" href="#jenkinsfile根据分支选择任务">#</a></h6>
<p>使用when关键字，配合正则表达式，实现分支的过滤选择：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;Example Build&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;Example Deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            when {
</span></span><span style="display:flex;"><span>                expression { BRANCH_NAME ==~ <span style="color:#e6db74">&#34;develop&#34;</span> }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Deploying to develop env&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>分别在develop和master分支进行验证。</p>
<p>针对本例，可以对Jenkinsfile做如下调整：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;integration test&#39;</span>) {
</span></span><span style="display:flex;"><span>            when {
</span></span><span style="display:flex;"><span>                expression { BRANCH_NAME ==~ /v.*/ }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    script{
</span></span><span style="display:flex;"><span>                    	devops.robotTest(PROJECT)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h6 id="模板化k8s的资源清单">模板化k8s的资源清单<a hidden class="anchor" aria-hidden="true" href="#模板化k8s的资源清单">#</a></h6>
<p>因为需要使用同一套模板和Jenkinsfile来部署到不同的环境，因此势必要对资源清单进行模板化，前面的内容中只将<code>deployment.yaml</code>放到了项目的<code>deploy</code>清单目录，此处将部署myblog用到的资源清单均补充进去，包含：</p>
<ul>
<li>deployment.yaml</li>
<li>service.yaml</li>
<li>ingress.yaml</li>
<li>configmap.yaml</li>
<li>secret.yaml</li>
</ul>
<p>涉及到需要进行模板化的内容包括：</p>
<ul>
<li>
<p>镜像地址</p>
</li>
<li>
<p>命名空间</p>
</li>
<li>
<p>ingress的域名信息</p>
</li>
</ul>
<p>模板化后的文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat deployment.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1   <span style="color:#75715e">#指定Pod副本数</span>
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>             <span style="color:#75715e">#指定Pod的选择器</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>   <span style="color:#75715e">#给Pod打label</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span> {{IMAGE_URL}}
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> IfNotPresent
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_HOST
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            configMapKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_HOST
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PORT
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            configMapKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PORT
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PASSWD
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PASSWD
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 500Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 100m
</span></span><span style="display:flex;"><span>        livenessProbe<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          httpGet<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            path<span style="color:#960050;background-color:#1e0010">:</span> /blog/index/
</span></span><span style="display:flex;"><span>            port<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>            scheme<span style="color:#960050;background-color:#1e0010">:</span> HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds<span style="color:#960050;background-color:#1e0010">:</span> 10  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>          periodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 15     <span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds<span style="color:#960050;background-color:#1e0010">:</span> 2             <span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>        readinessProbe<span style="color:#960050;background-color:#1e0010">:</span> 
</span></span><span style="display:flex;"><span>          httpGet<span style="color:#960050;background-color:#1e0010">:</span> 
</span></span><span style="display:flex;"><span>            path<span style="color:#960050;background-color:#1e0010">:</span> /blog/index/
</span></span><span style="display:flex;"><span>            port<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>            scheme<span style="color:#960050;background-color:#1e0010">:</span> HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds<span style="color:#960050;background-color:#1e0010">:</span> 10 
</span></span><span style="display:flex;"><span>          timeoutSeconds<span style="color:#960050;background-color:#1e0010">:</span> 2
</span></span><span style="display:flex;"><span>          periodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 15
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat configmap.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>data<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  MYSQL_HOST<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  MYSQL_PORT<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;3306&#34;</span>
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> ConfigMap
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat secret.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>data<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  MYSQL_PASSWD<span style="color:#960050;background-color:#1e0010">:</span> MTIzNDU2
</span></span><span style="display:flex;"><span>  MYSQL_USER<span style="color:#960050;background-color:#1e0010">:</span> cm9vdA==
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Secret
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>type<span style="color:#960050;background-color:#1e0010">:</span> Opaque
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat service.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - port<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  sessionAffinity<span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>  type<span style="color:#960050;background-color:#1e0010">:</span> ClusterIP
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat ingress.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> {{NAMESPACE}}
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> {{INGRESS_MYBLOG}}
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span></code></pre></div><h6 id="实现library配置替换逻辑">实现library配置替换逻辑<a hidden class="anchor" aria-hidden="true" href="#实现library配置替换逻辑">#</a></h6>
<p>我们需要实现使用相同的模板，做到如下事情：</p>
<ul>
<li>根据代码分支来部署到不同的命名空间
<ul>
<li>develop分支部署到开发环境，使用命名空间 dev</li>
<li>v.*部署到测试环境，使用命名空间 test</li>
</ul>
</li>
<li>不同环境使用不同的ingress地址来访问
<ul>
<li>开发环境，<code>blog-dev.luffy.com</code></li>
<li>测试环境，<code>blog-test.luffy.com</code></li>
</ul>
</li>
</ul>
<p>如何实现？sharedlibrary</p>
<p>所有的逻辑都会经过library这一层，我们具有完全可控权。</p>
<p>前面已经替换过镜像地址了，我们只需要实现如下逻辑：</p>
<ul>
<li>检测当前代码分支，替换命名空间</li>
<li>检测当前代码分支，替换Ingress地址</li>
</ul>
<p>问题来了，如何检测构建的触发是develop分支还是tag分支？</p>
<p>答案是：env.TAG_NAME，由tag分支触发的构建，环境变量中会带有TAG_NAME，且值为gitlab中的tag名称。</p>
<p>做个演示：</p>
<p>使用如下的Jenkinsfile，查看由master分支触发和由tag分支触发，printenv的值有什么不同</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example Deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span> BRANCH_NAME <span style="color:#f92672">==~</span> <span style="color:#e6db74">&#34;develop&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Deploying to develop env&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们可以选择和替换image镜像地址一样，来执行替换：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tplHandler</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>    String namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>    String ingress <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blog-dev.luffy.com&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAG_NAME</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>        ingress <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blog-test.luffy.com&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{NAMESPACE}}#${namespace}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{INGRESS_MYBLOG}}#${ingress}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>但是我们的library是要为多个项目提供服务的，如果采用上述方式，则每加入一个项目，都需要对library做改动，形成了强依赖。因此需要想一种更优雅的方式来进行替换。</p>
<p>思路：</p>
<ol>
<li>
<p>开发环境和集成测试环境里准备一个configmap，取名为 <code>devops-config</code></p>
</li>
<li>
<p>configmap的内容大致如下：</p>
<ul>
<li>
<p>开发环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>NAMESPACE=dev
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-dev.luffy.com
</span></span></code></pre></div></li>
<li>
<p>测试环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>NAMESPACE=test
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-test.luffy.com
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>约定：configmap的key值，拼接{{KEY}}则为代码中需要替换的模板部分，configmap的该key对应的value，则为该模板要被替换的值的内容。比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>NAMESPACE=dev
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-dev.luffy.com
</span></span><span style="display:flex;"><span>{{NAMESPACE}} =&gt; dev
</span></span><span style="display:flex;"><span>{{INGRESS_MYBLOG}} -&gt; blog-dev.luffy.com
</span></span></code></pre></div><p>意思是约定项目的deploy的资源清单中：</p>
<ul>
<li>所有的<code>{{NAMESPACE}}</code>被替换为<code>dev</code></li>
<li>所有的<code>{{INGRESS_MYBLOG}}</code>被替换为<code>blog-dev.luffy.com</code></li>
</ul>
</li>
<li>
<p>在library的逻辑中，实现读取触发当前构建的代码分支所关联的namespace下的<code>devops-config</code>这个configmap，然后遍历里面的值进行模板替换即可。</p>
</li>
</ol>
<p>这样，则以后再有新增的项目，则只需要维护<code>devops-config</code>配置文件即可，shared-library则不需要随着项目的增加而进行修改，通过这种方式实现library和具体的项目解耦。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tplHandler</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${env.CURRENT_IMAGE}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>    String namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAG_NAME</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> configMapData <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span>namespace<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;devops-config&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;configmap&#34;</span><span style="color:#f92672">)[</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        configMapData<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> k<span style="color:#f92672">,</span> v <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;key is ${k}, val is ${v}&#34;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{${k}}}#${v}#g&#39; ${this.resourcePath}/*&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception exc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;failed to get devops-config data,exception: ${exc}.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> exc
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="准备多环境">准备多环境<a hidden class="anchor" aria-hidden="true" href="#准备多环境">#</a></h6>
<ol>
<li>
<p>创建开发和测试环境的命名空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace dev
</span></span><span style="display:flex;"><span>$ kubectl create namespace test
</span></span></code></pre></div></li>
<li>
<p>分别在dev和test命名空间准备mysql数据库。演示功能，因此mysql未作持久化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat mysql-all.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> dev
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - port<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  type<span style="color:#960050;background-color:#1e0010">:</span> ClusterIP
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Secret
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> dev
</span></span><span style="display:flex;"><span>type<span style="color:#960050;background-color:#1e0010">:</span> Opaque
</span></span><span style="display:flex;"><span>data<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  MYSQL_USER<span style="color:#960050;background-color:#1e0010">:</span> cm9vdA==
</span></span><span style="display:flex;"><span>  MYSQL_PASSWD<span style="color:#960050;background-color:#1e0010">:</span> MTIzNDU2
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> dev
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1   <span style="color:#75715e">#指定Pod副本数</span>
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>             <span style="color:#75715e">#指定Pod的选择器</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>   <span style="color:#75715e">#给Pod打label</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> mysql
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span> 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/mysql<span style="color:#960050;background-color:#1e0010">:</span>5.7-utf8
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_USER
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_ROOT_PASSWORD
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_PASSWD
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> MYSQL_DATABASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 500Mi
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 100m
</span></span><span style="display:flex;"><span>        readinessProbe<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          tcpSocket<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            port<span style="color:#960050;background-color:#1e0010">:</span> 3306
</span></span><span style="display:flex;"><span>          initialDelaySeconds<span style="color:#960050;background-color:#1e0010">:</span> 5
</span></span><span style="display:flex;"><span>          periodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建开发环境的数据库</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> mysql-all.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 替换dev命名空间，创建测试环境的数据库</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/namespace: dev/namespace: test/g&#39;</span> mysql-all.yaml
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> mysql-all.yaml
</span></span></code></pre></div></li>
<li>
<p>对myblog项目的k8s资源清单模板化改造</p>
<ul>
<li>{{NAMESPACE}}</li>
<li>{{INGRESS_MYBLOG}}</li>
<li>{{IMAGE_URL}}</li>
</ul>
</li>
<li>
<p>初始化开发环境和测试环境的<code>devops-config</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 开发环境</span>
</span></span><span style="display:flex;"><span>$ cat devops-config-dev.txt
</span></span><span style="display:flex;"><span>NAMESPACE=dev
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-dev.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n dev create configmap devops-config --from-env<span style="color:#f92672">-file</span>=devops-config-dev.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 测试环境</span>
</span></span><span style="display:flex;"><span>$ cat devops-config-test.txt
</span></span><span style="display:flex;"><span>NAMESPACE=test
</span></span><span style="display:flex;"><span>INGRESS_MYBLOG=blog-test.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n test create configmap devops-config --from-env<span style="color:#f92672">-file</span>=devops-config-test.txt
</span></span></code></pre></div></li>
<li>
<p>提交最新的library代码</p>
</li>
<li>
<p>提交最新的python-demo项目代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#a6e22e">@Library</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        PROJECT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops<span style="color:#f92672">.</span><span style="color:#a6e22e">scan</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops<span style="color:#f92672">.</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${IMAGE_REPO}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;${GIT_COMMIT}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL                          
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">().</span><span style="color:#a6e22e">push</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">deploy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span><span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;integration test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span> BRANCH_NAME <span style="color:#f92672">==~</span> <span style="color:#e6db74">/v.*/</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops<span style="color:#f92672">.</span><span style="color:#a6e22e">robotTest</span><span style="color:#f92672">(</span>PROJECT<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationSuccess</span><span style="color:#f92672">(</span>PROJECT<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops<span style="color:#f92672">.</span><span style="color:#a6e22e">notificationFailure</span><span style="color:#f92672">(</span>PROJECT<span style="color:#f92672">,</span><span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h6 id="验证多环境自动部署">验证多环境自动部署<a hidden class="anchor" aria-hidden="true" href="#验证多环境自动部署">#</a></h6>
<p>模拟如下流程：</p>
<ol>
<li>
<p>提交代码到develop分支，观察是否部署到dev的命名空间中，注意，第一次部署，需要执行migrate操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> $ kubectl -n dev exec  myblog-9f9f7c8cd-k6tbj python3 manage.py migrate
</span></span></code></pre></div></li>
<li>
<p>配置hosts解析，测试使用<code>http://blog-dev.luffy.com/blog/index/</code>进行访问到develop分支最新版本</p>
</li>
<li>
<p>合并代码至master分支</p>
</li>
<li>
<p>在gitlab中创建tag，观察是否自动部署至test的命名空间中，且使用<code>myblog-test.luffy.com/blog/index/</code>可以访问到最新版本</p>
</li>
</ol>
<h6 id="实现打tag后自动部署">实现打tag后自动部署<a hidden class="anchor" aria-hidden="true" href="#实现打tag后自动部署">#</a></h6>
<p>我们发现，打了tag以后，多分支流水线中可以识别到该tag，但是并不会自动部署该tag的代码。因此，我们来使用一个新的插件：Basic Branch Build Strategies Plugin</p>
<p>安装并配置多分支流水线，注意Build strategies 设置：</p>
<ul>
<li>Regular branches</li>
<li>Tags
<ul>
<li>Ignore tags newer than 可以不用设置，不然会默认不自动构建新打的tag</li>
<li>Ignore tags older than</li>
</ul>
</li>
</ul>
<h6 id="优化镜像部署逻辑">优化镜像部署逻辑<a hidden class="anchor" aria-hidden="true" href="#优化镜像部署逻辑">#</a></h6>
<p>针对部署到测试环境的代码，由于已经打了tag了，因此，我们期望构建出来的镜像地址可以直接使用代码的tag作为镜像的tag。</p>
<p>思路一：直接在Jenkinsfile调用<code>devops.docker</code>时传递tag名称</p>
<p>思路二：在shared-library中，根据<code>env.TAG_NAME</code>来判断当前是否是tag分支的构建，若TAG_NAME不为空，则可以在构建镜像时使用TAG_NAME作为镜像的tag</p>
<p>很明显我们更期望使用思路二的方式来实现，因此，需要调整如下逻辑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>def docker(String repo, String tag, String credentialsId, String dockerfile=<span style="color:#e6db74">&#34;Dockerfile&#34;</span>, String context=<span style="color:#e6db74">&#34;.&#34;</span>){
</span></span><span style="display:flex;"><span>    this.repo = repo
</span></span><span style="display:flex;"><span>    this.tag = tag
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(env.TAG_NAME){
</span></span><span style="display:flex;"><span>        this.tag = env.TAG_NAME
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.dockerfile = dockerfile
</span></span><span style="display:flex;"><span>    this.credentialsId = credentialsId
</span></span><span style="display:flex;"><span>    this.context = context
</span></span><span style="display:flex;"><span>    this.fullAddress = <span style="color:#e6db74">&#34;${this.repo}:${this.tag}&#34;</span>
</span></span><span style="display:flex;"><span>    this.isLoggedIn = false
</span></span><span style="display:flex;"><span>    this.msg = new BuildMessage()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> this
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>提交代码，并进行测试，观察是否使用tag作为镜像标签进行部署。</p>
<h5 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h5>
<p>Jenkins-shared-library的代码地址： <a href="https://gitee.com/agagin/jenkins-shared-library">https://gitee.com/agagin/jenkins-shared-library</a></p>
<p>目标：让devops流程更好用</p>
<ul>
<li>项目更简便的接入</li>
<li>devops流程更方便维护</li>
</ul>
<p>思路：把各项目中公用的逻辑，抽象成方法，放到独立的library项目中，在各项目中引入shared-library项目，调用library提供的方法。</p>
<ul>
<li>镜像构建、推送</li>
<li>k8s服务部署、监控</li>
<li>钉钉消息推送</li>
<li>代码扫描</li>
<li>robot集成测试</li>
</ul>
<p>为了兼容多环境的CICD，因此采用模板与数据分离的方式，项目中的定义模板，shared-library中实现模板替换。为了实现shared-library与各项目解耦，使用configmap来维护模板与真实数据的值，思路是约定大于配置。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/">
    <span class="title">« 上一页</span>
    <br>
    <span>SpringBoot与SpringCloud微服务项目交付</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/">
    <span class="title">下一页 »</span>
    <br>
    <span>从零开始构建基于Kubernetes的Devops平台</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
