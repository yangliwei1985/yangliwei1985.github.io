<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>生产环境搭建高可用Harbor | ylw&#39;s blog</title>
<meta name="keywords" content="harbor" />
<meta name="description" content="前言 因资源成本问题，本Harbor高可用架构为最小开销方案，如果资源充足，可以将PG、Redis全部使用使用云厂商集群模式。
同时为了配置简单，并没有使用keepalived与heartbeat等高可用开源组件。
准备工作    阿里云SLB 阿里云ECS 共享存储 Redis     最小实例SLB 2c4g 2台 阿里云NFS 阿里云Redis    操作系统为Ubuntu18.04，在2台ECS上搭建主从PG，如果不想用阿里云redis，也可以使用ECS搭建Redis。
安装Harbor，用于导出基础harbor数据，恢复到PG集群中.   安装docker-compose
curl -L &#34;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&#34; -o /usr/local/bin/docker-compose sudo chmod &#43;x /usr/local/bin/docker-compose sudo add-apt-repository &#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs)stable&#34; # 添加国内阿里云 curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - #更新 sudo apt-get update [[查看docker]]版本 apt-cache madison docker-ce #安装最新版 sudo apt-get install -y docker-ce [[安装5]]:19.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8harbor/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="生产环境搭建高可用Harbor" />
<meta property="og:description" content="前言 因资源成本问题，本Harbor高可用架构为最小开销方案，如果资源充足，可以将PG、Redis全部使用使用云厂商集群模式。
同时为了配置简单，并没有使用keepalived与heartbeat等高可用开源组件。
准备工作    阿里云SLB 阿里云ECS 共享存储 Redis     最小实例SLB 2c4g 2台 阿里云NFS 阿里云Redis    操作系统为Ubuntu18.04，在2台ECS上搭建主从PG，如果不想用阿里云redis，也可以使用ECS搭建Redis。
安装Harbor，用于导出基础harbor数据，恢复到PG集群中.   安装docker-compose
curl -L &#34;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&#34; -o /usr/local/bin/docker-compose sudo chmod &#43;x /usr/local/bin/docker-compose sudo add-apt-repository &#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs)stable&#34; # 添加国内阿里云 curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - #更新 sudo apt-get update [[查看docker]]版本 apt-cache madison docker-ce #安装最新版 sudo apt-get install -y docker-ce [[安装5]]:19." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8harbor/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-18T18:15:43&#43;00:00" />
<meta property="article:modified_time" content="2022-02-18T18:15:43&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="生产环境搭建高可用Harbor"/>
<meta name="twitter:description" content="前言 因资源成本问题，本Harbor高可用架构为最小开销方案，如果资源充足，可以将PG、Redis全部使用使用云厂商集群模式。
同时为了配置简单，并没有使用keepalived与heartbeat等高可用开源组件。
准备工作    阿里云SLB 阿里云ECS 共享存储 Redis     最小实例SLB 2c4g 2台 阿里云NFS 阿里云Redis    操作系统为Ubuntu18.04，在2台ECS上搭建主从PG，如果不想用阿里云redis，也可以使用ECS搭建Redis。
安装Harbor，用于导出基础harbor数据，恢复到PG集群中.   安装docker-compose
curl -L &#34;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&#34; -o /usr/local/bin/docker-compose sudo chmod &#43;x /usr/local/bin/docker-compose sudo add-apt-repository &#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs)stable&#34; # 添加国内阿里云 curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - #更新 sudo apt-get update [[查看docker]]版本 apt-cache madison docker-ce #安装最新版 sudo apt-get install -y docker-ce [[安装5]]:19."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "生产环境搭建高可用Harbor",
      "item": "https://iblog.zone/archives/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8harbor/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "生产环境搭建高可用Harbor",
  "name": "生产环境搭建高可用Harbor",
  "description": "前言 因资源成本问题，本Harbor高可用架构为最小开销方案，如果资源充足，可以将PG、Redis全部使用使用云厂商集群模式。\n同时为了配置简单，并没有使用keepalived与heartbeat等高可用开源组件。\n准备工作    阿里云SLB 阿里云ECS 共享存储 Redis     最小实例SLB 2c4g 2台 阿里云NFS 阿里云Redis    操作系统为Ubuntu18.04，在2台ECS上搭建主从PG，如果不想用阿里云redis，也可以使用ECS搭建Redis。\n安装Harbor，用于导出基础harbor数据，恢复到PG集群中.   安装docker-compose\ncurl -L \u0026#34;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)\u0026#34; -o /usr/local/bin/docker-compose sudo chmod +x /usr/local/bin/docker-compose sudo add-apt-repository \u0026#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs)stable\u0026#34; # 添加国内阿里云 curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - #更新 sudo apt-get update [[查看docker]]版本 apt-cache madison docker-ce #安装最新版 sudo apt-get install -y docker-ce [[安装5]]:19.",
  "keywords": [
    "harbor"
  ],
  "articleBody": "前言 因资源成本问题，本Harbor高可用架构为最小开销方案，如果资源充足，可以将PG、Redis全部使用使用云厂商集群模式。\n同时为了配置简单，并没有使用keepalived与heartbeat等高可用开源组件。\n准备工作    阿里云SLB 阿里云ECS 共享存储 Redis     最小实例SLB 2c4g 2台 阿里云NFS 阿里云Redis    操作系统为Ubuntu18.04，在2台ECS上搭建主从PG，如果不想用阿里云redis，也可以使用ECS搭建Redis。\n安装Harbor，用于导出基础harbor数据，恢复到PG集群中.   安装docker-compose\ncurl -L \"https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose sudo chmod +x /usr/local/bin/docker-compose sudo add-apt-repository \"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs)stable\" # 添加国内阿里云 curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - #更新 sudo apt-get update [[查看docker]]版本 apt-cache madison docker-ce #安装最新版 sudo apt-get install -y docker-ce [[安装5]]:19.03.6~3-0~ubuntu-bionic版 sudo apt-get install -y docker-ce=5:19.03.6~3-0~ubuntu-bionic   Docker配置镜像加速与国内docker-cn源\nsudo tee /etc/docker/daemon.json { \"registry-mirrors\": [\"https://8sab4djv.mirror.aliyuncs.com\"], \"registry-mirrors\": [\"https://registry.docker-cn.com\"], \"insecure-registries\": [\"https://harbor.unixsre.com\"] } EOF sudo systemctl daemon-reload sudo systemctl restart docker   安装Harbor2.3\n# 下载Harbor wget -P /usr/local wget https://github.com/goharbor/harbor/releases/download/v2.3.2/harbor-online-installer-v2.3.2.tgz  tar zxf /usr/local/harbor-online-installer-v2.3.2.tgz -C /data/harbor  # 修改配置文件，根据自己的需求进行修改 cd /data/harbor cp harbor.yml.tmpl harbor.yml # harbor.yml中按需修改或添加如下内容 # Configuration file of Harbor  # The IP address or hostname to access admin UI and registry service. # DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients. hostname: harbor.unixsre.com  # http related config http:  # port for http, default is 80. If https enabled, this port will redirect to https port  port: 80  # https related config https:  # https port for harbor, default is 443  port: 443  # The path of cert and key files for nginx  certificate: /data/harbor/ssl/unixsre.com.cer  private_key: /data/harbor/ssl/unixsre.com.key  # # Uncomment following will enable tls communication between all harbor components # internal_tls: # # set enabled to true means internal tls is enabled # enabled: true # # put your cert and key files on dir # dir: /etc/harbor/tls/internal  # Uncomment external_url if you want to enable external proxy # And when it enabled the hostname will no longer used # external_url: https://reg.mydomain.com:8433  # The initial password of Harbor admin # It only works in first time to install harbor # Remember Change the admin password from UI after launching Harbor. # 初始密码，可以修改成自己需要的，然后后续在WEBUI上自行修改。 harbor_admin_password: 1234567 ## 添加禁止用户自注册 self_registration: off ## 设置只有管理员可以创建项目 project_creation_restriction: adminonly # The default data volume data_volume: /data/harbor # 执行安装命令 bash /data/harbor/install.sh # 如果对配置文件harbor.yml，需要使用./prepare脚本重新生成 ./prepare # 重启 docker-compose restart   常用命令示例\n# 登录 docker login https://harbor.unixsre.com # 拉取 docker pull busybox # 打包 docker build -t busybox:v1 . docker build -t busybox:v1 -f Dockerfile . # 打TAG docker tag busybox:latest harbor.unixsre.com/ops/busybox:latest # 上传 docker push harbor.unixsre.com/library/busybox:latest # k3s pull k3s crictl pull harbor.unixsre.com/library/busybox   备份Harbor使用到的数据库，并且导出用于恢复.\n# 进入容器备份 docker container exec -it harbor-db /bin/bash # 执行pg备份 pg_dump -U postgres registry  /tmp/registry.sql pg_dump -U postgres notarysigner  /tmp/notarysigner.sql pg_dump -U postgres notaryserver  /tmp/notaryserver.sql # 复制到本地宿主机 docker container cp harbor-db:/tmp/registry.sql /data/harbor/backup_sql/ docker container cp harbor-db:/tmp/notarysigner.sql /data/harbor/backup_sql/ docker container cp harbor-db:/tmp/notaryserver.sql /data/harbor/backup_sql/   安装PG主从集群 PostgreSql主从复制是一种高可用解决方案，可以实现读写分离，实时备份，PG的主从复制是基于xlog来实现的，主库开启日志功能，从库根据主库xlog来完成数据的同步。\nPG主从复制注意事项：\n 启动从库之前: 不能执行初始化，若已经初始化了需要删掉对应的目录中的数据文件。 启动从库之前: 需要通过base_backup从主服务器上同步配置与数据。 启动从库之前: 需要对同步之后的配置文件（standby.signal）进行修改。 从库只能读，不能写。    分别在每个ECS安装postgresql-13\n# 添加PG apt源 sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\"  /etc/apt/sources.list.d/pgdg.list' wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - # 更新源 apt-get update # 安装PG13 apt -y install postgresql-13 postgresql-client-13 postgresql-contrib # 验证服务是否启动成功 systemctl status postgresql@13-main.service # 登录验证修改密码 sudo -i -u postgres psql -p 5432 ALTER USER postgres WITH PASSWORD '1234567.com'; # 登录验证 psql -h localhost -p 5432 -U postgres   创建PG数据目录，分别在每个机器上创建.\n#创建数据目录 mkdir -p /data/harbor_nas/pgsql/data \u0026\u0026 chown postgres:postgres /data/harbor_nas/pgsql/data #创建归档目录 mkdir -p /data/harbor_nas/pgsql/pg_archive \u0026\u0026 chown postgres:postgres /data/harbor_nas/pgsql/pg_archive #给目录赋权 chmod 700 /data/harbor_nas/pgsql/pg_archive/ \u0026\u0026 chmod 700 /data/harbor_nas/pgsql/data/   添加systemd启动配置文件中的数据目录环境变量.\nvim /lib/systemd/system/postgresql@.service Environment=PGDATA=/data/harbor_nas/pgsql/data # 重载 systemctl daemon-reload # 删除默认集群 pg_dropcluster --stop 13 main # 在新目录创建集群 pg_createcluster -d /data/harbor_nas/pgsql/data 13 main # 重启服务 systemctl restart postgresql@13-main.service # 配置开机启动 systemctl enable postgresql@13-main.service #开启外部访问配置 vim /etc/postgresql/13/main/pg_hba.conf local all postgres peer  # TYPE DATABASE USER ADDRESS METHOD  # \"local\" is for Unix domain socket connections only local all all peer # IPv4 local connections: host all all 0.0.0.0/0 md5 # IPv6 local connections: host all all ::1/128 md5 # Allow replication connections from localhost, by a user with the # replication privilege. local replication all peer host replication all 127.0.0.1/32 md5 host replication all ::1/128 md5 # 修改集群监听地址 vim /etc/postgresql/13/main/postgresql.conf listen_addresses = '*' # 重启服务 systemctl restart postgresql@13-main.service   主服务器配置\n# 创建具有复制流操作权限的的用户：replica CREATE ROLE replica login replication encrypted password 'Deniss_12PRO@@@'; # 添加从服务器免密登录,replica为用户,172.19.48.254X为从节点的内网IP，md5为允许密码验证, trust为免密。 vim /etc/postgresql/13/main/pg_hba.conf host replication replica 172.19.48.254/20 trust # 添加主服务器postgresql.conf配置 vim /etc/postgresql/13/main/postgresql.conf listen_addresses = '*' max_connections = 100 archive_mode = on archive_command = 'test ! -f /data/harbor_nas/pgsql/pg_archive/%f \u0026\u0026 cp %p /data/harbor_nas/pgsql/pg_archive/%f' wal_level = replica # 重启服务 systemctl restart postgresql@13-main.service   从服务器配置\n# 如果前面已经在从服务器执行过了这个操作，直接可以进入postgres用户家目录清理、复制数据。 #创建数据目录 mkdir -p /data/harbor_nas/pgsql_replica/data \u0026\u0026 chown postgres:postgres /data/harbor_nas/pgsql_replica/data #创建归档目录 mkdir -p /data/harbor_nas/pgsql_replica/pg_archive \u0026\u0026 chown postgres:postgres /data/harbor_nas/pgsql_replica/pg_archive #给目录赋权 chmod 700 /data/harbor_nas/pgsql_replica/pg_archive/ \u0026\u0026 chmod 700 /data/harbor_nas/pgsql_replica/data/ # 添加如下配置 vim /lib/systemd/system/postgresql@.service Environment=PGDATA=/data/harbor_nas/pgsql_replica/data/ # 重载配置 systemctl daemon-reload #删除默认目录的集群 pg_dropcluster --stop 13 main #在新目录创建集群 pg_createcluster -d /data/harbor_nas/pgsql_replica/data 13 main #重启服务 systemctl restart postgresql@13-main.service # 进入postgres用户清理初始化的数据，从主服务器复制数据。 su - postgres rm -rf /data/harbor_nas/pgsql_replica/data/* pg_basebackup -h 172.19.48.253 -p 5432 -U replica -Fp -Xs -Pv -R -D /data/harbor_nas/pgsql_replica/data echo \"standby_mode = 'on'\"  /data/harbor_nas/pgsql_replica/data/standby.signal # 修改从服务器配置 vim /etc/postgresql/13/main/postgresql.conf primary_conninfo = 'host=172.19.48.253 port=5432 user=replica password=Deniss_12PRO@@@' recovery_target_timeline = latest max_connections = 100 hot_standby = on max_standby_streaming_delay = 30s wal_receiver_status_interval = 10s hot_standby_feedback = on # 启动从节点PG数据库 systemctl start postgresql@13-main.service # 登录主节点数据库查看装 psql -h 172.19.48.253 -p 5432 -U postgres postgres=# select client_addr,sync_state from pg_stat_replication;  client_addr | sync_state ---------------+------------  172.19.48.254 | async # 至此，PG主从复制安装完成。   配置Horbor为PG主节点   登录主节点创建harbor用户与harbor需要的DB，并且将数据恢复到当前数据.\n# 新建Harbor用户 CREATE USER harbor LOGIN PASSWORD 'Deniss1112s'; CREATE SCHEMA harbor; GRANT harbor TO postgres;GRANT USAGE ON SCHEMA harbor TO postgres; ALTER SCHEMA harbor OWNER TO postgres; # 创建数据库 CREATE DATABASE registry OWNER harbor; CREATE DATABASE notarysigner OWNER harbor; CREATE DATABASE notaryserver OWNER harbor; # 授权 GRANT ALL PRIVILEGES ON DATABASE registry TO harbor; GRANT ALL PRIVILEGES ON DATABASE notarysigner TO harbor; GRANT ALL PRIVILEGES ON DATABASE notaryserver TO harbor; # 恢复数据库 psql -h localhost -U harbor registry psql -h localhost -U harbor notarysigner psql -h localhost -U harbor notaryserver   对2个ECS的harbor.yml进行调整，开启外部PG、Redis配置，注释掉默认PG数据库配置，注意：2个ECS中Harbor链接的配置的必须为同样的Redis与PG数据库。\nhostname: harbor.unixsre.com  http:  port: 80  https:  port: 443  certificate: /data/harbor/ssl/unixsre.com.cer  private_key: /data/harbor/ssl/unixsre.com.key  harbor_admin_password: 1234567  data_volume: /data/harbor_nas/harbor_data  trivy:  ignore_unfixed: false  skip_update: false  insecure: false  jobservice:  max_job_workers: 10  notification:  webhook_job_max_retry: 10  chart:  absolute_url: disabled  log:  level: info  local:  rotate_count: 50  rotate_size: 200M  location: /var/log/harbor  _version: 2.3.0  external_database:  harbor:  host: 172.19.48.253  port: 5432  db_name: registry  username: harbor  password: Deniss1112s  ssl_mode: disable  max_idle_conns: 2  max_open_conns: 0  notary_signer:  host: 172.19.48.253  port: 5432  db_name: notarysigner  username: harbor  password: Deniss1112s  ssl_mode: disable  notary_server:  host: 172.19.48.253  port: 5432  db_name: notaryserver  username: harbor  password: Deniss1112s  ssl_mode: disable  external_redis:  host: 172.19.48.253:6379  password: Deniss1589s  registry_db_index: 1  jobservice_db_index: 2  chartmuseum_db_index: 3  trivy_db_index: 5  idle_timeout_seconds: 30  proxy:  http_proxy:  https_proxy:  no_proxy:  components:  - core  - jobservice  - trivy   harbor重新生成配置，并且重启容器.\ncd /data/harbor/ ./prepare docker-compose down \u0026\u0026 docker-compose up -d   在阿里云创建传统SLB，使用TCP四层添加443端口监听。\n  将域名绑定在新建的SLB上，这个SLB不一定非要是阿里云的，任何云的SLB都可以，比如AWS、微软云、GCP都可以。\n  PG主从故障切换 假设主库宕机或者主节点宕机，因为我们的Redis在阿里云，而Harbor的镜像数据在阿里云的NFS，要保证服务的可用性，这个时候，只需要快速的将从节点切换为主库，并且修改Harbor的配置文件，重启Harbor的服务下即可。\n下面为手动操作，建议调整为脚本执行快速切换。\n  模拟当前主节点库挂掉,\n# 停止主数据库的PG服务. service postgresql@13-main stop   激活备库为主库.\npsql -h 172.19.48.254 -p 5432 -U postgres postgres=# select pg_promote(true,60); # 验证是否升级为主库 /usr/lib/postgresql/13/bin/pg_controldata -D /data/harbor_nas/pgsql_replica/data/ |grep cluster Database cluster state: in production   修改Harbor配置，重启所有Harbor服务\n#  sed -i 's/172.19.48.253/172.19.48.254/' ./prepare docker-compose down \u0026\u0026 docker-compose up -d   访问域名，验证harbor服务的可用性。\n  快速恢复主节点，将主节点的PG库设置为从库。\n# 修改253从库免密配置，可以提前设置好，不需要此处配置了 /etc/postgresql/13/main/pg_hba.conf host replication replica 172.19.48.253/20 trust # 切换用户 su - postgres # 清理数据 rm -rf /data/harbor_nas/pgsql/data/* # 同步254数据到253 pg_basebackup -h 172.19.48.254 -p 5432 -U replica -Fp -Xs -Pv -R -D /data/harbor_nas/pgsql/data/ echo \"standby_mode = 'on'\"  /data/harbor_nas/pgsql/data/standby.signal # 修改253配置 vim /etc/postgresql/13/main/postgresql.conf primary_conninfo = 'host=172.19.48.254 port=5432 user=replica password=Deniss_12PRO@@@' recovery_target_timeline = latest max_connections = 100 hot_standby = on max_standby_streaming_delay = 30s wal_receiver_status_interval = 10s hot_standby_feedback = on # 启动253PG服务 systemctl start postgresql@13-main.service   在当前主节点254登录验证集群复制是否正常.\n# 登录节点验证当前同步是否正常 psql -h localhost -p 5432 -U postgres postgres=# select client_addr,sync_state from pg_stat_replication;  client_addr | sync_state ---------------+------------  172.19.48.253 | async   如果想将原来的库基本恢复成主库，只需要清理掉standby.signal文件，在原来的从库上的数据目录中新建standby.signal文件，并且将standby_mode = 'on'配置好，重启PG服务即可。\n  灾难性故障恢复 对于不可抗拒因素是比较极端的情况，任何人都无法预料，包括当前的各种云厂商，我们只把能想到的，能做到的全部做好，我这边已经做了PG数据库的全备上传到了OSS上，Harbor的镜像数据阿里云NFS一份，OSS一份，想要灾难性恢复必须保证如下俩个前提：\n PG数据库全备可用（注意：必须可以承受丢失全备时间起止到故障时间的数据）。 阿里云NFS或者OSS中的Harbor镜像数据文件可用。  恢复步骤：搭建一个单节点PG，全备导入，Harbor中的配置使用单节点PG，Redis本地或者harbor启动的都可以，然后使用docker-compose启动即可，具体操作步骤不在叙述。\n但是这样并不是最快的方法，还有没有更好的方案呢？当然有了，使用云服务，一切都交给云，但是就算是云也不可能保证100%的可用性，此处的灾难性故障恢复，仅做抛砖引玉，并不是最终的解决方案，只是给大家提供一个可以展开思考的思路，如果大家有更完美完善的方案，欢迎一起交流。\n",
  "wordCount" : "1183",
  "inLanguage": "zh",
  "datePublished": "2022-02-18T18:15:43Z",
  "dateModified": "2022-02-18T18:15:43Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8harbor/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      生产环境搭建高可用Harbor
    </h1>
    <div class="post-meta"><span title='2022-02-18 18:15:43 +0000 UTC'>2022-02-18</span>&nbsp;·&nbsp;6 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                    <li>
                        <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="准备工作">准备工作</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85harbor%e7%94%a8%e4%ba%8e%e5%af%bc%e5%87%ba%e5%9f%ba%e7%a1%80harbor%e6%95%b0%e6%8d%ae%e6%81%a2%e5%a4%8d%e5%88%b0pg%e9%9b%86%e7%be%a4%e4%b8%ad" aria-label="安装Harbor，用于导出基础harbor数据，恢复到PG集群中.">安装Harbor，用于导出基础harbor数据，恢复到PG集群中.</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85pg%e4%b8%bb%e4%bb%8e%e9%9b%86%e7%be%a4" aria-label="安装PG主从集群">安装PG主从集群</a></li>
                    <li>
                        <a href="#%e9%85%8d%e7%bd%aehorbor%e4%b8%bapg%e4%b8%bb%e8%8a%82%e7%82%b9" aria-label="配置Horbor为PG主节点">配置Horbor为PG主节点</a></li>
                    <li>
                        <a href="#pg%e4%b8%bb%e4%bb%8e%e6%95%85%e9%9a%9c%e5%88%87%e6%8d%a2" aria-label="PG主从故障切换">PG主从故障切换</a></li>
                    <li>
                        <a href="#%e7%81%be%e9%9a%be%e6%80%a7%e6%95%85%e9%9a%9c%e6%81%a2%e5%a4%8d" aria-label="灾难性故障恢复">灾难性故障恢复</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h3>
<p>因资源成本问题，本Harbor高可用架构为最小开销方案，如果资源充足，可以将PG、Redis全部使用使用云厂商集群模式。</p>
<p>同时为了配置简单，并没有使用keepalived与heartbeat等高可用开源组件。</p>
<p><img loading="lazy" src="/images/%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e9%ab%98%e5%8f%af%e7%94%a8Harbor/640.webp" alt=""  />
</p>
<h3 id="准备工作">准备工作<a hidden class="anchor" aria-hidden="true" href="#准备工作">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:center">阿里云SLB</th>
<th style="text-align:center">阿里云ECS</th>
<th style="text-align:center">共享存储</th>
<th style="text-align:center">Redis</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">最小实例SLB</td>
<td style="text-align:center">2c4g 2台</td>
<td style="text-align:center">阿里云NFS</td>
<td style="text-align:center">阿里云Redis</td>
</tr>
</tbody>
</table>
<p>操作系统为Ubuntu18.04，在2台ECS上搭建主从PG，如果不想用阿里云redis，也可以使用ECS搭建Redis。</p>
<h3 id="安装harbor用于导出基础harbor数据恢复到pg集群中">安装Harbor，用于导出基础harbor数据，恢复到PG集群中.<a hidden class="anchor" aria-hidden="true" href="#安装harbor用于导出基础harbor数据恢复到pg集群中">#</a></h3>
<ol>
<li>
<p>安装docker-compose</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>sudo chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>sudo add-apt-repository <span style="color:#e6db74">&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加国内阿里云</span>
</span></span><span style="display:flex;"><span>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
</span></span><span style="display:flex;"><span><span style="color:#75715e">#更新</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span><span style="color:#f92672">[[</span>查看docker<span style="color:#f92672">]]</span>版本
</span></span><span style="display:flex;"><span>apt-cache madison docker-ce
</span></span><span style="display:flex;"><span><span style="color:#75715e">#安装最新版</span>
</span></span><span style="display:flex;"><span>sudo apt-get install -y docker-ce
</span></span><span style="display:flex;"><span><span style="color:#f92672">[[</span>安装5<span style="color:#f92672">]]</span>:19.03.6~3-0~ubuntu-bionic版
</span></span><span style="display:flex;"><span>sudo apt-get install -y docker-ce<span style="color:#f92672">=</span>5:19.03.6~3-0~ubuntu-bionic
</span></span></code></pre></div></li>
<li>
<p>Docker配置镜像加速与国内docker-cn源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo tee /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;registry-mirrors&#34;: [&#34;https://8sab4djv.mirror.aliyuncs.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;registry-mirrors&#34;: [&#34;https://registry.docker-cn.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;insecure-registries&#34;: [&#34;https://harbor.unixsre.com&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl restart docker
</span></span></code></pre></div><p><img loading="lazy" src="/images/%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e9%ab%98%e5%8f%af%e7%94%a8Harbor/650.webp" alt=""  />
</p>
</li>
<li>
<p>安装Harbor2.3</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 下载Harbor</span>
</span></span><span style="display:flex;"><span>wget -P /usr/local wget https://github.com/goharbor/harbor/releases/download/v2.3.2/harbor-online-installer-v2.3.2.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar zxf /usr/local/harbor-online-installer-v2.3.2.tgz -C /data/harbor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改配置文件，根据自己的需求进行修改</span>
</span></span><span style="display:flex;"><span>cd /data/harbor
</span></span><span style="display:flex;"><span>cp harbor.yml.tmpl harbor.yml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># harbor.yml中按需修改或添加如下内容</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configuration file of Harbor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The IP address or hostname to access admin UI and registry service.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span>
</span></span><span style="display:flex;"><span>hostname: harbor.unixsre.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http related config</span>
</span></span><span style="display:flex;"><span>http:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># port for http, default is 80. If https enabled, this port will redirect to https port</span>
</span></span><span style="display:flex;"><span>  port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https related config</span>
</span></span><span style="display:flex;"><span>https:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># https port for harbor, default is 443</span>
</span></span><span style="display:flex;"><span>  port: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The path of cert and key files for nginx</span>
</span></span><span style="display:flex;"><span>  certificate: /data/harbor/ssl/unixsre.com.cer
</span></span><span style="display:flex;"><span>  private_key: /data/harbor/ssl/unixsre.com.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # Uncomment following will enable tls communication between all harbor components</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># internal_tls:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # set enabled to true means internal tls is enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   enabled: true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # put your cert and key files on dir</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   dir: /etc/harbor/tls/internal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment external_url if you want to enable external proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># And when it enabled the hostname will no longer used</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># external_url: https://reg.mydomain.com:8433</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The initial password of Harbor admin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># It only works in first time to install harbor</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remember Change the admin password from UI after launching Harbor.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始密码，可以修改成自己需要的，然后后续在WEBUI上自行修改。</span>
</span></span><span style="display:flex;"><span>harbor_admin_password: <span style="color:#ae81ff">1234567</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 添加禁止用户自注册</span>
</span></span><span style="display:flex;"><span>self_registration: off
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 设置只有管理员可以创建项目</span>
</span></span><span style="display:flex;"><span>project_creation_restriction: adminonly
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The default data volume</span>
</span></span><span style="display:flex;"><span>data_volume: /data/harbor
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行安装命令</span>
</span></span><span style="display:flex;"><span>bash /data/harbor/install.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果对配置文件harbor.yml，需要使用./prepare脚本重新生成</span>
</span></span><span style="display:flex;"><span>./prepare
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启</span>
</span></span><span style="display:flex;"><span>docker-compose restart
</span></span></code></pre></div></li>
<li>
<p>常用命令示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 登录</span>
</span></span><span style="display:flex;"><span>docker login https://harbor.unixsre.com
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拉取</span>
</span></span><span style="display:flex;"><span>docker pull busybox
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 打包</span>
</span></span><span style="display:flex;"><span>docker build -t busybox:v1 . 
</span></span><span style="display:flex;"><span>docker build -t busybox:v1 -f Dockerfile .
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 打TAG</span>
</span></span><span style="display:flex;"><span>docker tag busybox:latest harbor.unixsre.com/ops/busybox:latest
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 上传</span>
</span></span><span style="display:flex;"><span>docker push harbor.unixsre.com/library/busybox:latest
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k3s pull</span>
</span></span><span style="display:flex;"><span>k3s crictl pull harbor.unixsre.com/library/busybox
</span></span></code></pre></div></li>
<li>
<p>备份Harbor使用到的数据库，并且导出用于恢复.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 进入容器备份</span>
</span></span><span style="display:flex;"><span>docker container exec -it harbor-db /bin/bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行pg备份</span>
</span></span><span style="display:flex;"><span>pg_dump -U postgres registry &gt; /tmp/registry.sql 
</span></span><span style="display:flex;"><span>pg_dump -U postgres notarysigner &gt; /tmp/notarysigner.sql  
</span></span><span style="display:flex;"><span>pg_dump -U postgres notaryserver &gt; /tmp/notaryserver.sql
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 复制到本地宿主机</span>
</span></span><span style="display:flex;"><span>docker container cp harbor-db:/tmp/registry.sql /data/harbor/backup_sql/
</span></span><span style="display:flex;"><span>docker container cp harbor-db:/tmp/notarysigner.sql /data/harbor/backup_sql/
</span></span><span style="display:flex;"><span>docker container cp harbor-db:/tmp/notaryserver.sql /data/harbor/backup_sql/
</span></span></code></pre></div></li>
</ol>
<h3 id="安装pg主从集群">安装PG主从集群<a hidden class="anchor" aria-hidden="true" href="#安装pg主从集群">#</a></h3>
<p>PostgreSql主从复制是一种高可用解决方案，可以实现读写分离，实时备份，PG的主从复制是基于xlog来实现的，主库开启日志功能，从库根据主库xlog来完成数据的同步。</p>
<p><strong>PG主从复制注意事项：</strong></p>
<ul>
<li>启动从库之前: 不能执行初始化，若已经初始化了需要删掉对应的目录中的数据文件。</li>
<li>启动从库之前: 需要通过base_backup从主服务器上同步配置与数据。</li>
<li>启动从库之前: 需要对同步之后的配置文件（standby.signal）进行修改。</li>
<li>从库只能读，不能写。</li>
</ul>
<ol>
<li>
<p>分别在每个ECS安装postgresql-13</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 添加PG apt源</span>
</span></span><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#39;echo &#34;deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main&#34; &gt; /etc/apt/sources.list.d/pgdg.list&#39;</span>
</span></span><span style="display:flex;"><span>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更新源</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装PG13</span>
</span></span><span style="display:flex;"><span>apt -y install postgresql-13 postgresql-client-13 postgresql-contrib
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 验证服务是否启动成功</span>
</span></span><span style="display:flex;"><span>systemctl status postgresql@13-main.service
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 登录验证修改密码</span>
</span></span><span style="display:flex;"><span>sudo -i -u postgres psql -p <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>ALTER USER postgres WITH PASSWORD <span style="color:#e6db74">&#39;1234567.com&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 登录验证</span>
</span></span><span style="display:flex;"><span>psql -h localhost -p <span style="color:#ae81ff">5432</span> -U postgres
</span></span></code></pre></div></li>
<li>
<p>创建PG数据目录，分别在每个机器上创建.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#创建数据目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/harbor_nas/pgsql/data <span style="color:#f92672">&amp;&amp;</span> chown postgres:postgres /data/harbor_nas/pgsql/data
</span></span><span style="display:flex;"><span><span style="color:#75715e">#创建归档目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/harbor_nas/pgsql/pg_archive <span style="color:#f92672">&amp;&amp;</span> chown postgres:postgres /data/harbor_nas/pgsql/pg_archive
</span></span><span style="display:flex;"><span><span style="color:#75715e">#给目录赋权</span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">700</span> /data/harbor_nas/pgsql/pg_archive/ <span style="color:#f92672">&amp;&amp;</span> chmod <span style="color:#ae81ff">700</span> /data/harbor_nas/pgsql/data/
</span></span></code></pre></div></li>
<li>
<p>添加systemd启动配置文件中的数据目录环境变量.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim /lib/systemd/system/postgresql@.service
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span>PGDATA<span style="color:#f92672">=</span>/data/harbor_nas/pgsql/data
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重载</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除默认集群</span>
</span></span><span style="display:flex;"><span>pg_dropcluster --stop <span style="color:#ae81ff">13</span> main
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在新目录创建集群</span>
</span></span><span style="display:flex;"><span>pg_createcluster -d /data/harbor_nas/pgsql/data <span style="color:#ae81ff">13</span> main
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl restart postgresql@13-main.service
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置开机启动</span>
</span></span><span style="display:flex;"><span>systemctl enable postgresql@13-main.service
</span></span><span style="display:flex;"><span><span style="color:#75715e">#开启外部访问配置</span>
</span></span><span style="display:flex;"><span>vim /etc/postgresql/13/main/pg_hba.conf
</span></span><span style="display:flex;"><span>local   all             postgres                                peer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;local&#34; is for Unix domain socket connections only</span>
</span></span><span style="display:flex;"><span>local   all             all                                     peer
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPv4 local connections:</span>
</span></span><span style="display:flex;"><span>host    all             all             0.0.0.0/0            md5
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IPv6 local connections:</span>
</span></span><span style="display:flex;"><span>host    all             all             ::1/128                 md5
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Allow replication connections from localhost, by a user with the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># replication privilege.</span>
</span></span><span style="display:flex;"><span>local   replication     all                                     peer
</span></span><span style="display:flex;"><span>host    replication     all             127.0.0.1/32            md5
</span></span><span style="display:flex;"><span>host    replication     all             ::1/128                 md5
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改集群监听地址</span>
</span></span><span style="display:flex;"><span>vim /etc/postgresql/13/main/postgresql.conf
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl restart postgresql@13-main.service
</span></span></code></pre></div></li>
<li>
<p>主服务器配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建具有复制流操作权限的的用户：replica</span>
</span></span><span style="display:flex;"><span>CREATE ROLE replica login replication encrypted password <span style="color:#e6db74">&#39;Deniss_12PRO@@@&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加从服务器免密登录,replica为用户,172.19.48.254X为从节点的内网IP，md5为允许密码验证, trust为免密。</span>
</span></span><span style="display:flex;"><span>vim /etc/postgresql/13/main/pg_hba.conf
</span></span><span style="display:flex;"><span>host    replication    replica 172.19.48.254/20                 trust
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加主服务器postgresql.conf配置</span>
</span></span><span style="display:flex;"><span>vim /etc/postgresql/13/main/postgresql.conf
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span>max_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>archive_mode <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>archive_command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test ! -f /data/harbor_nas/pgsql/pg_archive/%f &amp;&amp; cp %p /data/harbor_nas/pgsql/pg_archive/%f&#39;</span>
</span></span><span style="display:flex;"><span>wal_level <span style="color:#f92672">=</span> replica
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl restart postgresql@13-main.service
</span></span></code></pre></div></li>
<li>
<p>从服务器配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 如果前面已经在从服务器执行过了这个操作，直接可以进入postgres用户家目录清理、复制数据。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#创建数据目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/harbor_nas/pgsql_replica/data <span style="color:#f92672">&amp;&amp;</span> chown postgres:postgres /data/harbor_nas/pgsql_replica/data
</span></span><span style="display:flex;"><span><span style="color:#75715e">#创建归档目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/harbor_nas/pgsql_replica/pg_archive <span style="color:#f92672">&amp;&amp;</span> chown postgres:postgres /data/harbor_nas/pgsql_replica/pg_archive
</span></span><span style="display:flex;"><span><span style="color:#75715e">#给目录赋权</span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">700</span> /data/harbor_nas/pgsql_replica/pg_archive/ <span style="color:#f92672">&amp;&amp;</span> chmod <span style="color:#ae81ff">700</span> /data/harbor_nas/pgsql_replica/data/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加如下配置</span>
</span></span><span style="display:flex;"><span>vim /lib/systemd/system/postgresql@.service
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span>PGDATA<span style="color:#f92672">=</span>/data/harbor_nas/pgsql_replica/data/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重载配置</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span><span style="color:#75715e">#删除默认目录的集群</span>
</span></span><span style="display:flex;"><span>pg_dropcluster --stop <span style="color:#ae81ff">13</span> main
</span></span><span style="display:flex;"><span><span style="color:#75715e">#在新目录创建集群</span>
</span></span><span style="display:flex;"><span>pg_createcluster -d /data/harbor_nas/pgsql_replica/data <span style="color:#ae81ff">13</span> main
</span></span><span style="display:flex;"><span><span style="color:#75715e">#重启服务</span>
</span></span><span style="display:flex;"><span>systemctl restart postgresql@13-main.service
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入postgres用户清理初始化的数据，从主服务器复制数据。</span>
</span></span><span style="display:flex;"><span>su - postgres
</span></span><span style="display:flex;"><span>rm -rf /data/harbor_nas/pgsql_replica/data/*
</span></span><span style="display:flex;"><span>pg_basebackup -h 172.19.48.253 -p <span style="color:#ae81ff">5432</span> -U replica -Fp -Xs -Pv -R -D /data/harbor_nas/pgsql_replica/data
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;standby_mode = &#39;on&#39;&#34;</span> &gt; /data/harbor_nas/pgsql_replica/data/standby.signal
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改从服务器配置</span>
</span></span><span style="display:flex;"><span>vim /etc/postgresql/13/main/postgresql.conf
</span></span><span style="display:flex;"><span>primary_conninfo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;host=172.19.48.253 port=5432 user=replica password=Deniss_12PRO@@@&#39;</span>
</span></span><span style="display:flex;"><span>recovery_target_timeline <span style="color:#f92672">=</span> latest
</span></span><span style="display:flex;"><span>max_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>hot_standby <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>max_standby_streaming_delay <span style="color:#f92672">=</span> 30s
</span></span><span style="display:flex;"><span>wal_receiver_status_interval <span style="color:#f92672">=</span> 10s
</span></span><span style="display:flex;"><span>hot_standby_feedback <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动从节点PG数据库</span>
</span></span><span style="display:flex;"><span>systemctl start postgresql@13-main.service
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 登录主节点数据库查看装</span>
</span></span><span style="display:flex;"><span>psql -h 172.19.48.253 -p <span style="color:#ae81ff">5432</span> -U postgres
</span></span><span style="display:flex;"><span>postgres<span style="color:#f92672">=</span><span style="color:#75715e"># select client_addr,sync_state from pg_stat_replication;</span>
</span></span><span style="display:flex;"><span>  client_addr  | sync_state
</span></span><span style="display:flex;"><span>---------------+------------
</span></span><span style="display:flex;"><span> 172.19.48.254 | async
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 至此，PG主从复制安装完成。</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="配置horbor为pg主节点">配置Horbor为PG主节点<a hidden class="anchor" aria-hidden="true" href="#配置horbor为pg主节点">#</a></h3>
<ol>
<li>
<p>登录主节点创建harbor用户与harbor需要的DB，并且将数据恢复到当前数据.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 新建Harbor用户</span>
</span></span><span style="display:flex;"><span>CREATE USER harbor LOGIN PASSWORD <span style="color:#e6db74">&#39;Deniss1112s&#39;</span>;
</span></span><span style="display:flex;"><span>CREATE SCHEMA harbor;
</span></span><span style="display:flex;"><span>GRANT harbor TO postgres;GRANT USAGE ON SCHEMA harbor TO postgres;
</span></span><span style="display:flex;"><span>ALTER SCHEMA harbor OWNER TO postgres;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建数据库</span>
</span></span><span style="display:flex;"><span>CREATE DATABASE registry OWNER harbor;
</span></span><span style="display:flex;"><span>CREATE DATABASE notarysigner OWNER harbor;
</span></span><span style="display:flex;"><span>CREATE DATABASE notaryserver OWNER harbor;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权</span>
</span></span><span style="display:flex;"><span>GRANT ALL PRIVILEGES ON DATABASE registry TO harbor;
</span></span><span style="display:flex;"><span>GRANT ALL PRIVILEGES ON DATABASE notarysigner TO harbor;
</span></span><span style="display:flex;"><span>GRANT ALL PRIVILEGES ON DATABASE notaryserver TO harbor;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 恢复数据库</span>
</span></span><span style="display:flex;"><span>psql -h localhost -U harbor registry &lt; /data/harbor/backup_sql/registry.sql
</span></span><span style="display:flex;"><span>psql -h localhost -U harbor notarysigner  &lt; /data/harbor/backup_sql/notarysigner.sql
</span></span><span style="display:flex;"><span>psql -h localhost -U harbor notaryserver &lt; /data/harbor/backup_sql/notaryserver.sql
</span></span></code></pre></div></li>
<li>
<p>对2个ECS的harbor.yml进行调整，开启外部PG、Redis配置，注释掉默认PG数据库配置，注意：2个ECS中Harbor链接的配置的必须为同样的Redis与PG数据库。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostname: harbor.unixsre.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http:
</span></span><span style="display:flex;"><span>  port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>https:
</span></span><span style="display:flex;"><span>  port: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>  certificate: /data/harbor/ssl/unixsre.com.cer
</span></span><span style="display:flex;"><span>  private_key: /data/harbor/ssl/unixsre.com.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>harbor_admin_password: <span style="color:#ae81ff">1234567</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data_volume: /data/harbor_nas/harbor_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trivy:
</span></span><span style="display:flex;"><span>  ignore_unfixed: false
</span></span><span style="display:flex;"><span>  skip_update: false
</span></span><span style="display:flex;"><span>  insecure: false
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jobservice:
</span></span><span style="display:flex;"><span>  max_job_workers: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>notification:
</span></span><span style="display:flex;"><span>  webhook_job_max_retry: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chart:
</span></span><span style="display:flex;"><span>  absolute_url: disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log:
</span></span><span style="display:flex;"><span>  level: info
</span></span><span style="display:flex;"><span>  local:
</span></span><span style="display:flex;"><span>    rotate_count: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>    rotate_size: 200M
</span></span><span style="display:flex;"><span>    location: /var/log/harbor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_version: 2.3.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>external_database:
</span></span><span style="display:flex;"><span>  harbor:
</span></span><span style="display:flex;"><span>    host: 172.19.48.253
</span></span><span style="display:flex;"><span>    port: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>    db_name: registry
</span></span><span style="display:flex;"><span>    username: harbor
</span></span><span style="display:flex;"><span>    password: Deniss1112s
</span></span><span style="display:flex;"><span>    ssl_mode: disable
</span></span><span style="display:flex;"><span>    max_idle_conns: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    max_open_conns: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  notary_signer:
</span></span><span style="display:flex;"><span>    host: 172.19.48.253
</span></span><span style="display:flex;"><span>    port: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>    db_name: notarysigner
</span></span><span style="display:flex;"><span>    username: harbor
</span></span><span style="display:flex;"><span>    password: Deniss1112s
</span></span><span style="display:flex;"><span>    ssl_mode: disable
</span></span><span style="display:flex;"><span>  notary_server:
</span></span><span style="display:flex;"><span>    host: 172.19.48.253
</span></span><span style="display:flex;"><span>    port: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>    db_name: notaryserver
</span></span><span style="display:flex;"><span>    username: harbor
</span></span><span style="display:flex;"><span>    password: Deniss1112s
</span></span><span style="display:flex;"><span>    ssl_mode: disable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>external_redis:
</span></span><span style="display:flex;"><span>  host: 172.19.48.253:6379
</span></span><span style="display:flex;"><span>  password: Deniss1589s
</span></span><span style="display:flex;"><span>  registry_db_index: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  jobservice_db_index: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  chartmuseum_db_index: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  trivy_db_index: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  idle_timeout_seconds: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>proxy:
</span></span><span style="display:flex;"><span>  http_proxy:
</span></span><span style="display:flex;"><span>  https_proxy:
</span></span><span style="display:flex;"><span>  no_proxy:
</span></span><span style="display:flex;"><span>  components:
</span></span><span style="display:flex;"><span>    - core
</span></span><span style="display:flex;"><span>    - jobservice
</span></span><span style="display:flex;"><span>    - trivy
</span></span></code></pre></div></li>
<li>
<p>harbor重新生成配置，并且重启容器.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd /data/harbor/
</span></span><span style="display:flex;"><span>./prepare
</span></span><span style="display:flex;"><span>docker-compose down <span style="color:#f92672">&amp;&amp;</span> docker-compose up -d
</span></span></code></pre></div></li>
<li>
<p>在阿里云创建传统SLB，使用TCP四层添加443端口监听。</p>
<p><img loading="lazy" src="/images/%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e9%ab%98%e5%8f%af%e7%94%a8Harbor/660.webp" alt=""  />
</p>
<p><img loading="lazy" src="/images/%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e9%ab%98%e5%8f%af%e7%94%a8Harbor/670.webp" alt=""  />
</p>
</li>
<li>
<p>将域名绑定在新建的SLB上，这个SLB不一定非要是阿里云的，任何云的SLB都可以，比如AWS、微软云、GCP都可以。</p>
</li>
</ol>
<h3 id="pg主从故障切换">PG主从故障切换<a hidden class="anchor" aria-hidden="true" href="#pg主从故障切换">#</a></h3>
<p>假设主库宕机或者主节点宕机，因为我们的Redis在阿里云，而Harbor的镜像数据在阿里云的NFS，要保证服务的可用性，这个时候，只需要快速的将从节点切换为主库，并且修改Harbor的配置文件，重启Harbor的服务下即可。</p>
<p>下面为手动操作，建议调整为脚本执行快速切换。</p>
<ol>
<li>
<p>模拟当前主节点库挂掉,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 停止主数据库的PG服务.</span>
</span></span><span style="display:flex;"><span>service postgresql@13-main stop
</span></span></code></pre></div></li>
<li>
<p>激活备库为主库.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>psql -h 172.19.48.254 -p <span style="color:#ae81ff">5432</span> -U postgres
</span></span><span style="display:flex;"><span>postgres<span style="color:#f92672">=</span><span style="color:#75715e"># select pg_promote(true,60);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 验证是否升级为主库</span>
</span></span><span style="display:flex;"><span>/usr/lib/postgresql/13/bin/pg_controldata -D /data/harbor_nas/pgsql_replica/data/ |grep cluster
</span></span><span style="display:flex;"><span>Database cluster state:               in production
</span></span></code></pre></div></li>
<li>
<p>修改Harbor配置，重启所有Harbor服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/172.19.48.253/172.19.48.254/&#39;</span> 
</span></span><span style="display:flex;"><span>./prepare
</span></span><span style="display:flex;"><span>docker-compose down <span style="color:#f92672">&amp;&amp;</span> docker-compose up -d
</span></span></code></pre></div></li>
<li>
<p>访问域名，验证harbor服务的可用性。</p>
</li>
<li>
<p>快速恢复主节点，将主节点的PG库设置为从库。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改253从库免密配置，可以提前设置好，不需要此处配置了</span>
</span></span><span style="display:flex;"><span>/etc/postgresql/13/main/pg_hba.conf
</span></span><span style="display:flex;"><span>host    replication    replica 172.19.48.253/20                 trust
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 切换用户</span>
</span></span><span style="display:flex;"><span>su - postgres
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理数据</span>
</span></span><span style="display:flex;"><span>rm -rf /data/harbor_nas/pgsql/data/*
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同步254数据到253</span>
</span></span><span style="display:flex;"><span>pg_basebackup -h 172.19.48.254 -p <span style="color:#ae81ff">5432</span> -U replica -Fp -Xs -Pv -R -D /data/harbor_nas/pgsql/data/
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;standby_mode = &#39;on&#39;&#34;</span> &gt; /data/harbor_nas/pgsql/data/standby.signal
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改253配置</span>
</span></span><span style="display:flex;"><span>vim /etc/postgresql/13/main/postgresql.conf
</span></span><span style="display:flex;"><span>primary_conninfo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;host=172.19.48.254 port=5432 user=replica password=Deniss_12PRO@@@&#39;</span>
</span></span><span style="display:flex;"><span>recovery_target_timeline <span style="color:#f92672">=</span> latest
</span></span><span style="display:flex;"><span>max_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>hot_standby <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span>max_standby_streaming_delay <span style="color:#f92672">=</span> 30s
</span></span><span style="display:flex;"><span>wal_receiver_status_interval <span style="color:#f92672">=</span> 10s
</span></span><span style="display:flex;"><span>hot_standby_feedback <span style="color:#f92672">=</span> on
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动253PG服务</span>
</span></span><span style="display:flex;"><span>systemctl start postgresql@13-main.service
</span></span></code></pre></div></li>
<li>
<p>在当前主节点254登录验证集群复制是否正常.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 登录节点验证当前同步是否正常</span>
</span></span><span style="display:flex;"><span>psql -h localhost -p <span style="color:#ae81ff">5432</span> -U postgres
</span></span><span style="display:flex;"><span>postgres<span style="color:#f92672">=</span><span style="color:#75715e"># select client_addr,sync_state from pg_stat_replication;</span>
</span></span><span style="display:flex;"><span>  client_addr  | sync_state
</span></span><span style="display:flex;"><span>---------------+------------
</span></span><span style="display:flex;"><span> 172.19.48.253 | async
</span></span></code></pre></div></li>
<li>
<p>如果想将原来的库基本恢复成主库，只需要清理掉standby.signal文件，在原来的从库上的数据目录中新建standby.signal文件，并且将<code>standby_mode = 'on'</code>配置好，重启PG服务即可。</p>
</li>
</ol>
<h3 id="灾难性故障恢复">灾难性故障恢复<a hidden class="anchor" aria-hidden="true" href="#灾难性故障恢复">#</a></h3>
<p>对于不可抗拒因素是比较极端的情况，任何人都无法预料，包括当前的各种云厂商，我们只把能想到的，能做到的全部做好，我这边已经做了PG数据库的全备上传到了OSS上，Harbor的镜像数据阿里云NFS一份，OSS一份，想要灾难性恢复必须保证如下俩个前提：</p>
<ul>
<li>PG数据库全备可用（注意：必须可以承受丢失全备时间起止到故障时间的数据）。</li>
<li>阿里云NFS或者OSS中的Harbor镜像数据文件可用。</li>
</ul>
<p>恢复步骤：搭建一个单节点PG，全备导入，Harbor中的配置使用单节点PG，Redis本地或者harbor启动的都可以，然后使用docker-compose启动即可，具体操作步骤不在叙述。</p>
<p>但是这样并不是最快的方法，还有没有更好的方案呢？当然有了，使用云服务，一切都交给云，但是就算是云也不可能保证100%的可用性，此处的灾难性故障恢复，仅做抛砖引玉，并不是最终的解决方案，只是给大家提供一个可以展开思考的思路，如果大家有更完美完善的方案，欢迎一起交流。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/harbor/">harbor</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/java-arraylist%E9%9B%86%E5%90%88%E5%AD%A6%E7%94%9F%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">
    <span class="title">« 上一页</span>
    <br>
    <span>Java ArrayList集合&amp;学生管理系统</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/%E8%B6%85%E5%A5%BD%E7%94%A8%E7%9A%84k8s%E4%B8%ADpod%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7kubectl-debug/">
    <span class="title">下一页 »</span>
    <br>
    <span>超好用的k8s中pod诊断工具：kubectl-debug</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
