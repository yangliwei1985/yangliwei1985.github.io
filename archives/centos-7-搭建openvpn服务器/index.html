<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CentOS 7 搭建OpenVPN服务器 | ylw&#39;s blog</title>
<meta name="keywords" content="openvpn" />
<meta name="description" content="OpenVPN的工作原理 在Linux2.4版本以上，操作系统支持一个名为tun的设备，tun设备的驱动程序中包含两个部分，一部分是字符设备驱动，一部分是网卡驱动。网卡的驱动把从TCP/IP协议栈收到的数据包结构skb放于tun设备的读取队列，用户进程通过调用字符设备接口read获得完整的IP数据包，字符驱动read函数的功能是从设备的读取队列读取数据，将核心态的skb传递给用户；反过来字符驱动write函数给用户提供了把用户态的数据写入核心态的接口，write函数把用户数据写入核心空间并穿入TCP/IP协议栈。该设备既能以字符设备的方式被读写，作为系统的虚拟网卡，也具有和物理网卡相同的特点：能够配置IP地址和路由。对虚拟网卡的使用是OpenVPN实现其SSL VPN功能的关键。
OpenVPN服务器一般需要配置一个虚拟IP地址池和一个自用的静态虚拟IP地址（静态地址和地址池必须在同一个子网中），然后为每一个成功建立SSL连接的客户端动态分配一个虚拟IP地址池中未分配的地址。这样，物理网络中的客户端和OpenVPN服务器就连接成一个虚拟网络上的星型结构局域网，OpenVPN服务器成为每个客户端在虚拟网络上的网关。OpenVPN服务器同时提供对客户端虚拟网卡的路由管理。当客户端对OpenVPN服务器后端的应用服务器的任何访问时，数据包都会经过路由流经虚拟网卡，OpenVPN程序在虚拟网卡上截获数据IP报文，然后使用SSL协议将这些IP报文封装起来，再经过物理网卡发送出去。OpenVPN的服务器和客户端在虚拟网卡之上建立起一个虚拟的局域网络，这个虚拟的局域网对系统的用户来说是透明的。
OpenVPN的服务器和客户端支持tcp和udp两种连接方式，只需在服务端和客户端预先定义好使用的连接方式（tcp或udp）和端口号，客户端和服务端在这个连接的基础上进行SSL握手。连接过程包括SSL的握手以及虚拟网络上的管理信息，OpenVPN将虚拟网上的网段、地址、路由发送给客户端。连接成功后，客户端和服务端建立起SSL安全连接，客户端和服务端的数据都流入虚拟网卡做SSL的处理，再在tcp或udp的连接上从物理网卡发送出去
环境说明 192.168.0.10外网 10.4.82.10 内网  系统环境 [root@vpn ~]# cat /etc/redhat-release CentOS Linux release 7.7.1908 (Core) [root@vpn ~]# uname -r 3.10.0-1062.9.1.el7.x86_64  网卡为双网卡 [root@vpn ~]# ifconfig eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500  inet 192.168.0.11 netmask 255.255.255.0 broadcast 192.168.0.255  inet6 fe80::6b5a:9ab8:1bb:5f8d prefixlen 64 scopeid 0x20  ether 00:0c:29:32:b2:36 txqueuelen 1000 (Ethernet)  RX packets 15104 bytes 16993218 (16.2 MiB)  RX errors 0 dropped 0 overruns 0 frame 0  TX packets 8661 bytes 889872 (869.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/centos-7-%E6%90%AD%E5%BB%BAopenvpn%E6%9C%8D%E5%8A%A1%E5%99%A8/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="CentOS 7 搭建OpenVPN服务器" />
<meta property="og:description" content="OpenVPN的工作原理 在Linux2.4版本以上，操作系统支持一个名为tun的设备，tun设备的驱动程序中包含两个部分，一部分是字符设备驱动，一部分是网卡驱动。网卡的驱动把从TCP/IP协议栈收到的数据包结构skb放于tun设备的读取队列，用户进程通过调用字符设备接口read获得完整的IP数据包，字符驱动read函数的功能是从设备的读取队列读取数据，将核心态的skb传递给用户；反过来字符驱动write函数给用户提供了把用户态的数据写入核心态的接口，write函数把用户数据写入核心空间并穿入TCP/IP协议栈。该设备既能以字符设备的方式被读写，作为系统的虚拟网卡，也具有和物理网卡相同的特点：能够配置IP地址和路由。对虚拟网卡的使用是OpenVPN实现其SSL VPN功能的关键。
OpenVPN服务器一般需要配置一个虚拟IP地址池和一个自用的静态虚拟IP地址（静态地址和地址池必须在同一个子网中），然后为每一个成功建立SSL连接的客户端动态分配一个虚拟IP地址池中未分配的地址。这样，物理网络中的客户端和OpenVPN服务器就连接成一个虚拟网络上的星型结构局域网，OpenVPN服务器成为每个客户端在虚拟网络上的网关。OpenVPN服务器同时提供对客户端虚拟网卡的路由管理。当客户端对OpenVPN服务器后端的应用服务器的任何访问时，数据包都会经过路由流经虚拟网卡，OpenVPN程序在虚拟网卡上截获数据IP报文，然后使用SSL协议将这些IP报文封装起来，再经过物理网卡发送出去。OpenVPN的服务器和客户端在虚拟网卡之上建立起一个虚拟的局域网络，这个虚拟的局域网对系统的用户来说是透明的。
OpenVPN的服务器和客户端支持tcp和udp两种连接方式，只需在服务端和客户端预先定义好使用的连接方式（tcp或udp）和端口号，客户端和服务端在这个连接的基础上进行SSL握手。连接过程包括SSL的握手以及虚拟网络上的管理信息，OpenVPN将虚拟网上的网段、地址、路由发送给客户端。连接成功后，客户端和服务端建立起SSL安全连接，客户端和服务端的数据都流入虚拟网卡做SSL的处理，再在tcp或udp的连接上从物理网卡发送出去
环境说明 192.168.0.10外网 10.4.82.10 内网  系统环境 [root@vpn ~]# cat /etc/redhat-release CentOS Linux release 7.7.1908 (Core) [root@vpn ~]# uname -r 3.10.0-1062.9.1.el7.x86_64  网卡为双网卡 [root@vpn ~]# ifconfig eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500  inet 192.168.0.11 netmask 255.255.255.0 broadcast 192.168.0.255  inet6 fe80::6b5a:9ab8:1bb:5f8d prefixlen 64 scopeid 0x20  ether 00:0c:29:32:b2:36 txqueuelen 1000 (Ethernet)  RX packets 15104 bytes 16993218 (16.2 MiB)  RX errors 0 dropped 0 overruns 0 frame 0  TX packets 8661 bytes 889872 (869." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/centos-7-%E6%90%AD%E5%BB%BAopenvpn%E6%9C%8D%E5%8A%A1%E5%99%A8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-05T22:02:39&#43;00:00" />
<meta property="article:modified_time" content="2021-12-05T22:02:39&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CentOS 7 搭建OpenVPN服务器"/>
<meta name="twitter:description" content="OpenVPN的工作原理 在Linux2.4版本以上，操作系统支持一个名为tun的设备，tun设备的驱动程序中包含两个部分，一部分是字符设备驱动，一部分是网卡驱动。网卡的驱动把从TCP/IP协议栈收到的数据包结构skb放于tun设备的读取队列，用户进程通过调用字符设备接口read获得完整的IP数据包，字符驱动read函数的功能是从设备的读取队列读取数据，将核心态的skb传递给用户；反过来字符驱动write函数给用户提供了把用户态的数据写入核心态的接口，write函数把用户数据写入核心空间并穿入TCP/IP协议栈。该设备既能以字符设备的方式被读写，作为系统的虚拟网卡，也具有和物理网卡相同的特点：能够配置IP地址和路由。对虚拟网卡的使用是OpenVPN实现其SSL VPN功能的关键。
OpenVPN服务器一般需要配置一个虚拟IP地址池和一个自用的静态虚拟IP地址（静态地址和地址池必须在同一个子网中），然后为每一个成功建立SSL连接的客户端动态分配一个虚拟IP地址池中未分配的地址。这样，物理网络中的客户端和OpenVPN服务器就连接成一个虚拟网络上的星型结构局域网，OpenVPN服务器成为每个客户端在虚拟网络上的网关。OpenVPN服务器同时提供对客户端虚拟网卡的路由管理。当客户端对OpenVPN服务器后端的应用服务器的任何访问时，数据包都会经过路由流经虚拟网卡，OpenVPN程序在虚拟网卡上截获数据IP报文，然后使用SSL协议将这些IP报文封装起来，再经过物理网卡发送出去。OpenVPN的服务器和客户端在虚拟网卡之上建立起一个虚拟的局域网络，这个虚拟的局域网对系统的用户来说是透明的。
OpenVPN的服务器和客户端支持tcp和udp两种连接方式，只需在服务端和客户端预先定义好使用的连接方式（tcp或udp）和端口号，客户端和服务端在这个连接的基础上进行SSL握手。连接过程包括SSL的握手以及虚拟网络上的管理信息，OpenVPN将虚拟网上的网段、地址、路由发送给客户端。连接成功后，客户端和服务端建立起SSL安全连接，客户端和服务端的数据都流入虚拟网卡做SSL的处理，再在tcp或udp的连接上从物理网卡发送出去
环境说明 192.168.0.10外网 10.4.82.10 内网  系统环境 [root@vpn ~]# cat /etc/redhat-release CentOS Linux release 7.7.1908 (Core) [root@vpn ~]# uname -r 3.10.0-1062.9.1.el7.x86_64  网卡为双网卡 [root@vpn ~]# ifconfig eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500  inet 192.168.0.11 netmask 255.255.255.0 broadcast 192.168.0.255  inet6 fe80::6b5a:9ab8:1bb:5f8d prefixlen 64 scopeid 0x20  ether 00:0c:29:32:b2:36 txqueuelen 1000 (Ethernet)  RX packets 15104 bytes 16993218 (16.2 MiB)  RX errors 0 dropped 0 overruns 0 frame 0  TX packets 8661 bytes 889872 (869."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "CentOS 7 搭建OpenVPN服务器",
      "item": "https://iblog.zone/archives/centos-7-%E6%90%AD%E5%BB%BAopenvpn%E6%9C%8D%E5%8A%A1%E5%99%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CentOS 7 搭建OpenVPN服务器",
  "name": "CentOS 7 搭建OpenVPN服务器",
  "description": "OpenVPN的工作原理 在Linux2.4版本以上，操作系统支持一个名为tun的设备，tun设备的驱动程序中包含两个部分，一部分是字符设备驱动，一部分是网卡驱动。网卡的驱动把从TCP/IP协议栈收到的数据包结构skb放于tun设备的读取队列，用户进程通过调用字符设备接口read获得完整的IP数据包，字符驱动read函数的功能是从设备的读取队列读取数据，将核心态的skb传递给用户；反过来字符驱动write函数给用户提供了把用户态的数据写入核心态的接口，write函数把用户数据写入核心空间并穿入TCP/IP协议栈。该设备既能以字符设备的方式被读写，作为系统的虚拟网卡，也具有和物理网卡相同的特点：能够配置IP地址和路由。对虚拟网卡的使用是OpenVPN实现其SSL VPN功能的关键。\nOpenVPN服务器一般需要配置一个虚拟IP地址池和一个自用的静态虚拟IP地址（静态地址和地址池必须在同一个子网中），然后为每一个成功建立SSL连接的客户端动态分配一个虚拟IP地址池中未分配的地址。这样，物理网络中的客户端和OpenVPN服务器就连接成一个虚拟网络上的星型结构局域网，OpenVPN服务器成为每个客户端在虚拟网络上的网关。OpenVPN服务器同时提供对客户端虚拟网卡的路由管理。当客户端对OpenVPN服务器后端的应用服务器的任何访问时，数据包都会经过路由流经虚拟网卡，OpenVPN程序在虚拟网卡上截获数据IP报文，然后使用SSL协议将这些IP报文封装起来，再经过物理网卡发送出去。OpenVPN的服务器和客户端在虚拟网卡之上建立起一个虚拟的局域网络，这个虚拟的局域网对系统的用户来说是透明的。\nOpenVPN的服务器和客户端支持tcp和udp两种连接方式，只需在服务端和客户端预先定义好使用的连接方式（tcp或udp）和端口号，客户端和服务端在这个连接的基础上进行SSL握手。连接过程包括SSL的握手以及虚拟网络上的管理信息，OpenVPN将虚拟网上的网段、地址、路由发送给客户端。连接成功后，客户端和服务端建立起SSL安全连接，客户端和服务端的数据都流入虚拟网卡做SSL的处理，再在tcp或udp的连接上从物理网卡发送出去\n环境说明 192.168.0.10外网 10.4.82.10 内网  系统环境 [root@vpn ~]# cat /etc/redhat-release CentOS Linux release 7.7.1908 (Core) [root@vpn ~]# uname -r 3.10.0-1062.9.1.el7.x86_64  网卡为双网卡 [root@vpn ~]# ifconfig eth0: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500  inet 192.168.0.11 netmask 255.255.255.0 broadcast 192.168.0.255  inet6 fe80::6b5a:9ab8:1bb:5f8d prefixlen 64 scopeid 0x20  ether 00:0c:29:32:b2:36 txqueuelen 1000 (Ethernet)  RX packets 15104 bytes 16993218 (16.2 MiB)  RX errors 0 dropped 0 overruns 0 frame 0  TX packets 8661 bytes 889872 (869.",
  "keywords": [
    "openvpn"
  ],
  "articleBody": "OpenVPN的工作原理 在Linux2.4版本以上，操作系统支持一个名为tun的设备，tun设备的驱动程序中包含两个部分，一部分是字符设备驱动，一部分是网卡驱动。网卡的驱动把从TCP/IP协议栈收到的数据包结构skb放于tun设备的读取队列，用户进程通过调用字符设备接口read获得完整的IP数据包，字符驱动read函数的功能是从设备的读取队列读取数据，将核心态的skb传递给用户；反过来字符驱动write函数给用户提供了把用户态的数据写入核心态的接口，write函数把用户数据写入核心空间并穿入TCP/IP协议栈。该设备既能以字符设备的方式被读写，作为系统的虚拟网卡，也具有和物理网卡相同的特点：能够配置IP地址和路由。对虚拟网卡的使用是OpenVPN实现其SSL VPN功能的关键。\nOpenVPN服务器一般需要配置一个虚拟IP地址池和一个自用的静态虚拟IP地址（静态地址和地址池必须在同一个子网中），然后为每一个成功建立SSL连接的客户端动态分配一个虚拟IP地址池中未分配的地址。这样，物理网络中的客户端和OpenVPN服务器就连接成一个虚拟网络上的星型结构局域网，OpenVPN服务器成为每个客户端在虚拟网络上的网关。OpenVPN服务器同时提供对客户端虚拟网卡的路由管理。当客户端对OpenVPN服务器后端的应用服务器的任何访问时，数据包都会经过路由流经虚拟网卡，OpenVPN程序在虚拟网卡上截获数据IP报文，然后使用SSL协议将这些IP报文封装起来，再经过物理网卡发送出去。OpenVPN的服务器和客户端在虚拟网卡之上建立起一个虚拟的局域网络，这个虚拟的局域网对系统的用户来说是透明的。\nOpenVPN的服务器和客户端支持tcp和udp两种连接方式，只需在服务端和客户端预先定义好使用的连接方式（tcp或udp）和端口号，客户端和服务端在这个连接的基础上进行SSL握手。连接过程包括SSL的握手以及虚拟网络上的管理信息，OpenVPN将虚拟网上的网段、地址、路由发送给客户端。连接成功后，客户端和服务端建立起SSL安全连接，客户端和服务端的数据都流入虚拟网卡做SSL的处理，再在tcp或udp的连接上从物理网卡发送出去\n环境说明 192.168.0.10外网 10.4.82.10 内网  系统环境 [root@vpn ~]# cat /etc/redhat-release CentOS Linux release 7.7.1908 (Core) [root@vpn ~]# uname -r 3.10.0-1062.9.1.el7.x86_64  网卡为双网卡 [root@vpn ~]# ifconfig eth0: flags=4163 mtu 1500  inet 192.168.0.11 netmask 255.255.255.0 broadcast 192.168.0.255  inet6 fe80::6b5a:9ab8:1bb:5f8d prefixlen 64 scopeid 0x20  ether 00:0c:29:32:b2:36 txqueuelen 1000 (Ethernet)  RX packets 15104 bytes 16993218 (16.2 MiB)  RX errors 0 dropped 0 overruns 0 frame 0  TX packets 8661 bytes 889872 (869.0 KiB)  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0  eth1: flags=4163 mtu 1500  inet 10.4.82.11 netmask 255.255.255.0 broadcast 10.4.82.255  inet6 fe80::20c:29ff:fe32:b240 prefixlen 64 scopeid 0x20  ether 00:0c:29:32:b2:40 txqueuelen 1000 (Ethernet)  RX packets 202 bytes 18735 (18.2 KiB)  RX errors 0 dropped 0 overruns 0 frame 0  TX packets 8 bytes 656 (656.0 B)  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 首先我们先使用easy-rsa制作openVPN证书\n下载并解压easy-rsa软件包\nmkdir /data/tools -p wget -P /data/tools http://down.i4t.com/easy-rsa.zip unzip -d /usr/local /data/tools/easy-rsa.zip 在开始制作CA证书之前，我们还需要编辑vars文件，修改如下相关选项\ncd /usr/local/easy-rsa-old-master/easy-rsa/2.0/  vim vars export KEY_COUNTRY=\"cn\" export KEY_PROVINCE=\"BJ\" export KEY_CITY=\"BJ\" export KEY_ORG=\"abcdocker\" export KEY_EMAIL=\"cyh@i4t.com\" export KEY_CN=abc export KEY_NAME=abc export KEY_OU=abc  #行数大约67行开始,主要是修改默认的注册信息，比如注册公司、公司名称、部门、国家城市等  注意：以上内容，我们也可以使用系统默认的，也就是说不进行修改也是可以使用的\n 然后使用使环境变量生效\n#初始化环境边看 source vars ./clean-all  #注意：执行clean-all命令会在当前目录下创建一个名词为keys的目录 接下来开始正式制作CA证书，命令如下\n./build-ca  # 生成根证书ca.crt和根密钥ca.key #因为在vars中填写了证书的基本信息，所以这里一路回车即可 这时我们可以查看keys目录，已经帮我们生成ca.crt和ca.key两个文件，其中ca.crt就是我们的证书文件\n[root@abc01 2.0]# ls keys ca.crt ca.key index.txt serial  制作Server端证书 为服务端生成证书和密钥\n#一直回车，2个Y  [root@abc01 2.0]# ./build-key-server server .... An optional company name []: Using configuration from /usr/local/easy-rsa-old-master/easy-rsa/2.0/openssl-1.0.0.cnf Check that the request matches the signature Signature ok The Subject's Distinguished Name is as follows countryName :PRINTABLE:'cn' stateOrProvinceName :PRINTABLE:'BJ' localityName :PRINTABLE:'BJ' organizationName :PRINTABLE:'abcdocker' organizationalUnitName:PRINTABLE:'abc' commonName :PRINTABLE:'abc' name :PRINTABLE:'abc' emailAddress :IA5STRING:'cyh@i4t.com' Certificate is to be certified until Jan 31 14:01:35 2030 GMT (3650 days) Sign the certificate? [y/n]:y   1 out of 1 certificate requests certified, commit? [y/n]y Write out database with 1 new entries Data Base Updated  #这里的server就是我们server端的证书 查看新生成的证书\n[root@abc01 2.0]# ls keys 01.pem abc.key index.txt serial server.crt ca.crt index.txt.attr serial.old server.csr ca.key index.txt.old 这里我们已经生成了server.crt、server.key、server.csr三个文件，其中server.crt和server.key两个文件是我们需要使用的\n 制作Client端证书 这里我们创建2个用户，分别为client1和client2\n#每一个登陆的VPN客户端需要有一个证书，每个证书在同一时刻只能供一个客户端连接，下面建立2份 #为客户端生成证书和密钥（一路按回车，直到提示需要输入y/n时，输入y再按回车，一共两次） ./build-key client1 ./build-key client2 每一个登陆的VPN客户端需要有一个证书，每个证书在同一时刻只可以一个客户端连接(可以修改配置文件)\n现在为服务器生成加密交换时的Diffie-Hellman文件\n./build-dh # 创建迪菲·赫尔曼密钥，会生成dh2048.pem文件（生成过程比较慢，在此期间不要去中断它）  证书生成完毕\n[root@abc01 2.0]# ll keys total 84 -rw-r--r-- 1 root root 7997 Feb 3 09:01 01.pem -rw-r--r-- 1 root root 7880 Feb 3 09:09 02.pem -rw-r--r-- 1 root root 7997 Feb 3 09:01 abc.crt -rw-r--r-- 1 root root 1765 Feb 3 09:01 abc.csr -rw------- 1 root root 3272 Feb 3 09:01 abc.key -rw-r--r-- 1 root root 2293 Feb 3 09:01 ca.crt -rw------- 1 root root 3272 Feb 3 09:01 ca.key -rw-r--r-- 1 root root 424 Feb 3 09:06 dh2048.pem -rw-r--r-- 1 root root 211 Feb 3 09:09 index.txt -rw-r--r-- 1 root root 21 Feb 3 09:09 index.txt.attr -rw-r--r-- 1 root root 21 Feb 3 09:01 index.txt.attr.old -rw-r--r-- 1 root root 105 Feb 3 09:01 index.txt.old -rw-r--r-- 1 root root 3 Feb 3 09:09 serial -rw-r--r-- 1 root root 3 Feb 3 09:01 serial.old -rw-r--r-- 1 root root 7880 Feb 3 09:09 test.crt -rw-r--r-- 1 root root 1765 Feb 3 09:09 test.csr -rw------- 1 root root 3272 Feb 3 09:09 test.key 其中包含了一个test用户和abc用户的证书\n 其中只有*.crt和*.key文件是我们需要使用的\n  安装OpenVPN 安装vpn的方法有2种，一种是使用yum安装，另外一种是编译安装。这两个我们选择一个就可以\n编译安装\n#安装依赖包 curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo yum makecache yum install -y lzo lzo-devel openssl openssl-devel pam pam-devel net-tools git lz4-devel   #下载openVPN软件包 wget -P /data/tools http://down.i4t.com/openvpn-2.4.7.tar.gz cd /data/tools  #安装openVPN tar zxf openvpn-2.4.7.tar.gz cd openvpn-2.4.7 ./configure --prefix=/usr/local/openvpn-2.4.7 make make install  # 创建软连接 ln -s /usr/local/openvpn-2.4.7 /usr/local/openvpn yum安装\nOpenVPN需要安装EPEL\ncurl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo yum clean all \u0026\u0026 yum makecache yum 安装openVPN\nyum install -y openvpn  配置OpenVPN服务端 我们需要创建openVPN文件目录和证书目录\n# openVPN配置文件目录，yum安装默认存在 mkdir /etc/openvpn  #openvpn证书目录 mkdir /etc/openvpn/keys 生成tls-auth key并将其拷贝到证书目录中（防DDos攻击、UDP淹没等恶意攻击）\n#编译安装执行此句 /usr/local/openvpn/sbin/openvpn --genkey --secret ta.key  # yum安装执行此句 openvpn --genkey --secret ta.key  #将本地的ta.key移动到openVPN证书目录 mv ./ta.key /etc/openvpn/keys/ 将我们上面生成的CA证书和服务端证书拷贝到证书目录中\n$ cp /usr/local/easy-rsa-old-master/easy-rsa/2.0/keys/{server.crt,server.key,ca.crt,dh2048.pem} /etc/openvpn/keys/  [root@k8s-01 ~]# ll /etc/openvpn/keys/ total 24 -rw-r--r-- 1 root root 2342 Feb 3 12:48 ca.crt -rw-r--r-- 1 root root 424 Feb 3 12:48 dh2048.pem -rw-r--r-- 1 root root 8089 Feb 3 12:48 server.crt -rw------- 1 root root 3272 Feb 3 12:48 server.key -rw------- 1 root root 636 Feb 3 12:47 ta.key   #abc和test为我们client端用户的证书 拷贝OpenVPN配置文件\n# 编译安装 cp /data/tools/openvpn-2.4.7/sample/sample-config-files/server.conf /etc/openvpn/  # yum安装 cp /usr/share/doc/openvpn-2.4.7/sample/sample-config-files/server.conf /etc/openvpn/ 接下来我们来配置服务端的配置文件\n$ cat /etc/openvpn/server.conf port 1194 #openVPN端口 proto tcp #tcp连接 dev tun #生成tun0虚拟网卡  ca keys/ca.crt #相关证书配置路径(可以修改为全路径/etc/openvpn/keys) cert keys/server.crt key keys/server.key # This file should be kept secret dh keys/dh2048.pem  server 10.4.82.0 255.255.255.0 #默认虚拟局域网网段，不要和实际的局域网冲突就可以 ifconfig-pool-persist ipp.txt  push \"route 10.4.82.0 255.255.255.0\" #可以通过iptables进行路由的转发 push \"route 172.17.88.0 255.255.255.0\" #vpn机器内网 push \"route 172.17.65.0 255.255.255.0\" #目的网段内网  client-to-client #如果客户端都是用一个证书和密钥连接VPN，需要打开这个选项 duplicate-cn keepalive 10 120 tls-auth keys/ta.key 0 # This file is secret comp-lzo  persist-key persist-tun  status openvpn-status.log #状态日志路径 log-append openvpn.log #运行日志 verb 3 #调试信息级别    #如果需要接入ldap，需要在server.conf下添加如下2行 plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so \"/etc/openvpn/auth/ldap.conf cn=%u\" client-cert-not-required  #如何环境和我相同，可以直接cp我的配置文件 开启内核路由转发功能\necho \"net.ipv4.ip_forward = 1\" /etc/sysctl.conf sysctl -p 如果有iptables可以开启iptables策略\niptables -P FORWARD ACCEPT iptables -I INPUT -p tcp --dport 1194 -m comment --comment \"openvpn\" -j ACCEPT iptables -t nat -A POSTROUTING -s 10.4.82.0/24 -j MASQUERADE 启动openvpn服务\n$ cd /etc/openvpn/ $ /usr/local/openvpn/sbin/openvpn --daemon --config /etc/openvpn/server.conf 检查服务\n$ netstat -lntup|grep 1194 tcp 0 0 0.0.0.0:1194 0.0.0.0:* LISTEN 48091/openvpn 设置开机启动\necho \"/usr/local/openvpn/sbin/openvpn --daemon --config /etc/openvpn/server.conf  /dev/null 2\u00261 \u0026\"  /etc/rc.local  客户端连接测试 无论我们是在Windows还是Linux OS上Client端的配置，都需要将Client证书、CA证书以及Client配置文件下载下来\n现在我们需要先配置一下client.conf\ncp /data/tools/openvpn-2.4.7/sample/sample-config-files/client.conf /root/  #修改如下，并将client.conf修改为client.ovpn $ cat /root/client.conf client dev tun proto tcp remote 192.168.0.10 1194 #openvpn服务器的外网IP和端口(可以写多个做到高可用) resolv-retry infinite nobind persist-key persist-tun ca ca.crt cert client1.crt #用户的证书 key client1.key  tls-auth ta.key 1 cipher AES-256-CBC comp-lzo verb 3   #比较重点的就是修改remote 地址，这里的地址为server cert key，我们这里使用用户的证书，所以证书也应当修改为client1.crt和client1.key tls-auth 因为使用加密协议，所以ta.key也需要下载下来 修改后缀并导出\n[root@vpn ~]# mv client.conf client.ovpn [root@vpn ~]# sz client.ovpn  #同时还需要导出几个证书 mv client.conf client.ovpn sz /root/client.ovpn sz /etc/openvpn/keys/ca.crt sz /etc/openvpn/keys/ta.key sz /usr/local/easy-rsa-old-master/easy-rsa/2.0/keys/client1.crt sz /usr/local/easy-rsa-old-master/easy-rsa/2.0/keys/client1.key 添加用户\n以后我们如果想添加用户只需要到cd /usr/local/easy-rsa-old-master/easy-rsa/2.0目录下执行./build-key 用户名，在将keys目录下生成的用户名.crt和key导出，修改一下client.ovpn的用户key名称即可\n Windows\n客户端需要证书如下\nWindows客户端下载\nhttp://down.i4t.com/openvpn-install-2.4.7-I606-Win10.exe\nhttp://down.i4t.com/openvpn-install-2.4.7-I606-Win7.exe\n 打开浏览器即可下载\n 安装步骤，直接C盘就可以了，文件很小~\n疯狂下一步即可\n安装完成后\n接下来我们需要替换一下证书\n点击桌面的logo，右击属性\n点击打开文件位置\n点击上方OpenVPN从新选择目录\n选择config目录\n将config目录下文件全部删除\n然后将我们导出的5个证书复制过去\n 其中client1.*为client1用户的证书\n 现在我们进行启动openvpn客户端，进行连接\n双击桌面OpenVPN 右击图标，选择连接\n这里可以看到已经连接成功\nMac\n复制链接到浏览器，下载软件包\nhttp://down.i4t.com/Tunnelblick_3.8.1_build_5400.dmg\n我们直接点开client.ovpn就可以自动链接\n成功后会有下面的流量图\n配置文件打开方式\n这时候网络已经通了\n配置完成后，可能路由存在问题，可以尝试添加下面的iptables规则\niptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 172.17.88.56 iptables -I INPUT -p tcp --dport 1194 -j ACCEPT iptables -I FORWARD -s 10.8.0.0/24 -j ACCEPT iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -t nat -D POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 172.17.88.56 iptables -D INPUT -p tcp --dport 1194 -j ACCEPT iptables -D FORWARD -s 10.8.0.0/24 -j ACCEPT iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT ",
  "wordCount" : "965",
  "inLanguage": "zh",
  "datePublished": "2021-12-05T22:02:39Z",
  "dateModified": "2021-12-05T22:02:39Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/centos-7-%E6%90%AD%E5%BB%BAopenvpn%E6%9C%8D%E5%8A%A1%E5%99%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      CentOS 7 搭建OpenVPN服务器
    </h1>
    <div class="post-meta"><span title='2021-12-05 22:02:39 +0000 UTC'>2021-12-05</span>&nbsp;·&nbsp;5 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul><ul>
                    <li>
                        <a href="#openvpn%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="OpenVPN的工作原理">OpenVPN的工作原理</a></li>
                    <li>
                        <a href="#%e7%8e%af%e5%a2%83%e8%af%b4%e6%98%8e" aria-label="环境说明">环境说明</a></li>
                    <li>
                        <a href="#%e5%88%b6%e4%bd%9cserver%e7%ab%af%e8%af%81%e4%b9%a6" aria-label="制作Server端证书">制作Server端证书</a></li>
                    <li>
                        <a href="#%e5%88%b6%e4%bd%9cclient%e7%ab%af%e8%af%81%e4%b9%a6" aria-label="制作Client端证书">制作Client端证书</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85openvpn" aria-label="安装OpenVPN">安装OpenVPN</a></li></ul>
                        
                    <li>
                        <a href="#%e9%85%8d%e7%bd%aeopenvpn%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="配置OpenVPN服务端">配置OpenVPN服务端</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e8%bf%9e%e6%8e%a5%e6%b5%8b%e8%af%95" aria-label="客户端连接测试">客户端连接测试</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="openvpn的工作原理">OpenVPN的工作原理<a hidden class="anchor" aria-hidden="true" href="#openvpn的工作原理">#</a></h3>
<p>在Linux2.4版本以上，操作系统支持一个名为tun的设备，tun设备的驱动程序中包含两个部分，一部分是字符设备驱动，一部分是网卡驱动。网卡的驱动把从TCP/IP协议栈收到的数据包结构skb放于tun设备的读取队列，用户进程通过调用字符设备接口read获得完整的IP数据包，字符驱动read函数的功能是从设备的读取队列读取数据，将核心态的skb传递给用户；反过来字符驱动write函数给用户提供了把用户态的数据写入核心态的接口，write函数把用户数据写入核心空间并穿入TCP/IP协议栈。该设备既能以字符设备的方式被读写，作为系统的虚拟网卡，也具有和物理网卡相同的特点：能够配置IP地址和路由。对虚拟网卡的使用是OpenVPN实现其SSL VPN功能的关键。</p>
<p>OpenVPN服务器一般需要配置一个虚拟IP地址池和一个自用的静态虚拟IP地址（静态地址和地址池必须在同一个子网中），然后为每一个成功建立SSL连接的客户端动态分配一个虚拟IP地址池中未分配的地址。这样，物理网络中的客户端和OpenVPN服务器就连接成一个虚拟网络上的星型结构局域网，OpenVPN服务器成为每个客户端在虚拟网络上的网关。OpenVPN服务器同时提供对客户端虚拟网卡的路由管理。当客户端对OpenVPN服务器后端的应用服务器的任何访问时，数据包都会经过路由流经虚拟网卡，OpenVPN程序在虚拟网卡上截获数据IP报文，然后使用SSL协议将这些IP报文封装起来，再经过物理网卡发送出去。OpenVPN的服务器和客户端在虚拟网卡之上建立起一个虚拟的局域网络，这个虚拟的局域网对系统的用户来说是透明的。</p>
<p>OpenVPN的服务器和客户端支持tcp和udp两种连接方式，只需在服务端和客户端预先定义好使用的连接方式（tcp或udp）和端口号，客户端和服务端在这个连接的基础上进行SSL握手。连接过程包括SSL的握手以及虚拟网络上的管理信息，OpenVPN将虚拟网上的网段、地址、路由发送给客户端。连接成功后，客户端和服务端建立起SSL安全连接，客户端和服务端的数据都流入虚拟网卡做SSL的处理，再在tcp或udp的连接上从物理网卡发送出去</p>
<h3 id="环境说明">环境说明<a hidden class="anchor" aria-hidden="true" href="#环境说明">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>192.168.0.10外网     10.4.82.10 内网
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>系统环境
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vpn ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /etc/redhat-release</span>
</span></span><span style="display:flex;"><span>CentOS Linux release 7.7.1908 <span style="color:#f92672">(</span>Core<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vpn ~<span style="color:#f92672">]</span><span style="color:#75715e"># uname -r</span>
</span></span><span style="display:flex;"><span>3.10.0-1062.9.1.el7.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>网卡为双网卡
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vpn ~<span style="color:#f92672">]</span><span style="color:#75715e"># ifconfig</span>
</span></span><span style="display:flex;"><span>eth0: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 192.168.0.11  netmask 255.255.255.0  broadcast 192.168.0.255
</span></span><span style="display:flex;"><span>        inet6 fe80::6b5a:9ab8:1bb:5f8d  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20
</span></span><span style="display:flex;"><span>        ether 00:0c:29:32:b2:36  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">15104</span>  bytes <span style="color:#ae81ff">16993218</span> <span style="color:#f92672">(</span>16.2 MiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">8661</span>  bytes <span style="color:#ae81ff">889872</span> <span style="color:#f92672">(</span>869.0 KiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eth1: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.4.82.11  netmask 255.255.255.0  broadcast 10.4.82.255
</span></span><span style="display:flex;"><span>        inet6 fe80::20c:29ff:fe32:b240  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20
</span></span><span style="display:flex;"><span>        ether 00:0c:29:32:b2:40  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">202</span>  bytes <span style="color:#ae81ff">18735</span> <span style="color:#f92672">(</span>18.2 KiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">8</span>  bytes <span style="color:#ae81ff">656</span> <span style="color:#f92672">(</span>656.0 B<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>首先我们先使用<code>easy-rsa</code>制作openVPN证书</p>
<p>下载并解压<code>easy-rsa</code>软件包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /data/tools -p
</span></span><span style="display:flex;"><span>wget -P /data/tools http://down.i4t.com/easy-rsa.zip
</span></span><span style="display:flex;"><span>unzip -d /usr/local /data/tools/easy-rsa.zip
</span></span></code></pre></div><p>在开始制作CA证书之前，我们还需要编辑vars文件，修改如下相关选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd /usr/local/easy-rsa-old-master/easy-rsa/2.0/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vim vars
</span></span><span style="display:flex;"><span>export KEY_COUNTRY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cn&#34;</span>
</span></span><span style="display:flex;"><span>export KEY_PROVINCE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;BJ&#34;</span>
</span></span><span style="display:flex;"><span>export KEY_CITY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;BJ&#34;</span>
</span></span><span style="display:flex;"><span>export KEY_ORG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;abcdocker&#34;</span>
</span></span><span style="display:flex;"><span>export KEY_EMAIL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cyh@i4t.com&#34;</span>
</span></span><span style="display:flex;"><span>export KEY_CN<span style="color:#f92672">=</span>abc
</span></span><span style="display:flex;"><span>export KEY_NAME<span style="color:#f92672">=</span>abc
</span></span><span style="display:flex;"><span>export KEY_OU<span style="color:#f92672">=</span>abc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#行数大约67行开始,主要是修改默认的注册信息，比如注册公司、公司名称、部门、国家城市等</span>
</span></span></code></pre></div><blockquote>
<p>注意：以上内容，我们也可以使用系统默认的，也就是说不进行修改也是可以使用的</p>
</blockquote>
<p>然后使用使环境变量生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#初始化环境边看</span>
</span></span><span style="display:flex;"><span>source vars
</span></span><span style="display:flex;"><span>./clean-all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#注意：执行clean-all命令会在当前目录下创建一个名词为keys的目录</span>
</span></span></code></pre></div><p>接下来开始正式制作CA证书，命令如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./build-ca
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成根证书ca.crt和根密钥ca.key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#因为在vars中填写了证书的基本信息，所以这里一路回车即可</span>
</span></span></code></pre></div><p>这时我们可以查看keys目录，已经帮我们生成ca.crt和ca.key两个文件，其中ca.crt就是我们的证书文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@abc01 2.0<span style="color:#f92672">]</span><span style="color:#75715e"># ls keys</span>
</span></span><span style="display:flex;"><span>ca.crt  ca.key  index.txt  serial
</span></span></code></pre></div><hr>
<h3 id="制作server端证书">制作Server端证书<a hidden class="anchor" aria-hidden="true" href="#制作server端证书">#</a></h3>
<p>为服务端生成证书和密钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#一直回车，2个Y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@abc01 2.0<span style="color:#f92672">]</span><span style="color:#75715e"># ./build-key-server server</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>An optional company name <span style="color:#f92672">[]</span>:
</span></span><span style="display:flex;"><span>Using configuration from /usr/local/easy-rsa-old-master/easy-rsa/2.0/openssl-1.0.0.cnf
</span></span><span style="display:flex;"><span>Check that the request matches the signature
</span></span><span style="display:flex;"><span>Signature ok
</span></span><span style="display:flex;"><span>The Subject<span style="color:#e6db74">&#39;s Distinguished Name is as follows
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">countryName           :PRINTABLE:&#39;</span>cn<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">stateOrProvinceName   :PRINTABLE:&#39;</span>BJ<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">localityName          :PRINTABLE:&#39;</span>BJ<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationName      :PRINTABLE:&#39;</span>abcdocker<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">organizationalUnitName:PRINTABLE:&#39;</span>abc<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">commonName            :PRINTABLE:&#39;</span>abc<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name                  :PRINTABLE:&#39;</span>abc<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">emailAddress          :IA5STRING:&#39;</span>cyh@i4t.com<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>Certificate is to be certified <span style="color:#66d9ef">until</span> Jan <span style="color:#ae81ff">31</span> 14:01:35 <span style="color:#ae81ff">2030</span> GMT <span style="color:#f92672">(</span><span style="color:#ae81ff">3650</span> days<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Sign the certificate? <span style="color:#f92672">[</span>y/n<span style="color:#f92672">]</span>:y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> certificate requests certified, commit? <span style="color:#f92672">[</span>y/n<span style="color:#f92672">]</span>y
</span></span><span style="display:flex;"><span>Write out database with <span style="color:#ae81ff">1</span> new entries
</span></span><span style="display:flex;"><span>Data Base Updated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#这里的server就是我们server端的证书</span>
</span></span></code></pre></div><p>查看新生成的证书</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@abc01 2.0<span style="color:#f92672">]</span><span style="color:#75715e"># ls keys</span>
</span></span><span style="display:flex;"><span>01.pem   abc.key  index.txt       serial
</span></span><span style="display:flex;"><span>server.crt  ca.crt   index.txt.attr  serial.old
</span></span><span style="display:flex;"><span>server.csr  ca.key   index.txt.old
</span></span></code></pre></div><p>这里我们已经生成了server.crt、server.key、server.csr三个文件，其中server.crt和server.key两个文件是我们需要使用的</p>
<hr>
<h3 id="制作client端证书">制作Client端证书<a hidden class="anchor" aria-hidden="true" href="#制作client端证书">#</a></h3>
<p>这里我们创建2个用户，分别为client1和client2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#每一个登陆的VPN客户端需要有一个证书，每个证书在同一时刻只能供一个客户端连接，下面建立2份</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#为客户端生成证书和密钥（一路按回车，直到提示需要输入y/n时，输入y再按回车，一共两次）</span>
</span></span><span style="display:flex;"><span>./build-key client1
</span></span><span style="display:flex;"><span>./build-key client2
</span></span></code></pre></div><p>每一个登陆的VPN客户端需要有一个证书，每个证书在同一时刻只可以一个客户端连接(可以修改配置文件)</p>
<p>现在为服务器生成加密交换时的Diffie-Hellman文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./build-dh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建迪菲·赫尔曼密钥，会生成dh2048.pem文件（生成过程比较慢，在此期间不要去中断它）</span>
</span></span></code></pre></div><hr>
<p>证书生成完毕</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@abc01 2.0<span style="color:#f92672">]</span><span style="color:#75715e"># ll keys</span>
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">84</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">7997</span> Feb  <span style="color:#ae81ff">3</span> 09:01 01.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">7880</span> Feb  <span style="color:#ae81ff">3</span> 09:09 02.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">7997</span> Feb  <span style="color:#ae81ff">3</span> 09:01 abc.crt
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1765</span> Feb  <span style="color:#ae81ff">3</span> 09:01 abc.csr
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3272</span> Feb  <span style="color:#ae81ff">3</span> 09:01 abc.key
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">2293</span> Feb  <span style="color:#ae81ff">3</span> 09:01 ca.crt
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3272</span> Feb  <span style="color:#ae81ff">3</span> 09:01 ca.key
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">424</span> Feb  <span style="color:#ae81ff">3</span> 09:06 dh2048.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">211</span> Feb  <span style="color:#ae81ff">3</span> 09:09 index.txt
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">21</span> Feb  <span style="color:#ae81ff">3</span> 09:09 index.txt.attr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">21</span> Feb  <span style="color:#ae81ff">3</span> 09:01 index.txt.attr.old
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">105</span> Feb  <span style="color:#ae81ff">3</span> 09:01 index.txt.old
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">3</span> Feb  <span style="color:#ae81ff">3</span> 09:09 serial
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">3</span> Feb  <span style="color:#ae81ff">3</span> 09:01 serial.old
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">7880</span> Feb  <span style="color:#ae81ff">3</span> 09:09 test.crt
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1765</span> Feb  <span style="color:#ae81ff">3</span> 09:09 test.csr
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3272</span> Feb  <span style="color:#ae81ff">3</span> 09:09 test.key
</span></span></code></pre></div><p>其中包含了一个test用户和abc用户的证书</p>
<blockquote>
<p>其中只有*.crt和*.key文件是我们需要使用的</p>
</blockquote>
<hr>
<h3 id="安装openvpn">安装OpenVPN<a hidden class="anchor" aria-hidden="true" href="#安装openvpn">#</a></h3>
<p>安装vpn的方法有2种，一种是使用yum安装，另外一种是编译安装。<strong>这两个我们选择一个就可以</strong></p>
<p><strong>编译安装</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#安装依赖包</span>
</span></span><span style="display:flex;"><span>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>yum makecache
</span></span><span style="display:flex;"><span>yum install -y lzo lzo-devel openssl openssl-devel pam pam-devel net-tools git lz4-devel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#下载openVPN软件包</span>
</span></span><span style="display:flex;"><span>wget -P /data/tools http://down.i4t.com/openvpn-2.4.7.tar.gz
</span></span><span style="display:flex;"><span>cd /data/tools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#安装openVPN</span>
</span></span><span style="display:flex;"><span>tar zxf openvpn-2.4.7.tar.gz
</span></span><span style="display:flex;"><span>cd openvpn-2.4.7
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#f92672">=</span>/usr/local/openvpn-2.4.7
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建软连接</span>
</span></span><span style="display:flex;"><span>ln -s /usr/local/openvpn-2.4.7 /usr/local/openvpn
</span></span></code></pre></div><p><strong>yum安装</strong></p>
<p>OpenVPN需要安装EPEL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span style="display:flex;"><span>yum clean all <span style="color:#f92672">&amp;&amp;</span> yum makecache
</span></span></code></pre></div><p>yum 安装openVPN</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install -y openvpn
</span></span></code></pre></div><hr>
<h2 id="配置openvpn服务端">配置OpenVPN服务端<a hidden class="anchor" aria-hidden="true" href="#配置openvpn服务端">#</a></h2>
<p>我们需要创建openVPN文件目录和证书目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># openVPN配置文件目录，yum安装默认存在</span>
</span></span><span style="display:flex;"><span>mkdir /etc/openvpn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#openvpn证书目录</span>
</span></span><span style="display:flex;"><span>mkdir /etc/openvpn/keys
</span></span></code></pre></div><p>生成<code>tls-auth key</code>并将其拷贝到证书目录中（防DDos攻击、UDP淹没等恶意攻击）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#编译安装执行此句</span>
</span></span><span style="display:flex;"><span>/usr/local/openvpn/sbin/openvpn --genkey --secret ta.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># yum安装执行此句</span>
</span></span><span style="display:flex;"><span>openvpn --genkey --secret ta.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#将本地的ta.key移动到openVPN证书目录</span>
</span></span><span style="display:flex;"><span>mv ./ta.key /etc/openvpn/keys/
</span></span></code></pre></div><p>将我们上面生成的<code>CA</code>证书和服务端证书拷贝到证书目录中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /usr/local/easy-rsa-old-master/easy-rsa/2.0/keys/<span style="color:#f92672">{</span>server.crt,server.key,ca.crt,dh2048.pem<span style="color:#f92672">}</span> /etc/openvpn/keys/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ll /etc/openvpn/keys/</span>
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">2342</span> Feb  <span style="color:#ae81ff">3</span> 12:48 ca.crt
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">424</span> Feb  <span style="color:#ae81ff">3</span> 12:48 dh2048.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">8089</span> Feb  <span style="color:#ae81ff">3</span> 12:48 server.crt
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3272</span> Feb  <span style="color:#ae81ff">3</span> 12:48 server.key
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">636</span> Feb  <span style="color:#ae81ff">3</span> 12:47 ta.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#abc和test为我们client端用户的证书</span>
</span></span></code></pre></div><p>拷贝OpenVPN配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 编译安装</span>
</span></span><span style="display:flex;"><span>cp /data/tools/openvpn-2.4.7/sample/sample-config-files/server.conf /etc/openvpn/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># yum安装</span>
</span></span><span style="display:flex;"><span>cp /usr/share/doc/openvpn-2.4.7/sample/sample-config-files/server.conf /etc/openvpn/
</span></span></code></pre></div><p><strong>接下来我们来配置服务端的配置文件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /etc/openvpn/server.conf
</span></span><span style="display:flex;"><span>port <span style="color:#ae81ff">1194</span>       <span style="color:#75715e">#openVPN端口</span>
</span></span><span style="display:flex;"><span>proto tcp       <span style="color:#75715e">#tcp连接</span>
</span></span><span style="display:flex;"><span>dev tun         <span style="color:#75715e">#生成tun0虚拟网卡</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ca keys/ca.crt      <span style="color:#75715e">#相关证书配置路径(可以修改为全路径/etc/openvpn/keys)</span>
</span></span><span style="display:flex;"><span>cert keys/server.crt
</span></span><span style="display:flex;"><span>key keys/server.key  <span style="color:#75715e"># This file should be kept secret</span>
</span></span><span style="display:flex;"><span>dh keys/dh2048.pem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server 10.4.82.0 255.255.255.0   <span style="color:#75715e">#默认虚拟局域网网段，不要和实际的局域网冲突就可以</span>
</span></span><span style="display:flex;"><span>ifconfig-pool-persist ipp.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>push <span style="color:#e6db74">&#34;route 10.4.82.0 255.255.255.0&#34;</span>    <span style="color:#75715e">#可以通过iptables进行路由的转发</span>
</span></span><span style="display:flex;"><span>push <span style="color:#e6db74">&#34;route 172.17.88.0 255.255.255.0&#34;</span>  <span style="color:#75715e">#vpn机器内网</span>
</span></span><span style="display:flex;"><span>push <span style="color:#e6db74">&#34;route 172.17.65.0 255.255.255.0&#34;</span>  <span style="color:#75715e">#目的网段内网</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>client-to-client                 <span style="color:#75715e">#如果客户端都是用一个证书和密钥连接VPN，需要打开这个选项</span>
</span></span><span style="display:flex;"><span>duplicate-cn
</span></span><span style="display:flex;"><span>keepalive <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>tls-auth keys/ta.key <span style="color:#ae81ff">0</span> <span style="color:#75715e"># This file is secret</span>
</span></span><span style="display:flex;"><span>comp-lzo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>persist-key
</span></span><span style="display:flex;"><span>persist-tun
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>status openvpn-status.log   <span style="color:#75715e">#状态日志路径</span>
</span></span><span style="display:flex;"><span>log-append  openvpn.log     <span style="color:#75715e">#运行日志</span>
</span></span><span style="display:flex;"><span>verb <span style="color:#ae81ff">3</span>                      <span style="color:#75715e">#调试信息级别</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#如果需要接入ldap，需要在server.conf下添加如下2行</span>
</span></span><span style="display:flex;"><span>plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so <span style="color:#e6db74">&#34;/etc/openvpn/auth/ldap.conf cn=%u&#34;</span>
</span></span><span style="display:flex;"><span>client-cert-not-required
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#如何环境和我相同，可以直接cp我的配置文件</span>
</span></span></code></pre></div><p>开启内核路由转发功能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt;/etc/sysctl.conf
</span></span><span style="display:flex;"><span>sysctl -p
</span></span></code></pre></div><p>如果有iptables可以开启iptables策略</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>iptables -P FORWARD ACCEPT
</span></span><span style="display:flex;"><span>iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">1194</span> -m comment --comment <span style="color:#e6db74">&#34;openvpn&#34;</span> -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -t nat -A POSTROUTING -s 10.4.82.0/24 -j MASQUERADE
</span></span></code></pre></div><p>启动openvpn服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cd /etc/openvpn/
</span></span><span style="display:flex;"><span>$ /usr/local/openvpn/sbin/openvpn --daemon --config /etc/openvpn/server.conf
</span></span></code></pre></div><p>检查服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ netstat -lntup|grep <span style="color:#ae81ff">1194</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 0.0.0.0:1194            0.0.0.0:*               LISTEN      48091/openvpn
</span></span></code></pre></div><p>设置开机启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;/usr/local/openvpn/sbin/openvpn --daemon --config /etc/openvpn/server.conf &gt; /dev/null 2&gt;&amp;1 &amp;&#34;</span> &gt;&gt; /etc/rc.local
</span></span></code></pre></div><hr>
<h3 id="客户端连接测试">客户端连接测试<a hidden class="anchor" aria-hidden="true" href="#客户端连接测试">#</a></h3>
<p>无论我们是在Windows还是Linux OS上Client端的配置，都需要将Client证书、CA证书以及Client配置文件下载下来</p>
<p><strong>现在我们需要先配置一下client.conf</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp /data/tools/openvpn-2.4.7/sample/sample-config-files/client.conf /root/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#修改如下，并将client.conf修改为client.ovpn</span>
</span></span><span style="display:flex;"><span>$ cat /root/client.conf
</span></span><span style="display:flex;"><span>client
</span></span><span style="display:flex;"><span>dev tun
</span></span><span style="display:flex;"><span>proto tcp
</span></span><span style="display:flex;"><span>remote 192.168.0.10 <span style="color:#ae81ff">1194</span>    <span style="color:#75715e">#openvpn服务器的外网IP和端口(可以写多个做到高可用)</span>
</span></span><span style="display:flex;"><span>resolv-retry infinite
</span></span><span style="display:flex;"><span>nobind
</span></span><span style="display:flex;"><span>persist-key
</span></span><span style="display:flex;"><span>persist-tun
</span></span><span style="display:flex;"><span>ca ca.crt
</span></span><span style="display:flex;"><span>cert client1.crt         <span style="color:#75715e">#用户的证书</span>
</span></span><span style="display:flex;"><span>key client1.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tls-auth ta.key <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>cipher AES-256-CBC
</span></span><span style="display:flex;"><span>comp-lzo
</span></span><span style="display:flex;"><span>verb <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#比较重点的就是修改remote 地址，这里的地址为server</span>
</span></span><span style="display:flex;"><span>cert key，我们这里使用用户的证书，所以证书也应当修改为client1.crt和client1.key
</span></span><span style="display:flex;"><span>tls-auth 因为使用加密协议，所以ta.key也需要下载下来
</span></span></code></pre></div><p>修改后缀并导出</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vpn ~<span style="color:#f92672">]</span><span style="color:#75715e"># mv client.conf client.ovpn</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@vpn ~<span style="color:#f92672">]</span><span style="color:#75715e"># sz client.ovpn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#同时还需要导出几个证书</span>
</span></span><span style="display:flex;"><span>mv client.conf client.ovpn
</span></span><span style="display:flex;"><span>sz /root/client.ovpn
</span></span><span style="display:flex;"><span>sz /etc/openvpn/keys/ca.crt
</span></span><span style="display:flex;"><span>sz /etc/openvpn/keys/ta.key
</span></span><span style="display:flex;"><span>sz /usr/local/easy-rsa-old-master/easy-rsa/2.0/keys/client1.crt
</span></span><span style="display:flex;"><span>sz /usr/local/easy-rsa-old-master/easy-rsa/2.0/keys/client1.key
</span></span></code></pre></div><p><strong>添加用户</strong></p>
<p>以后我们如果想添加用户只需要到<code>cd /usr/local/easy-rsa-old-master/easy-rsa/2.0</code>目录下执行<code>./build-key 用户名</code>，在将keys目录下生成的用户名.crt和key导出，修改一下client.ovpn的用户key名称即可</p>
<hr>
<p><strong>Windows</strong></p>
<p>客户端需要证书如下</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e064adis8tfhpj1mh91pk132s55.png" alt=""  />
</p>
<p>Windows客户端下载</p>
<p><a href="http://down.i4t.com/openvpn-install-2.4.7-I606-Win10.exe">http://down.i4t.com/openvpn-install-2.4.7-I606-Win10.exe</a></p>
<p><a href="http://down.i4t.com/openvpn-install-2.4.7-I606-Win7.exe">http://down.i4t.com/openvpn-install-2.4.7-I606-Win7.exe</a></p>
<blockquote>
<p>打开浏览器即可下载</p>
</blockquote>
<p>安装步骤，直接C盘就可以了，文件很小~</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05q54uh1802svu1fcm1o6ajb21g.png" alt=""  />
</p>
<p>疯狂下一步即可</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05q5oaj1h341n1g1sl6ail1ca71t.png" alt=""  />
</p>
<p>安装完成后</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05q7f9enl11dj45relri1hbd2a.png" alt=""  />
</p>
<p>接下来我们需要替换一下证书</p>
<p>点击桌面的logo，右击属性</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05q8lnd1ibj5prl6515rn1v712n.png" alt=""  />
</p>
<p>点击打开文件位置</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05q9a2urlg1meurun52ihg134.png" alt=""  />
</p>
<p>点击上方OpenVPN从新选择目录</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05qaes7i3j1csha599jikq3h.png" alt=""  />
</p>
<p>选择config目录</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05qb5c818ea1tpcqb912scmp83u.png" alt=""  />
</p>
<p>将config目录下文件全部删除</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e05qccgijf76vd1oq413aj1s4t4b.png" alt=""  />
</p>
<p>然后将我们导出的5个证书复制过去</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e064adis8tfhpj1mh91pk132s55.png" alt=""  />
</p>
<blockquote>
<p>其中client1.*为client1用户的证书</p>
</blockquote>
<p>现在我们进行启动openvpn客户端，进行连接</p>
<pre tabindex="0"><code>双击桌面OpenVPN
</code></pre><p>右击图标，选择连接</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e065eise5bh89a1gfh12oqn7k5v.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e065dpuhsur1bktmu31ruj7im5i.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e065fh3892b8g714nu19jv1crf6c.png" alt=""  />
</p>
<p>这里可以看到已经连接成功</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e0678fe812fq1hts19pa1jbcg6i9.png" alt=""  />
</p>
<p><strong>Mac</strong></p>
<p>复制链接到浏览器，下载软件包</p>
<p><a href="http://down.i4t.com/Tunnelblick_3.8.1_build_5400.dmg">http://down.i4t.com/Tunnelblick_3.8.1_build_5400.dmg</a></p>
<p>我们直接点开client.ovpn就可以自动链接</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e067jo5h114mtnr1pij46jb0813.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e067jsvo820r9p13atig2vtv1g.png" alt=""  />
</p>
<p>成功后会有下面的流量图</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e067jjr0qfrub6ans10ddm4nm.png" alt=""  />
</p>
<p>配置文件打开方式</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e067n5tt1d6bu071blus8m4fl1t.png" alt=""  />
</p>
<p>这时候网络已经通了</p>
<p><img loading="lazy" src="/images/CentOS-7-%e6%90%ad%e5%bb%baOpenVPN%e6%9c%8d%e5%8a%a1%e5%99%a8/image_1e067r39fqav1bc88uqueot5d2a.png" alt=""  />
</p>
<p>配置完成后，可能路由存在问题，可以尝试添加下面的iptables规则</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 172.17.88.56
</span></span><span style="display:flex;"><span>iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">1194</span> -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -I FORWARD -s 10.8.0.0/24 -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -t nat -D POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 172.17.88.56
</span></span><span style="display:flex;"><span>iptables -D INPUT -p tcp --dport <span style="color:#ae81ff">1194</span> -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -D FORWARD -s 10.8.0.0/24 -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/openvpn/">openvpn</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/%E8%A7%A3%E5%86%B3npm-install%E4%B8%8B%E8%BD%BDchromedriver2.46.0%E4%BE%9D%E8%B5%96%E5%8C%85%E8%B6%85%E7%BA%A7%E6%85%A2%E9%97%AE%E9%A2%98/">
    <span class="title">« 上一页</span>
    <br>
    <span>解决npm install下载chromedriver@2.46.0依赖包超级慢问题</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
