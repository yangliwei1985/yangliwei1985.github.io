<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群 | ylw&#39;s blog</title>
<meta name="keywords" content="mongodb, replicaSet" />
<meta name="description" content="基础规划 软件环境 #mongodb下载 # wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb解压 # tar -zxvf mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb安装 # mv mv mongodb-linux-x86_64-rhel70-3.4.10 /usr/local/mongodb #mongodb环境配置 # echo &#39;export PATH=/usr/local/mongodb/bin:$PATH&#39; &gt;&gt; /etc/profile #使配置生效  # source /etc/profile  # 查看是否安装成功 # mongo --version 环境规划&ndash;单机器部署多节点    节点名 节点用途 节点IP 节点端口 集群名     node1 主节点(PRIMARY) 10.0.2.11 27017 mgset   node2 从节点(SECONDARY) 10.0.2.11 27018    node3 仲裁节点(ARBITER) 10.0.2.11 27019        目录 用途 备注     /data/mongodb/node[x]/data Mongo集群数据文件目录    /data/mongodb/node[x]/logs Mongo集群系统日志目录    /data/mongodb/node[x]/conf Mongo集群配置文件目录     搭建步骤 配置文件 node1的配置文件/data/mongodb/node1/conf/mongod.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/centos7%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E7%9A%84mongodb3.4%E4%B8%89%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E9%9B%86%E7%BE%A4/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群" />
<meta property="og:description" content="基础规划 软件环境 #mongodb下载 # wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb解压 # tar -zxvf mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb安装 # mv mv mongodb-linux-x86_64-rhel70-3.4.10 /usr/local/mongodb #mongodb环境配置 # echo &#39;export PATH=/usr/local/mongodb/bin:$PATH&#39; &gt;&gt; /etc/profile #使配置生效  # source /etc/profile  # 查看是否安装成功 # mongo --version 环境规划&ndash;单机器部署多节点    节点名 节点用途 节点IP 节点端口 集群名     node1 主节点(PRIMARY) 10.0.2.11 27017 mgset   node2 从节点(SECONDARY) 10.0.2.11 27018    node3 仲裁节点(ARBITER) 10.0.2.11 27019        目录 用途 备注     /data/mongodb/node[x]/data Mongo集群数据文件目录    /data/mongodb/node[x]/logs Mongo集群系统日志目录    /data/mongodb/node[x]/conf Mongo集群配置文件目录     搭建步骤 配置文件 node1的配置文件/data/mongodb/node1/conf/mongod." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/centos7%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E7%9A%84mongodb3.4%E4%B8%89%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E9%9B%86%E7%BE%A4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-30T15:37:05&#43;08:00" />
<meta property="article:modified_time" content="2022-03-30T15:37:05&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群"/>
<meta name="twitter:description" content="基础规划 软件环境 #mongodb下载 # wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb解压 # tar -zxvf mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb安装 # mv mv mongodb-linux-x86_64-rhel70-3.4.10 /usr/local/mongodb #mongodb环境配置 # echo &#39;export PATH=/usr/local/mongodb/bin:$PATH&#39; &gt;&gt; /etc/profile #使配置生效  # source /etc/profile  # 查看是否安装成功 # mongo --version 环境规划&ndash;单机器部署多节点    节点名 节点用途 节点IP 节点端口 集群名     node1 主节点(PRIMARY) 10.0.2.11 27017 mgset   node2 从节点(SECONDARY) 10.0.2.11 27018    node3 仲裁节点(ARBITER) 10.0.2.11 27019        目录 用途 备注     /data/mongodb/node[x]/data Mongo集群数据文件目录    /data/mongodb/node[x]/logs Mongo集群系统日志目录    /data/mongodb/node[x]/conf Mongo集群配置文件目录     搭建步骤 配置文件 node1的配置文件/data/mongodb/node1/conf/mongod."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群",
      "item": "https://iblog.zone/archives/centos7%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E7%9A%84mongodb3.4%E4%B8%89%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E9%9B%86%E7%BE%A4/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群",
  "name": "CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群",
  "description": "基础规划 软件环境 #mongodb下载 # wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb解压 # tar -zxvf mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb安装 # mv mv mongodb-linux-x86_64-rhel70-3.4.10 /usr/local/mongodb #mongodb环境配置 # echo \u0026#39;export PATH=/usr/local/mongodb/bin:$PATH\u0026#39; \u0026gt;\u0026gt; /etc/profile #使配置生效  # source /etc/profile  # 查看是否安装成功 # mongo --version 环境规划\u0026ndash;单机器部署多节点    节点名 节点用途 节点IP 节点端口 集群名     node1 主节点(PRIMARY) 10.0.2.11 27017 mgset   node2 从节点(SECONDARY) 10.0.2.11 27018    node3 仲裁节点(ARBITER) 10.0.2.11 27019        目录 用途 备注     /data/mongodb/node[x]/data Mongo集群数据文件目录    /data/mongodb/node[x]/logs Mongo集群系统日志目录    /data/mongodb/node[x]/conf Mongo集群配置文件目录     搭建步骤 配置文件 node1的配置文件/data/mongodb/node1/conf/mongod.",
  "keywords": [
    "mongodb", "replicaSet"
  ],
  "articleBody": "基础规划 软件环境 #mongodb下载 # wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb解压 # tar -zxvf mongodb-linux-x86_64-rhel70-3.4.10.tgz #mongodb安装 # mv mv mongodb-linux-x86_64-rhel70-3.4.10 /usr/local/mongodb #mongodb环境配置 # echo 'export PATH=/usr/local/mongodb/bin:$PATH'  /etc/profile #使配置生效  # source /etc/profile  # 查看是否安装成功 # mongo --version 环境规划–单机器部署多节点    节点名 节点用途 节点IP 节点端口 集群名     node1 主节点(PRIMARY) 10.0.2.11 27017 mgset   node2 从节点(SECONDARY) 10.0.2.11 27018    node3 仲裁节点(ARBITER) 10.0.2.11 27019        目录 用途 备注     /data/mongodb/node[x]/data Mongo集群数据文件目录    /data/mongodb/node[x]/logs Mongo集群系统日志目录    /data/mongodb/node[x]/conf Mongo集群配置文件目录     搭建步骤 配置文件 node1的配置文件/data/mongodb/node1/conf/mongod.conf (其他节点根据情况修改)\nsystemLog:  destination: file  path: \"/data/mongodb/node1/logs/mongod.log\"  logAppend: true storage:  dbPath: \"/data/mongodb/node1/data\"  journal:  enabled: true processManagement:  fork: true  pidFilePath: \"/data/mongodb/node1/mongod.pid\" net:  bindIp: 10.0.2.11  port: 27017 #security: # 认证配置，开启认证后取消注释 # keyFile: \"/data/mongodb/node1/conf/access.key\" # authorization: enabled replication:  oplogSizeMB: 500  replSetName: mgset 启动服务\n# mongod -f /data/mongodb/node1/conf/mongod.conf # mongod -f /data/mongodb/node2/conf/mongod.conf # mongod -f /data/mongodb/node3/conf/mongod.conf 配置集群 进入其中一个节点(主节点)的mongo控制台, 配置集群(务必保证节点防火墙关闭或开放mongo服务端口).\n# 仅在一个节点执行 # mongo 10.0.2.11:27017 #进入mongo控制台  cfg = {_id: 'mgset', members: []} #生成集群配置变量  cfg.members.push({_id: 1, host: '10.0.2.11:27017'}) #变量中加入节点1  cfg.members.push({_id: 2, host: '10.0.2.11:27018'}) #变量中加入节点2  cfg.members.push({_id: 3, host: '10.0.2.11:27019', arbiterOnly: true}) #变量中加入节点3(仲裁节点)  rs.initiate(cfg) #根据变量配置集群  rs.isMaster() #查看集群是否配置成功  rs.status()  #健康状态 1表示正常 0表示故障  \"health\" : 1,  #表示状态 1是主库 2是从库 3表示恢复数据中 7表示投票者 8表示down机  \"state\" : 1,  #标注是主库还是从库  \"stateStr\" : \"PRIMARY\",  #集群启动时间  \"uptime\" : 579,  #另一种格式的时间  \"optime\" : {  \"ts\" : Timestamp(1590593779, 1),  \"t\" : NumberLong(1)  },  #上一次心跳传过来数据的时间  \"optimeDate\" : ISODate(\"2020-05-27T15:36:19Z\"),  #检测上一次心跳时间  \"lastHeartbeat\" : ISODate(\"2020-05-27T15:36:25.815Z\"),  rs.printReplicationInfo()\t#oplog信息 configured oplog size: 1024MB log length start to end: 1543secs (0.43hrs) oplog first event time: Wed May 27 2020 23:26:46 GMT+0800 (CST) oplog last event time: Wed May 27 2020 23:52:29 GMT+0800 (CST) now: Wed May 27 2020 23:52:38 GMT+0800 (CST)  rs.printSlaveReplicationInfo()\t#查看延时从库信息 source: 10.0.0.93:28018  syncedTo: Wed May 27 2020 23:54:19 GMT+0800 (CST)  0 secs (0 hrs) behind the primary source: 10.0.0.93:28019  syncedTo: Wed May 27 2020 23:54:19 GMT+0800 (CST)  0 secs (0 hrs) behind the primary  rs.config()\t#打印副本集配置文件 添加用户 集群配置完成后, 仍然在主节点的mongo控制台中添加数据库管理员\n# 仅在一个节点执行 # mongo 10.0.2.11:27017 #进入mongo控制台  use admin #使用内置的admin库   db.createUser(\t#创建数据库管理员 { user:\"root\", pwd:\"root\", roles:[{role:\"readWriteAnyDatabase\",db:\"admin\"},{role:\"dbAdminAnyDatabase\",db:\"admin\"},{role:\"userAdminAnyDatabase\",db:\"admin\"}] } )  # 其他用户创建  db.createUser( #创建集群管理员 { user:\"suroot\", pwd:\"suroot\", roles:[{role:\"clusterAdmin\",db:\"admin\"},{role:\"clusterManager\",db:\"admin\"},{role:\"clusterMonitor\",db:\"admin\"}] } )  use testdb #切换到testdb数据库,不用事先创建  db.createUser( #创建特定库的特定用户 { user:\"test\", pwd:\"test\", roles:[{role:\"readWrite\",db:\"testdb\"},{role:\"dbAdmin\",db:\"testdb\"},{role:\"userAdmin\",db:\"testdb\"}] } )  use admin  db.system.users.find() #查看创建的用户 　[注]:\n1. MongoDB的用户和数据库是绑定的, 必须指定某个用户归属于哪个数据库, 即在roles字段的每个role中指定db字段. 2. 数据库管理员通常需要具有读写,管理任意数据库和管理任意用户的role, 后续可以登录此用户进行数据库和用户的增删改查. 3. 集群管理员通常需要具有集群管理和集群监控的role, 只有集群管理员可以关闭集群. 4. 普通用户根据用途不同可以对特定或者多个数据库拥有各种不同的role, 本例中的test用户既可以读写testdb库, 同时也是testdb库的管理员. 5. 主节点上添加的用户应该能够在从节点上查询到(需要先键入rs.slaveOk()命令). 开启用户认证 用户添加完成后需要关闭所有节点:\nkillall mongod 生成keyFile(keyFile的用途是作为所有mongod后台进程允许加入集群的凭证, 所有集群中的节点共用一个keyFile, 避免其他mongod非法加入集群):\n# 仅在一个节点执行 # openssl rand -base64 756  /data/mongodb/node1/conf/access.key #生成keyFile, keyFile的长度必须在6-1024个字符之间 # chmod 400 /data/mongodb/node1/conf/access.key #设置keyFile文件为只读 # cp /data/mongodb/node1/conf/access.key /data/mongodb/node2/conf/ #将keyFile复制到其他节点 # cp /data/mongodb/node1/conf/access.key /data/mongodb/node3/conf/ 取消三个节点mongod.conf文件中security部分的注释:\nsystemLog:  destination: file  path: \"/data/mongodb/node1/logs/mongod.log\"  logAppend: true storage:  dbPath: \"/data/mongodb/node1/data\"  journal:  enabled: true processManagement:  fork: true  pidFilePath: \"/data/mongodb/node1/mongod.pid\" net:  bindIp: 10.0.2.11  port: 27017 security: # 认证配置，开启认证后取消注释  keyFile: \"/data/mongodb/node1/conf/access.key\"  authorization: enabled replication:  oplogSizeMB: 500  replSetName: mgset 依次启动主节点, 从节点和仲裁节点的mongod后台进程:\n# mongod -f /data/mongodb/node1/conf/mongod.conf # mongod -f /data/mongodb/node2/conf/mongod.conf # mongod -f /data/mongodb/node3/conf/mongod.conf 使用认证用户登录:\n# mongo 10.0.2.11:27017  use admin  db.auth('root', 'root') #使用数据库管理员认证  rs.slaveOk() #默认读写操作均在主节点执行, 从节点上需要执行此命令才能读取数据库数据  db.system.users.find()  use testdb  db.auth('test', 'test') #切换到test用户  db.getCollectionNames()  use admin #切换到集群管理员用户, 关闭mongo服务  db.auth('suroot', 'suroot') 　至此, 基于用户认证的MongoDB3.4三节点副本集集群环境已经搭建完成.\n常用命令：\nhttps://www.runoob.com/mongodb/mongodb-create-collection.html\n本文参考：\nhttps://www.itq168.com/article/3470\nhttps://xpbag.com/503.html\n",
  "wordCount" : "479",
  "inLanguage": "zh",
  "datePublished": "2022-03-30T15:37:05+08:00",
  "dateModified": "2022-03-30T15:37:05+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/centos7%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E7%9A%84mongodb3.4%E4%B8%89%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E9%9B%86%E7%BE%A4/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      CentOS7搭建基于用户认证的MongoDB3.4三节点副本集集群
    </h1>
    <div class="post-meta"><span title='2022-03-30 15:37:05 +0800 CST'>2022-03-30</span>&nbsp;·&nbsp;3 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%9f%ba%e7%a1%80%e8%a7%84%e5%88%92" aria-label="基础规划">基础规划</a><ul>
                            
                    <li>
                        <a href="#%e8%bd%af%e4%bb%b6%e7%8e%af%e5%a2%83" aria-label="软件环境">软件环境</a></li>
                    <li>
                        <a href="#%e7%8e%af%e5%a2%83%e8%a7%84%e5%88%92--%e5%8d%95%e6%9c%ba%e5%99%a8%e9%83%a8%e7%bd%b2%e5%a4%9a%e8%8a%82%e7%82%b9" aria-label="环境规划&amp;ndash;单机器部署多节点">环境规划&ndash;单机器部署多节点</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%90%ad%e5%bb%ba%e6%ad%a5%e9%aa%a4" aria-label="搭建步骤">搭建步骤</a><ul>
                            
                    <li>
                        <a href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="配置文件">配置文件</a></li>
                    <li>
                        <a href="#%e9%85%8d%e7%bd%ae%e9%9b%86%e7%be%a4" aria-label="配置集群">配置集群</a></li>
                    <li>
                        <a href="#%e6%b7%bb%e5%8a%a0%e7%94%a8%e6%88%b7" aria-label="添加用户">添加用户</a></li>
                    <li>
                        <a href="#%e5%bc%80%e5%90%af%e7%94%a8%e6%88%b7%e8%ae%a4%e8%af%81" aria-label="开启用户认证">开启用户认证</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="基础规划">基础规划<a hidden class="anchor" aria-hidden="true" href="#基础规划">#</a></h3>
<h4 id="软件环境">软件环境<a hidden class="anchor" aria-hidden="true" href="#软件环境">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#mongodb下载</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.10.tgz</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#mongodb解压</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tar -zxvf mongodb-linux-x86_64-rhel70-3.4.10.tgz</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#mongodb安装</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mv mv mongodb-linux-x86_64-rhel70-3.4.10 /usr/local/mongodb</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#mongodb环境配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo &#39;export PATH=/usr/local/mongodb/bin:$PATH&#39; &gt;&gt; /etc/profile</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#使配置生效 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># source /etc/profile           </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看是否安装成功</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongo --version</span>
</span></span></code></pre></div><h4 id="环境规划--单机器部署多节点">环境规划&ndash;单机器部署多节点<a hidden class="anchor" aria-hidden="true" href="#环境规划--单机器部署多节点">#</a></h4>
<table>
<thead>
<tr>
<th>节点名</th>
<th>节点用途</th>
<th>节点IP</th>
<th>节点端口</th>
<th>集群名</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>主节点(PRIMARY)</td>
<td>10.0.2.11</td>
<td>27017</td>
<td>mgset</td>
</tr>
<tr>
<td>node2</td>
<td>从节点(SECONDARY)</td>
<td>10.0.2.11</td>
<td>27018</td>
<td></td>
</tr>
<tr>
<td>node3</td>
<td>仲裁节点(ARBITER)</td>
<td>10.0.2.11</td>
<td>27019</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>目录</th>
<th>用途</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>/data/mongodb/node[x]/data</td>
<td>Mongo集群数据文件目录</td>
<td></td>
</tr>
<tr>
<td>/data/mongodb/node[x]/logs</td>
<td>Mongo集群系统日志目录</td>
<td></td>
</tr>
<tr>
<td>/data/mongodb/node[x]/conf</td>
<td>Mongo集群配置文件目录</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="搭建步骤">搭建步骤<a hidden class="anchor" aria-hidden="true" href="#搭建步骤">#</a></h3>
<h4 id="配置文件">配置文件<a hidden class="anchor" aria-hidden="true" href="#配置文件">#</a></h4>
<p>node1的配置文件/data/mongodb/node1/conf/mongod.conf (其他节点根据情况修改)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">systemLog</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">destination</span>: <span style="color:#ae81ff">file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/logs/mongod.log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">logAppend</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">storage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dbPath</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/data&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">journal</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">processManagement</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pidFilePath</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/mongod.pid&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">net</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">bindIp</span>: <span style="color:#ae81ff">10.0.2.11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">27017</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#security:    # 认证配置，开启认证后取消注释</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    keyFile: &#34;/data/mongodb/node1/conf/access.key&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    authorization: enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">replication</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">oplogSizeMB</span>: <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replSetName</span>: <span style="color:#ae81ff">mgset</span>
</span></span></code></pre></div><p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># mongod -f /data/mongodb/node1/conf/mongod.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongod -f /data/mongodb/node2/conf/mongod.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongod -f /data/mongodb/node3/conf/mongod.conf</span>
</span></span></code></pre></div><h4 id="配置集群">配置集群<a hidden class="anchor" aria-hidden="true" href="#配置集群">#</a></h4>
<p>进入其中一个节点(主节点)的mongo控制台, 配置集群(务必保证节点防火墙关闭或开放mongo服务端口).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 仅在一个节点执行</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongo 10.0.2.11:27017     #进入mongo控制台</span>
</span></span><span style="display:flex;"><span>&gt; cfg <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>_id: <span style="color:#e6db74">&#39;mgset&#39;</span>, members: <span style="color:#f92672">[]}</span>                                       <span style="color:#75715e">#生成集群配置变量</span>
</span></span><span style="display:flex;"><span>&gt; cfg.members.push<span style="color:#f92672">({</span>_id: 1, host: <span style="color:#e6db74">&#39;10.0.2.11:27017&#39;</span><span style="color:#f92672">})</span>                     <span style="color:#75715e">#变量中加入节点1</span>
</span></span><span style="display:flex;"><span>&gt; cfg.members.push<span style="color:#f92672">({</span>_id: 2, host: <span style="color:#e6db74">&#39;10.0.2.11:27018&#39;</span><span style="color:#f92672">})</span>                     <span style="color:#75715e">#变量中加入节点2</span>
</span></span><span style="display:flex;"><span>&gt; cfg.members.push<span style="color:#f92672">({</span>_id: 3, host: <span style="color:#e6db74">&#39;10.0.2.11:27019&#39;</span>, arbiterOnly: true<span style="color:#f92672">})</span> <span style="color:#75715e">#变量中加入节点3(仲裁节点)</span>
</span></span><span style="display:flex;"><span>&gt; rs.initiate<span style="color:#f92672">(</span>cfg<span style="color:#f92672">)</span>                                                       <span style="color:#75715e">#根据变量配置集群</span>
</span></span><span style="display:flex;"><span>&gt; rs.isMaster<span style="color:#f92672">()</span>                                                          <span style="color:#75715e">#查看集群是否配置成功</span>
</span></span><span style="display:flex;"><span>&gt; rs.status<span style="color:#f92672">()</span>  
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#健康状态 1表示正常 0表示故障</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;health&#34;</span> : 1,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#表示状态 1是主库 2是从库 3表示恢复数据中 7表示投票者 8表示down机</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;state&#34;</span> : 1,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#标注是主库还是从库</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;stateStr&#34;</span> : <span style="color:#e6db74">&#34;PRIMARY&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#集群启动时间</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;uptime&#34;</span> : 579,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#另一种格式的时间</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;optime&#34;</span> : <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ts&#34;</span> : Timestamp<span style="color:#f92672">(</span>1590593779, 1<span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;t&#34;</span> : NumberLong<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#上一次心跳传过来数据的时间</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;optimeDate&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2020-05-27T15:36:19Z&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#检测上一次心跳时间</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;lastHeartbeat&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2020-05-27T15:36:25.815Z&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>&gt; rs.printReplicationInfo<span style="color:#f92672">()</span>	 <span style="color:#75715e">#oplog信息</span>
</span></span><span style="display:flex;"><span>configured oplog size:   1024MB
</span></span><span style="display:flex;"><span>log length start to end: 1543secs <span style="color:#f92672">(</span>0.43hrs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>oplog first event time:  Wed May <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">2020</span> 23:26:46 GMT+0800 <span style="color:#f92672">(</span>CST<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>oplog last event time:   Wed May <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">2020</span> 23:52:29 GMT+0800 <span style="color:#f92672">(</span>CST<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>now:                     Wed May <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">2020</span> 23:52:38 GMT+0800 <span style="color:#f92672">(</span>CST<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt; rs.printSlaveReplicationInfo<span style="color:#f92672">()</span>	<span style="color:#75715e">#查看延时从库信息</span>
</span></span><span style="display:flex;"><span>source: 10.0.0.93:28018
</span></span><span style="display:flex;"><span>    syncedTo: Wed May <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">2020</span> 23:54:19 GMT+0800 <span style="color:#f92672">(</span>CST<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> secs <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> hrs<span style="color:#f92672">)</span> behind the primary 
</span></span><span style="display:flex;"><span>source: 10.0.0.93:28019
</span></span><span style="display:flex;"><span>    syncedTo: Wed May <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">2020</span> 23:54:19 GMT+0800 <span style="color:#f92672">(</span>CST<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> secs <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> hrs<span style="color:#f92672">)</span> behind the primary 
</span></span><span style="display:flex;"><span>&gt; rs.config<span style="color:#f92672">()</span>		<span style="color:#75715e">#打印副本集配置文件</span>
</span></span></code></pre></div><h4 id="添加用户">添加用户<a hidden class="anchor" aria-hidden="true" href="#添加用户">#</a></h4>
<p>集群配置完成后, 仍然在主节点的mongo控制台中添加数据库管理员</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 仅在一个节点执行</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongo 10.0.2.11:27017     #进入mongo控制台</span>
</span></span><span style="display:flex;"><span>&gt; use admin    <span style="color:#75715e">#使用内置的admin库           </span>
</span></span><span style="display:flex;"><span>&gt; db.createUser<span style="color:#f92672">(</span>	<span style="color:#75715e">#创建数据库管理员</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>user:<span style="color:#e6db74">&#34;root&#34;</span>,
</span></span><span style="display:flex;"><span>pwd:<span style="color:#e6db74">&#34;root&#34;</span>,
</span></span><span style="display:flex;"><span>roles:<span style="color:#f92672">[{</span>role:<span style="color:#e6db74">&#34;readWriteAnyDatabase&#34;</span>,db:<span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>role:<span style="color:#e6db74">&#34;dbAdminAnyDatabase&#34;</span>,db:<span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>role:<span style="color:#e6db74">&#34;userAdminAnyDatabase&#34;</span>,db:<span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其他用户创建</span>
</span></span><span style="display:flex;"><span>&gt; db.createUser<span style="color:#f92672">(</span>  <span style="color:#75715e">#创建集群管理员</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>user:<span style="color:#e6db74">&#34;suroot&#34;</span>,
</span></span><span style="display:flex;"><span>pwd:<span style="color:#e6db74">&#34;suroot&#34;</span>,
</span></span><span style="display:flex;"><span>roles:<span style="color:#f92672">[{</span>role:<span style="color:#e6db74">&#34;clusterAdmin&#34;</span>,db:<span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>role:<span style="color:#e6db74">&#34;clusterManager&#34;</span>,db:<span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>role:<span style="color:#e6db74">&#34;clusterMonitor&#34;</span>,db:<span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt; use testdb   <span style="color:#75715e">#切换到testdb数据库,不用事先创建</span>
</span></span><span style="display:flex;"><span>&gt; db.createUser<span style="color:#f92672">(</span>  <span style="color:#75715e">#创建特定库的特定用户</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>user:<span style="color:#e6db74">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>pwd:<span style="color:#e6db74">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>roles:<span style="color:#f92672">[{</span>role:<span style="color:#e6db74">&#34;readWrite&#34;</span>,db:<span style="color:#e6db74">&#34;testdb&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>role:<span style="color:#e6db74">&#34;dbAdmin&#34;</span>,db:<span style="color:#e6db74">&#34;testdb&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>role:<span style="color:#e6db74">&#34;userAdmin&#34;</span>,db:<span style="color:#e6db74">&#34;testdb&#34;</span><span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt; use admin
</span></span><span style="display:flex;"><span>&gt; db.system.users.find<span style="color:#f92672">()</span>  <span style="color:#75715e">#查看创建的用户</span>
</span></span></code></pre></div><p>　　[注]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>1. MongoDB的用户和数据库是绑定的, 必须指定某个用户归属于哪个数据库, 即在roles字段的每个role中指定db字段.
</span></span><span style="display:flex;"><span>2. 数据库管理员通常需要具有读写,管理任意数据库和管理任意用户的role, 后续可以登录此用户进行数据库和用户的增删改查.
</span></span><span style="display:flex;"><span>3. 集群管理员通常需要具有集群管理和集群监控的role, 只有集群管理员可以关闭集群.
</span></span><span style="display:flex;"><span>4. 普通用户根据用途不同可以对特定或者多个数据库拥有各种不同的role, 本例中的test用户既可以读写testdb库, 同时也是testdb库的管理员.
</span></span><span style="display:flex;"><span>5. 主节点上添加的用户应该能够在从节点上查询到<span style="color:#f92672">(</span>需要先键入rs.slaveOk<span style="color:#f92672">()</span>命令<span style="color:#f92672">)</span>.
</span></span></code></pre></div><h4 id="开启用户认证">开启用户认证<a hidden class="anchor" aria-hidden="true" href="#开启用户认证">#</a></h4>
<p>用户添加完成后需要关闭所有节点:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>killall mongod
</span></span></code></pre></div><p>生成keyFile(keyFile的用途是作为所有mongod后台进程允许加入集群的凭证, 所有集群中的节点共用一个keyFile, 避免其他mongod非法加入集群):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 仅在一个节点执行</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># openssl rand -base64 756 &gt; /data/mongodb/node1/conf/access.key  #生成keyFile, keyFile的长度必须在6-1024个字符之间</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># chmod 400 /data/mongodb/node1/conf/access.key    #设置keyFile文件为只读</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cp /data/mongodb/node1/conf/access.key /data/mongodb/node2/conf/   #将keyFile复制到其他节点</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cp /data/mongodb/node1/conf/access.key /data/mongodb/node3/conf/</span>
</span></span></code></pre></div><p>取消三个节点mongod.conf文件中security部分的注释:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">systemLog</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">destination</span>: <span style="color:#ae81ff">file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/logs/mongod.log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">logAppend</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">storage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dbPath</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/data&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">journal</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">processManagement</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pidFilePath</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/mongod.pid&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">net</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">bindIp</span>: <span style="color:#ae81ff">10.0.2.11</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">27017</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">security</span>:    <span style="color:#75715e"># 认证配置，开启认证后取消注释</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">keyFile</span>: <span style="color:#e6db74">&#34;/data/mongodb/node1/conf/access.key&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization</span>: <span style="color:#ae81ff">enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">replication</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">oplogSizeMB</span>: <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replSetName</span>: <span style="color:#ae81ff">mgset</span>
</span></span></code></pre></div><p>依次启动主节点, 从节点和仲裁节点的mongod后台进程:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># mongod -f /data/mongodb/node1/conf/mongod.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongod -f /data/mongodb/node2/conf/mongod.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mongod -f /data/mongodb/node3/conf/mongod.conf</span>
</span></span></code></pre></div><p>使用认证用户登录:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># mongo 10.0.2.11:27017</span>
</span></span><span style="display:flex;"><span>&gt; use admin
</span></span><span style="display:flex;"><span>&gt; db.auth<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;root&#39;</span>, <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">)</span>  <span style="color:#75715e">#使用数据库管理员认证</span>
</span></span><span style="display:flex;"><span>&gt; rs.slaveOk<span style="color:#f92672">()</span>             <span style="color:#75715e">#默认读写操作均在主节点执行, 从节点上需要执行此命令才能读取数据库数据</span>
</span></span><span style="display:flex;"><span>&gt; db.system.users.find<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt; use testdb
</span></span><span style="display:flex;"><span>&gt; db.auth<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;test&#39;</span>, <span style="color:#e6db74">&#39;test&#39;</span><span style="color:#f92672">)</span>   <span style="color:#75715e">#切换到test用户</span>
</span></span><span style="display:flex;"><span>&gt; db.getCollectionNames<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt; use admin                 <span style="color:#75715e">#切换到集群管理员用户, 关闭mongo服务</span>
</span></span><span style="display:flex;"><span>&gt; db.auth<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;suroot&#39;</span>, <span style="color:#e6db74">&#39;suroot&#39;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>　　至此, 基于用户认证的MongoDB3.4三节点副本集集群环境已经搭建完成.</p>
<p>常用命令：</p>
<p><a href="https://www.runoob.com/mongodb/mongodb-create-collection.html">https://www.runoob.com/mongodb/mongodb-create-collection.html</a></p>
<p>本文参考：</p>
<p><a href="https://www.itq168.com/article/3470">https://www.itq168.com/article/3470</a></p>
<p><a href="https://xpbag.com/503.html">https://xpbag.com/503.html</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/mongodb/">mongodb</a></li>
      <li><a href="https://iblog.zone/tags/replicaset/">replicaSet</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/centos7%E6%90%AD%E5%BB%BArocketmq4.6%E4%B8%89%E4%B8%BB%E9%9B%86%E7%BE%A4/">
    <span class="title">« 上一页</span>
    <br>
    <span>CentOS7搭建Rocketmq4.6三主集群</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/centos7%E5%AE%89%E8%A3%85redis4.0/">
    <span class="title">下一页 »</span>
    <br>
    <span>CentOS7安装Redis4.0</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
