<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>基于Istio实现微服务治理 | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="基于Istio实现微服务治理 微服务架构可谓是当前软件开发领域的技术热点，它在各种博客、社交媒体和会议演讲上的出镜率非常之高，无论是做基础架构还是做业务系统的工程师，对微服务都相当关注，而这个现象与热度到目前为止，已经持续了近 5 年之久。
尤其是近些年来，微服务架构逐渐发展成熟，从最初的星星之火到现在的大规模的落地与实践，几乎已经成为分布式环境下的首选架构。微服务成为时下技术热点，大量互联网公司都在做微服务架构的落地和推广。同时，也有很多传统企业基于微服务和容器，在做互联网技术转型。
而在这个技术转型中，国内有一个趋势，以 Spring Cloud 与 Dubbo 为代表的微服务开发框架非常普及和受欢迎。然而软件开发没有银弹，基于这些传统微服务框架构建的应用系统在享受其优势的同时，痛点也越加明显。这些痛点包括但不限于以下几点：
 侵入性强。想要集成 SDK 的能力，除了需要添加相关依赖，往往还需要在业务代码中增加一部分的代码、或注解、或配置；业务代码与治理层代码界限不清晰。 升级成本高。每次升级都需要业务应用修改 SDK 版本，重新进行功能回归测试，并且对每一台机器进行部署上线，而这对于业务方来说，与业务的快速迭代开发是有冲突的，大多不愿意停下来做这些与业务目标不太相关的事情。 版本碎片化严重。由于升级成本高，而中间件却不会停止向前发展的步伐，久而久之，就会导致线上不同服务引用的 SDK 版本不统一、能力参差不齐，造成很难统一治理。 中间件演变困难。由于版本碎片化严重，导致中间件向前演进的过程中就需要在代码中兼容各种各样的老版本逻辑，带着 “枷锁” 前行，无法实现快速迭代。 内容多、门槛高。Spring Cloud 被称为微服务治理的全家桶，包含大大小小几十个组件，内容相当之多，往往需要几年时间去熟悉其中的关键组件。而要想使用 Spring Cloud 作为完整的治理框架，则需要深入了解其中原理与实现，否则遇到问题还是很难定位。 治理功能不全。不同于 RPC 框架，Spring Cloud 作为治理全家桶的典型，也不是万能的，诸如协议转换支持、多重授权机制、动态请求路由、故障注入、灰度发布等高级功能并没有覆盖到。而这些功能往往是企业大规模落地不可获缺的功能，因此公司往往还需要投入其它人力进行相关功能的自研或者调研其它组件作为补充。  Service Mesh 服务网格 架构和概念 目的是解决系统架构微服务化后的服务间通信和治理问题。设计初衷是提供一种通用的服务治理方案。
Sidecar 在软件系统架构中特指边车模式。这个模式的灵感来源于我们生活中的边三轮：即在两轮摩托车的旁边添加一个边车的方式扩展现有的服务和功能。
这个模式的精髓在于实现了数据面（业务逻辑）和控制面的解耦：原来两轮摩托车的驾驶者集中注意力跑赛道，边车上的领航员专注周围信息和地图，专注导航。
Service Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的与应用逻辑服务部署在一起的服务代理，并且对于应用服务是透明的。
开源实现 第一代服务网格 Linkerd和Envoy Linkerd 使用Scala编写，是业界第一个开源的service mesh方案。作者 William Morgan 是 service mesh 的布道师和践行者。Envoy 基于C&#43;&#43; 11编写，无论是理论上还是实际上，后者性能都比 Linkderd 更好。这两个开源实现都是以 sidecar 为核心，绝大部分关注点都是如何做好proxy，并完成一些通用控制面的功能。 但是，当你在容器中大量部署 sidecar 以后，如何管理和控制这些 sidecar 本身就是一个不小的挑战。于是，第二代 Service Mesh 应运而生。">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Eistio%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="基于Istio实现微服务治理" />
<meta property="og:description" content="基于Istio实现微服务治理 微服务架构可谓是当前软件开发领域的技术热点，它在各种博客、社交媒体和会议演讲上的出镜率非常之高，无论是做基础架构还是做业务系统的工程师，对微服务都相当关注，而这个现象与热度到目前为止，已经持续了近 5 年之久。
尤其是近些年来，微服务架构逐渐发展成熟，从最初的星星之火到现在的大规模的落地与实践，几乎已经成为分布式环境下的首选架构。微服务成为时下技术热点，大量互联网公司都在做微服务架构的落地和推广。同时，也有很多传统企业基于微服务和容器，在做互联网技术转型。
而在这个技术转型中，国内有一个趋势，以 Spring Cloud 与 Dubbo 为代表的微服务开发框架非常普及和受欢迎。然而软件开发没有银弹，基于这些传统微服务框架构建的应用系统在享受其优势的同时，痛点也越加明显。这些痛点包括但不限于以下几点：
 侵入性强。想要集成 SDK 的能力，除了需要添加相关依赖，往往还需要在业务代码中增加一部分的代码、或注解、或配置；业务代码与治理层代码界限不清晰。 升级成本高。每次升级都需要业务应用修改 SDK 版本，重新进行功能回归测试，并且对每一台机器进行部署上线，而这对于业务方来说，与业务的快速迭代开发是有冲突的，大多不愿意停下来做这些与业务目标不太相关的事情。 版本碎片化严重。由于升级成本高，而中间件却不会停止向前发展的步伐，久而久之，就会导致线上不同服务引用的 SDK 版本不统一、能力参差不齐，造成很难统一治理。 中间件演变困难。由于版本碎片化严重，导致中间件向前演进的过程中就需要在代码中兼容各种各样的老版本逻辑，带着 “枷锁” 前行，无法实现快速迭代。 内容多、门槛高。Spring Cloud 被称为微服务治理的全家桶，包含大大小小几十个组件，内容相当之多，往往需要几年时间去熟悉其中的关键组件。而要想使用 Spring Cloud 作为完整的治理框架，则需要深入了解其中原理与实现，否则遇到问题还是很难定位。 治理功能不全。不同于 RPC 框架，Spring Cloud 作为治理全家桶的典型，也不是万能的，诸如协议转换支持、多重授权机制、动态请求路由、故障注入、灰度发布等高级功能并没有覆盖到。而这些功能往往是企业大规模落地不可获缺的功能，因此公司往往还需要投入其它人力进行相关功能的自研或者调研其它组件作为补充。  Service Mesh 服务网格 架构和概念 目的是解决系统架构微服务化后的服务间通信和治理问题。设计初衷是提供一种通用的服务治理方案。
Sidecar 在软件系统架构中特指边车模式。这个模式的灵感来源于我们生活中的边三轮：即在两轮摩托车的旁边添加一个边车的方式扩展现有的服务和功能。
这个模式的精髓在于实现了数据面（业务逻辑）和控制面的解耦：原来两轮摩托车的驾驶者集中注意力跑赛道，边车上的领航员专注周围信息和地图，专注导航。
Service Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的与应用逻辑服务部署在一起的服务代理，并且对于应用服务是透明的。
开源实现 第一代服务网格 Linkerd和Envoy Linkerd 使用Scala编写，是业界第一个开源的service mesh方案。作者 William Morgan 是 service mesh 的布道师和践行者。Envoy 基于C&#43;&#43; 11编写，无论是理论上还是实际上，后者性能都比 Linkderd 更好。这两个开源实现都是以 sidecar 为核心，绝大部分关注点都是如何做好proxy，并完成一些通用控制面的功能。 但是，当你在容器中大量部署 sidecar 以后，如何管理和控制这些 sidecar 本身就是一个不小的挑战。于是，第二代 Service Mesh 应运而生。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Eistio%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-12T17:38:42&#43;00:00" />
<meta property="article:modified_time" content="2022-01-12T17:38:42&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="基于Istio实现微服务治理"/>
<meta name="twitter:description" content="基于Istio实现微服务治理 微服务架构可谓是当前软件开发领域的技术热点，它在各种博客、社交媒体和会议演讲上的出镜率非常之高，无论是做基础架构还是做业务系统的工程师，对微服务都相当关注，而这个现象与热度到目前为止，已经持续了近 5 年之久。
尤其是近些年来，微服务架构逐渐发展成熟，从最初的星星之火到现在的大规模的落地与实践，几乎已经成为分布式环境下的首选架构。微服务成为时下技术热点，大量互联网公司都在做微服务架构的落地和推广。同时，也有很多传统企业基于微服务和容器，在做互联网技术转型。
而在这个技术转型中，国内有一个趋势，以 Spring Cloud 与 Dubbo 为代表的微服务开发框架非常普及和受欢迎。然而软件开发没有银弹，基于这些传统微服务框架构建的应用系统在享受其优势的同时，痛点也越加明显。这些痛点包括但不限于以下几点：
 侵入性强。想要集成 SDK 的能力，除了需要添加相关依赖，往往还需要在业务代码中增加一部分的代码、或注解、或配置；业务代码与治理层代码界限不清晰。 升级成本高。每次升级都需要业务应用修改 SDK 版本，重新进行功能回归测试，并且对每一台机器进行部署上线，而这对于业务方来说，与业务的快速迭代开发是有冲突的，大多不愿意停下来做这些与业务目标不太相关的事情。 版本碎片化严重。由于升级成本高，而中间件却不会停止向前发展的步伐，久而久之，就会导致线上不同服务引用的 SDK 版本不统一、能力参差不齐，造成很难统一治理。 中间件演变困难。由于版本碎片化严重，导致中间件向前演进的过程中就需要在代码中兼容各种各样的老版本逻辑，带着 “枷锁” 前行，无法实现快速迭代。 内容多、门槛高。Spring Cloud 被称为微服务治理的全家桶，包含大大小小几十个组件，内容相当之多，往往需要几年时间去熟悉其中的关键组件。而要想使用 Spring Cloud 作为完整的治理框架，则需要深入了解其中原理与实现，否则遇到问题还是很难定位。 治理功能不全。不同于 RPC 框架，Spring Cloud 作为治理全家桶的典型，也不是万能的，诸如协议转换支持、多重授权机制、动态请求路由、故障注入、灰度发布等高级功能并没有覆盖到。而这些功能往往是企业大规模落地不可获缺的功能，因此公司往往还需要投入其它人力进行相关功能的自研或者调研其它组件作为补充。  Service Mesh 服务网格 架构和概念 目的是解决系统架构微服务化后的服务间通信和治理问题。设计初衷是提供一种通用的服务治理方案。
Sidecar 在软件系统架构中特指边车模式。这个模式的灵感来源于我们生活中的边三轮：即在两轮摩托车的旁边添加一个边车的方式扩展现有的服务和功能。
这个模式的精髓在于实现了数据面（业务逻辑）和控制面的解耦：原来两轮摩托车的驾驶者集中注意力跑赛道，边车上的领航员专注周围信息和地图，专注导航。
Service Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的与应用逻辑服务部署在一起的服务代理，并且对于应用服务是透明的。
开源实现 第一代服务网格 Linkerd和Envoy Linkerd 使用Scala编写，是业界第一个开源的service mesh方案。作者 William Morgan 是 service mesh 的布道师和践行者。Envoy 基于C&#43;&#43; 11编写，无论是理论上还是实际上，后者性能都比 Linkderd 更好。这两个开源实现都是以 sidecar 为核心，绝大部分关注点都是如何做好proxy，并完成一些通用控制面的功能。 但是，当你在容器中大量部署 sidecar 以后，如何管理和控制这些 sidecar 本身就是一个不小的挑战。于是，第二代 Service Mesh 应运而生。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "基于Istio实现微服务治理",
      "item": "https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Eistio%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于Istio实现微服务治理",
  "name": "基于Istio实现微服务治理",
  "description": "基于Istio实现微服务治理 微服务架构可谓是当前软件开发领域的技术热点，它在各种博客、社交媒体和会议演讲上的出镜率非常之高，无论是做基础架构还是做业务系统的工程师，对微服务都相当关注，而这个现象与热度到目前为止，已经持续了近 5 年之久。\n尤其是近些年来，微服务架构逐渐发展成熟，从最初的星星之火到现在的大规模的落地与实践，几乎已经成为分布式环境下的首选架构。微服务成为时下技术热点，大量互联网公司都在做微服务架构的落地和推广。同时，也有很多传统企业基于微服务和容器，在做互联网技术转型。\n而在这个技术转型中，国内有一个趋势，以 Spring Cloud 与 Dubbo 为代表的微服务开发框架非常普及和受欢迎。然而软件开发没有银弹，基于这些传统微服务框架构建的应用系统在享受其优势的同时，痛点也越加明显。这些痛点包括但不限于以下几点：\n 侵入性强。想要集成 SDK 的能力，除了需要添加相关依赖，往往还需要在业务代码中增加一部分的代码、或注解、或配置；业务代码与治理层代码界限不清晰。 升级成本高。每次升级都需要业务应用修改 SDK 版本，重新进行功能回归测试，并且对每一台机器进行部署上线，而这对于业务方来说，与业务的快速迭代开发是有冲突的，大多不愿意停下来做这些与业务目标不太相关的事情。 版本碎片化严重。由于升级成本高，而中间件却不会停止向前发展的步伐，久而久之，就会导致线上不同服务引用的 SDK 版本不统一、能力参差不齐，造成很难统一治理。 中间件演变困难。由于版本碎片化严重，导致中间件向前演进的过程中就需要在代码中兼容各种各样的老版本逻辑，带着 “枷锁” 前行，无法实现快速迭代。 内容多、门槛高。Spring Cloud 被称为微服务治理的全家桶，包含大大小小几十个组件，内容相当之多，往往需要几年时间去熟悉其中的关键组件。而要想使用 Spring Cloud 作为完整的治理框架，则需要深入了解其中原理与实现，否则遇到问题还是很难定位。 治理功能不全。不同于 RPC 框架，Spring Cloud 作为治理全家桶的典型，也不是万能的，诸如协议转换支持、多重授权机制、动态请求路由、故障注入、灰度发布等高级功能并没有覆盖到。而这些功能往往是企业大规模落地不可获缺的功能，因此公司往往还需要投入其它人力进行相关功能的自研或者调研其它组件作为补充。  Service Mesh 服务网格 架构和概念 目的是解决系统架构微服务化后的服务间通信和治理问题。设计初衷是提供一种通用的服务治理方案。\nSidecar 在软件系统架构中特指边车模式。这个模式的灵感来源于我们生活中的边三轮：即在两轮摩托车的旁边添加一个边车的方式扩展现有的服务和功能。\n这个模式的精髓在于实现了数据面（业务逻辑）和控制面的解耦：原来两轮摩托车的驾驶者集中注意力跑赛道，边车上的领航员专注周围信息和地图，专注导航。\nService Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的与应用逻辑服务部署在一起的服务代理，并且对于应用服务是透明的。\n开源实现 第一代服务网格 Linkerd和Envoy Linkerd 使用Scala编写，是业界第一个开源的service mesh方案。作者 William Morgan 是 service mesh 的布道师和践行者。Envoy 基于C++ 11编写，无论是理论上还是实际上，后者性能都比 Linkderd 更好。这两个开源实现都是以 sidecar 为核心，绝大部分关注点都是如何做好proxy，并完成一些通用控制面的功能。 但是，当你在容器中大量部署 sidecar 以后，如何管理和控制这些 sidecar 本身就是一个不小的挑战。于是，第二代 Service Mesh 应运而生。",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "基于Istio实现微服务治理 微服务架构可谓是当前软件开发领域的技术热点，它在各种博客、社交媒体和会议演讲上的出镜率非常之高，无论是做基础架构还是做业务系统的工程师，对微服务都相当关注，而这个现象与热度到目前为止，已经持续了近 5 年之久。\n尤其是近些年来，微服务架构逐渐发展成熟，从最初的星星之火到现在的大规模的落地与实践，几乎已经成为分布式环境下的首选架构。微服务成为时下技术热点，大量互联网公司都在做微服务架构的落地和推广。同时，也有很多传统企业基于微服务和容器，在做互联网技术转型。\n而在这个技术转型中，国内有一个趋势，以 Spring Cloud 与 Dubbo 为代表的微服务开发框架非常普及和受欢迎。然而软件开发没有银弹，基于这些传统微服务框架构建的应用系统在享受其优势的同时，痛点也越加明显。这些痛点包括但不限于以下几点：\n 侵入性强。想要集成 SDK 的能力，除了需要添加相关依赖，往往还需要在业务代码中增加一部分的代码、或注解、或配置；业务代码与治理层代码界限不清晰。 升级成本高。每次升级都需要业务应用修改 SDK 版本，重新进行功能回归测试，并且对每一台机器进行部署上线，而这对于业务方来说，与业务的快速迭代开发是有冲突的，大多不愿意停下来做这些与业务目标不太相关的事情。 版本碎片化严重。由于升级成本高，而中间件却不会停止向前发展的步伐，久而久之，就会导致线上不同服务引用的 SDK 版本不统一、能力参差不齐，造成很难统一治理。 中间件演变困难。由于版本碎片化严重，导致中间件向前演进的过程中就需要在代码中兼容各种各样的老版本逻辑，带着 “枷锁” 前行，无法实现快速迭代。 内容多、门槛高。Spring Cloud 被称为微服务治理的全家桶，包含大大小小几十个组件，内容相当之多，往往需要几年时间去熟悉其中的关键组件。而要想使用 Spring Cloud 作为完整的治理框架，则需要深入了解其中原理与实现，否则遇到问题还是很难定位。 治理功能不全。不同于 RPC 框架，Spring Cloud 作为治理全家桶的典型，也不是万能的，诸如协议转换支持、多重授权机制、动态请求路由、故障注入、灰度发布等高级功能并没有覆盖到。而这些功能往往是企业大规模落地不可获缺的功能，因此公司往往还需要投入其它人力进行相关功能的自研或者调研其它组件作为补充。  Service Mesh 服务网格 架构和概念 目的是解决系统架构微服务化后的服务间通信和治理问题。设计初衷是提供一种通用的服务治理方案。\nSidecar 在软件系统架构中特指边车模式。这个模式的灵感来源于我们生活中的边三轮：即在两轮摩托车的旁边添加一个边车的方式扩展现有的服务和功能。\n这个模式的精髓在于实现了数据面（业务逻辑）和控制面的解耦：原来两轮摩托车的驾驶者集中注意力跑赛道，边车上的领航员专注周围信息和地图，专注导航。\nService Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的与应用逻辑服务部署在一起的服务代理，并且对于应用服务是透明的。\n开源实现 第一代服务网格 Linkerd和Envoy Linkerd 使用Scala编写，是业界第一个开源的service mesh方案。作者 William Morgan 是 service mesh 的布道师和践行者。Envoy 基于C++ 11编写，无论是理论上还是实际上，后者性能都比 Linkderd 更好。这两个开源实现都是以 sidecar 为核心，绝大部分关注点都是如何做好proxy，并完成一些通用控制面的功能。 但是，当你在容器中大量部署 sidecar 以后，如何管理和控制这些 sidecar 本身就是一个不小的挑战。于是，第二代 Service Mesh 应运而生。\n第二代服务网格 Istio Istio 是 Google 和 IBM 两位巨人联合 Lyft 的合作开源项目。是当前最主流的service mesh方案，也是事实上的第二代 service mesh 标准。\n安装Istio https://istio.io/latest/docs/setup/getting-started/\n下载 Istio 下载内容将包含：安装文件、示例和 istioctl 命令行工具。\n  访问 Istio release 页面下载与您操作系统对应的安装文件。在 macOS 或 Linux 系统中，也可以通过以下命令下载最新版本的 Istio：\n$ wget https://github.com/istio/istio/releases/download/1.7.3/istio-1.7.3-linux-amd64.tar.gz   解压并切换到 Istio 包所在目录下。例如：Istio 包名为 istio-1.7.3，则：\n$ tar zxf istio-1.7.3-linux-amd64.tar.gz $ ll istio-1.7.3 drwxr-x--- 2 root root 22 Sep 27 08:33 bin -rw-r--r-- 1 root root 11348 Sep 27 08:33 LICENSE drwxr-xr-x 6 root root 66 Sep 27 08:33 manifests -rw-r----- 1 root root 756 Sep 27 08:33 manifest.yaml -rw-r--r-- 1 root root 5756 Sep 27 08:33 README.md drwxr-xr-x 20 root root 330 Sep 27 08:33 samples drwxr-x--- 3 root root 133 Sep 27 08:33 tools   将 istioctl 客户端拷贝到 path 环境变量中\n$ cp bin/istioctl /bin/   配置命令自动补全\nistioctl 自动补全的文件位于 tools 目录。通过复制 istioctl.bash 文件到您的 home 目录，然后添加下行内容到您的 .bashrc 文件执行 istioctl tab 补全文件：\n$ cp tools/istioctl.bash ~ $ source ~/istioctl.bash   安装istio组件 https://istio.io/latest/zh/docs/setup/install/istioctl/#display-the-configuration-of-a-profile\n使用istioctl直接安装：\n$ istioctl install --set profile=demo ✔ Istio core installed ✔ Istiod installed ✔ Egress gateways installed ✔ Ingress gateways installed ✔ Installation complete  $ kubectl -n istio-system get po NAME READY STATUS RESTARTS AGE istio-egressgateway-7bf76dd59-n9t5l 1/1 Running 0 77s istio-ingressgateway-586dbbc45d-xphjb 1/1 Running 0 77s istiod-6cc5758d8c-pz28m 1/1 Running 0 84s istio针对不同的环境，提供了几种不同的初始化部署的profile\n# 查看提供的profile类型 $ istioctl profile list  # 获取kubernetes的yaml： $ istioctl manifest generate --set profile=demo  istio-kubernetes-manifest.yaml 卸载 $ istioctl manifest generate --set profile=demo | kubectl delete -f - 快速入门 场景一 模型图 资源清单 front-tomcat-dpl-v1.yaml\napiVersion: apps/v1 kind: Deployment metadata:  labels:  app: front-tomcat  version: v1  name: front-tomcat-v1  namespace: istio-demo spec:  replicas: 1  selector:  matchLabels:  app: front-tomcat  version: v1  template:  metadata:  labels:  app: front-tomcat  version: v1  spec:  containers:  - image: consol/tomcat-7.0:latest  name: front-tomcat bill-service-dpl-v1.yaml\napiVersion: apps/v1 kind: Deployment metadata:  labels:  service: bill-service  version: v1  name: bill-service-v1  namespace: istio-demo spec:  replicas: 1  selector:  matchLabels:  service: bill-service  version: v1  template:  metadata:  labels:  service: bill-service  version: v1  spec:  containers:  - image: nginx:alpine  name: bill-service  command: [\"/bin/sh\", \"-c\", \"echo 'this is bill-service-v1'/usr/share/nginx/html/index.html;nginx -g 'daemon off;'\"] bill-service-svc.yaml\napiVersion: v1 kind: Service metadata:  labels:  service: bill-service  name: bill-service  namespace: istio-demo spec:  ports:  - name: http  port: 9999  protocol: TCP  targetPort: 80  selector:  service: bill-service  type: ClusterIP 操作 $ kubectl create namespace istio-demo $ kubectl apply -f front-tomcat-dpl-v1.yaml $ kubectl apply -f bill-service-dpl-v1.yaml $ kubectl apply -f bill-service-svc.yaml  $ kubectl -n istio-demo exec front-tomcat-v1-548b46d488-r7wv8 -- curl -s bill-service this is bill-service-v1 场景二 后台账单服务更新v2版本，前期规划90%的流量访问v1版本，导入10%的流量到v2版本\n模型图 资源清单 新增bill-service-dpl-v2.yaml\napiVersion: apps/v1 kind: Deployment metadata:  labels:  service: bill-service  version: v2  name: bill-service-v2  namespace: istio-demo spec:  replicas: 1  selector:  matchLabels:  service: bill-service  version: v2  template:  metadata:  labels:  service: bill-service  version: v2  spec:  containers:  - image: nginx:alpine  name: bill-service  command: [\"/bin/sh\", \"-c\", \"echo 'hello, this is bill-service-v2'/usr/share/nginx/html/index.html;nginx -g 'daemon off;'\"] 此时，访问规则会按照v1和v2的pod各50%的流量分配。\n$ kubectl apply -f bill-service-dpl-v2.yaml $ kubectl -n istio-demo exec front-tomcat-v1-548b46d488-r7wv8 -- curl -s bill-service:9999 使用Istio 注入：\n$ istioctl kube-inject -f bill-service-dpl-v1.yaml|kubectl apply -f - $ istioctl kube-inject -f bill-service-dpl-v2.yaml|kubectl apply -f - $ istioctl kube-inject -f front-tomcat-dpl-v1.yaml|kubectl apply -f - 若想实现上述需求，需要解决如下两个问题：\n 让访问账单服务的流量按照我们期望的比例，其实是一条路由规则，如何定义这个规则 如何区分两个版本的服务  两个新的资源类型：VirtualService和DestinationRule\nbill-service-destnation-rule.yaml\napiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata:  name: dest-bill-service  namespace: istio-demo spec:  host: bill-service  subsets:  - name: v1  labels:  version: v1  - name: v2  labels:  version: v2 bill-service-virtualservice.yaml\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: vs-bill-service  namespace: istio-demo spec:  hosts:  - bill-service  http:  - name: bill-service-route  route:  - destination:  host: bill-service  subset: v1  weight: 90  - destination:  host: bill-service  subset: v2  weight: 10 使用client验证流量分配是否生效。\n$ kubectl apply -f bill-service-virtualservice.yaml $ kubectl apply -f bill-service-destnation-rule.yaml $ kubectl -n istio-demo exec front-tomcat-v1-78cf497978-ltxpf -c front-tomcat -- curl -s bill-service 服务网格细节剖析 执行的操作：\n 使用istioctl为pod注入了sidecar 创建了virtualservice和destinationrule  如何最终影响到了pod的访问行为？\n宏观角度 nginx的配置中，可以提供类似如下的配置片段实现按照权重的转发：\n因为nginx是代理层，可以转发请求，istio也实现了流量转发的效果，肯定也有代理层，并且识别了前面创建的虚拟服务中定义的规则。\n$ istioctl kube-inject -f front-tomcat-dpl-v1.yaml 可以看到注入后yaml中增加了很多内容：\npod被istio注入后，被纳入到服务网格中，每个pod都会添加一个名为istio-proxy的容器（常说的sidecar容器），istio-proxy容器中有两个进程，一个是piolot-agent，一个是envoy\n$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash # ps aux 目前已知：\n 在istio网格内，每个Pod都会被注入一个envoy代理 envoy充当nginx的角色，做为proxy代理，负责接管pod的入口和出口流量  目前，还需要搞清楚几个问题：\n istio-init初始化容器作用是什么？ istio-proxy如何接管业务服务的出入口流量？  认识envoy Envoy 是为云原生应用设计的代理。\n可以和nginx做类比： https://fuckcloudnative.io/posts/migrating-from-nginx-to-envoy/\n$ docker run -d --name envoy -v `pwd`/envoy.yaml:/etc/envoy/envoy.yaml -p 10000:10000 envoyproxy/envoy-alpine:v1.15.2  $ curl localhost:10000 envoy.yaml\nadmin:  access_log_path: /tmp/admin_access.log  address:  socket_address: { address: 127.0.0.1, port_value: 9901 }  static_resources:  listeners:  - name: listener_0  address:  socket_address: { address: 0.0.0.0, port_value: 10000 }  filter_chains:  - filters:  - name: envoy.http_connection_manager  config:  stat_prefix: ingress_http  codec_type: AUTO  route_config:  name: local_route  virtual_hosts:  - name: local_service  domains: [\"*\"]  routes:  - match: { prefix: \"/\" }  route: { cluster: some_service }  http_filters:  - name: envoy.router  clusters:  - name: some_service  connect_timeout: 2s  type: STATIC  lb_policy: ROUND_ROBIN  hosts: [{ socket_address: { address: 10.111.219.247, port_value: 9999 }}] 脑补一下网络代理程序的流程，比如作为一个代理，首先要能获取请求流量，通常是采用监听端口的方式实现；其次拿到请求数据后需要对其做微处理，例如附加 Header 或校验某个 Header 字段的内容等，这里针对来源数据的层次不同，可以分为 L3/L4/L7，然后将请求转发出去；转发这里又可以衍生出如果后端是一个集群，需要从中挑选一台机器，如何挑选又涉及到负载均衡等。\n listener : Envoy 的监听地址。Envoy 会暴露一个或多个 Listener 来监听客户端的请求。 filter : 过滤器。在 Envoy 中指的是一些“可插拔”和可组合的逻辑处理层，是 Envoy 核心逻辑处理单元。 route_config : 路由规则配置。即将请求路由到后端的哪个集群。 cluster : 服务提供方集群。Envoy 通过服务发现定位集群成员并获取服务，具体路由到哪个集群成员由负载均衡策略决定。  envoy的xDS Envoy的启动配置文件分为两种方式：静态配置和动态配置。\n 静态配置是将所有信息都放在配置文件中，启动的时候直接加载。 动态配置需要提供一个Envoy的服务端，用于动态生成Envoy需要的服务发现接口，这里叫XDS，通过发现服务来动态的调整配置信息，Istio就是实现了v2的API。  Envoy 接收到请求后，会先走 FilterChain，通过各种 L3/L4/L7 Filter 对请求进行微处理，然后再路由到指定的集群，并通过负载均衡获取一个目标地址，最后再转发出去。\n其中每一个环节可以静态配置，也可以动态服务发现，也就是所谓的 xDS。这里的 x 是一个代词，类似云计算里的 XaaS 可以指代 IaaS、PaaS、SaaS 等。\n所以，envoy的架构大致的样子如下：\nDownstream\n下游（downstream）主机连接到 Envoy，发送请求并或获得响应。\nUpstream\n上游（upstream）主机获取来自 Envoy 的链接请求和响应。\n监听器\n 除了过滤器链之外，还有一种过滤器叫监听器过滤器（Listener filters），它会在过滤器链之前执行，用于操纵连接的元数据。这样做的目的是，无需更改 Envoy 的核心代码就可以方便地集成更多功能。 每个监听器都可以配置多个过滤器链（Filter Chains），监听器会根据 filter_chain_match 中的匹配条件将流量转交到对应的过滤器链，其中每一个过滤器链都由一个或多个网络过滤器（Network filters）组成。这些过滤器用于执行不同的代理任务，如速率限制，TLS 客户端认证，HTTP 连接管理，MongoDB 嗅探，原始 TCP 代理等。  envoy在微服务治理中的工作环境 可以在服务旁运行，以平台无关的方式提供必要的特性，所有到服务的流量都通过 Envoy 代理，这里 Envoy 扮演的就是 Sidecar 的角色。\n针对于k8s的pod来讲：\n在istio中，envoy的位置：\n很明显，istio中，envoy进行流量治理，更多的使用的是XDS进行配置更新，而我们知道，XDS需要有服务端来提供接口，istiod中的pilot组件则提供了xDS服务端接口的实现 。\n工作原理 目前为止，我们可以知道大致的工作流程：\n 用户端，通过创建服务治理的规则（VirtualService、DestinationRule等资源类型），存储到ETCD中 istio控制平面中的Pilot服务监听上述规则，转换成envoy可读的规则配置，通过xDS接口同步给各envoy envoy通过xDS获取最新的配置后，动态reload，进而改变流量转发的策略  思考两个问题：\n istio中envoy的动态配置到底长什么样子？ 在istio的网格内，front-tomcat访问到bill-service，流量的流向是怎么样的？  针对问题1：\n每个envoy进程启动的时候，会在127.0.0.1启动监听15000端口\n$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash # netstat -nltp # curl localhost:15000/help # curl localhost:15000/config_dump 针对问题2：\n$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash # curl bill-service:9999 按照之前的认知，\n现在为什么流量分配由5：5 变成了9：1？流量经过envoy了的处理\nenvoy如何接管由front-tomcat容器发出的请求流量？（istio-init\n回顾iptables：\nIstio 给应用 Pod 注入的配置主要包括：\n  Init 容器 istio-init\nIstio 在 pod 中注入的 Init 容器名为 istio-init，作用是为 pod 设置 iptables 端口转发。\n我们在上面 Istio 注入完成后的 YAML 文件中看到了该容器的启动命令是：\nistio-iptables -p 15001 -z 15006 -u 1337 -m REDIRECT -i '*' -x \"\" -b '*' -d 15090,15021,15020 Init 容器的启动入口是 istio-iptables 命令行，该命令行工具的用法如下：\n$ istio-iptables [flags]  -p: 指定重定向所有 TCP 出站流量的 sidecar 端口（默认为 $ENVOY_PORT = 15001）  -m: 指定入站连接重定向到 sidecar 的模式，“REDIRECT” 或 “TPROXY”（默认为 $ISTIO_INBOUND_INTERCEPTION_MODE)  -b: 逗号分隔的入站端口列表，其流量将重定向到 Envoy（可选）。使用通配符 “*” 表示重定向所有端口。为空时表示禁用所有入站重定向（默认为 $ISTIO_INBOUND_PORTS）  -d: 指定要从重定向到 sidecar 中排除的入站端口列表（可选），以逗号格式分隔。使用通配符“*” 表示重定向所有入站流量（默认为 $ISTIO_LOCAL_EXCLUDE_PORTS）  -o：逗号分隔的出站端口列表，不包括重定向到 Envoy 的端口。  -i: 指定重定向到 sidecar 的 IP 地址范围（可选），以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量。空列表将禁用所有出站重定向（默认为 $ISTIO_SERVICE_CIDR）  -x: 指定将从重定向中排除的 IP 地址范围，以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量（默认为 $ISTIO_SERVICE_EXCLUDE_CIDR）。  -k：逗号分隔的虚拟接口列表，其入站流量（来自虚拟机的）将被视为出站流量。  -g：指定不应用重定向的用户的 GID。(默认值与 -u param 相同)  -u：指定不应用重定向的用户的 UID。通常情况下，这是代理容器的 UID（默认值是 1337，即 istio-proxy 的 UID）。  -z: 所有进入 pod/VM 的 TCP 流量应被重定向到的端口（默认 $INBOUND_CAPTURE_PORT = 15006）。 以上传入的参数都会重新组装成 iptables 规则，关于 Istio 中端口用途请参考 Istio 官方文档。\n这条启动命令的作用是：\n 将应用容器的所有入站流量都转发到 envoy的 15006 端口（15090 端口（Envoy Prometheus telemetry）和 15020 端口（Ingress Gateway）除外，15021（sidecar健康检查）端口） 将所有出站流量都重定向到 sidecar 代理（通过 15001 端口） 上述规则对id为1337用户除外，因为1337是istio-proxy自身的流量  该容器存在的意义就是让 sidecar 代理可以拦截pod所有的入站（inbound）流量以及出站（outbound）流量，这样就可以实现由sidecar容器来接管流量，进尔实现流量管控。\n因为 Init 容器初始化完毕后就会自动终止，因为我们无法登陆到容器中查看 iptables 信息，但是 Init 容器初始化结果会保留到应用容器和 sidecar 容器中。\n# 查看front-tomcat服务的istio-proxy容器的id $ docker ps |grep front-tomcat d02fa8217f2f consol/tomcat-7.0 \"/bin/sh -c /opt/tom…\" 2 days ago Up 2 days  k8s_front-tomcat_front-tomcat-v1-78cf497978-ppwwk_istio-demo_f03358b1-ed17-4811-ac7e-9f70e6bd797b_0  # 根据容器id获取front-tomcat容器在宿主机中的进程 $ docker inspect d02fa8217f2f|grep -i pid  \"Pid\": 28834,  \"PidMode\": \"\",  \"PidsLimit\": null, # 进入该进程的网络命名空间 $ nsenter -n --target 28834 # 查看命名空间的iptables规则 $ iptables -t nat -vnL # PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。 Chain PREROUTING (policy ACCEPT 148 packets, 8880 bytes)  pkts bytes target prot opt in out source destination  148 8880 ISTIO_INBOUND tcp -- * * 0.0.0.0/0 0.0.0.0/0  # INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。 Chain INPUT (policy ACCEPT 148 packets, 8880 bytes)  pkts bytes target prot opt in out source destination  # OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。 Chain OUTPUT (policy ACCEPT 46 packets, 3926 bytes)  pkts bytes target prot opt in out source destination  8 480 ISTIO_OUTPUT tcp -- * * 0.0.0.0/0 0.0.0.0/0 # POSTROUTING 链：所有数据包流出网卡时都要先进入POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。 Chain POSTROUTING (policy ACCEPT 46 packets, 3926 bytes)  pkts bytes target prot opt in out source destination  # ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上，目的地为 15090，15020，15021端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING。 Chain ISTIO_INBOUND (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15008  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:22  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15090  143 8580 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15021  5 300 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15020  0 0 ISTIO_IN_REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0  # ISTIO_IN_REDIRECT 链：将所有入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到sidecar中。 Chain ISTIO_IN_REDIRECT (3 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0 redir ports 15006  # ISTIO_OUTPUT 链：选择需要重定向到 Envoy（即本地） 的出站流量，所有非 localhost 的流量全部转发到 ISTIO_REDIRECT。为了避免流量在该 Pod 中无限循环，所有到 istio-proxy 用户空间的流量都返回到它的调用点中的下一条规则，本例中即 OUTPUT 链，因为跳出 ISTIO_OUTPUT 规则之后就进入下一条链 POSTROUTING。如果目的地非 localhost 就跳转到 ISTIO_REDIRECT；如果流量是来自 istio-proxy 用户空间的，那么就跳出该链，返回它的调用链继续执行下一条规则（OUTPUT 的下一条规则，无需对流量进行处理）；所有的非 istio-proxy 用户空间的目的地是 localhost 的流量就跳转到 ISTIO_REDIRECT。 Chain ISTIO_OUTPUT (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN all -- * lo 127.0.0.6 0.0.0.0/0  0 0 ISTIO_IN_REDIRECT all -- * lo 0.0.0.0/0 !127.0.0.1 owner UID match 1337  0 0 RETURN all -- * lo 0.0.0.0/0 0.0.0.0/0 ! owner UID match 1337  8 480 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 owner UID match 1337  0 0 ISTIO_IN_REDIRECT all -- * lo 0.0.0.0/0 !127.0.0.1 owner GID match 1337  0 0 RETURN all -- * lo 0.0.0.0/0 0.0.0.0/0 ! owner GID match 1337  0 0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 owner GID match 1337  0 0 RETURN all -- * * 0.0.0.0/0 127.0.0.1  0 0 ISTIO_REDIRECT all -- * * 0.0.0.0/0 0.0.0.0/0  # ISTIO_REDIRECT 链：将所有流量重定向到 Sidecar（即本地） 的 15001 端口。 Chain ISTIO_REDIRECT (1 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0 redir ports 15001   $ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash istio-proxy@front-tomcat-v1-78cf497978-ppwwk:/$ netstat -nltp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:15000 0.0.0.0:* LISTEN 16/envoy tcp 0 0 0.0.0.0:15001 0.0.0.0:* LISTEN 16/envoy tcp 0 0 0.0.0.0:15006 0.0.0.0:* LISTEN 16/envoy tcp 0 0 127.0.0.1:8005 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:8009 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:8778 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:15021 0.0.0.0:* LISTEN 16/envoy tcp 0 0 0.0.0.0:8080 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:15090 0.0.0.0:* LISTEN 16/envoy tcp6 0 0 :::15020 :::* LISTEN 1/pilot-agent 说明pod内的出站流量请求被监听在15001端口的envoy的进程接收到，进而就走到了envoy的Listener - route - cluster - endpoint 转发流程。\n问题就转变为：如何查看envoy的配置，跟踪转发的过程？\n调试envoy 我们知道，envoy的配置非常复杂，直接在config_dump里去跟踪xDS的过程非常繁琐。因此istio提供了调试命令，方便查看envoy的流量处理流程。\n$ istioctl proxy-config -h 比如，通过如下命令可以查看envoy的监听器：\n# 查看15001的监听 $ istioctl proxy-config listener front-tomcat-v1-78cf497978-vv9wj.istio-demo --port 15001 -ojson # virtualOutbound的监听不做请求处理，hiddenEnvoyDeprecatedUseOriginalDst: true, 直接转到原始的请求对应的监听器中  # 查看访问端口是9999的监听器 $ istioctl proxy-config listener front-tomcat-v1-78cf497978-ppwwk.istio-demo --port 9999 -ojson ...  {  \"name\": \"0.0.0.0_9999\",  \"address\": {  \"socketAddress\": {  \"address\": \"0.0.0.0\",  \"portValue\": 9999  }  },  \"filterChains\": [  {  \"filterChainMatch\": {  \"applicationProtocols\": [  \"http/1.0\",  \"http/1.1\",  \"h2c\"  ]  },  \"filters\": [  {  \"name\": \"envoy.filters.network.http_connection_manager\",  \"typedConfig\": {  \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\",  \"statPrefix\": \"outbound_0.0.0.0_9999\",  \"rds\": {  \"configSource\": {  \"ads\": {},  \"resourceApiVersion\": \"V3\"  },  \"routeConfigName\": \"9999\"  }, ...  envoy收到请求后，会转给监听器进行处理请求，监听器先匹配address和port和socket都一致的Listener，如果没找到再找port一致，address==0.0.0.0的Listener\n 发现istio会为网格内的Service Port创建名为0.0.0.0_的虚拟监听器，本例中为0.0.0.0_9999。\nenvoy的15001端口收到请求后，直接转到了0.0.0.0_9999，进而转到了\"routeConfigName\": \"9999\"，即9999这个route中。\n下面，看下route的内容：\n$ istioctl pc route front-tomcat-v1-78cf497978-ppwwk.istio-demo --name 9999 NOTE: This output only contains routes loaded via RDS. NAME DOMAINS MATCH VIRTUAL SERVICE 9999 bill-service /* vs-bill-service.istio-demo  # 发现了前面创建的virtual service $ istioctl pc route front-tomcat-v1-78cf497978-ppwwk.istio-demo --name 9999 -ojson [  {  \"name\": \"9999\",  \"virtualHosts\": [  {  \"name\": \"allow_any\",  \"domains\": [  \"*\"  ],  \"routes\": [  {  \"name\": \"allow_any\",  \"match\": {  \"prefix\": \"/\"  },  \"route\": {  \"cluster\": \"PassthroughCluster\",  \"timeout\": \"0s\",  \"maxGrpcTimeout\": \"0s\"  }  }  ],  \"includeRequestAttemptCount\": true  },  {  \"name\": \"bill-service.istio-demo.svc.cluster.local:9999\",  \"domains\": [  \"bill-service.istio-demo.svc.cluster.local\",  \"bill-service.istio-demo.svc.cluster.local:9999\",  \"bill-service\",  \"bill-service:9999\",  \"bill-service.istio-demo.svc.cluster\",  \"bill-service.istio-demo.svc.cluster:9999\",  \"bill-service.istio-demo.svc\",  \"bill-service.istio-demo.svc:9999\",  \"bill-service.istio-demo\",  \"bill-service.istio-demo:9999\",  \"10.111.219.247\",  \"10.111.219.247:9999\"  ],  \"routes\": [  {  \"name\": \"bill-service-route\",  \"match\": {  \"prefix\": \"/\"  },  \"route\": {  \"weightedClusters\": {  \"clusters\": [  {  \"name\": \"outbound|9999|v1|bill-service.istio-demo.svc.cluster.local\",  \"weight\": 90  },  {  \"name\": \"outbound|9999|v2|bill-service.istio-demo.svc.cluster.local\",  \"weight\": 10  }  ]  }, ... 满足访问domains列表的会优先匹配到，我们访问的是10.111.219.247:9999，因此匹配bill-service.istio-demo.svc.cluster.local:9999这组虚拟hosts，进而使用到基于weight的集群配置。\n我们看到，流量按照预期的配置进行了转发：\n90% - outbound|9999|v1|bill-service.istio-demo.svc.cluster.local 10% - outbound|9999|v2|bill-service.istio-demo.svc.cluster.local 下面，看一下cluster的具体内容：\n$ istioctl pc cluster front-tomcat-v1-78cf497978-ppwwk.istio-demo --fqdn bill-service.istio-demo.svc.cluster.local -ojson ...  \"name\": \"outbound|9999|v1|bill-service.istio-demo.svc.cluster.local\",  \"type\": \"EDS\",  \"edsClusterConfig\": {  \"edsConfig\": {  \"ads\": {},  \"resourceApiVersion\": \"V3\"  },  \"serviceName\": \"outbound|9999|v1|bill-service.istio-demo.svc.cluster.local\"  }, ... 我们发现，endpoint列表是通过eds获取的，因此，查看endpoint信息：\n$ istioctl pc endpoint front-tomcat-v1-78cf497978-ppwwk.istio-demo --cluster 'outbound|9999|v1|bill-service.istio-demo.svc.cluster.local' -ojson [  {  \"name\": \"outbound|9999|v1|bill-service.istio-demo.svc.cluster.local\",  \"addedViaApi\": true,  \"hostStatuses\": [  {  \"address\": {  \"socketAddress\": {  \"address\": \"10.244.0.17\",  \"portValue\": 80  }  }, ... 目前为止，经过envoy的规则，流量从front-tomcat的pod中知道要发往10.244.0.7:80 这个pod地址。前面提到过，envoy不止接管出站流量，入站流量同样会接管。\n下面看下流量到达bill-service-v1的pod后的处理：\n先回顾前面的iptables规则，除特殊情况以外，所有的出站流量被监听在15001端口的envoy进程拦截处理，同样的，分析bill-service-v1的iptables规则可以发现，监听在15006端口的envoy进程通过在PREROUTING链上添加规则，同样将进入pod的入站流量做了拦截。\n# PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。 Chain PREROUTING (policy ACCEPT 148 packets, 8880 bytes)  pkts bytes target prot opt in out source destination  148 8880 ISTIO_INBOUND tcp -- * * 0.0.0.0/0 0.0.0.0/0  # INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。 Chain INPUT (policy ACCEPT 148 packets, 8880 bytes)  pkts bytes target prot opt in out source destination  # ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上，目的地为 15090，15020，15021端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING。 Chain ISTIO_INBOUND (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15008  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:22  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15090  143 8580 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15021  5 300 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15020  0 0 ISTIO_IN_REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0  # ISTIO_IN_REDIRECT 链：将所有入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到sidecar中。 Chain ISTIO_IN_REDIRECT (3 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0 redir ports 15006 15006端口是一个名为 virtualInbound虚拟入站监听器，\n$ istioctl pc l bill-service-v1-6c95ccb747-vwt2d.istio-demo --port 15006 -ojson/tmp/15006.inbound.json 相比于VirtualOutbound， virtualInbound 不会再次转给别的虚拟监听器，而是直接由本监听器的filterChains处理，本例中我们可以发现本机目标地址为80的http请求，转发到了inbound|9999|http|bill-service.istio-demo.svc.cluster.local这个集群中。\n查看该集群的信息：\n$ istioctl pc cluster bill-service-v1-6c95ccb747-vwt2d.istio-demo -h $ istioctl pc cluster bill-service-v1-6c95ccb747-vwt2d.istio-demo --direction inbound -ojson [  {  \"name\": \"inbound|9999|http|bill-service.istio-demo.svc.cluster.local\",  \"type\": \"STATIC\",  \"connectTimeout\": \"10s\",  \"loadAssignment\": {  \"clusterName\": \"inbound|9999|http|bill-service.istio-demo.svc.cluster.local\",  \"endpoints\": [  {  \"lbEndpoints\": [  {  \"endpoint\": {  \"address\": {  \"socketAddress\": {  \"address\": \"127.0.0.1\",  \"portValue\": 80  }  }  }  }  ]  }  ]  },  \"circuitBreakers\": {  \"thresholds\": [  {  \"maxConnections\": 4294967295,  \"maxPendingRequests\": 4294967295,  \"maxRequests\": 4294967295,  \"maxRetries\": 4294967295  }  ]  }  } ] 一点小知识 同一个Pod，不同的表现\n$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash # curl bill-service:9999  $ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash # curl bill-service:9999 可以发现，在front-tomcat中的访问请求，是受到我们设置的 9：1的流量分配规则限制的，但是istio-proxy中的访问是不受限制的。\n istio-proxy自身，发起的往10.244.0.17的请求，使用的用户是 uid=1337(istio-proxy)，因此不会被istio-init初始化的防火墙规则拦截，可以直接走pod的网络进行通信。\n istio服务网格内，流量请求完全绕过了kube-proxy组件\n通过上述流程调试，我们可以得知，front-tomcat中访问bill-service:9999，流量是没有用到kube-proxy维护的宿主机中的iptables规则的。\n验证一下：\n# 停掉kube-proxy $ kubectl -n kube-system edit daemonset kube-proxy ...  dnsPolicy: ClusterFirst  hostNetwork: true  nodeSelector:  beta.kubernetes.io/os: linux1 #把此处修改一个不存在的label值   priorityClassName: system-node-critical ...  #清理iptables规则 $ iptables -F -t nat  # 访问测试 $ kubectl -n istio-demo get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE bill-service ClusterIP 10.111.219.247  9999/TCP 2d18h $ curl 10.111.219.247:9999  # 进入front-tomcat容器进行访问 $ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash # curl 10.111.219.247:9999  # curl bill-service:9999 会因为dns解析失败而访问失败，手动配置namespaceserver即可  $ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash # curl curl 10.111.219.247:9999  集群内的Service都相应的创建了虚拟出站监听器\n$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash # curl sonarqube.jenkins:9000  $ istioctl pc l front-tomcat-v1-78cf497978-ppwwk.istio-demo --port 9000 ADDRESS PORT MATCH DESTINATION 10.97.243.33 9000 App: HTTP Route: sonarqube.jenkins.svc.cluster.local:9000 10.97.243.33 9000 ALL Cluster: outbound|9000||sonarqube.jenkins.svc.cluster.local  $ istioctl pc r front-tomcat-v1-78cf497978-ppwwk.istio-demo --name 'sonarqube.jenkins.svc.cluster.local:9000'  $ istioctl pc ep front-tomcat-v1-78cf497978-ppwwk.istio-demo --cluster 'outbound|9000||sonarqube.jenkins.svc.cluster.local' virtualOutBound 15001 – virtial listener 10.97.243.33_9000 – route sonarqube.jenkins.svc.cluster.local:9000 – cluster outbound|9000||sonarqube.jenkins.svc.cluster.local – 10.244.1.13:9000\n场景三 模型图 资源清单 front-tomcat-service.yaml\napiVersion: v1 kind: Service metadata:  labels:  app: front-tomcat  name: front-tomcat  namespace: istio-demo spec:  ports:  - name: http  port: 8080  protocol: TCP  targetPort: 8080  selector:  app: front-tomcat  type: ClusterIP front-tomcat-v2-dpl.yaml\napiVersion: apps/v1 kind: Deployment metadata:  labels:  app: front-tomcat  version: v2  name: front-tomcat-v2  namespace: istio-demo spec:  replicas: 1  selector:  matchLabels:  app: front-tomcat  version: v2  template:  metadata:  labels:  app: front-tomcat  version: v2  spec:  containers:  - image: consol/tomcat-7.0:latest  name: front-tomcat  command: [\"/bin/sh\", \"-c\", \"echo 'hello tomcat version2'/opt/tomcat/webapps/ROOT/index.html;/opt/tomcat/bin/deploy-and-run.sh;\"] front-tomcat-virtualservice.yaml\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: front-tomcat  namespace: istio-demo spec:  hosts:  - front-tomcat  http:  - name: front-tomcat-route  route:  - destination:  host: front-tomcat  subset: v1  weight: 90  - destination:  host: front-tomcat  subset: v2  weight: 10 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata:  name: front-tomcat  namespace: istio-demo spec:  host: front-tomcat  subsets:  - name: v1  labels:  version: v1  - name: v2  labels:  version: v2 $ kubectl apply -f front-tomcat-service.yaml $ kubectl apply -f -f front-tomcat-v2-dpl.yaml) $ kubectl apply -f front-tomcat-virtualservice.yaml 使用ingress来访问网格服务 front-tomcat-ingress.yaml\napiVersion: extensions/v1beta1 kind: Ingress metadata:  name: front-tomcat  namespace: istio-demo spec:  rules:  - host: tomcat.istio-demo.com  http:  paths:  - backend:  serviceName: front-tomcat  servicePort: 8080  path: / status:  loadBalancer: {} 使用浏览器访问查看效果。\n只有网格内部访问会遵从virtualservice的规则，在宿主机中直接访问Service的ClusterIP还是按照默认的规则转发。\nIngress：对接ingress controller，实现外部流量进入集群内部，只适用于 HTTP 流量，使用方式也很简单，只能对 service、port、HTTP 路径等有限字段匹配来路由流量，这导致它无法路由如 MySQL、Redis 和各种私有 RPC 等 TCP 流量。要想直接路由南北向的流量，只能使用 Service 的 LoadBalancer 或 NodePort，前者需要云厂商支持，后者需要进行额外的端口管理。有些 Ingress controller 支持暴露 TCP 和 UDP 服务，但是只能使用 Service 来暴露，Ingress 本身是不支持的，例如 nginx ingress controller，服务暴露的端口是通过创建 ConfigMap 的方式来配置的。\ningressgateway访问网格服务 对于入口流量管理，您可能会问： 为什么不直接使用 Kubernetes Ingress API ？ 原因是 Ingress API 无法表达 Istio 的路由需求。 Ingress 试图在不同的 HTTP 代理之间取一个公共的交集，因此只能支持最基本的 HTTP 路由，最终导致需要将代理的其他高级功能放入到注解（annotation）中，而注解的方式在多个代理之间是不兼容的，无法移植。\nIstio Gateway 通过将 L4-L6 配置与 L7 配置分离的方式克服了 Ingress 的这些缺点。 Gateway 只用于配置 L4-L6 功能（例如，对外公开的端口，TLS 配置），所有主流的L7代理均以统一的方式实现了这些功能。 然后，通过在 Gateway 上绑定 VirtualService 的方式，可以使用标准的 Istio 规则来控制进入 Gateway 的 HTTP 和 TCP 流量。\nfront-tomcat-gateway.yaml\napiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata:  name: front-tomcat-gateway  namespace: istio-demo spec:  selector:  istio: ingressgateway # use istio default controller  servers:  - port:  number: 80  name: http  protocol: HTTP  hosts:  - tomcat.istio-demo.com 效果是在Istio的ingress网关上加了一条规则，允许``tomcat.istio-demo.com` 的外部http流量进入到网格中，但是只是接受访问和流量输入，当流量到达这个网关时，它还不知道发送到哪里去。\n网关已准备好接收流量，我们必须告知它将收到的流量发往何处，这就用到了前面使用过的VirtualService。\n要为进入上面的 Gateway 的流量配置相应的路由，必须为同一个 host 定义一个 VirtualService，并使用配置中的 gateways 字段绑定到前面定义的 Gateway 上\nfront-tomcat-gateway-virtualservice.yaml\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: gateway-front-tomcat  namespace: istio-demo spec:  gateways:  - front-tomcat-gateway  hosts:  - tomcat.istio-demo.com  http:  - name: front-tomcat-route  route:  - destination:  host: front-tomcat  subset: v1  weight: 90  - destination:  host: front-tomcat  subset: v2  weight: 10 该网关列表指定，只有通过我们指定的网关 front-tomcat-gateway 的流量是允许的。所有其他外部请求将被拒绝，并返回 404 响应。\n 请注意，在此配置中，来自网格中其他服务的内部请求不受这些规则约束\n $ kubectl apply -f front-tomcat-gateway-virtualservice.yaml $ kubectl apply -f front-tomcat-gateway.yaml 模拟访问：\n$ kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==\"http2\")].nodePort}' 31995 $ curl -HHost:tomcat.istio-demo.com 172.21.51.67:31995/ 172.21.51.67:31995地址从何而来？\n浏览器访问: http://tomcat.istio-demo.com:31995/\n如何实现不加端口访问网格内服务？\n# 在一台80端口未被占用的机器中，如ip为172.21.51.69 $ docker run -d --restart=always -p 80:80 --name istio-nginx nginx:alpine  # 在容器的/etc/nginx/conf.d/目录中，新增配置文件 $ cat front-tomcat.conf upstream front-tomcat {  server 172.21.51.67:31995; } server {  listen 80;  listen [::]:80;  server_name tomcat.istio-demo.com;   location / {  proxy_set_header Host $host;  proxy_set_header X-Real-IP $remote_addr;  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  proxy_http_version 1.1;  proxy_pass http://front-tomcat;  } }  $ nginx -s reload 本地配置hosts\n172.21.51.69 tomcat.istio-demo.com 直接访问http://tomcat.istio-demo.com 即可实现外部域名访问到网格内部服务\n实例演示 实例介绍 创建bookinfo实例：\n$ kubectl create namespace bookinfo $ kubectl -n bookinfo create -f samples/bookinfo/platform/kube/bookinfo.yaml $ kubectl -n bookinfo get po NAME READY STATUS RESTARTS AGE details-v1-5974b67c8-wclnd 1/1 Running 0 34s productpage-v1-64794f5db4-jsdbg 1/1 Running 0 33s ratings-v1-c6cdf8d98-jrfrn 1/1 Running 0 33s reviews-v1-7f6558b974-kq6kj 1/1 Running 0 33s reviews-v2-6cb6ccd848-qdg2k 1/1 Running 0 34s reviews-v3-cc56b578-kppcx 1/1 Running 0 34s 该应用由四个单独的微服务构成。 这个应用模仿在线书店的一个分类，显示一本书的信息。 页面上会显示一本书的描述，书籍的细节（ISBN、页数等），以及关于这本书的一些评论。\nBookinfo 应用分为四个单独的微服务：\n productpage. 这个微服务会调用 details 和 reviews 两个微服务，用来生成页面。 details. 这个微服务中包含了书籍的信息。 reviews. 这个微服务中包含了书籍相关的评论。它还会调用 ratings 微服务。 ratings. 这个微服务中包含了由书籍评价组成的评级信息。  reviews 微服务有 3 个版本：\n  v1 版本不会调用 ratings 服务。\n  v2 版本会调用 ratings 服务，并使用 1 到 5 个黑色星形图标来显示评分信息。\n  v3 版本会调用 ratings 服务，并使用 1 到 5 个红色星形图标来显示评分信息。\n  Bookinfo 是一个异构应用，几个微服务是由不同的语言编写的。这些服务对 Istio 并无依赖，但是构成了一个有代表性的服务网格的例子：它由多个服务、多个语言构成，并且 reviews 服务具有多个版本。\n使用ingress访问productpage服务：\ningress-productpage.yaml\napiVersion: extensions/v1beta1 kind: Ingress metadata:  name: productpage  namespace: bookinfo spec:  rules:  - host: productpage.bookinfo.com  http:  paths:  - backend:  serviceName: productpage  servicePort: 9080  path: / status:  loadBalancer: {} 如何实现更细粒度的流量管控？\n注入sidecar容器 如何注入sidecar容器   使用istioctl kube-inject\n$ kubectl -n bookinfo apply -f -f samples/bookinfo/platform/kube/bookinfo.yaml)   为命名空间打label\n# 给命名空间打标签，这样部署在该命名空间的服务会自动注入sidecar容器 $ kubectl label namespace dafault istio-injection=enabled   注入bookinfo $ kubectl -n bookinfo apply -f -f samples/bookinfo/platform/kube/bookinfo.yaml) 流量路由 实现ingress解决不了的按照比例分配流量\ningress-gateway访问productpage productpage-gateway.yaml\napiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata:  name: productpage-gateway  namespace: bookinfo spec:  selector:  istio: ingressgateway # use istio default controller  servers:  - port:  number: 80  name: http  protocol: HTTP  hosts:  - productpage.bookinfo.com productpage-virtualservice.yaml\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: gateway-front-tomcat  namespace: bookinfo spec:  gateways:  - productpage-gateway  hosts:  - productpage.bookinfo.com  http:  - route:  - destination:  host: productpage  port:  number: 9080 配置nginx，使用域名80端口访问。\nupstream bookinfo-productpage {  server 172.21.51.67:31995; } server {  listen 80;  listen [::]:80;  server_name productpage.bookinfo.com;   location / {  proxy_set_header Host $host;  proxy_set_header X-Real-IP $remote_addr;  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  proxy_http_version 1.1;  proxy_pass http://bookinfo-productpage;  } } 权重路由 只想访问reviews-v3\n$ cat virtual-service-reviews-v3.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: reviews  namespace: bookinfo spec:  hosts:  - reviews  http:  - route:  - destination:  host: reviews  subset: v3  $ cat destination-rule-reviews.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata:  name: reviews  namespace: bookinfo spec:  host: reviews  trafficPolicy:  loadBalancer:  simple: RANDOM  subsets:  - name: v1  labels:  version: v1  - name: v2  labels:  version: v2  - name: v3  labels:  version: v3  $ kubectl apply -f virtual-service-reviews-v3.yaml  # 访问productpage测试 实现如下流量分配：\n90% - reivews-v1 10% - reviews-v2 0% - reviews-v3 $ cat virtual-service-reviews-90-10.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: reviews  namespace: bookinfo spec:  hosts:  - reviews  http:  - route:  - destination:  host: reviews  subset: v1  weight: 90  - destination:  host: reviews  subset: v2  weight: 10  $ kubectl apply -f virtual-service-reviews-90-10.yaml  # 假如v2版本的副本数扩容为3，v2版本的流量会如何分配？ 会不会变成30%？ $ kubectl -n bookinfo scale deploy reviews-v2 --replicas=3 访问路径路由 实现效果如下：\n# 定义允许外部流量进入网格,直接编辑已有gateway $ kubectl -n bookinfo edit gw productpage-gateway  $ cat bookinfo-routing-with-uri-path.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: bookinfo  namespace: bookinfo spec:  gateways:  - productpage-gateway  hosts:  - bookinfo.com  http:  - name: productpage-route  match:  - uri:  prefix: /productpage  route:  - destination:  host: productpage  - name: reviews-route  match:  - uri:  prefix: /reviews  route:  - destination:  host: reviews  - name: ratings-route  match:  - uri:  prefix: /ratings  route:  - destination:  host: ratings nginx中新增配置：\nupstream bookinfo {  server 172.21.51.67:31995; } server {  listen 80;  listen [::]:80;  server_name bookinfo.com;   location / {  proxy_set_header Host $host;  proxy_set_header X-Real-IP $remote_addr;  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  proxy_http_version 1.1;  proxy_pass http://bookinfo;  } } 访问：\nhttp://bookinfo.com/productpage\nhttp://bookinfo.com/ratings/1\n实际的访问对应为：\nbookinfo.com/productpage - productpage:8090/productpage bookinfo.com/ratings - ratings:9080/ratings bookinfo.com/reviews - reviews:9080/reviews 实际访问productpage页面，由于需要引用css、js等静态资源，因此需要补充对/static路径的转发：\n...  http:  - name: productpage-route  match:  - uri:  prefix: /productpage  - uri:  prefix: /static  route:  - destination:  host: productpage ... virtualservice的配置中并未指定service的port端口，转发同样可以生效？\n 注意，若service中只有一个端口，则不用显式指定端口号，会自动转发到该端口中\n 路径重写 如果想实现rewrite的功能，\nbookinfo.com/rate - ratings:8090/ratings ...  - name: ratings-route  match:  - uri:  prefix: /rate  rewrite:  uri: \"/ratings\"  route:  - destination:  host: ratings ... 匹配优先级 登录发现/login的匹配也没有添加，后续有可能有别的，因此可以在规则列表最后添加一个规则，作为默认的转发规则。\n$ kubectl -n bookinfo edit vs bookinfo ...  - name: default-route  route:  - destination:  host: productpage DestinationRule 转发策略 默认会使用轮询策略，此外也支持如下负载均衡模型，可以在 DestinationRule 中使用这些模型，将请求分发到特定的服务或服务子集。\n Random：将请求转发到一个随机的实例上 Weighted：按照指定的百分比将请求转发到实例上 Least requests：将请求转发到具有最少请求数目的实例上  apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata:  name: my-destination-rule spec:  host: my-svc  trafficPolicy: #默认的负载均衡策略模型为随机  loadBalancer:  simple: RANDOM  subsets:  - name: v1  #subset1，将流量转发到具有标签 version:v1 的 deployment 对应的服务上  labels:  version: v1  - name: v2  #subset2，将流量转发到具有标签 version:v2 的 deployment 对应的服务上,指定负载均衡为轮询  labels:  version: v2  trafficPolicy:  loadBalancer:  simple: ROUND_ROBIN  - name: v3  #subset3，将流量转发到具有标签 version:v3 的 deployment 对应的服务上  labels:  version: v3 使用https 方式一：把证书绑定在外部的nginx中， nginx 443端口监听外网域名并转发请求到Istio Ingress网关IP+http端口 ，如果使用公有云lb的话（如slb，clb），可以在lb层绑定证书\n方式二：在istio侧使用证书\nhttps://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/\nheader头路由 $ cat virtual-service-reviews-header.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: reviews  namespace: bookinfo spec:  hosts:  - reviews  http:  - match:  - headers:  end-user:  exact: luffy  route:  - destination:  host: reviews  subset: v2  - route:  - destination:  host: reviews  subset: v3 $ kubectl apply -f virtual-service-reviews-header.yaml  # 刷新观察http://bookinfo.com/productpage 更多支持的匹配类型可以在此处查看。\nhttps://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest\n流量镜像 介绍 很多情况下，当我们对服务做了重构，或者我们对项目做了重大优化时，怎么样保证服务是健壮的呢？在传统的服务里，我们只能通过大量的测试，模拟在各种情况下服务的响应情况。虽然也有手工测试、自动化测试、压力测试等一系列手段去检测它，但是测试本身就是一个样本化的行为，即使测试人员再完善它的测试样例，无法全面的表现出线上服务的一个真实流量形态 。\n流量镜像的设计，让这类问题得到了最大限度的解决。流量镜像讲究的不再是使用少量样本去评估一个服务的健壮性，而是在不影响线上坏境的前提下将线上流量持续的镜像到我们的预发布坏境中去，让重构后的服务在上线之前就结结实实地接受一波真实流量的冲击与考验，让所有的风险全部暴露在上线前夕，通过不断的暴露问题，解决问题让服务在上线前夕就拥有跟线上服务一样的健壮性。由于测试坏境使用的是真实流量，所以不管从流量的多样性，真实性，还是复杂性上都将能够得以展现，同时预发布服务也将表现出其最真实的处理能力和对异常的处理能力。\n实践 # 准备httpbin v1 $ cat httpbin-v1.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: httpbin-v1  namespace: bookinfo spec:  replicas: 1  selector:  matchLabels:  app: httpbin  version: v1  template:  metadata:  labels:  app: httpbin  version: v1  spec:  containers:  - image: docker.io/kennethreitz/httpbin  imagePullPolicy: IfNotPresent  name: httpbin  command: [\"gunicorn\", \"--access-logfile\", \"-\", \"-b\", \"0.0.0.0:80\", \"httpbin:app\"]  $ istioctl kube-inject -f httpbin-v1.yaml | kubectl create -f - $ curl $(kubectl -n bookinfo get po -l version=v1,app=httpbin -ojsonpath='{.items[0].status.podIP}')/headers {  \"headers\": {  \"Accept\": \"*/*\",  \"Content-Length\": \"0\",  \"Host\": \"10.244.0.88\",  \"User-Agent\": \"curl/7.29.0\",  \"X-B3-Sampled\": \"1\",  \"X-B3-Spanid\": \"777c7af4458c5b81\",  \"X-B3-Traceid\": \"6b98ea81618deb4f777c7af4458c5b81\"  } }  # 准备httpbin v2 $ cat httpbin-v2.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: httpbin-v2  namespace: bookinfo spec:  replicas: 1  selector:  matchLabels:  app: httpbin  version: v2  template:  metadata:  labels:  app: httpbin  version: v2  spec:  containers:  - image: docker.io/kennethreitz/httpbin  imagePullPolicy: IfNotPresent  name: httpbin  command: [\"gunicorn\", \"--access-logfile\", \"-\", \"-b\", \"0.0.0.0:80\", \"httpbin:app\"]  $ istioctl kube-inject -f httpbin-v2.yaml | kubectl create -f -  # Service文件 $ cat httpbin-svc.yaml apiVersion: v1 kind: Service metadata:  name: httpbin  namespace: bookinfo  labels:  app: httpbin spec:  ports:  - name: http  port: 8000  targetPort: 80  selector:  app: httpbin  $ kubectl apply -f httpbin-svc.yaml  # 使用bookinfo.com/httpbin访问,因此直接修改bookinfo这个virtualservice即可 $ kubectl -n bookinfo get vs NAME GATEWAYS HOSTS bookinfo [bookinfo-gateway] [bookinfo.com] gateway-front-tomcat [productpage-gateway] [productpage.bookinfo.com] reviews [reviews] $ kubectl -n bookinfo edit vs bookinfo #添加httpbin的规则 ...  - match:  - uri:  prefix: /httpbin  name: httpbin-route  rewrite:  uri: /  route:  - destination:  host: httpbin  subset: v1 ... # 创建gateway和virtualservice,由于都是使用http请求，因此，直接 $ cat httpbin-destinationRule.yaml apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata:  name: httpbin  namespace: bookinfo spec:  host: httpbin  subsets:  - name: v1  labels:  version: v1  - name: v2  labels:  version: v2 $ kubectl apply -f httpbin-destinationRule.yaml  # 访问http://bookinfo.com/httpbin/headers，查看日志  # 为httpbin-v1添加mirror设置，mirror点为httpbin-v2 $ kubectl -n bookinfo edit vs bookinfo ...  - match:  - uri:  prefix: /httpbin  name: httpbin-route  rewrite:  uri: /  route:  - destination:  host: httpbin  subset: v1  mirror:  host: httpbin  subset: v2  mirror_percent: 100 ... 重试 在网络环境不稳定的情况下，会出现暂时的网络不可达现象，这时需要重试机制，通过多次尝试来获取正确的返回信息。 istio 可以通过简单的配置来实现重试功能，让开发人员无需关注重试部分的代码实现，专心实现业务代码。\n实践 浏览器访问http://bookinfo.com/httpbin/status/502\n# 此时查看httpbin-v1的日志，显示一条状态码为502的日志 $ kubectl -n bookinfo logs -f httpbin-v1-5967569c54-sp874 -c istio-proxy [2020-11-09T10:26:48.907Z] \"GET /httpbin/status/502 HTTP/1.1\" 502 - \"-\" \"-\" 0 0 5 4 \"172.21.50.140,10.244.0.1\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36\" \"767cf33b-b8cf-9804-8c48-df131393c8a5\" \"bookinfo.com\" \"127.0.0.1:80\" inbound|8000|http|httpbin.bookinfo.svc.cluster.local 127.0.0.1:48376 10.244.0.90:80 10.244.0.1:0 outbound_.8000_.v1_.httpbin.bookinfo.svc.cluster.local default 我们为httpbin服务设置重试机制，这里设置如果服务在 2 秒内没有返回正确的返回值，就进行重试，重试的条件为返回码为5xx，重试 3 次。\n$ kubectl -n bookinfo edit vs bookinfo ...  - match:  - uri:  prefix: /httpbin  mirror:  host: httpbin  subset: v2  mirror_percent: 100  name: httpbin-route  retries:  attempts: 3  perTryTimeout: 2s  retryOn: 5xx  rewrite:  uri: /  route:  - destination:  host: httpbin  subset: v1 ...  # 再次查看httpbin-v1的日志，显示四条状态码为502的日志 熔断 介绍 熔断（Circuit Breaker），原是指当电流超过规定值时断开电路，进行短路保护或严重过载保护的机制 。对于微服务系统而言，熔断尤为重要，它可以使系统在遭遇某些模块故障时，通过服务降级等方式来提高系统核心功能的可用性，得以应对来自故障、潜在峰值或其他未知网络因素的影响。\n准备环境 Istio 是通过 Envoy Proxy 来实现熔断机制的，Envoy 强制在网络层面配置熔断策略，这样就不必为每个应用程序单独配置或重新编程。下面就通过一个示例来演示如何为 Istio 网格中的服务配置熔断的连接数、请求数和异常检测。\n  创建httpbin服务\n  创建测试客户端\n我们已经为 httpbin 服务设置了熔断策略，接下来创建一个 Java 客户端，用来向后端服务发送请求，观察是否会触发熔断策略。这个客户端可以控制连接数量、并发数、待处理请求队列，使用这一客户端，能够有效的触发前面在目标规则中设置的熔断策略。该客户端的 deployment yaml 内容如下：\n# httpbin-client-deploy.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: httpbin-client-v1  namespace: bookinfo spec:  replicas: 1  selector:  matchLabels:  app: httpbin-client-v1  version: v1  template:  metadata:  labels:  app: httpbin-client-v1  version: v1  spec:  containers:  - image: ceposta/http-envoy-client-standalone:latest  imagePullPolicy: IfNotPresent  name: httpbin-client  command: [\"/bin/sleep\",\"infinity\"] 这里我们会把给客户端也进行 Sidecar 的注入，以此保证 Istio 对网络交互的控制：\n$ kubectl apply -f -f httpbin-client-deploy.yaml)   验证 先尝试通过单线程（NUM_THREADS=1）创建一个连接，并进行 5 次调用（默认值：NUM_CALLS_PER_CLIENT=5）：\n$ CLIENT_POD=$(kubectl get pod -n bookinfo | grep httpbin-client | awk '{ print $1 }') $ kubectl -n bookinfo exec -it $CLIENT_POD -c httpbin-client -- sh -c 'export URL_UNDER_TEST=http://httpbin:8000/get export NUM_THREADS=1 \u0026\u0026 java -jar http-client.jar' 下面尝试把线程数提高到 2：\n$ kubectl -n bookinfo exec -it $CLIENT_POD -c httpbin-client -- sh -c 'export URL_UNDER_TEST=http://httpbin:8000/get export NUM_THREADS=2 \u0026\u0026 java -jar http-client.jar' 创建DestinationRule， 针对 httpbin 服务设置熔断策略：\n$ kubectl apply -f - apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata:  name: httpbin  namespace: bookinfo spec:  host: httpbin  trafficPolicy:  connectionPool:  tcp:  maxConnections: 1  http:  http1MaxPendingRequests: 1  maxRequestsPerConnection: 1 EOF  maxConnections : 限制对后端服务发起的 HTTP/1.1 连接数，如果超过了这个限制，就会开启熔断。 maxPendingRequests : 限制待处理请求列表的长度， 如果超过了这个限制，就会开启熔断。 maxRequestsPerConnection : 在任何给定时间内限制对后端服务发起的 HTTP/2 请求数，如果超过了这个限制，就会开启熔断。  可以查看设置的熔断策略在envoy的配置片段：\n$ istioctl pc cluster httpbin-client-v1-56b86fb85c-vg5pp.bookinfo --fqdn httpbin.bookinfo.svc.cluster.local -ojson ...  \"connectTimeout\": \"10s\",  \"maxRequestsPerConnection\": 1,  \"circuitBreakers\": {  \"thresholds\": [  {  \"maxConnections\": 1,  \"maxPendingRequests\": 1,  \"maxRequests\": 4294967295,  \"maxRetries\": 4294967295  }  ]  }, ... 再次验证熔断。\n故障注入与超时机制 在一个微服务架构的系统中，为了让系统达到较高的健壮性要求，通常需要对系统做定向错误测试。比如电商中的订单系统、支付系统等若出现故障那将是非常严重的生产事故，因此必须在系统设计前期就需要考虑多样性的异常故障并对每一种异常设计完善的恢复策略或优雅的回退策略，尽全力规避类似事故的发生，使得当系统发生故障时依然可以正常运作。而在这个过程中，服务故障模拟一直以来是一个非常繁杂的工作。\nistio提供了无侵入式的故障注入机制，让开发测试人员在不用调整服务程序的前提下，通过配置即可完成对服务的异常模拟。目前，包含两类：\n abort：非必配项，配置一个 Abort 类型的对象。用来注入请求异常类故障。简单的说，就是用来模拟上游服务对请求返回指定异常码时，当前的服务是否具备处理能力。 delay：非必配项，配置一个 Delay 类型的对象。用来注入延时类故障。通俗一点讲，就是人为模拟上游服务的响应时间，测试在高延迟的情况下，当前的服务是否具备容错容灾的能力。  延迟与超时 目前针对luffy登录用户，访问服务的示意为：\nproductpage -- reviews v2 -- ratings  \\  - details 可以通过如下方式，为ratings服务注入2秒的延迟：\n$ cat virtualservice-ratings-2s-delay.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: ratings  namespace: bookinfo spec:  hosts:  - ratings  http:  - fault:  delay:  percentage:  value: 100  fixedDelay: 2s  route:  - destination:  host: ratings  $ kubectl apply -f virtualservice-ratings-2s-delay.yaml # 再次访问http://bookinfo.com/productpage，可以明显感觉2s的延迟,network可以看到 可以查看对应的envoy的配置：\n$ istioctl pc r ratings-v1-556cfbd589-89ml4.bookinfo --name 9080 -ojson 此时的调用为:\nproductpage -- reviews v2 -（延迟2秒）- ratings  \\  - details 此时，为reviews服务添加请求超时时间：\n$ kubectl -n bookinfo edit vs reviews ...  http:  - match:  - headers:  end-user:  exact: luffy  route:  - destination:  host: reviews  subset: v2  timeout: 1s  - route:  - destination:  host: reviews  subset: v3 ... 此使的调用关系为：\nproductpage -（0.5秒超时）- reviews v2 -（延迟2秒）- ratings  \\  - details 此时，如果使用非luffy用户，则会出现只延迟，不会失败的情况。\n删除延迟：\n$ kubectl -n bookinfo delete vs ratings 状态码 $ cat virtualservice-details-aborted.yaml apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata:  name: details  namespace: bookinfo spec:  hosts:  - details  http:  - fault:  abort:  percentage:  value: 50  httpStatus: 500  route:  - destination:  host: details  $ kubectl apply -f virtualservice-details-aborted.yaml  # 再次刷新查看details的状态，查看productpage的日志 $ kubectl -n bookinfo logs -f $(kubectl -n bookinfo get po -l app=productpage -ojsonpath='{.items[0].metadata.name}') -c istio-proxy [2020-11-09T09:00:16.020Z] \"GET /details/0 HTTP/1.1\" 500 FI \"-\" \"-\" 0 18 0 - \"-\" \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36\" \"f0387bb6-a445-922c-89ab-689dfbf548f8\" \"details:9080\" \"-\" - - 10.111.67.169:9080 10.244.0.52:56552 - - 可观察性 安装集成组件 https://istio.io/latest/docs/ops/integrations\n  Grafana\n$ kubectl apply -f samples/addons/grafana.yaml   Jaeger\n$ kubectl apply -f samples/addons/jaeger.yaml   Kiali\n# 完善扩展组件地址： grafana url: \"http://grafana.istio.com\" tracing url: \"http://jaeger.istio.com\" $ kubectl apply -f samples/addons/kiali.yaml   Prometheus\n$ kubectl apply -f samples/addons/prometheus.yaml   prometheus Prometheus：\n$ cat prometheus-ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: prometheus  namespace: istio-system spec:  rules:  - host: prometheus.istio.com  http:  paths:  - backend:  serviceName: prometheus  servicePort: 9090  path: / status:  loadBalancer: {}  $ kubectl apply -f prometheus-ingress.yaml 查看默认添加的targets列表：\n其中最核心的是kubernetes-pods 的监控，服务网格内的每个服务都作为一个target被监控，而且服务流量指标直接由sidecar容器来提供指标。\n$ kubectl -n bookinfo get po -owide $ curl 10.244.0.53:15020/stats/prometheus 对于这些监控指标采集的数据，可以在grafana中查看到。\n$ cat grafana-ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: grafana  namespace: istio-system spec:  rules:  - host: grafana.istio.com  http:  paths:  - backend:  serviceName: grafana  servicePort: 3000  path: / status:  loadBalancer: {}   $ for i in $(seq 1 10000); do curl -s -o /dev/null \"http://bookinfo.com/productpage\"; done 访问界面后，可以查看到Istio Mesh Dashboard等相关的dashboard，因为在grafana的资源文件中， 中以 ConfigMap 的形式挂载了 Istio各个组件的仪表盘 JSON 配置文件：\n$ kubectl -n istio-system get cm istio-services-grafana-dashboards NAME DATA AGE istio-services-grafana-dashboards 3 7d1h jaeger $ cat jaeger-ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: jaeger  namespace: istio-system spec:  rules:  - host: jaeger.istio.com  http:  paths:  - backend:  serviceName: tracing  servicePort: 80  path: / status:  loadBalancer: {}  $ kubectl apply -f jaeger-ingress.yaml kiali kiali 是一个 可观测性分析服务\n$ cat kiali-ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: kiali  namespace: istio-system spec:  rules:  - host: kiali.istio.com  http:  paths:  - backend:  serviceName: kiali  servicePort: 20001  path: / status:  loadBalancer: {}  $ kubectl apply -f kiali-ingress.yaml 集成了Prometheus、grafana、tracing、log、\n展望未来 Kubernets已经成为了容器调度编排的事实标准，而容器正好可以作为微服务的最小工作单元，从而发挥微服务架构的最大优势。所以我认为未来微服务架构会围绕Kubernetes展开。而Istio和Conduit这类Service Mesh天生就是为了Kubernetes设计，它们的出现补足了Kubernetes在微服务间服务通讯上的短板。虽然Dubbo、Spring Cloud等都是成熟的微服务框架，但是它们或多或少都会和具体语言或应用场景绑定，并只解决了微服务Dev层面的问题。若想解决Ops问题，它们还需和诸如Cloud Foundry、Mesos、Docker Swarm或Kubernetes这类资源调度框架做结合：\n但是这种结合又由于初始设计和生态，有很多适用性问题需要解决。\nKubernetes则不同，它本身就是一个和开发语言无关的、通用的容器管理平台，它可以支持运行云原生和传统的容器化应用。并且它覆盖了微服务的Dev和Ops阶段，结合Service Mesh，它可以为用户提供完整端到端的微服务体验。\n所以我认为，未来的微服务架构和技术栈可能是如下形式：\n多云平台为微服务提供了资源能力（计算、存储和网络等），容器作为最小工作单元被Kubernetes调度和编排，Service Mesh管理微服务的服务通信，最后通过API Gateway向外暴露微服务的业务接口。\n未来随着以Kubernetes和Service Mesh为标准的微服务框架的盛行，将大大降低微服务实施的成本，最终为微服务落地以及大规模使用提供坚实的基础和保障。\n小结   第一代为Spring Cloud为代表的服务治理能力，是和业务代码紧耦合的，没法跨编程语言去使用\n  为了可以实现通用的服务治理能力，istio会为每个业务pod注入一个sidecar代理容器\n  为了能够做到服务治理，需要接管pod内的出入流量，因此通过注入的时候引入初始化容器istio-init实现pod内防火墙规则的初始化，分别将出入站流量拦截到pod内的15001和15006端口\n  同时，注入了istio-proxy容器，利用envoy代理，监听了15001和15006端口，对流量进行处理\n  istio在istio-system命名空间启动了istiod服务，用于监听用户写入etcd中的流量规则，转换成envoy可度的配置片段，通过envoy支持的xDS协议，同步到网格内的各envoy中\n  envoy获取规则后，做reload，直接应用到了用户期望的转发行为\n  envoy提供了强大的流量处理规则，包含了流量路由、镜像、重试、熔断、故障注入等，同时，也内置了分布式追踪、Prometheus监控的实现，业务应用对于这一切都是感知不到的\n  最后，通过分析bookinfo中，从 Productpage服务调用Reviews服务的 请求流程 来回顾istio重点：\n  Productpage发起对Reviews服务的调用：http://reviews:9080/reviews/0\n  请求被Productpage Pod的iptable规则拦截，重定向到本地的15001端口\n# OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。 Chain OUTPUT (policy ACCEPT 46 packets, 3926 bytes)  pkts bytes target prot opt in out source destination  8 480 ISTIO_OUTPUT tcp -- * * 0.0.0.0/0 0.0.0.0/0  # ISTIO_OUTPUT 链：选择需要重定向到 Envoy（即本地） 的出站流量，所有非 localhost 的流量全部转发到 ISTIO_REDIRECT。为了避免流量在该 Pod 中无限循环，所有到 istio-proxy 用户空间的流量都返回到它的调用点中的下一条规则，本例中即 OUTPUT 链，因为跳出 ISTIO_OUTPUT 规则之后就进入下一条链 POSTROUTING。如果目的地非 localhost 就跳转到 ISTIO_REDIRECT；如果流量是来自 istio-proxy 用户空间的，那么就跳出该链，返回它的调用链继续执行下一条规则（OUTPUT 的下一条规则，无需对流量进行处理）；所有的非 istio-proxy 用户空间的目的地是 localhost 的流量就跳转到 ISTIO_REDIRECT。 Chain ISTIO_OUTPUT (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN all -- * lo 127.0.0.6 0.0.0.0/0  0 0 ISTIO_IN_REDIRECT all -- * lo 0.0.0.0/0 !127.0.0.1 owner UID match 1337  0 0 RETURN all -- * lo 0.0.0.0/0 0.0.0.0/0 ! owner UID match 1337  8 480 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 owner UID match 1337  0 0 ISTIO_IN_REDIRECT all -- * lo 0.0.0.0/0 !127.0.0.1 owner GID match 1337  0 0 RETURN all -- * lo 0.0.0.0/0 0.0.0.0/0 ! owner GID match 1337  0 0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 owner GID match 1337  0 0 RETURN all -- * * 0.0.0.0/0 127.0.0.1  0 0 ISTIO_REDIRECT all -- * * 0.0.0.0/0 0.0.0.0/0  # ISTIO_REDIRECT 链：将所有流量重定向到 Sidecar（即本地） 的 15001 端口。 Chain ISTIO_REDIRECT (1 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0 redir ports 15001   15001端口上监听的Envoy Virtual Outbound Listener收到了该请求\n$ istioctl pc listener productpage-v1-785b4dbc96-2cw5v.bookinfo --port 15001 -ojson|more [  {  \"name\": \"virtualOutbound\",  \"address\": {  \"socketAddress\": {  \"address\": \"0.0.0.0\",  \"portValue\": 15001  }  }, ...   请求被Virtual Outbound Listener根据原目标IP（通配）和端口（9080）转发到0.0.0.0_9080这个 outbound listener\n$ istioctl pc listener productpage-v1-785b4dbc96-2cw5v.bookinfo --port 9080 -ojson [  {  \"name\": \"0.0.0.0_9080\",  \"address\": {  \"socketAddress\": {  \"address\": \"0.0.0.0\",  \"portValue\": 9080  }  },  \"filterChains\": [  {  \"filterChainMatch\": {  \"applicationProtocols\": [  \"http/1.0\",  \"http/1.1\",  \"h2c\"  ]  },  \"filters\": [  {  \"name\": \"envoy.filters.network.http_connection_manager\",  \"typedConfig\": {  \"statPrefix\": \"outbound_0.0.0.0_9080\",  \"rds\": {  \"configSource\": {  \"ads\": {},  \"resourceApiVersion\": \"V3\"  },  \"routeConfigName\": \"9080\"  },   根据0.0.0.0_9080 listener的http_connection_manager filter配置,该请求采用“9080” route进行分发\n  9080的route中，根据domains进行匹配，将请求交给 outbound|9080|v2|reviews.bookinfo.svc.cluster.local这个cluster处理\n$ istioctl pc route productpage-v1-785b4dbc96-2cw5v.bookinfo --name 9080 -ojson ...  {  \"name\": \"reviews.bookinfo.svc.cluster.local:9080\",  \"domains\": [  \"reviews.bookinfo.svc.cluster.local\",  \"reviews.bookinfo.svc.cluster.local:9080\",  \"reviews\",  \"reviews:9080\",  \"reviews.bookinfo.svc.cluster\",  \"reviews.bookinfo.svc.cluster:9080\",  \"reviews.bookinfo.svc\",  \"reviews.bookinfo.svc:9080\",  \"reviews.bookinfo\",  \"reviews.bookinfo:9080\",  \"10.109.133.236\",  \"10.109.133.236:9080\"  ],  \"routes\": [  {  \"match\": {  \"prefix\": \"/\",  \"caseSensitive\": true,  \"headers\": [  {  \"name\": \"end-user\",  \"exactMatch\": \"luffy\"  }  ]  },  \"route\": {  \"cluster\": \"outbound|9080|v2|reviews.bookinfo.svc.cluster.local\",  \"timeout\": \"1s\",   该cluster为EDS\n$ istioctl pc cluster productpage-v1-785b4dbc96-2cw5v.bookinfo --fqdn reviews.bookinfo.svc.cluster.local --direction outbound -ojson ...  \"name\": \"outbound|9080|v3|reviews.bookinfo.svc.cluster.local\",  \"type\": \"EDS\",  \"edsClusterConfig\": {  \"edsConfig\": {  \"ads\": {},  \"resourceApiVersion\": \"V3\"  },  \"serviceName\": \"outbound|9080|v3|reviews.bookinfo.svc.cluster.local\"  },  \"connectTimeout\": \"10s\",  \"lbPolicy\": \"RANDOM\",  \"circuitBreakers\": {  \"thresholds\": [  {  \"maxConnections\": 4294967295,  \"maxPendingRequests\": 4294967295,  \"maxRequests\": 4294967295,  \"maxRetries\": 4294967295  }  ]  },   查寻EDS对应的endpoint列表\n$ istioctl pc endpoint productpage-v1-785b4dbc96-2cw5v.bookinfo --cluster \"outbound|9080|v3|reviews.bookinfo.svc.cluster.local\" -ojson [  {  \"name\": \"outbound|9080|v3|reviews.bookinfo.svc.cluster.local\",  \"addedViaApi\": true,  \"hostStatuses\": [  {  \"address\": {  \"socketAddress\": {  \"address\": \"10.244.0.37\",  \"portValue\": 9080  }  }, ...   envoy进程得到了最终需要访问的地址（reviews-v3的podip：port），由envoy做proxy转发出去\n  此时，虽然还是会走一遍envoy的防火墙规则，但是由于是1337用户发起的请求，因此不会被再次拦截，直接走kubernetes的集群网络发出去\n  请求到达reviews-v3， 被iptable规则拦截，重定向到本地的15006端口\n# PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。 Chain PREROUTING (policy ACCEPT 148 packets, 8880 bytes)  pkts bytes target prot opt in out source destination  148 8880 ISTIO_INBOUND tcp -- * * 0.0.0.0/0 0.0.0.0/0  # INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。 Chain INPUT (policy ACCEPT 148 packets, 8880 bytes)  pkts bytes target prot opt in out source destination  # ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上，目的地为 15090，15020，15021端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING。 Chain ISTIO_INBOUND (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15008  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:22  0 0 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15090  143 8580 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15021  5 300 RETURN tcp -- * * 0.0.0.0/0 0.0.0.0/0 tcp dpt:15020  0 0 ISTIO_IN_REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0  # ISTIO_IN_REDIRECT 链：将所有入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到sidecar中。 Chain ISTIO_IN_REDIRECT (3 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- * * 0.0.0.0/0 0.0.0.0/0 redir ports 15006   被监听在15006端口的envoy进程处理\n$ istioctl pc listener reviews-v3-6c7d64cd96-75f4x.bookinfo --port 15006 -ojson|more [  {  \"name\": \"virtualInbound\",  \"address\": {  \"socketAddress\": {  \"address\": \"0.0.0.0\",  \"portValue\": 15006  }  }, ...   VirtualInbound不再转给别的监听器，根据自身过滤器链的匹配条件，请求被Virtual Inbound Listener内部配置的Http connection manager filter处理 ， 该filter设置的路由配置为将其发送给 inbound|9080|http|reviews.bookinfo.svc.cluster.local这个inbound的cluster\n {  \"filterChainMatch\": {  \"destinationPort\": 9080  },  \"filters\": [  {  \"name\": \"istio.metadata_exchange\",  \"typedConfig\": {  \"@type\": \"type.googleapis.com/udpa.type.v1.TypedStruct\",  \"value\": {  \"protocol\": \"istio-peer-exchange\"  }  }  },  {  \"name\": \"envoy.filters.network.http_connection_manager\",  \"typedConfig\": {  \"statPrefix\": \"inbound_0.0.0.0_9080\",  \"routeConfig\": {  \"name\": \"inbound|9080|http|reviews.bookinfo.svc.cluster.local\",  \"virtualHosts\": [  {  \"name\": \"inbound|http|9080\",  \"domains\": [  \"*\"  ],  \"routes\": [  {  \"name\": \"default\",  \"match\": {  \"prefix\": \"/\"  },  \"route\": {  \"cluster\": \"inbound|9080|http|reviews.bookinfo.svc.cluster.local\",  \"timeout\": \"0s\",  \"maxGrpcTimeout\": \"0s\"  }   inbound|9080|http|reviews.bookinfo.svc.cluster.local配置的endpoint为本机的127.0.0.1:9080,因此转发到Pod内部的Reviews服务的9080端口进行处理。\n$ istioctl pc endpoint reviews-v3-6c7d64cd96-75f4x.bookinfo --cluster \"inbound|9080|http|reviews.bookinfo.svc.cluster.local\" -ojson [  {  \"name\": \"inbound|9080|http|reviews.bookinfo.svc.cluster.local\",  \"addedViaApi\": true,  \"hostStatuses\": [  {  \"address\": {  \"socketAddress\": {  \"address\": \"127.0.0.1\",  \"portValue\": 9080  }  },   ",
  "wordCount" : "5288",
  "inLanguage": "zh",
  "datePublished": "2022-01-12T17:38:42Z",
  "dateModified": "2022-01-12T17:38:42Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Eistio%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      基于Istio实现微服务治理
    </h1>
    <div class="post-meta"><span title='2022-01-12 17:38:42 +0000 UTC'>2022-01-12</span>&nbsp;·&nbsp;25 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%9f%ba%e4%ba%8eistio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86" aria-label="基于Istio实现微服务治理">基于Istio实现微服务治理</a><ul>
                            
                    <li>
                        <a href="#service-mesh-%e6%9c%8d%e5%8a%a1%e7%bd%91%e6%a0%bc" aria-label="Service Mesh 服务网格">Service Mesh 服务网格</a><ul>
                            
                    <li>
                        <a href="#%e6%9e%b6%e6%9e%84%e5%92%8c%e6%a6%82%e5%bf%b5" aria-label="架构和概念">架构和概念</a></li>
                    <li>
                        <a href="#%e5%bc%80%e6%ba%90%e5%ae%9e%e7%8e%b0" aria-label="开源实现">开源实现</a><ul>
                            
                    <li>
                        <a href="#%e7%ac%ac%e4%b8%80%e4%bb%a3%e6%9c%8d%e5%8a%a1%e7%bd%91%e6%a0%bc-linkerd%e5%92%8cenvoy" aria-label="第一代服务网格 Linkerd和Envoy">第一代服务网格 Linkerd和Envoy</a></li>
                    <li>
                        <a href="#%e7%ac%ac%e4%ba%8c%e4%bb%a3%e6%9c%8d%e5%8a%a1%e7%bd%91%e6%a0%bc--istio" aria-label="第二代服务网格  Istio">第二代服务网格  Istio</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85istio" aria-label="安装Istio">安装Istio</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e4%b8%8b%e8%bd%bd-istio" aria-label="下载 Istio">下载 Istio</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85istio%e7%bb%84%e4%bb%b6" aria-label="安装istio组件">安装istio组件</a></li>
                    <li>
                        <a href="#%e5%8d%b8%e8%bd%bd" aria-label="卸载">卸载</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" aria-label="快速入门">快速入门</a><ul>
                            
                    <li>
                        <a href="#%e5%9c%ba%e6%99%af%e4%b8%80" aria-label="场景一">场景一</a><ul>
                            
                    <li>
                        <a href="#%e6%a8%a1%e5%9e%8b%e5%9b%be" aria-label="模型图">模型图</a></li>
                    <li>
                        <a href="#%e8%b5%84%e6%ba%90%e6%b8%85%e5%8d%95" aria-label="资源清单">资源清单</a></li>
                    <li>
                        <a href="#%e6%93%8d%e4%bd%9c" aria-label="操作">操作</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%9c%ba%e6%99%af%e4%ba%8c" aria-label="场景二">场景二</a><ul>
                            
                    <li>
                        <a href="#%e6%a8%a1%e5%9e%8b%e5%9b%be-1" aria-label="模型图">模型图</a></li>
                    <li>
                        <a href="#%e8%b5%84%e6%ba%90%e6%b8%85%e5%8d%95-1" aria-label="资源清单">资源清单</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8istio" aria-label="使用Istio">使用Istio</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e7%bd%91%e6%a0%bc%e7%bb%86%e8%8a%82%e5%89%96%e6%9e%90" aria-label="服务网格细节剖析">服务网格细节剖析</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%8f%e8%a7%82%e8%a7%92%e5%ba%a6" aria-label="宏观角度">宏观角度</a></li>
                    <li>
                        <a href="#%e8%ae%a4%e8%af%86envoy" aria-label="认识envoy">认识envoy</a></li>
                    <li>
                        <a href="#envoy%e7%9a%84xds" aria-label="envoy的xDS">envoy的xDS</a></li>
                    <li>
                        <a href="#envoy%e5%9c%a8%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86%e4%b8%ad%e7%9a%84%e5%b7%a5%e4%bd%9c%e7%8e%af%e5%a2%83" aria-label="envoy在微服务治理中的工作环境">envoy在微服务治理中的工作环境</a></li>
                    <li>
                        <a href="#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="工作原理">工作原理</a></li>
                    <li>
                        <a href="#%e8%b0%83%e8%af%95envoy" aria-label="调试envoy">调试envoy</a></li>
                    <li>
                        <a href="#%e4%b8%80%e7%82%b9%e5%b0%8f%e7%9f%a5%e8%af%86" aria-label="一点小知识">一点小知识</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%9c%ba%e6%99%af%e4%b8%89" aria-label="场景三">场景三</a><ul>
                            
                    <li>
                        <a href="#%e6%a8%a1%e5%9e%8b%e5%9b%be-2" aria-label="模型图">模型图</a></li>
                    <li>
                        <a href="#%e8%b5%84%e6%ba%90%e6%b8%85%e5%8d%95-2" aria-label="资源清单">资源清单</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8ingress%e6%9d%a5%e8%ae%bf%e9%97%ae%e7%bd%91%e6%a0%bc%e6%9c%8d%e5%8a%a1" aria-label="使用ingress来访问网格服务">使用ingress来访问网格服务</a></li>
                    <li>
                        <a href="#ingressgateway%e8%ae%bf%e9%97%ae%e7%bd%91%e6%a0%bc%e6%9c%8d%e5%8a%a1" aria-label="ingressgateway访问网格服务">ingressgateway访问网格服务</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%9e%e4%be%8b%e6%bc%94%e7%a4%ba" aria-label="实例演示">实例演示</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e4%be%8b%e4%bb%8b%e7%bb%8d" aria-label="实例介绍">实例介绍</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%85%a5sidecar%e5%ae%b9%e5%99%a8" aria-label="注入sidecar容器">注入sidecar容器</a><ul>
                            
                    <li>
                        <a href="#%e5%a6%82%e4%bd%95%e6%b3%a8%e5%85%a5sidecar%e5%ae%b9%e5%99%a8" aria-label="如何注入sidecar容器">如何注入sidecar容器</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%85%a5bookinfo" aria-label="注入bookinfo">注入bookinfo</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b5%81%e9%87%8f%e8%b7%af%e7%94%b1" aria-label="流量路由">流量路由</a><ul>
                            
                    <li>
                        <a href="#ingress-gateway%e8%ae%bf%e9%97%aeproductpage" aria-label="ingress-gateway访问productpage">ingress-gateway访问productpage</a></li>
                    <li>
                        <a href="#%e6%9d%83%e9%87%8d%e8%b7%af%e7%94%b1" aria-label="权重路由">权重路由</a></li>
                    <li>
                        <a href="#%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84%e8%b7%af%e7%94%b1" aria-label="访问路径路由">访问路径路由</a></li>
                    <li>
                        <a href="#%e8%b7%af%e5%be%84%e9%87%8d%e5%86%99" aria-label="路径重写">路径重写</a></li>
                    <li>
                        <a href="#%e5%8c%b9%e9%85%8d%e4%bc%98%e5%85%88%e7%ba%a7" aria-label="匹配优先级">匹配优先级</a></li>
                    <li>
                        <a href="#destinationrule-%e8%bd%ac%e5%8f%91%e7%ad%96%e7%95%a5" aria-label="DestinationRule 转发策略">DestinationRule 转发策略</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8https" aria-label="使用https">使用https</a></li>
                    <li>
                        <a href="#header%e5%a4%b4%e8%b7%af%e7%94%b1" aria-label="header头路由">header头路由</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b5%81%e9%87%8f%e9%95%9c%e5%83%8f" aria-label="流量镜像">流量镜像</a><ul>
                            
                    <li>
                        <a href="#%e4%bb%8b%e7%bb%8d" aria-label="介绍">介绍</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5" aria-label="实践">实践</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%87%8d%e8%af%95" aria-label="重试">重试</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5-1" aria-label="实践">实践</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%86%94%e6%96%ad" aria-label="熔断">熔断</a><ul>
                            
                    <li>
                        <a href="#%e4%bb%8b%e7%bb%8d-1" aria-label="介绍">介绍</a></li>
                    <li>
                        <a href="#%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83" aria-label="准备环境">准备环境</a></li>
                    <li>
                        <a href="#%e9%aa%8c%e8%af%81" aria-label="验证">验证</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%95%85%e9%9a%9c%e6%b3%a8%e5%85%a5%e4%b8%8e%e8%b6%85%e6%97%b6%e6%9c%ba%e5%88%b6" aria-label="故障注入与超时机制">故障注入与超时机制</a><ul>
                            
                    <li>
                        <a href="#%e5%bb%b6%e8%bf%9f%e4%b8%8e%e8%b6%85%e6%97%b6" aria-label="延迟与超时">延迟与超时</a></li>
                    <li>
                        <a href="#%e7%8a%b6%e6%80%81%e7%a0%81" aria-label="状态码">状态码</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%8f%af%e8%a7%82%e5%af%9f%e6%80%a7" aria-label="可观察性">可观察性</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85%e9%9b%86%e6%88%90%e7%bb%84%e4%bb%b6" aria-label="安装集成组件">安装集成组件</a></li></ul>
                        
                    <li>
                        <a href="#prometheus" aria-label="prometheus">prometheus</a></li>
                    <li>
                        <a href="#jaeger" aria-label="jaeger">jaeger</a></li>
                    <li>
                        <a href="#kiali" aria-label="kiali">kiali</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b1%95%e6%9c%9b%e6%9c%aa%e6%9d%a5" aria-label="展望未来">展望未来</a></li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="基于istio实现微服务治理">基于Istio实现微服务治理<a hidden class="anchor" aria-hidden="true" href="#基于istio实现微服务治理">#</a></h3>
<p>微服务架构可谓是当前软件开发领域的技术热点，它在各种博客、社交媒体和会议演讲上的出镜率非常之高，无论是做基础架构还是做业务系统的工程师，对微服务都相当关注，而这个现象与热度到目前为止，已经持续了近 5 年之久。</p>
<p>尤其是近些年来，微服务架构逐渐发展成熟，从最初的星星之火到现在的大规模的落地与实践，几乎已经成为分布式环境下的首选架构。微服务成为时下技术热点，大量互联网公司都在做微服务架构的落地和推广。同时，也有很多传统企业基于微服务和容器，在做互联网技术转型。</p>
<p>而在这个技术转型中，国内有一个趋势，以 Spring Cloud 与 Dubbo 为代表的微服务开发框架非常普及和受欢迎。然而软件开发没有银弹，基于这些传统微服务框架构建的应用系统在享受其优势的同时，痛点也越加明显。这些痛点包括但不限于以下几点：</p>
<ul>
<li><strong>侵入性强</strong>。想要集成 SDK 的能力，除了需要添加相关依赖，往往还需要在业务代码中增加一部分的代码、或注解、或配置；业务代码与治理层代码界限不清晰。</li>
<li><strong>升级成本高</strong>。每次升级都需要业务应用修改 SDK 版本，重新进行功能回归测试，并且对每一台机器进行部署上线，而这对于业务方来说，与业务的快速迭代开发是有冲突的，大多不愿意停下来做这些与业务目标不太相关的事情。</li>
<li><strong>版本碎片化严重</strong>。由于升级成本高，而中间件却不会停止向前发展的步伐，久而久之，就会导致线上不同服务引用的 SDK 版本不统一、能力参差不齐，造成很难统一治理。</li>
<li><strong>中间件演变困难</strong>。由于版本碎片化严重，导致中间件向前演进的过程中就需要在代码中兼容各种各样的老版本逻辑，带着 “枷锁” 前行，无法实现快速迭代。</li>
<li><strong>内容多、门槛高</strong>。Spring Cloud 被称为微服务治理的全家桶，包含大大小小几十个组件，内容相当之多，往往需要几年时间去熟悉其中的关键组件。而要想使用 Spring Cloud 作为完整的治理框架，则需要深入了解其中原理与实现，否则遇到问题还是很难定位。</li>
<li><strong>治理功能不全</strong>。不同于 RPC 框架，Spring Cloud 作为治理全家桶的典型，也不是万能的，诸如协议转换支持、多重授权机制、动态请求路由、故障注入、灰度发布等高级功能并没有覆盖到。而这些功能往往是企业大规模落地不可获缺的功能，因此公司往往还需要投入其它人力进行相关功能的自研或者调研其它组件作为补充。</li>
</ul>
<h4 id="service-mesh-服务网格">Service Mesh 服务网格<a hidden class="anchor" aria-hidden="true" href="#service-mesh-服务网格">#</a></h4>
<h5 id="架构和概念">架构和概念<a hidden class="anchor" aria-hidden="true" href="#架构和概念">#</a></h5>
<p>目的是解决系统架构微服务化后的服务间通信和治理问题。设计初衷是提供一种通用的服务治理方案。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/sidecar-pattern.jpg" alt=""  />
</p>
<p>Sidecar 在软件系统架构中特指边车模式。这个模式的灵感来源于我们生活中的边三轮：即在两轮摩托车的旁边添加一个边车的方式扩展现有的服务和功能。</p>
<p>这个模式的精髓在于实现了数据面（业务逻辑）和控制面的解耦：原来两轮摩托车的驾驶者集中注意力跑赛道，边车上的领航员专注周围信息和地图，专注导航。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/service-mesh.png" alt=""  />
</p>
<p>Service Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的与应用逻辑服务部署在一起的服务代理，并且对于应用服务是透明的。</p>
<h5 id="开源实现">开源实现<a hidden class="anchor" aria-hidden="true" href="#开源实现">#</a></h5>
<h6 id="第一代服务网格-linkerd和envoy">第一代服务网格 Linkerd和Envoy<a hidden class="anchor" aria-hidden="true" href="#第一代服务网格-linkerd和envoy">#</a></h6>
<p>Linkerd 使用Scala编写，是业界第一个开源的service mesh方案。作者 William Morgan 是 service mesh 的布道师和践行者。Envoy 基于C++ 11编写，无论是理论上还是实际上，后者性能都比 Linkderd 更好。这两个开源实现都是以 sidecar 为核心，绝大部分关注点都是如何做好proxy，并完成一些通用控制面的功能。 但是，当你在容器中大量部署 sidecar 以后，如何管理和控制这些 sidecar 本身就是一个不小的挑战。于是，第二代 Service Mesh 应运而生。</p>
<h6 id="第二代服务网格--istio">第二代服务网格  Istio<a hidden class="anchor" aria-hidden="true" href="#第二代服务网格--istio">#</a></h6>
<p>Istio 是 Google 和 IBM 两位巨人联合 Lyft 的合作开源项目。是当前最主流的service mesh方案，也是事实上的第二代 service mesh 标准。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/istio-mesh-arch.png" alt=""  />
</p>
<h4 id="安装istio">安装Istio<a hidden class="anchor" aria-hidden="true" href="#安装istio">#</a></h4>
<p><a href="https://istio.io/latest/docs/setup/getting-started/">https://istio.io/latest/docs/setup/getting-started/</a></p>
<h6 id="下载-istio">下载 Istio<a hidden class="anchor" aria-hidden="true" href="#下载-istio">#</a></h6>
<p>下载内容将包含：安装文件、示例和 <a href="https://istio.io/latest/zh/docs/reference/commands/istioctl/">istioctl</a> 命令行工具。</p>
<ol>
<li>
<p>访问 <a href="https://github.com/istio/istio/releases/tag/1.7.3">Istio release</a> 页面下载与您操作系统对应的安装文件。在 macOS 或 Linux 系统中，也可以通过以下命令下载最新版本的 Istio：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ wget https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/istio/istio/releases/download/1.7.3/istio-1.7.3-linux-amd64.tar.gz
</span></span></code></pre></div></li>
<li>
<p>解压并切换到 Istio 包所在目录下。例如：Istio 包名为 <code>istio-1.7.3</code>，则：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ tar zxf istio-1.7.3-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ ll istio-1.7.3
</span></span><span style="display:flex;"><span>drwxr-x---  2 root root    22 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 bin
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root 11348 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 LICENSE
</span></span><span style="display:flex;"><span>drwxr-xr-x  6 root root    66 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 manifests
</span></span><span style="display:flex;"><span>-rw-r-----  1 root root   756 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 manifest.yaml
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root  5756 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 README.md
</span></span><span style="display:flex;"><span>drwxr-xr-x 20 root root   330 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 samples
</span></span><span style="display:flex;"><span>drwxr-x---  3 root root   133 Sep 27 08<span style="color:#960050;background-color:#1e0010">:</span>33 tools
</span></span></code></pre></div></li>
<li>
<p>将 <code>istioctl</code> 客户端拷贝到 path 环境变量中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cp bin/istioctl /bin/
</span></span></code></pre></div></li>
<li>
<p>配置命令自动补全</p>
<p><code>istioctl</code> 自动补全的文件位于 <code>tools</code> 目录。通过复制 <code>istioctl.bash</code> 文件到您的 home 目录，然后添加下行内容到您的 <code>.bashrc</code> 文件执行 <code>istioctl</code> tab 补全文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cp tools/istioctl.bash ~
</span></span><span style="display:flex;"><span>$ source ~/istioctl.bash
</span></span></code></pre></div></li>
</ol>
<h6 id="安装istio组件">安装istio组件<a hidden class="anchor" aria-hidden="true" href="#安装istio组件">#</a></h6>
<p><a href="https://istio.io/latest/zh/docs/setup/install/istioctl/#display-the-configuration-of-a-profile">https://istio.io/latest/zh/docs/setup/install/istioctl/#display-the-configuration-of-a-profile</a></p>
<p>使用istioctl直接安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl install --set profile=demo
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">✔</span> Istio core installed
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">✔</span> Istiod installed
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">✔</span> Egress gateways installed
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">✔</span> Ingress gateways installed
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">✔</span> Installation complete
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n istio-system get po
</span></span><span style="display:flex;"><span>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>istio-egressgateway-7bf76dd59-n9t5l     1/1     Running   0          77s
</span></span><span style="display:flex;"><span>istio-ingressgateway-586dbbc45d-xphjb   1/1     Running   0          77s
</span></span><span style="display:flex;"><span>istiod-6cc5758d8c-pz28m                 1/1     Running   0          84s
</span></span></code></pre></div><p>istio针对不同的环境，提供了几种不同的初始化部署的<a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/">profile</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 查看提供的profile类型</span>
</span></span><span style="display:flex;"><span>$ istioctl profile list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取kubernetes的yaml：</span>
</span></span><span style="display:flex;"><span>$ istioctl manifest generate --set profile=demo &gt; istio-kubernetes-manifest.yaml
</span></span></code></pre></div><h6 id="卸载">卸载<a hidden class="anchor" aria-hidden="true" href="#卸载">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl manifest generate --set profile=demo | kubectl delete <span style="color:#f92672">-f</span> -
</span></span></code></pre></div><h4 id="快速入门">快速入门<a hidden class="anchor" aria-hidden="true" href="#快速入门">#</a></h4>
<h5 id="场景一">场景一<a hidden class="anchor" aria-hidden="true" href="#场景一">#</a></h5>
<h6 id="模型图">模型图<a hidden class="anchor" aria-hidden="true" href="#模型图">#</a></h6>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/cj-1.jpg" alt=""  />
</p>
<h6 id="资源清单">资源清单<a hidden class="anchor" aria-hidden="true" href="#资源清单">#</a></h6>
<p><code>front-tomcat-dpl-v1.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat-v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">consol/tomcat-7.0:latest</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span></code></pre></div><p><code>bill-service-dpl-v1.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service-v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo &#39;this is bill-service-v1&#39;&gt;/usr/share/nginx/html/index.html;nginx -g &#39;daemon off;&#39;&#34;</span>]
</span></span></code></pre></div><p><code>bill-service-svc.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span></code></pre></div><h6 id="操作">操作<a hidden class="anchor" aria-hidden="true" href="#操作">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create namespace istio-demo
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> front-tomcat-dpl-v1.yaml
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> bill-service-dpl-v1.yaml
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> bill-service-svc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo exec front-tomcat-v1-548b46d488-r7wv8 -- curl -s bill-service
</span></span><span style="display:flex;"><span>this is bill-service-v1
</span></span></code></pre></div><h5 id="场景二">场景二<a hidden class="anchor" aria-hidden="true" href="#场景二">#</a></h5>
<p>后台账单服务更新v2版本，前期规划90%的流量访问v1版本，导入10%的流量到v2版本</p>
<h6 id="模型图-1">模型图<a hidden class="anchor" aria-hidden="true" href="#模型图-1">#</a></h6>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/cj-2.jpg" alt=""  />
</p>
<h6 id="资源清单-1">资源清单<a hidden class="anchor" aria-hidden="true" href="#资源清单-1">#</a></h6>
<p>新增<code>bill-service-dpl-v2.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service-v2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">service</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo &#39;hello, this is bill-service-v2&#39;&gt;/usr/share/nginx/html/index.html;nginx -g &#39;daemon off;&#39;&#34;</span>]
</span></span></code></pre></div><p>此时，访问规则会按照v1和v2的pod各50%的流量分配。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> bill-service-dpl-v2.yaml
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo exec front-tomcat-v1-548b46d488-r7wv8 --  curl -s bill-service<span style="color:#960050;background-color:#1e0010">:</span>9999
</span></span></code></pre></div><p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/cj-2-1.jpg" alt=""  />
</p>
<h6 id="使用istio">使用Istio<a hidden class="anchor" aria-hidden="true" href="#使用istio">#</a></h6>
<p>注入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl kube-inject <span style="color:#f92672">-f</span> bill-service-dpl-v1.yaml|kubectl apply <span style="color:#f92672">-f</span> -
</span></span><span style="display:flex;"><span>$ istioctl kube-inject <span style="color:#f92672">-f</span> bill-service-dpl-v2.yaml|kubectl apply <span style="color:#f92672">-f</span> -
</span></span><span style="display:flex;"><span>$ istioctl kube-inject <span style="color:#f92672">-f</span> front-tomcat-dpl-v1.yaml|kubectl apply <span style="color:#f92672">-f</span> -
</span></span></code></pre></div><p>若想实现上述需求，需要解决如下两个问题：</p>
<ul>
<li>让访问账单服务的流量按照我们期望的比例，其实是一条路由规则，如何定义这个规则</li>
<li>如何区分两个版本的服务</li>
</ul>
<p>两个新的资源类型：<code>VirtualService</code>和<code>DestinationRule</code></p>
<p><code>bill-service-destnation-rule.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DestinationRule</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dest-bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span></code></pre></div><p><code>bill-service-virtualservice.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VirtualService</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">vs-bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service-route</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">subset</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">subset</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p>使用client验证流量分配是否生效。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> bill-service-virtualservice.yaml
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> bill-service-destnation-rule.yaml
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo exec front-tomcat-v1-78cf497978-ltxpf -c front-tomcat -- curl -s bill-service
</span></span></code></pre></div><h5 id="服务网格细节剖析">服务网格细节剖析<a hidden class="anchor" aria-hidden="true" href="#服务网格细节剖析">#</a></h5>
<p>执行的操作：</p>
<ul>
<li>使用istioctl为pod注入了sidecar</li>
<li>创建了virtualservice和destinationrule</li>
</ul>
<p>如何最终影响到了pod的访问行为？</p>
<h6 id="宏观角度">宏观角度<a hidden class="anchor" aria-hidden="true" href="#宏观角度">#</a></h6>
<p>nginx的配置中，可以提供类似如下的配置片段实现按照权重的转发：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/nginx-weight.png" alt=""  />
</p>
<p>因为nginx是代理层，可以转发请求，istio也实现了流量转发的效果，肯定也有代理层，并且识别了前面创建的虚拟服务中定义的规则。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl kube-inject <span style="color:#f92672">-f</span> front-tomcat-dpl-v1.yaml
</span></span></code></pre></div><p>可以看到注入后yaml中增加了很多内容：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/inject.jpg" alt=""  />
</p>
<p>pod被istio注入后，被纳入到服务网格中，每个pod都会添加一个名为istio-proxy的容器（常说的sidecar容器），istio-proxy容器中有两个进程，一个是<code>piolot-agent</code>，一个是<code>envoy</code></p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/ll-3.jpg" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ps aux</span>
</span></span></code></pre></div><p>目前已知：</p>
<ul>
<li>在istio网格内，每个Pod都会被注入一个envoy代理</li>
<li>envoy充当nginx的角色，做为proxy代理，负责接管pod的入口和出口流量</li>
</ul>
<p>目前，还需要搞清楚几个问题：</p>
<ul>
<li>istio-init初始化容器作用是什么？</li>
<li>istio-proxy如何接管业务服务的出入口流量？</li>
</ul>
<h6 id="认识envoy">认识envoy<a hidden class="anchor" aria-hidden="true" href="#认识envoy">#</a></h6>
<p><code>Envoy</code> 是为云原生应用设计的代理。</p>
<p>可以和nginx做类比： <a href="https://fuckcloudnative.io/posts/migrating-from-nginx-to-envoy/">https://fuckcloudnative.io/posts/migrating-from-nginx-to-envoy/</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker run -d --name envoy -v `pwd`/envoy.yaml<span style="color:#960050;background-color:#1e0010">:</span>/etc/envoy/envoy.yaml -p 10000<span style="color:#960050;background-color:#1e0010">:</span>10000 envoyproxy/envoy-alpine<span style="color:#960050;background-color:#1e0010">:</span>v1.15.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl localhost<span style="color:#960050;background-color:#1e0010">:</span>10000
</span></span></code></pre></div><p><code>envoy.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">admin</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">access_log_path</span>: <span style="color:#ae81ff">/tmp/admin_access.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">address</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">socket_address</span>: { <span style="color:#f92672">address: 127.0.0.1, port_value</span>: <span style="color:#ae81ff">9901</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">static_resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">listeners</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">listener_0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">address</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">socket_address</span>: { <span style="color:#f92672">address: 0.0.0.0, port_value</span>: <span style="color:#ae81ff">10000</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">filter_chains</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">filters</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">envoy.http_connection_manager</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">stat_prefix</span>: <span style="color:#ae81ff">ingress_http</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">codec_type</span>: <span style="color:#ae81ff">AUTO</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">route_config</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">local_route</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">virtual_hosts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">local_service</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">domains</span>: [<span style="color:#e6db74">&#34;*&#34;</span>]
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">match</span>: { <span style="color:#f92672">prefix</span>: <span style="color:#e6db74">&#34;/&#34;</span> }
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">route</span>: { <span style="color:#f92672">cluster</span>: <span style="color:#ae81ff">some_service }</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">http_filters</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">envoy.router</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusters</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">some_service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">connect_timeout</span>: <span style="color:#ae81ff">2s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">STATIC</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lb_policy</span>: <span style="color:#ae81ff">ROUND_ROBIN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hosts</span>: [{ <span style="color:#f92672">socket_address</span>: { <span style="color:#f92672">address: 10.111.219.247, port_value</span>: <span style="color:#ae81ff">9999</span> }}]
</span></span></code></pre></div><p>脑补一下网络代理程序的流程，比如作为一个代理，首先要能获取请求流量，通常是采用监听端口的方式实现；其次拿到请求数据后需要对其做微处理，例如附加 <code>Header</code> 或校验某个 <code>Header</code> 字段的内容等，这里针对来源数据的层次不同，可以分为 <code>L3/L4/L7</code>，然后将请求转发出去；转发这里又可以衍生出如果后端是一个集群，需要从中挑选一台机器，如何挑选又涉及到负载均衡等。</p>
<ul>
<li><code>listener</code> : Envoy 的监听地址。Envoy 会暴露一个或多个 Listener 来监听客户端的请求。</li>
<li><code>filter</code> : 过滤器。在 Envoy 中指的是一些“可插拔”和可组合的逻辑处理层，是 Envoy 核心逻辑处理单元。</li>
<li><code>route_config</code> : 路由规则配置。即将请求路由到后端的哪个集群。</li>
<li><code>cluster</code> : 服务提供方集群。Envoy 通过服务发现定位集群成员并获取服务，具体路由到哪个集群成员由负载均衡策略决定。</li>
</ul>
<h6 id="envoy的xds">envoy的xDS<a hidden class="anchor" aria-hidden="true" href="#envoy的xds">#</a></h6>
<p>Envoy的启动配置文件分为两种方式：静态配置和动态配置。</p>
<ul>
<li>静态配置是将所有信息都放在配置文件中，启动的时候直接加载。</li>
<li>动态配置需要提供一个Envoy的服务端，用于动态生成Envoy需要的服务发现接口，这里叫XDS，通过发现服务来动态的调整配置信息，Istio就是实现了v2的API。</li>
</ul>
<p>Envoy 接收到请求后，会先走 <code>FilterChain</code>，通过各种 L3/L4/L7 Filter 对请求进行微处理，然后再路由到指定的集群，并通过负载均衡获取一个目标地址，最后再转发出去。</p>
<p>其中每一个环节可以静态配置，也可以动态服务发现，也就是所谓的 <code>xDS</code>。这里的 <code>x</code> 是一个代词，类似云计算里的 <code>XaaS</code> 可以指代 IaaS、PaaS、SaaS 等。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/xds.webp" alt=""  />
</p>
<p>所以，envoy的架构大致的样子如下：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/arct-envoy.png" alt=""  />
</p>
<p><strong>Downstream</strong></p>
<p>下游（downstream）主机连接到 Envoy，发送请求并或获得响应。</p>
<p><strong>Upstream</strong></p>
<p>上游（upstream）主机获取来自 Envoy 的链接请求和响应。</p>
<p><strong>监听器</strong></p>
<ul>
<li>除了过滤器链之外，还有一种过滤器叫<strong>监听器过滤器</strong>（Listener filters），它会在过滤器链之前执行，用于操纵连接的<strong>元数据</strong>。这样做的目的是，无需更改 Envoy 的核心代码就可以方便地集成更多功能。</li>
<li>每个监听器都可以配置多个过<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener_components.proto#envoy-v3-api-msg-config-listener-v3-filterchain">滤器链（Filter Chains）</a>，监听器会根据 <code>filter_chain_match</code> 中的<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener_components.proto#envoy-v3-api-msg-config-listener-v3-filterchainmatch">匹配条件</a>将流量转交到对应的过滤器链，其中每一个过滤器链都由一个或多个<strong>网络过滤器</strong>（<code>Network filters</code>）组成。这些过滤器用于执行不同的代理任务，如速率限制，<code>TLS</code> 客户端认证，<code>HTTP</code> 连接管理，<code>MongoDB</code> 嗅探，原始 TCP 代理等。</li>
</ul>
<h6 id="envoy在微服务治理中的工作环境">envoy在微服务治理中的工作环境<a hidden class="anchor" aria-hidden="true" href="#envoy在微服务治理中的工作环境">#</a></h6>
<p>可以在服务旁运行，以平台无关的方式提供必要的特性，所有到服务的流量都通过 <code>Envoy</code> 代理，这里 <code>Envoy</code> 扮演的就是 <code>Sidecar</code> 的角色。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/sidecar.png" alt=""  />
</p>
<p>针对于k8s的pod来讲：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/20200503110532.png" alt=""  />
</p>
<p>在istio中，envoy的位置：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/istio-mesh-arch.png" alt=""  />
</p>
<p>很明显，istio中，envoy进行流量治理，更多的使用的是XDS进行配置更新，而我们知道，XDS需要有服务端来提供接口，istiod中的pilot组件则提供了xDS服务端接口的实现 。</p>
<h6 id="工作原理">工作原理<a hidden class="anchor" aria-hidden="true" href="#工作原理">#</a></h6>
<p>目前为止，我们可以知道大致的工作流程：</p>
<ul>
<li>用户端，通过创建服务治理的规则（VirtualService、DestinationRule等资源类型），存储到ETCD中</li>
<li>istio控制平面中的Pilot服务监听上述规则，转换成envoy可读的规则配置，通过xDS接口同步给各envoy</li>
<li>envoy通过xDS获取最新的配置后，动态reload，进而改变流量转发的策略</li>
</ul>
<p>思考两个问题：</p>
<ul>
<li>istio中envoy的动态配置到底长什么样子？</li>
<li>在istio的网格内，front-tomcat访问到bill-service，流量的流向是怎么样的？</li>
</ul>
<p>针对问题1：</p>
<p>每个envoy进程启动的时候，会在<code>127.0.0.1</code>启动监听15000端口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># netstat -nltp</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl localhost:15000/help</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl localhost:15000/config_dump</span>
</span></span></code></pre></div><p>针对问题2：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl bill-service:9999</span>
</span></span></code></pre></div><p>按照之前的认知，</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/cluster-ip-route.jpg" alt=""  />
</p>
<p>现在为什么流量分配由5：5 变成了9：1？流量经过envoy了的处理</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/9-1.jpg" alt=""  />
</p>
<p>envoy如何接管由front-tomcat容器发出的请求流量？（istio-init</p>
<p>回顾iptables：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/iptables.jpg" alt=""  />
</p>
<p>Istio 给应用 Pod 注入的配置主要包括：</p>
<ul>
<li>
<p>Init 容器 <code>istio-init</code></p>
<p>Istio 在 pod 中注入的 Init 容器名为 <code>istio-init</code>，作用是为 pod 设置 iptables 端口转发。</p>
<p>我们在上面 Istio 注入完成后的 YAML 文件中看到了该容器的启动命令是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>istio-iptables -p <span style="color:#ae81ff">15001</span> -z <span style="color:#ae81ff">15006</span> -u <span style="color:#ae81ff">1337</span> -m REDIRECT -i <span style="color:#e6db74">&#39;*&#39;</span> -x <span style="color:#e6db74">&#34;&#34;</span> -b <span style="color:#e6db74">&#39;*&#39;</span> -d 15090,15021,15020
</span></span></code></pre></div><p>Init 容器的启动入口是 <code>istio-iptables</code> 命令行，该命令行工具的用法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ istio-iptables <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  -p: 指定重定向所有 TCP 出站流量的 sidecar 端口（默认为 $ENVOY_PORT <span style="color:#f92672">=</span> 15001）
</span></span><span style="display:flex;"><span>  -m: 指定入站连接重定向到 sidecar 的模式，“REDIRECT” 或 “TPROXY”（默认为 $ISTIO_INBOUND_INTERCEPTION_MODE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -b: 逗号分隔的入站端口列表，其流量将重定向到 Envoy（可选）。使用通配符 “*” 表示重定向所有端口。为空时表示禁用所有入站重定向（默认为 $ISTIO_INBOUND_PORTS）
</span></span><span style="display:flex;"><span>  -d: 指定要从重定向到 sidecar 中排除的入站端口列表（可选），以逗号格式分隔。使用通配符“*” 表示重定向所有入站流量（默认为 $ISTIO_LOCAL_EXCLUDE_PORTS）
</span></span><span style="display:flex;"><span>  -o：逗号分隔的出站端口列表，不包括重定向到 Envoy 的端口。
</span></span><span style="display:flex;"><span>  -i: 指定重定向到 sidecar 的 IP 地址范围（可选），以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量。空列表将禁用所有出站重定向（默认为 $ISTIO_SERVICE_CIDR）
</span></span><span style="display:flex;"><span>  -x: 指定将从重定向中排除的 IP 地址范围，以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量（默认为 $ISTIO_SERVICE_EXCLUDE_CIDR）。
</span></span><span style="display:flex;"><span>  -k：逗号分隔的虚拟接口列表，其入站流量（来自虚拟机的）将被视为出站流量。
</span></span><span style="display:flex;"><span>  -g：指定不应用重定向的用户的 GID。<span style="color:#f92672">(</span>默认值与 -u param 相同<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -u：指定不应用重定向的用户的 UID。通常情况下，这是代理容器的 UID（默认值是 1337，即 istio-proxy 的 UID）。
</span></span><span style="display:flex;"><span>  -z: 所有进入 pod/VM 的 TCP 流量应被重定向到的端口（默认 $INBOUND_CAPTURE_PORT <span style="color:#f92672">=</span> 15006）。
</span></span></code></pre></div><p>以上传入的参数都会重新组装成 <a href="https://wangchujiang.com/linux-command/c/iptables.html"><code>iptables</code> </a>规则，关于 Istio 中端口用途请参考 <a href="https://istio.io/latest/docs/ops/deployment/requirements/">Istio 官方文档</a>。</p>
<p>这条启动命令的作用是：</p>
<ul>
<li>将应用容器的所有入站流量都转发到 envoy的 15006 端口（15090 端口（Envoy Prometheus telemetry）和 15020 端口（Ingress Gateway）除外，15021（sidecar健康检查）端口）</li>
<li>将所有出站流量都重定向到 sidecar 代理（通过 15001 端口）</li>
<li>上述规则对id为1337用户除外，因为1337是istio-proxy自身的流量</li>
</ul>
<p>该容器存在的意义就是让 sidecar 代理可以拦截pod所有的入站（inbound）流量以及出站（outbound）流量，这样就可以实现由sidecar容器来接管流量，进尔实现流量管控。</p>
<p>因为 Init 容器初始化完毕后就会自动终止，因为我们无法登陆到容器中查看 iptables 信息，但是 Init 容器初始化结果会保留到应用容器和 sidecar 容器中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 查看front-tomcat服务的istio-proxy容器的id</span>
</span></span><span style="display:flex;"><span>$ docker ps |grep front-tomcat
</span></span><span style="display:flex;"><span>d02fa8217f2f        consol/tomcat-7.0                                   <span style="color:#e6db74">&#34;/bin/sh -c /opt/tom…&#34;</span>   2 days ago          Up 2 days
</span></span><span style="display:flex;"><span>                                              k8s_front-tomcat_front-tomcat-v1-78cf497978-ppwwk_istio-demo_f03358b1-ed17-4811-ac7e-9f70e6bd797b_0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 根据容器id获取front-tomcat容器在宿主机中的进程</span>
</span></span><span style="display:flex;"><span>$ docker inspect d02fa8217f2f|grep -i pid
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Pid&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 28834,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;PidMode&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;PidsLimit&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> null,
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入该进程的网络命名空间</span>
</span></span><span style="display:flex;"><span>$ nsenter -n --target 28834
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看命名空间的iptables规则</span>
</span></span><span style="display:flex;"><span>$ iptables -t nat -vnL
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。</span>
</span></span><span style="display:flex;"><span>Chain PREROUTING (policy ACCEPT 148 packets, 8880 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>  148  8880 ISTIO_INBOUND  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。</span>
</span></span><span style="display:flex;"><span>Chain INPUT (policy ACCEPT 148 packets, 8880 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。</span>
</span></span><span style="display:flex;"><span>Chain OUTPUT (policy ACCEPT 46 packets, 3926 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    8   480 ISTIO_OUTPUT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># POSTROUTING 链：所有数据包流出网卡时都要先进入POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。</span>
</span></span><span style="display:flex;"><span>Chain POSTROUTING (policy ACCEPT 46 packets, 3926 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上，目的地为 15090，15020，15021端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_INBOUND (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15008
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>22
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15090
</span></span><span style="display:flex;"><span>  143  8580 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15021
</span></span><span style="display:flex;"><span>    5   300 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15020
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_IN_REDIRECT 链：将所有入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到sidecar中。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_IN_REDIRECT (3 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            redir ports 15006
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_OUTPUT 链：选择需要重定向到 Envoy（即本地） 的出站流量，所有非 localhost 的流量全部转发到 ISTIO_REDIRECT。为了避免流量在该 Pod 中无限循环，所有到 istio-proxy 用户空间的流量都返回到它的调用点中的下一条规则，本例中即 OUTPUT 链，因为跳出 ISTIO_OUTPUT 规则之后就进入下一条链 POSTROUTING。如果目的地非 localhost 就跳转到 ISTIO_REDIRECT；如果流量是来自 istio-proxy 用户空间的，那么就跳出该链，返回它的调用链继续执行下一条规则（OUTPUT 的下一条规则，无需对流量进行处理）；所有的非 istio-proxy 用户空间的目的地是 localhost 的流量就跳转到 ISTIO_REDIRECT。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_OUTPUT (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      lo      127.0.0.6            0.0.0.0/0
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  all  --  *      lo      0.0.0.0/0           !127.0.0.1            owner UID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      lo      0.0.0.0/0            0.0.0.0/0            ! owner UID match 1337
</span></span><span style="display:flex;"><span>    8   480 <span style="color:#66d9ef">RETURN</span>     all  --  *      *       0.0.0.0/0            0.0.0.0/0            owner UID match 1337
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  all  --  *      lo      0.0.0.0/0           !127.0.0.1            owner GID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      lo      0.0.0.0/0            0.0.0.0/0            ! owner GID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      *       0.0.0.0/0            0.0.0.0/0            owner GID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      *       0.0.0.0/0            127.0.0.1
</span></span><span style="display:flex;"><span>    0     0 ISTIO_REDIRECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_REDIRECT 链：将所有流量重定向到 Sidecar（即本地） 的 15001 端口。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_REDIRECT (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            redir ports 15001
</span></span></code></pre></div></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash
</span></span><span style="display:flex;"><span>istio-proxy@front-tomcat-v1-78cf497978-ppwwk<span style="color:#960050;background-color:#1e0010">:</span>/$ netstat -nltp
</span></span><span style="display:flex;"><span>Active Internet connections (only servers)
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span></span><span style="display:flex;"><span>tcp        0      0 127.0.0.1<span style="color:#960050;background-color:#1e0010">:</span>15000         0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      16/envoy
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>15001           0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      16/envoy
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>15006           0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      16/envoy
</span></span><span style="display:flex;"><span>tcp        0      0 127.0.0.1<span style="color:#960050;background-color:#1e0010">:</span>8005          0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      -
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>8009            0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      -
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>8778            0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      -
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>15021           0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      16/envoy
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>8080            0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      -
</span></span><span style="display:flex;"><span>tcp        0      0 0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>15090           0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>*               LISTEN      16/envoy
</span></span><span style="display:flex;"><span>tcp6       0      0 ::<span style="color:#960050;background-color:#1e0010">:</span>15020                ::<span style="color:#960050;background-color:#1e0010">:</span>*                    LISTEN      1/pilot-agent
</span></span></code></pre></div><p>说明pod内的出站流量请求被监听在15001端口的envoy的进程接收到，进而就走到了envoy的Listener -&gt; route -&gt; cluster -&gt; endpoint 转发流程。</p>
<p>问题就转变为：如何查看envoy的配置，跟踪转发的过程？</p>
<h6 id="调试envoy">调试envoy<a hidden class="anchor" aria-hidden="true" href="#调试envoy">#</a></h6>
<p>我们知道，envoy的配置非常复杂，直接在config_dump里去跟踪xDS的过程非常繁琐。因此istio提供了调试命令，方便查看envoy的流量处理流程。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl proxy-config -h
</span></span></code></pre></div><p>比如，通过如下命令可以查看envoy的监听器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 查看15001的监听</span>
</span></span><span style="display:flex;"><span>$ istioctl proxy-config listener front-tomcat-v1-78cf497978-vv9wj.istio-demo --port 15001 -ojson
</span></span><span style="display:flex;"><span><span style="color:#75715e"># virtualOutbound的监听不做请求处理，hiddenEnvoyDeprecatedUseOriginalDst: true, 直接转到原始的请求对应的监听器中</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看访问端口是9999的监听器</span>
</span></span><span style="display:flex;"><span>$ istioctl proxy-config listener front-tomcat-v1-78cf497978-ppwwk.istio-demo --port 9999 -ojson
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0.0.0.0_9999&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 9999
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;filterChains&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;filterChainMatch&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;applicationProtocols&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;http/1.0&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;http/1.1&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;h2c&#34;</span>
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;filters&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;envoy.filters.network.http_connection_manager&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;typedConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;@type&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;statPrefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound_0.0.0.0_9999&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;rds&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;configSource&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;ads&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {},
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;resourceApiVersion&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;V3&#34;</span>
</span></span><span style="display:flex;"><span>                                },
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;routeConfigName&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;9999&#34;</span>
</span></span><span style="display:flex;"><span>                            },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><blockquote>
<p>envoy收到请求后，会转给监听器进行处理请求，监听器先匹配address和port和socket都一致的Listener，如果没找到再找port一致，address==0.0.0.0的Listener</p>
</blockquote>
<p>发现istio会为网格内的Service Port创建名为<code>0.0.0.0_&lt;Port&gt;</code>的虚拟监听器，本例中为<code>0.0.0.0_9999</code>。</p>
<p>envoy的15001端口收到请求后，直接转到了<code>0.0.0.0_9999</code>，进而转到了<code>&quot;routeConfigName&quot;: &quot;9999&quot;</code>，即9999这个route中。</p>
<p>下面，看下route的内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc route front-tomcat-v1-78cf497978-ppwwk.istio-demo --name 9999
</span></span><span style="display:flex;"><span>NOTE<span style="color:#960050;background-color:#1e0010">:</span> This output only contains routes loaded via RDS.
</span></span><span style="display:flex;"><span>NAME     DOMAINS          MATCH     VIRTUAL SERVICE
</span></span><span style="display:flex;"><span>9999     bill-service     /*        vs-bill-service.istio-demo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 发现了前面创建的virtual service</span>
</span></span><span style="display:flex;"><span>$ istioctl pc route front-tomcat-v1-78cf497978-ppwwk.istio-demo --name 9999 -ojson
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;9999&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;virtualHosts&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;allow_any&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;domains&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>                ],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;routes&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;allow_any&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;match&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;prefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;route&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;cluster&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;PassthroughCluster&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;timeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0s&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;maxGrpcTimeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0s&#34;</span>
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                ],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;includeRequestAttemptCount&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> true
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;bill-service.istio-demo.svc.cluster.local:9999&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;domains&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo.svc.cluster.local:9999&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service:9999&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo.svc.cluster&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo.svc.cluster:9999&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo.svc&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo.svc:9999&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;bill-service.istio-demo:9999&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;10.111.219.247&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;10.111.219.247:9999&#34;</span>
</span></span><span style="display:flex;"><span>                ],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;routes&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;bill-service-route&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;match&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;prefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;route&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;weightedClusters&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;clusters&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                                    {
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9999|v1|bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;weight&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 90
</span></span><span style="display:flex;"><span>                                    },
</span></span><span style="display:flex;"><span>                                    {
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9999|v2|bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;weight&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 10
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                ]
</span></span><span style="display:flex;"><span>                            },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>满足访问domains列表的会优先匹配到，我们访问的是<code>10.111.219.247:9999</code>，因此匹配<code>bill-service.istio-demo.svc.cluster.local:9999</code>这组虚拟hosts，进而使用到基于weight的集群配置。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/9-1.jpg" alt=""  />
</p>
<p>我们看到，流量按照预期的配置进行了转发：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>90% -&gt; outbound|9999|v1|bill-service.istio-demo.svc.cluster.local
</span></span><span style="display:flex;"><span>10% -&gt; outbound|9999|v2|bill-service.istio-demo.svc.cluster.local
</span></span></code></pre></div><p>下面，看一下cluster的具体内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc cluster front-tomcat-v1-78cf497978-ppwwk.istio-demo --fqdn bill-service.istio-demo.svc.cluster.local -ojson
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9999|v1|bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;EDS&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;edsClusterConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;edsConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ads&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {},
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;resourceApiVersion&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;V3&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;serviceName&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9999|v1|bill-service.istio-demo.svc.cluster.local&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>我们发现，endpoint列表是通过eds获取的，因此，查看endpoint信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc endpoint front-tomcat-v1-78cf497978-ppwwk.istio-demo  --cluster <span style="color:#e6db74">&#39;outbound|9999|v1|bill-service.istio-demo.svc.cluster.local&#39;</span> -ojson
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9999|v1|bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;addedViaApi&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;hostStatuses&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;10.244.0.17&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>目前为止，经过envoy的规则，流量从front-tomcat的pod中知道要发往<code>10.244.0.7:80</code> 这个pod地址。前面提到过，envoy不止接管出站流量，入站流量同样会接管。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/20200503110532.png" alt=""  />
</p>
<p>下面看下流量到达bill-service-v1的pod后的处理：</p>
<p>先回顾前面的iptables规则，除特殊情况以外，所有的出站流量被监听在15001端口的envoy进程拦截处理，同样的，分析bill-service-v1的iptables规则可以发现，监听在15006端口的envoy进程通过在PREROUTING链上添加规则，同样将进入pod的入站流量做了拦截。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。</span>
</span></span><span style="display:flex;"><span>Chain PREROUTING (policy ACCEPT 148 packets, 8880 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>  148  8880 ISTIO_INBOUND  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。</span>
</span></span><span style="display:flex;"><span>Chain INPUT (policy ACCEPT 148 packets, 8880 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上，目的地为 15090，15020，15021端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_INBOUND (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15008
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>22
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15090
</span></span><span style="display:flex;"><span>  143  8580 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15021
</span></span><span style="display:flex;"><span>    5   300 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15020
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_IN_REDIRECT 链：将所有入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到sidecar中。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_IN_REDIRECT (3 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            redir ports 15006
</span></span></code></pre></div><p>15006端口是一个名为 <code>virtualInbound</code>虚拟入站监听器，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc l bill-service-v1-6c95ccb747-vwt2d.istio-demo --port 15006 -ojson&gt;/tmp/15006.inbound.json
</span></span></code></pre></div><p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/inbound-15006.jpg" alt=""  />
</p>
<p>相比于<code>VirtualOutbound</code>， <code>virtualInbound</code> 不会再次转给别的虚拟监听器，而是直接由本监听器的<code>filterChains</code>处理，本例中我们可以发现本机目标地址为80的http请求，转发到了<code>inbound|9999|http|bill-service.istio-demo.svc.cluster.local</code>这个集群中。</p>
<p>查看该集群的信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc cluster bill-service-v1-6c95ccb747-vwt2d.istio-demo -h
</span></span><span style="display:flex;"><span>$ istioctl pc cluster bill-service-v1-6c95ccb747-vwt2d.istio-demo --direction inbound -ojson
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound|9999|http|bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;STATIC&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;connectTimeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;10s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;loadAssignment&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;clusterName&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound|9999|http|bill-service.istio-demo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;endpoints&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;lbEndpoints&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;endpoint&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;circuitBreakers&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;thresholds&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxConnections&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxPendingRequests&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxRequests&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxRetries&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h6 id="一点小知识">一点小知识<a hidden class="anchor" aria-hidden="true" href="#一点小知识">#</a></h6>
<p><strong>同一个Pod，不同的表现</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl bill-service:9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl bill-service:9999</span>
</span></span></code></pre></div><p>可以发现，在front-tomcat中的访问请求，是受到我们设置的 9：1的流量分配规则限制的，但是istio-proxy中的访问是不受限制的。</p>
<blockquote>
<p>istio-proxy自身，发起的往10.244.0.17的请求，使用的用户是 <code>uid=1337(istio-proxy)</code>，因此不会被<code>istio-init</code>初始化的防火墙规则拦截，可以直接走pod的网络进行通信。</p>
</blockquote>
<p><strong>istio服务网格内，流量请求完全绕过了kube-proxy组件</strong></p>
<p>通过上述流程调试，我们可以得知，front-tomcat中访问bill-service:9999，流量是没有用到kube-proxy维护的宿主机中的iptables规则的。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/kubernetes-vs-service-mesh.png" alt=""  />
</p>
<p>验证一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 停掉kube-proxy</span>
</span></span><span style="display:flex;"><span>$ kubectl -n kube-system edit daemonset kube-proxy
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>      dnsPolicy<span style="color:#960050;background-color:#1e0010">:</span> ClusterFirst                 
</span></span><span style="display:flex;"><span>      hostNetwork<span style="color:#960050;background-color:#1e0010">:</span> true                       
</span></span><span style="display:flex;"><span>      nodeSelector<span style="color:#960050;background-color:#1e0010">:</span>                           
</span></span><span style="display:flex;"><span>        beta.kubernetes.io/os<span style="color:#960050;background-color:#1e0010">:</span> linux1    <span style="color:#75715e">#把此处修改一个不存在的label值     </span>
</span></span><span style="display:flex;"><span>      priorityClassName<span style="color:#960050;background-color:#1e0010">:</span> system-node-critical 
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#清理iptables规则</span>
</span></span><span style="display:flex;"><span>$ iptables <span style="color:#f92672">-F</span> -t nat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 访问测试</span>
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo get  svc
</span></span><span style="display:flex;"><span>NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
</span></span><span style="display:flex;"><span>bill-service   ClusterIP   10.111.219.247   &lt;none&gt;        9999/TCP   2d18h
</span></span><span style="display:flex;"><span>$ curl 10.111.219.247<span style="color:#960050;background-color:#1e0010">:</span>9999 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入front-tomcat容器进行访问</span>
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl 10.111.219.247:9999 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl bill-service:9999 会因为dns解析失败而访问失败，手动配置namespaceserver即可</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c istio-proxy bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl curl 10.111.219.247:9999 </span>
</span></span></code></pre></div><p><strong>集群内的Service都相应的创建了虚拟出站监听器</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-demo exec -ti front-tomcat-v1-78cf497978-ppwwk -c front-tomcat bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># curl sonarqube.jenkins:9000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ istioctl pc l front-tomcat-v1-78cf497978-ppwwk.istio-demo --port 9000 
</span></span><span style="display:flex;"><span>ADDRESS      PORT MATCH     DESTINATION
</span></span><span style="display:flex;"><span>10.97.243.33 9000 App<span style="color:#960050;background-color:#1e0010">:</span> HTTP Route<span style="color:#960050;background-color:#1e0010">:</span> sonarqube.jenkins.svc.cluster.local<span style="color:#960050;background-color:#1e0010">:</span>9000
</span></span><span style="display:flex;"><span>10.97.243.33 9000 ALL       Cluster<span style="color:#960050;background-color:#1e0010">:</span> outbound|9000||sonarqube.jenkins.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ istioctl pc r front-tomcat-v1-78cf497978-ppwwk.istio-demo --name <span style="color:#e6db74">&#39;sonarqube.jenkins.svc.cluster.local:9000&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ istioctl pc ep front-tomcat-v1-78cf497978-ppwwk.istio-demo --cluster <span style="color:#e6db74">&#39;outbound|9000||sonarqube.jenkins.svc.cluster.local&#39;</span>
</span></span></code></pre></div><p>virtualOutBound 15001 &ndash;&gt; virtial listener 10.97.243.33_9000  &ndash;&gt; route sonarqube.jenkins.svc.cluster.local:9000  &ndash;&gt; cluster  outbound|9000||sonarqube.jenkins.svc.cluster.local &ndash;&gt; 10.244.1.13:9000</p>
<h5 id="场景三">场景三<a hidden class="anchor" aria-hidden="true" href="#场景三">#</a></h5>
<h6 id="模型图-2">模型图<a hidden class="anchor" aria-hidden="true" href="#模型图-2">#</a></h6>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/cj-3.jpg" alt=""  />
</p>
<h6 id="资源清单-2">资源清单<a hidden class="anchor" aria-hidden="true" href="#资源清单-2">#</a></h6>
<p><code>front-tomcat-service.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span></code></pre></div><p><code>front-tomcat-v2-dpl.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat-v2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">consol/tomcat-7.0:latest</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo &#39;hello tomcat version2&#39;&gt;/opt/tomcat/webapps/ROOT/index.html;/opt/tomcat/bin/deploy-and-run.sh;&#34;</span>]
</span></span></code></pre></div><p><code>front-tomcat-virtualservice.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VirtualService</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat-route</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">subset</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">subset</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DestinationRule</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> front-tomcat-service.yaml
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> &lt;(istioctl kube-inject <span style="color:#f92672">-f</span> front-tomcat-v2-dpl.yaml)
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> front-tomcat-virtualservice.yaml
</span></span></code></pre></div><h5 id="使用ingress来访问网格服务">使用ingress来访问网格服务<a hidden class="anchor" aria-hidden="true" href="#使用ingress来访问网格服务">#</a></h5>
<p><code>front-tomcat-ingress.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.istio-demo.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><p>使用浏览器访问查看效果。</p>
<p>只有网格内部访问会遵从<code>virtualservice</code>的规则，在宿主机中直接访问Service的ClusterIP还是按照默认的规则转发。</p>
<p>Ingress：对接ingress controller，实现外部流量进入集群内部，只适用于 HTTP 流量，使用方式也很简单，只能对 service、port、HTTP 路径等有限字段匹配来路由流量，这导致它无法路由如 MySQL、Redis 和各种私有 RPC 等 TCP 流量。要想直接路由南北向的流量，只能使用 Service 的 LoadBalancer 或 NodePort，前者需要云厂商支持，后者需要进行额外的端口管理。有些 Ingress controller 支持暴露 TCP 和 UDP 服务，但是只能使用 Service 来暴露，Ingress 本身是不支持的，例如 nginx ingress controller，服务暴露的端口是通过创建 ConfigMap 的方式来配置的。</p>
<h5 id="ingressgateway访问网格服务">ingressgateway访问网格服务<a hidden class="anchor" aria-hidden="true" href="#ingressgateway访问网格服务">#</a></h5>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/gateways.svg" alt=""  />
</p>
<p>对于入口流量管理，您可能会问： 为什么不直接使用 Kubernetes Ingress API ？ 原因是 Ingress API 无法表达 Istio 的路由需求。 Ingress 试图在不同的 HTTP 代理之间取一个公共的交集，因此只能支持最基本的 HTTP 路由，最终导致需要将代理的其他高级功能放入到注解（annotation）中，而注解的方式在多个代理之间是不兼容的，无法移植。</p>
<p>Istio <code>Gateway</code> 通过将 L4-L6 配置与 L7 配置分离的方式克服了 <code>Ingress</code> 的这些缺点。 <code>Gateway</code> 只用于配置 L4-L6 功能（例如，对外公开的端口，TLS 配置），所有主流的L7代理均以统一的方式实现了这些功能。 然后，通过在 <code>Gateway</code> 上绑定 <code>VirtualService</code> 的方式，可以使用标准的 Istio 规则来控制进入 <code>Gateway</code> 的 HTTP 和 TCP 流量。</p>
<p><code>front-tomcat-gateway.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>: <span style="color:#ae81ff">ingressgateway</span> <span style="color:#75715e"># use istio default controller</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">tomcat.istio-demo.com</span>
</span></span></code></pre></div><p>效果是在Istio的ingress网关上加了一条规则，允许``tomcat.istio-demo.com` 的外部http流量进入到网格中，但是只是接受访问和流量输入，当流量到达这个网关时，它还不知道发送到哪里去。</p>
<p>网关已准备好接收流量，我们必须告知它将收到的流量发往何处，这就用到了前面使用过的<code>VirtualService</code>。</p>
<p>要为进入上面的 Gateway 的流量配置相应的路由，必须为同一个 host 定义一个 <code>VirtualService</code>，并使用配置中的 <code>gateways</code> 字段绑定到前面定义的 <code>Gateway</code> 上</p>
<p><code>front-tomcat-gateway-virtualservice.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VirtualService</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gateway-front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">istio-demo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gateways</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">front-tomcat-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">tomcat.istio-demo.com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">front-tomcat-route</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">subset</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">front-tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">subset</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p>该网关列表指定，只有通过我们指定的网关 <code>front-tomcat-gateway</code> 的流量是允许的。所有其他外部请求将被拒绝，并返回 404 响应。</p>
<blockquote>
<p>请注意，在此配置中，来自网格中其他服务的内部请求不受这些规则约束</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> front-tomcat-gateway-virtualservice.yaml
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> front-tomcat-gateway.yaml
</span></span></code></pre></div><p>模拟访问：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-system get service istio-ingressgateway -o jsonpath=<span style="color:#e6db74">&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span>
</span></span><span style="display:flex;"><span>31995
</span></span><span style="display:flex;"><span>$ curl  -HHost<span style="color:#960050;background-color:#1e0010">:</span>tomcat.istio-demo.com 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>31995/
</span></span></code></pre></div><p><code>172.21.51.67:31995</code>地址从何而来？</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/gateway.png" alt=""  />
</p>
<p>浏览器访问: <code>http://tomcat.istio-demo.com:31995/</code></p>
<p>如何实现不加端口访问网格内服务？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 在一台80端口未被占用的机器中，如ip为172.21.51.69</span>
</span></span><span style="display:flex;"><span>$ docker run -d --restart=always -p 80<span style="color:#960050;background-color:#1e0010">:</span>80 --name istio-nginx nginx<span style="color:#960050;background-color:#1e0010">:</span>alpine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在容器的/etc/nginx/conf.d/目录中，新增配置文件</span>
</span></span><span style="display:flex;"><span>$ cat front-tomcat.conf
</span></span><span style="display:flex;"><span>upstream front-tomcat {
</span></span><span style="display:flex;"><span>  server 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>31995;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    listen  [::]<span style="color:#960050;background-color:#1e0010">:</span>80;
</span></span><span style="display:flex;"><span>    server_name  tomcat.istio-demo.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / {
</span></span><span style="display:flex;"><span>        proxy_set_header Host $host;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        proxy_http_version 1.1;
</span></span><span style="display:flex;"><span>        proxy_pass http<span style="color:#960050;background-color:#1e0010">:</span>//front-tomcat;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nginx -s reload
</span></span></code></pre></div><p>本地配置hosts</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>172.21.51.69 tomcat.istio-demo.com
</span></span></code></pre></div><p>直接访问<code>http://tomcat.istio-demo.com</code> 即可实现外部域名访问到网格内部服务</p>
<h4 id="实例演示">实例演示<a hidden class="anchor" aria-hidden="true" href="#实例演示">#</a></h4>
<h5 id="实例介绍">实例介绍<a hidden class="anchor" aria-hidden="true" href="#实例介绍">#</a></h5>
<p>创建bookinfo实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create namespace bookinfo
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo create <span style="color:#f92672">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml 
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo get po 
</span></span><span style="display:flex;"><span>NAME                                  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>details-v1-5974b67c8-wclnd            1/1     Running   0          34s
</span></span><span style="display:flex;"><span>productpage-v1-64794f5db4-jsdbg       1/1     Running   0          33s
</span></span><span style="display:flex;"><span>ratings-v1-c6cdf8d98-jrfrn            1/1     Running   0          33s
</span></span><span style="display:flex;"><span>reviews-v1-7f6558b974-kq6kj           1/1     Running   0          33s
</span></span><span style="display:flex;"><span>reviews-v2-6cb6ccd848-qdg2k           1/1     Running   0          34s
</span></span><span style="display:flex;"><span>reviews-v3-cc56b578-kppcx             1/1     Running   0          34s
</span></span></code></pre></div><p>该应用由四个单独的微服务构成。 这个应用模仿在线书店的一个分类，显示一本书的信息。 页面上会显示一本书的描述，书籍的细节（ISBN、页数等），以及关于这本书的一些评论。</p>
<p>Bookinfo 应用分为四个单独的微服务：</p>
<ul>
<li><code>productpage</code>. 这个微服务会调用 <code>details</code> 和 <code>reviews</code> 两个微服务，用来生成页面。</li>
<li><code>details</code>. 这个微服务中包含了书籍的信息。</li>
<li><code>reviews</code>. 这个微服务中包含了书籍相关的评论。它还会调用 <code>ratings</code> 微服务。</li>
<li><code>ratings</code>. 这个微服务中包含了由书籍评价组成的评级信息。</li>
</ul>
<p><code>reviews</code> 微服务有 3 个版本：</p>
<ul>
<li>
<p>v1 版本不会调用 <code>ratings</code> 服务。</p>
</li>
<li>
<p>v2 版本会调用 <code>ratings</code> 服务，并使用 1 到 5 个黑色星形图标来显示评分信息。</p>
</li>
<li>
<p>v3 版本会调用 <code>ratings</code> 服务，并使用 1 到 5 个红色星形图标来显示评分信息。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/noistio.svg" alt=""  />
</p>
</li>
</ul>
<p>Bookinfo 是一个异构应用，几个微服务是由不同的语言编写的。这些服务对 Istio 并无依赖，但是构成了一个有代表性的服务网格的例子：它由多个服务、多个语言构成，并且 <code>reviews</code> 服务具有多个版本。</p>
<p>使用ingress访问productpage服务：</p>
<p><code>ingress-productpage.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">productpage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">bookinfo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">productpage.bookinfo.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">productpage</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">9080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><p>如何实现更细粒度的流量管控？</p>
<h5 id="注入sidecar容器">注入sidecar容器<a hidden class="anchor" aria-hidden="true" href="#注入sidecar容器">#</a></h5>
<h6 id="如何注入sidecar容器">如何注入sidecar容器<a hidden class="anchor" aria-hidden="true" href="#如何注入sidecar容器">#</a></h6>
<ol>
<li>
<p>使用<code>istioctl kube-inject</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo apply <span style="color:#f92672">-f</span> &lt;(istioctl kube-inject <span style="color:#f92672">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml)
</span></span></code></pre></div></li>
<li>
<p>为命名空间打label</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 给命名空间打标签，这样部署在该命名空间的服务会自动注入sidecar容器</span>
</span></span><span style="display:flex;"><span>$ kubectl label namespace dafault istio-injection=enabled
</span></span></code></pre></div></li>
</ol>
<h6 id="注入bookinfo">注入bookinfo<a hidden class="anchor" aria-hidden="true" href="#注入bookinfo">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo apply <span style="color:#f92672">-f</span> &lt;(istioctl kube-inject <span style="color:#f92672">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml) 
</span></span></code></pre></div><p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/withistio.svg" alt=""  />
</p>
<h5 id="流量路由">流量路由<a hidden class="anchor" aria-hidden="true" href="#流量路由">#</a></h5>
<p>实现ingress解决不了的按照比例分配流量</p>
<h6 id="ingress-gateway访问productpage">ingress-gateway访问productpage<a hidden class="anchor" aria-hidden="true" href="#ingress-gateway访问productpage">#</a></h6>
<p><code>productpage-gateway.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">productpage-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">bookinfo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>: <span style="color:#ae81ff">ingressgateway</span> <span style="color:#75715e"># use istio default controller</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">productpage.bookinfo.com</span>
</span></span></code></pre></div><p><code>productpage-virtualservice.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VirtualService</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gateway-front-tomcat</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">bookinfo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gateways</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">productpage-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">productpage.bookinfo.com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">productpage</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">number</span>: <span style="color:#ae81ff">9080</span>
</span></span></code></pre></div><p>配置nginx，使用域名80端口访问。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>upstream bookinfo-productpage {
</span></span><span style="display:flex;"><span>  server 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>31995;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    listen  [::]<span style="color:#960050;background-color:#1e0010">:</span>80;
</span></span><span style="display:flex;"><span>    server_name  productpage.bookinfo.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / {
</span></span><span style="display:flex;"><span>        proxy_set_header Host $host;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        proxy_http_version 1.1;
</span></span><span style="display:flex;"><span>        proxy_pass http<span style="color:#960050;background-color:#1e0010">:</span>//bookinfo-productpage;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/withistio.svg" alt=""  />
</p>
<h6 id="权重路由">权重路由<a hidden class="anchor" aria-hidden="true" href="#权重路由">#</a></h6>
<p>只想访问<code>reviews-v3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat virtual-service-reviews-v3.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> VirtualService
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  hosts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - reviews
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat destination-rule-reviews.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> DestinationRule
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>  trafficPolicy<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    loadBalancer<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      simple<span style="color:#960050;background-color:#1e0010">:</span> RANDOM
</span></span><span style="display:flex;"><span>  subsets<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>    labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>    labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> v3
</span></span><span style="display:flex;"><span>    labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> virtual-service-reviews-v3.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 访问productpage测试</span>
</span></span></code></pre></div><p>实现如下流量分配：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>90% -&gt; reivews-v1
</span></span><span style="display:flex;"><span>10% -&gt; reviews-v2
</span></span><span style="display:flex;"><span>0%  -&gt; reviews-v3
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat virtual-service-reviews-90-10.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> VirtualService
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  hosts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - reviews
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>      weight<span style="color:#960050;background-color:#1e0010">:</span> 90
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>      weight<span style="color:#960050;background-color:#1e0010">:</span> 10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> virtual-service-reviews-90-10.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 假如v2版本的副本数扩容为3，v2版本的流量会如何分配？  会不会变成30%？</span>
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo scale deploy reviews-v2 --replicas=3
</span></span></code></pre></div><h6 id="访问路径路由">访问路径路由<a hidden class="anchor" aria-hidden="true" href="#访问路径路由">#</a></h6>
<p>实现效果如下：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/ll-4.jpg" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 定义允许外部流量进入网格,直接编辑已有gateway</span>
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo edit gw productpage-gateway
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat bookinfo-routing-with-uri-path.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> VirtualService
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  gateways<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - productpage-gateway
</span></span><span style="display:flex;"><span>  hosts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - bookinfo.com
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> productpage-route
</span></span><span style="display:flex;"><span>    match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - uri<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        prefix<span style="color:#960050;background-color:#1e0010">:</span> /productpage
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> productpage
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> reviews-route
</span></span><span style="display:flex;"><span>    match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - uri<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        prefix<span style="color:#960050;background-color:#1e0010">:</span> /reviews
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> ratings-route
</span></span><span style="display:flex;"><span>    match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - uri<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        prefix<span style="color:#960050;background-color:#1e0010">:</span> /ratings
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> ratings
</span></span></code></pre></div><p>nginx中新增配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>upstream bookinfo {
</span></span><span style="display:flex;"><span>  server 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>31995;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    listen  [::]<span style="color:#960050;background-color:#1e0010">:</span>80;
</span></span><span style="display:flex;"><span>    server_name  bookinfo.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / {
</span></span><span style="display:flex;"><span>        proxy_set_header Host $host;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        proxy_http_version 1.1;
</span></span><span style="display:flex;"><span>        proxy_pass http<span style="color:#960050;background-color:#1e0010">:</span>//bookinfo;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>访问：</p>
<p><code>http://bookinfo.com/productpage</code></p>
<p><code>http://bookinfo.com/ratings/1</code></p>
<p>实际的访问对应为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>bookinfo.com/productpage  -&gt; productpage<span style="color:#960050;background-color:#1e0010">:</span>8090/productpage
</span></span><span style="display:flex;"><span>bookinfo.com/ratings  -&gt;  ratings<span style="color:#960050;background-color:#1e0010">:</span>9080/ratings
</span></span><span style="display:flex;"><span>bookinfo.com/reviews  -&gt;  reviews<span style="color:#960050;background-color:#1e0010">:</span>9080/reviews
</span></span></code></pre></div><p>实际访问productpage页面，由于需要引用css、js等静态资源，因此需要补充对<code>/static</code>路径的转发：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">productpage-route</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">match</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">uri</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prefix</span>: <span style="color:#ae81ff">/productpage</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">uri</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prefix</span>: <span style="color:#ae81ff">/static</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">productpage</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><code>virtualservice</code>的配置中并未指定service的port端口，转发同样可以生效？</p>
<blockquote>
<p>注意，若service中只有一个端口，则不用显式指定端口号，会自动转发到该端口中</p>
</blockquote>
<h6 id="路径重写">路径重写<a hidden class="anchor" aria-hidden="true" href="#路径重写">#</a></h6>
<p>如果想实现rewrite的功能，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>bookinfo.com/rate  -&gt; ratings<span style="color:#960050;background-color:#1e0010">:</span>8090/ratings
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ratings-route</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">match</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">uri</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">prefix</span>: <span style="color:#ae81ff">/rate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rewrite</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">uri</span>: <span style="color:#e6db74">&#34;/ratings&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">ratings</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h6 id="匹配优先级">匹配优先级<a hidden class="anchor" aria-hidden="true" href="#匹配优先级">#</a></h6>
<p>登录发现<code>/login</code>的匹配也没有添加，后续有可能有别的，因此可以在规则列表最后添加一个规则，作为默认的转发规则。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo edit vs bookinfo
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> default-route
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> productpage
</span></span></code></pre></div><h6 id="destinationrule-转发策略">DestinationRule 转发策略<a hidden class="anchor" aria-hidden="true" href="#destinationrule-转发策略">#</a></h6>
<p>默认会使用轮询策略，此外也支持如下负载均衡模型，可以在 <code>DestinationRule</code> 中使用这些模型，将请求分发到特定的服务或服务子集。</p>
<ul>
<li>Random：将请求转发到一个随机的实例上</li>
<li>Weighted：按照指定的百分比将请求转发到实例上</li>
<li>Least requests：将请求转发到具有最少请求数目的实例上</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1alpha3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DestinationRule</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-destination-rule</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">my-svc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">trafficPolicy</span>:     <span style="color:#75715e">#默认的负载均衡策略模型为随机</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">loadBalancer</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">simple</span>: <span style="color:#ae81ff">RANDOM</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">subsets</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1 </span> <span style="color:#75715e">#subset1，将流量转发到具有标签 version:v1 的 deployment 对应的服务上</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v2 </span> <span style="color:#75715e">#subset2，将流量转发到具有标签 version:v2 的 deployment 对应的服务上,指定负载均衡为轮询</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">trafficPolicy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">loadBalancer</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">simple</span>: <span style="color:#ae81ff">ROUND_ROBIN</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v3  </span> <span style="color:#75715e">#subset3，将流量转发到具有标签 version:v3 的 deployment 对应的服务上</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v3</span>
</span></span></code></pre></div><h6 id="使用https">使用https<a hidden class="anchor" aria-hidden="true" href="#使用https">#</a></h6>
<p>方式一：把证书绑定在外部的nginx中， nginx 443端口监听外网域名并转发请求到Istio Ingress网关IP+http端口 ，如果使用公有云lb的话（如slb，clb），可以在lb层绑定证书</p>
<p>方式二：在istio侧使用证书</p>
<p><a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/">https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/</a></p>
<h6 id="header头路由">header头路由<a hidden class="anchor" aria-hidden="true" href="#header头路由">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat virtual-service-reviews-header.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> VirtualService
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  hosts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - reviews
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - headers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        end-user<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          exact<span style="color:#960050;background-color:#1e0010">:</span> luffy
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>  - route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v3
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> virtual-service-reviews-header.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 刷新观察http://bookinfo.com/productpage</span>
</span></span></code></pre></div><p>更多支持的匹配类型可以在此处查看。</p>
<p><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest">https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest</a></p>
<h5 id="流量镜像">流量镜像<a hidden class="anchor" aria-hidden="true" href="#流量镜像">#</a></h5>
<h6 id="介绍">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍">#</a></h6>
<p>很多情况下，当我们对服务做了重构，或者我们对项目做了重大优化时，怎么样保证服务是健壮的呢？在传统的服务里，我们只能通过大量的测试，模拟在各种情况下服务的响应情况。虽然也有手工测试、自动化测试、压力测试等一系列手段去检测它，但是测试本身就是一个样本化的行为，即使测试人员再完善它的测试样例，无法全面的表现出线上服务的一个真实流量形态 。</p>
<p>流量镜像的设计，让这类问题得到了最大限度的解决。流量镜像讲究的不再是使用少量样本去评估一个服务的健壮性，而是在不影响线上坏境的前提下将线上流量持续的镜像到我们的预发布坏境中去，让重构后的服务在上线之前就结结实实地接受一波真实流量的冲击与考验，让所有的风险全部暴露在上线前夕，通过不断的暴露问题，解决问题让服务在上线前夕就拥有跟线上服务一样的健壮性。由于测试坏境使用的是真实流量，所以不管从流量的多样性，真实性，还是复杂性上都将能够得以展现，同时预发布服务也将表现出其最真实的处理能力和对异常的处理能力。</p>
<h6 id="实践">实践<a hidden class="anchor" aria-hidden="true" href="#实践">#</a></h6>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/shadow-in-one-mesh.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 准备httpbin v1</span>
</span></span><span style="display:flex;"><span>$ cat httpbin-v1.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> httpbin-v1
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        version<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - image<span style="color:#960050;background-color:#1e0010">:</span> docker.io/kennethreitz/httpbin
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> IfNotPresent
</span></span><span style="display:flex;"><span>        name<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        command<span style="color:#960050;background-color:#1e0010">:</span> [<span style="color:#e6db74">&#34;gunicorn&#34;</span>, <span style="color:#e6db74">&#34;--access-logfile&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;-b&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0:80&#34;</span>, <span style="color:#e6db74">&#34;httpbin:app&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ istioctl kube-inject <span style="color:#f92672">-f</span> httpbin-v1.yaml | kubectl create <span style="color:#f92672">-f</span> -
</span></span><span style="display:flex;"><span>$ curl $(kubectl -n bookinfo get po  -l version=v1,app=httpbin -ojsonpath=<span style="color:#e6db74">&#39;{.items[0].status.podIP}&#39;</span>)/headers
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;headers&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Accept&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;*/*&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Content-Length&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Host&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;10.244.0.88&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;User-Agent&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;curl/7.29.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;X-B3-Sampled&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;X-B3-Spanid&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;777c7af4458c5b81&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;X-B3-Traceid&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;6b98ea81618deb4f777c7af4458c5b81&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 准备httpbin v2</span>
</span></span><span style="display:flex;"><span>$ cat httpbin-v2.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> httpbin-v2
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        version<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - image<span style="color:#960050;background-color:#1e0010">:</span> docker.io/kennethreitz/httpbin
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> IfNotPresent
</span></span><span style="display:flex;"><span>        name<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        command<span style="color:#960050;background-color:#1e0010">:</span> [<span style="color:#e6db74">&#34;gunicorn&#34;</span>, <span style="color:#e6db74">&#34;--access-logfile&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;-b&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0:80&#34;</span>, <span style="color:#e6db74">&#34;httpbin:app&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ istioctl kube-inject <span style="color:#f92672">-f</span> httpbin-v2.yaml | kubectl create <span style="color:#f92672">-f</span> -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Service文件</span>
</span></span><span style="display:flex;"><span>$ cat httpbin-svc.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> http
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 8000
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> httpbin-svc.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用bookinfo.com/httpbin访问,因此直接修改bookinfo这个virtualservice即可</span>
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo get vs
</span></span><span style="display:flex;"><span>NAME                   GATEWAYS                HOSTS               
</span></span><span style="display:flex;"><span>bookinfo               [bookinfo-gateway]      <span style="color:#66d9ef">[bookinfo.com]</span>       
</span></span><span style="display:flex;"><span>gateway-front-tomcat   [productpage-gateway]   <span style="color:#66d9ef">[productpage.bookinfo.com]</span>
</span></span><span style="display:flex;"><span>reviews                                        <span style="color:#66d9ef">[reviews]</span>     
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo edit vs bookinfo
</span></span><span style="display:flex;"><span><span style="color:#75715e">#添加httpbin的规则</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - uri<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        prefix<span style="color:#960050;background-color:#1e0010">:</span> /httpbin
</span></span><span style="display:flex;"><span>    name<span style="color:#960050;background-color:#1e0010">:</span> httpbin-route
</span></span><span style="display:flex;"><span>    rewrite<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      uri<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建gateway和virtualservice,由于都是使用http请求，因此，直接</span>
</span></span><span style="display:flex;"><span>$ cat httpbin-destinationRule.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> DestinationRule
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>  subsets<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>    labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>    labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      version<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> httpbin-destinationRule.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 访问http://bookinfo.com/httpbin/headers，查看日志</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为httpbin-v1添加mirror设置，mirror点为httpbin-v2</span>
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo edit vs bookinfo
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - uri<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        prefix<span style="color:#960050;background-color:#1e0010">:</span> /httpbin
</span></span><span style="display:flex;"><span>    name<span style="color:#960050;background-color:#1e0010">:</span> httpbin-route
</span></span><span style="display:flex;"><span>    rewrite<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      uri<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>    mirror<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>      subset<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>    mirror_percent<span style="color:#960050;background-color:#1e0010">:</span> 100
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h5 id="重试">重试<a hidden class="anchor" aria-hidden="true" href="#重试">#</a></h5>
<p>在网络环境不稳定的情况下，会出现暂时的网络不可达现象，这时需要重试机制，通过多次尝试来获取正确的返回信息。 istio 可以通过简单的配置来实现重试功能，让开发人员无需关注重试部分的代码实现，专心实现业务代码。</p>
<h6 id="实践-1">实践<a hidden class="anchor" aria-hidden="true" href="#实践-1">#</a></h6>
<p>浏览器访问<code>http://bookinfo.com/httpbin/status/502</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 此时查看httpbin-v1的日志，显示一条状态码为502的日志</span>
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo logs <span style="color:#f92672">-f</span> httpbin-v1-5967569c54-sp874 -c istio-proxy
</span></span><span style="display:flex;"><span>[2020-11-09T10<span style="color:#960050;background-color:#1e0010">:</span>26<span style="color:#960050;background-color:#1e0010">:</span>48.907Z] <span style="color:#e6db74">&#34;GET /httpbin/status/502 HTTP/1.1&#34;</span> 502 - <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span> 0 0 5 4 <span style="color:#e6db74">&#34;172.21.50.140,10.244.0.1&#34;</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36&#34;</span> <span style="color:#e6db74">&#34;767cf33b-b8cf-9804-8c48-df131393c8a5&#34;</span> <span style="color:#e6db74">&#34;bookinfo.com&#34;</span> <span style="color:#e6db74">&#34;127.0.0.1:80&#34;</span> inbound|8000|http|httpbin.bookinfo.svc.cluster.local 127.0.0.1<span style="color:#960050;background-color:#1e0010">:</span>48376 10.244.0.90<span style="color:#960050;background-color:#1e0010">:</span>80 10.244.0.1<span style="color:#960050;background-color:#1e0010">:</span>0 outbound_.8000_.v1_.httpbin.bookinfo.svc.cluster.local <span style="color:#66d9ef">default</span>
</span></span></code></pre></div><p>我们为<code>httpbin</code>服务设置重试机制，这里设置如果服务在 2 秒内没有返回正确的返回值，就进行重试，重试的条件为返回码为<code>5xx</code>，重试 3 次。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo edit vs bookinfo
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - uri<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        prefix<span style="color:#960050;background-color:#1e0010">:</span> /httpbin
</span></span><span style="display:flex;"><span>    mirror<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>      subset<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>    mirror_percent<span style="color:#960050;background-color:#1e0010">:</span> 100
</span></span><span style="display:flex;"><span>    name<span style="color:#960050;background-color:#1e0010">:</span> httpbin-route
</span></span><span style="display:flex;"><span>    retries<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      attempts<span style="color:#960050;background-color:#1e0010">:</span> 3
</span></span><span style="display:flex;"><span>      perTryTimeout<span style="color:#960050;background-color:#1e0010">:</span> 2s
</span></span><span style="display:flex;"><span>      retryOn<span style="color:#960050;background-color:#1e0010">:</span> 5xx
</span></span><span style="display:flex;"><span>    rewrite<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      uri<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次查看httpbin-v1的日志，显示四条状态码为502的日志</span>
</span></span></code></pre></div><h5 id="熔断">熔断<a hidden class="anchor" aria-hidden="true" href="#熔断">#</a></h5>
<h6 id="介绍-1">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍-1">#</a></h6>
<p>熔断（Circuit Breaker），原是指当电流超过规定值时断开电路，进行短路保护或严重过载保护的机制 。对于微服务系统而言，熔断尤为重要，它可以使系统在遭遇某些模块故障时，通过服务降级等方式来提高系统核心功能的可用性，得以应对来自故障、潜在峰值或其他未知网络因素的影响。</p>
<h6 id="准备环境">准备环境<a hidden class="anchor" aria-hidden="true" href="#准备环境">#</a></h6>
<p>Istio 是通过 Envoy Proxy 来实现熔断机制的，Envoy 强制在网络层面配置熔断策略，这样就不必为每个应用程序单独配置或重新编程。下面就通过一个示例来演示如何为 Istio 网格中的服务配置熔断的连接数、请求数和异常检测。</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/httpbin-java-client.jpg" alt=""  />
</p>
<ul>
<li>
<p>创建httpbin服务</p>
</li>
<li>
<p>创建测试客户端</p>
<p>我们已经为 <code>httpbin</code> 服务设置了熔断策略，接下来创建一个 Java 客户端，用来向后端服务发送请求，观察是否会触发熔断策略。这个客户端可以控制连接数量、并发数、待处理请求队列，使用这一客户端，能够有效的触发前面在目标规则中设置的熔断策略。该客户端的 deployment yaml 内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># httpbin-client-deploy.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">httpbin-client-v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">bookinfo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">httpbin-client-v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">httpbin-client-v1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">ceposta/http-envoy-client-standalone:latest</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">httpbin-client</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sleep&#34;</span>,<span style="color:#e6db74">&#34;infinity&#34;</span>]
</span></span></code></pre></div><p>这里我们会把给客户端也进行 Sidecar 的注入，以此保证 Istio 对网络交互的控制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> &lt;(istioctl kube-inject <span style="color:#f92672">-f</span> httpbin-client-deploy.yaml)
</span></span></code></pre></div></li>
</ul>
<h6 id="验证">验证<a hidden class="anchor" aria-hidden="true" href="#验证">#</a></h6>
<p>先尝试通过单线程（<code>NUM_THREADS=1</code>）创建一个连接，并进行 5 次调用（默认值：<code>NUM_CALLS_PER_CLIENT=5</code>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ CLIENT_POD=$(kubectl get pod -n bookinfo | grep httpbin-client | awk <span style="color:#e6db74">&#39;{ print $1 }&#39;</span>)
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo exec -it $CLIENT_POD -c httpbin-client -- sh -c <span style="color:#e6db74">&#39;export URL_UNDER_TEST=http://httpbin:8000/get export NUM_THREADS=1 &amp;&amp; java -jar http-client.jar&#39;</span>
</span></span></code></pre></div><p>下面尝试把线程数提高到 2：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo exec -it $CLIENT_POD -c httpbin-client -- sh -c <span style="color:#e6db74">&#39;export URL_UNDER_TEST=http://httpbin:8000/get export NUM_THREADS=2 &amp;&amp; java -jar http-client.jar&#39;</span>
</span></span></code></pre></div><p>创建DestinationRule， 针对 <code>httpbin</code> 服务设置熔断策略：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> - &lt;&lt;EOF
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> DestinationRule
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  host<span style="color:#960050;background-color:#1e0010">:</span> httpbin
</span></span><span style="display:flex;"><span>  trafficPolicy<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    connectionPool<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      tcp<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        maxConnections<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>      http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        http1MaxPendingRequests<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>        maxRequestsPerConnection<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><ul>
<li><strong>maxConnections</strong> : 限制对后端服务发起的 <code>HTTP/1.1</code> 连接数，如果超过了这个限制，就会开启熔断。</li>
<li><strong>maxPendingRequests</strong> : 限制待处理请求列表的长度， 如果超过了这个限制，就会开启熔断。</li>
<li><strong>maxRequestsPerConnection</strong> : 在任何给定时间内限制对后端服务发起的 <code>HTTP/2</code> 请求数，如果超过了这个限制，就会开启熔断。</li>
</ul>
<p>可以查看设置的熔断策略在envoy的配置片段：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc cluster httpbin-client-v1-56b86fb85c-vg5pp.bookinfo --fqdn httpbin.bookinfo.svc.cluster.local -ojson
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;connectTimeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;10s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;maxRequestsPerConnection&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 1,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;circuitBreakers&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;thresholds&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxConnections&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 1,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxPendingRequests&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 1,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxRequests&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxRetries&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>再次验证熔断。</p>
<h5 id="故障注入与超时机制">故障注入与超时机制<a hidden class="anchor" aria-hidden="true" href="#故障注入与超时机制">#</a></h5>
<p>在一个微服务架构的系统中，为了让系统达到较高的健壮性要求，通常需要对系统做定向错误测试。比如电商中的订单系统、支付系统等若出现故障那将是非常严重的生产事故，因此必须在系统设计前期就需要考虑多样性的异常故障并对每一种异常设计完善的恢复策略或优雅的回退策略，尽全力规避类似事故的发生，使得当系统发生故障时依然可以正常运作。而在这个过程中，服务故障模拟一直以来是一个非常繁杂的工作。</p>
<p>istio提供了无侵入式的故障注入机制，让开发测试人员在不用调整服务程序的前提下，通过配置即可完成对服务的异常模拟。目前，包含两类：</p>
<ul>
<li><strong>abort</strong>：非必配项，配置一个 Abort 类型的对象。用来注入请求异常类故障。简单的说，就是用来模拟上游服务对请求返回指定异常码时，当前的服务是否具备处理能力。</li>
<li><strong>delay</strong>：非必配项，配置一个 Delay 类型的对象。用来注入延时类故障。通俗一点讲，就是人为模拟上游服务的响应时间，测试在高延迟的情况下，当前的服务是否具备容错容灾的能力。</li>
</ul>
<h6 id="延迟与超时">延迟与超时<a hidden class="anchor" aria-hidden="true" href="#延迟与超时">#</a></h6>
<p>目前针对luffy登录用户，访问服务的示意为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>productpage --&gt; reviews v2 --&gt; ratings
</span></span><span style="display:flex;"><span>               \
</span></span><span style="display:flex;"><span>                -&gt; details
</span></span></code></pre></div><p>可以通过如下方式，为<code>ratings</code>服务注入2秒的延迟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat virtualservice-ratings-2s-delay.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> VirtualService
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> ratings
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  hosts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - ratings
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - fault<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      delay<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        percentage<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> 100
</span></span><span style="display:flex;"><span>        fixedDelay<span style="color:#960050;background-color:#1e0010">:</span> 2s
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> ratings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> virtualservice-ratings-2s-delay.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次访问http://bookinfo.com/productpage，可以明显感觉2s的延迟,network可以看到</span>
</span></span></code></pre></div><p>可以查看对应的envoy的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc r ratings-v1-556cfbd589-89ml4.bookinfo --name 9080 -ojson
</span></span></code></pre></div><p>此时的调用为:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>productpage --&gt; reviews v2 -<span style="color:#960050;background-color:#1e0010">（</span>延迟2秒<span style="color:#960050;background-color:#1e0010">）</span>-&gt; ratings
</span></span><span style="display:flex;"><span>               \
</span></span><span style="display:flex;"><span>                -&gt; details
</span></span></code></pre></div><p>此时，为reviews服务添加请求超时时间：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo edit vs reviews
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - match<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - headers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        end-user<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          exact<span style="color:#960050;background-color:#1e0010">:</span> luffy
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v2
</span></span><span style="display:flex;"><span>    timeout<span style="color:#960050;background-color:#1e0010">:</span> 1s
</span></span><span style="display:flex;"><span>  - route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> reviews
</span></span><span style="display:flex;"><span>        subset<span style="color:#960050;background-color:#1e0010">:</span> v3
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>此使的调用关系为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>productpage -<span style="color:#960050;background-color:#1e0010">（</span>0.5秒超时<span style="color:#960050;background-color:#1e0010">）</span>-&gt; reviews v2 -<span style="color:#960050;background-color:#1e0010">（</span>延迟2秒<span style="color:#960050;background-color:#1e0010">）</span>-&gt; ratings
</span></span><span style="display:flex;"><span>               \
</span></span><span style="display:flex;"><span>                -&gt; details
</span></span></code></pre></div><p>此时，如果使用非luffy用户，则会出现只延迟，不会失败的情况。</p>
<p>删除延迟：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo delete vs ratings
</span></span></code></pre></div><h6 id="状态码">状态码<a hidden class="anchor" aria-hidden="true" href="#状态码">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat virtualservice-details-aborted.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> networking.istio.io/v1alpha3
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> VirtualService
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> details
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> bookinfo
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  hosts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - details
</span></span><span style="display:flex;"><span>  http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - fault<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      abort<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        percentage<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> 50
</span></span><span style="display:flex;"><span>        httpStatus<span style="color:#960050;background-color:#1e0010">:</span> 500
</span></span><span style="display:flex;"><span>    route<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    - destination<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        host<span style="color:#960050;background-color:#1e0010">:</span> details
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> virtualservice-details-aborted.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次刷新查看details的状态，查看productpage的日志</span>
</span></span><span style="display:flex;"><span>$ kubectl -n bookinfo logs <span style="color:#f92672">-f</span> $(kubectl -n bookinfo get po -l app=productpage -ojsonpath=<span style="color:#e6db74">&#39;{.items[0].metadata.name}&#39;</span>) -c istio-proxy
</span></span><span style="display:flex;"><span>[2020-11-09T09<span style="color:#960050;background-color:#1e0010">:</span>00<span style="color:#960050;background-color:#1e0010">:</span>16.020Z] <span style="color:#e6db74">&#34;GET /details/0 HTTP/1.1&#34;</span> 500 FI <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span> 0 18 0 - <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36&#34;</span> <span style="color:#e6db74">&#34;f0387bb6-a445-922c-89ab-689dfbf548f8&#34;</span> <span style="color:#e6db74">&#34;details:9080&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span> - - 10.111.67.169<span style="color:#960050;background-color:#1e0010">:</span>9080 10.244.0.52<span style="color:#960050;background-color:#1e0010">:</span>56552 - -
</span></span></code></pre></div><h4 id="可观察性">可观察性<a hidden class="anchor" aria-hidden="true" href="#可观察性">#</a></h4>
<h6 id="安装集成组件">安装集成组件<a hidden class="anchor" aria-hidden="true" href="#安装集成组件">#</a></h6>
<p><a href="https://istio.io/latest/docs/ops/integrations">https://istio.io/latest/docs/ops/integrations</a></p>
<ol>
<li>
<p>Grafana</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> samples/addons/grafana.yaml
</span></span></code></pre></div></li>
<li>
<p>Jaeger</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> samples/addons/jaeger.yaml
</span></span></code></pre></div></li>
<li>
<p>Kiali</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 完善扩展组件地址：</span>
</span></span><span style="display:flex;"><span>grafana url<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;http://grafana.istio.com&#34;</span>
</span></span><span style="display:flex;"><span>tracing url<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;http://jaeger.istio.com&#34;</span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> samples/addons/kiali.yaml
</span></span></code></pre></div></li>
<li>
<p>Prometheus</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> samples/addons/prometheus.yaml
</span></span></code></pre></div></li>
</ol>
<h5 id="prometheus">prometheus<a hidden class="anchor" aria-hidden="true" href="#prometheus">#</a></h5>
<p>Prometheus：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat prometheus-ingress.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> prometheus
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> istio-system
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> prometheus.istio.com
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> prometheus
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 9090
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> prometheus-ingress.yaml
</span></span></code></pre></div><p>查看默认添加的targets列表：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/prometheus-targets.jpg" alt=""  />
</p>
<p>其中最核心的是<code>kubernetes-pods</code> 的监控，服务网格内的每个服务都作为一个target被监控，而且服务流量指标直接由sidecar容器来提供指标。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n bookinfo get po -owide
</span></span><span style="display:flex;"><span>$ curl 10.244.0.53<span style="color:#960050;background-color:#1e0010">:</span>15020/stats/prometheus
</span></span></code></pre></div><p>对于这些监控指标采集的数据，可以在grafana中查看到。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat grafana-ingress.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> grafana
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> istio-system
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> grafana.istio.com
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> grafana
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 3000
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> $(seq 1 10000); <span style="color:#66d9ef">do</span> curl -s -o /dev/null <span style="color:#e6db74">&#34;http://bookinfo.com/productpage&#34;</span>; done
</span></span></code></pre></div><p>访问界面后，可以查看到Istio Mesh Dashboard等相关的dashboard，因为在grafana的资源文件中， 中以 ConfigMap 的形式挂载了 Istio各个组件的仪表盘 JSON 配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n istio-system get cm istio-services-grafana-dashboards
</span></span><span style="display:flex;"><span>NAME                                DATA   AGE
</span></span><span style="display:flex;"><span>istio-services-grafana-dashboards   3      7d1h
</span></span></code></pre></div><h5 id="jaeger">jaeger<a hidden class="anchor" aria-hidden="true" href="#jaeger">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat jaeger-ingress.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> jaeger
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> istio-system
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> jaeger.istio.com
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> tracing
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> jaeger-ingress.yaml
</span></span></code></pre></div><h5 id="kiali">kiali<a hidden class="anchor" aria-hidden="true" href="#kiali">#</a></h5>
<p>kiali 是一个 可观测性分析服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat kiali-ingress.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> kiali
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> istio-system
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> kiali.istio.com
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> kiali
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 20001
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>status<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  loadBalancer<span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> kiali-ingress.yaml
</span></span></code></pre></div><p>集成了Prometheus、grafana、tracing、log、</p>
<h4 id="展望未来">展望未来<a hidden class="anchor" aria-hidden="true" href="#展望未来">#</a></h4>
<p>Kubernets已经成为了容器调度编排的事实标准，而容器正好可以作为微服务的最小工作单元，从而发挥微服务架构的最大优势。所以我认为未来微服务架构会围绕Kubernetes展开。而Istio和Conduit这类Service Mesh天生就是为了Kubernetes设计，它们的出现补足了Kubernetes在微服务间服务通讯上的短板。虽然Dubbo、Spring Cloud等都是成熟的微服务框架，但是它们或多或少都会和具体语言或应用场景绑定，并只解决了微服务Dev层面的问题。若想解决Ops问题，它们还需和诸如Cloud Foundry、Mesos、Docker Swarm或Kubernetes这类资源调度框架做结合：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/kubernetes%e4%b8%8espringcloud.jpg" alt=""  />
</p>
<p>但是这种结合又由于初始设计和生态，有很多适用性问题需要解决。</p>
<p>Kubernetes则不同，它本身就是一个和开发语言无关的、通用的容器管理平台，它可以支持运行云原生和传统的容器化应用。并且它覆盖了微服务的Dev和Ops阶段，结合Service Mesh，它可以为用户提供完整端到端的微服务体验。</p>
<p>所以我认为，未来的微服务架构和技术栈可能是如下形式：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/microservice-future.jpg" alt=""  />
</p>
<p>多云平台为微服务提供了资源能力（计算、存储和网络等），容器作为最小工作单元被Kubernetes调度和编排，Service Mesh管理微服务的服务通信，最后通过API Gateway向外暴露微服务的业务接口。</p>
<p>未来随着以Kubernetes和Service Mesh为标准的微服务框架的盛行，将大大降低微服务实施的成本，最终为微服务落地以及大规模使用提供坚实的基础和保障。</p>
<h4 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h4>
<ul>
<li>
<p>第一代为Spring Cloud为代表的服务治理能力，是和业务代码紧耦合的，没法跨编程语言去使用</p>
</li>
<li>
<p>为了可以实现通用的服务治理能力，istio会为每个业务pod注入一个sidecar代理容器</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/20200503110532.png" alt=""  />
</p>
</li>
<li>
<p>为了能够做到服务治理，需要接管pod内的出入流量，因此通过注入的时候引入初始化容器istio-init实现pod内防火墙规则的初始化，分别将出入站流量拦截到pod内的15001和15006端口</p>
</li>
<li>
<p>同时，注入了istio-proxy容器，利用envoy代理，监听了15001和15006端口，对流量进行处理</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/envoy-config-init.png" alt=""  />
</p>
</li>
<li>
<p>istio在istio-system命名空间启动了istiod服务，用于监听用户写入etcd中的流量规则，转换成envoy可度的配置片段，通过envoy支持的xDS协议，同步到网格内的各envoy中</p>
</li>
<li>
<p>envoy获取规则后，做reload，直接应用到了用户期望的转发行为</p>
</li>
<li>
<p>envoy提供了强大的流量处理规则，包含了流量路由、镜像、重试、熔断、故障注入等，同时，也内置了分布式追踪、Prometheus监控的实现，业务应用对于这一切都是感知不到的</p>
</li>
</ul>
<p>最后，通过分析bookinfo中，从 Productpage服务调用Reviews服务的 请求流程 来回顾istio重点：</p>
<p><img loading="lazy" src="/images/%e5%9f%ba%e4%ba%8eIstio%e5%ae%9e%e7%8e%b0%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86/envoy-traffic-route.png" alt=""  />
</p>
<ol>
<li>
<p>Productpage发起对Reviews服务的调用：<code>http://reviews:9080/reviews/0</code></p>
</li>
<li>
<p>请求被Productpage Pod的iptable规则拦截，重定向到本地的15001端口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。</span>
</span></span><span style="display:flex;"><span>Chain OUTPUT (policy ACCEPT 46 packets, 3926 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    8   480 ISTIO_OUTPUT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_OUTPUT 链：选择需要重定向到 Envoy（即本地） 的出站流量，所有非 localhost 的流量全部转发到 ISTIO_REDIRECT。为了避免流量在该 Pod 中无限循环，所有到 istio-proxy 用户空间的流量都返回到它的调用点中的下一条规则，本例中即 OUTPUT 链，因为跳出 ISTIO_OUTPUT 规则之后就进入下一条链 POSTROUTING。如果目的地非 localhost 就跳转到 ISTIO_REDIRECT；如果流量是来自 istio-proxy 用户空间的，那么就跳出该链，返回它的调用链继续执行下一条规则（OUTPUT 的下一条规则，无需对流量进行处理）；所有的非 istio-proxy 用户空间的目的地是 localhost 的流量就跳转到 ISTIO_REDIRECT。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_OUTPUT (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      lo      127.0.0.6            0.0.0.0/0
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  all  --  *      lo      0.0.0.0/0           !127.0.0.1            owner UID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      lo      0.0.0.0/0            0.0.0.0/0            ! owner UID match 1337
</span></span><span style="display:flex;"><span>    8   480 <span style="color:#66d9ef">RETURN</span>     all  --  *      *       0.0.0.0/0            0.0.0.0/0            owner UID match 1337
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  all  --  *      lo      0.0.0.0/0           !127.0.0.1            owner GID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      lo      0.0.0.0/0            0.0.0.0/0            ! owner GID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      *       0.0.0.0/0            0.0.0.0/0            owner GID match 1337
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     all  --  *      *       0.0.0.0/0            127.0.0.1
</span></span><span style="display:flex;"><span>    0     0 ISTIO_REDIRECT  all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_REDIRECT 链：将所有流量重定向到 Sidecar（即本地） 的 15001 端口。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_REDIRECT (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            redir ports 15001
</span></span></code></pre></div></li>
<li>
<p>15001端口上监听的Envoy Virtual Outbound Listener收到了该请求</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc listener productpage-v1-785b4dbc96-2cw5v.bookinfo --port 15001 -ojson|more
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;virtualOutbound&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 15001
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
<li>
<p>请求被Virtual Outbound Listener根据原目标IP（通配）和端口（9080）转发到0.0.0.0_9080这个 outbound listener</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc listener productpage-v1-785b4dbc96-2cw5v.bookinfo --port 9080 -ojson
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0.0.0.0_9080&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 9080
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;filterChains&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;filterChainMatch&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;applicationProtocols&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;http/1.0&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;http/1.1&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;h2c&#34;</span>
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;filters&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;envoy.filters.network.http_connection_manager&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;typedConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;statPrefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound_0.0.0.0_9080&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;rds&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;configSource&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;ads&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {},
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;resourceApiVersion&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;V3&#34;</span>
</span></span><span style="display:flex;"><span>                                },
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;routeConfigName&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;9080&#34;</span>
</span></span><span style="display:flex;"><span>                            },
</span></span></code></pre></div></li>
<li>
<p>根据0.0.0.0_9080 listener的http_connection_manager filter配置,该请求采用“9080” route进行分发</p>
</li>
<li>
<p>9080的route中，根据domains进行匹配，将请求交给 <code>outbound|9080|v2|reviews.bookinfo.svc.cluster.local</code>这个cluster处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc route productpage-v1-785b4dbc96-2cw5v.bookinfo --name 9080 -ojson
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;reviews.bookinfo.svc.cluster.local:9080&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;domains&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo.svc.cluster.local:9080&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews:9080&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo.svc.cluster&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo.svc.cluster:9080&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo.svc&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo.svc:9080&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;reviews.bookinfo:9080&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;10.109.133.236&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;10.109.133.236:9080&#34;</span>
</span></span><span style="display:flex;"><span>                ],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;routes&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;match&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;prefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;caseSensitive&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> true,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;headers&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;end-user&#34;</span>,
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;exactMatch&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;luffy&#34;</span>
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            ]
</span></span><span style="display:flex;"><span>                        },
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;route&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;cluster&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9080|v2|reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;timeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;1s&#34;</span>,
</span></span></code></pre></div></li>
<li>
<p>该cluster为EDS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc cluster productpage-v1-785b4dbc96-2cw5v.bookinfo --fqdn reviews.bookinfo.svc.cluster.local --direction outbound -ojson
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9080|v3|reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;EDS&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;edsClusterConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;edsConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ads&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {},
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;resourceApiVersion&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;V3&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;serviceName&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9080|v3|reviews.bookinfo.svc.cluster.local&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;connectTimeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;10s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;lbPolicy&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;RANDOM&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;circuitBreakers&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;thresholds&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxConnections&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxPendingRequests&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxRequests&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;maxRetries&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 4294967295
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span></code></pre></div></li>
<li>
<p>查寻EDS对应的endpoint列表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc endpoint productpage-v1-785b4dbc96-2cw5v.bookinfo --cluster <span style="color:#e6db74">&#34;outbound|9080|v3|reviews.bookinfo.svc.cluster.local&#34;</span> -ojson
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;outbound|9080|v3|reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;addedViaApi&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;hostStatuses&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;10.244.0.37&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 9080
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
<li>
<p>envoy进程得到了最终需要访问的地址（reviews-v3的podip：port），由envoy做proxy转发出去</p>
</li>
<li>
<p>此时，虽然还是会走一遍envoy的防火墙规则，但是由于是1337用户发起的请求，因此不会被再次拦截，直接走kubernetes的集群网络发出去</p>
</li>
<li>
<p>请求到达reviews-v3， 被iptable规则拦截，重定向到本地的15006端口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。</span>
</span></span><span style="display:flex;"><span>Chain PREROUTING (policy ACCEPT 148 packets, 8880 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>  148  8880 ISTIO_INBOUND  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。</span>
</span></span><span style="display:flex;"><span>Chain INPUT (policy ACCEPT 148 packets, 8880 bytes)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上，目的地为 15090，15020，15021端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_INBOUND (1 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15008
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>22
</span></span><span style="display:flex;"><span>    0     0 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15090
</span></span><span style="display:flex;"><span>  143  8580 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15021
</span></span><span style="display:flex;"><span>    5   300 <span style="color:#66d9ef">RETURN</span>     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt<span style="color:#960050;background-color:#1e0010">:</span>15020
</span></span><span style="display:flex;"><span>    0     0 ISTIO_IN_REDIRECT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ISTIO_IN_REDIRECT 链：将所有入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到sidecar中。</span>
</span></span><span style="display:flex;"><span>Chain ISTIO_IN_REDIRECT (3 references)
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt <span style="color:#66d9ef">in</span>     out     source               destination
</span></span><span style="display:flex;"><span>    0     0 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            redir ports 15006
</span></span></code></pre></div></li>
<li>
<p>被监听在15006端口的envoy进程处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc listener reviews-v3-6c7d64cd96-75f4x.bookinfo --port 15006 -ojson|more
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;virtualInbound&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 15006
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div></li>
<li>
<p>VirtualInbound不再转给别的监听器，根据自身过滤器链的匹配条件，请求被Virtual Inbound Listener内部配置的Http connection manager filter处理 ， 该filter设置的路由配置为将其发送给 <code>inbound|9080|http|reviews.bookinfo.svc.cluster.local</code>这个inbound的cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;filterChainMatch&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;destinationPort&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 9080
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;filters&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;istio.metadata_exchange&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;typedConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;@type&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;type.googleapis.com/udpa.type.v1.TypedStruct&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;value&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;protocol&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;istio-peer-exchange&#34;</span>
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;envoy.filters.network.http_connection_manager&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;typedConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;statPrefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound_0.0.0.0_9080&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;routeConfig&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound|9080|http|reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;virtualHosts&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                                    {
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound|http|9080&#34;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;domains&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                                            <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>                                        ],
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#34;routes&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                                            {
</span></span><span style="display:flex;"><span>                                                <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>                                                <span style="color:#e6db74">&#34;match&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                                    <span style="color:#e6db74">&#34;prefix&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>                                                },
</span></span><span style="display:flex;"><span>                                                <span style="color:#e6db74">&#34;route&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                                                    <span style="color:#e6db74">&#34;cluster&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound|9080|http|reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>                                                    <span style="color:#e6db74">&#34;timeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0s&#34;</span>,
</span></span><span style="display:flex;"><span>                                                    <span style="color:#e6db74">&#34;maxGrpcTimeout&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;0s&#34;</span>
</span></span><span style="display:flex;"><span>                                                }
</span></span></code></pre></div></li>
<li>
<p><code>inbound|9080|http|reviews.bookinfo.svc.cluster.local</code>配置的endpoint为本机的<code>127.0.0.1:9080</code>,因此转发到Pod内部的Reviews服务的9080端口进行处理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ istioctl pc endpoint reviews-v3-6c7d64cd96-75f4x.bookinfo --cluster <span style="color:#e6db74">&#34;inbound|9080|http|reviews.bookinfo.svc.cluster.local&#34;</span> -ojson
</span></span><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;inbound|9080|http|reviews.bookinfo.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;addedViaApi&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> true,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;hostStatuses&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;socketAddress&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;address&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;portValue&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 9080
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                },
</span></span></code></pre></div></li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/kali-linux-2021.2%E5%AE%89%E8%A3%85openvas/">
    <span class="title">« 上一页</span>
    <br>
    <span>kali-linux-2021.2安装openvas</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/">
    <span class="title">下一页 »</span>
    <br>
    <span>SpringBoot与SpringCloud微服务项目交付</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
