<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å° | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ æŒç»­é›†æˆå·¥å…·ï¼š
 Jenkins gitlabci Tekton  æœ¬ç« åŸºäºk8sé›†ç¾¤éƒ¨ç½²gitlabã€sonarQubeã€Jenkinsç­‰å·¥å…·ï¼Œå¹¶æŠŠä¸Šè¿°å·¥å…·é›†æˆåˆ°Jenkinsä¸­ï¼Œä»¥Djangoé¡¹ç›®å’ŒSpringBooté¡¹ç›®ä¸ºä¾‹ï¼Œé€šè¿‡å¤šåˆ†æ”¯æµæ°´çº¿åŠJenkinsfileå®ç°é¡¹ç›®ä»£ç æäº¤åˆ°ä¸åŒçš„ä»“åº“åˆ†æ”¯ï¼Œå®ç°è‡ªåŠ¨ä»£ç æ‰«æã€å•å…ƒæµ‹è¯•ã€dockerå®¹å™¨æ„å»ºã€k8sæœåŠ¡çš„è‡ªåŠ¨éƒ¨ç½²ã€‚
 DevOpsã€CIã€CDä»‹ç» Jenkinsã€sonarQubeã€gitlabçš„å¿«é€Ÿéƒ¨ç½² Jenkinsåˆä½“éªŒ æµæ°´çº¿å…¥é—¨åŠJenkinsfileä½¿ç”¨ Jenkinsä¸Kubernetesçš„é›†æˆ sonarQubeä»£ç æ‰«æä¸Jenkinsçš„é›†æˆ å®è·µDjangoé¡¹ç›®çš„åŸºäºJenkinsfileå®ç°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„CI/CD  DevOpsã€CIã€CDä»‹ç» Continuous Integration (CI) / Continuous Delivery (CD)
è½¯ä»¶äº¤ä»˜æµç¨‹
ä¸€ä¸ªè½¯ä»¶ä»é›¶å¼€å§‹åˆ°æœ€ç»ˆäº¤ä»˜ï¼Œå¤§æ¦‚åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼šè§„åˆ’ã€ç¼–ç ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒåŸºäºè¿™äº›é˜¶æ®µï¼Œæˆ‘ä»¬çš„è½¯ä»¶äº¤ä»˜æ¨¡å‹å¤§è‡´ç»å†äº†å‡ ä¸ªé˜¶æ®µï¼š
ç€‘å¸ƒå¼æµç¨‹ å‰æœŸéœ€æ±‚ç¡®ç«‹ä¹‹åï¼Œè½¯ä»¶å¼€å‘äººå‘˜èŠ±è´¹æ•°å‘¨å’Œæ•°æœˆç¼–å†™ä»£ç ï¼ŒæŠŠæ‰€æœ‰éœ€æ±‚ä¸€æ¬¡æ€§å¼€å‘å®Œï¼Œç„¶åå°†ä»£ç äº¤ç»™QAï¼ˆè´¨é‡ä¿éšœï¼‰å›¢é˜Ÿè¿›è¡Œæµ‹è¯•ï¼Œç„¶åå°†æœ€ç»ˆçš„å‘å¸ƒç‰ˆäº¤ç»™è¿ç»´å›¢é˜Ÿå»éƒ¨ç½²ã€‚ç€‘å¸ƒæ¨¡å‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç­‰ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰å·¥ä½œå®Œæˆä¹‹åï¼Œå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™ç§æ¨¡å¼çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§å“è¿­ä»£å‘¨æœŸé•¿ï¼Œçµæ´»æ€§å·®ã€‚ä¸€ä¸ªå‘¨æœŸåŠ¨è¾„å‡ å‘¨å‡ ä¸ªæœˆï¼Œé€‚åº”ä¸äº†å½“ä¸‹äº§å“éœ€è¦å¿«é€Ÿè¿­ä»£çš„åœºæ™¯ã€‚
æ•æ·å¼€å‘ ä»»åŠ¡ç”±å¤§æ‹†å°ï¼Œå¼€å‘ã€æµ‹è¯•ååŒå·¥ä½œï¼Œæ³¨é‡å¼€å‘æ•æ·ï¼Œä¸é‡è§†äº¤ä»˜æ•æ·
DevOps å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œ, æŒç»­å¼€å‘&#43;æŒç»­äº¤ä»˜ã€‚
æˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºDevOps = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Ÿ
å¤§å®¶æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ€åˆçš„å¼€å‘æ¨¡å¼æ²¡æœ‰ç›´æ¥è¿›å…¥DevOpsçš„æ—¶ä»£ï¼Ÿ
åŸå› æ˜¯ï¼šæ²Ÿé€šæˆæœ¬ã€‚
å„è§’è‰²äººå‘˜å»æ²Ÿé€šåä½œçš„æ—¶å€™éƒ½æ˜¯æ‰‹åŠ¨å»åšï¼Œäº¤æµé å˜´ï¼Œé äººå»æŒ‡æŒ¥ï¼Œå¾ˆæ˜¾ç„¶ä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥è¯´ä¸èƒ½è®¤ä¸ºDevOpså°±æ˜¯ä¸€ç§äº¤ä»˜æ¨¡å¼ï¼Œå› ä¸ºè§£å†³ä¸äº†æ²Ÿé€šåä½œæˆæœ¬ï¼Œè¿™ç§æ¨¡å¼å°±ä¸å…·å¤‡å¯è½åœ°æ€§ã€‚
é‚£DevOpsæ—¶ä»£å¦‚ä½•è§£å†³è§’è‰²ä¹‹é—´çš„æˆæœ¬é—®é¢˜ï¼ŸDevOpsçš„æ ¸å¿ƒå°±æ˜¯è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–çš„èƒ½åŠ›é ä»€ä¹ˆæ¥æ”¯æ’‘ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚
DevOpså·¥å…·é“¾
é è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ‰å®ç°äº†è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›è€Œè§£å†³äº†åä½œæˆæœ¬ï¼Œä½¿å¾—devopså…·å¤‡äº†å¯è½åœ°æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¤§è‡´ç»™devopsä¸€ä¸ªå®šä¹‰ï¼š
devops = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ &#43; åŸºäºå·¥å…·å’ŒæŠ€æœ¯æ”¯æ’‘çš„è‡ªåŠ¨åŒ–æµç¨‹çš„è½åœ°å®è·µã€‚
å› æ­¤devopsä¸æ˜¯æŸä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³&#43;è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°ä¾¿æ·ã€é¢‘ç¹å’Œå¯é çš„è½åœ°å®è·µã€‚æœ¬æ¬¡è¯¾ç¨‹æ ¸å¿ƒå†…å®¹å°±æ˜¯è¦æ•™ä¼šå¤§å®¶å¦‚ä½•åˆ©ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥å®ç°å®Œæ•´çš„DevOpså¹³å°çš„å»ºè®¾ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š
 gitlabï¼Œä»£ç ä»“åº“ï¼Œä¼ä¸šå†…éƒ¨ä½¿ç”¨æœ€å¤šçš„ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚ Jenkinsï¼Œ ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚ robotFrameworkï¼Œ åŸºäºPythonçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ sonarqubeï¼Œä»£ç è´¨é‡ç®¡ç†å¹³å° mavenï¼ŒjavaåŒ…æ„å»ºç®¡ç†å·¥å…· Kubernetes Docker  Jenkinsåˆä½“éªŒ Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins å…¶ä»–éƒ¨ç½²æ–¹å¼
æ³¨æ„ç‚¹ï¼š
 ç¬¬ä¸€æ¬¡å¯åŠ¨å¾ˆæ…¢ å› ä¸ºåé¢Jenkinsä¼šä¸kubernetesé›†ç¾¤è¿›è¡Œé›†æˆï¼Œä¼šéœ€è¦è°ƒç”¨kubernetesé›†ç¾¤çš„apiï¼Œå› æ­¤å®‰è£…çš„æ—¶å€™åˆ›å»ºäº†ServiceAccountå¹¶èµ‹äºˆäº†cluster-adminçš„æƒé™ é»˜è®¤éƒ¨ç½²åˆ°jenkins=trueçš„èŠ‚ç‚¹ åˆå§‹åŒ–å®¹å™¨æ¥è®¾ç½®æƒé™ ingressæ¥å¤–éƒ¨è®¿é—® æ•°æ®å­˜å‚¨é€šè¿‡hostpathæŒ‚è½½åˆ°å®¿ä¸»æœºä¸­  jenkins/jenkins-all.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°" />
<meta property="og:description" content="åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ æŒç»­é›†æˆå·¥å…·ï¼š
 Jenkins gitlabci Tekton  æœ¬ç« åŸºäºk8sé›†ç¾¤éƒ¨ç½²gitlabã€sonarQubeã€Jenkinsç­‰å·¥å…·ï¼Œå¹¶æŠŠä¸Šè¿°å·¥å…·é›†æˆåˆ°Jenkinsä¸­ï¼Œä»¥Djangoé¡¹ç›®å’ŒSpringBooté¡¹ç›®ä¸ºä¾‹ï¼Œé€šè¿‡å¤šåˆ†æ”¯æµæ°´çº¿åŠJenkinsfileå®ç°é¡¹ç›®ä»£ç æäº¤åˆ°ä¸åŒçš„ä»“åº“åˆ†æ”¯ï¼Œå®ç°è‡ªåŠ¨ä»£ç æ‰«æã€å•å…ƒæµ‹è¯•ã€dockerå®¹å™¨æ„å»ºã€k8sæœåŠ¡çš„è‡ªåŠ¨éƒ¨ç½²ã€‚
 DevOpsã€CIã€CDä»‹ç» Jenkinsã€sonarQubeã€gitlabçš„å¿«é€Ÿéƒ¨ç½² Jenkinsåˆä½“éªŒ æµæ°´çº¿å…¥é—¨åŠJenkinsfileä½¿ç”¨ Jenkinsä¸Kubernetesçš„é›†æˆ sonarQubeä»£ç æ‰«æä¸Jenkinsçš„é›†æˆ å®è·µDjangoé¡¹ç›®çš„åŸºäºJenkinsfileå®ç°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„CI/CD  DevOpsã€CIã€CDä»‹ç» Continuous Integration (CI) / Continuous Delivery (CD)
è½¯ä»¶äº¤ä»˜æµç¨‹
ä¸€ä¸ªè½¯ä»¶ä»é›¶å¼€å§‹åˆ°æœ€ç»ˆäº¤ä»˜ï¼Œå¤§æ¦‚åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼šè§„åˆ’ã€ç¼–ç ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒåŸºäºè¿™äº›é˜¶æ®µï¼Œæˆ‘ä»¬çš„è½¯ä»¶äº¤ä»˜æ¨¡å‹å¤§è‡´ç»å†äº†å‡ ä¸ªé˜¶æ®µï¼š
ç€‘å¸ƒå¼æµç¨‹ å‰æœŸéœ€æ±‚ç¡®ç«‹ä¹‹åï¼Œè½¯ä»¶å¼€å‘äººå‘˜èŠ±è´¹æ•°å‘¨å’Œæ•°æœˆç¼–å†™ä»£ç ï¼ŒæŠŠæ‰€æœ‰éœ€æ±‚ä¸€æ¬¡æ€§å¼€å‘å®Œï¼Œç„¶åå°†ä»£ç äº¤ç»™QAï¼ˆè´¨é‡ä¿éšœï¼‰å›¢é˜Ÿè¿›è¡Œæµ‹è¯•ï¼Œç„¶åå°†æœ€ç»ˆçš„å‘å¸ƒç‰ˆäº¤ç»™è¿ç»´å›¢é˜Ÿå»éƒ¨ç½²ã€‚ç€‘å¸ƒæ¨¡å‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç­‰ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰å·¥ä½œå®Œæˆä¹‹åï¼Œå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™ç§æ¨¡å¼çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§å“è¿­ä»£å‘¨æœŸé•¿ï¼Œçµæ´»æ€§å·®ã€‚ä¸€ä¸ªå‘¨æœŸåŠ¨è¾„å‡ å‘¨å‡ ä¸ªæœˆï¼Œé€‚åº”ä¸äº†å½“ä¸‹äº§å“éœ€è¦å¿«é€Ÿè¿­ä»£çš„åœºæ™¯ã€‚
æ•æ·å¼€å‘ ä»»åŠ¡ç”±å¤§æ‹†å°ï¼Œå¼€å‘ã€æµ‹è¯•ååŒå·¥ä½œï¼Œæ³¨é‡å¼€å‘æ•æ·ï¼Œä¸é‡è§†äº¤ä»˜æ•æ·
DevOps å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œ, æŒç»­å¼€å‘&#43;æŒç»­äº¤ä»˜ã€‚
æˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºDevOps = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Ÿ
å¤§å®¶æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ€åˆçš„å¼€å‘æ¨¡å¼æ²¡æœ‰ç›´æ¥è¿›å…¥DevOpsçš„æ—¶ä»£ï¼Ÿ
åŸå› æ˜¯ï¼šæ²Ÿé€šæˆæœ¬ã€‚
å„è§’è‰²äººå‘˜å»æ²Ÿé€šåä½œçš„æ—¶å€™éƒ½æ˜¯æ‰‹åŠ¨å»åšï¼Œäº¤æµé å˜´ï¼Œé äººå»æŒ‡æŒ¥ï¼Œå¾ˆæ˜¾ç„¶ä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥è¯´ä¸èƒ½è®¤ä¸ºDevOpså°±æ˜¯ä¸€ç§äº¤ä»˜æ¨¡å¼ï¼Œå› ä¸ºè§£å†³ä¸äº†æ²Ÿé€šåä½œæˆæœ¬ï¼Œè¿™ç§æ¨¡å¼å°±ä¸å…·å¤‡å¯è½åœ°æ€§ã€‚
é‚£DevOpsæ—¶ä»£å¦‚ä½•è§£å†³è§’è‰²ä¹‹é—´çš„æˆæœ¬é—®é¢˜ï¼ŸDevOpsçš„æ ¸å¿ƒå°±æ˜¯è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–çš„èƒ½åŠ›é ä»€ä¹ˆæ¥æ”¯æ’‘ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚
DevOpså·¥å…·é“¾
é è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ‰å®ç°äº†è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›è€Œè§£å†³äº†åä½œæˆæœ¬ï¼Œä½¿å¾—devopså…·å¤‡äº†å¯è½åœ°æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¤§è‡´ç»™devopsä¸€ä¸ªå®šä¹‰ï¼š
devops = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ &#43; åŸºäºå·¥å…·å’ŒæŠ€æœ¯æ”¯æ’‘çš„è‡ªåŠ¨åŒ–æµç¨‹çš„è½åœ°å®è·µã€‚
å› æ­¤devopsä¸æ˜¯æŸä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³&#43;è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°ä¾¿æ·ã€é¢‘ç¹å’Œå¯é çš„è½åœ°å®è·µã€‚æœ¬æ¬¡è¯¾ç¨‹æ ¸å¿ƒå†…å®¹å°±æ˜¯è¦æ•™ä¼šå¤§å®¶å¦‚ä½•åˆ©ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥å®ç°å®Œæ•´çš„DevOpså¹³å°çš„å»ºè®¾ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š
 gitlabï¼Œä»£ç ä»“åº“ï¼Œä¼ä¸šå†…éƒ¨ä½¿ç”¨æœ€å¤šçš„ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚ Jenkinsï¼Œ ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚ robotFrameworkï¼Œ åŸºäºPythonçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ sonarqubeï¼Œä»£ç è´¨é‡ç®¡ç†å¹³å° mavenï¼ŒjavaåŒ…æ„å»ºç®¡ç†å·¥å…· Kubernetes Docker  Jenkinsåˆä½“éªŒ Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins å…¶ä»–éƒ¨ç½²æ–¹å¼
æ³¨æ„ç‚¹ï¼š
 ç¬¬ä¸€æ¬¡å¯åŠ¨å¾ˆæ…¢ å› ä¸ºåé¢Jenkinsä¼šä¸kubernetesé›†ç¾¤è¿›è¡Œé›†æˆï¼Œä¼šéœ€è¦è°ƒç”¨kubernetesé›†ç¾¤çš„apiï¼Œå› æ­¤å®‰è£…çš„æ—¶å€™åˆ›å»ºäº†ServiceAccountå¹¶èµ‹äºˆäº†cluster-adminçš„æƒé™ é»˜è®¤éƒ¨ç½²åˆ°jenkins=trueçš„èŠ‚ç‚¹ åˆå§‹åŒ–å®¹å™¨æ¥è®¾ç½®æƒé™ ingressæ¥å¤–éƒ¨è®¿é—® æ•°æ®å­˜å‚¨é€šè¿‡hostpathæŒ‚è½½åˆ°å®¿ä¸»æœºä¸­  jenkins/jenkins-all." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-07T14:26:43&#43;00:00" />
<meta property="article:modified_time" content="2022-01-07T14:26:43&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°"/>
<meta name="twitter:description" content="åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ æŒç»­é›†æˆå·¥å…·ï¼š
 Jenkins gitlabci Tekton  æœ¬ç« åŸºäºk8sé›†ç¾¤éƒ¨ç½²gitlabã€sonarQubeã€Jenkinsç­‰å·¥å…·ï¼Œå¹¶æŠŠä¸Šè¿°å·¥å…·é›†æˆåˆ°Jenkinsä¸­ï¼Œä»¥Djangoé¡¹ç›®å’ŒSpringBooté¡¹ç›®ä¸ºä¾‹ï¼Œé€šè¿‡å¤šåˆ†æ”¯æµæ°´çº¿åŠJenkinsfileå®ç°é¡¹ç›®ä»£ç æäº¤åˆ°ä¸åŒçš„ä»“åº“åˆ†æ”¯ï¼Œå®ç°è‡ªåŠ¨ä»£ç æ‰«æã€å•å…ƒæµ‹è¯•ã€dockerå®¹å™¨æ„å»ºã€k8sæœåŠ¡çš„è‡ªåŠ¨éƒ¨ç½²ã€‚
 DevOpsã€CIã€CDä»‹ç» Jenkinsã€sonarQubeã€gitlabçš„å¿«é€Ÿéƒ¨ç½² Jenkinsåˆä½“éªŒ æµæ°´çº¿å…¥é—¨åŠJenkinsfileä½¿ç”¨ Jenkinsä¸Kubernetesçš„é›†æˆ sonarQubeä»£ç æ‰«æä¸Jenkinsçš„é›†æˆ å®è·µDjangoé¡¹ç›®çš„åŸºäºJenkinsfileå®ç°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„CI/CD  DevOpsã€CIã€CDä»‹ç» Continuous Integration (CI) / Continuous Delivery (CD)
è½¯ä»¶äº¤ä»˜æµç¨‹
ä¸€ä¸ªè½¯ä»¶ä»é›¶å¼€å§‹åˆ°æœ€ç»ˆäº¤ä»˜ï¼Œå¤§æ¦‚åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼šè§„åˆ’ã€ç¼–ç ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒåŸºäºè¿™äº›é˜¶æ®µï¼Œæˆ‘ä»¬çš„è½¯ä»¶äº¤ä»˜æ¨¡å‹å¤§è‡´ç»å†äº†å‡ ä¸ªé˜¶æ®µï¼š
ç€‘å¸ƒå¼æµç¨‹ å‰æœŸéœ€æ±‚ç¡®ç«‹ä¹‹åï¼Œè½¯ä»¶å¼€å‘äººå‘˜èŠ±è´¹æ•°å‘¨å’Œæ•°æœˆç¼–å†™ä»£ç ï¼ŒæŠŠæ‰€æœ‰éœ€æ±‚ä¸€æ¬¡æ€§å¼€å‘å®Œï¼Œç„¶åå°†ä»£ç äº¤ç»™QAï¼ˆè´¨é‡ä¿éšœï¼‰å›¢é˜Ÿè¿›è¡Œæµ‹è¯•ï¼Œç„¶åå°†æœ€ç»ˆçš„å‘å¸ƒç‰ˆäº¤ç»™è¿ç»´å›¢é˜Ÿå»éƒ¨ç½²ã€‚ç€‘å¸ƒæ¨¡å‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç­‰ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰å·¥ä½œå®Œæˆä¹‹åï¼Œå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™ç§æ¨¡å¼çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§å“è¿­ä»£å‘¨æœŸé•¿ï¼Œçµæ´»æ€§å·®ã€‚ä¸€ä¸ªå‘¨æœŸåŠ¨è¾„å‡ å‘¨å‡ ä¸ªæœˆï¼Œé€‚åº”ä¸äº†å½“ä¸‹äº§å“éœ€è¦å¿«é€Ÿè¿­ä»£çš„åœºæ™¯ã€‚
æ•æ·å¼€å‘ ä»»åŠ¡ç”±å¤§æ‹†å°ï¼Œå¼€å‘ã€æµ‹è¯•ååŒå·¥ä½œï¼Œæ³¨é‡å¼€å‘æ•æ·ï¼Œä¸é‡è§†äº¤ä»˜æ•æ·
DevOps å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œ, æŒç»­å¼€å‘&#43;æŒç»­äº¤ä»˜ã€‚
æˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºDevOps = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Ÿ
å¤§å®¶æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ€åˆçš„å¼€å‘æ¨¡å¼æ²¡æœ‰ç›´æ¥è¿›å…¥DevOpsçš„æ—¶ä»£ï¼Ÿ
åŸå› æ˜¯ï¼šæ²Ÿé€šæˆæœ¬ã€‚
å„è§’è‰²äººå‘˜å»æ²Ÿé€šåä½œçš„æ—¶å€™éƒ½æ˜¯æ‰‹åŠ¨å»åšï¼Œäº¤æµé å˜´ï¼Œé äººå»æŒ‡æŒ¥ï¼Œå¾ˆæ˜¾ç„¶ä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥è¯´ä¸èƒ½è®¤ä¸ºDevOpså°±æ˜¯ä¸€ç§äº¤ä»˜æ¨¡å¼ï¼Œå› ä¸ºè§£å†³ä¸äº†æ²Ÿé€šåä½œæˆæœ¬ï¼Œè¿™ç§æ¨¡å¼å°±ä¸å…·å¤‡å¯è½åœ°æ€§ã€‚
é‚£DevOpsæ—¶ä»£å¦‚ä½•è§£å†³è§’è‰²ä¹‹é—´çš„æˆæœ¬é—®é¢˜ï¼ŸDevOpsçš„æ ¸å¿ƒå°±æ˜¯è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–çš„èƒ½åŠ›é ä»€ä¹ˆæ¥æ”¯æ’‘ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚
DevOpså·¥å…·é“¾
é è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ‰å®ç°äº†è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›è€Œè§£å†³äº†åä½œæˆæœ¬ï¼Œä½¿å¾—devopså…·å¤‡äº†å¯è½åœ°æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¤§è‡´ç»™devopsä¸€ä¸ªå®šä¹‰ï¼š
devops = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ &#43; åŸºäºå·¥å…·å’ŒæŠ€æœ¯æ”¯æ’‘çš„è‡ªåŠ¨åŒ–æµç¨‹çš„è½åœ°å®è·µã€‚
å› æ­¤devopsä¸æ˜¯æŸä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³&#43;è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°ä¾¿æ·ã€é¢‘ç¹å’Œå¯é çš„è½åœ°å®è·µã€‚æœ¬æ¬¡è¯¾ç¨‹æ ¸å¿ƒå†…å®¹å°±æ˜¯è¦æ•™ä¼šå¤§å®¶å¦‚ä½•åˆ©ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥å®ç°å®Œæ•´çš„DevOpså¹³å°çš„å»ºè®¾ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š
 gitlabï¼Œä»£ç ä»“åº“ï¼Œä¼ä¸šå†…éƒ¨ä½¿ç”¨æœ€å¤šçš„ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚ Jenkinsï¼Œ ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚ robotFrameworkï¼Œ åŸºäºPythonçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ sonarqubeï¼Œä»£ç è´¨é‡ç®¡ç†å¹³å° mavenï¼ŒjavaåŒ…æ„å»ºç®¡ç†å·¥å…· Kubernetes Docker  Jenkinsåˆä½“éªŒ Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins å…¶ä»–éƒ¨ç½²æ–¹å¼
æ³¨æ„ç‚¹ï¼š
 ç¬¬ä¸€æ¬¡å¯åŠ¨å¾ˆæ…¢ å› ä¸ºåé¢Jenkinsä¼šä¸kubernetesé›†ç¾¤è¿›è¡Œé›†æˆï¼Œä¼šéœ€è¦è°ƒç”¨kubernetesé›†ç¾¤çš„apiï¼Œå› æ­¤å®‰è£…çš„æ—¶å€™åˆ›å»ºäº†ServiceAccountå¹¶èµ‹äºˆäº†cluster-adminçš„æƒé™ é»˜è®¤éƒ¨ç½²åˆ°jenkins=trueçš„èŠ‚ç‚¹ åˆå§‹åŒ–å®¹å™¨æ¥è®¾ç½®æƒé™ ingressæ¥å¤–éƒ¨è®¿é—® æ•°æ®å­˜å‚¨é€šè¿‡hostpathæŒ‚è½½åˆ°å®¿ä¸»æœºä¸­  jenkins/jenkins-all."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°",
      "item": "https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°",
  "name": "ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°",
  "description": "åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ æŒç»­é›†æˆå·¥å…·ï¼š\n Jenkins gitlabci Tekton  æœ¬ç« åŸºäºk8sé›†ç¾¤éƒ¨ç½²gitlabã€sonarQubeã€Jenkinsç­‰å·¥å…·ï¼Œå¹¶æŠŠä¸Šè¿°å·¥å…·é›†æˆåˆ°Jenkinsä¸­ï¼Œä»¥Djangoé¡¹ç›®å’ŒSpringBooté¡¹ç›®ä¸ºä¾‹ï¼Œé€šè¿‡å¤šåˆ†æ”¯æµæ°´çº¿åŠJenkinsfileå®ç°é¡¹ç›®ä»£ç æäº¤åˆ°ä¸åŒçš„ä»“åº“åˆ†æ”¯ï¼Œå®ç°è‡ªåŠ¨ä»£ç æ‰«æã€å•å…ƒæµ‹è¯•ã€dockerå®¹å™¨æ„å»ºã€k8sæœåŠ¡çš„è‡ªåŠ¨éƒ¨ç½²ã€‚\n DevOpsã€CIã€CDä»‹ç» Jenkinsã€sonarQubeã€gitlabçš„å¿«é€Ÿéƒ¨ç½² Jenkinsåˆä½“éªŒ æµæ°´çº¿å…¥é—¨åŠJenkinsfileä½¿ç”¨ Jenkinsä¸Kubernetesçš„é›†æˆ sonarQubeä»£ç æ‰«æä¸Jenkinsçš„é›†æˆ å®è·µDjangoé¡¹ç›®çš„åŸºäºJenkinsfileå®ç°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„CI/CD  DevOpsã€CIã€CDä»‹ç» Continuous Integration (CI) / Continuous Delivery (CD)\nè½¯ä»¶äº¤ä»˜æµç¨‹\nä¸€ä¸ªè½¯ä»¶ä»é›¶å¼€å§‹åˆ°æœ€ç»ˆäº¤ä»˜ï¼Œå¤§æ¦‚åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼šè§„åˆ’ã€ç¼–ç ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒåŸºäºè¿™äº›é˜¶æ®µï¼Œæˆ‘ä»¬çš„è½¯ä»¶äº¤ä»˜æ¨¡å‹å¤§è‡´ç»å†äº†å‡ ä¸ªé˜¶æ®µï¼š\nç€‘å¸ƒå¼æµç¨‹ å‰æœŸéœ€æ±‚ç¡®ç«‹ä¹‹åï¼Œè½¯ä»¶å¼€å‘äººå‘˜èŠ±è´¹æ•°å‘¨å’Œæ•°æœˆç¼–å†™ä»£ç ï¼ŒæŠŠæ‰€æœ‰éœ€æ±‚ä¸€æ¬¡æ€§å¼€å‘å®Œï¼Œç„¶åå°†ä»£ç äº¤ç»™QAï¼ˆè´¨é‡ä¿éšœï¼‰å›¢é˜Ÿè¿›è¡Œæµ‹è¯•ï¼Œç„¶åå°†æœ€ç»ˆçš„å‘å¸ƒç‰ˆäº¤ç»™è¿ç»´å›¢é˜Ÿå»éƒ¨ç½²ã€‚ç€‘å¸ƒæ¨¡å‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç­‰ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰å·¥ä½œå®Œæˆä¹‹åï¼Œå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™ç§æ¨¡å¼çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§å“è¿­ä»£å‘¨æœŸé•¿ï¼Œçµæ´»æ€§å·®ã€‚ä¸€ä¸ªå‘¨æœŸåŠ¨è¾„å‡ å‘¨å‡ ä¸ªæœˆï¼Œé€‚åº”ä¸äº†å½“ä¸‹äº§å“éœ€è¦å¿«é€Ÿè¿­ä»£çš„åœºæ™¯ã€‚\næ•æ·å¼€å‘ ä»»åŠ¡ç”±å¤§æ‹†å°ï¼Œå¼€å‘ã€æµ‹è¯•ååŒå·¥ä½œï¼Œæ³¨é‡å¼€å‘æ•æ·ï¼Œä¸é‡è§†äº¤ä»˜æ•æ·\nDevOps å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œ, æŒç»­å¼€å‘+æŒç»­äº¤ä»˜ã€‚\næˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºDevOps = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Ÿ\nå¤§å®¶æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ€åˆçš„å¼€å‘æ¨¡å¼æ²¡æœ‰ç›´æ¥è¿›å…¥DevOpsçš„æ—¶ä»£ï¼Ÿ\nåŸå› æ˜¯ï¼šæ²Ÿé€šæˆæœ¬ã€‚\nå„è§’è‰²äººå‘˜å»æ²Ÿé€šåä½œçš„æ—¶å€™éƒ½æ˜¯æ‰‹åŠ¨å»åšï¼Œäº¤æµé å˜´ï¼Œé äººå»æŒ‡æŒ¥ï¼Œå¾ˆæ˜¾ç„¶ä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥è¯´ä¸èƒ½è®¤ä¸ºDevOpså°±æ˜¯ä¸€ç§äº¤ä»˜æ¨¡å¼ï¼Œå› ä¸ºè§£å†³ä¸äº†æ²Ÿé€šåä½œæˆæœ¬ï¼Œè¿™ç§æ¨¡å¼å°±ä¸å…·å¤‡å¯è½åœ°æ€§ã€‚\né‚£DevOpsæ—¶ä»£å¦‚ä½•è§£å†³è§’è‰²ä¹‹é—´çš„æˆæœ¬é—®é¢˜ï¼ŸDevOpsçš„æ ¸å¿ƒå°±æ˜¯è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–çš„èƒ½åŠ›é ä»€ä¹ˆæ¥æ”¯æ’‘ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚\nDevOpså·¥å…·é“¾\né è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ‰å®ç°äº†è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›è€Œè§£å†³äº†åä½œæˆæœ¬ï¼Œä½¿å¾—devopså…·å¤‡äº†å¯è½åœ°æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¤§è‡´ç»™devopsä¸€ä¸ªå®šä¹‰ï¼š\ndevops = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ + åŸºäºå·¥å…·å’ŒæŠ€æœ¯æ”¯æ’‘çš„è‡ªåŠ¨åŒ–æµç¨‹çš„è½åœ°å®è·µã€‚\nå› æ­¤devopsä¸æ˜¯æŸä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³+è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°ä¾¿æ·ã€é¢‘ç¹å’Œå¯é çš„è½åœ°å®è·µã€‚æœ¬æ¬¡è¯¾ç¨‹æ ¸å¿ƒå†…å®¹å°±æ˜¯è¦æ•™ä¼šå¤§å®¶å¦‚ä½•åˆ©ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥å®ç°å®Œæ•´çš„DevOpså¹³å°çš„å»ºè®¾ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š\n gitlabï¼Œä»£ç ä»“åº“ï¼Œä¼ä¸šå†…éƒ¨ä½¿ç”¨æœ€å¤šçš„ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚ Jenkinsï¼Œ ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚ robotFrameworkï¼Œ åŸºäºPythonçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ sonarqubeï¼Œä»£ç è´¨é‡ç®¡ç†å¹³å° mavenï¼ŒjavaåŒ…æ„å»ºç®¡ç†å·¥å…· Kubernetes Docker  Jenkinsåˆä½“éªŒ Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins å…¶ä»–éƒ¨ç½²æ–¹å¼\næ³¨æ„ç‚¹ï¼š\n ç¬¬ä¸€æ¬¡å¯åŠ¨å¾ˆæ…¢ å› ä¸ºåé¢Jenkinsä¼šä¸kubernetesé›†ç¾¤è¿›è¡Œé›†æˆï¼Œä¼šéœ€è¦è°ƒç”¨kubernetesé›†ç¾¤çš„apiï¼Œå› æ­¤å®‰è£…çš„æ—¶å€™åˆ›å»ºäº†ServiceAccountå¹¶èµ‹äºˆäº†cluster-adminçš„æƒé™ é»˜è®¤éƒ¨ç½²åˆ°jenkins=trueçš„èŠ‚ç‚¹ åˆå§‹åŒ–å®¹å™¨æ¥è®¾ç½®æƒé™ ingressæ¥å¤–éƒ¨è®¿é—® æ•°æ®å­˜å‚¨é€šè¿‡hostpathæŒ‚è½½åˆ°å®¿ä¸»æœºä¸­  jenkins/jenkins-all.",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ æŒç»­é›†æˆå·¥å…·ï¼š\n Jenkins gitlabci Tekton  æœ¬ç« åŸºäºk8sé›†ç¾¤éƒ¨ç½²gitlabã€sonarQubeã€Jenkinsç­‰å·¥å…·ï¼Œå¹¶æŠŠä¸Šè¿°å·¥å…·é›†æˆåˆ°Jenkinsä¸­ï¼Œä»¥Djangoé¡¹ç›®å’ŒSpringBooté¡¹ç›®ä¸ºä¾‹ï¼Œé€šè¿‡å¤šåˆ†æ”¯æµæ°´çº¿åŠJenkinsfileå®ç°é¡¹ç›®ä»£ç æäº¤åˆ°ä¸åŒçš„ä»“åº“åˆ†æ”¯ï¼Œå®ç°è‡ªåŠ¨ä»£ç æ‰«æã€å•å…ƒæµ‹è¯•ã€dockerå®¹å™¨æ„å»ºã€k8sæœåŠ¡çš„è‡ªåŠ¨éƒ¨ç½²ã€‚\n DevOpsã€CIã€CDä»‹ç» Jenkinsã€sonarQubeã€gitlabçš„å¿«é€Ÿéƒ¨ç½² Jenkinsåˆä½“éªŒ æµæ°´çº¿å…¥é—¨åŠJenkinsfileä½¿ç”¨ Jenkinsä¸Kubernetesçš„é›†æˆ sonarQubeä»£ç æ‰«æä¸Jenkinsçš„é›†æˆ å®è·µDjangoé¡¹ç›®çš„åŸºäºJenkinsfileå®ç°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„CI/CD  DevOpsã€CIã€CDä»‹ç» Continuous Integration (CI) / Continuous Delivery (CD)\nè½¯ä»¶äº¤ä»˜æµç¨‹\nä¸€ä¸ªè½¯ä»¶ä»é›¶å¼€å§‹åˆ°æœ€ç»ˆäº¤ä»˜ï¼Œå¤§æ¦‚åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼šè§„åˆ’ã€ç¼–ç ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒåŸºäºè¿™äº›é˜¶æ®µï¼Œæˆ‘ä»¬çš„è½¯ä»¶äº¤ä»˜æ¨¡å‹å¤§è‡´ç»å†äº†å‡ ä¸ªé˜¶æ®µï¼š\nç€‘å¸ƒå¼æµç¨‹ å‰æœŸéœ€æ±‚ç¡®ç«‹ä¹‹åï¼Œè½¯ä»¶å¼€å‘äººå‘˜èŠ±è´¹æ•°å‘¨å’Œæ•°æœˆç¼–å†™ä»£ç ï¼ŒæŠŠæ‰€æœ‰éœ€æ±‚ä¸€æ¬¡æ€§å¼€å‘å®Œï¼Œç„¶åå°†ä»£ç äº¤ç»™QAï¼ˆè´¨é‡ä¿éšœï¼‰å›¢é˜Ÿè¿›è¡Œæµ‹è¯•ï¼Œç„¶åå°†æœ€ç»ˆçš„å‘å¸ƒç‰ˆäº¤ç»™è¿ç»´å›¢é˜Ÿå»éƒ¨ç½²ã€‚ç€‘å¸ƒæ¨¡å‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç­‰ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰å·¥ä½œå®Œæˆä¹‹åï¼Œå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™ç§æ¨¡å¼çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§å“è¿­ä»£å‘¨æœŸé•¿ï¼Œçµæ´»æ€§å·®ã€‚ä¸€ä¸ªå‘¨æœŸåŠ¨è¾„å‡ å‘¨å‡ ä¸ªæœˆï¼Œé€‚åº”ä¸äº†å½“ä¸‹äº§å“éœ€è¦å¿«é€Ÿè¿­ä»£çš„åœºæ™¯ã€‚\næ•æ·å¼€å‘ ä»»åŠ¡ç”±å¤§æ‹†å°ï¼Œå¼€å‘ã€æµ‹è¯•ååŒå·¥ä½œï¼Œæ³¨é‡å¼€å‘æ•æ·ï¼Œä¸é‡è§†äº¤ä»˜æ•æ·\nDevOps å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œ, æŒç»­å¼€å‘+æŒç»­äº¤ä»˜ã€‚\næˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºDevOps = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Ÿ\nå¤§å®¶æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ€åˆçš„å¼€å‘æ¨¡å¼æ²¡æœ‰ç›´æ¥è¿›å…¥DevOpsçš„æ—¶ä»£ï¼Ÿ\nåŸå› æ˜¯ï¼šæ²Ÿé€šæˆæœ¬ã€‚\nå„è§’è‰²äººå‘˜å»æ²Ÿé€šåä½œçš„æ—¶å€™éƒ½æ˜¯æ‰‹åŠ¨å»åšï¼Œäº¤æµé å˜´ï¼Œé äººå»æŒ‡æŒ¥ï¼Œå¾ˆæ˜¾ç„¶ä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥è¯´ä¸èƒ½è®¤ä¸ºDevOpså°±æ˜¯ä¸€ç§äº¤ä»˜æ¨¡å¼ï¼Œå› ä¸ºè§£å†³ä¸äº†æ²Ÿé€šåä½œæˆæœ¬ï¼Œè¿™ç§æ¨¡å¼å°±ä¸å…·å¤‡å¯è½åœ°æ€§ã€‚\né‚£DevOpsæ—¶ä»£å¦‚ä½•è§£å†³è§’è‰²ä¹‹é—´çš„æˆæœ¬é—®é¢˜ï¼ŸDevOpsçš„æ ¸å¿ƒå°±æ˜¯è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–çš„èƒ½åŠ›é ä»€ä¹ˆæ¥æ”¯æ’‘ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚\nDevOpså·¥å…·é“¾\né è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ‰å®ç°äº†è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›è€Œè§£å†³äº†åä½œæˆæœ¬ï¼Œä½¿å¾—devopså…·å¤‡äº†å¯è½åœ°æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¤§è‡´ç»™devopsä¸€ä¸ªå®šä¹‰ï¼š\ndevops = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ + åŸºäºå·¥å…·å’ŒæŠ€æœ¯æ”¯æ’‘çš„è‡ªåŠ¨åŒ–æµç¨‹çš„è½åœ°å®è·µã€‚\nå› æ­¤devopsä¸æ˜¯æŸä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³+è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°ä¾¿æ·ã€é¢‘ç¹å’Œå¯é çš„è½åœ°å®è·µã€‚æœ¬æ¬¡è¯¾ç¨‹æ ¸å¿ƒå†…å®¹å°±æ˜¯è¦æ•™ä¼šå¤§å®¶å¦‚ä½•åˆ©ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥å®ç°å®Œæ•´çš„DevOpså¹³å°çš„å»ºè®¾ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š\n gitlabï¼Œä»£ç ä»“åº“ï¼Œä¼ä¸šå†…éƒ¨ä½¿ç”¨æœ€å¤šçš„ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚ Jenkinsï¼Œ ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚ robotFrameworkï¼Œ åŸºäºPythonçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ sonarqubeï¼Œä»£ç è´¨é‡ç®¡ç†å¹³å° mavenï¼ŒjavaåŒ…æ„å»ºç®¡ç†å·¥å…· Kubernetes Docker  Jenkinsåˆä½“éªŒ Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins å…¶ä»–éƒ¨ç½²æ–¹å¼\næ³¨æ„ç‚¹ï¼š\n ç¬¬ä¸€æ¬¡å¯åŠ¨å¾ˆæ…¢ å› ä¸ºåé¢Jenkinsä¼šä¸kubernetesé›†ç¾¤è¿›è¡Œé›†æˆï¼Œä¼šéœ€è¦è°ƒç”¨kubernetesé›†ç¾¤çš„apiï¼Œå› æ­¤å®‰è£…çš„æ—¶å€™åˆ›å»ºäº†ServiceAccountå¹¶èµ‹äºˆäº†cluster-adminçš„æƒé™ é»˜è®¤éƒ¨ç½²åˆ°jenkins=trueçš„èŠ‚ç‚¹ åˆå§‹åŒ–å®¹å™¨æ¥è®¾ç½®æƒé™ ingressæ¥å¤–éƒ¨è®¿é—® æ•°æ®å­˜å‚¨é€šè¿‡hostpathæŒ‚è½½åˆ°å®¿ä¸»æœºä¸­  jenkins/jenkins-all.yaml\napiVersion: v1 kind: Namespace metadata:  name: jenkins --- apiVersion: v1 kind: ServiceAccount metadata:  name: jenkins  namespace: jenkins --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata:  name: jenkins-crb roleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: cluster-admin subjects: - kind: ServiceAccount  name: jenkins  namespace: jenkins --- apiVersion: apps/v1 kind: Deployment metadata:  name: jenkins-master  namespace: jenkins spec:  replicas: 1  selector:  matchLabels:  devops: jenkins-master  template:  metadata:  labels:  devops: jenkins-master  spec:  nodeSelector:  jenkins: \"true\"  serviceAccount: jenkins #Pod éœ€è¦ä½¿ç”¨çš„æœåŠ¡è´¦å·  initContainers:  - name: fix-permissions  image: busybox  command: [\"sh\", \"-c\", \"chown -R 1000:1000 /var/jenkins_home\"]  securityContext:  privileged: true  volumeMounts:  - name: jenkinshome  mountPath: /var/jenkins_home  containers:  - name: jenkins  image: jenkinsci/blueocean:1.23.2  imagePullPolicy: IfNotPresent  ports:  - name: http #Jenkins Master Web æœåŠ¡ç«¯å£  containerPort: 8080  - name: slavelistener #Jenkins Master ä¾›æœªæ¥ Slave è¿æ¥çš„ç«¯å£  containerPort: 50000  volumeMounts:  - name: jenkinshome  mountPath: /var/jenkins_home  env:  - name: JAVA_OPTS  value: \"-Xms4096m -Xmx5120m -Duser.timezone=Asia/Shanghai -Dhudson.model.DirectoryBrowserSupport.CSP=\"  volumes:  - name: jenkinshome  hostPath:  path: /var/jenkins_home/ --- apiVersion: v1 kind: Service metadata:  name: jenkins  namespace: jenkins spec:  ports:  - name: http  port: 8080  targetPort: 8080  - name: slavelistener  port: 50000  targetPort: 50000  type: ClusterIP  selector:  devops: jenkins-master --- apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: jenkins-web  namespace: jenkins spec:  rules:  - host: jenkins.luffy.com  http:  paths:  - backend:  serviceName: jenkins  servicePort: 8080  path: / åˆ›å»ºæœåŠ¡ï¼š\n## ä¸ºk8s-slave1æ‰“æ ‡ç­¾ï¼Œå°†jenkins-masteréƒ¨ç½²åœ¨k8s-slave1èŠ‚ç‚¹ $ kubectl label node k8s-slave1 jenkins=true ## éƒ¨ç½²æœåŠ¡ $ kubectl create -f jenkins-all.yaml ## æŸ¥çœ‹æœåŠ¡ $ kubectl -n jenkins get po NAME READY STATUS RESTARTS AGE jenkins-master-767df9b574-lgdr5 1/1 Running 0 20s  # æŸ¥çœ‹æ—¥å¿—ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨æç¤ºéœ€è¦å®Œæˆåˆå§‹åŒ–è®¾ç½® $ kubectl -n jenkins logs -f jenkins-master-767df9b574-lgdr5 ...... *************************************************************  Jenkins initial setup is required. An admin user has been created and a password generated. Please use the following password to proceed to installation:  5396b4e1c395450f8360efd8ee641b18  This may also be found at: /var/jenkins_home/secrets/initialAdminPassword  ************************************************************* è®¿é—®æœåŠ¡ï¼š\né…ç½®hostsè§£æï¼Œ172.21.51.67 jenkins.luffy.comï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨åŸŸåè®¿é—®æœåŠ¡ã€‚ç¬¬ä¸€æ¬¡è®¿é—®éœ€è¦å¤§æ¦‚å‡ åˆ†é’Ÿçš„åˆå§‹åŒ–æ—¶é—´ã€‚\nä½¿ç”¨jenkinså¯åŠ¨æ—¥å¿—ä¸­çš„å¯†ç ï¼Œæˆ–è€…æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è·å–è§£é”çš„ç®¡ç†å‘˜å¯†ç ï¼š\n$ kubectl -n jenkins exec jenkins-master-767df9b574-lgdr5 bash / # cat /var/jenkins_home/secrets/initialAdminPassword 35b083de1d25409eaef57255e0da481a ç‚¹å‡»å‰å·ï¼Œè·³è¿‡é€‰æ‹©å®‰è£…æ¨èçš„æ’ä»¶ç¯èŠ‚ï¼Œç›´æ¥è¿›å…¥Jenkinsã€‚ç”±äºé»˜è®¤çš„æ’ä»¶åœ°å€å®‰è£…éå¸¸æ…¢ï¼Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢æˆå›½å†…æ¸…åçš„æºï¼Œè¿›å…¥ jenkins å·¥ä½œç›®å½•ï¼Œç›®å½•ä¸‹é¢æœ‰ä¸€ä¸ª updates çš„ç›®å½•ï¼Œä¸‹é¢æœ‰ä¸€ä¸ª default.json æ–‡ä»¶ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ›¿æ¢æ’ä»¶åœ°å€ï¼š\n$ cd /var/jenkins_home/updates $ sed -i 's/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json $ sed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json  æš‚æ—¶å…ˆä¸ç”¨é‡æ–°å¯åŠ¨podï¼Œæ±‰åŒ–åä¸€èµ·é‡å¯ã€‚\n é€‰æ‹©å³ä¸Šè§’admin-configure-passwordé‡æ–°è®¾ç½®ç®¡ç†å‘˜å¯†ç ï¼Œè®¾ç½®å®Œåï¼Œä¼šé€€å‡ºè¦æ±‚é‡æ–°ç™»å½•ï¼Œä½¿ç”¨admin/xxxxxx(æ–°å¯†ç )ï¼Œç™»å½•å³å¯ã€‚\nå®‰è£…æ±‰åŒ–æ’ä»¶ Jenkins - manage Jenkins - Plugin Manager - Avaliableï¼Œæœç´¢ chineseå…³é”®å­—\né€‰ä¸­åï¼Œé€‰æ‹©[Install without restart]ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆï¼Œç„¶åç‚¹å‡»[ Restart Jenkins when installation is complete and no jobs are running ]ï¼Œè®©Jenkinsè‡ªåŠ¨é‡å¯\nå¯åŠ¨åï¼Œç•Œé¢é»˜è®¤å˜æˆä¸­æ–‡ã€‚\nJenkinsåŸºæœ¬ä½¿ç”¨æ¼”ç¤º æ¼”ç¤ºç›®æ ‡  ä»£ç æäº¤gitlabï¼Œè‡ªåŠ¨è§¦å‘Jenkinsä»»åŠ¡ Jenkinsä»»åŠ¡å®Œæˆåå‘é€é’‰é’‰æ¶ˆæ¯é€šçŸ¥  æ¼”ç¤ºå‡†å¤‡ gitlabä»£ç ä»“åº“æ­å»º\nhttps://github.com/sameersbn/docker-gitlab\n## å…¨é‡éƒ¨ç½²çš„ç»„ä»¶ $ gitlab-ctl status run: alertmanager: (pid 1987) 27s; run: log: (pid 1986) 27s run: gitaly: (pid 1950) 28s; run: log: (pid 1949) 28s run: gitlab-exporter: (pid 1985) 27s; run: log: (pid 1984) 27s run: gitlab-workhorse: (pid 1956) 28s; run: log: (pid 1955) 28s run: logrotate: (pid 1960) 28s; run: log: (pid 1959) 28s run: nginx: (pid 2439) 1s; run: log: (pid 1990) 27s run: node-exporter: (pid 1963) 28s; run: log: (pid 1962) 28s run: postgres-exporter: (pid 1989) 27s; run: log: (pid 1988) 27s run: postgresql: (pid 1945) 28s; run: log: (pid 1944) 28s run: prometheus: (pid 1973) 28s; run: log: (pid 1972) 28s run: puma: (pid 1968) 28s; run: log: (pid 1966) 28s run: redis: (pid 1952) 28s; run: log: (pid 1951) 28s run: redis-exporter: (pid 1971) 28s; run: log: (pid 1964) 28s run: sidekiq: (pid 1969) 28s; run: log: (pid 1967) 28s éƒ¨ç½²åˆ†æï¼š\n ä¾èµ–postgres ä¾èµ–redis  ä½¿ç”¨k8séƒ¨ç½²ï¼š\n  å‡†å¤‡secretæ–‡ä»¶\n$ cat gitlab-secret.txt postgres.user.root=root postgres.pwd.root=1qaz2wsx  $ kubectl -n jenkins create secret generic gitlab-secret --from-env-file=gitlab-secret.txt   éƒ¨ç½²postgres\næ³¨æ„ç‚¹ï¼š\n ä½¿ç”¨secretæ¥å¼•ç”¨è´¦æˆ·å¯†ç  ä½¿ç”¨postgres=trueæ¥æŒ‡å®šèŠ‚ç‚¹  $ cat postgres.yaml apiVersion: v1 kind: Service metadata:  name: postgres  labels:  app: postgres  namespace: jenkins spec:  ports:  - name: server  port: 5432  targetPort: 5432  protocol: TCP  selector:  app: postgres --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: postgres  labels:  app: postgres spec:  replicas: 1  selector:  matchLabels:  app: postgres  template:  metadata:  labels:  app: postgres  spec:  nodeSelector:  postgres: \"true\"  tolerations:  - operator: \"Exists\"  containers:  - name: postgres  image: 172.21.51.67:5000/postgres:11.4 #è‹¥æœ¬åœ°æ²¡æœ‰å¯åŠ¨è¯¥ä»“åº“ï¼Œæ¢æˆpostgres:11.4  imagePullPolicy: \"IfNotPresent\"  ports:  - containerPort: 5432  env:  - name: POSTGRES_USER #PostgreSQL ç”¨æˆ·å  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.user.root  - name: POSTGRES_PASSWORD #PostgreSQL å¯†ç   valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.pwd.root  resources:  limits:  cpu: 1000m  memory: 2048Mi  requests:  cpu: 50m  memory: 100Mi  volumeMounts:  - mountPath: /var/lib/postgresql/data  name: postgredb  volumes:  - name: postgredb  hostPath:  path: /var/lib/postgres/   #éƒ¨ç½²åˆ°k8s-slave2èŠ‚ç‚¹ $ kubectl label node k8s-slave2 postgres=true  #åˆ›å»ºpostgres $ kubectl create -f postgres.yaml  # åˆ›å»ºæ•°æ®åº“gitlab,ä¸ºåé¢éƒ¨ç½²gitlabç»„ä»¶ä½¿ç”¨ $ kubectl -n jenkins exec -ti postgres-7ff9b49f4c-nt8zh bash root@postgres-7ff9b49f4c-nt8zh:/# psql root=# create database gitlab; CREATE DATABASE   éƒ¨ç½²redis\n$ cat redis.yaml apiVersion: v1 kind: Service metadata:  name: redis  labels:  app: redis  namespace: jenkins spec:  ports:  - name: server  port: 6379  targetPort: 6379  protocol: TCP  selector:  app: redis --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: redis  labels:  app: redis spec:  replicas: 1  selector:  matchLabels:  app: redis  template:  metadata:  labels:  app: redis  spec:  tolerations:  - operator: \"Exists\"  containers:  - name: redis  image: sameersbn/redis:4.0.9-2  imagePullPolicy: \"IfNotPresent\"  ports:  - containerPort: 6379  resources:  limits:  cpu: 1000m  memory: 2048Mi  requests:  cpu: 50m  memory: 100Mi  # åˆ›å»º $ kubectl create -f redis.yaml   éƒ¨ç½²gitlab\næ³¨æ„ç‚¹ï¼š\n ä½¿ç”¨ingressæš´æ¼æœåŠ¡ æ·»åŠ annotationï¼ŒæŒ‡å®šnginxç«¯ä¸Šä¼ å¤§å°é™åˆ¶ï¼Œå¦åˆ™æ¨é€ä»£ç æ—¶ä¼šé»˜è®¤è¢«é™åˆ¶1må¤§å°ï¼Œç›¸å½“äºç»™nginxè®¾ç½®client_max_body_sizeçš„é™åˆ¶å¤§å° ä½¿ç”¨gitlab=trueæ¥é€‰æ‹©èŠ‚ç‚¹ ä½¿ç”¨æœåŠ¡å‘ç°åœ°å€æ¥è®¿é—®postgreså’Œredis åœ¨secretä¸­å¼•ç”¨æ•°æ®åº“è´¦æˆ·å’Œå¯†ç  æ•°æ®åº“åç§°ä¸ºgitlab  $ cat gitlab.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: gitlab  namespace: jenkins  annotations:  nginx.ingress.kubernetes.io/proxy-body-size: \"50m\" spec:  rules:  - host: gitlab.luffy.com  http:  paths:  - backend:  serviceName: gitlab  servicePort: 80  path: / --- apiVersion: v1 kind: Service metadata:  name: gitlab  labels:  app: gitlab  namespace: jenkins spec:  ports:  - name: server  port: 80  targetPort: 80  protocol: TCP  selector:  app: gitlab --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: gitlab  labels:  app: gitlab spec:  replicas: 1  selector:  matchLabels:  app: gitlab  template:  metadata:  labels:  app: gitlab  spec:  nodeSelector:  gitlab: \"true\"  tolerations:  - operator: \"Exists\"  containers:  - name: gitlab  image: sameersbn/gitlab:13.2.2  imagePullPolicy: \"IfNotPresent\"  env:  - name: GITLAB_HOST  value: \"gitlab.luffy.com\"  - name: GITLAB_PORT  value: \"80\"  - name: GITLAB_SECRETS_DB_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: GITLAB_SECRETS_DB_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: GITLAB_SECRETS_SECRET_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: GITLAB_SECRETS_OTP_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: DB_HOST  value: \"postgres\"  - name: DB_NAME  value: \"gitlab\"  - name: DB_USER  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.user.root  - name: DB_PASS  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.pwd.root  - name: REDIS_HOST  value: \"redis\"  - name: REDIS_PORT  value: \"6379\"  ports:  - containerPort: 80  resources:  limits:  cpu: 2000m  memory: 5048Mi  requests:  cpu: 100m  memory: 500Mi  volumeMounts:  - mountPath: /home/git/data  name: data  volumes:  - name: data  hostPath:  path: /var/lib/gitlab/  #éƒ¨ç½²åˆ°k8s-slave2èŠ‚ç‚¹ $ kubectl label node k8s-slave2 gitlab=true  # åˆ›å»º $ kubectl create -f gitlab.yaml   é…ç½®hostsè§£æï¼š\n172.21.51.67 gitlab.luffy.com è®¾ç½®rootå¯†ç \nè®¿é—®http://gitlab.luffy.comï¼Œè®¾ç½®ç®¡ç†å‘˜å¯†ç \né…ç½®k8s-masterèŠ‚ç‚¹çš„hosts\n$ echo \"172.21.51.67 gitlab.luffy.com\" /etc/hosts myblogé¡¹ç›®æ¨é€åˆ°gitlab\nmkdir demo cp -r myblog demo/ cd demo/myblog git remote rename origin old-origin git remote add origin http://gitlab.luffy.com/root/myblog.git git push -u origin --all git push -u origin --tags é’‰é’‰æ¨é€\nå®˜æ–¹æ–‡æ¡£\n  é…ç½®æœºå™¨äºº\n  è¯•éªŒå‘é€æ¶ˆæ¯\n$ curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\  -H 'Content-Type: application/json' \\  -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"æˆ‘å°±æ˜¯æˆ‘, æ˜¯ä¸ä¸€æ ·çš„çƒŸç«\" } }'   æ¼”ç¤ºè¿‡ç¨‹ æµç¨‹ç¤ºæ„å›¾ï¼š\n  å®‰è£…gitlab plugin\næ’ä»¶ä¸­å¿ƒæœç´¢å¹¶å®‰è£…gitlabï¼Œç›´æ¥å®‰è£…å³å¯\n  é…ç½®Gitlab\nç³»ç»Ÿç®¡ç†-ç³»ç»Ÿé…ç½®-Gitlabï¼Œå…¶ä¸­çš„API Tokenï¼Œéœ€è¦ä»ä¸‹ä¸ªæ­¥éª¤ä¸­è·å–\n  è·å–AccessToken\nç™»å½•gitlabï¼Œé€‰æ‹©user-Settings-access tokensæ–°å»ºä¸€ä¸ªè®¿é—®token\n  é…ç½®hostè§£æ\nç”±äºæˆ‘ä»¬çš„Jenkinså’ŒgitlabåŸŸåæ˜¯æœ¬åœ°è§£æï¼Œå› æ­¤éœ€è¦è®©gitlabå’ŒJenkinsæœåŠ¡å¯ä»¥è§£æåˆ°å¯¹æ–¹çš„åŸŸåã€‚ä¸¤ç§æ–¹å¼ï¼š\n  åœ¨å®¹å™¨å†…é…ç½®hosts\n  é…ç½®corednsçš„é™æ€è§£æ\n hosts {  172.21.51.67 jenkins.luffy.com gitlab.luffy.com  fallthrough  }     åˆ›å»ºè‡ªç”±é£æ ¼é¡¹ç›®\n gitlab connection é€‰æ‹©ä¸ºåˆšåˆ›å»ºçš„gitlab æºç ç®¡ç†é€‰æ‹©Gitï¼Œå¡«é¡¹é¡¹ç›®åœ°å€ æ–°å»ºä¸€ä¸ª Credentials è®¤è¯ï¼Œä½¿ç”¨ç”¨æˆ·åå¯†ç æ–¹å¼ï¼Œé…ç½®gitlabçš„ç”¨æˆ·å’Œå¯†ç  æ„å»ºè§¦å‘å™¨é€‰æ‹© Build when a change is pushed to GitLab ç”Ÿæˆä¸€ä¸ªSecret token ä¿å­˜    åˆ°gitlabé…ç½®webhook\n è¿›å…¥é¡¹ç›®ä¸‹settings-Integrations URLï¼š http://jenkins.luffy.com/project/free Secret Token å¡«å…¥åœ¨Jenkinsç«¯ç”Ÿæˆçš„token Add webhook test push eventsï¼ŒæŠ¥é”™ï¼šRequests to the local network are not allowed    è®¾ç½®gitlabå…è®¸å‘æœ¬åœ°ç½‘ç»œå‘é€webhookè¯·æ±‚\nè®¿é—® Admin Aera - Settings - Network ï¼Œå±•å¼€Outbound requests\nCollapseï¼Œå‹¾é€‰ç¬¬ä¸€é¡¹å³å¯ã€‚å†æ¬¡test push eventsï¼ŒæˆåŠŸã€‚\n  é…ç½®freeé¡¹ç›®ï¼Œå¢åŠ æ„å»ºæ­¥éª¤ï¼Œæ‰§è¡Œshellï¼Œå°†å‘é€é’‰é’‰æ¶ˆæ¯çš„shellä¿å­˜\n  æäº¤ä»£ç åˆ°gitlabä»“åº“ï¼ŒæŸ¥çœ‹æ„å»ºæ˜¯å¦è‡ªåŠ¨æ‰§è¡Œ\n    Master-Slavesï¼ˆagentï¼‰æ¨¡å¼ ä¸Šé¢æ¼”ç¤ºçš„ä»»åŠ¡ï¼Œé»˜è®¤éƒ½æ˜¯åœ¨masterèŠ‚ç‚¹æ‰§è¡Œçš„ï¼Œå¤šä¸ªä»»åŠ¡éƒ½åœ¨masterèŠ‚ç‚¹æ‰§è¡Œï¼Œå¯¹masterèŠ‚ç‚¹çš„æ€§èƒ½ä¼šé€ æˆä¸€å®šå½±å“ï¼Œå¦‚ä½•å°†ä»»åŠ¡åˆ†æ•£åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œåšæˆå¤šslaveçš„æ–¹å¼ï¼Ÿ\n  æ·»åŠ slaveèŠ‚ç‚¹\n  ç³»ç»Ÿç®¡ç† - èŠ‚ç‚¹ç®¡ç† - æ–°å»ºèŠ‚ç‚¹\n  æ¯”å¦‚æ·»åŠ 172.21.51.68ï¼Œé€‰æ‹©å›ºå®šèŠ‚ç‚¹ï¼Œä¿å­˜\n  è¿œç¨‹å·¥ä½œç›®å½•/opt/jenkins_jobs\n  æ ‡ç­¾ä¸ºä»»åŠ¡é€‰æ‹©èŠ‚ç‚¹çš„ä¾æ®ï¼Œå¦‚172.21.51.68\n  å¯åŠ¨æ–¹å¼é€‰æ‹©é€šè¿‡java webå¯åŠ¨ä»£ç†ï¼Œä»£ç†æ˜¯è¿è¡ŒjaråŒ…ï¼Œé€šè¿‡JNLPï¼ˆæ˜¯ä¸€ç§å…è®¸å®¢æˆ·ç«¯å¯åŠ¨æ‰˜ç®¡åœ¨è¿œç¨‹WebæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç¨‹åºçš„åè®® ï¼‰å¯åŠ¨è¿æ¥åˆ°masterèŠ‚ç‚¹æœåŠ¡ä¸­\n    æ‰§è¡Œjavaå‘½ä»¤å¯åŠ¨agentæœåŠ¡\n## ç™»å½•172.21.51.68ï¼Œä¸‹è½½agent.jar $ wget http://jenkins.luffy.com/jnlpJars/agent.jar ## ä¼šæç¤ºæ‰¾ä¸åˆ°agenté”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰é…ç½®åœ°å€è§£æï¼Œç”±äºè¿æ¥jenkins masterä¼šé€šè¿‡50000ç«¯å£ï¼Œç›´æ¥ä½¿ç”¨cluster-ip $ kubectl -n jenkins get svc #åœ¨masterèŠ‚ç‚¹æ‰§è¡ŒæŸ¥è¯¢cluster-ipåœ°å€ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE jenkins ClusterIP 10.99.204.208  8080/TCP,50000/TCP 4h8m  ## å†æ¬¡å›åˆ°68èŠ‚ç‚¹ $ wget 10.99.204.208:8080/jnlpJars/agent.jar $ java -jar agent.jar -jnlpUrl http://10.99.204.208:8080/computer/172.21.51.68/slave-agent.jnlp -secret 4be4d164f861d2830835653567867a1e695b30c320d35eca2be9f5624f8712c8 -workDir \"/opt/jenkins_jobs\" ... INFO: Remoting server accepts the following protocols: [JNLP4-connect, Ping] Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Agent discovery successful  Agent address: 10.99.204.208  Agent port: 50000  Identity: e4:46:3ağŸ‡©ğŸ‡ª86:24:8e:15:09:13:3d:a7:4e:07:04:37 Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Handshaking Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Connecting to 10.99.204.208:50000 Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Trying protocol: JNLP4-connect Apr 01, 2020 7:04:02 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Remote identity confirmed: e4:46:3ağŸ‡©ğŸ‡ª86:24:8e:15:09:13:3d:a7:4e:07:04:37 Apr 01, 2020 7:04:03 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Connected è‹¥å‡ºç°å¦‚ä¸‹é”™è¯¯:\nSEVERE: http://jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity. java.io.IOException: http://jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity.  at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:287)  at hudson.remoting.Engine.innerRun(Engine.java:694)  at hudson.remoting.Engine.run(Engine.java:519) å¯ä»¥é€‰æ‹©ï¼š é…ç½®ä»èŠ‚ç‚¹ - é«˜çº§ - Tunnelè¿æ¥ä½ç½®ï¼Œå‚è€ƒä¸‹å›¾è¿›è¡Œè®¾ç½®:\n  æŸ¥çœ‹JenkinsèŠ‚ç‚¹åˆ—è¡¨ï¼Œæ–°èŠ‚ç‚¹å·²ç»å¤„äºå¯ç”¨çŠ¶æ€\n  æµ‹è¯•ä½¿ç”¨æ–°èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡\n  é…ç½®freeé¡¹ç›®\n  é™åˆ¶é¡¹ç›®çš„è¿è¡ŒèŠ‚ç‚¹ ï¼Œæ ‡ç­¾è¡¨è¾¾å¼é€‰æ‹©172.21.51.68\n  ç«‹å³æ„å»º\n  æŸ¥çœ‹æ„å»ºæ—¥å¿—\nStarted by user admin Running as SYSTEM Building remotely on 172.21.51.68 in workspace /opt/jenkins_jobs/workspace/free-demo using credential gitlab-user Cloning the remote Git repository Cloning repository http://gitlab.luffy.com/root/myblog.git   git init /opt/jenkins_jobs/workspace/free-demo # timeout=10  ...       Jenkinså®šåˆ¶åŒ–å®¹å™¨ ç”±äºæ¯æ¬¡æ–°éƒ¨ç½²Jenkinsç¯å¢ƒï¼Œå‡éœ€è¦å®‰è£…å¾ˆå¤šå¿…è¦çš„æ’ä»¶ï¼Œå› æ­¤è€ƒè™‘æŠŠæ’ä»¶æå‰åšåˆ°é•œåƒä¸­\nDockerfile\nFROMjenkinsci/blueocean:1.23.2LABEL maintainer=\"inspur_lyx@hotmail.com\"## ç”¨æœ€æ–°çš„æ’ä»¶åˆ—è¡¨æ–‡ä»¶æ›¿æ¢é»˜è®¤æ’ä»¶æ–‡ä»¶COPY plugins.txt /usr/share/jenkins/ref/## æ‰§è¡Œæ’ä»¶å®‰è£…RUN /usr/local/bin/install-plugins.sh plugins.txt\nace-editor:1.1 allure-jenkins-plugin:2.28.1 ant:1.10 antisamy-markup-formatter:1.6 apache-httpcomponents-client-4-api:4.5.10-1.0 authentication-tokens:1.3 ... get_plugin.sh\n admin:123456@localhost éœ€è¦æ›¿æ¢æˆJenkinsçš„ç”¨æˆ·åã€å¯†ç åŠè®¿é—®åœ°å€\n #!/usr/bin/env bash curl -sSL \"http://admin:123456@localhost:8080/pluginManager/api/xml?depth=1\u0026xpath=/*/*/shortName|/*/*/version\u0026wrapper=plugins\" | perl -pe 's/.*?([\\w-]+).*?([^)+/\\1:\\2\\n/g'|sed 's/ /:/'  plugins.txt ## æ‰§è¡Œæ„å»ºï¼Œå®šåˆ¶jenkinså®¹å™¨ $ docker build . -t 172.21.51.67:5000/jenkins:v20200414 -f Dockerfile $ docker push 172.21.51.67:5000/jenkins:v20200414 è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®šåˆ¶åŒ–çš„é•œåƒå¯åŠ¨jenkinsæœåŠ¡\n## åˆ æ‰å½“å‰æœåŠ¡ $ kubectl delete -f jenkins-all.yaml  ## åˆ æ‰å·²æŒ‚è½½çš„æ•°æ® $ rm -rf /var/jenkins_home  ## æ›¿æ¢ä½¿ç”¨å®šåˆ¶åŒ–é•œåƒ $ sed -i 's#jenkinsci/blueocean#172.21.51.67:5000/jenkins:v20200404#g' jenkins-all.yaml  ## é‡æ–°åˆ›å»ºæœåŠ¡ $ kubectl create -f jenkins-all.yaml æœ¬ç« å°ç»“ è‡ªç”±é£æ ¼é¡¹ç›®å¼Šç«¯ï¼š\n ä»»åŠ¡çš„å®Œæˆéœ€è¦åœ¨Jenkinsç«¯ç»´æŠ¤å¤§é‡çš„é…ç½® æ²¡æ³•åšç‰ˆæœ¬æ§åˆ¶ å¯è¯»æ€§ã€å¯ç§»æ¤æ€§å¾ˆå·®ï¼Œä¸å¤Ÿä¼˜é›…    æµæ°´çº¿å…¥é—¨ å®˜æ–¹æ–‡æ¡£\nä¸ºä»€ä¹ˆå«åšæµæ°´çº¿ï¼Œå’Œå·¥å‚äº§å“çš„ç”Ÿäº§çº¿ç±»ä¼¼ï¼Œpipelineæ˜¯ä»æºç åˆ°å‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒã€‚å…³äºæµæ°´çº¿ï¼Œéœ€è¦çŸ¥é“çš„å‡ ä¸ªç‚¹ï¼š\n  é‡è¦çš„åŠŸèƒ½æ’ä»¶ï¼Œå¸®åŠ©Jenkinså®šä¹‰äº†ä¸€å¥—å·¥ä½œæµæ¡†æ¶ï¼›\n  Pipeline çš„å®ç°æ–¹å¼æ˜¯ä¸€å¥— Groovy DSLï¼ˆ é¢†åŸŸä¸“ç”¨è¯­è¨€ ï¼‰ï¼Œæ‰€æœ‰çš„å‘å¸ƒæµç¨‹éƒ½å¯ä»¥è¡¨è¿°ä¸ºä¸€æ®µ Groovy è„šæœ¬ï¼›\n  å°†WebUIä¸Šéœ€è¦å®šä¹‰çš„ä»»åŠ¡ï¼Œä»¥è„šæœ¬ä»£ç çš„æ–¹å¼è¡¨è¿°å‡ºæ¥ï¼›\n  å¸®åŠ©jenkinså®ç°æŒç»­é›†æˆCIï¼ˆContinue Integrationï¼‰å’ŒæŒç»­éƒ¨ç½²CDï¼ˆContinue Deliverï¼‰çš„é‡è¦æ‰‹æ®µï¼›\n  æµæ°´çº¿åŸºç¡€è¯­æ³• å®˜æ–¹æ–‡æ¡£\nä¸¤ç§è¯­æ³•ç±»å‹ï¼š\n Scripted Pipelineï¼Œè„šæœ¬å¼æµæ°´çº¿ï¼Œæœ€åˆæ”¯æŒçš„ç±»å‹ Declarative Pipelineï¼Œå£°æ˜å¼æµæ°´çº¿ï¼Œä¸ºPipeline pluginåœ¨2.5ç‰ˆæœ¬ä¹‹åæ–°å¢çš„ä¸€ç§è„šæœ¬ç±»å‹ï¼Œåç»­Open Blue Oceanæ‰€æ”¯æŒçš„ç±»å‹ã€‚ä¸åŸå…ˆçš„Scripted Pipelineä¸€æ ·ï¼Œéƒ½å¯ä»¥ç”¨æ¥ç¼–å†™è„šæœ¬ã€‚Declarative Pipeline æ˜¯åç»­Open Blue Oceanæ‰€æ”¯æŒçš„ç±»å‹ï¼Œå†™æ³•ç®€å•ï¼Œæ”¯æŒå†…åµŒScripted Pipelineä»£ç   ä¸ºä¸BlueOceanè„šæœ¬ç¼–è¾‘å™¨å…¼å®¹ï¼Œé€šå¸¸å»ºè®®ä½¿ç”¨Declarative Pipelineçš„æ–¹å¼è¿›è¡Œç¼–å†™,ä»jenkinsç¤¾åŒºçš„åŠ¨å‘æ¥çœ‹ï¼Œå¾ˆæ˜æ˜¾è¿™ç§è¯­æ³•ç»“æ„ä¹Ÿä¼šæ˜¯æœªæ¥çš„è¶‹åŠ¿ã€‚\nè„šæœ¬ç¤ºä¾‹ pipeline {  agent {label '172.21.51.68'}  environment {  PROJECT = 'myblog'  }  stages {  stage('Checkout') {  steps {  checkout scm  }  }  stage('Build') {  steps {  sh 'make'  }  }  stage('Test'){  steps {  sh 'make check'  junit 'reports/**/*.xml'  }  }  stage('Deploy') {  steps {  sh 'make publish'  }  }  } \tpost {  success {  echo 'Congratulations!'  } \tfailure {  echo 'Oh no!'  }  always {  echo 'I will always say Hello again!'  }  } } è„šæœ¬è§£é‡Šï¼š   checkoutæ­¥éª¤ä¸ºæ£€å‡ºä»£ç ; scmæ˜¯ä¸€ä¸ªç‰¹æ®Šå˜é‡ï¼ŒæŒ‡ç¤ºcheckoutæ­¥éª¤å…‹éš†è§¦å‘æ­¤Pipelineè¿è¡Œçš„ç‰¹å®šä¿®è®¢\n  agentï¼šæŒ‡æ˜ä½¿ç”¨å“ªä¸ªagentèŠ‚ç‚¹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®šä¹‰äºpipelineé¡¶å±‚æˆ–è€…stageå†…éƒ¨\n  anyï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„å¯ç”¨çš„agentæ¥æ‰§è¡Œ\n  labelï¼Œåœ¨æä¾›äº†æ ‡ç­¾çš„ Jenkins ç¯å¢ƒä¸­å¯ç”¨çš„ä»£ç†ä¸Šæ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚ ä¾‹å¦‚: agent { label 'my-defined-label' }ï¼Œæœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼\n  noneï¼Œå½“åœ¨ pipeline å—çš„é¡¶éƒ¨æ²¡æœ‰å…¨å±€ä»£ç†ï¼Œ è¯¥å‚æ•°å°†ä¼šè¢«åˆ†é…åˆ°æ•´ä¸ªæµæ°´çº¿çš„è¿è¡Œä¸­å¹¶ä¸”æ¯ä¸ª stage éƒ¨åˆ†éƒ½éœ€è¦åŒ…å«ä»–è‡ªå·±çš„ agent éƒ¨åˆ†ã€‚æ¯”å¦‚: agent none\n  dockerï¼Œ ä½¿ç”¨ç»™å®šçš„å®¹å™¨æ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚ åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸­ï¼Œé€šè¿‡è¿è¡Œå®¹å™¨æ¥æ‰§è¡Œä»»åŠ¡\nagent {  docker {  image 'maven:3-alpine'  label 'my-defined-label'  args '-v /tmp:/tmp'  } }     options: å…è®¸ä»æµæ°´çº¿å†…éƒ¨é…ç½®ç‰¹å®šäºæµæ°´çº¿çš„é€‰é¡¹ã€‚\n buildDiscarder , ä¸ºæœ€è¿‘çš„æµæ°´çº¿è¿è¡Œçš„ç‰¹å®šæ•°é‡ä¿å­˜ç»„ä»¶å’Œæ§åˆ¶å°è¾“å‡ºã€‚ä¾‹å¦‚: options { buildDiscarder(logRotator(numToKeepStr: '10')) } disableConcurrentBuilds ,ä¸å…è®¸åŒæ—¶æ‰§è¡Œæµæ°´çº¿ã€‚ å¯è¢«ç”¨æ¥é˜²æ­¢åŒæ—¶è®¿é—®å…±äº«èµ„æºç­‰ã€‚ ä¾‹å¦‚: options { disableConcurrentBuilds() } timeout ,è®¾ç½®æµæ°´çº¿è¿è¡Œçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkinså°†ä¸­æ­¢æµæ°´çº¿ã€‚ä¾‹å¦‚: options { timeout(time: 1, unit: 'HOURS') } retryï¼Œåœ¨å¤±è´¥æ—¶, é‡æ–°å°è¯•æ•´ä¸ªæµæ°´çº¿çš„æŒ‡å®šæ¬¡æ•°ã€‚ For example: options { retry(3) }    environment: æŒ‡ä»¤åˆ¶å®šä¸€ä¸ª é”®-å€¼å¯¹åºåˆ—ï¼Œè¯¥åºåˆ—å°†è¢«å®šä¹‰ä¸ºæ‰€æœ‰æ­¥éª¤çš„ç¯å¢ƒå˜é‡\n  stages: åŒ…å«ä¸€ç³»åˆ—ä¸€ä¸ªæˆ–å¤šä¸ª stageæŒ‡ä»¤, stages éƒ¨åˆ†æ˜¯æµæ°´çº¿æè¿°çš„å¤§éƒ¨åˆ†\"work\" çš„ä½ç½®ã€‚ å»ºè®® stages è‡³å°‘åŒ…å«ä¸€ä¸ª stage æŒ‡ä»¤ç”¨äºè¿ç»­äº¤ä»˜è¿‡ç¨‹çš„æ¯ä¸ªç¦»æ•£éƒ¨åˆ†,æ¯”å¦‚æ„å»º, æµ‹è¯•, å’Œéƒ¨ç½²ã€‚\npipeline {  agent any  stages {  stage('Example') {  steps {  echo 'Hello World'  }  }  } }   steps: åœ¨ç»™å®šçš„ stage æŒ‡ä»¤ä¸­æ‰§è¡Œçš„å®šä¹‰äº†ä¸€ç³»åˆ—çš„ä¸€ä¸ªæˆ–å¤šä¸ªstepsã€‚\n  post: å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªsteps ï¼Œè¿™äº›é˜¶æ®µæ ¹æ®æµæ°´çº¿æˆ–é˜¶æ®µçš„å®Œæˆæƒ…å†µè€Œè¿è¡Œpost æ”¯æŒä»¥ä¸‹ post-condition å—ä¸­çš„å…¶ä¸­ä¹‹ä¸€: always, changed, failure, success, unstable, å’Œ abortedã€‚\n always, æ— è®ºæµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€å¦‚ä½•ï¼Œéƒ½å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤ changed, å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸å®ƒä¹‹å‰çš„è¿è¡Œä¸åŒæ—¶ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤ failure, å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º\"failure\"ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯çº¢è‰² success, å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º\"success\"ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯è“è‰²æˆ–ç»¿è‰² unstable, å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º\"unstable\"ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµ‹è¯•å¤±è´¥,ä»£ç è¿è§„ç­‰é€ æˆã€‚é€šå¸¸web UIæ˜¯é»„è‰² abortedï¼Œ åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º\"aborted\"ï¼Œæ‰å…è®¸åœ¨ post éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµæ°´çº¿è¢«æ‰‹åŠ¨çš„abortedã€‚é€šå¸¸web UIæ˜¯ç°è‰²    åˆ›å»ºpipelineç¤ºæ„ï¼š\næ–°å»ºä»»åŠ¡ - æµæ°´çº¿\njenkins/pipelines/p1.yaml\npipeline {  agent {label '172.21.51.68'}  environment {  PROJECT = 'myblog'  }  stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-user', url: 'http://gitlab.luffy.com/root/myblog.git']]])  }  }  stage('build-image') {  steps {  sh 'docker build . -t myblog:latest -f Dockerfile'  }  }  stage('send-msg') {  steps {  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"æˆ‘å°±æ˜¯æˆ‘, æ˜¯ä¸ä¸€æ ·çš„çƒŸç«\" } }' \"\"\"  }  }  } } ç‚¹å‡»â€œç«‹å³æ„å»ºâ€ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®è§¦å‘å™¨ï¼Œä½¿ç”¨webhookçš„æ–¹å¼æ¥æ”¶é¡¹ç›®çš„pushäº‹ä»¶ï¼Œ\n æ„å»ºè§¦å‘å™¨é€‰æ‹© Build when a change is pushed to GitLab. ç”Ÿæˆ Secret token é…ç½®gitlabï¼Œåˆ›å»ºwebhookï¼Œå‘é€test push eventsæµ‹è¯•  Blue Ocean: å®˜æ–¹æ–‡æ¡£\næˆ‘ä»¬éœ€è¦çŸ¥é“çš„å‡ ç‚¹ï¼š\n æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œ æ—¨åœ¨ä¸ºPipelineæä¾›ä¸°å¯Œçš„ä½“éªŒ ï¼› è¿ç»­äº¤ä»˜ï¼ˆCDï¼‰Pipelineçš„å¤æ‚å¯è§†åŒ–ï¼Œå…è®¸å¿«é€Ÿå’Œç›´è§‚åœ°äº†è§£Pipelineçš„çŠ¶æ€ï¼› ç›®å‰æ”¯æŒçš„ç±»å‹ä»…é’ˆå¯¹äºPipelineï¼Œå°šä¸èƒ½æ›¿ä»£Jenkins ç»å…¸ç‰ˆUI  æ€è€ƒï¼š\n æ¯ä¸ªé¡¹ç›®éƒ½æŠŠå¤§é‡çš„pipelineè„šæœ¬å†™åœ¨Jenkinsç«¯ï¼Œå¯¹äºè°å»ç»´æŠ¤åŠç»´æŠ¤æˆæœ¬æ˜¯ä¸€ä¸ªé—®é¢˜ æ²¡æ³•åšç‰ˆæœ¬æ§åˆ¶    Jenkinsflie Jenkins Pipeline æä¾›äº†ä¸€å¥—å¯æ‰©å±•çš„å·¥å…·ï¼Œç”¨äºå°†â€œç®€å•åˆ°å¤æ‚â€çš„äº¤ä»˜æµç¨‹å®ç°ä¸ºâ€œæŒç»­äº¤ä»˜å³ä»£ç â€ã€‚Jenkins Pipeline çš„å®šä¹‰é€šå¸¸è¢«å†™å…¥åˆ°ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ˆç§°ä¸º Jenkinsfile ï¼‰ä¸­ï¼Œè¯¥æ–‡ä»¶å¯ä»¥è¢«æ”¾å…¥é¡¹ç›®çš„æºä»£ç æ§åˆ¶åº“ä¸­ã€‚\næ¼”ç¤º1ï¼šä½¿ç”¨Jenkinsfileç®¡ç†pipeline  åœ¨é¡¹ç›®ä¸­æ–°å»ºJenkinsfileæ–‡ä»¶ï¼Œæ‹·è´å·²æœ‰scriptå†…å®¹ é…ç½®pipelineä»»åŠ¡ï¼Œæµæ°´çº¿å®šä¹‰ä¸ºPipeline Script from SCM æ‰§è¡Œpush ä»£ç æµ‹è¯•  Jenkinsfile:\njenkins/pipelines/p2.yaml\npipeline {  agent { label '172.21.51.68'}   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-user', url: 'http://gitlab.luffy.com/root/myblog.git']]])  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t myblog:latest'}  }  }  stage('send-msg') {  steps {  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"æˆ‘å°±æ˜¯æˆ‘, æ˜¯ä¸ä¸€æ ·çš„çƒŸç«\" } }' \"\"\"  }  }  } } æ¼”ç¤º2ï¼šä¼˜åŒ–åŠä¸°å¯Œæµæ°´çº¿å†…å®¹   ä¼˜åŒ–ä»£ç æ£€å‡ºé˜¶æ®µ\nç”±äºç›®å‰å·²ç»é…ç½®äº†ä½¿ç”¨gitä»“åº“åœ°å€ï¼Œä¸”ä½¿ç”¨SCMæ¥æ£€æµ‹é¡¹ç›®ï¼Œå› æ­¤ä»£ç æ£€å‡ºé˜¶æ®µå®Œå…¨æ²¡æœ‰å¿…è¦å†å»æŒ‡å®šä¸€æ¬¡\n  æ„å»ºé•œåƒçš„tagä½¿ç”¨gitçš„commit id\n  å¢åŠ posté˜¶æ®µçš„æ¶ˆæ¯é€šçŸ¥ï¼Œä¸°å¯Œé€šçŸ¥å†…å®¹\n  é…ç½®webhookï¼Œå®ç°myblogä»£ç æ¨é€åï¼Œè§¦å‘Jenkinsfileä»»åŠ¡æ‰§è¡Œ\n  jenkins/pipelines/p3.yaml\npipeline {  agent { label '172.21.51.68'}   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout scm  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t myblog:${GIT_COMMIT}'}  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"ğŸ˜„ğŸ‘æ„å»ºæˆåŠŸğŸ‘ğŸ˜„\\n å…³é”®å­—ï¼šluffy\\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"ğŸ˜–âŒæ„å»ºå¤±è´¥âŒğŸ˜–\\n å…³é”®å­—ï¼šluffy\\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } æ¼”ç¤º3ï¼šä½¿ç”¨k8séƒ¨ç½²æœåŠ¡   æ–°å»ºdeployç›®å½•ï¼Œå°†k8sæ‰€éœ€çš„æ–‡ä»¶æ”¾åˆ°deployç›®å½•ä¸­\n  å°†é•œåƒåœ°å€æ”¹æˆæ¨¡æ¿ï¼Œåœ¨pipelineä¸­ä½¿ç”¨æ–°æ„å»ºçš„é•œåƒè¿›è¡Œæ›¿æ¢\n  æ‰§è¡Œkubectl apply -f deployåº”ç”¨æ›´æ”¹ï¼Œéœ€è¦é…ç½®kubectlè®¤è¯\n$ scp -r k8s-master:/root/.kube /root   jenkins/pipelines/p4.yaml\npipeline {  agent { label '172.21.51.68'}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  }   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout scm  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"ğŸ˜„ğŸ‘æ„å»ºæˆåŠŸğŸ‘ğŸ˜„\\n å…³é”®å­—ï¼šmyblog\\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"ğŸ˜–âŒæ„å»ºå¤±è´¥âŒğŸ˜–\\n å…³é”®å­—ï¼šluffy\\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } æ¼”ç¤º4ï¼šä½¿ç”¨å‡­æ®ç®¡ç†æ•æ„Ÿä¿¡æ¯ ä¸Šè¿°Jenkinsfileä¸­å­˜åœ¨çš„é—®é¢˜æ˜¯æ•æ„Ÿä¿¡æ¯ä½¿ç”¨æ˜æ–‡ï¼Œæš´æ¼åœ¨ä»£ç ä¸­ï¼Œå¦‚ä½•ç®¡ç†æµæ°´çº¿ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼ˆåŒ…å«è´¦å·å¯†ç ï¼‰ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨å¯¹æ¥gitlabçš„æ—¶å€™ï¼Œéœ€è¦è´¦å·å¯†ç ï¼Œå·²ç»ä½¿ç”¨è¿‡å‡­æ®æ¥ç®¡ç†è¿™ç±»æ•æ„Ÿä¿¡æ¯ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡­æ®æ¥å­˜å‚¨é’‰é’‰çš„tokenä¿¡æ¯ï¼Œé‚£ä¹ˆï¼Œåˆ›å»ºå¥½å‡­æ®åï¼Œå¦‚ä½•åœ¨Jenkinsfileä¸­è·å–å·²æœ‰å‡­æ®çš„å†…å®¹ï¼Ÿ\nJenkins çš„å£°æ˜å¼æµæ°´çº¿è¯­æ³•æœ‰ä¸€ä¸ª credentials() è¾…åŠ©æ–¹æ³•ï¼ˆåœ¨environment æŒ‡ä»¤ä¸­ä½¿ç”¨ï¼‰ï¼Œå®ƒæ”¯æŒ secret æ–‡æœ¬ï¼Œå¸¦å¯†ç çš„ç”¨æˆ·åï¼Œä»¥åŠ secret æ–‡ä»¶å‡­æ®ã€‚\nä¸‹é¢çš„æµæ°´çº¿ä»£ç ç‰‡æ®µå±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªä½¿ç”¨å¸¦å¯†ç çš„ç”¨æˆ·åå‡­æ®çš„ç¯å¢ƒå˜é‡çš„æµæ°´çº¿ã€‚\nåœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œå¸¦å¯†ç çš„ç”¨æˆ·åå‡­æ®è¢«åˆ†é…äº†ç¯å¢ƒå˜é‡ï¼Œç”¨æ¥ä½¿ä½ çš„ç»„ç»‡æˆ–å›¢é˜Ÿä»¥ä¸€ä¸ªå…¬ç”¨è´¦æˆ·è®¿é—® Bitbucket ä»“åº“ï¼›è¿™äº›å‡­æ®å·²åœ¨ Jenkins ä¸­é…ç½®äº†å‡­æ® ID jenkins-bitbucket-common-credsã€‚\nå½“åœ¨ environment æŒ‡ä»¤ä¸­è®¾ç½®å‡­æ®ç¯å¢ƒå˜é‡æ—¶ï¼š\nenvironment { BITBUCKET_COMMON_CREDS = credentials('jenkins-bitbucket-common-creds') } è¿™å®é™…è®¾ç½®äº†ä¸‹é¢çš„ä¸‰ä¸ªç¯å¢ƒå˜é‡ï¼š\n BITBUCKET_COMMON_CREDS - åŒ…å«ä¸€ä¸ªä»¥å†’å·åˆ†éš”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ ¼å¼ä¸º username:passwordã€‚ BITBUCKET_COMMON_CREDS_USR - é™„åŠ çš„ä¸€ä¸ªä»…åŒ…å«ç”¨æˆ·åéƒ¨åˆ†çš„å˜é‡ã€‚ BITBUCKET_COMMON_CREDS_PSW - é™„åŠ çš„ä¸€ä¸ªä»…åŒ…å«å¯†ç éƒ¨åˆ†çš„å˜é‡ã€‚  pipeline {  agent {  // æ­¤å¤„å®šä¹‰ agent çš„ç»†èŠ‚  }  environment {  //é¡¶å±‚æµæ°´çº¿å—ä¸­ä½¿ç”¨çš„ environment æŒ‡ä»¤å°†é€‚ç”¨äºæµæ°´çº¿ä¸­çš„æ‰€æœ‰æ­¥éª¤ã€‚  BITBUCKET_COMMON_CREDS = credentials('jenkins-bitbucket-common-creds')  }  stages {  stage('Example stage 1') {  //åœ¨ä¸€ä¸ª stage ä¸­å®šä¹‰çš„ environment æŒ‡ä»¤åªä¼šå°†ç»™å®šçš„ç¯å¢ƒå˜é‡åº”ç”¨äº stage ä¸­çš„æ­¥éª¤ã€‚  environment {  BITBUCKET_COMMON_CREDS = credentials('another-credential-id')  }  steps {  //  }  }  stage('Example stage 2') {  steps {  //  }  }  } } å› æ­¤å¯¹Jenkinsfileåšæ”¹é€ ï¼š\njenkins/pipelines/p5.yaml\npipeline {  agent { label '172.21.51.68'}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  }   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout scm  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"ğŸ˜„ğŸ‘æ„å»ºæˆåŠŸğŸ‘ğŸ˜„\\n å…³é”®å­—ï¼šluffy\\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"ğŸ˜–âŒæ„å»ºå¤±è´¥âŒğŸ˜–\\n å…³é”®å­—ï¼šluffy\\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } æœ¬ç« å°ç»“ ä¸Šé¢æˆ‘ä»¬å·²ç»é€šè¿‡Jenkinsfileå®Œæˆäº†æœ€ç®€å•çš„é¡¹ç›®çš„æ„å»ºå’Œéƒ¨ç½²ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥æ€è€ƒç›®å‰çš„æ–¹å¼ï¼š\n ç›®å‰éƒ½æ˜¯åœ¨é¡¹ç›®çš„å•ä¸€åˆ†æ”¯ä¸‹è¿›è¡Œæ“ä½œï¼Œä¼ä¸šå†…ä¸€èˆ¬ä¼šä½¿ç”¨featureã€developã€releaseã€masterç­‰å¤šä¸ªåˆ†æ”¯æ¥ç®¡ç†æ•´ä¸ªä»£ç æäº¤æµç¨‹ï¼Œå¦‚ä½•æ ¹æ®ä¸åŒçš„åˆ†æ”¯æ¥åšæ„å»ºï¼Ÿ æ„å»ºè§†å›¾ä¸­å¦‚ä½•åŒºåˆ†ä¸åŒçš„åˆ†æ”¯? å¦‚ä½•ä¸é…ç½®webhookçš„æ–¹å¼å®ç°æ„å»ºï¼Ÿ å¦‚ä½•æ ¹æ®ä¸åŒçš„åˆ†æ”¯é€‰æ‹©å‘å¸ƒåˆ°ä¸åŒçš„ç¯å¢ƒ(å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§)ï¼Ÿ    å¤šåˆ†æ”¯æµæ°´çº¿ å®˜æ–¹ç¤ºä¾‹\næˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹æµç¨‹ï¼Œå‡å¦‚ä½¿ç”¨developåˆ†æ”¯ä½œä¸ºå¼€å‘åˆ†æ”¯ï¼Œmasteråˆ†æ”¯ä½œä¸ºé›†æˆæµ‹è¯•åˆ†æ”¯ï¼Œçœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨å¤šåˆ†æ”¯æµæ°´çº¿æ¥ç®¡ç†ã€‚\næ¼”ç¤º1ï¼šå¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨  æäº¤developåˆ†æ”¯ï¼š  $ git checkout -b develop $ git push --set-upstream origin develop  ç¦ç”¨pipelineé¡¹ç›®\n  Jenkinsç«¯åˆ›å»ºå¤šåˆ†æ”¯æµæ°´çº¿é¡¹ç›®\n å¢åŠ gitåˆ†æ”¯æº å‘ç°æ ‡ç­¾ æ ¹æ®åç§°è¿‡æ»¤ï¼Œdevelop|master|v.* é«˜çº§å…‹éš†ï¼Œè®¾ç½®æµ…å…‹éš†    ä¿å­˜åï¼Œä¼šè‡ªåŠ¨æ£€ç´¢é¡¹ç›®ä¸­æ‰€æœ‰å­˜åœ¨Jenkinsfileæ–‡ä»¶çš„åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œè‹¥åŒ¹é…æˆ‘ä»¬è®¾ç½®çš„è¿‡æ»¤æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™ä¼šæ·»åŠ åˆ°å¤šåˆ†æ”¯çš„æ„å»ºè§†å›¾ä¸­ã€‚æ‰€æœ‰æ·»åŠ åˆ°è§†å›¾ä¸­çš„åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œä¼šé»˜è®¤æ‰§è¡Œä¸€æ¬¡æ„å»ºä»»åŠ¡ã€‚\næ¼”ç¤º2ï¼šç¾åŒ–æ¶ˆæ¯é€šçŸ¥å†…å®¹  æ·»åŠ æ„å»ºé˜¶æ®µè®°å½• ä½¿ç”¨markdownæ ¼å¼ï¼Œæ·»åŠ æ„å»ºåˆ†æ”¯æ¶ˆæ¯  jenkins/pipelines/p6.yaml\npipeline {  agent { label '172.21.51.68'}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('printenv') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  checkout scm  script{  env.BUILD_TASKS = env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„ \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${GIT_BRANCH} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜– \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${GIT_BRANCH} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } æ¼”ç¤º3ï¼šé€šçŸ¥gitlabæ„å»ºçŠ¶æ€ Jenkinsç«¯åšäº†æ„å»ºï¼Œå¯ä»¥é€šè¿‡gitlabé€šè¿‡çš„apiå°†æ„å»ºçŠ¶æ€é€šçŸ¥è¿‡å»ï¼Œä½œä¸ºå¼€å‘äººå‘˜å‘èµ·Merge Requestæˆ–è€…åˆå¹¶Merge Requestçš„ä¾æ®ä¹‹ä¸€ã€‚\næ³¨æ„ä¸€å®šè¦æŒ‡å®šgitLabConnection(â€˜gitlabâ€™)ï¼Œä¸ç„¶æ²¡æ³•è®¤è¯åˆ°Gitlabç«¯\njenkins/pipelines/p7.yaml\npipeline {  agent { label '172.21.51.68'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('printenv') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  checkout scm  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„ \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜– \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } æˆ‘ä»¬å¯ä»¥è®¿é—®gitlabï¼Œç„¶åæ‰¾åˆ°commitè®°å½•ï¼ŒæŸ¥çœ‹åŒæ­¥çŠ¶æ€\næäº¤merge requestï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç›¸å…³çš„ä»»åŠ¡çŠ¶æ€ï¼Œå¯ä»¥ä½œä¸ºé¡¹ç›®owneråˆå¹¶ä»£ç çš„ä¾æ®ä¹‹ä¸€ï¼š\næœ¬ç« å°èŠ‚ ä¼˜åŠ¿:\n æ ¹æ®åˆ†æ”¯å±•ç¤º, è§†å›¾äººæ€§åŒ– è‡ªåŠ¨æ£€æµ‹å„åˆ†æ”¯çš„å˜æ›´  æ€è€ƒï¼š\n Jenkinsçš„slaveç«¯ï¼Œæ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™å¤„äºé—²ç½®çŠ¶æ€ï¼ŒslaveèŠ‚ç‚¹å¤šçš„è¯é€ æˆèµ„æºæµªè´¹ æ˜¯å¦å¯ä»¥åˆ©ç”¨kubernetesçš„Podæ¥å¯åŠ¨slaveï¼ŒåŠ¨æ€slave podæ¥æ‰§è¡Œæ„å»ºä»»åŠ¡    å·¥å…·é›†æˆä¸Jenkinsfileå®è·µç¯‡  Jenkinså¦‚ä½•å¯¹æ¥kubernetesé›†ç¾¤ ä½¿ç”¨kubernetesçš„Pod-Templateæ¥ä½œä¸ºåŠ¨æ€çš„agentæ‰§è¡ŒJenkinsä»»åŠ¡ å¦‚ä½•åˆ¶ä½œagentå®¹å™¨å®ç°ä¸åŒç±»å‹çš„ä¸šåŠ¡çš„é›†æˆ é›†æˆä»£ç æ‰«æã€dockeré•œåƒè‡ªåŠ¨æ„å»ºã€k8sæœåŠ¡éƒ¨ç½²ã€è‡ªåŠ¨åŒ–æµ‹è¯•  é›†æˆKubernetes æ’ä»¶å®‰è£…åŠé…ç½® æ’ä»¶å®˜æ–¹æ–‡æ¡£\n  [ç³»ç»Ÿç®¡ç†] - [æ’ä»¶ç®¡ç†] - [æœç´¢kubernetes]-ç›´æ¥å®‰è£…\nè‹¥å®‰è£…å¤±è´¥ï¼Œè¯·å…ˆæ›´æ–°bouncycastle API Pluginå¹¶é‡æ–°å¯åŠ¨Jenkins\n  [ç³»ç»Ÿç®¡ç†] - [ç³»ç»Ÿé…ç½®] - [Add a new cloud]\n  é…ç½®åœ°å€ä¿¡æ¯\n Kubernetes åœ°å€: https://kubernetes.defaultï¼ˆæˆ–è€…https://172.21.51.67:6443ï¼‰ Kubernetes å‘½åç©ºé—´ï¼šjenkins æœåŠ¡è¯ä¹¦ä¸ç”¨å†™ï¼ˆæˆ‘ä»¬åœ¨å®‰è£…Jenkinsçš„æ—¶å€™å·²ç»æŒ‡å®šè¿‡serviceAccountï¼‰ï¼Œå‡ä½¿ç”¨é»˜è®¤ è¿æ¥æµ‹è¯•ï¼ŒæˆåŠŸä¼šæç¤ºï¼šConnection test successful Jenkinsåœ°å€ï¼šhttp://jenkins:8080 Jenkins é€šé“ ï¼šjenkins:50000    é…ç½®Pod Template\n åç§°ï¼šjnlp-slave å‘½åç©ºé—´ï¼šjenkins æ ‡ç­¾åˆ—è¡¨ï¼šjnlp-slaveï¼Œä½œä¸ºagentçš„labelé€‰æ‹©ç”¨ è¿æ¥ Jenkins çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ ï¼š300ï¼Œè®¾ç½®è¿æ¥jenkinsè¶…æ—¶æ—¶é—´ èŠ‚ç‚¹é€‰æ‹©å™¨ï¼šagent=true å·¥ä½œç©ºé—´å·ï¼šé€‰æ‹©hostpathï¼Œè®¾ç½®/opt/jenkins_jobs/,æ³¨æ„éœ€è¦è®¾ç½®chown -R 1000:1000 /opt/jenkins_jobs/æƒé™ï¼Œå¦åˆ™Podæ²¡æœ‰æƒé™    æ¼”ç¤ºåŠ¨æ€slave pod # ä¸ºå‡†å¤‡è¿è¡Œjnlp-slave-agentçš„podçš„èŠ‚ç‚¹æ‰“ä¸Šlabel $ kubectl label node k8s-slave1 agent=true  ### å›æ”¾ä¸€æ¬¡å¤šåˆ†æ”¯æµæ°´çº¿developåˆ†æ”¯ agent { label 'jnlp-slave'} æ‰§è¡Œä»»åŠ¡ï¼Œä¼šä¸‹è½½é»˜è®¤çš„jnlp-slaveé•œåƒï¼Œåœ°å€ä¸ºjenkins/inbound-agent:4.3-4ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨k8s-masterèŠ‚ç‚¹æ‹‰å–ä¸‹æ¥è¯¥é•œåƒï¼š\n$ docker pull jenkins/inbound-agent:4.3-4 ä¿å­˜jenkinsfileæäº¤åï¼Œä¼šå‡ºç°æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬çš„agentå·²ç»ä¸å†æ˜¯å®¿ä¸»æœºï¼Œè€Œæ˜¯Podä¸­çš„å®¹å™¨å†…ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š\nå› æ­¤æˆ‘ä»¬éœ€è¦å°†ç”¨åˆ°çš„å‘½ä»¤è¡Œå·¥å…·é›†æˆåˆ°Podçš„å®¹å™¨å†…ï¼Œä½†æ˜¯æ€è€ƒå¦‚ä¸‹é—®é¢˜ï¼š\n ç›®å‰æ˜¯ç”¨çš„jnlpçš„å®¹å™¨ï¼Œæ˜¯javaçš„ç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šéœ€è¦é›†æˆå¾ˆå¤šå·¥å…·ï¼Œèƒ½ä¸èƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œè®©æ–°å®¹å™¨æ¥åšå…·ä½“çš„ä»»åŠ¡ï¼Œjnlp-slaveå®¹å™¨åªç”¨æ¥è´Ÿè´£è¿æ¥jenkins-master é’ˆå¯¹ä¸åŒçš„æ„å»ºç¯å¢ƒï¼ˆjavaã€pythonã€goã€nodejsï¼‰ï¼Œå¯ä»¥åˆ¶ä½œä¸åŒçš„å®¹å™¨ï¼Œæ¥æ‰§è¡Œå¯¹åº”çš„ä»»åŠ¡    Pod-Templateä¸­å®¹å™¨é•œåƒçš„åˆ¶ä½œ ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªtoolsé•œåƒï¼Œé›†æˆå¸¸ç”¨çš„å·¥å…·ï¼Œæ¥å®Œæˆå¸¸è§çš„æ„å»ºä»»åŠ¡ï¼Œéœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š\n ä½¿ç”¨alpineåŸºç¡€é•œåƒï¼Œè‡ªèº«ä½“ç§¯æ¯”è¾ƒå° æ›¿æ¢å›½å†…å®‰è£…æº ä¸ºäº†ä½¿ç”¨dockerï¼Œå®‰è£…äº†docker ä¸ºäº†å…‹éš†ä»£ç ï¼Œå®‰è£…git ä¸ºäº†åç»­åšpythonçš„æµ‹è¯•ç­‰ä»»åŠ¡ï¼Œå®‰è£…pythonç¯å¢ƒ ä¸ºäº†åœ¨å®¹å™¨ä¸­è°ƒç”¨kubectlçš„å‘½ä»¤ï¼Œæ‹·è´äº†kubectlçš„äºŒè¿›åˆ¶æ–‡ä»¶ ä¸ºäº†è®¤è¯kubectlï¼Œéœ€è¦åœ¨å®¹å™¨å†…éƒ¨ç”Ÿæˆ.kubeç›®å½•åŠconfigæ–‡ä»¶  $ mkdir tools; $ cd tools; $ cp `which kubectl` . $ cp ~/.kube/config . Dockerfile\njenkins/custom-images/tools/Dockerfile\nFROMalpineLABEL maintainer=\"inspur_lyx@hotmail.com\"USERrootRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \u0026\u0026 \\  apk update \u0026\u0026 \\  apk add --no-cache openrc docker git curl tar gcc g++ make \\  bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \\  libstdc++ harfbuzz nss freetype ttf-freefont \u0026\u0026 \\  mkdir -p /root/.kube \u0026\u0026 \\  usermod -a -G docker rootCOPY config /root/.kube/RUN rm -rf /var/cache/apk/* #-----------------å®‰è£… kubectl--------------------#COPY kubectl /usr/local/bin/RUN chmod +x /usr/local/bin/kubectl# ------------------------------------------------#æ‰§è¡Œé•œåƒæ„å»ºå¹¶æ¨é€åˆ°ä»“åº“ä¸­ï¼š\n$ docker build . -t 172.21.51.67:5000/devops/tools:v1 $ docker push 172.21.51.67:5000/devops/tools:v1 æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥é•œåƒåšæµ‹è¯•ï¼š\n## å¯åŠ¨ä¸´æ—¶é•œåƒåšæµ‹è¯• $ docker run --rm -ti 172.21.51.67:5000/devops/tools:v1 bash # / git clone http://xxxxxx.git # / kubectl get no # / python3 #/ docker  ## é‡æ–°æŒ‚è½½dockerçš„sockæ–‡ä»¶ docker run -v /var/run/docker.sock:/var/run/docker.sock --rm -ti 172.21.51.67:5000/devops/tools:v1 bash å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®è‡ªåŠ¨å‘å¸ƒåˆ°kubenetesç¯å¢ƒ æ›´æ–°Jenkinsä¸­çš„PodTemplateï¼Œæ·»åŠ toolsé•œåƒï¼Œæ³¨æ„åŒæ—¶è¦å…ˆæ·»åŠ åä¸ºjnlpçš„containerï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„PodTemplateè¦†ç›–æ‰é»˜è®¤çš„æ¨¡æ¿ï¼š\nåœ¨å·æ ç›®ï¼Œæ·»åŠ å·ï¼ŒHost Path Volumeï¼Œä¸ç„¶åœ¨å®¹å™¨ä¸­ä½¿ç”¨dockerä¼šæç¤ºdockeræœåŠ¡æœªå¯åŠ¨\ntoolså®¹å™¨åšå¥½åï¼Œæˆ‘ä»¬éœ€è¦å¯¹Jenkinsfileåšå¦‚ä¸‹è°ƒæ•´ï¼š\njenkins/pipelines/p8.yaml\npipeline {  agent { label 'jnlp-slave'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('printenv') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  container('tools') {  checkout scm  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('build-image') {  steps {  container('tools') {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  container('tools') {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  container('tools') {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„ \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜– \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } }   é›†æˆsonarQubeå®ç°ä»£ç æ‰«æ Sonarå¯ä»¥ä»ä»¥ä¸‹ä¸ƒä¸ªç»´åº¦æ£€æµ‹ä»£ç è´¨é‡ï¼Œè€Œä½œä¸ºå¼€å‘äººå‘˜è‡³å°‘éœ€è¦å¤„ç†å‰5ç§ä»£ç è´¨é‡é—®é¢˜ã€‚\n ä¸éµå¾ªä»£ç æ ‡å‡† sonarå¯ä»¥é€šè¿‡PMD,CheckStyle,Findbugsç­‰ç­‰ä»£ç è§„åˆ™æ£€æµ‹å·¥å…·è§„èŒƒä»£ç ç¼–å†™ã€‚ æ½œåœ¨çš„ç¼ºé™· sonarå¯ä»¥é€šè¿‡PMD,CheckStyle,Findbugsç­‰ç­‰ä»£ç è§„åˆ™æ£€æµ‹å·¥å…·æ£€ æµ‹å‡ºæ½œåœ¨çš„ç¼ºé™·ã€‚ ç³Ÿç³•çš„å¤æ‚åº¦åˆ†å¸ƒ æ–‡ä»¶ã€ç±»ã€æ–¹æ³•ç­‰ï¼Œå¦‚æœå¤æ‚åº¦è¿‡é«˜å°†éš¾ä»¥æ”¹å˜ï¼Œè¿™ä¼šä½¿å¾—å¼€å‘äººå‘˜ éš¾ä»¥ç†è§£å®ƒä»¬, ä¸”å¦‚æœæ²¡æœ‰è‡ªåŠ¨åŒ–çš„å•å…ƒæµ‹è¯•ï¼Œå¯¹äºç¨‹åºä¸­çš„ä»»ä½•ç»„ä»¶çš„æ”¹å˜éƒ½å°†å¯èƒ½å¯¼è‡´éœ€è¦å…¨é¢çš„å›å½’æµ‹è¯•ã€‚ é‡å¤ æ˜¾ç„¶ç¨‹åºä¸­åŒ…å«å¤§é‡å¤åˆ¶ç²˜è´´çš„ä»£ç æ˜¯è´¨é‡ä½ä¸‹çš„ï¼Œsonarå¯ä»¥å±•ç¤º æºç ä¸­é‡å¤ä¸¥é‡çš„åœ°æ–¹ã€‚ æ³¨é‡Šä¸è¶³æˆ–è€…è¿‡å¤š æ²¡æœ‰æ³¨é‡Šå°†ä½¿ä»£ç å¯è¯»æ€§å˜å·®ï¼Œç‰¹åˆ«æ˜¯å½“ä¸å¯é¿å…åœ°å‡ºç°äººå‘˜å˜åŠ¨ æ—¶ï¼Œç¨‹åºçš„å¯è¯»æ€§å°†å¤§å¹…ä¸‹é™ è€Œè¿‡å¤šçš„æ³¨é‡Šåˆä¼šä½¿å¾—å¼€å‘äººå‘˜å°†ç²¾åŠ›è¿‡å¤šåœ°èŠ±è´¹åœ¨é˜…è¯»æ³¨é‡Šä¸Šï¼Œäº¦è¿èƒŒåˆè¡·ã€‚ ç¼ºä¹å•å…ƒæµ‹è¯• sonarå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»Ÿè®¡å¹¶å±•ç¤ºå•å…ƒæµ‹è¯•è¦†ç›–ç‡ã€‚ ç³Ÿç³•çš„è®¾è®¡ é€šè¿‡sonarå¯ä»¥æ‰¾å‡ºå¾ªç¯ï¼Œå±•ç¤ºåŒ…ä¸åŒ…ã€ç±»ä¸ç±»ä¹‹é—´çš„ç›¸äº’ä¾èµ–å…³ç³»ï¼Œå¯ä»¥æ£€æµ‹è‡ªå®šä¹‰çš„æ¶æ„è§„åˆ™ é€šè¿‡sonarå¯ä»¥ç®¡ç†ç¬¬ä¸‰æ–¹çš„jaråŒ…ï¼Œå¯ä»¥åˆ©ç”¨LCOM4æ£€æµ‹å•ä¸ªä»»åŠ¡è§„åˆ™çš„åº”ç”¨æƒ…å†µï¼Œ æ£€æµ‹è€¦åˆã€‚  sonarqubeæ¶æ„ç®€ä»‹  CSæ¶æ„  sonarqube scanner sonarqube server   SonarQube Scanner æ‰«æä»ªåœ¨æœ¬åœ°æ‰§è¡Œä»£ç æ‰«æä»»åŠ¡ æ‰§è¡Œå®Œåï¼Œå°†åˆ†ææŠ¥å‘Šè¢«å‘é€åˆ°SonarQubeæœåŠ¡å™¨è¿›è¡Œå¤„ç† SonarQubeæœåŠ¡å™¨å¤„ç†å’Œå­˜å‚¨åˆ†ææŠ¥å‘Šå¯¼è‡´SonarQubeæ•°æ®åº“ï¼Œå¹¶æ˜¾ç¤ºç»“æœåœ¨UIä¸­  sonarqube on kubernetesç¯å¢ƒæ­å»º  èµ„æºæ–‡ä»¶å‡†å¤‡  sonar/sonar.yaml\n å’Œgitlabå…±äº«postgresæ•°æ®åº“ ä½¿ç”¨ingressåœ°å€ sonar.luffy.com è¿›è¡Œè®¿é—® ä½¿ç”¨initContainersè¿›è¡Œç³»ç»Ÿå‚æ•°è°ƒæ•´  apiVersion: v1 kind: Service metadata:  name: sonarqube  namespace: jenkins  labels:  app: sonarqube spec:  ports:  - name: sonarqube  port: 9000  targetPort: 9000  protocol: TCP  selector:  app: sonarqube --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: sonarqube  labels:  app: sonarqube spec:  replicas: 1  selector:  matchLabels:  app: sonarqube  template:  metadata:  labels:  app: sonarqube  spec:  nodeSelector:  sonar: \"true\"  initContainers:  - command:  - /sbin/sysctl  - -w  - vm.max_map_count=262144  image: alpine:3.6  imagePullPolicy: IfNotPresent  name: elasticsearch-logging-init  resources: {}  securityContext:  privileged: true  containers:  - name: sonarqube  image: 172.21.51.67:5000/sonarqube:7.9-community  ports:  - containerPort: 9000  env:  - name: SONARQUBE_JDBC_USERNAME  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.user.root  - name: SONARQUBE_JDBC_PASSWORD  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.pwd.root  - name: SONARQUBE_JDBC_URL  value: \"jdbc:postgresql://postgres:5432/sonar\"  livenessProbe:  httpGet:  path: /sessions/new  port: 9000  initialDelaySeconds: 60  periodSeconds: 30  readinessProbe:  httpGet:  path: /sessions/new  port: 9000  initialDelaySeconds: 60  periodSeconds: 30  failureThreshold: 6  resources:  limits:  cpu: 2000m  memory: 4096Mi  requests:  cpu: 300m  memory: 512Mi --- apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: sonarqube  namespace: jenkins spec:  rules:  - host: sonar.luffy.com  http:  paths:  - backend:  serviceName: sonarqube  servicePort: 9000  path: / status:  loadBalancer: {}  sonarqubeæœåŠ¡ç«¯å®‰è£…\n# åˆ›å»ºsonaræ•°æ®åº“ $ kubectl -n jenkins exec -ti postgres-5859dc6f58-mgqz9 bash #/ psql  # create database sonar;  ## åˆ›å»ºsonarqubeæœåŠ¡å™¨ $ kubectl create -f sonar.yaml  ## é…ç½®æœ¬åœ°hostsè§£æ 172.21.51.67 sonar.luffy.com  ## è®¿é—®sonarqubeï¼Œåˆå§‹ç”¨æˆ·åå¯†ç ä¸º admin/admin $ curl http://sonar.luffy.com   sonar-scannerçš„å®‰è£…\nä¸‹è½½åœ°å€ï¼š https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zipã€‚è¯¥åœ°å€æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥åœ¨ç½‘ç›˜ä¸‹è½½ï¼ˆhttps://pan.baidu.com/s/1SiEhWyHikTiKl5lEMX1tJg æå–ç : tqb9ï¼‰ã€‚\n  æ¼”ç¤ºsonarä»£ç æ‰«æåŠŸèƒ½\n  åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­å‡†å¤‡é…ç½®æ–‡ä»¶ sonar-project.properties\nsonar.projectKey=myblog sonar.projectName=myblog # if you want disabled the DTD verification for a proxy problem for example, true by default sonar.coverage.dtdVerification=false # JUnit like test report, default value is test.xml sonar.sources=blog,myblog   é…ç½®sonarqubeæœåŠ¡å™¨åœ°å€\nç”±äºsonar-scanneréœ€è¦å°†æ‰«æç»“æœä¸ŠæŠ¥ç»™sonarqubeæœåŠ¡å™¨åšè´¨é‡åˆ†æï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨sonar-scannerä¸­é…ç½®sonarqubeçš„æœåŠ¡å™¨åœ°å€ï¼š\nåœ¨é›†ç¾¤å®¿ä¸»æœºä¸­æµ‹è¯•ï¼Œå…ˆé…ç½®ä¸€ä¸‹hostsæ–‡ä»¶ï¼Œç„¶åé…ç½®sonarçš„åœ°å€ï¼š\n$ cat /etc/hosts 172.21.51.67 sonar.luffy.com  $ cat sonar-scanner/conf/sonar-scanner.properties #----- Default SonarQube server #sonar.host.url=http://localhost:9000 sonar.host.url=http://sonar.luffy.com #----- Default source code encoding #sonar.sourceEncoding=UTF-8      - ä¸ºäº†ä½¿æ‰€æœ‰çš„podéƒ½å¯ä»¥é€šè¿‡`sonar.luffy.com`è®¿é—®ï¼Œå¯ä»¥é…ç½®corednsçš„é™æ€è§£æ ```powershell hosts { 172.21.51.67 jenkins.luffy.com gitlab.luffy.com sonar.luffy.com fallthrough }   æ‰§è¡Œæ‰«æ\n## åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ $ /opt/sonar-scanner-4.0.0.1744-linux/bin/sonar-scanner -X   sonarqubeç•Œé¢æŸ¥çœ‹ç»“æœ\nç™»å½•sonarqubeç•Œé¢æŸ¥çœ‹ç»“æœï¼ŒQuality Gatesè¯´æ˜\n  æ’ä»¶å®‰è£…åŠé…ç½®   é›†æˆåˆ°toolså®¹å™¨ä¸­\nç”±äºæˆ‘ä»¬çš„ä»£ç æ‹‰å–ã€æ„å»ºä»»åŠ¡å‡æ˜¯åœ¨toolså®¹å™¨ä¸­è¿›è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠscanneré›†æˆåˆ°æˆ‘ä»¬çš„toolså®¹å™¨ä¸­ï¼Œåˆå› ä¸ºscanneræ˜¯ä¸€ä¸ªcliå®¢æˆ·ç«¯ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æŠŠåŒ…è§£å‹å¥½ï¼Œæ‹·è´åˆ°toolså®¹å™¨å†…éƒ¨ï¼Œé…ç½®ä¸€ä¸‹PATHè·¯å¾„å³å¯ï¼Œæ³¨æ„ä¸¤ç‚¹ï¼š\n  ç›´æ¥åœ¨åœ¨toolsé•œåƒä¸­é…ç½®http://sonar.luffy.com\n  ç”±äºtoolså·²ç»é›†æˆäº†javaç¯å¢ƒï¼Œå› æ­¤å¯ä»¥ç›´æ¥å‰”é™¤scannerè‡ªå¸¦çš„jre\n  åˆ æ‰sonar-scanner/jreç›®å½•\n  ä¿®æ”¹sonar-scanner/bin/sonar-scanner\nuse_embedded_jre=false\n    $ cd tools $ cp -r /opt/sonar-scanner-4.0.0.1744-linux/ sonar-scanner ## sonaré…ç½®ï¼Œç”±äºæˆ‘ä»¬æ˜¯åœ¨Podä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®ï¼šsonar.host.url=http://sonarqube:9000 $ cat sonar-scanner/conf/sonar-scanner.properties #----- Default SonarQube server sonar.host.url=http://sonar.luffy.com  #----- Default source code encoding #sonar.sourceEncoding=UTF-8  $ rm -rf sonar-scanner/jre $ vi sonar-scanner/bin/sonar-scanner ... use_embedded_jre=false ... Dockerfile\njenkins/custom-images/tools/Dockerfile2\nFROMalpineLABEL maintainer=\"inspur_lyx@hotmail.com\"USERrootRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \u0026\u0026 \\  apk update \u0026\u0026 \\  apk add --no-cache openrc docker git curl tar gcc g++ make \\  bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \\  libstdc++ harfbuzz nss freetype ttf-freefont \u0026\u0026 \\  mkdir -p /root/.kube \u0026\u0026 \\  usermod -a -G docker rootCOPY config /root/.kube/RUN rm -rf /var/cache/apk/*#-----------------å®‰è£… kubectl--------------------#COPY kubectl /usr/local/bin/RUN chmod +x /usr/local/bin/kubectl# ------------------------------------------------##---------------å®‰è£… sonar-scanner-----------------#COPY sonar-scanner /usr/lib/sonar-scannerRUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner \u0026\u0026 chmod +x /usr/local/bin/sonar-scannerENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner# ------------------------------------------------#  é‡æ–°æ„å»ºé•œåƒï¼Œå¹¶æ¨é€åˆ°ä»“åº“ï¼š\n $ docker build . -t 172.21.51.67:5000/devops/tools:v2  $ docker push 172.21.51.67:5000/devops/tools:v2   ä¿®æ”¹Jenkins PodTemplate\nä¸ºäº†åœ¨æ–°çš„æ„å»ºä»»åŠ¡ä¸­å¯ä»¥æ‹‰å–v2ç‰ˆæœ¬çš„toolsé•œåƒï¼Œéœ€è¦æ›´æ–°PodTemplate\n  å®‰è£…å¹¶é…ç½®sonaræ’ä»¶\nç”±äºsonarqubeçš„æ‰«æçš„ç»“æœéœ€è¦è¿›è¡ŒQuality Gatesçš„æ£€æµ‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å®¹å™¨ä¸­æ‰§è¡Œå®Œä»£ç æ‰«æä»»åŠ¡åï¼Œå¦‚ä½•çŸ¥é“æœ¬æ¬¡æ‰«ææ˜¯å¦é€šè¿‡äº†Quality Gatesï¼Œé‚£ä¹ˆå°±éœ€è¦å€ŸåŠ©äºsonarqubeå®ç°çš„jenkinsçš„æ’ä»¶ã€‚\n  å®‰è£…æ’ä»¶\næ’ä»¶ä¸­å¿ƒæœç´¢sonarqubeï¼Œç›´æ¥å®‰è£…\n  é…ç½®æ’ä»¶\nç³»ç»Ÿç®¡ç†-ç³»ç»Ÿé…ç½®- SonarQube servers -Add SonarQube\n  Nameï¼šsonarqube\n  Server URLï¼šhttp://sonar.luffy.com\n  Server authentication token\nâ‘  ç™»å½•sonarqube - My Account - Security - Generate Token\nâ‘¡ ç™»å½•Jenkinsï¼Œæ·»åŠ å…¨å±€å‡­æ®ï¼Œç±»å‹ä¸ºSecret text\n    å¦‚ä½•åœ¨jenkinsfileä¸­ä½¿ç”¨\næˆ‘ä»¬åœ¨ https://jenkins.io/doc/pipeline/steps/sonar/ å®˜æ–¹ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ°ï¼š\n    Jenkinsfileé›†æˆsonarqubeæ¼”ç¤º jenkins/pipelines/p9.yaml\npipeline {  agent { label 'jnlp-slave'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('git-log') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  container('tools') {  checkout scm  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  withSonarQubeEnv('sonarqube') {  sh 'sonar-scanner -X'  sleep 3  }  script {  timeout(1) {  def qg = waitForQualityGate('sonarqube')  if (qg.status != 'OK') {  error \"æœªé€šè¿‡Sonarqubeçš„ä»£ç è´¨é‡é˜ˆæ£€æŸ¥ï¼Œè¯·åŠæ—¶ä¿®æ”¹ï¼failure: ${qg.status}\"  }  }  }  }  }  }  }  }  stage('build-image') {  steps {  container('tools') {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  container('tools') {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  container('tools') {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„ \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜– \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } }   é›†æˆRobotFrameworkå®ç°éªŒæ”¶æµ‹è¯• ä¸€ä¸ªåŸºäºPythonè¯­è¨€ï¼Œç”¨äºéªŒæ”¶æµ‹è¯•å’ŒéªŒæ”¶æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆATDDï¼‰çš„é€šç”¨æµ‹è¯•è‡ªåŠ¨åŒ–æ¡†æ¶ï¼Œæä¾›äº†ä¸€å¥—ç‰¹å®šçš„è¯­æ³•ï¼Œå¹¶ä¸”æœ‰éå¸¸ä¸°å¯Œçš„æµ‹è¯•åº“ ã€‚\nrobotç”¨ä¾‹ç®€ä»‹ robot/robot.txt\n*** Settings *** Library RequestsLibrary Library SeleniumLibrary  *** Variables *** ${demo_url} http://myblog.luffy/admin  *** Test Cases *** api  [Tags] critical  Create Session api ${demo_url}  ${alarm_system_info} RequestsLibrary.Get Request api /  log ${alarm_system_info.status_code}  log ${alarm_system_info.content}  should be true ${alarm_system_info.status_code} == 200  ui  [Tags] critical  ${chrome_options} = Evaluate sys.modules['selenium.webdriver'].ChromeOptions() sys, selenium.webdriver  Call Method ${chrome_options} add_argument headless  Call Method ${chrome_options} add_argument no-sandbox  ${options}= Call Method ${chrome_options} to_capabilities  Open Browser ${demo_url}/ browser=chrome desired_capabilities=${options}  sleep 2s  Capture Page Screenshot  Page Should Contain Django  close browser # ä½¿ç”¨toolsé•œåƒå¯åŠ¨å®¹å™¨ï¼Œæ¥éªŒè¯æ‰‹åŠ¨ä½¿ç”¨robotframeworkæ¥åšéªŒæ”¶æµ‹è¯• $ docker run --rm -ti 172.21.51.67:5000/devops/tools:v2 bash bash-5.0# apk add chromium chromium-chromedriver $ cat requirements.txt robotframework robotframework-seleniumlibrary robotframework-databaselibrary robotframework-requests  #pipå®‰è£…å¿…è¦çš„è½¯ä»¶åŒ… $ pip install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt  #ä½¿ç”¨robotå‘½ä»¤åšæµ‹è¯• $ robot -d artifacts/ robot.txt ä¸toolså·¥å…·é•œåƒé›†æˆ FROM alpine LABEL maintainer=\"inspur_lyx@hotmail.com\" USER root  RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \u0026\u0026 \\  apk update \u0026\u0026 \\  apk add --no-cache openrc docker git curl tar gcc g++ make \\  bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \\  libstdc++ harfbuzz nss freetype ttf-freefont chromium chromium-chromedriver \u0026\u0026 \\  mkdir -p /root/.kube \u0026\u0026 \\  usermod -a -G docker root   COPY config /root/.kube/  COPY requirements.txt /  RUN pip install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt   RUN rm -rf /var/cache/apk/* \u0026\u0026 \\  rm -rf ~/.cache/pip  #-----------------å®‰è£… kubectl--------------------# COPY kubectl /usr/local/bin/ RUN chmod +x /usr/local/bin/kubectl # ------------------------------------------------#  #---------------å®‰è£… sonar-scanner-----------------# COPY sonar-scanner /usr/lib/sonar-scanner RUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner \u0026\u0026 chmod +x /usr/local/bin/sonar-scanner ENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner # ------------------------------------------------# $ docker build . -t 172.21.51.67:5000/devops/tools:v3  $ docker push 172.21.51.67:5000/devops/tools:v3 æ›´æ–°Jenkinsä¸­kubernetesä¸­çš„containers template\næ’ä»¶å®‰è£…åŠé…ç½® ä¸ºä»€ä¹ˆè¦å®‰è£…robotæ’ä»¶ï¼Ÿ\n  å®‰è£…robotFramework\n æ’ä»¶ä¸­å¿ƒæœç´¢robotframeworkï¼Œç›´æ¥å®‰è£… toolsé›†æˆrobotå‘½ä»¤ï¼ˆä¹‹å‰å·²ç»å®‰è£…ï¼‰    ä¸jenkinsfileçš„é›†æˆ\n container('tools') {  sh 'robot -i critical -d artifacts/ robot.txt || echo ok'  echo \"R ${currentBuild.result}\"  step([  $class : 'RobotPublisher',  outputPath: 'artifacts/',  outputFileName : \"output.xml\",  disableArchiveOutput : false,  passThreshold : 80,  unstableThreshold: 20.0,  onlyCritical : true,  otherFiles : \"*.png\"  ])  echo \"R ${currentBuild.result}\"  archiveArtifacts artifacts: 'artifacts/*', fingerprint: true  }   å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®çš„éªŒæ”¶æµ‹è¯• python-demoé¡¹ç›®æ·»åŠ robot.txtæ–‡ä»¶ï¼š\njenkins/pipelines/p10.yaml\npipeline {  agent { label 'jnlp-slave'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('git-log') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  container('tools') {  checkout scm  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  withSonarQubeEnv('sonarqube') {  sh 'sonar-scanner -X'  sleep 3  }  script {  timeout(1) {  def qg = waitForQualityGate('sonarqube')  if (qg.status != 'OK') {  error \"æœªé€šè¿‡Sonarqubeçš„ä»£ç è´¨é‡é˜ˆæ£€æŸ¥ï¼Œè¯·åŠæ—¶ä¿®æ”¹ï¼failure: ${qg.status}\"  }  }  }  }  }  }  }  }  stage('build-image') {  steps {  container('tools') {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  container('tools') {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  container('tools') {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/;sleep 20;\"  }  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"âˆš...\" + env.TAB_STR  }  }  }  stage('Accept Test') {  steps {  container('tools') {  sh 'robot -i critical -d artifacts/ robot.txt|| echo ok'  echo \"R ${currentBuild.result}\"  step([  $class : 'RobotPublisher',  outputPath: 'artifacts/',  outputFileName : \"output.xml\",  disableArchiveOutput : false,  passThreshold : 80,  unstableThreshold: 20.0,  onlyCritical : true,  otherFiles : \"*.png\"  ])  echo \"R ${currentBuild.result}\"  archiveArtifacts artifacts: 'artifacts/*', fingerprint: true  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„ \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜– \\n**é¡¹ç›®åç§°**ï¼šluffy \\n**Git log**: ${GIT_LOG} \\n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME} \\n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL} \\n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } åœ¨Jenkinsä¸­æŸ¥çœ‹robotçš„æ„å»ºç»“æœã€‚\n  å°ç»“ æ€è·¯ï¼š\n è®²è§£æœ€åŸºç¡€çš„Jenkinsçš„ä½¿ç”¨ Pipelineæµæ°´çº¿çš„ä½¿ç”¨ Jenkinsfileçš„ä½¿ç”¨ å¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨ ä¸Kubernetesé›†æˆï¼ŒåŠ¨æ€jnlp slave podçš„ä½¿ç”¨ ä¸sonarqubeé›†æˆï¼Œå®ç°ä»£ç æ‰«æ ä¸Robotframeworké›†æˆï¼Œå®ç°éªŒæ”¶æµ‹è¯•  é—®é¢˜ï¼š\n Jenkinsfileè¿‡äºå†—é•¿ å¤šä¸ªé¡¹ç›®é…ç½®Jenkinsfileï¼Œå­˜åœ¨å¾ˆå¤šé‡å¤å†…å®¹ æ²¡æœ‰å®ç°æ ¹æ®ä¸åŒåˆ†æ”¯æ¥éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒ Javaé¡¹ç›®çš„æ„å»º k8séƒ¨ç½²åï¼Œé‡‡ç”¨ç­‰å¾…çš„æ–¹å¼æ‰§è¡Œåç»­æ­¥éª¤ï¼Œä¸åˆç†  ",
  "wordCount" : "5025",
  "inLanguage": "zh",
  "datePublished": "2022-01-07T14:26:43Z",
  "dateModified": "2022-01-07T14:26:43Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      ä»é›¶å¼€å§‹æ„å»ºåŸºäºKubernetesçš„Devopså¹³å°
    </h1>
    <div class="post-meta"><span title='2022-01-07 14:26:43 +0000 UTC'>2022-01-07</span>&nbsp;Â·&nbsp;24 åˆ†é’Ÿ

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%9f%ba%e4%ba%8ekubernetes%e7%9a%84devops%e5%b9%b3%e5%8f%b0%e5%ae%9e%e8%b7%b5" aria-label="åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ">åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ</a><ul>
                            
                    <li>
                        <a href="#devopscicd%e4%bb%8b%e7%bb%8d" aria-label="DevOpsã€CIã€CDä»‹ç»">DevOpsã€CIã€CDä»‹ç»</a><ul>
                            
                    <li>
                        <a href="#%e7%80%91%e5%b8%83%e5%bc%8f%e6%b5%81%e7%a8%8b" aria-label="ç€‘å¸ƒå¼æµç¨‹">ç€‘å¸ƒå¼æµç¨‹</a></li>
                    <li>
                        <a href="#%e6%95%8f%e6%8d%b7%e5%bc%80%e5%8f%91" aria-label="æ•æ·å¼€å‘">æ•æ·å¼€å‘</a></li>
                    <li>
                        <a href="#devops" aria-label="DevOps">DevOps</a></li></ul>
                    </li>
                    <li>
                        <a href="#jenkins%e5%88%9d%e4%bd%93%e9%aa%8c" aria-label="Jenkinsåˆä½“éªŒ">Jenkinsåˆä½“éªŒ</a><ul>
                            
                    <li>
                        <a href="#kubernetes%e7%8e%af%e5%a2%83%e4%b8%ad%e9%83%a8%e7%bd%b2jenkins" aria-label="Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins">Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85%e6%b1%89%e5%8c%96%e6%8f%92%e4%bb%b6" aria-label="å®‰è£…æ±‰åŒ–æ’ä»¶">å®‰è£…æ±‰åŒ–æ’ä»¶</a></li>
                    <li>
                        <a href="#jenkins%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%bc%94%e7%a4%ba" aria-label="JenkinsåŸºæœ¬ä½¿ç”¨æ¼”ç¤º">JenkinsåŸºæœ¬ä½¿ç”¨æ¼”ç¤º</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e7%9b%ae%e6%a0%87" aria-label="æ¼”ç¤ºç›®æ ‡">æ¼”ç¤ºç›®æ ‡</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e5%87%86%e5%a4%87" aria-label="æ¼”ç¤ºå‡†å¤‡">æ¼”ç¤ºå‡†å¤‡</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e8%bf%87%e7%a8%8b" aria-label="æ¼”ç¤ºè¿‡ç¨‹">æ¼”ç¤ºè¿‡ç¨‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#master-slavesagent%e6%a8%a1%e5%bc%8f" aria-label="Master-Slavesï¼ˆagentï¼‰æ¨¡å¼">Master-Slavesï¼ˆagentï¼‰æ¨¡å¼</a></li>
                    <li>
                        <a href="#jenkins%e5%ae%9a%e5%88%b6%e5%8c%96%e5%ae%b9%e5%99%a8" aria-label="Jenkinså®šåˆ¶åŒ–å®¹å™¨">Jenkinså®šåˆ¶åŒ–å®¹å™¨</a></li>
                    <li>
                        <a href="#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93" aria-label="æœ¬ç« å°ç»“">æœ¬ç« å°ç»“</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8" aria-label="æµæ°´çº¿å…¥é—¨">æµæ°´çº¿å…¥é—¨</a><ul>
                            
                    <li>
                        <a href="#%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%9f%ba%e7%a1%80%e8%af%ad%e6%b3%95" aria-label="æµæ°´çº¿åŸºç¡€è¯­æ³•">æµæ°´çº¿åŸºç¡€è¯­æ³•</a><ul>
                            
                    <li>
                        <a href="#%e8%84%9a%e6%9c%ac%e7%a4%ba%e4%be%8b" aria-label="è„šæœ¬ç¤ºä¾‹">è„šæœ¬ç¤ºä¾‹</a></li>
                    <li>
                        <a href="#%e8%84%9a%e6%9c%ac%e8%a7%a3%e9%87%8a" aria-label="è„šæœ¬è§£é‡Šï¼š">è„šæœ¬è§£é‡Šï¼š</a></li>
                    <li>
                        <a href="#blue-ocean" aria-label="Blue Ocean:">Blue Ocean:</a></li></ul>
                    </li>
                    <li>
                        <a href="#jenkinsflie" aria-label="Jenkinsflie">Jenkinsflie</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba1%e4%bd%bf%e7%94%a8jenkinsfile%e7%ae%a1%e7%90%86pipeline" aria-label="æ¼”ç¤º1ï¼šä½¿ç”¨Jenkinsfileç®¡ç†pipeline">æ¼”ç¤º1ï¼šä½¿ç”¨Jenkinsfileç®¡ç†<strong>pipeline</strong></a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba2%e4%bc%98%e5%8c%96%e5%8f%8a%e4%b8%b0%e5%af%8c%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%86%85%e5%ae%b9" aria-label="æ¼”ç¤º2ï¼šä¼˜åŒ–åŠä¸°å¯Œæµæ°´çº¿å†…å®¹">æ¼”ç¤º2ï¼šä¼˜åŒ–åŠä¸°å¯Œæµæ°´çº¿å†…å®¹</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba3%e4%bd%bf%e7%94%a8k8s%e9%83%a8%e7%bd%b2%e6%9c%8d%e5%8a%a1" aria-label="æ¼”ç¤º3ï¼šä½¿ç”¨k8séƒ¨ç½²æœåŠ¡">æ¼”ç¤º3ï¼šä½¿ç”¨k8séƒ¨ç½²æœåŠ¡</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba4%e4%bd%bf%e7%94%a8%e5%87%ad%e6%8d%ae%e7%ae%a1%e7%90%86%e6%95%8f%e6%84%9f%e4%bf%a1%e6%81%af" aria-label="æ¼”ç¤º4ï¼šä½¿ç”¨å‡­æ®ç®¡ç†æ•æ„Ÿä¿¡æ¯">æ¼”ç¤º4ï¼šä½¿ç”¨å‡­æ®ç®¡ç†æ•æ„Ÿä¿¡æ¯</a></li>
                    <li>
                        <a href="#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1" aria-label="æœ¬ç« å°ç»“">æœ¬ç« å°ç»“</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%a4%9a%e5%88%86%e6%94%af%e6%b5%81%e6%b0%b4%e7%ba%bf" aria-label="å¤šåˆ†æ”¯æµæ°´çº¿">å¤šåˆ†æ”¯æµæ°´çº¿</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba1%e5%a4%9a%e5%88%86%e6%94%af%e6%b5%81%e6%b0%b4%e7%ba%bf%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="æ¼”ç¤º1ï¼šå¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨">æ¼”ç¤º1ï¼šå¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba2%e7%be%8e%e5%8c%96%e6%b6%88%e6%81%af%e9%80%9a%e7%9f%a5%e5%86%85%e5%ae%b9" aria-label="æ¼”ç¤º2ï¼šç¾åŒ–æ¶ˆæ¯é€šçŸ¥å†…å®¹">æ¼”ç¤º2ï¼šç¾åŒ–æ¶ˆæ¯é€šçŸ¥å†…å®¹</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba3%e9%80%9a%e7%9f%a5gitlab%e6%9e%84%e5%bb%ba%e7%8a%b6%e6%80%81" aria-label="æ¼”ç¤º3ï¼šé€šçŸ¥gitlabæ„å»ºçŠ¶æ€">æ¼”ç¤º3ï¼šé€šçŸ¥gitlabæ„å»ºçŠ¶æ€</a></li>
                    <li>
                        <a href="#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e8%8a%82" aria-label="æœ¬ç« å°èŠ‚">æœ¬ç« å°èŠ‚</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b7%a5%e5%85%b7%e9%9b%86%e6%88%90%e4%b8%8ejenkinsfile%e5%ae%9e%e8%b7%b5%e7%af%87" aria-label="å·¥å…·é›†æˆä¸Jenkinsfileå®è·µç¯‡">å·¥å…·é›†æˆä¸Jenkinsfileå®è·µç¯‡</a><ul>
                            
                    <li>
                        <a href="#%e9%9b%86%e6%88%90kubernetes" aria-label="é›†æˆKubernetes">é›†æˆKubernetes</a><ul>
                            
                    <li>
                        <a href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae" aria-label="æ’ä»¶å®‰è£…åŠé…ç½®">æ’ä»¶å®‰è£…åŠé…ç½®</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e5%8a%a8%e6%80%81slave-pod" aria-label="æ¼”ç¤ºåŠ¨æ€slave pod">æ¼”ç¤ºåŠ¨æ€slave pod</a></li>
                    <li>
                        <a href="#pod-template%e4%b8%ad%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e7%9a%84%e5%88%b6%e4%bd%9c" aria-label="Pod-Templateä¸­å®¹å™¨é•œåƒçš„åˆ¶ä½œ">Pod-Templateä¸­å®¹å™¨é•œåƒçš„åˆ¶ä½œ</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5%e9%80%9a%e8%bf%87jenkinsfile%e5%ae%9e%e7%8e%b0demo%e9%a1%b9%e7%9b%ae%e8%87%aa%e5%8a%a8%e5%8f%91%e5%b8%83%e5%88%b0kubenetes%e7%8e%af%e5%a2%83" aria-label="å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®è‡ªåŠ¨å‘å¸ƒåˆ°kubenetesç¯å¢ƒ">å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®è‡ªåŠ¨å‘å¸ƒåˆ°kubenetesç¯å¢ƒ</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%9b%86%e6%88%90sonarqube%e5%ae%9e%e7%8e%b0%e4%bb%a3%e7%a0%81%e6%89%ab%e6%8f%8f" aria-label="é›†æˆsonarQubeå®ç°ä»£ç æ‰«æ">é›†æˆsonarQubeå®ç°ä»£ç æ‰«æ</a><ul>
                            
                    <li>
                        <a href="#sonarqube%e6%9e%b6%e6%9e%84%e7%ae%80%e4%bb%8b" aria-label="sonarqubeæ¶æ„ç®€ä»‹">sonarqubeæ¶æ„ç®€ä»‹</a></li>
                    <li>
                        <a href="#sonarqube-on-kubernetes%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="sonarqube on kubernetesç¯å¢ƒæ­å»º">sonarqube on kubernetesç¯å¢ƒæ­å»º</a></li>
                    <li>
                        <a href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae-1" aria-label="æ’ä»¶å®‰è£…åŠé…ç½®">æ’ä»¶å®‰è£…åŠé…ç½®</a></li>
                    <li>
                        <a href="#jenkinsfile%e9%9b%86%e6%88%90sonarqube%e6%bc%94%e7%a4%ba" aria-label="Jenkinsfileé›†æˆsonarqubeæ¼”ç¤º">Jenkinsfileé›†æˆsonarqubeæ¼”ç¤º</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%9b%86%e6%88%90robotframework%e5%ae%9e%e7%8e%b0%e9%aa%8c%e6%94%b6%e6%b5%8b%e8%af%95" aria-label="é›†æˆRobotFrameworkå®ç°éªŒæ”¶æµ‹è¯•">é›†æˆRobotFrameworkå®ç°éªŒæ”¶æµ‹è¯•</a><ul>
                            
                    <li>
                        <a href="#robot%e7%94%a8%e4%be%8b%e7%ae%80%e4%bb%8b" aria-label="robotç”¨ä¾‹ç®€ä»‹">robotç”¨ä¾‹ç®€ä»‹</a></li>
                    <li>
                        <a href="#%e4%b8%8etools%e5%b7%a5%e5%85%b7%e9%95%9c%e5%83%8f%e9%9b%86%e6%88%90" aria-label="ä¸toolså·¥å…·é•œåƒé›†æˆ">ä¸toolså·¥å…·é•œåƒé›†æˆ</a></li>
                    <li>
                        <a href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae-2" aria-label="æ’ä»¶å®‰è£…åŠé…ç½®">æ’ä»¶å®‰è£…åŠé…ç½®</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5%e9%80%9a%e8%bf%87jenkinsfile%e5%ae%9e%e7%8e%b0demo%e9%a1%b9%e7%9b%ae%e7%9a%84%e9%aa%8c%e6%94%b6%e6%b5%8b%e8%af%95" aria-label="å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®çš„éªŒæ”¶æµ‹è¯•">å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®çš„éªŒæ”¶æµ‹è¯•</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="å°ç»“">å°ç»“</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="åŸºäºkubernetesçš„devopså¹³å°å®è·µ">åŸºäºKubernetesçš„DevOpså¹³å°å®è·µ<a hidden class="anchor" aria-hidden="true" href="#åŸºäºkubernetesçš„devopså¹³å°å®è·µ">#</a></h3>
<p>æŒç»­é›†æˆå·¥å…·ï¼š</p>
<ul>
<li>Jenkins</li>
<li>gitlabci</li>
<li>Tekton</li>
</ul>
<p>æœ¬ç« åŸºäºk8sé›†ç¾¤éƒ¨ç½²gitlabã€sonarQubeã€Jenkinsç­‰å·¥å…·ï¼Œå¹¶æŠŠä¸Šè¿°å·¥å…·é›†æˆåˆ°Jenkinsä¸­ï¼Œä»¥Djangoé¡¹ç›®å’ŒSpringBooté¡¹ç›®ä¸ºä¾‹ï¼Œé€šè¿‡å¤šåˆ†æ”¯æµæ°´çº¿åŠJenkinsfileå®ç°é¡¹ç›®ä»£ç æäº¤åˆ°ä¸åŒçš„ä»“åº“åˆ†æ”¯ï¼Œå®ç°è‡ªåŠ¨ä»£ç æ‰«æã€å•å…ƒæµ‹è¯•ã€dockerå®¹å™¨æ„å»ºã€k8sæœåŠ¡çš„è‡ªåŠ¨éƒ¨ç½²ã€‚</p>
<ul>
<li>DevOpsã€CIã€CDä»‹ç»</li>
<li>Jenkinsã€sonarQubeã€gitlabçš„å¿«é€Ÿéƒ¨ç½²</li>
<li>Jenkinsåˆä½“éªŒ</li>
<li>æµæ°´çº¿å…¥é—¨åŠJenkinsfileä½¿ç”¨</li>
<li>Jenkinsä¸Kubernetesçš„é›†æˆ</li>
<li>sonarQubeä»£ç æ‰«æä¸Jenkinsçš„é›†æˆ</li>
<li>å®è·µDjangoé¡¹ç›®çš„åŸºäºJenkinsfileå®ç°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒçš„CI/CD</li>
</ul>
<h4 id="devopscicdä»‹ç»">DevOpsã€CIã€CDä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#devopscicdä»‹ç»">#</a></h4>
<p>Continuous Integration (<em>CI</em>) / Continuous Delivery (<em>CD</em>)</p>
<p>è½¯ä»¶äº¤ä»˜æµç¨‹</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-roles.jpg" alt=""  />
</p>
<p>ä¸€ä¸ªè½¯ä»¶ä»é›¶å¼€å§‹åˆ°æœ€ç»ˆäº¤ä»˜ï¼Œå¤§æ¦‚åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼šè§„åˆ’ã€ç¼–ç ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€éƒ¨ç½²å’Œç»´æŠ¤ï¼ŒåŸºäºè¿™äº›é˜¶æ®µï¼Œæˆ‘ä»¬çš„è½¯ä»¶äº¤ä»˜æ¨¡å‹å¤§è‡´ç»å†äº†å‡ ä¸ªé˜¶æ®µï¼š</p>
<h5 id="ç€‘å¸ƒå¼æµç¨‹">ç€‘å¸ƒå¼æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#ç€‘å¸ƒå¼æµç¨‹">#</a></h5>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-waterfall.jpg" alt=""  />
</p>
<p>å‰æœŸéœ€æ±‚ç¡®ç«‹ä¹‹åï¼Œè½¯ä»¶å¼€å‘äººå‘˜èŠ±è´¹æ•°å‘¨å’Œæ•°æœˆç¼–å†™ä»£ç ï¼ŒæŠŠæ‰€æœ‰éœ€æ±‚ä¸€æ¬¡æ€§å¼€å‘å®Œï¼Œç„¶åå°†ä»£ç äº¤ç»™QAï¼ˆè´¨é‡ä¿éšœï¼‰å›¢é˜Ÿè¿›è¡Œæµ‹è¯•ï¼Œç„¶åå°†æœ€ç»ˆçš„å‘å¸ƒç‰ˆäº¤ç»™è¿ç»´å›¢é˜Ÿå»éƒ¨ç½²ã€‚ç€‘å¸ƒæ¨¡å‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç­‰ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰å·¥ä½œå®Œæˆä¹‹åï¼Œå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚è¿™ç§æ¨¡å¼çš„é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œäº§å“è¿­ä»£å‘¨æœŸé•¿ï¼Œçµæ´»æ€§å·®ã€‚ä¸€ä¸ªå‘¨æœŸåŠ¨è¾„å‡ å‘¨å‡ ä¸ªæœˆï¼Œé€‚åº”ä¸äº†å½“ä¸‹äº§å“éœ€è¦å¿«é€Ÿè¿­ä»£çš„åœºæ™¯ã€‚</p>
<h5 id="æ•æ·å¼€å‘">æ•æ·å¼€å‘<a hidden class="anchor" aria-hidden="true" href="#æ•æ·å¼€å‘">#</a></h5>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-agile.jpg" alt=""  />
</p>
<p>ä»»åŠ¡ç”±å¤§æ‹†å°ï¼Œå¼€å‘ã€æµ‹è¯•ååŒå·¥ä½œï¼Œæ³¨é‡å¼€å‘æ•æ·ï¼Œä¸é‡è§†äº¤ä»˜æ•æ·</p>
<h5 id="devops">DevOps<a hidden class="anchor" aria-hidden="true" href="#devops">#</a></h5>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-compire.jpg" alt=""  />
</p>
<p>å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œ, æŒç»­å¼€å‘+æŒç»­äº¤ä»˜ã€‚</p>
<p>æˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¤ä¸ºDevOps = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Ÿ</p>
<p>å¤§å®¶æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ€åˆçš„å¼€å‘æ¨¡å¼æ²¡æœ‰ç›´æ¥è¿›å…¥DevOpsçš„æ—¶ä»£ï¼Ÿ</p>
<p>åŸå› æ˜¯ï¼šæ²Ÿé€šæˆæœ¬ã€‚</p>
<p>å„è§’è‰²äººå‘˜å»æ²Ÿé€šåä½œçš„æ—¶å€™éƒ½æ˜¯æ‰‹åŠ¨å»åšï¼Œäº¤æµé å˜´ï¼Œé äººå»æŒ‡æŒ¥ï¼Œå¾ˆæ˜¾ç„¶ä¼šå‡ºå¤§é—®é¢˜ã€‚æ‰€ä»¥è¯´ä¸èƒ½è®¤ä¸ºDevOpså°±æ˜¯ä¸€ç§äº¤ä»˜æ¨¡å¼ï¼Œå› ä¸ºè§£å†³ä¸äº†æ²Ÿé€šåä½œæˆæœ¬ï¼Œè¿™ç§æ¨¡å¼å°±ä¸å…·å¤‡å¯è½åœ°æ€§ã€‚</p>
<p>é‚£DevOpsæ—¶ä»£å¦‚ä½•è§£å†³è§’è‰²ä¹‹é—´çš„æˆæœ¬é—®é¢˜ï¼ŸDevOpsçš„æ ¸å¿ƒå°±æ˜¯è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–çš„èƒ½åŠ›é ä»€ä¹ˆæ¥æ”¯æ’‘ï¼Œå·¥å…·å’ŒæŠ€æœ¯ã€‚</p>
<p>DevOpså·¥å…·é“¾</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-tools.jpg" alt=""  />
</p>
<p>é è¿™äº›å·¥å…·å’ŒæŠ€æœ¯ï¼Œæ‰å®ç°äº†è‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¿›è€Œè§£å†³äº†åä½œæˆæœ¬ï¼Œä½¿å¾—devopså…·å¤‡äº†å¯è½åœ°æ€§ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¤§è‡´ç»™devopsä¸€ä¸ªå®šä¹‰ï¼š</p>
<p>devops = æå€¡å¼€å‘ã€æµ‹è¯•ã€è¿ç»´ååŒå·¥ä½œæ¥å®ç°æŒç»­å¼€å‘ã€æŒç»­äº¤ä»˜çš„ä¸€ç§è½¯ä»¶äº¤ä»˜æ¨¡å¼ + åŸºäºå·¥å…·å’ŒæŠ€æœ¯æ”¯æ’‘çš„è‡ªåŠ¨åŒ–æµç¨‹çš„è½åœ°å®è·µã€‚</p>
<p>å› æ­¤devopsä¸æ˜¯æŸä¸€ä¸ªå…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³+è‡ªåŠ¨åŒ–èƒ½åŠ›ï¼Œæ¥ä½¿å¾—æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒè½¯ä»¶èƒ½å¤Ÿæ›´åŠ åœ°ä¾¿æ·ã€é¢‘ç¹å’Œå¯é çš„è½åœ°å®è·µã€‚æœ¬æ¬¡è¯¾ç¨‹æ ¸å¿ƒå†…å®¹å°±æ˜¯è¦æ•™ä¼šå¤§å®¶å¦‚ä½•åˆ©ç”¨å·¥å…·å’ŒæŠ€æœ¯æ¥å®ç°å®Œæ•´çš„DevOpså¹³å°çš„å»ºè®¾ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š</p>
<ol>
<li>gitlabï¼Œä»£ç ä»“åº“ï¼Œä¼ä¸šå†…éƒ¨ä½¿ç”¨æœ€å¤šçš„ä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·ã€‚</li>
<li>Jenkinsï¼Œ ä¸€ä¸ªå¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å„ç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è½¯ä»¶ã€‚</li>
<li>robotFrameworkï¼Œ åŸºäºPythonçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶</li>
<li>sonarqubeï¼Œä»£ç è´¨é‡ç®¡ç†å¹³å°</li>
<li>mavenï¼ŒjavaåŒ…æ„å»ºç®¡ç†å·¥å…·</li>
<li>Kubernetes</li>
<li>Docker</li>
</ol>
<h4 id="jenkinsåˆä½“éªŒ">Jenkinsåˆä½“éªŒ<a hidden class="anchor" aria-hidden="true" href="#jenkinsåˆä½“éªŒ">#</a></h4>
<h5 id="kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins">Kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins<a hidden class="anchor" aria-hidden="true" href="#kubernetesç¯å¢ƒä¸­éƒ¨ç½²jenkins">#</a></h5>
<p><a href="https://jenkins.io/zh/doc/book/installing/">å…¶ä»–éƒ¨ç½²æ–¹å¼</a></p>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ¬¡å¯åŠ¨å¾ˆæ…¢</li>
<li>å› ä¸ºåé¢Jenkinsä¼šä¸kubernetesé›†ç¾¤è¿›è¡Œé›†æˆï¼Œä¼šéœ€è¦è°ƒç”¨kubernetesé›†ç¾¤çš„apiï¼Œå› æ­¤å®‰è£…çš„æ—¶å€™åˆ›å»ºäº†ServiceAccountå¹¶èµ‹äºˆäº†cluster-adminçš„æƒé™</li>
<li>é»˜è®¤éƒ¨ç½²åˆ°jenkins=trueçš„èŠ‚ç‚¹</li>
<li>åˆå§‹åŒ–å®¹å™¨æ¥è®¾ç½®æƒé™</li>
<li>ingressæ¥å¤–éƒ¨è®¿é—®</li>
<li>æ•°æ®å­˜å‚¨é€šè¿‡hostpathæŒ‚è½½åˆ°å®¿ä¸»æœºä¸­</li>
</ol>
<p><code>jenkins/jenkins-all.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins-crb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">devops</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">devops</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">jenkins</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccount</span>: <span style="color:#ae81ff">jenkins</span> <span style="color:#75715e">#Pod éœ€è¦ä½¿ç”¨çš„æœåŠ¡è´¦å·</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fix-permissions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;chown -R 1000:1000 /var/jenkins_home&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkinshome</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/jenkins_home</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">jenkinsci/blueocean:1.23.2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span> <span style="color:#75715e">#Jenkins Master Web æœåŠ¡ç«¯å£</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slavelistener</span> <span style="color:#75715e">#Jenkins Master ä¾›æœªæ¥ Slave è¿æ¥çš„ç«¯å£</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkinshome</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/jenkins_home</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xms4096m -Xmx5120m -Duser.timezone=Asia/Shanghai -Dhudson.model.DirectoryBrowserSupport.CSP=&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkinshome</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/jenkins_home/</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slavelistener</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">devops</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins-web</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">jenkins.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span></code></pre></div><p>åˆ›å»ºæœåŠ¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## ä¸ºk8s-slave1æ‰“æ ‡ç­¾ï¼Œå°†jenkins-masteréƒ¨ç½²åœ¨k8s-slave1èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave1 jenkins=true
</span></span><span style="display:flex;"><span><span style="color:#75715e">## éƒ¨ç½²æœåŠ¡</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> jenkins-all.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## æŸ¥çœ‹æœåŠ¡</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins get po
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>jenkins-master-767df9b574-lgdr5   1/1     Running   0          20s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æ—¥å¿—ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨æç¤ºéœ€è¦å®Œæˆåˆå§‹åŒ–è®¾ç½®</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins logs <span style="color:#f92672">-f</span> jenkins-master-767df9b574-lgdr5
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>*************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Jenkins initial setup is required. An admin user has been created and a password generated.
</span></span><span style="display:flex;"><span>Please use the following password to proceed to installation<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>5396b4e1c395450f8360efd8ee641b18
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This may also be found at<span style="color:#960050;background-color:#1e0010">:</span> /var/jenkins_home/secrets/initialAdminPassword
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*************************************************************
</span></span></code></pre></div><p>è®¿é—®æœåŠ¡ï¼š</p>
<p>é…ç½®hostsè§£æï¼Œ<code>172.21.51.67 jenkins.luffy.com</code>ï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨åŸŸåè®¿é—®æœåŠ¡ã€‚ç¬¬ä¸€æ¬¡è®¿é—®éœ€è¦å¤§æ¦‚å‡ åˆ†é’Ÿçš„åˆå§‹åŒ–æ—¶é—´ã€‚</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins_setup.jpg" alt=""  />
</p>
<p>ä½¿ç”¨jenkinså¯åŠ¨æ—¥å¿—ä¸­çš„å¯†ç ï¼Œæˆ–è€…æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è·å–è§£é”çš„ç®¡ç†å‘˜å¯†ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n jenkins exec jenkins-master-767df9b574-lgdr5 bash 
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># cat /var/jenkins_home/secrets/initialAdminPassword</span>
</span></span><span style="display:flex;"><span>35b083de1d25409eaef57255e0da481a
</span></span></code></pre></div><p>ç‚¹å‡»å‰å·ï¼Œè·³è¿‡é€‰æ‹©å®‰è£…æ¨èçš„æ’ä»¶ç¯èŠ‚ï¼Œç›´æ¥è¿›å…¥Jenkinsã€‚ç”±äºé»˜è®¤çš„æ’ä»¶åœ°å€å®‰è£…éå¸¸æ…¢ï¼Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢æˆå›½å†…æ¸…åçš„æºï¼Œè¿›å…¥ jenkins å·¥ä½œç›®å½•ï¼Œç›®å½•ä¸‹é¢æœ‰ä¸€ä¸ª <code>updates</code> çš„ç›®å½•ï¼Œä¸‹é¢æœ‰ä¸€ä¸ª <code>default.json</code> æ–‡ä»¶ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ›¿æ¢æ’ä»¶åœ°å€ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cd /var/jenkins_home/updates
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#39;</span> <span style="color:#66d9ef">default</span>.json 
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#39;</span> <span style="color:#66d9ef">default</span>.json
</span></span></code></pre></div><blockquote>
<p>æš‚æ—¶å…ˆä¸ç”¨é‡æ–°å¯åŠ¨podï¼Œæ±‰åŒ–åä¸€èµ·é‡å¯ã€‚</p>
</blockquote>
<p>é€‰æ‹©å³ä¸Šè§’admin-&gt;configure-&gt;passwordé‡æ–°è®¾ç½®ç®¡ç†å‘˜å¯†ç ï¼Œè®¾ç½®å®Œåï¼Œä¼šé€€å‡ºè¦æ±‚é‡æ–°ç™»å½•ï¼Œä½¿ç”¨admin/xxxxxx(æ–°å¯†ç )ï¼Œç™»å½•å³å¯ã€‚</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-mainpage.jpg" alt=""  />
</p>
<h5 id="å®‰è£…æ±‰åŒ–æ’ä»¶">å®‰è£…æ±‰åŒ–æ’ä»¶<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…æ±‰åŒ–æ’ä»¶">#</a></h5>
<p>Jenkins -&gt; manage Jenkins -&gt; Plugin Manager -&gt; Avaliableï¼Œæœç´¢ <code>chinese</code>å…³é”®å­—</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-install-plugins.jpg" alt=""  />
</p>
<p>é€‰ä¸­åï¼Œé€‰æ‹©[Install without restart]ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆï¼Œç„¶åç‚¹å‡»[ Restart Jenkins when installation is complete and no jobs are running ]ï¼Œè®©Jenkinsè‡ªåŠ¨é‡å¯</p>
<p>å¯åŠ¨åï¼Œç•Œé¢é»˜è®¤å˜æˆä¸­æ–‡ã€‚</p>
<h5 id="jenkinsåŸºæœ¬ä½¿ç”¨æ¼”ç¤º">JenkinsåŸºæœ¬ä½¿ç”¨æ¼”ç¤º<a hidden class="anchor" aria-hidden="true" href="#jenkinsåŸºæœ¬ä½¿ç”¨æ¼”ç¤º">#</a></h5>
<h6 id="æ¼”ç¤ºç›®æ ‡">æ¼”ç¤ºç›®æ ‡<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤ºç›®æ ‡">#</a></h6>
<ul>
<li>ä»£ç æäº¤gitlabï¼Œè‡ªåŠ¨è§¦å‘Jenkinsä»»åŠ¡</li>
<li>Jenkinsä»»åŠ¡å®Œæˆåå‘é€é’‰é’‰æ¶ˆæ¯é€šçŸ¥</li>
</ul>
<h6 id="æ¼”ç¤ºå‡†å¤‡">æ¼”ç¤ºå‡†å¤‡<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤ºå‡†å¤‡">#</a></h6>
<p><em>gitlabä»£ç ä»“åº“æ­å»º</em></p>
<p><a href="https://github.com/sameersbn/docker-gitlab">https://github.com/sameersbn/docker-gitlab</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## å…¨é‡éƒ¨ç½²çš„ç»„ä»¶</span>
</span></span><span style="display:flex;"><span>$ gitlab-ctl status
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> alertmanager<span style="color:#960050;background-color:#1e0010">:</span> (pid 1987) 27s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1986) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> gitaly<span style="color:#960050;background-color:#1e0010">:</span> (pid 1950) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1949) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> gitlab-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1985) 27s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1984) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> gitlab-workhorse<span style="color:#960050;background-color:#1e0010">:</span> (pid 1956) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1955) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> logrotate<span style="color:#960050;background-color:#1e0010">:</span> (pid 1960) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1959) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> nginx<span style="color:#960050;background-color:#1e0010">:</span> (pid 2439) 1s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1990) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> node-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1963) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1962) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> postgres-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1989) 27s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1988) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> postgresql<span style="color:#960050;background-color:#1e0010">:</span> (pid 1945) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1944) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> prometheus<span style="color:#960050;background-color:#1e0010">:</span> (pid 1973) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1972) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> puma<span style="color:#960050;background-color:#1e0010">:</span> (pid 1968) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1966) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> redis<span style="color:#960050;background-color:#1e0010">:</span> (pid 1952) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1951) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> redis-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1971) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1964) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> sidekiq<span style="color:#960050;background-color:#1e0010">:</span> (pid 1969) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1967) 28s
</span></span></code></pre></div><p>éƒ¨ç½²åˆ†æï¼š</p>
<ol>
<li>ä¾èµ–postgres</li>
<li>ä¾èµ–redis</li>
</ol>
<p>ä½¿ç”¨k8séƒ¨ç½²ï¼š</p>
<ol>
<li>
<p>å‡†å¤‡secretæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat gitlab-secret.txt
</span></span><span style="display:flex;"><span>postgres.user.root=root
</span></span><span style="display:flex;"><span>postgres.pwd.root=1qaz2wsx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins create secret generic gitlab-secret --from-env<span style="color:#f92672">-file</span>=gitlab-secret.txt
</span></span></code></pre></div></li>
<li>
<p>éƒ¨ç½²postgres</p>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨secretæ¥å¼•ç”¨è´¦æˆ·å¯†ç </li>
<li>ä½¿ç”¨postgres=trueæ¥æŒ‡å®šèŠ‚ç‚¹</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat postgres.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> server
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 5432
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 5432
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      nodeSelector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        postgres<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      tolerations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - operator<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span>  172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/postgres<span style="color:#960050;background-color:#1e0010">:</span>11.4 <span style="color:#75715e">#è‹¥æœ¬åœ°æ²¡æœ‰å¯åŠ¨è¯¥ä»“åº“ï¼Œæ¢æˆpostgres:11.4</span>
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 5432
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> POSTGRES_USER           <span style="color:#75715e">#PostgreSQL ç”¨æˆ·å</span>
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.user.root
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> POSTGRES_PASSWORD       <span style="color:#75715e">#PostgreSQL å¯†ç </span>
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.pwd.root
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 1000m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 2048Mi
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>        volumeMounts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - mountPath<span style="color:#960050;background-color:#1e0010">:</span> /var/lib/postgresql/data
</span></span><span style="display:flex;"><span>          name<span style="color:#960050;background-color:#1e0010">:</span> postgredb
</span></span><span style="display:flex;"><span>      volumes<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> postgredb
</span></span><span style="display:flex;"><span>        hostPath<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          path<span style="color:#960050;background-color:#1e0010">:</span> /var/lib/postgres/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#éƒ¨ç½²åˆ°k8s-slave2èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave2 postgres=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#åˆ›å»ºpostgres</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> postgres.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºæ•°æ®åº“gitlab,ä¸ºåé¢éƒ¨ç½²gitlabç»„ä»¶ä½¿ç”¨</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins exec -ti postgres-7ff9b49f4c-nt8zh bash
</span></span><span style="display:flex;"><span>root@postgres-7ff9b49f4c-nt8zh<span style="color:#960050;background-color:#1e0010">:</span>/<span style="color:#75715e"># psql</span>
</span></span><span style="display:flex;"><span>root=<span style="color:#75715e"># create database gitlab;</span>
</span></span><span style="display:flex;"><span>CREATE DATABASE
</span></span></code></pre></div></li>
<li>
<p>éƒ¨ç½²redis</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat redis.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> server
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 6379
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 6379
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      tolerations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - operator<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span>  sameersbn/redis<span style="color:#960050;background-color:#1e0010">:</span>4.0.9-2
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 6379
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 1000m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 2048Mi
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»º</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> redis.yaml
</span></span></code></pre></div></li>
<li>
<p>éƒ¨ç½²gitlab</p>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨ingressæš´æ¼æœåŠ¡</li>
<li>æ·»åŠ annotationï¼ŒæŒ‡å®šnginxç«¯ä¸Šä¼ å¤§å°é™åˆ¶ï¼Œå¦åˆ™æ¨é€ä»£ç æ—¶ä¼šé»˜è®¤è¢«é™åˆ¶1må¤§å°ï¼Œç›¸å½“äºç»™nginxè®¾ç½®client_max_body_sizeçš„é™åˆ¶å¤§å°</li>
<li>ä½¿ç”¨gitlab=trueæ¥é€‰æ‹©èŠ‚ç‚¹</li>
<li>ä½¿ç”¨æœåŠ¡å‘ç°åœ°å€æ¥è®¿é—®postgreså’Œredis</li>
<li>åœ¨secretä¸­å¼•ç”¨æ•°æ®åº“è´¦æˆ·å’Œå¯†ç </li>
<li>æ•°æ®åº“åç§°ä¸ºgitlab</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat gitlab.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  annotations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    nginx.ingress.kubernetes.io/proxy-body-size<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;50m&#34;</span>
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> gitlab.luffy.com
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> server
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      nodeSelector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        gitlab<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      tolerations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - operator<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span>  sameersbn/gitlab<span style="color:#960050;background-color:#1e0010">:</span>13.2.2
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_HOST
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;gitlab.luffy.com&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_PORT
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_DB_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_DB_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_SECRET_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_OTP_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_HOST
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;postgres&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_NAME
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;gitlab&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_USER
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.user.root
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_PASS
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.pwd.root
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> REDIS_HOST
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;redis&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> REDIS_PORT
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 2000m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 5048Mi
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 100m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 500Mi
</span></span><span style="display:flex;"><span>        volumeMounts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - mountPath<span style="color:#960050;background-color:#1e0010">:</span> /home/git/data
</span></span><span style="display:flex;"><span>          name<span style="color:#960050;background-color:#1e0010">:</span> data
</span></span><span style="display:flex;"><span>      volumes<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> data
</span></span><span style="display:flex;"><span>        hostPath<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          path<span style="color:#960050;background-color:#1e0010">:</span> /var/lib/gitlab/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#éƒ¨ç½²åˆ°k8s-slave2èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave2 gitlab=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»º</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> gitlab.yaml
</span></span></code></pre></div></li>
</ol>
<p>é…ç½®hostsè§£æï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>172.21.51.67 gitlab.luffy.com
</span></span></code></pre></div><p><em>è®¾ç½®rootå¯†ç </em></p>
<p>è®¿é—®http://gitlab.luffy.comï¼Œè®¾ç½®ç®¡ç†å‘˜å¯†ç </p>
<p><em>é…ç½®k8s-masterèŠ‚ç‚¹çš„hosts</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;172.21.51.67 gitlab.luffy.com&#34;</span> &gt;&gt;/etc/hosts
</span></span></code></pre></div><p><em>myblogé¡¹ç›®æ¨é€åˆ°gitlab</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mkdir demo
</span></span><span style="display:flex;"><span>cp -r myblog demo/
</span></span><span style="display:flex;"><span>cd demo/myblog
</span></span><span style="display:flex;"><span>git remote rename origin old-origin
</span></span><span style="display:flex;"><span>git remote add origin http<span style="color:#960050;background-color:#1e0010">:</span>//gitlab.luffy.com/root/myblog.git
</span></span><span style="display:flex;"><span>git push -u origin --all
</span></span><span style="display:flex;"><span>git push -u origin --tags
</span></span></code></pre></div><p><em>é’‰é’‰æ¨é€</em></p>
<p><a href="https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq">å®˜æ–¹æ–‡æ¡£</a></p>
<ul>
<li>
<p>é…ç½®æœºå™¨äºº</p>
</li>
<li>
<p>è¯•éªŒå‘é€æ¶ˆæ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39;</span> \
</span></span><span style="display:flex;"><span>   -H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> \
</span></span><span style="display:flex;"><span>   -d <span style="color:#e6db74">&#39;{&#34;msgtype&#34;: &#34;text&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;text&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;content&#34;: &#34;æˆ‘å°±æ˜¯æˆ‘, æ˜¯ä¸ä¸€æ ·çš„çƒŸç«&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h6 id="æ¼”ç¤ºè¿‡ç¨‹">æ¼”ç¤ºè¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤ºè¿‡ç¨‹">#</a></h6>
<p>æµç¨‹ç¤ºæ„å›¾ï¼š</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-gitlab.png" alt=""  />
</p>
<ol>
<li>
<p>å®‰è£…gitlab plugin</p>
<p>æ’ä»¶ä¸­å¿ƒæœç´¢å¹¶å®‰è£…gitlabï¼Œç›´æ¥å®‰è£…å³å¯</p>
</li>
<li>
<p>é…ç½®Gitlab</p>
<p>ç³»ç»Ÿç®¡ç†-&gt;ç³»ç»Ÿé…ç½®-&gt;Gitlabï¼Œå…¶ä¸­çš„API Tokenï¼Œéœ€è¦ä»ä¸‹ä¸ªæ­¥éª¤ä¸­è·å–</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-connection.jpg" alt=""  />
</p>
</li>
<li>
<p>è·å–AccessToken</p>
<p>ç™»å½•gitlabï¼Œé€‰æ‹©user-&gt;Settings-&gt;access tokensæ–°å»ºä¸€ä¸ªè®¿é—®token</p>
</li>
<li>
<p>é…ç½®hostè§£æ</p>
<p>ç”±äºæˆ‘ä»¬çš„Jenkinså’ŒgitlabåŸŸåæ˜¯æœ¬åœ°è§£æï¼Œå› æ­¤éœ€è¦è®©gitlabå’ŒJenkinsæœåŠ¡å¯ä»¥è§£æåˆ°å¯¹æ–¹çš„åŸŸåã€‚ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>
<p>åœ¨å®¹å™¨å†…é…ç½®hosts</p>
</li>
<li>
<p>é…ç½®corednsçš„é™æ€è§£æ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>        hosts {
</span></span><span style="display:flex;"><span>            172.21.51.67 jenkins.luffy.com  gitlab.luffy.com
</span></span><span style="display:flex;"><span>            fallthrough
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>åˆ›å»ºè‡ªç”±é£æ ¼é¡¹ç›®</p>
<ul>
<li>gitlab connection é€‰æ‹©ä¸ºåˆšåˆ›å»ºçš„gitlab</li>
<li>æºç ç®¡ç†é€‰æ‹©Gitï¼Œå¡«é¡¹é¡¹ç›®åœ°å€</li>
<li>æ–°å»ºä¸€ä¸ª Credentials è®¤è¯ï¼Œä½¿ç”¨ç”¨æˆ·åå¯†ç æ–¹å¼ï¼Œé…ç½®gitlabçš„ç”¨æˆ·å’Œå¯†ç </li>
<li>æ„å»ºè§¦å‘å™¨é€‰æ‹© Build when a change is pushed to GitLab</li>
<li>ç”Ÿæˆä¸€ä¸ªSecret token</li>
<li>ä¿å­˜</li>
</ul>
</li>
<li>
<p>åˆ°gitlabé…ç½®webhook</p>
<ul>
<li>è¿›å…¥é¡¹ç›®ä¸‹settings-&gt;Integrations</li>
<li>URLï¼š <a href="http://jenkins.luffy.com/project/free">http://jenkins.luffy.com/project/free</a></li>
<li>Secret Token å¡«å…¥åœ¨Jenkinsç«¯ç”Ÿæˆçš„token</li>
<li>Add webhook</li>
<li>test push eventsï¼ŒæŠ¥é”™ï¼šRequests to the local network are not allowed</li>
</ul>
</li>
<li>
<p>è®¾ç½®gitlabå…è®¸å‘æœ¬åœ°ç½‘ç»œå‘é€webhookè¯·æ±‚</p>
<p>è®¿é—® Admin Aera -&gt; Settings -&gt; Network ï¼Œå±•å¼€Outbound requests</p>
<p>Collapseï¼Œå‹¾é€‰ç¬¬ä¸€é¡¹å³å¯ã€‚å†æ¬¡test push eventsï¼ŒæˆåŠŸã€‚</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-webhook-success.jpg" alt=""  />
</p>
</li>
<li>
<p>é…ç½®freeé¡¹ç›®ï¼Œå¢åŠ æ„å»ºæ­¥éª¤ï¼Œæ‰§è¡Œshellï¼Œå°†å‘é€é’‰é’‰æ¶ˆæ¯çš„shellä¿å­˜</p>
</li>
<li>
<p>æäº¤ä»£ç åˆ°gitlabä»“åº“ï¼ŒæŸ¥çœ‹æ„å»ºæ˜¯å¦è‡ªåŠ¨æ‰§è¡Œ</p>
</li>
</ol>
<blockquote>
</blockquote>
<h5 id="master-slavesagentæ¨¡å¼">Master-Slavesï¼ˆagentï¼‰æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#master-slavesagentæ¨¡å¼">#</a></h5>
<p>ä¸Šé¢æ¼”ç¤ºçš„ä»»åŠ¡ï¼Œé»˜è®¤éƒ½æ˜¯åœ¨masterèŠ‚ç‚¹æ‰§è¡Œçš„ï¼Œå¤šä¸ªä»»åŠ¡éƒ½åœ¨masterèŠ‚ç‚¹æ‰§è¡Œï¼Œå¯¹masterèŠ‚ç‚¹çš„æ€§èƒ½ä¼šé€ æˆä¸€å®šå½±å“ï¼Œå¦‚ä½•å°†ä»»åŠ¡åˆ†æ•£åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œåšæˆå¤šslaveçš„æ–¹å¼ï¼Ÿ</p>
<ol>
<li>
<p>æ·»åŠ slaveèŠ‚ç‚¹</p>
<ul>
<li>
<p>ç³»ç»Ÿç®¡ç† -&gt; èŠ‚ç‚¹ç®¡ç† -&gt; æ–°å»ºèŠ‚ç‚¹</p>
</li>
<li>
<p>æ¯”å¦‚æ·»åŠ 172.21.51.68ï¼Œé€‰æ‹©å›ºå®šèŠ‚ç‚¹ï¼Œä¿å­˜</p>
</li>
<li>
<p>è¿œç¨‹å·¥ä½œç›®å½•/opt/jenkins_jobs</p>
</li>
<li>
<p>æ ‡ç­¾ä¸ºä»»åŠ¡é€‰æ‹©èŠ‚ç‚¹çš„ä¾æ®ï¼Œå¦‚172.21.51.68</p>
</li>
<li>
<p>å¯åŠ¨æ–¹å¼é€‰æ‹©é€šè¿‡java webå¯åŠ¨ä»£ç†ï¼Œä»£ç†æ˜¯è¿è¡ŒjaråŒ…ï¼Œé€šè¿‡JNLPï¼ˆæ˜¯ä¸€ç§å…è®¸å®¢æˆ·ç«¯å¯åŠ¨æ‰˜ç®¡åœ¨è¿œç¨‹WebæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç¨‹åºçš„åè®® ï¼‰å¯åŠ¨è¿æ¥åˆ°masterèŠ‚ç‚¹æœåŠ¡ä¸­</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-new-node.jpg" alt=""  />
</p>
</li>
</ul>
</li>
<li>
<p>æ‰§è¡Œjavaå‘½ä»¤å¯åŠ¨agentæœåŠ¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## ç™»å½•172.21.51.68ï¼Œä¸‹è½½agent.jar</span>
</span></span><span style="display:flex;"><span>$ wget http<span style="color:#960050;background-color:#1e0010">:</span>//jenkins.luffy.com/jnlpJars/agent.jar
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ä¼šæç¤ºæ‰¾ä¸åˆ°agenté”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰é…ç½®åœ°å€è§£æï¼Œç”±äºè¿æ¥jenkins masterä¼šé€šè¿‡50000ç«¯å£ï¼Œç›´æ¥ä½¿ç”¨cluster-ip</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins get svc <span style="color:#75715e">#åœ¨masterèŠ‚ç‚¹æ‰§è¡ŒæŸ¥è¯¢cluster-ipåœ°å€</span>
</span></span><span style="display:flex;"><span>NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)              AGE
</span></span><span style="display:flex;"><span>jenkins   ClusterIP   10.99.204.208   &lt;none&gt;        8080/TCP,50000/TCP   4h8m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## å†æ¬¡å›åˆ°68èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>$ wget 10.99.204.208<span style="color:#960050;background-color:#1e0010">:</span>8080/jnlpJars/agent.jar
</span></span><span style="display:flex;"><span>$ java -jar agent.jar -jnlpUrl http<span style="color:#960050;background-color:#1e0010">:</span>//10.99.204.208<span style="color:#960050;background-color:#1e0010">:</span>8080/computer/172.21.51.68/slave-agent.jnlp -secret 4be4d164f861d2830835653567867a1e695b30c320d35eca2be9f5624f8712c8 -workDir <span style="color:#e6db74">&#34;/opt/jenkins_jobs&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Remoting server accepts the following protocols<span style="color:#960050;background-color:#1e0010">:</span> [JNLP4-connect, Ping]
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Agent discovery successful
</span></span><span style="display:flex;"><span>  Agent address<span style="color:#960050;background-color:#1e0010">:</span> 10.99.204.208
</span></span><span style="display:flex;"><span>  Agent port<span style="color:#960050;background-color:#1e0010">:</span>    50000
</span></span><span style="display:flex;"><span>  Identity<span style="color:#960050;background-color:#1e0010">:</span>      e4<span style="color:#960050;background-color:#1e0010">:</span>46<span style="color:#960050;background-color:#1e0010">:</span>3a<span style="color:#960050;background-color:#1e0010">ğŸ‡©ğŸ‡ª</span>86<span style="color:#960050;background-color:#1e0010">:</span>24<span style="color:#960050;background-color:#1e0010">:</span>8e<span style="color:#960050;background-color:#1e0010">:</span>15<span style="color:#960050;background-color:#1e0010">:</span>09<span style="color:#960050;background-color:#1e0010">:</span>13<span style="color:#960050;background-color:#1e0010">:</span>3d<span style="color:#960050;background-color:#1e0010">:</span>a7<span style="color:#960050;background-color:#1e0010">:</span>4e<span style="color:#960050;background-color:#1e0010">:</span>07<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>37
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Handshaking
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Connecting to 10.99.204.208<span style="color:#960050;background-color:#1e0010">:</span>50000
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Trying protocol<span style="color:#960050;background-color:#1e0010">:</span> JNLP4-connect
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>02 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Remote identity confirmed<span style="color:#960050;background-color:#1e0010">:</span> e4<span style="color:#960050;background-color:#1e0010">:</span>46<span style="color:#960050;background-color:#1e0010">:</span>3a<span style="color:#960050;background-color:#1e0010">ğŸ‡©ğŸ‡ª</span>86<span style="color:#960050;background-color:#1e0010">:</span>24<span style="color:#960050;background-color:#1e0010">:</span>8e<span style="color:#960050;background-color:#1e0010">:</span>15<span style="color:#960050;background-color:#1e0010">:</span>09<span style="color:#960050;background-color:#1e0010">:</span>13<span style="color:#960050;background-color:#1e0010">:</span>3d<span style="color:#960050;background-color:#1e0010">:</span>a7<span style="color:#960050;background-color:#1e0010">:</span>4e<span style="color:#960050;background-color:#1e0010">:</span>07<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>37
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>03 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Connected
</span></span></code></pre></div><p>è‹¥å‡ºç°å¦‚ä¸‹é”™è¯¯:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SEVERE<span style="color:#960050;background-color:#1e0010">:</span> http<span style="color:#960050;background-color:#1e0010">:</span>//jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity.
</span></span><span style="display:flex;"><span>java.io.IOException<span style="color:#960050;background-color:#1e0010">:</span> http<span style="color:#960050;background-color:#1e0010">:</span>//jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity.
</span></span><span style="display:flex;"><span>        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java<span style="color:#960050;background-color:#1e0010">:</span>287)
</span></span><span style="display:flex;"><span>        at hudson.remoting.Engine.innerRun(Engine.java<span style="color:#960050;background-color:#1e0010">:</span>694)
</span></span><span style="display:flex;"><span>        at hudson.remoting.Engine.run(Engine.java<span style="color:#960050;background-color:#1e0010">:</span>519)
</span></span></code></pre></div><p>å¯ä»¥é€‰æ‹©ï¼š é…ç½®ä»èŠ‚ç‚¹ -&gt; é«˜çº§ -&gt; Tunnelè¿æ¥ä½ç½®ï¼Œå‚è€ƒä¸‹å›¾è¿›è¡Œè®¾ç½®:</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/slave-tunnel.jpg" alt=""  />
</p>
</li>
<li>
<p>æŸ¥çœ‹JenkinsèŠ‚ç‚¹åˆ—è¡¨ï¼Œæ–°èŠ‚ç‚¹å·²ç»å¤„äºå¯ç”¨çŠ¶æ€</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-node-lists.jpg" alt=""  />
</p>
</li>
<li>
<p>æµ‹è¯•ä½¿ç”¨æ–°èŠ‚ç‚¹æ‰§è¡Œä»»åŠ¡</p>
<ul>
<li>
<p>é…ç½®freeé¡¹ç›®</p>
</li>
<li>
<p>é™åˆ¶é¡¹ç›®çš„è¿è¡ŒèŠ‚ç‚¹ ï¼Œæ ‡ç­¾è¡¨è¾¾å¼é€‰æ‹©172.21.51.68</p>
</li>
<li>
<p>ç«‹å³æ„å»º</p>
</li>
<li>
<p>æŸ¥çœ‹æ„å»ºæ—¥å¿—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Started by user admin
</span></span><span style="display:flex;"><span>Running as SYSTEM
</span></span><span style="display:flex;"><span>Building remotely on 172.21.51.68 <span style="color:#66d9ef">in</span> workspace /opt/jenkins_jobs/workspace/free-demo
</span></span><span style="display:flex;"><span>using credential gitlab-user
</span></span><span style="display:flex;"><span>Cloning the remote Git repository
</span></span><span style="display:flex;"><span>Cloning repository http<span style="color:#960050;background-color:#1e0010">:</span>//gitlab.luffy.com/root/myblog.git
</span></span><span style="display:flex;"><span> &gt; git init /opt/jenkins_jobs/workspace/free-demo <span style="color:#75715e"># timeout=10</span>
</span></span><span style="display:flex;"><span> ...
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
<blockquote>
</blockquote>
<h5 id="jenkinså®šåˆ¶åŒ–å®¹å™¨">Jenkinså®šåˆ¶åŒ–å®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#jenkinså®šåˆ¶åŒ–å®¹å™¨">#</a></h5>
<p>ç”±äºæ¯æ¬¡æ–°éƒ¨ç½²Jenkinsç¯å¢ƒï¼Œå‡éœ€è¦å®‰è£…å¾ˆå¤šå¿…è¦çš„æ’ä»¶ï¼Œå› æ­¤è€ƒè™‘æŠŠæ’ä»¶æå‰åšåˆ°é•œåƒä¸­</p>
<p><em>Dockerfile</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> jenkinsci/blueocean:1.23.2</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> maintainer<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">## ç”¨æœ€æ–°çš„æ’ä»¶åˆ—è¡¨æ–‡ä»¶æ›¿æ¢é»˜è®¤æ’ä»¶æ–‡ä»¶</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> plugins.txt /usr/share/jenkins/ref/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">## æ‰§è¡Œæ’ä»¶å®‰è£…</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> /usr/local/bin/install-plugins.sh &lt; /usr/share/jenkins/ref/plugins.txt<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><em>plugins.txt</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ace<span style="color:#f92672">-</span>editor:<span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span>allure<span style="color:#f92672">-</span>jenkins<span style="color:#f92672">-</span>plugin:<span style="color:#ae81ff">2.28.1</span>
</span></span><span style="display:flex;"><span>ant:<span style="color:#ae81ff">1.10</span>
</span></span><span style="display:flex;"><span>antisamy<span style="color:#f92672">-</span>markup<span style="color:#f92672">-</span>formatter:<span style="color:#ae81ff">1.6</span>
</span></span><span style="display:flex;"><span>apache<span style="color:#f92672">-</span>httpcomponents<span style="color:#f92672">-</span>client<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#f92672">-</span>api:<span style="color:#ae81ff">4.5.10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>authentication<span style="color:#f92672">-</span>tokens:<span style="color:#ae81ff">1.3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p><em>get_plugin.sh</em></p>
<blockquote>
<p>admin:123456@localhost éœ€è¦æ›¿æ¢æˆJenkinsçš„ç”¨æˆ·åã€å¯†ç åŠè®¿é—®åœ°å€</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash</span>
</span></span><span style="display:flex;"><span>curl -sSL  <span style="color:#e6db74">&#34;http://admin:123456@localhost:8080/pluginManager/api/xml?depth=1&amp;xpath=/*/*/shortName|/*/*/version&amp;wrapper=plugins&#34;</span> | perl -pe <span style="color:#e6db74">&#39;s/.*?&lt;shortName&gt;([\w-]+).*?&lt;version&gt;([^&lt;]+)()(&lt;\/\w+&gt;)+/\1:\2\n/g&#39;</span>|sed <span style="color:#e6db74">&#39;s/ /:/&#39;</span> &gt; plugins.txt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## æ‰§è¡Œæ„å»ºï¼Œå®šåˆ¶jenkinså®¹å™¨</span>
</span></span><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/jenkins<span style="color:#960050;background-color:#1e0010">:</span>v20200414 <span style="color:#f92672">-f</span> Dockerfile
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/jenkins<span style="color:#960050;background-color:#1e0010">:</span>v20200414
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®šåˆ¶åŒ–çš„é•œåƒå¯åŠ¨jenkinsæœåŠ¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## åˆ æ‰å½“å‰æœåŠ¡</span>
</span></span><span style="display:flex;"><span>$ kubectl delete <span style="color:#f92672">-f</span> jenkins-all.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## åˆ æ‰å·²æŒ‚è½½çš„æ•°æ®</span>
</span></span><span style="display:flex;"><span>$ rm -rf /var/jenkins_home
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## æ›¿æ¢ä½¿ç”¨å®šåˆ¶åŒ–é•œåƒ</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#jenkinsci/blueocean#172.21.51.67:5000/jenkins:v20200404#g&#39;</span> jenkins-all.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## é‡æ–°åˆ›å»ºæœåŠ¡</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> jenkins-all.yaml
</span></span></code></pre></div><h5 id="æœ¬ç« å°ç»“">æœ¬ç« å°ç»“<a hidden class="anchor" aria-hidden="true" href="#æœ¬ç« å°ç»“">#</a></h5>
<p>è‡ªç”±é£æ ¼é¡¹ç›®å¼Šç«¯ï¼š</p>
<ul>
<li>ä»»åŠ¡çš„å®Œæˆéœ€è¦åœ¨Jenkinsç«¯ç»´æŠ¤å¤§é‡çš„é…ç½®</li>
<li>æ²¡æ³•åšç‰ˆæœ¬æ§åˆ¶</li>
<li>å¯è¯»æ€§ã€å¯ç§»æ¤æ€§å¾ˆå·®ï¼Œä¸å¤Ÿä¼˜é›…</li>
</ul>
<blockquote>
</blockquote>
<h4 id="æµæ°´çº¿å…¥é—¨">æµæ°´çº¿å…¥é—¨<a hidden class="anchor" aria-hidden="true" href="#æµæ°´çº¿å…¥é—¨">#</a></h4>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/pipeline-factory.jpeg" alt=""  />
</p>
<p><a href="https://jenkins.io/zh/doc/book/pipeline/getting-started/">å®˜æ–¹æ–‡æ¡£</a></p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/realworld-pipeline-flow.png" alt=""  />
</p>
<p>ä¸ºä»€ä¹ˆå«åšæµæ°´çº¿ï¼Œå’Œå·¥å‚äº§å“çš„ç”Ÿäº§çº¿ç±»ä¼¼ï¼Œpipelineæ˜¯ä»æºç åˆ°å‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒã€‚å…³äºæµæ°´çº¿ï¼Œéœ€è¦çŸ¥é“çš„å‡ ä¸ªç‚¹ï¼š</p>
<ul>
<li>
<p>é‡è¦çš„åŠŸèƒ½æ’ä»¶ï¼Œå¸®åŠ©Jenkinså®šä¹‰äº†ä¸€å¥—å·¥ä½œæµæ¡†æ¶ï¼›</p>
</li>
<li>
<p>Pipeline çš„å®ç°æ–¹å¼æ˜¯ä¸€å¥— Groovy DSLï¼ˆ é¢†åŸŸä¸“ç”¨è¯­è¨€ ï¼‰ï¼Œæ‰€æœ‰çš„å‘å¸ƒæµç¨‹éƒ½å¯ä»¥è¡¨è¿°ä¸ºä¸€æ®µ Groovy è„šæœ¬ï¼›</p>
</li>
<li>
<p>å°†WebUIä¸Šéœ€è¦å®šä¹‰çš„ä»»åŠ¡ï¼Œä»¥è„šæœ¬ä»£ç çš„æ–¹å¼è¡¨è¿°å‡ºæ¥ï¼›</p>
</li>
<li>
<p>å¸®åŠ©jenkinså®ç°æŒç»­é›†æˆCIï¼ˆContinue Integrationï¼‰å’ŒæŒç»­éƒ¨ç½²CDï¼ˆContinue Deliverï¼‰çš„é‡è¦æ‰‹æ®µï¼›</p>
</li>
</ul>
<h5 id="æµæ°´çº¿åŸºç¡€è¯­æ³•">æµæ°´çº¿åŸºç¡€è¯­æ³•<a hidden class="anchor" aria-hidden="true" href="#æµæ°´çº¿åŸºç¡€è¯­æ³•">#</a></h5>
<p><a href="https://jenkins.io/zh/doc/book/pipeline/syntax/">å®˜æ–¹æ–‡æ¡£</a></p>
<p>ä¸¤ç§è¯­æ³•ç±»å‹ï¼š</p>
<ul>
<li>Scripted Pipelineï¼Œè„šæœ¬å¼æµæ°´çº¿ï¼Œæœ€åˆæ”¯æŒçš„ç±»å‹</li>
<li>Declarative Pipelineï¼Œå£°æ˜å¼æµæ°´çº¿ï¼Œä¸ºPipeline pluginåœ¨2.5ç‰ˆæœ¬ä¹‹åæ–°å¢çš„ä¸€ç§è„šæœ¬ç±»å‹ï¼Œåç»­Open Blue Oceanæ‰€æ”¯æŒçš„ç±»å‹ã€‚ä¸åŸå…ˆçš„Scripted Pipelineä¸€æ ·ï¼Œéƒ½å¯ä»¥ç”¨æ¥ç¼–å†™è„šæœ¬ã€‚Declarative Pipeline æ˜¯åç»­Open Blue Oceanæ‰€æ”¯æŒçš„ç±»å‹ï¼Œå†™æ³•ç®€å•ï¼Œæ”¯æŒå†…åµŒScripted Pipelineä»£ç </li>
</ul>
<p><em>ä¸ºä¸BlueOceanè„šæœ¬ç¼–è¾‘å™¨å…¼å®¹ï¼Œé€šå¸¸å»ºè®®ä½¿ç”¨Declarative Pipelineçš„æ–¹å¼è¿›è¡Œç¼–å†™,ä»jenkinsç¤¾åŒºçš„åŠ¨å‘æ¥çœ‹ï¼Œå¾ˆæ˜æ˜¾è¿™ç§è¯­æ³•ç»“æ„ä¹Ÿä¼šæ˜¯æœªæ¥çš„è¶‹åŠ¿ã€‚</em></p>
<h6 id="è„šæœ¬ç¤ºä¾‹">è„šæœ¬ç¤ºä¾‹<a hidden class="anchor" aria-hidden="true" href="#è„šæœ¬ç¤ºä¾‹">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">pipeline</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">agent</span> <span style="color:#960050;background-color:#1e0010">{label</span> <span style="color:#960050;background-color:#1e0010">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">environment</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">PROJECT</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">&#39;myblog&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">stages</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Checkout&#39;)</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">checkout</span> <span style="color:#960050;background-color:#1e0010">scm</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Build&#39;)</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">sh</span> <span style="color:#960050;background-color:#1e0010">&#39;make&#39;</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Test&#39;)</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">sh</span> <span style="color:#960050;background-color:#1e0010">&#39;make</span> <span style="color:#960050;background-color:#1e0010">check&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">junit</span> <span style="color:#960050;background-color:#1e0010">&#39;reports/**/*.xml&#39;</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Deploy&#39;)</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">sh</span> <span style="color:#960050;background-color:#1e0010">&#39;make</span> <span style="color:#960050;background-color:#1e0010">publish&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">post</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">success</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">failure</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;Oh</span> <span style="color:#960050;background-color:#1e0010">no!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">always</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;I</span> <span style="color:#960050;background-color:#1e0010">will</span> <span style="color:#960050;background-color:#1e0010">always</span> <span style="color:#960050;background-color:#1e0010">say</span> <span style="color:#960050;background-color:#1e0010">Hello</span> <span style="color:#960050;background-color:#1e0010">again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div><h6 id="è„šæœ¬è§£é‡Š">è„šæœ¬è§£é‡Šï¼š<a hidden class="anchor" aria-hidden="true" href="#è„šæœ¬è§£é‡Š">#</a></h6>
<ul>
<li>
<p><code>checkout</code>æ­¥éª¤ä¸ºæ£€å‡ºä»£ç ; <code>scm</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šå˜é‡ï¼ŒæŒ‡ç¤º<code>checkout</code>æ­¥éª¤å…‹éš†è§¦å‘æ­¤Pipelineè¿è¡Œçš„ç‰¹å®šä¿®è®¢</p>
</li>
<li>
<p>agentï¼šæŒ‡æ˜ä½¿ç”¨å“ªä¸ªagentèŠ‚ç‚¹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®šä¹‰äºpipelineé¡¶å±‚æˆ–è€…stageå†…éƒ¨</p>
<ul>
<li>
<p>anyï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„å¯ç”¨çš„agentæ¥æ‰§è¡Œ</p>
</li>
<li>
<p>labelï¼Œåœ¨æä¾›äº†æ ‡ç­¾çš„ Jenkins ç¯å¢ƒä¸­å¯ç”¨çš„ä»£ç†ä¸Šæ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚ ä¾‹å¦‚: <code>agent { label 'my-defined-label' }</code>ï¼Œæœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼</p>
</li>
<li>
<p>noneï¼Œå½“åœ¨ <code>pipeline</code> å—çš„é¡¶éƒ¨æ²¡æœ‰å…¨å±€ä»£ç†ï¼Œ è¯¥å‚æ•°å°†ä¼šè¢«åˆ†é…åˆ°æ•´ä¸ªæµæ°´çº¿çš„è¿è¡Œä¸­å¹¶ä¸”æ¯ä¸ª <code>stage</code> éƒ¨åˆ†éƒ½éœ€è¦åŒ…å«ä»–è‡ªå·±çš„ <code>agent</code> éƒ¨åˆ†ã€‚æ¯”å¦‚: <code>agent none</code></p>
</li>
<li>
<p>dockerï¼Œ ä½¿ç”¨ç»™å®šçš„å®¹å™¨æ‰§è¡Œæµæ°´çº¿æˆ–é˜¶æ®µã€‚ åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸­ï¼Œé€šè¿‡è¿è¡Œå®¹å™¨æ¥æ‰§è¡Œä»»åŠ¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">agent</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">docker</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">image</span> <span style="color:#960050;background-color:#1e0010">&#39;maven:3-alpine&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">label</span> <span style="color:#960050;background-color:#1e0010">&#39;my-defined-label&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">args</span>  <span style="color:#960050;background-color:#1e0010">&#39;-v</span> <span style="color:#960050;background-color:#1e0010">/tmp:/tmp&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>options:  å…è®¸ä»æµæ°´çº¿å†…éƒ¨é…ç½®ç‰¹å®šäºæµæ°´çº¿çš„é€‰é¡¹ã€‚</p>
<ul>
<li>buildDiscarder , ä¸ºæœ€è¿‘çš„æµæ°´çº¿è¿è¡Œçš„ç‰¹å®šæ•°é‡ä¿å­˜ç»„ä»¶å’Œæ§åˆ¶å°è¾“å‡ºã€‚ä¾‹å¦‚: <code>options { buildDiscarder(logRotator(numToKeepStr: '10')) }</code></li>
<li>disableConcurrentBuilds ,ä¸å…è®¸åŒæ—¶æ‰§è¡Œæµæ°´çº¿ã€‚ å¯è¢«ç”¨æ¥é˜²æ­¢åŒæ—¶è®¿é—®å…±äº«èµ„æºç­‰ã€‚ ä¾‹å¦‚: <code>options { disableConcurrentBuilds() }</code></li>
<li>timeout ,è®¾ç½®æµæ°´çº¿è¿è¡Œçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkinså°†ä¸­æ­¢æµæ°´çº¿ã€‚ä¾‹å¦‚: <code>options { timeout(time: 1, unit: 'HOURS') }</code></li>
<li>retryï¼Œåœ¨å¤±è´¥æ—¶, é‡æ–°å°è¯•æ•´ä¸ªæµæ°´çº¿çš„æŒ‡å®šæ¬¡æ•°ã€‚ For example: <code>options { retry(3) }</code></li>
</ul>
</li>
<li>
<p>environment:  æŒ‡ä»¤åˆ¶å®šä¸€ä¸ª é”®-å€¼å¯¹åºåˆ—ï¼Œè¯¥åºåˆ—å°†è¢«å®šä¹‰ä¸ºæ‰€æœ‰æ­¥éª¤çš„ç¯å¢ƒå˜é‡</p>
</li>
<li>
<p>stages: åŒ…å«ä¸€ç³»åˆ—ä¸€ä¸ªæˆ–å¤šä¸ª <a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#stage">stage</a>æŒ‡ä»¤, <code>stages</code> éƒ¨åˆ†æ˜¯æµæ°´çº¿æè¿°çš„å¤§éƒ¨åˆ†&quot;work&quot; çš„ä½ç½®ã€‚ å»ºè®® <code>stages</code> è‡³å°‘åŒ…å«ä¸€ä¸ª <a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#stage">stage</a> æŒ‡ä»¤ç”¨äºè¿ç»­äº¤ä»˜è¿‡ç¨‹çš„æ¯ä¸ªç¦»æ•£éƒ¨åˆ†,æ¯”å¦‚æ„å»º, æµ‹è¯•, å’Œéƒ¨ç½²ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>steps: åœ¨ç»™å®šçš„ <code>stage</code> æŒ‡ä»¤ä¸­æ‰§è¡Œçš„å®šä¹‰äº†ä¸€ç³»åˆ—çš„ä¸€ä¸ªæˆ–å¤šä¸ª<a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps">steps</a>ã€‚</p>
</li>
<li>
<p>post:  å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ª<a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps">steps</a> ï¼Œè¿™äº›é˜¶æ®µæ ¹æ®æµæ°´çº¿æˆ–é˜¶æ®µçš„å®Œæˆæƒ…å†µè€Œè¿è¡Œ<code>post</code> æ”¯æŒä»¥ä¸‹ <a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#post-conditions">post-condition</a> å—ä¸­çš„å…¶ä¸­ä¹‹ä¸€: <code>always</code>, <code>changed</code>, <code>failure</code>, <code>success</code>, <code>unstable</code>, å’Œ <code>aborted</code>ã€‚</p>
<ul>
<li>always, æ— è®ºæµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€å¦‚ä½•ï¼Œéƒ½å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤</li>
<li>changed, å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸å®ƒä¹‹å‰çš„è¿è¡Œä¸åŒæ—¶ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤</li>
<li>failure,  å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º&quot;failure&quot;ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯çº¢è‰²</li>
<li>success,  å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º&quot;success&quot;ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸web UIæ˜¯è“è‰²æˆ–ç»¿è‰²</li>
<li>unstable,  å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º&quot;unstable&quot;ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµ‹è¯•å¤±è´¥,ä»£ç è¿è§„ç­‰é€ æˆã€‚é€šå¸¸web UIæ˜¯é»„è‰²</li>
<li>abortedï¼Œ åªæœ‰å½“å‰æµæ°´çº¿æˆ–é˜¶æ®µçš„å®ŒæˆçŠ¶æ€ä¸º&quot;aborted&quot;ï¼Œæ‰å…è®¸åœ¨ <code>post</code> éƒ¨åˆ†è¿è¡Œè¯¥æ­¥éª¤, é€šå¸¸ç”±äºæµæ°´çº¿è¢«æ‰‹åŠ¨çš„abortedã€‚é€šå¸¸web UIæ˜¯ç°è‰²</li>
</ul>
</li>
</ul>
<p>åˆ›å»ºpipelineç¤ºæ„ï¼š</p>
<p>æ–°å»ºä»»åŠ¡ -&gt; æµæ°´çº¿</p>
<p><code>jenkins/pipelines/p1.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>   agent {label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>   environment { 
</span></span><span style="display:flex;"><span>      PROJECT = <span style="color:#e6db74">&#39;myblog&#39;</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   stages {
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            checkout([$class<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;GitSCM&#39;</span>, branches<span style="color:#960050;background-color:#1e0010">:</span> [[name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;*/master&#39;</span>]], doGenerateSubmoduleConfigurations<span style="color:#960050;background-color:#1e0010">:</span> false, extensions<span style="color:#960050;background-color:#1e0010">:</span> [], submoduleCfg<span style="color:#960050;background-color:#1e0010">:</span> [], userRemoteConfigs<span style="color:#960050;background-color:#1e0010">:</span> [[credentialsId<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;gitlab-user&#39;</span>, url<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;http://gitlab.luffy.com/root/myblog.git&#39;</span>]]])
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;docker build . -t myblog:latest -f Dockerfile&#39;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;send-msg&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span>æˆ‘å°±æ˜¯æˆ‘, æ˜¯ä¸ä¸€æ ·çš„çƒŸç«<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç‚¹å‡»â€œç«‹å³æ„å»ºâ€ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®è§¦å‘å™¨ï¼Œä½¿ç”¨webhookçš„æ–¹å¼æ¥æ”¶é¡¹ç›®çš„pushäº‹ä»¶ï¼Œ</p>
<ul>
<li>æ„å»ºè§¦å‘å™¨é€‰æ‹© Build when a change is pushed to GitLab.</li>
<li>ç”Ÿæˆ Secret token</li>
<li>é…ç½®gitlabï¼Œåˆ›å»ºwebhookï¼Œå‘é€test push eventsæµ‹è¯•</li>
</ul>
<h6 id="blue-ocean">Blue Ocean:<a hidden class="anchor" aria-hidden="true" href="#blue-ocean">#</a></h6>
<p><a href="https://jenkins.io/zh/doc/book/blueocean/getting-started/">å®˜æ–¹æ–‡æ¡£</a></p>
<p>æˆ‘ä»¬éœ€è¦çŸ¥é“çš„å‡ ç‚¹ï¼š</p>
<ul>
<li>æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œ æ—¨åœ¨ä¸ºPipelineæä¾›ä¸°å¯Œçš„ä½“éªŒ ï¼›</li>
<li>è¿ç»­äº¤ä»˜ï¼ˆCDï¼‰Pipelineçš„å¤æ‚å¯è§†åŒ–ï¼Œå…è®¸å¿«é€Ÿå’Œç›´è§‚åœ°äº†è§£Pipelineçš„çŠ¶æ€ï¼›</li>
<li>ç›®å‰æ”¯æŒçš„ç±»å‹ä»…é’ˆå¯¹äºPipelineï¼Œå°šä¸èƒ½æ›¿ä»£Jenkins ç»å…¸ç‰ˆUI</li>
</ul>
<p>æ€è€ƒï¼š</p>
<ol>
<li>æ¯ä¸ªé¡¹ç›®éƒ½æŠŠå¤§é‡çš„pipelineè„šæœ¬å†™åœ¨Jenkinsç«¯ï¼Œå¯¹äºè°å»ç»´æŠ¤åŠç»´æŠ¤æˆæœ¬æ˜¯ä¸€ä¸ªé—®é¢˜</li>
<li>æ²¡æ³•åšç‰ˆæœ¬æ§åˆ¶</li>
</ol>
<blockquote>
</blockquote>
<h5 id="jenkinsflie">Jenkinsflie<a hidden class="anchor" aria-hidden="true" href="#jenkinsflie">#</a></h5>
<p>Jenkins Pipeline æä¾›äº†ä¸€å¥—å¯æ‰©å±•çš„å·¥å…·ï¼Œç”¨äºå°†â€œç®€å•åˆ°å¤æ‚â€çš„äº¤ä»˜æµç¨‹å®ç°ä¸ºâ€œæŒç»­äº¤ä»˜å³ä»£ç â€ã€‚Jenkins Pipeline çš„å®šä¹‰é€šå¸¸è¢«å†™å…¥åˆ°ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ˆç§°ä¸º <code>Jenkinsfile</code> ï¼‰ä¸­ï¼Œè¯¥æ–‡ä»¶å¯ä»¥è¢«æ”¾å…¥é¡¹ç›®çš„æºä»£ç æ§åˆ¶åº“ä¸­ã€‚</p>
<h6 id="æ¼”ç¤º1ä½¿ç”¨jenkinsfileç®¡ç†pipeline">æ¼”ç¤º1ï¼šä½¿ç”¨Jenkinsfileç®¡ç†<strong>pipeline</strong><a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º1ä½¿ç”¨jenkinsfileç®¡ç†pipeline">#</a></h6>
<ul>
<li>åœ¨é¡¹ç›®ä¸­æ–°å»ºJenkinsfileæ–‡ä»¶ï¼Œæ‹·è´å·²æœ‰scriptå†…å®¹</li>
<li>é…ç½®pipelineä»»åŠ¡ï¼Œæµæ°´çº¿å®šä¹‰ä¸ºPipeline Script from SCM</li>
<li>æ‰§è¡Œpush ä»£ç æµ‹è¯•</li>
</ul>
<p>Jenkinsfile:</p>
<p><code>jenkins/pipelines/p2.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>   agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   stages {
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            checkout([$class<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;GitSCM&#39;</span>, branches<span style="color:#960050;background-color:#1e0010">:</span> [[name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;*/master&#39;</span>]], doGenerateSubmoduleConfigurations<span style="color:#960050;background-color:#1e0010">:</span> false, extensions<span style="color:#960050;background-color:#1e0010">:</span> [], submoduleCfg<span style="color:#960050;background-color:#1e0010">:</span> [], userRemoteConfigs<span style="color:#960050;background-color:#1e0010">:</span> [[credentialsId<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;gitlab-user&#39;</span>, url<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;http://gitlab.luffy.com/root/myblog.git&#39;</span>]]])
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t myblog:latest&#39;</span>}
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;send-msg&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span>æˆ‘å°±æ˜¯æˆ‘, æ˜¯ä¸ä¸€æ ·çš„çƒŸç«<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="æ¼”ç¤º2ä¼˜åŒ–åŠä¸°å¯Œæµæ°´çº¿å†…å®¹">æ¼”ç¤º2ï¼šä¼˜åŒ–åŠä¸°å¯Œæµæ°´çº¿å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º2ä¼˜åŒ–åŠä¸°å¯Œæµæ°´çº¿å†…å®¹">#</a></h6>
<ul>
<li>
<p>ä¼˜åŒ–ä»£ç æ£€å‡ºé˜¶æ®µ</p>
<p>ç”±äºç›®å‰å·²ç»é…ç½®äº†ä½¿ç”¨gitä»“åº“åœ°å€ï¼Œä¸”ä½¿ç”¨SCMæ¥æ£€æµ‹é¡¹ç›®ï¼Œå› æ­¤ä»£ç æ£€å‡ºé˜¶æ®µå®Œå…¨æ²¡æœ‰å¿…è¦å†å»æŒ‡å®šä¸€æ¬¡</p>
</li>
<li>
<p>æ„å»ºé•œåƒçš„tagä½¿ç”¨gitçš„commit id</p>
</li>
<li>
<p>å¢åŠ posté˜¶æ®µçš„æ¶ˆæ¯é€šçŸ¥ï¼Œä¸°å¯Œé€šçŸ¥å†…å®¹</p>
</li>
<li>
<p>é…ç½®webhookï¼Œå®ç°myblogä»£ç æ¨é€åï¼Œè§¦å‘Jenkinsfileä»»åŠ¡æ‰§è¡Œ</p>
</li>
</ul>
<p><code>jenkins/pipelines/p3.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;printenv&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;check&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            	retry<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#39;docker build . -t myblog:${GIT_COMMIT}&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;msgtype&#34;: &#34;text&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;content&#34;: &#34;ğŸ˜„ğŸ‘æ„å»ºæˆåŠŸğŸ‘ğŸ˜„\n å…³é”®å­—ï¼šluffy\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\n Commit Id: ${GIT_COMMIT}\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;msgtype&#34;: &#34;text&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;content&#34;: &#34;ğŸ˜–âŒæ„å»ºå¤±è´¥âŒğŸ˜–\n å…³é”®å­—ï¼šluffy\n é¡¹ç›®åç§°: ${JOB_BASE_NAME}\n Commit Id: ${GIT_COMMIT}\n æ„å»ºåœ°å€ï¼š${RUN_DISPLAY_URL}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="æ¼”ç¤º3ä½¿ç”¨k8séƒ¨ç½²æœåŠ¡">æ¼”ç¤º3ï¼šä½¿ç”¨k8séƒ¨ç½²æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º3ä½¿ç”¨k8séƒ¨ç½²æœåŠ¡">#</a></h6>
<ul>
<li>
<p>æ–°å»ºdeployç›®å½•ï¼Œå°†k8sæ‰€éœ€çš„æ–‡ä»¶æ”¾åˆ°deployç›®å½•ä¸­</p>
</li>
<li>
<p>å°†é•œåƒåœ°å€æ”¹æˆæ¨¡æ¿ï¼Œåœ¨pipelineä¸­ä½¿ç”¨æ–°æ„å»ºçš„é•œåƒè¿›è¡Œæ›¿æ¢</p>
</li>
<li>
<p>æ‰§è¡Œkubectl apply -f deployåº”ç”¨æ›´æ”¹ï¼Œéœ€è¦é…ç½®kubectlè®¤è¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ scp -r k8s-master<span style="color:#960050;background-color:#1e0010">:</span>/root/.kube /root
</span></span></code></pre></div></li>
</ul>
<p><code>jenkins/pipelines/p4.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>              echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>              sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜„ğŸ‘</span>æ„å»ºæˆåŠŸ<span style="color:#960050;background-color:#1e0010">ğŸ‘ğŸ˜„</span>\n å…³é”®å­—<span style="color:#960050;background-color:#1e0010">ï¼š</span>myblog\n é¡¹ç›®åç§°<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n æ„å»ºåœ°å€<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜–âŒ</span>æ„å»ºå¤±è´¥<span style="color:#960050;background-color:#1e0010">âŒğŸ˜–</span>\n å…³é”®å­—<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy\n é¡¹ç›®åç§°<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n æ„å»ºåœ°å€<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="æ¼”ç¤º4ä½¿ç”¨å‡­æ®ç®¡ç†æ•æ„Ÿä¿¡æ¯">æ¼”ç¤º4ï¼šä½¿ç”¨å‡­æ®ç®¡ç†æ•æ„Ÿä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º4ä½¿ç”¨å‡­æ®ç®¡ç†æ•æ„Ÿä¿¡æ¯">#</a></h6>
<p>ä¸Šè¿°Jenkinsfileä¸­å­˜åœ¨çš„é—®é¢˜æ˜¯æ•æ„Ÿä¿¡æ¯ä½¿ç”¨æ˜æ–‡ï¼Œæš´æ¼åœ¨ä»£ç ä¸­ï¼Œå¦‚ä½•ç®¡ç†æµæ°´çº¿ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼ˆåŒ…å«è´¦å·å¯†ç ï¼‰ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨å¯¹æ¥gitlabçš„æ—¶å€™ï¼Œéœ€è¦è´¦å·å¯†ç ï¼Œå·²ç»ä½¿ç”¨è¿‡å‡­æ®æ¥ç®¡ç†è¿™ç±»æ•æ„Ÿä¿¡æ¯ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡­æ®æ¥å­˜å‚¨é’‰é’‰çš„tokenä¿¡æ¯ï¼Œé‚£ä¹ˆï¼Œåˆ›å»ºå¥½å‡­æ®åï¼Œå¦‚ä½•åœ¨Jenkinsfileä¸­è·å–å·²æœ‰å‡­æ®çš„å†…å®¹ï¼Ÿ</p>
<p>Jenkins çš„å£°æ˜å¼æµæ°´çº¿è¯­æ³•æœ‰ä¸€ä¸ª <code>credentials()</code> è¾…åŠ©æ–¹æ³•ï¼ˆåœ¨<a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/#../syntax#environment"><code>environment</code></a> æŒ‡ä»¤ä¸­ä½¿ç”¨ï¼‰ï¼Œå®ƒæ”¯æŒ <a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/##secret-text">secret æ–‡æœ¬</a>ï¼Œ<a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/##usernames-and-passwords">å¸¦å¯†ç çš„ç”¨æˆ·å</a>ï¼Œä»¥åŠ <a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/##secret-files">secret æ–‡ä»¶</a>å‡­æ®ã€‚</p>
<p>ä¸‹é¢çš„æµæ°´çº¿ä»£ç ç‰‡æ®µå±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªä½¿ç”¨å¸¦å¯†ç çš„ç”¨æˆ·åå‡­æ®çš„ç¯å¢ƒå˜é‡çš„æµæ°´çº¿ã€‚</p>
<p>åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œå¸¦å¯†ç çš„ç”¨æˆ·åå‡­æ®è¢«åˆ†é…äº†ç¯å¢ƒå˜é‡ï¼Œç”¨æ¥ä½¿ä½ çš„ç»„ç»‡æˆ–å›¢é˜Ÿä»¥ä¸€ä¸ªå…¬ç”¨è´¦æˆ·è®¿é—® Bitbucket ä»“åº“ï¼›è¿™äº›å‡­æ®å·²åœ¨ Jenkins ä¸­é…ç½®äº†å‡­æ® ID <code>jenkins-bitbucket-common-creds</code>ã€‚</p>
<p>å½“åœ¨ <a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/#../syntax#environment"><code>environment</code></a> æŒ‡ä»¤ä¸­è®¾ç½®å‡­æ®ç¯å¢ƒå˜é‡æ—¶ï¼š</p>
<pre tabindex="0"><code>environment {
    BITBUCKET_COMMON_CREDS = credentials(&#39;jenkins-bitbucket-common-creds&#39;)
}
</code></pre><p>è¿™å®é™…è®¾ç½®äº†ä¸‹é¢çš„ä¸‰ä¸ªç¯å¢ƒå˜é‡ï¼š</p>
<ul>
<li><code>BITBUCKET_COMMON_CREDS</code> - åŒ…å«ä¸€ä¸ªä»¥å†’å·åˆ†éš”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ ¼å¼ä¸º <code>username:password</code>ã€‚</li>
<li><code>BITBUCKET_COMMON_CREDS_USR</code> - é™„åŠ çš„ä¸€ä¸ªä»…åŒ…å«ç”¨æˆ·åéƒ¨åˆ†çš„å˜é‡ã€‚</li>
<li><code>BITBUCKET_COMMON_CREDS_PSW</code> - é™„åŠ çš„ä¸€ä¸ªä»…åŒ…å«å¯†ç éƒ¨åˆ†çš„å˜é‡ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ­¤å¤„å®šä¹‰ agent çš„ç»†èŠ‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//é¡¶å±‚æµæ°´çº¿å—ä¸­ä½¿ç”¨çš„ environment æŒ‡ä»¤å°†é€‚ç”¨äºæµæ°´çº¿ä¸­çš„æ‰€æœ‰æ­¥éª¤ã€‚ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        BITBUCKET_COMMON_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;jenkins-bitbucket-common-creds&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example stage 1&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> 			<span style="color:#75715e">//åœ¨ä¸€ä¸ª stage ä¸­å®šä¹‰çš„ environment æŒ‡ä»¤åªä¼šå°†ç»™å®šçš„ç¯å¢ƒå˜é‡åº”ç”¨äº stage ä¸­çš„æ­¥éª¤ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                BITBUCKET_COMMON_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;another-credential-id&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example stage 2&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å› æ­¤å¯¹Jenkinsfileåšæ”¹é€ ï¼š</p>
<p><code>jenkins/pipelines/p5.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜„ğŸ‘</span>æ„å»ºæˆåŠŸ<span style="color:#960050;background-color:#1e0010">ğŸ‘ğŸ˜„</span>\n å…³é”®å­—<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy\n é¡¹ç›®åç§°<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n æ„å»ºåœ°å€<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜–âŒ</span>æ„å»ºå¤±è´¥<span style="color:#960050;background-color:#1e0010">âŒğŸ˜–</span>\n å…³é”®å­—<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy\n é¡¹ç›®åç§°<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n æ„å»ºåœ°å€<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="æœ¬ç« å°ç»“-1">æœ¬ç« å°ç»“<a hidden class="anchor" aria-hidden="true" href="#æœ¬ç« å°ç»“-1">#</a></h6>
<p>ä¸Šé¢æˆ‘ä»¬å·²ç»é€šè¿‡Jenkinsfileå®Œæˆäº†æœ€ç®€å•çš„é¡¹ç›®çš„æ„å»ºå’Œéƒ¨ç½²ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥æ€è€ƒç›®å‰çš„æ–¹å¼ï¼š</p>
<ol>
<li>ç›®å‰éƒ½æ˜¯åœ¨é¡¹ç›®çš„å•ä¸€åˆ†æ”¯ä¸‹è¿›è¡Œæ“ä½œï¼Œä¼ä¸šå†…ä¸€èˆ¬ä¼šä½¿ç”¨featureã€developã€releaseã€masterç­‰å¤šä¸ªåˆ†æ”¯æ¥ç®¡ç†æ•´ä¸ªä»£ç æäº¤æµç¨‹ï¼Œå¦‚ä½•æ ¹æ®ä¸åŒçš„åˆ†æ”¯æ¥åšæ„å»ºï¼Ÿ</li>
<li>æ„å»ºè§†å›¾ä¸­å¦‚ä½•åŒºåˆ†ä¸åŒçš„åˆ†æ”¯?</li>
<li>å¦‚ä½•ä¸é…ç½®webhookçš„æ–¹å¼å®ç°æ„å»ºï¼Ÿ</li>
<li>å¦‚ä½•æ ¹æ®ä¸åŒçš„åˆ†æ”¯é€‰æ‹©å‘å¸ƒåˆ°ä¸åŒçš„ç¯å¢ƒ(å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§)ï¼Ÿ</li>
</ol>
<blockquote>
</blockquote>
<h5 id="å¤šåˆ†æ”¯æµæ°´çº¿">å¤šåˆ†æ”¯æµæ°´çº¿<a hidden class="anchor" aria-hidden="true" href="#å¤šåˆ†æ”¯æµæ°´çº¿">#</a></h5>
<p><a href="https://jenkins.io/zh/doc/tutorials/build-a-multibranch-pipeline-project/">å®˜æ–¹ç¤ºä¾‹</a></p>
<p>æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹æµç¨‹ï¼Œå‡å¦‚ä½¿ç”¨developåˆ†æ”¯ä½œä¸ºå¼€å‘åˆ†æ”¯ï¼Œmasteråˆ†æ”¯ä½œä¸ºé›†æˆæµ‹è¯•åˆ†æ”¯ï¼Œçœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨å¤šåˆ†æ”¯æµæ°´çº¿æ¥ç®¡ç†ã€‚</p>
<h6 id="æ¼”ç¤º1å¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨">æ¼”ç¤º1ï¼šå¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º1å¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨">#</a></h6>
<ol>
<li>æäº¤developåˆ†æ”¯ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ git checkout -b develop
</span></span><span style="display:flex;"><span>$ git push --set-upstream origin develop
</span></span></code></pre></div><ol start="2">
<li>
<p>ç¦ç”¨pipelineé¡¹ç›®</p>
</li>
<li>
<p>Jenkinsç«¯åˆ›å»ºå¤šåˆ†æ”¯æµæ°´çº¿é¡¹ç›®</p>
<ul>
<li>å¢åŠ gitåˆ†æ”¯æº</li>
<li>å‘ç°æ ‡ç­¾</li>
<li>æ ¹æ®åç§°è¿‡æ»¤ï¼Œdevelop|master|v.*</li>
<li>é«˜çº§å…‹éš†ï¼Œè®¾ç½®æµ…å…‹éš†</li>
</ul>
</li>
</ol>
<p>ä¿å­˜åï¼Œä¼šè‡ªåŠ¨æ£€ç´¢é¡¹ç›®ä¸­æ‰€æœ‰å­˜åœ¨Jenkinsfileæ–‡ä»¶çš„åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œè‹¥åŒ¹é…æˆ‘ä»¬è®¾ç½®çš„è¿‡æ»¤æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆ™ä¼šæ·»åŠ åˆ°å¤šåˆ†æ”¯çš„æ„å»ºè§†å›¾ä¸­ã€‚æ‰€æœ‰æ·»åŠ åˆ°è§†å›¾ä¸­çš„åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œä¼šé»˜è®¤æ‰§è¡Œä¸€æ¬¡æ„å»ºä»»åŠ¡ã€‚</p>
<h6 id="æ¼”ç¤º2ç¾åŒ–æ¶ˆæ¯é€šçŸ¥å†…å®¹">æ¼”ç¤º2ï¼šç¾åŒ–æ¶ˆæ¯é€šçŸ¥å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º2ç¾åŒ–æ¶ˆæ¯é€šçŸ¥å†…å®¹">#</a></h6>
<ul>
<li>æ·»åŠ æ„å»ºé˜¶æ®µè®°å½•</li>
<li>ä½¿ç”¨markdownæ ¼å¼ï¼Œæ·»åŠ æ„å»ºåˆ†æ”¯æ¶ˆæ¯</li>
</ul>
<p><code>jenkins/pipelines/p6.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜„ğŸ‘</span> æ„å»ºæˆåŠŸ <span style="color:#960050;background-color:#1e0010">ğŸ‘ğŸ˜„</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_BRANCH}   \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜–âŒ</span> æ„å»ºå¤±è´¥ <span style="color:#960050;background-color:#1e0010">âŒğŸ˜–</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_BRANCH}  \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="æ¼”ç¤º3é€šçŸ¥gitlabæ„å»ºçŠ¶æ€">æ¼”ç¤º3ï¼šé€šçŸ¥gitlabæ„å»ºçŠ¶æ€<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º3é€šçŸ¥gitlabæ„å»ºçŠ¶æ€">#</a></h6>
<p>Jenkinsç«¯åšäº†æ„å»ºï¼Œå¯ä»¥é€šè¿‡gitlabé€šè¿‡çš„apiå°†æ„å»ºçŠ¶æ€é€šçŸ¥è¿‡å»ï¼Œä½œä¸ºå¼€å‘äººå‘˜å‘èµ·Merge Requestæˆ–è€…åˆå¹¶Merge Requestçš„ä¾æ®ä¹‹ä¸€ã€‚</p>
<p><em>æ³¨æ„ä¸€å®šè¦æŒ‡å®šgitLabConnection(&lsquo;gitlab&rsquo;)ï¼Œä¸ç„¶æ²¡æ³•è®¤è¯åˆ°Gitlabç«¯</em></p>
<p><code>jenkins/pipelines/p7.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options {
</span></span><span style="display:flex;"><span>		buildDiscarder(logRotator(numToKeepStr<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10&#39;</span>))
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds()
</span></span><span style="display:flex;"><span>		timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 20, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>)
</span></span><span style="display:flex;"><span>		gitLabConnection(<span style="color:#e6db74">&#39;gitlab&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜„ğŸ‘</span> æ„å»ºæˆåŠŸ <span style="color:#960050;background-color:#1e0010">ğŸ‘ğŸ˜„</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜–âŒ</span> æ„å»ºå¤±è´¥ <span style="color:#960050;background-color:#1e0010">âŒğŸ˜–</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}  \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥è®¿é—®gitlabï¼Œç„¶åæ‰¾åˆ°commitè®°å½•ï¼ŒæŸ¥çœ‹åŒæ­¥çŠ¶æ€</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-cicd.jpg" alt=""  />
</p>
<p>æäº¤merge requestï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç›¸å…³çš„ä»»åŠ¡çŠ¶æ€ï¼Œå¯ä»¥ä½œä¸ºé¡¹ç›®owneråˆå¹¶ä»£ç çš„ä¾æ®ä¹‹ä¸€ï¼š</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-merge-request.jpg" alt=""  />
</p>
<h6 id="æœ¬ç« å°èŠ‚">æœ¬ç« å°èŠ‚<a hidden class="anchor" aria-hidden="true" href="#æœ¬ç« å°èŠ‚">#</a></h6>
<p>ä¼˜åŠ¿:</p>
<ul>
<li>æ ¹æ®åˆ†æ”¯å±•ç¤º, è§†å›¾äººæ€§åŒ–</li>
<li>è‡ªåŠ¨æ£€æµ‹å„åˆ†æ”¯çš„å˜æ›´</li>
</ul>
<p>æ€è€ƒï¼š</p>
<ul>
<li>Jenkinsçš„slaveç«¯ï¼Œæ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™å¤„äºé—²ç½®çŠ¶æ€ï¼ŒslaveèŠ‚ç‚¹å¤šçš„è¯é€ æˆèµ„æºæµªè´¹</li>
<li>æ˜¯å¦å¯ä»¥åˆ©ç”¨kubernetesçš„Podæ¥å¯åŠ¨slaveï¼ŒåŠ¨æ€slave podæ¥æ‰§è¡Œæ„å»ºä»»åŠ¡</li>
</ul>
<blockquote>
</blockquote>
<h4 id="å·¥å…·é›†æˆä¸jenkinsfileå®è·µç¯‡">å·¥å…·é›†æˆä¸Jenkinsfileå®è·µç¯‡<a hidden class="anchor" aria-hidden="true" href="#å·¥å…·é›†æˆä¸jenkinsfileå®è·µç¯‡">#</a></h4>
<ol>
<li>Jenkinså¦‚ä½•å¯¹æ¥kubernetesé›†ç¾¤</li>
<li>ä½¿ç”¨kubernetesçš„Pod-Templateæ¥ä½œä¸ºåŠ¨æ€çš„agentæ‰§è¡ŒJenkinsä»»åŠ¡</li>
<li>å¦‚ä½•åˆ¶ä½œagentå®¹å™¨å®ç°ä¸åŒç±»å‹çš„ä¸šåŠ¡çš„é›†æˆ</li>
<li>é›†æˆä»£ç æ‰«æã€dockeré•œåƒè‡ªåŠ¨æ„å»ºã€k8sæœåŠ¡éƒ¨ç½²ã€è‡ªåŠ¨åŒ–æµ‹è¯•</li>
</ol>
<h5 id="é›†æˆkubernetes">é›†æˆKubernetes<a hidden class="anchor" aria-hidden="true" href="#é›†æˆkubernetes">#</a></h5>
<h6 id="æ’ä»¶å®‰è£…åŠé…ç½®">æ’ä»¶å®‰è£…åŠé…ç½®<a hidden class="anchor" aria-hidden="true" href="#æ’ä»¶å®‰è£…åŠé…ç½®">#</a></h6>
<p><a href="https://plugins.jenkins.io/kubernetes/">æ’ä»¶å®˜æ–¹æ–‡æ¡£</a></p>
<ol>
<li>
<p>[ç³»ç»Ÿç®¡ç†] -&gt; [æ’ä»¶ç®¡ç†] -&gt; [æœç´¢kubernetes]-&gt;ç›´æ¥å®‰è£…</p>
<p>è‹¥å®‰è£…å¤±è´¥ï¼Œè¯·å…ˆæ›´æ–°<a href="https://plugins.jenkins.io/bouncycastle-api"> bouncycastle API Plugin</a>å¹¶é‡æ–°å¯åŠ¨Jenkins</p>
</li>
<li>
<p>[ç³»ç»Ÿç®¡ç†] -&gt; [ç³»ç»Ÿé…ç½®] -&gt; [Add a new cloud]</p>
</li>
<li>
<p>é…ç½®åœ°å€ä¿¡æ¯</p>
<ul>
<li>Kubernetes åœ°å€: <a href="https://kubernetes.default">https://kubernetes.default</a>ï¼ˆæˆ–è€…https://172.21.51.67:6443ï¼‰</li>
<li>Kubernetes å‘½åç©ºé—´ï¼šjenkins</li>
<li>æœåŠ¡è¯ä¹¦ä¸ç”¨å†™ï¼ˆæˆ‘ä»¬åœ¨å®‰è£…Jenkinsçš„æ—¶å€™å·²ç»æŒ‡å®šè¿‡serviceAccountï¼‰ï¼Œå‡ä½¿ç”¨é»˜è®¤</li>
<li>è¿æ¥æµ‹è¯•ï¼ŒæˆåŠŸä¼šæç¤ºï¼šConnection test successful</li>
<li>Jenkinsåœ°å€ï¼šhttp://jenkins:8080</li>
<li>Jenkins é€šé“ ï¼šjenkins:50000</li>
</ul>
</li>
<li>
<p>é…ç½®Pod Template</p>
<ul>
<li>åç§°ï¼šjnlp-slave</li>
<li>å‘½åç©ºé—´ï¼šjenkins</li>
<li>æ ‡ç­¾åˆ—è¡¨ï¼šjnlp-slaveï¼Œä½œä¸ºagentçš„labelé€‰æ‹©ç”¨</li>
<li>è¿æ¥ Jenkins çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ ï¼š300ï¼Œè®¾ç½®è¿æ¥jenkinsè¶…æ—¶æ—¶é—´</li>
<li>èŠ‚ç‚¹é€‰æ‹©å™¨ï¼šagent=true</li>
<li>å·¥ä½œç©ºé—´å·ï¼šé€‰æ‹©hostpathï¼Œè®¾ç½®/opt/jenkins_jobs/,æ³¨æ„éœ€è¦è®¾ç½®chown -R 1000:1000 /opt/jenkins_jobs/æƒé™ï¼Œå¦åˆ™Podæ²¡æœ‰æƒé™</li>
</ul>
</li>
</ol>
<h6 id="æ¼”ç¤ºåŠ¨æ€slave-pod">æ¼”ç¤ºåŠ¨æ€slave pod<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤ºåŠ¨æ€slave-pod">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºå‡†å¤‡è¿è¡Œjnlp-slave-agentçš„podçš„èŠ‚ç‚¹æ‰“ä¸Šlabel</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave1 agent=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### å›æ”¾ä¸€æ¬¡å¤šåˆ†æ”¯æµæ°´çº¿developåˆ†æ”¯</span>
</span></span><span style="display:flex;"><span>agent { label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>}
</span></span></code></pre></div><p>æ‰§è¡Œä»»åŠ¡ï¼Œä¼šä¸‹è½½é»˜è®¤çš„jnlp-slaveé•œåƒï¼Œåœ°å€ä¸ºjenkins/inbound-agent:4.3-4ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨k8s-masterèŠ‚ç‚¹æ‹‰å–ä¸‹æ¥è¯¥é•œåƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker pull jenkins/inbound-agent<span style="color:#960050;background-color:#1e0010">:</span>4.3-4
</span></span></code></pre></div><p>ä¿å­˜jenkinsfileæäº¤åï¼Œä¼šå‡ºç°æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬çš„agentå·²ç»ä¸å†æ˜¯å®¿ä¸»æœºï¼Œè€Œæ˜¯Podä¸­çš„å®¹å™¨å†…ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-no-docker-err.png" alt=""  />
</p>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦å°†ç”¨åˆ°çš„å‘½ä»¤è¡Œå·¥å…·é›†æˆåˆ°Podçš„å®¹å™¨å†…ï¼Œä½†æ˜¯æ€è€ƒå¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>ç›®å‰æ˜¯ç”¨çš„jnlpçš„å®¹å™¨ï¼Œæ˜¯javaçš„ç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šéœ€è¦é›†æˆå¾ˆå¤šå·¥å…·ï¼Œèƒ½ä¸èƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œè®©æ–°å®¹å™¨æ¥åšå…·ä½“çš„ä»»åŠ¡ï¼Œjnlp-slaveå®¹å™¨åªç”¨æ¥è´Ÿè´£è¿æ¥jenkins-master</li>
<li>é’ˆå¯¹ä¸åŒçš„æ„å»ºç¯å¢ƒï¼ˆjavaã€pythonã€goã€nodejsï¼‰ï¼Œå¯ä»¥åˆ¶ä½œä¸åŒçš„å®¹å™¨ï¼Œæ¥æ‰§è¡Œå¯¹åº”çš„ä»»åŠ¡</li>
</ul>
<blockquote>
</blockquote>
<h6 id="pod-templateä¸­å®¹å™¨é•œåƒçš„åˆ¶ä½œ">Pod-Templateä¸­å®¹å™¨é•œåƒçš„åˆ¶ä½œ<a hidden class="anchor" aria-hidden="true" href="#pod-templateä¸­å®¹å™¨é•œåƒçš„åˆ¶ä½œ">#</a></h6>
<p>ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªtoolsé•œåƒï¼Œé›†æˆå¸¸ç”¨çš„å·¥å…·ï¼Œæ¥å®Œæˆå¸¸è§çš„æ„å»ºä»»åŠ¡ï¼Œéœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨alpineåŸºç¡€é•œåƒï¼Œè‡ªèº«ä½“ç§¯æ¯”è¾ƒå°</li>
<li>æ›¿æ¢å›½å†…å®‰è£…æº</li>
<li>ä¸ºäº†ä½¿ç”¨dockerï¼Œå®‰è£…äº†docker</li>
<li>ä¸ºäº†å…‹éš†ä»£ç ï¼Œå®‰è£…git</li>
<li>ä¸ºäº†åç»­åšpythonçš„æµ‹è¯•ç­‰ä»»åŠ¡ï¼Œå®‰è£…pythonç¯å¢ƒ</li>
<li>ä¸ºäº†åœ¨å®¹å™¨ä¸­è°ƒç”¨kubectlçš„å‘½ä»¤ï¼Œæ‹·è´äº†kubectlçš„äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>ä¸ºäº†è®¤è¯kubectlï¼Œéœ€è¦åœ¨å®¹å™¨å†…éƒ¨ç”Ÿæˆ.kubeç›®å½•åŠconfigæ–‡ä»¶</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ mkdir tools;
</span></span><span style="display:flex;"><span>$ cd tools;
</span></span><span style="display:flex;"><span>$ cp `which kubectl` .
</span></span><span style="display:flex;"><span>$ cp ~/.kube/config .
</span></span></code></pre></div><p><em>Dockerfile</em></p>
<p><code>jenkins/custom-images/tools/Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> maintainer<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> root</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add  --no-cache openrc docker git curl tar gcc g++ make <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    libstdc++ harfbuzz nss freetype ttf-freefont <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir -p /root/.kube <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    usermod -a -G docker root<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> config /root/.kube/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf /var/cache/apk/* <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#-----------------å®‰è£… kubectl--------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> kubectl /usr/local/bin/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /usr/local/bin/kubectl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>æ‰§è¡Œé•œåƒæ„å»ºå¹¶æ¨é€åˆ°ä»“åº“ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥é•œåƒåšæµ‹è¯•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## å¯åŠ¨ä¸´æ—¶é•œåƒåšæµ‹è¯•</span>
</span></span><span style="display:flex;"><span>$ docker run --rm -ti 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1 bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / git clone http://xxxxxx.git</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / kubectl get no</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/ docker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## é‡æ–°æŒ‚è½½dockerçš„sockæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>docker run -v /var/run/docker.sock<span style="color:#960050;background-color:#1e0010">:</span>/var/run/docker.sock --rm -ti 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1 bash
</span></span></code></pre></div><h6 id="å®è·µé€šè¿‡jenkinsfileå®ç°demoé¡¹ç›®è‡ªåŠ¨å‘å¸ƒåˆ°kubenetesç¯å¢ƒ">å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®è‡ªåŠ¨å‘å¸ƒåˆ°kubenetesç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#å®è·µé€šè¿‡jenkinsfileå®ç°demoé¡¹ç›®è‡ªåŠ¨å‘å¸ƒåˆ°kubenetesç¯å¢ƒ">#</a></h6>
<p>æ›´æ–°Jenkinsä¸­çš„PodTemplateï¼Œæ·»åŠ toolsé•œåƒï¼Œæ³¨æ„åŒæ—¶è¦å…ˆæ·»åŠ åä¸ºjnlpçš„containerï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„PodTemplateè¦†ç›–æ‰é»˜è®¤çš„æ¨¡æ¿ï¼š</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/pod-template-jnlp.jpg" alt=""  />
</p>
<p>åœ¨å·æ ç›®ï¼Œæ·»åŠ å·ï¼ŒHost Path Volumeï¼Œä¸ç„¶åœ¨å®¹å™¨ä¸­ä½¿ç”¨dockerä¼šæç¤ºdockeræœåŠ¡æœªå¯åŠ¨</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-docker-sock.png" alt=""  />
</p>
<p>toolså®¹å™¨åšå¥½åï¼Œæˆ‘ä»¬éœ€è¦å¯¹Jenkinsfileåšå¦‚ä¸‹è°ƒæ•´ï¼š</p>
<p><code>jenkins/pipelines/p8.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options {
</span></span><span style="display:flex;"><span>		buildDiscarder(logRotator(numToKeepStr<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10&#39;</span>))
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds()
</span></span><span style="display:flex;"><span>		timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 20, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>)
</span></span><span style="display:flex;"><span>		gitLabConnection(<span style="color:#e6db74">&#39;gitlab&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                    timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜„ğŸ‘</span> æ„å»ºæˆåŠŸ <span style="color:#960050;background-color:#1e0010">ğŸ‘ğŸ˜„</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜–âŒ</span> æ„å»ºå¤±è´¥ <span style="color:#960050;background-color:#1e0010">âŒğŸ˜–</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}  \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
</blockquote>
<h5 id="é›†æˆsonarqubeå®ç°ä»£ç æ‰«æ">é›†æˆsonarQubeå®ç°ä»£ç æ‰«æ<a hidden class="anchor" aria-hidden="true" href="#é›†æˆsonarqubeå®ç°ä»£ç æ‰«æ">#</a></h5>
<p>Sonarå¯ä»¥ä»ä»¥ä¸‹ä¸ƒä¸ªç»´åº¦æ£€æµ‹ä»£ç è´¨é‡ï¼Œè€Œä½œä¸ºå¼€å‘äººå‘˜è‡³å°‘éœ€è¦å¤„ç†å‰5ç§ä»£ç è´¨é‡é—®é¢˜ã€‚</p>
<ol>
<li>ä¸éµå¾ªä»£ç æ ‡å‡†
sonarå¯ä»¥é€šè¿‡PMD,CheckStyle,Findbugsç­‰ç­‰ä»£ç è§„åˆ™æ£€æµ‹å·¥å…·è§„èŒƒä»£ç ç¼–å†™ã€‚</li>
<li>æ½œåœ¨çš„ç¼ºé™·
sonarå¯ä»¥é€šè¿‡PMD,CheckStyle,Findbugsç­‰ç­‰ä»£ç è§„åˆ™æ£€æµ‹å·¥å…·æ£€ æµ‹å‡ºæ½œåœ¨çš„ç¼ºé™·ã€‚</li>
<li>ç³Ÿç³•çš„å¤æ‚åº¦åˆ†å¸ƒ
æ–‡ä»¶ã€ç±»ã€æ–¹æ³•ç­‰ï¼Œå¦‚æœå¤æ‚åº¦è¿‡é«˜å°†éš¾ä»¥æ”¹å˜ï¼Œè¿™ä¼šä½¿å¾—å¼€å‘äººå‘˜ éš¾ä»¥ç†è§£å®ƒä»¬, ä¸”å¦‚æœæ²¡æœ‰è‡ªåŠ¨åŒ–çš„å•å…ƒæµ‹è¯•ï¼Œå¯¹äºç¨‹åºä¸­çš„ä»»ä½•ç»„ä»¶çš„æ”¹å˜éƒ½å°†å¯èƒ½å¯¼è‡´éœ€è¦å…¨é¢çš„å›å½’æµ‹è¯•ã€‚</li>
<li>é‡å¤
æ˜¾ç„¶ç¨‹åºä¸­åŒ…å«å¤§é‡å¤åˆ¶ç²˜è´´çš„ä»£ç æ˜¯è´¨é‡ä½ä¸‹çš„ï¼Œsonarå¯ä»¥å±•ç¤º æºç ä¸­é‡å¤ä¸¥é‡çš„åœ°æ–¹ã€‚</li>
<li>æ³¨é‡Šä¸è¶³æˆ–è€…è¿‡å¤š
æ²¡æœ‰æ³¨é‡Šå°†ä½¿ä»£ç å¯è¯»æ€§å˜å·®ï¼Œç‰¹åˆ«æ˜¯å½“ä¸å¯é¿å…åœ°å‡ºç°äººå‘˜å˜åŠ¨ æ—¶ï¼Œç¨‹åºçš„å¯è¯»æ€§å°†å¤§å¹…ä¸‹é™ è€Œè¿‡å¤šçš„æ³¨é‡Šåˆä¼šä½¿å¾—å¼€å‘äººå‘˜å°†ç²¾åŠ›è¿‡å¤šåœ°èŠ±è´¹åœ¨é˜…è¯»æ³¨é‡Šä¸Šï¼Œäº¦è¿èƒŒåˆè¡·ã€‚</li>
<li>ç¼ºä¹å•å…ƒæµ‹è¯•
sonarå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»Ÿè®¡å¹¶å±•ç¤ºå•å…ƒæµ‹è¯•è¦†ç›–ç‡ã€‚</li>
<li>ç³Ÿç³•çš„è®¾è®¡
é€šè¿‡sonarå¯ä»¥æ‰¾å‡ºå¾ªç¯ï¼Œå±•ç¤ºåŒ…ä¸åŒ…ã€ç±»ä¸ç±»ä¹‹é—´çš„ç›¸äº’ä¾èµ–å…³ç³»ï¼Œå¯ä»¥æ£€æµ‹è‡ªå®šä¹‰çš„æ¶æ„è§„åˆ™ é€šè¿‡sonarå¯ä»¥ç®¡ç†ç¬¬ä¸‰æ–¹çš„jaråŒ…ï¼Œå¯ä»¥åˆ©ç”¨LCOM4æ£€æµ‹å•ä¸ªä»»åŠ¡è§„åˆ™çš„åº”ç”¨æƒ…å†µï¼Œ æ£€æµ‹è€¦åˆã€‚</li>
</ol>
<h6 id="sonarqubeæ¶æ„ç®€ä»‹">sonarqubeæ¶æ„ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#sonarqubeæ¶æ„ç®€ä»‹">#</a></h6>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/sonarqube.webp" alt=""  />
</p>
<ol>
<li>CSæ¶æ„
<ul>
<li>sonarqube scanner</li>
<li>sonarqube server</li>
</ul>
</li>
<li>SonarQube Scanner æ‰«æä»ªåœ¨æœ¬åœ°æ‰§è¡Œä»£ç æ‰«æä»»åŠ¡</li>
<li>æ‰§è¡Œå®Œåï¼Œå°†åˆ†ææŠ¥å‘Šè¢«å‘é€åˆ°SonarQubeæœåŠ¡å™¨è¿›è¡Œå¤„ç†</li>
<li>SonarQubeæœåŠ¡å™¨å¤„ç†å’Œå­˜å‚¨åˆ†ææŠ¥å‘Šå¯¼è‡´SonarQubeæ•°æ®åº“ï¼Œå¹¶æ˜¾ç¤ºç»“æœåœ¨UIä¸­</li>
</ol>
<h6 id="sonarqube-on-kubernetesç¯å¢ƒæ­å»º">sonarqube on kubernetesç¯å¢ƒæ­å»º<a hidden class="anchor" aria-hidden="true" href="#sonarqube-on-kubernetesç¯å¢ƒæ­å»º">#</a></h6>
<ol>
<li>èµ„æºæ–‡ä»¶å‡†å¤‡</li>
</ol>
<p><code>sonar/sonar.yaml</code></p>
<ul>
<li>å’Œgitlabå…±äº«postgresæ•°æ®åº“</li>
<li>ä½¿ç”¨ingressåœ°å€ <code>sonar.luffy.com</code> è¿›è¡Œè®¿é—®</li>
<li>ä½¿ç”¨initContainersè¿›è¡Œç³»ç»Ÿå‚æ•°è°ƒæ•´</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">sonar</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/sbin/sysctl</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">w</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">vm.max_map_count=262144</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">alpine:3.6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">elasticsearch-logging-init</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>: {}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/sonarqube:7.9-community</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SONARQUBE_JDBC_USERNAME</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gitlab-secret</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">postgres.user.root</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SONARQUBE_JDBC_PASSWORD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gitlab-secret</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">postgres.pwd.root</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SONARQUBE_JDBC_URL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;jdbc:postgresql://postgres:5432/sonar&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/sessions/new</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/sessions/new</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">2000m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">4096Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">300m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">512Mi</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">sonar.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><ol start="2">
<li>
<p>sonarqubeæœåŠ¡ç«¯å®‰è£…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºsonaræ•°æ®åº“</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins exec -ti postgres-5859dc6f58-mgqz9 bash
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/ psql </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create database sonar;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## åˆ›å»ºsonarqubeæœåŠ¡å™¨</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> sonar.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## é…ç½®æœ¬åœ°hostsè§£æ</span>
</span></span><span style="display:flex;"><span>172.21.51.67 sonar.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## è®¿é—®sonarqubeï¼Œåˆå§‹ç”¨æˆ·åå¯†ç ä¸º admin/admin</span>
</span></span><span style="display:flex;"><span>$ curl http<span style="color:#960050;background-color:#1e0010">:</span>//sonar.luffy.com
</span></span></code></pre></div></li>
<li>
<p>sonar-scannerçš„å®‰è£…</p>
<p>ä¸‹è½½åœ°å€ï¼š <a href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zip">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zip</a>ã€‚è¯¥åœ°å€æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥åœ¨ç½‘ç›˜ä¸‹è½½ï¼ˆhttps://pan.baidu.com/s/1SiEhWyHikTiKl5lEMX1tJg æå–ç : tqb9ï¼‰ã€‚</p>
</li>
<li>
<p>æ¼”ç¤ºsonarä»£ç æ‰«æåŠŸèƒ½</p>
<ul>
<li>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­å‡†å¤‡é…ç½®æ–‡ä»¶ <strong>sonar-project.properties</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>sonar.projectKey=myblog
</span></span><span style="display:flex;"><span>sonar.projectName=myblog
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if you want disabled the DTD verification for a proxy problem for example, true by default</span>
</span></span><span style="display:flex;"><span>sonar.coverage.dtdVerification=false
</span></span><span style="display:flex;"><span><span style="color:#75715e"># JUnit like test report, default value is test.xml</span>
</span></span><span style="display:flex;"><span>sonar.sources=blog,myblog
</span></span></code></pre></div></li>
<li>
<p>é…ç½®sonarqubeæœåŠ¡å™¨åœ°å€</p>
<p>ç”±äºsonar-scanneréœ€è¦å°†æ‰«æç»“æœä¸ŠæŠ¥ç»™sonarqubeæœåŠ¡å™¨åšè´¨é‡åˆ†æï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨sonar-scannerä¸­é…ç½®sonarqubeçš„æœåŠ¡å™¨åœ°å€ï¼š</p>
<p>åœ¨é›†ç¾¤å®¿ä¸»æœºä¸­æµ‹è¯•ï¼Œå…ˆé…ç½®ä¸€ä¸‹hostsæ–‡ä»¶ï¼Œç„¶åé…ç½®sonarçš„åœ°å€ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat /etc/hosts
</span></span><span style="display:flex;"><span>172.21.51.67  sonar.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat sonar-scanner/conf/sonar-scanner.properties
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default SonarQube server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sonar.host.url=http://localhost:9000</span>
</span></span><span style="display:flex;"><span>sonar.host.url=http<span style="color:#960050;background-color:#1e0010">:</span>//sonar.luffy.com
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default source code encoding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sonar.sourceEncoding=UTF-8</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
<pre tabindex="0"><code> 
- ä¸ºäº†ä½¿æ‰€æœ‰çš„podéƒ½å¯ä»¥é€šè¿‡`sonar.luffy.com`è®¿é—®ï¼Œå¯ä»¥é…ç½®corednsçš„é™æ€è§£æ
 
   ```powershell
           hosts {
               172.21.51.67 jenkins.luffy.com gitlab.luffy.com sonar.luffy.com
               fallthrough
        }
</code></pre><ul>
<li>
<p>æ‰§è¡Œæ‰«æ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>$ /opt/sonar-scanner-4.0.0.1744-linux/bin/sonar-scanner  -X 
</span></span></code></pre></div></li>
<li>
<p>sonarqubeç•Œé¢æŸ¥çœ‹ç»“æœ</p>
<p>ç™»å½•sonarqubeç•Œé¢æŸ¥çœ‹ç»“æœï¼ŒQuality Gatesè¯´æ˜</p>
</li>
</ul>
<h6 id="æ’ä»¶å®‰è£…åŠé…ç½®-1">æ’ä»¶å®‰è£…åŠé…ç½®<a hidden class="anchor" aria-hidden="true" href="#æ’ä»¶å®‰è£…åŠé…ç½®-1">#</a></h6>
<ol>
<li>
<p>é›†æˆåˆ°toolså®¹å™¨ä¸­</p>
<p>ç”±äºæˆ‘ä»¬çš„ä»£ç æ‹‰å–ã€æ„å»ºä»»åŠ¡å‡æ˜¯åœ¨toolså®¹å™¨ä¸­è¿›è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠscanneré›†æˆåˆ°æˆ‘ä»¬çš„toolså®¹å™¨ä¸­ï¼Œåˆå› ä¸ºscanneræ˜¯ä¸€ä¸ªcliå®¢æˆ·ç«¯ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æŠŠåŒ…è§£å‹å¥½ï¼Œæ‹·è´åˆ°toolså®¹å™¨å†…éƒ¨ï¼Œé…ç½®ä¸€ä¸‹PATHè·¯å¾„å³å¯ï¼Œæ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ul>
<li>
<p>ç›´æ¥åœ¨åœ¨toolsé•œåƒä¸­é…ç½®<code>http://sonar.luffy.com</code></p>
</li>
<li>
<p>ç”±äºtoolså·²ç»é›†æˆäº†javaç¯å¢ƒï¼Œå› æ­¤å¯ä»¥ç›´æ¥å‰”é™¤scannerè‡ªå¸¦çš„jre</p>
<ul>
<li>
<p>åˆ æ‰sonar-scanner/jreç›®å½•</p>
</li>
<li>
<p>ä¿®æ”¹sonar-scanner/bin/sonar-scanner</p>
<p><code>use_embedded_jre=false</code></p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cd tools
</span></span><span style="display:flex;"><span>$ cp -r /opt/sonar-scanner-4.0.0.1744-linux/ sonar-scanner
</span></span><span style="display:flex;"><span><span style="color:#75715e">## sonaré…ç½®ï¼Œç”±äºæˆ‘ä»¬æ˜¯åœ¨Podä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®ï¼šsonar.host.url=http://sonarqube:9000</span>
</span></span><span style="display:flex;"><span>$ cat sonar-scanner/conf/sonar-scanner.properties
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default SonarQube server</span>
</span></span><span style="display:flex;"><span>sonar.host.url=http<span style="color:#960050;background-color:#1e0010">:</span>//sonar.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default source code encoding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sonar.sourceEncoding=UTF-8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rm -rf sonar-scanner/jre
</span></span><span style="display:flex;"><span>$ vi sonar-scanner/bin/sonar-scanner
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>use_embedded_jre=false
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><em>Dockerfile</em></p>
<p><code>jenkins/custom-images/tools/Dockerfile2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> maintainer<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> root</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add  --no-cache openrc docker git curl tar gcc g++ make <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    libstdc++ harfbuzz nss freetype ttf-freefont <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir -p /root/.kube <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    usermod -a -G docker root<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> config /root/.kube/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf /var/cache/apk/*<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#-----------------å®‰è£… kubectl--------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> kubectl /usr/local/bin/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /usr/local/bin/kubectl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#---------------å®‰è£… sonar-scanner-----------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> sonar-scanner /usr/lib/sonar-scanner<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/sonar-scanner<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> SONAR_RUNNER_HOME<span style="color:#f92672">=</span>/usr/lib/sonar-scanner<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div></li>
</ol>
<p>é‡æ–°æ„å»ºé•œåƒï¼Œå¹¶æ¨é€åˆ°ä»“åº“ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>   $ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v2
</span></span><span style="display:flex;"><span>   $ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v2
</span></span><span style="display:flex;"><span>   
</span></span></code></pre></div><ol start="2">
<li>
<p>ä¿®æ”¹Jenkins PodTemplate</p>
<p>ä¸ºäº†åœ¨æ–°çš„æ„å»ºä»»åŠ¡ä¸­å¯ä»¥æ‹‰å–v2ç‰ˆæœ¬çš„toolsé•œåƒï¼Œéœ€è¦æ›´æ–°PodTemplate</p>
</li>
<li>
<p>å®‰è£…å¹¶é…ç½®sonaræ’ä»¶</p>
<p>ç”±äºsonarqubeçš„æ‰«æçš„ç»“æœéœ€è¦è¿›è¡ŒQuality Gatesçš„æ£€æµ‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å®¹å™¨ä¸­æ‰§è¡Œå®Œä»£ç æ‰«æä»»åŠ¡åï¼Œå¦‚ä½•çŸ¥é“æœ¬æ¬¡æ‰«ææ˜¯å¦é€šè¿‡äº†Quality Gatesï¼Œé‚£ä¹ˆå°±éœ€è¦å€ŸåŠ©äºsonarqubeå®ç°çš„jenkinsçš„æ’ä»¶ã€‚</p>
<ul>
<li>
<p>å®‰è£…æ’ä»¶</p>
<p>æ’ä»¶ä¸­å¿ƒæœç´¢sonarqubeï¼Œç›´æ¥å®‰è£…</p>
</li>
<li>
<p>é…ç½®æ’ä»¶</p>
<p>ç³»ç»Ÿç®¡ç†-&gt;ç³»ç»Ÿé…ç½®-&gt; <strong>SonarQube servers</strong> -&gt;Add SonarQube</p>
<ul>
<li>
<p>Nameï¼šsonarqube</p>
</li>
<li>
<p>Server URLï¼šhttp://sonar.luffy.com</p>
</li>
<li>
<p>Server authentication token</p>
<p>â‘  ç™»å½•sonarqube -&gt; My Account -&gt; Security -&gt; Generate Token</p>
<p>â‘¡ ç™»å½•Jenkinsï¼Œæ·»åŠ å…¨å±€å‡­æ®ï¼Œç±»å‹ä¸ºSecret text</p>
</li>
</ul>
</li>
<li>
<p>å¦‚ä½•åœ¨jenkinsfileä¸­ä½¿ç”¨</p>
<p>æˆ‘ä»¬åœ¨ <a href="https://jenkins.io/doc/pipeline/steps/sonar/">https://jenkins.io/doc/pipeline/steps/sonar/</a> å®˜æ–¹ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
</li>
</ul>
</li>
</ol>
<h6 id="jenkinsfileé›†æˆsonarqubeæ¼”ç¤º">Jenkinsfileé›†æˆsonarqubeæ¼”ç¤º<a hidden class="anchor" aria-hidden="true" href="#jenkinsfileé›†æˆsonarqubeæ¼”ç¤º">#</a></h6>
<p><code>jenkins/pipelines/p9.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		buildDiscarder<span style="color:#f92672">(</span>logRotator<span style="color:#f92672">(</span>numToKeepStr: <span style="color:#e6db74">&#39;10&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TAB_STR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;git-log&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">GIT_LOG</span> <span style="color:#f92672">=</span> readFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;gitlog.file&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>        
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;âˆš...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            withSonarQubeEnv<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                sh <span style="color:#e6db74">&#39;sonar-scanner -X&#39;</span>
</span></span><span style="display:flex;"><span>                                sleep <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                timeout<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">def</span> qg <span style="color:#f92672">=</span> waitForQualityGate<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>qg<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;OK&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                        error <span style="color:#e6db74">&#34;æœªé€šè¿‡Sonarqubeçš„ä»£ç è´¨é‡é˜ˆæ£€æŸ¥ï¼Œè¯·åŠæ—¶ä¿®æ”¹ï¼failure: ${qg.status}&#34;</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    retry<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">+=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;âˆš...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;push-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    retry<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">+=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;âˆš...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                    timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">+=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;âˆš...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;markdown&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;title&#34;:&#34;myblog&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: &#34;ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„  \n**é¡¹ç›®åç§°**ï¼šluffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;markdown&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;title&#34;:&#34;myblog&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: &#34;ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜–  \n**é¡¹ç›®åç§°**ï¼šluffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}  \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
</blockquote>
<h5 id="é›†æˆrobotframeworkå®ç°éªŒæ”¶æµ‹è¯•">é›†æˆRobotFrameworkå®ç°éªŒæ”¶æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#é›†æˆrobotframeworkå®ç°éªŒæ”¶æµ‹è¯•">#</a></h5>
<p>ä¸€ä¸ªåŸºäºPythonè¯­è¨€ï¼Œç”¨äºéªŒæ”¶æµ‹è¯•å’ŒéªŒæ”¶æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆATDDï¼‰çš„é€šç”¨æµ‹è¯•è‡ªåŠ¨åŒ–æ¡†æ¶ï¼Œæä¾›äº†ä¸€å¥—ç‰¹å®šçš„è¯­æ³•ï¼Œå¹¶ä¸”æœ‰éå¸¸ä¸°å¯Œçš„æµ‹è¯•åº“ ã€‚</p>
<h6 id="robotç”¨ä¾‹ç®€ä»‹">robotç”¨ä¾‹ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#robotç”¨ä¾‹ç®€ä»‹">#</a></h6>
<p><code>robot/robot.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*** Settings ***
</span></span><span style="display:flex;"><span>Library           RequestsLibrary
</span></span><span style="display:flex;"><span>Library           SeleniumLibrary
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*** Variables ***
</span></span><span style="display:flex;"><span>${demo_url}       http<span style="color:#960050;background-color:#1e0010">:</span>//myblog.luffy/admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*** Test Cases ***
</span></span><span style="display:flex;"><span>api
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[Tags]</span>  critical
</span></span><span style="display:flex;"><span>    Create Session    api    ${demo_url}
</span></span><span style="display:flex;"><span>    ${alarm_system_info}    RequestsLibrary.Get Request    api    /
</span></span><span style="display:flex;"><span>    log    ${alarm_system_info.status_code}
</span></span><span style="display:flex;"><span>    log    ${alarm_system_info.content}
</span></span><span style="display:flex;"><span>    should be true    ${alarm_system_info.status_code} == 200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ui
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[Tags]</span>  critical
</span></span><span style="display:flex;"><span>    ${chrome_options} =     Evaluate    sys.modules[<span style="color:#e6db74">&#39;selenium.webdriver&#39;</span>].ChromeOptions()    sys, selenium.webdriver
</span></span><span style="display:flex;"><span>    Call Method    ${chrome_options}   add_argument    headless
</span></span><span style="display:flex;"><span>    Call Method    ${chrome_options}   add_argument    no-sandbox
</span></span><span style="display:flex;"><span>    ${options}=     Call Method     ${chrome_options}    to_capabilities
</span></span><span style="display:flex;"><span>    Open Browser    ${demo_url}/    browser=chrome       desired_capabilities=${options}
</span></span><span style="display:flex;"><span>    sleep    2s
</span></span><span style="display:flex;"><span>    Capture Page Screenshot
</span></span><span style="display:flex;"><span>    Page Should Contain    Django
</span></span><span style="display:flex;"><span>    close browser
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨toolsé•œåƒå¯åŠ¨å®¹å™¨ï¼Œæ¥éªŒè¯æ‰‹åŠ¨ä½¿ç”¨robotframeworkæ¥åšéªŒæ”¶æµ‹è¯•</span>
</span></span><span style="display:flex;"><span>$ docker run --rm -ti 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v2 bash
</span></span><span style="display:flex;"><span>bash-5.0<span style="color:#75715e"># apk add chromium chromium-chromedriver</span>
</span></span><span style="display:flex;"><span>$ cat requirements.txt
</span></span><span style="display:flex;"><span>robotframework
</span></span><span style="display:flex;"><span>robotframework-seleniumlibrary
</span></span><span style="display:flex;"><span>robotframework-databaselibrary
</span></span><span style="display:flex;"><span>robotframework-requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pipå®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…</span>
</span></span><span style="display:flex;"><span>$ pip install -i http<span style="color:#960050;background-color:#1e0010">:</span>//mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ä½¿ç”¨robotå‘½ä»¤åšæµ‹è¯•</span>
</span></span><span style="display:flex;"><span>$ robot -d artifacts/ robot.txt
</span></span></code></pre></div><h6 id="ä¸toolså·¥å…·é•œåƒé›†æˆ">ä¸toolså·¥å…·é•œåƒé›†æˆ<a hidden class="anchor" aria-hidden="true" href="#ä¸toolså·¥å…·é•œåƒé›†æˆ">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>FROM alpine
</span></span><span style="display:flex;"><span>LABEL maintainer=<span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span>
</span></span><span style="display:flex;"><span>USER root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN sed -i <span style="color:#e6db74">&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/apk/repositories &amp;&amp; \
</span></span><span style="display:flex;"><span>    apk update &amp;&amp; \
</span></span><span style="display:flex;"><span>    apk add  --no-cache openrc docker git curl tar gcc g++ make \
</span></span><span style="display:flex;"><span>    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \
</span></span><span style="display:flex;"><span>    libstdc++ harfbuzz nss freetype ttf-freefont chromium chromium-chromedriver &amp;&amp; \
</span></span><span style="display:flex;"><span>    mkdir -p /root/.kube &amp;&amp; \
</span></span><span style="display:flex;"><span>    usermod -a -G docker root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY config /root/.kube/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY requirements.txt /
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN pip install -i http<span style="color:#960050;background-color:#1e0010">:</span>//mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN rm -rf /var/cache/apk/* &amp;&amp; \
</span></span><span style="display:flex;"><span>    rm -rf ~/.cache/pip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-----------------å®‰è£… kubectl--------------------#</span>
</span></span><span style="display:flex;"><span>COPY kubectl /usr/local/bin/
</span></span><span style="display:flex;"><span>RUN chmod +x /usr/local/bin/kubectl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#---------------å®‰è£… sonar-scanner-----------------#</span>
</span></span><span style="display:flex;"><span>COPY sonar-scanner /usr/lib/sonar-scanner
</span></span><span style="display:flex;"><span>RUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner &amp;&amp; chmod +x /usr/local/bin/sonar-scanner
</span></span><span style="display:flex;"><span>ENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------#</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v3
</span></span></code></pre></div><p>æ›´æ–°Jenkinsä¸­kubernetesä¸­çš„containers template</p>
<h6 id="æ’ä»¶å®‰è£…åŠé…ç½®-2">æ’ä»¶å®‰è£…åŠé…ç½®<a hidden class="anchor" aria-hidden="true" href="#æ’ä»¶å®‰è£…åŠé…ç½®-2">#</a></h6>
<p>ä¸ºä»€ä¹ˆè¦å®‰è£…robotæ’ä»¶ï¼Ÿ</p>
<ol>
<li>
<p>å®‰è£…robotFramework</p>
<ul>
<li>æ’ä»¶ä¸­å¿ƒæœç´¢robotframeworkï¼Œç›´æ¥å®‰è£…</li>
<li>toolsé›†æˆrobotå‘½ä»¤ï¼ˆä¹‹å‰å·²ç»å®‰è£…ï¼‰</li>
</ul>
</li>
<li>
<p>ä¸jenkinsfileçš„é›†æˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>    container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#39;robot -i critical  -d artifacts/ robot.txt || echo ok&#39;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>        step<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>            $class <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;RobotPublisher&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            outputPath: <span style="color:#e6db74">&#39;artifacts/&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            outputFileName <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;output.xml&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            disableArchiveOutput <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            passThreshold <span style="color:#f92672">:</span> <span style="color:#ae81ff">80</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            unstableThreshold: <span style="color:#ae81ff">20.0</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            onlyCritical <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            otherFiles <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>        archiveArtifacts artifacts: <span style="color:#e6db74">&#39;artifacts/*&#39;</span><span style="color:#f92672">,</span> fingerprint: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h6 id="å®è·µé€šè¿‡jenkinsfileå®ç°demoé¡¹ç›®çš„éªŒæ”¶æµ‹è¯•">å®è·µé€šè¿‡Jenkinsfileå®ç°demoé¡¹ç›®çš„éªŒæ”¶æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#å®è·µé€šè¿‡jenkinsfileå®ç°demoé¡¹ç›®çš„éªŒæ”¶æµ‹è¯•">#</a></h6>
<p>python-demoé¡¹ç›®æ·»åŠ robot.txtæ–‡ä»¶ï¼š</p>
<p><code>jenkins/pipelines/p10.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options {
</span></span><span style="display:flex;"><span>		buildDiscarder(logRotator(numToKeepStr<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10&#39;</span>))
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds()
</span></span><span style="display:flex;"><span>		timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 20, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>)
</span></span><span style="display:flex;"><span>		gitLabConnection(<span style="color:#e6db74">&#39;gitlab&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;git-log&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }        
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;CI&#39;</span>){
</span></span><span style="display:flex;"><span>            failFast true
</span></span><span style="display:flex;"><span>            parallel {
</span></span><span style="display:flex;"><span>                stage(<span style="color:#e6db74">&#39;Unit Test&#39;</span>) {
</span></span><span style="display:flex;"><span>                    steps {
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                stage(<span style="color:#e6db74">&#39;Code Scan&#39;</span>) {
</span></span><span style="display:flex;"><span>                    steps {
</span></span><span style="display:flex;"><span>                        container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                            withSonarQubeEnv(<span style="color:#e6db74">&#39;sonarqube&#39;</span>) {
</span></span><span style="display:flex;"><span>                                sh <span style="color:#e6db74">&#39;sonar-scanner -X&#39;</span>
</span></span><span style="display:flex;"><span>                                sleep 3
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            script {
</span></span><span style="display:flex;"><span>                                timeout(1) {
</span></span><span style="display:flex;"><span>                                    def qg = waitForQualityGate(<span style="color:#e6db74">&#39;sonarqube&#39;</span>)
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">if</span> (qg.status != <span style="color:#e6db74">&#39;OK&#39;</span>) {
</span></span><span style="display:flex;"><span>                                        error <span style="color:#e6db74">&#34;æœªé€šè¿‡Sonarqubeçš„ä»£ç è´¨é‡é˜ˆæ£€æŸ¥ï¼Œè¯·åŠæ—¶ä¿®æ”¹ï¼failure: ${qg.status}&#34;</span>
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                    timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/;sleep 20;&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;âˆš...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;Accept Test&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                    container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;robot -i critical  -d artifacts/ robot.txt|| echo ok&#39;</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>                        step([
</span></span><span style="display:flex;"><span>                            $class <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;RobotPublisher&#39;</span>,
</span></span><span style="display:flex;"><span>                            outputPath<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;artifacts/&#39;</span>,
</span></span><span style="display:flex;"><span>                            outputFileName <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;output.xml&#34;</span>,
</span></span><span style="display:flex;"><span>                            disableArchiveOutput <span style="color:#960050;background-color:#1e0010">:</span> false,
</span></span><span style="display:flex;"><span>                            passThreshold <span style="color:#960050;background-color:#1e0010">:</span> 80,
</span></span><span style="display:flex;"><span>                            unstableThreshold<span style="color:#960050;background-color:#1e0010">:</span> 20.0,
</span></span><span style="display:flex;"><span>                            onlyCritical <span style="color:#960050;background-color:#1e0010">:</span> true,
</span></span><span style="display:flex;"><span>                            otherFiles <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>                        ])
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>                        archiveArtifacts artifacts<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;artifacts/*&#39;</span>, fingerprint<span style="color:#960050;background-color:#1e0010">:</span> true
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜„ğŸ‘</span> æ„å»ºæˆåŠŸ <span style="color:#960050;background-color:#1e0010">ğŸ‘ğŸ˜„</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">ğŸ˜–âŒ</span> æ„å»ºå¤±è´¥ <span style="color:#960050;background-color:#1e0010">âŒğŸ˜–</span>  \n**é¡¹ç›®åç§°**<span style="color:#960050;background-color:#1e0010">ï¼š</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}  \n**æ„å»ºåœ°å€**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**<span style="color:#960050;background-color:#1e0010">ï¼š</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨Jenkinsä¸­æŸ¥çœ‹robotçš„æ„å»ºç»“æœã€‚</p>
<blockquote>
</blockquote>
<h4 id="å°ç»“">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“">#</a></h4>
<p>æ€è·¯ï¼š</p>
<ol>
<li>è®²è§£æœ€åŸºç¡€çš„Jenkinsçš„ä½¿ç”¨</li>
<li>Pipelineæµæ°´çº¿çš„ä½¿ç”¨</li>
<li>Jenkinsfileçš„ä½¿ç”¨</li>
<li>å¤šåˆ†æ”¯æµæ°´çº¿çš„ä½¿ç”¨</li>
<li>ä¸Kubernetesé›†æˆï¼ŒåŠ¨æ€jnlp slave podçš„ä½¿ç”¨</li>
<li>ä¸sonarqubeé›†æˆï¼Œå®ç°ä»£ç æ‰«æ</li>
<li>ä¸Robotframeworké›†æˆï¼Œå®ç°éªŒæ”¶æµ‹è¯•</li>
</ol>
<p>é—®é¢˜ï¼š</p>
<ol>
<li>Jenkinsfileè¿‡äºå†—é•¿</li>
<li>å¤šä¸ªé¡¹ç›®é…ç½®Jenkinsfileï¼Œå­˜åœ¨å¾ˆå¤šé‡å¤å†…å®¹</li>
<li>æ²¡æœ‰å®ç°æ ¹æ®ä¸åŒåˆ†æ”¯æ¥éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒ</li>
<li>Javaé¡¹ç›®çš„æ„å»º</li>
<li>k8séƒ¨ç½²åï¼Œé‡‡ç”¨ç­‰å¾…çš„æ–¹å¼æ‰§è¡Œåç»­æ­¥éª¤ï¼Œä¸åˆç†</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>åŸºäºsharedLibraryè¿›è¡ŒCICDæµç¨‹çš„ä¼˜åŒ–</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/linux-iowait%E9%AB%98%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%8F%8A%E5%A4%84%E7%90%86/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Linux iowaité«˜é—®é¢˜æ’æŸ¥åŠå¤„ç†</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">äº¬ICPå¤‡2021039488å·</a>
    </span>

    æ€»è®¿å®¢ï¼š<span id="busuanzi_value_site_uv"></span>
    æ€»æµè§ˆé‡ï¼š<span id="busuanzi_value_site_pv"></span>
    é¡µé¢è®¿é—®é‡ï¼š<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
