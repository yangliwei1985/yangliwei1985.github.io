<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>从零开始构建基于Kubernetes的Devops平台 | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="基于Kubernetes的DevOps平台实践 持续集成工具：
 Jenkins gitlabci Tekton  本章基于k8s集群部署gitlab、sonarQube、Jenkins等工具，并把上述工具集成到Jenkins中，以Django项目和SpringBoot项目为例，通过多分支流水线及Jenkinsfile实现项目代码提交到不同的仓库分支，实现自动代码扫描、单元测试、docker容器构建、k8s服务的自动部署。
 DevOps、CI、CD介绍 Jenkins、sonarQube、gitlab的快速部署 Jenkins初体验 流水线入门及Jenkinsfile使用 Jenkins与Kubernetes的集成 sonarQube代码扫描与Jenkins的集成 实践Django项目的基于Jenkinsfile实现开发、测试环境的CI/CD  DevOps、CI、CD介绍 Continuous Integration (CI) / Continuous Delivery (CD)
软件交付流程
一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护，基于这些阶段，我们的软件交付模型大致经历了几个阶段：
瀑布式流程 前期需求确立之后，软件开发人员花费数周和数月编写代码，把所有需求一次性开发完，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去部署。瀑布模型，简单来说，就是等一个阶段所有工作完成之后，再进入下一个阶段。这种模式的问题也很明显，产品迭代周期长，灵活性差。一个周期动辄几周几个月，适应不了当下产品需要快速迭代的场景。
敏捷开发 任务由大拆小，开发、测试协同工作，注重开发敏捷，不重视交付敏捷
DevOps 开发、测试、运维协同工作, 持续开发&#43;持续交付。
我们是否可以认为DevOps = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式？
大家想一下为什么最初的开发模式没有直接进入DevOps的时代？
原因是：沟通成本。
各角色人员去沟通协作的时候都是手动去做，交流靠嘴，靠人去指挥，很显然会出大问题。所以说不能认为DevOps就是一种交付模式，因为解决不了沟通协作成本，这种模式就不具备可落地性。
那DevOps时代如何解决角色之间的成本问题？DevOps的核心就是自动化。自动化的能力靠什么来支撑，工具和技术。
DevOps工具链
靠这些工具和技术，才实现了自动化流程，进而解决了协作成本，使得devops具备了可落地性。因此我们可以大致给devops一个定义：
devops = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式 &#43; 基于工具和技术支撑的自动化流程的落地实践。
因此devops不是某一个具体的技术，而是一种思想&#43;自动化能力，来使得构建、测试、发布软件能够更加地便捷、频繁和可靠的落地实践。本次课程核心内容就是要教会大家如何利用工具和技术来实现完整的DevOps平台的建设。我们主要使用的工具有：
 gitlab，代码仓库，企业内部使用最多的代码版本管理工具。 Jenkins， 一个可扩展的持续集成引擎，用于自动化各种任务，包括构建、测试和部署软件。 robotFramework， 基于Python的自动化测试框架 sonarqube，代码质量管理平台 maven，java包构建管理工具 Kubernetes Docker  Jenkins初体验 Kubernetes环境中部署jenkins 其他部署方式
注意点：
 第一次启动很慢 因为后面Jenkins会与kubernetes集群进行集成，会需要调用kubernetes集群的api，因此安装的时候创建了ServiceAccount并赋予了cluster-admin的权限 默认部署到jenkins=true的节点 初始化容器来设置权限 ingress来外部访问 数据存储通过hostpath挂载到宿主机中  jenkins/jenkins-all.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="从零开始构建基于Kubernetes的Devops平台" />
<meta property="og:description" content="基于Kubernetes的DevOps平台实践 持续集成工具：
 Jenkins gitlabci Tekton  本章基于k8s集群部署gitlab、sonarQube、Jenkins等工具，并把上述工具集成到Jenkins中，以Django项目和SpringBoot项目为例，通过多分支流水线及Jenkinsfile实现项目代码提交到不同的仓库分支，实现自动代码扫描、单元测试、docker容器构建、k8s服务的自动部署。
 DevOps、CI、CD介绍 Jenkins、sonarQube、gitlab的快速部署 Jenkins初体验 流水线入门及Jenkinsfile使用 Jenkins与Kubernetes的集成 sonarQube代码扫描与Jenkins的集成 实践Django项目的基于Jenkinsfile实现开发、测试环境的CI/CD  DevOps、CI、CD介绍 Continuous Integration (CI) / Continuous Delivery (CD)
软件交付流程
一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护，基于这些阶段，我们的软件交付模型大致经历了几个阶段：
瀑布式流程 前期需求确立之后，软件开发人员花费数周和数月编写代码，把所有需求一次性开发完，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去部署。瀑布模型，简单来说，就是等一个阶段所有工作完成之后，再进入下一个阶段。这种模式的问题也很明显，产品迭代周期长，灵活性差。一个周期动辄几周几个月，适应不了当下产品需要快速迭代的场景。
敏捷开发 任务由大拆小，开发、测试协同工作，注重开发敏捷，不重视交付敏捷
DevOps 开发、测试、运维协同工作, 持续开发&#43;持续交付。
我们是否可以认为DevOps = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式？
大家想一下为什么最初的开发模式没有直接进入DevOps的时代？
原因是：沟通成本。
各角色人员去沟通协作的时候都是手动去做，交流靠嘴，靠人去指挥，很显然会出大问题。所以说不能认为DevOps就是一种交付模式，因为解决不了沟通协作成本，这种模式就不具备可落地性。
那DevOps时代如何解决角色之间的成本问题？DevOps的核心就是自动化。自动化的能力靠什么来支撑，工具和技术。
DevOps工具链
靠这些工具和技术，才实现了自动化流程，进而解决了协作成本，使得devops具备了可落地性。因此我们可以大致给devops一个定义：
devops = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式 &#43; 基于工具和技术支撑的自动化流程的落地实践。
因此devops不是某一个具体的技术，而是一种思想&#43;自动化能力，来使得构建、测试、发布软件能够更加地便捷、频繁和可靠的落地实践。本次课程核心内容就是要教会大家如何利用工具和技术来实现完整的DevOps平台的建设。我们主要使用的工具有：
 gitlab，代码仓库，企业内部使用最多的代码版本管理工具。 Jenkins， 一个可扩展的持续集成引擎，用于自动化各种任务，包括构建、测试和部署软件。 robotFramework， 基于Python的自动化测试框架 sonarqube，代码质量管理平台 maven，java包构建管理工具 Kubernetes Docker  Jenkins初体验 Kubernetes环境中部署jenkins 其他部署方式
注意点：
 第一次启动很慢 因为后面Jenkins会与kubernetes集群进行集成，会需要调用kubernetes集群的api，因此安装的时候创建了ServiceAccount并赋予了cluster-admin的权限 默认部署到jenkins=true的节点 初始化容器来设置权限 ingress来外部访问 数据存储通过hostpath挂载到宿主机中  jenkins/jenkins-all." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-07T14:26:43&#43;00:00" />
<meta property="article:modified_time" content="2022-01-07T14:26:43&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="从零开始构建基于Kubernetes的Devops平台"/>
<meta name="twitter:description" content="基于Kubernetes的DevOps平台实践 持续集成工具：
 Jenkins gitlabci Tekton  本章基于k8s集群部署gitlab、sonarQube、Jenkins等工具，并把上述工具集成到Jenkins中，以Django项目和SpringBoot项目为例，通过多分支流水线及Jenkinsfile实现项目代码提交到不同的仓库分支，实现自动代码扫描、单元测试、docker容器构建、k8s服务的自动部署。
 DevOps、CI、CD介绍 Jenkins、sonarQube、gitlab的快速部署 Jenkins初体验 流水线入门及Jenkinsfile使用 Jenkins与Kubernetes的集成 sonarQube代码扫描与Jenkins的集成 实践Django项目的基于Jenkinsfile实现开发、测试环境的CI/CD  DevOps、CI、CD介绍 Continuous Integration (CI) / Continuous Delivery (CD)
软件交付流程
一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护，基于这些阶段，我们的软件交付模型大致经历了几个阶段：
瀑布式流程 前期需求确立之后，软件开发人员花费数周和数月编写代码，把所有需求一次性开发完，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去部署。瀑布模型，简单来说，就是等一个阶段所有工作完成之后，再进入下一个阶段。这种模式的问题也很明显，产品迭代周期长，灵活性差。一个周期动辄几周几个月，适应不了当下产品需要快速迭代的场景。
敏捷开发 任务由大拆小，开发、测试协同工作，注重开发敏捷，不重视交付敏捷
DevOps 开发、测试、运维协同工作, 持续开发&#43;持续交付。
我们是否可以认为DevOps = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式？
大家想一下为什么最初的开发模式没有直接进入DevOps的时代？
原因是：沟通成本。
各角色人员去沟通协作的时候都是手动去做，交流靠嘴，靠人去指挥，很显然会出大问题。所以说不能认为DevOps就是一种交付模式，因为解决不了沟通协作成本，这种模式就不具备可落地性。
那DevOps时代如何解决角色之间的成本问题？DevOps的核心就是自动化。自动化的能力靠什么来支撑，工具和技术。
DevOps工具链
靠这些工具和技术，才实现了自动化流程，进而解决了协作成本，使得devops具备了可落地性。因此我们可以大致给devops一个定义：
devops = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式 &#43; 基于工具和技术支撑的自动化流程的落地实践。
因此devops不是某一个具体的技术，而是一种思想&#43;自动化能力，来使得构建、测试、发布软件能够更加地便捷、频繁和可靠的落地实践。本次课程核心内容就是要教会大家如何利用工具和技术来实现完整的DevOps平台的建设。我们主要使用的工具有：
 gitlab，代码仓库，企业内部使用最多的代码版本管理工具。 Jenkins， 一个可扩展的持续集成引擎，用于自动化各种任务，包括构建、测试和部署软件。 robotFramework， 基于Python的自动化测试框架 sonarqube，代码质量管理平台 maven，java包构建管理工具 Kubernetes Docker  Jenkins初体验 Kubernetes环境中部署jenkins 其他部署方式
注意点：
 第一次启动很慢 因为后面Jenkins会与kubernetes集群进行集成，会需要调用kubernetes集群的api，因此安装的时候创建了ServiceAccount并赋予了cluster-admin的权限 默认部署到jenkins=true的节点 初始化容器来设置权限 ingress来外部访问 数据存储通过hostpath挂载到宿主机中  jenkins/jenkins-all."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "从零开始构建基于Kubernetes的Devops平台",
      "item": "https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "从零开始构建基于Kubernetes的Devops平台",
  "name": "从零开始构建基于Kubernetes的Devops平台",
  "description": "基于Kubernetes的DevOps平台实践 持续集成工具：\n Jenkins gitlabci Tekton  本章基于k8s集群部署gitlab、sonarQube、Jenkins等工具，并把上述工具集成到Jenkins中，以Django项目和SpringBoot项目为例，通过多分支流水线及Jenkinsfile实现项目代码提交到不同的仓库分支，实现自动代码扫描、单元测试、docker容器构建、k8s服务的自动部署。\n DevOps、CI、CD介绍 Jenkins、sonarQube、gitlab的快速部署 Jenkins初体验 流水线入门及Jenkinsfile使用 Jenkins与Kubernetes的集成 sonarQube代码扫描与Jenkins的集成 实践Django项目的基于Jenkinsfile实现开发、测试环境的CI/CD  DevOps、CI、CD介绍 Continuous Integration (CI) / Continuous Delivery (CD)\n软件交付流程\n一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护，基于这些阶段，我们的软件交付模型大致经历了几个阶段：\n瀑布式流程 前期需求确立之后，软件开发人员花费数周和数月编写代码，把所有需求一次性开发完，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去部署。瀑布模型，简单来说，就是等一个阶段所有工作完成之后，再进入下一个阶段。这种模式的问题也很明显，产品迭代周期长，灵活性差。一个周期动辄几周几个月，适应不了当下产品需要快速迭代的场景。\n敏捷开发 任务由大拆小，开发、测试协同工作，注重开发敏捷，不重视交付敏捷\nDevOps 开发、测试、运维协同工作, 持续开发+持续交付。\n我们是否可以认为DevOps = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式？\n大家想一下为什么最初的开发模式没有直接进入DevOps的时代？\n原因是：沟通成本。\n各角色人员去沟通协作的时候都是手动去做，交流靠嘴，靠人去指挥，很显然会出大问题。所以说不能认为DevOps就是一种交付模式，因为解决不了沟通协作成本，这种模式就不具备可落地性。\n那DevOps时代如何解决角色之间的成本问题？DevOps的核心就是自动化。自动化的能力靠什么来支撑，工具和技术。\nDevOps工具链\n靠这些工具和技术，才实现了自动化流程，进而解决了协作成本，使得devops具备了可落地性。因此我们可以大致给devops一个定义：\ndevops = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式 + 基于工具和技术支撑的自动化流程的落地实践。\n因此devops不是某一个具体的技术，而是一种思想+自动化能力，来使得构建、测试、发布软件能够更加地便捷、频繁和可靠的落地实践。本次课程核心内容就是要教会大家如何利用工具和技术来实现完整的DevOps平台的建设。我们主要使用的工具有：\n gitlab，代码仓库，企业内部使用最多的代码版本管理工具。 Jenkins， 一个可扩展的持续集成引擎，用于自动化各种任务，包括构建、测试和部署软件。 robotFramework， 基于Python的自动化测试框架 sonarqube，代码质量管理平台 maven，java包构建管理工具 Kubernetes Docker  Jenkins初体验 Kubernetes环境中部署jenkins 其他部署方式\n注意点：\n 第一次启动很慢 因为后面Jenkins会与kubernetes集群进行集成，会需要调用kubernetes集群的api，因此安装的时候创建了ServiceAccount并赋予了cluster-admin的权限 默认部署到jenkins=true的节点 初始化容器来设置权限 ingress来外部访问 数据存储通过hostpath挂载到宿主机中  jenkins/jenkins-all.",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "基于Kubernetes的DevOps平台实践 持续集成工具：\n Jenkins gitlabci Tekton  本章基于k8s集群部署gitlab、sonarQube、Jenkins等工具，并把上述工具集成到Jenkins中，以Django项目和SpringBoot项目为例，通过多分支流水线及Jenkinsfile实现项目代码提交到不同的仓库分支，实现自动代码扫描、单元测试、docker容器构建、k8s服务的自动部署。\n DevOps、CI、CD介绍 Jenkins、sonarQube、gitlab的快速部署 Jenkins初体验 流水线入门及Jenkinsfile使用 Jenkins与Kubernetes的集成 sonarQube代码扫描与Jenkins的集成 实践Django项目的基于Jenkinsfile实现开发、测试环境的CI/CD  DevOps、CI、CD介绍 Continuous Integration (CI) / Continuous Delivery (CD)\n软件交付流程\n一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护，基于这些阶段，我们的软件交付模型大致经历了几个阶段：\n瀑布式流程 前期需求确立之后，软件开发人员花费数周和数月编写代码，把所有需求一次性开发完，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去部署。瀑布模型，简单来说，就是等一个阶段所有工作完成之后，再进入下一个阶段。这种模式的问题也很明显，产品迭代周期长，灵活性差。一个周期动辄几周几个月，适应不了当下产品需要快速迭代的场景。\n敏捷开发 任务由大拆小，开发、测试协同工作，注重开发敏捷，不重视交付敏捷\nDevOps 开发、测试、运维协同工作, 持续开发+持续交付。\n我们是否可以认为DevOps = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式？\n大家想一下为什么最初的开发模式没有直接进入DevOps的时代？\n原因是：沟通成本。\n各角色人员去沟通协作的时候都是手动去做，交流靠嘴，靠人去指挥，很显然会出大问题。所以说不能认为DevOps就是一种交付模式，因为解决不了沟通协作成本，这种模式就不具备可落地性。\n那DevOps时代如何解决角色之间的成本问题？DevOps的核心就是自动化。自动化的能力靠什么来支撑，工具和技术。\nDevOps工具链\n靠这些工具和技术，才实现了自动化流程，进而解决了协作成本，使得devops具备了可落地性。因此我们可以大致给devops一个定义：\ndevops = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式 + 基于工具和技术支撑的自动化流程的落地实践。\n因此devops不是某一个具体的技术，而是一种思想+自动化能力，来使得构建、测试、发布软件能够更加地便捷、频繁和可靠的落地实践。本次课程核心内容就是要教会大家如何利用工具和技术来实现完整的DevOps平台的建设。我们主要使用的工具有：\n gitlab，代码仓库，企业内部使用最多的代码版本管理工具。 Jenkins， 一个可扩展的持续集成引擎，用于自动化各种任务，包括构建、测试和部署软件。 robotFramework， 基于Python的自动化测试框架 sonarqube，代码质量管理平台 maven，java包构建管理工具 Kubernetes Docker  Jenkins初体验 Kubernetes环境中部署jenkins 其他部署方式\n注意点：\n 第一次启动很慢 因为后面Jenkins会与kubernetes集群进行集成，会需要调用kubernetes集群的api，因此安装的时候创建了ServiceAccount并赋予了cluster-admin的权限 默认部署到jenkins=true的节点 初始化容器来设置权限 ingress来外部访问 数据存储通过hostpath挂载到宿主机中  jenkins/jenkins-all.yaml\napiVersion: v1 kind: Namespace metadata:  name: jenkins --- apiVersion: v1 kind: ServiceAccount metadata:  name: jenkins  namespace: jenkins --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata:  name: jenkins-crb roleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: cluster-admin subjects: - kind: ServiceAccount  name: jenkins  namespace: jenkins --- apiVersion: apps/v1 kind: Deployment metadata:  name: jenkins-master  namespace: jenkins spec:  replicas: 1  selector:  matchLabels:  devops: jenkins-master  template:  metadata:  labels:  devops: jenkins-master  spec:  nodeSelector:  jenkins: \"true\"  serviceAccount: jenkins #Pod 需要使用的服务账号  initContainers:  - name: fix-permissions  image: busybox  command: [\"sh\", \"-c\", \"chown -R 1000:1000 /var/jenkins_home\"]  securityContext:  privileged: true  volumeMounts:  - name: jenkinshome  mountPath: /var/jenkins_home  containers:  - name: jenkins  image: jenkinsci/blueocean:1.23.2  imagePullPolicy: IfNotPresent  ports:  - name: http #Jenkins Master Web 服务端口  containerPort: 8080  - name: slavelistener #Jenkins Master 供未来 Slave 连接的端口  containerPort: 50000  volumeMounts:  - name: jenkinshome  mountPath: /var/jenkins_home  env:  - name: JAVA_OPTS  value: \"-Xms4096m -Xmx5120m -Duser.timezone=Asia/Shanghai -Dhudson.model.DirectoryBrowserSupport.CSP=\"  volumes:  - name: jenkinshome  hostPath:  path: /var/jenkins_home/ --- apiVersion: v1 kind: Service metadata:  name: jenkins  namespace: jenkins spec:  ports:  - name: http  port: 8080  targetPort: 8080  - name: slavelistener  port: 50000  targetPort: 50000  type: ClusterIP  selector:  devops: jenkins-master --- apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: jenkins-web  namespace: jenkins spec:  rules:  - host: jenkins.luffy.com  http:  paths:  - backend:  serviceName: jenkins  servicePort: 8080  path: / 创建服务：\n## 为k8s-slave1打标签，将jenkins-master部署在k8s-slave1节点 $ kubectl label node k8s-slave1 jenkins=true ## 部署服务 $ kubectl create -f jenkins-all.yaml ## 查看服务 $ kubectl -n jenkins get po NAME READY STATUS RESTARTS AGE jenkins-master-767df9b574-lgdr5 1/1 Running 0 20s  # 查看日志，第一次启动提示需要完成初始化设置 $ kubectl -n jenkins logs -f jenkins-master-767df9b574-lgdr5 ...... *************************************************************  Jenkins initial setup is required. An admin user has been created and a password generated. Please use the following password to proceed to installation:  5396b4e1c395450f8360efd8ee641b18  This may also be found at: /var/jenkins_home/secrets/initialAdminPassword  ************************************************************* 访问服务：\n配置hosts解析，172.21.51.67 jenkins.luffy.com，然后使用浏览器域名访问服务。第一次访问需要大概几分钟的初始化时间。\n使用jenkins启动日志中的密码，或者执行下面的命令获取解锁的管理员密码：\n$ kubectl -n jenkins exec jenkins-master-767df9b574-lgdr5 bash / # cat /var/jenkins_home/secrets/initialAdminPassword 35b083de1d25409eaef57255e0da481a 点击叉号，跳过选择安装推荐的插件环节，直接进入Jenkins。由于默认的插件地址安装非常慢，我们可以替换成国内清华的源，进入 jenkins 工作目录，目录下面有一个 updates 的目录，下面有一个 default.json 文件，我们执行下面的命令替换插件地址：\n$ cd /var/jenkins_home/updates $ sed -i 's/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json $ sed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json  暂时先不用重新启动pod，汉化后一起重启。\n 选择右上角admin-configure-password重新设置管理员密码，设置完后，会退出要求重新登录，使用admin/xxxxxx(新密码)，登录即可。\n安装汉化插件 Jenkins - manage Jenkins - Plugin Manager - Avaliable，搜索 chinese关键字\n选中后，选择[Install without restart]，等待下载完成，然后点击[ Restart Jenkins when installation is complete and no jobs are running ]，让Jenkins自动重启\n启动后，界面默认变成中文。\nJenkins基本使用演示 演示目标  代码提交gitlab，自动触发Jenkins任务 Jenkins任务完成后发送钉钉消息通知  演示准备 gitlab代码仓库搭建\nhttps://github.com/sameersbn/docker-gitlab\n## 全量部署的组件 $ gitlab-ctl status run: alertmanager: (pid 1987) 27s; run: log: (pid 1986) 27s run: gitaly: (pid 1950) 28s; run: log: (pid 1949) 28s run: gitlab-exporter: (pid 1985) 27s; run: log: (pid 1984) 27s run: gitlab-workhorse: (pid 1956) 28s; run: log: (pid 1955) 28s run: logrotate: (pid 1960) 28s; run: log: (pid 1959) 28s run: nginx: (pid 2439) 1s; run: log: (pid 1990) 27s run: node-exporter: (pid 1963) 28s; run: log: (pid 1962) 28s run: postgres-exporter: (pid 1989) 27s; run: log: (pid 1988) 27s run: postgresql: (pid 1945) 28s; run: log: (pid 1944) 28s run: prometheus: (pid 1973) 28s; run: log: (pid 1972) 28s run: puma: (pid 1968) 28s; run: log: (pid 1966) 28s run: redis: (pid 1952) 28s; run: log: (pid 1951) 28s run: redis-exporter: (pid 1971) 28s; run: log: (pid 1964) 28s run: sidekiq: (pid 1969) 28s; run: log: (pid 1967) 28s 部署分析：\n 依赖postgres 依赖redis  使用k8s部署：\n  准备secret文件\n$ cat gitlab-secret.txt postgres.user.root=root postgres.pwd.root=1qaz2wsx  $ kubectl -n jenkins create secret generic gitlab-secret --from-env-file=gitlab-secret.txt   部署postgres\n注意点：\n 使用secret来引用账户密码 使用postgres=true来指定节点  $ cat postgres.yaml apiVersion: v1 kind: Service metadata:  name: postgres  labels:  app: postgres  namespace: jenkins spec:  ports:  - name: server  port: 5432  targetPort: 5432  protocol: TCP  selector:  app: postgres --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: postgres  labels:  app: postgres spec:  replicas: 1  selector:  matchLabels:  app: postgres  template:  metadata:  labels:  app: postgres  spec:  nodeSelector:  postgres: \"true\"  tolerations:  - operator: \"Exists\"  containers:  - name: postgres  image: 172.21.51.67:5000/postgres:11.4 #若本地没有启动该仓库，换成postgres:11.4  imagePullPolicy: \"IfNotPresent\"  ports:  - containerPort: 5432  env:  - name: POSTGRES_USER #PostgreSQL 用户名  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.user.root  - name: POSTGRES_PASSWORD #PostgreSQL 密码  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.pwd.root  resources:  limits:  cpu: 1000m  memory: 2048Mi  requests:  cpu: 50m  memory: 100Mi  volumeMounts:  - mountPath: /var/lib/postgresql/data  name: postgredb  volumes:  - name: postgredb  hostPath:  path: /var/lib/postgres/   #部署到k8s-slave2节点 $ kubectl label node k8s-slave2 postgres=true  #创建postgres $ kubectl create -f postgres.yaml  # 创建数据库gitlab,为后面部署gitlab组件使用 $ kubectl -n jenkins exec -ti postgres-7ff9b49f4c-nt8zh bash root@postgres-7ff9b49f4c-nt8zh:/# psql root=# create database gitlab; CREATE DATABASE   部署redis\n$ cat redis.yaml apiVersion: v1 kind: Service metadata:  name: redis  labels:  app: redis  namespace: jenkins spec:  ports:  - name: server  port: 6379  targetPort: 6379  protocol: TCP  selector:  app: redis --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: redis  labels:  app: redis spec:  replicas: 1  selector:  matchLabels:  app: redis  template:  metadata:  labels:  app: redis  spec:  tolerations:  - operator: \"Exists\"  containers:  - name: redis  image: sameersbn/redis:4.0.9-2  imagePullPolicy: \"IfNotPresent\"  ports:  - containerPort: 6379  resources:  limits:  cpu: 1000m  memory: 2048Mi  requests:  cpu: 50m  memory: 100Mi  # 创建 $ kubectl create -f redis.yaml   部署gitlab\n注意点：\n 使用ingress暴漏服务 添加annotation，指定nginx端上传大小限制，否则推送代码时会默认被限制1m大小，相当于给nginx设置client_max_body_size的限制大小 使用gitlab=true来选择节点 使用服务发现地址来访问postgres和redis 在secret中引用数据库账户和密码 数据库名称为gitlab  $ cat gitlab.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: gitlab  namespace: jenkins  annotations:  nginx.ingress.kubernetes.io/proxy-body-size: \"50m\" spec:  rules:  - host: gitlab.luffy.com  http:  paths:  - backend:  serviceName: gitlab  servicePort: 80  path: / --- apiVersion: v1 kind: Service metadata:  name: gitlab  labels:  app: gitlab  namespace: jenkins spec:  ports:  - name: server  port: 80  targetPort: 80  protocol: TCP  selector:  app: gitlab --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: gitlab  labels:  app: gitlab spec:  replicas: 1  selector:  matchLabels:  app: gitlab  template:  metadata:  labels:  app: gitlab  spec:  nodeSelector:  gitlab: \"true\"  tolerations:  - operator: \"Exists\"  containers:  - name: gitlab  image: sameersbn/gitlab:13.2.2  imagePullPolicy: \"IfNotPresent\"  env:  - name: GITLAB_HOST  value: \"gitlab.luffy.com\"  - name: GITLAB_PORT  value: \"80\"  - name: GITLAB_SECRETS_DB_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: GITLAB_SECRETS_DB_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: GITLAB_SECRETS_SECRET_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: GITLAB_SECRETS_OTP_KEY_BASE  value: \"long-and-random-alpha-numeric-string\"  - name: DB_HOST  value: \"postgres\"  - name: DB_NAME  value: \"gitlab\"  - name: DB_USER  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.user.root  - name: DB_PASS  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.pwd.root  - name: REDIS_HOST  value: \"redis\"  - name: REDIS_PORT  value: \"6379\"  ports:  - containerPort: 80  resources:  limits:  cpu: 2000m  memory: 5048Mi  requests:  cpu: 100m  memory: 500Mi  volumeMounts:  - mountPath: /home/git/data  name: data  volumes:  - name: data  hostPath:  path: /var/lib/gitlab/  #部署到k8s-slave2节点 $ kubectl label node k8s-slave2 gitlab=true  # 创建 $ kubectl create -f gitlab.yaml   配置hosts解析：\n172.21.51.67 gitlab.luffy.com 设置root密码\n访问http://gitlab.luffy.com，设置管理员密码\n配置k8s-master节点的hosts\n$ echo \"172.21.51.67 gitlab.luffy.com\" /etc/hosts myblog项目推送到gitlab\nmkdir demo cp -r myblog demo/ cd demo/myblog git remote rename origin old-origin git remote add origin http://gitlab.luffy.com/root/myblog.git git push -u origin --all git push -u origin --tags 钉钉推送\n官方文档\n  配置机器人\n  试验发送消息\n$ curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\  -H 'Content-Type: application/json' \\  -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"我就是我, 是不一样的烟火\" } }'   演示过程 流程示意图：\n  安装gitlab plugin\n插件中心搜索并安装gitlab，直接安装即可\n  配置Gitlab\n系统管理-系统配置-Gitlab，其中的API Token，需要从下个步骤中获取\n  获取AccessToken\n登录gitlab，选择user-Settings-access tokens新建一个访问token\n  配置host解析\n由于我们的Jenkins和gitlab域名是本地解析，因此需要让gitlab和Jenkins服务可以解析到对方的域名。两种方式：\n  在容器内配置hosts\n  配置coredns的静态解析\n hosts {  172.21.51.67 jenkins.luffy.com gitlab.luffy.com  fallthrough  }     创建自由风格项目\n gitlab connection 选择为刚创建的gitlab 源码管理选择Git，填项项目地址 新建一个 Credentials 认证，使用用户名密码方式，配置gitlab的用户和密码 构建触发器选择 Build when a change is pushed to GitLab 生成一个Secret token 保存    到gitlab配置webhook\n 进入项目下settings-Integrations URL： http://jenkins.luffy.com/project/free Secret Token 填入在Jenkins端生成的token Add webhook test push events，报错：Requests to the local network are not allowed    设置gitlab允许向本地网络发送webhook请求\n访问 Admin Aera - Settings - Network ，展开Outbound requests\nCollapse，勾选第一项即可。再次test push events，成功。\n  配置free项目，增加构建步骤，执行shell，将发送钉钉消息的shell保存\n  提交代码到gitlab仓库，查看构建是否自动执行\n    Master-Slaves（agent）模式 上面演示的任务，默认都是在master节点执行的，多个任务都在master节点执行，对master节点的性能会造成一定影响，如何将任务分散到不同的节点，做成多slave的方式？\n  添加slave节点\n  系统管理 - 节点管理 - 新建节点\n  比如添加172.21.51.68，选择固定节点，保存\n  远程工作目录/opt/jenkins_jobs\n  标签为任务选择节点的依据，如172.21.51.68\n  启动方式选择通过java web启动代理，代理是运行jar包，通过JNLP（是一种允许客户端启动托管在远程Web服务器上的应用程序的协议 ）启动连接到master节点服务中\n    执行java命令启动agent服务\n## 登录172.21.51.68，下载agent.jar $ wget http://jenkins.luffy.com/jnlpJars/agent.jar ## 会提示找不到agent错误，因为没有配置地址解析，由于连接jenkins master会通过50000端口，直接使用cluster-ip $ kubectl -n jenkins get svc #在master节点执行查询cluster-ip地址 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE jenkins ClusterIP 10.99.204.208  8080/TCP,50000/TCP 4h8m  ## 再次回到68节点 $ wget 10.99.204.208:8080/jnlpJars/agent.jar $ java -jar agent.jar -jnlpUrl http://10.99.204.208:8080/computer/172.21.51.68/slave-agent.jnlp -secret 4be4d164f861d2830835653567867a1e695b30c320d35eca2be9f5624f8712c8 -workDir \"/opt/jenkins_jobs\" ... INFO: Remoting server accepts the following protocols: [JNLP4-connect, Ping] Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Agent discovery successful  Agent address: 10.99.204.208  Agent port: 50000  Identity: e4:46:3a🇩🇪86:24:8e:15:09:13:3d:a7:4e:07:04:37 Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Handshaking Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Connecting to 10.99.204.208:50000 Apr 01, 2020 7:03:51 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Trying protocol: JNLP4-connect Apr 01, 2020 7:04:02 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Remote identity confirmed: e4:46:3a🇩🇪86:24:8e:15:09:13:3d:a7:4e:07:04:37 Apr 01, 2020 7:04:03 PM hudson.remoting.jnlp.Main$CuiListener status INFO: Connected 若出现如下错误:\nSEVERE: http://jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity. java.io.IOException: http://jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity.  at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java:287)  at hudson.remoting.Engine.innerRun(Engine.java:694)  at hudson.remoting.Engine.run(Engine.java:519) 可以选择： 配置从节点 - 高级 - Tunnel连接位置，参考下图进行设置:\n  查看Jenkins节点列表，新节点已经处于可用状态\n  测试使用新节点执行任务\n  配置free项目\n  限制项目的运行节点 ，标签表达式选择172.21.51.68\n  立即构建\n  查看构建日志\nStarted by user admin Running as SYSTEM Building remotely on 172.21.51.68 in workspace /opt/jenkins_jobs/workspace/free-demo using credential gitlab-user Cloning the remote Git repository Cloning repository http://gitlab.luffy.com/root/myblog.git   git init /opt/jenkins_jobs/workspace/free-demo # timeout=10  ...       Jenkins定制化容器 由于每次新部署Jenkins环境，均需要安装很多必要的插件，因此考虑把插件提前做到镜像中\nDockerfile\nFROMjenkinsci/blueocean:1.23.2LABEL maintainer=\"inspur_lyx@hotmail.com\"## 用最新的插件列表文件替换默认插件文件COPY plugins.txt /usr/share/jenkins/ref/## 执行插件安装RUN /usr/local/bin/install-plugins.sh plugins.txt\nace-editor:1.1 allure-jenkins-plugin:2.28.1 ant:1.10 antisamy-markup-formatter:1.6 apache-httpcomponents-client-4-api:4.5.10-1.0 authentication-tokens:1.3 ... get_plugin.sh\n admin:123456@localhost 需要替换成Jenkins的用户名、密码及访问地址\n #!/usr/bin/env bash curl -sSL \"http://admin:123456@localhost:8080/pluginManager/api/xml?depth=1\u0026xpath=/*/*/shortName|/*/*/version\u0026wrapper=plugins\" | perl -pe 's/.*?([\\w-]+).*?([^)+/\\1:\\2\\n/g'|sed 's/ /:/'  plugins.txt ## 执行构建，定制jenkins容器 $ docker build . -t 172.21.51.67:5000/jenkins:v20200414 -f Dockerfile $ docker push 172.21.51.67:5000/jenkins:v20200414 至此，我们可以使用定制化的镜像启动jenkins服务\n## 删掉当前服务 $ kubectl delete -f jenkins-all.yaml  ## 删掉已挂载的数据 $ rm -rf /var/jenkins_home  ## 替换使用定制化镜像 $ sed -i 's#jenkinsci/blueocean#172.21.51.67:5000/jenkins:v20200404#g' jenkins-all.yaml  ## 重新创建服务 $ kubectl create -f jenkins-all.yaml 本章小结 自由风格项目弊端：\n 任务的完成需要在Jenkins端维护大量的配置 没法做版本控制 可读性、可移植性很差，不够优雅    流水线入门 官方文档\n为什么叫做流水线，和工厂产品的生产线类似，pipeline是从源码到发布到线上环境。关于流水线，需要知道的几个点：\n  重要的功能插件，帮助Jenkins定义了一套工作流框架；\n  Pipeline 的实现方式是一套 Groovy DSL（ 领域专用语言 ），所有的发布流程都可以表述为一段 Groovy 脚本；\n  将WebUI上需要定义的任务，以脚本代码的方式表述出来；\n  帮助jenkins实现持续集成CI（Continue Integration）和持续部署CD（Continue Deliver）的重要手段；\n  流水线基础语法 官方文档\n两种语法类型：\n Scripted Pipeline，脚本式流水线，最初支持的类型 Declarative Pipeline，声明式流水线，为Pipeline plugin在2.5版本之后新增的一种脚本类型，后续Open Blue Ocean所支持的类型。与原先的Scripted Pipeline一样，都可以用来编写脚本。Declarative Pipeline 是后续Open Blue Ocean所支持的类型，写法简单，支持内嵌Scripted Pipeline代码  为与BlueOcean脚本编辑器兼容，通常建议使用Declarative Pipeline的方式进行编写,从jenkins社区的动向来看，很明显这种语法结构也会是未来的趋势。\n脚本示例 pipeline {  agent {label '172.21.51.68'}  environment {  PROJECT = 'myblog'  }  stages {  stage('Checkout') {  steps {  checkout scm  }  }  stage('Build') {  steps {  sh 'make'  }  }  stage('Test'){  steps {  sh 'make check'  junit 'reports/**/*.xml'  }  }  stage('Deploy') {  steps {  sh 'make publish'  }  }  } \tpost {  success {  echo 'Congratulations!'  } \tfailure {  echo 'Oh no!'  }  always {  echo 'I will always say Hello again!'  }  } } 脚本解释：   checkout步骤为检出代码; scm是一个特殊变量，指示checkout步骤克隆触发此Pipeline运行的特定修订\n  agent：指明使用哪个agent节点来执行任务，定义于pipeline顶层或者stage内部\n  any，可以使用任意可用的agent来执行\n  label，在提供了标签的 Jenkins 环境中可用的代理上执行流水线或阶段。 例如: agent { label 'my-defined-label' }，最常见的使用方式\n  none，当在 pipeline 块的顶部没有全局代理， 该参数将会被分配到整个流水线的运行中并且每个 stage 部分都需要包含他自己的 agent 部分。比如: agent none\n  docker， 使用给定的容器执行流水线或阶段。 在指定的节点中，通过运行容器来执行任务\nagent {  docker {  image 'maven:3-alpine'  label 'my-defined-label'  args '-v /tmp:/tmp'  } }     options: 允许从流水线内部配置特定于流水线的选项。\n buildDiscarder , 为最近的流水线运行的特定数量保存组件和控制台输出。例如: options { buildDiscarder(logRotator(numToKeepStr: '10')) } disableConcurrentBuilds ,不允许同时执行流水线。 可被用来防止同时访问共享资源等。 例如: options { disableConcurrentBuilds() } timeout ,设置流水线运行的超时时间, 在此之后，Jenkins将中止流水线。例如: options { timeout(time: 1, unit: 'HOURS') } retry，在失败时, 重新尝试整个流水线的指定次数。 For example: options { retry(3) }    environment: 指令制定一个 键-值对序列，该序列将被定义为所有步骤的环境变量\n  stages: 包含一系列一个或多个 stage指令, stages 部分是流水线描述的大部分\"work\" 的位置。 建议 stages 至少包含一个 stage 指令用于连续交付过程的每个离散部分,比如构建, 测试, 和部署。\npipeline {  agent any  stages {  stage('Example') {  steps {  echo 'Hello World'  }  }  } }   steps: 在给定的 stage 指令中执行的定义了一系列的一个或多个steps。\n  post: 定义一个或多个steps ，这些阶段根据流水线或阶段的完成情况而运行post 支持以下 post-condition 块中的其中之一: always, changed, failure, success, unstable, 和 aborted。\n always, 无论流水线或阶段的完成状态如何，都允许在 post 部分运行该步骤 changed, 当前流水线或阶段的完成状态与它之前的运行不同时，才允许在 post 部分运行该步骤 failure, 当前流水线或阶段的完成状态为\"failure\"，才允许在 post 部分运行该步骤, 通常web UI是红色 success, 当前流水线或阶段的完成状态为\"success\"，才允许在 post 部分运行该步骤, 通常web UI是蓝色或绿色 unstable, 当前流水线或阶段的完成状态为\"unstable\"，才允许在 post 部分运行该步骤, 通常由于测试失败,代码违规等造成。通常web UI是黄色 aborted， 只有当前流水线或阶段的完成状态为\"aborted\"，才允许在 post 部分运行该步骤, 通常由于流水线被手动的aborted。通常web UI是灰色    创建pipeline示意：\n新建任务 - 流水线\njenkins/pipelines/p1.yaml\npipeline {  agent {label '172.21.51.68'}  environment {  PROJECT = 'myblog'  }  stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-user', url: 'http://gitlab.luffy.com/root/myblog.git']]])  }  }  stage('build-image') {  steps {  sh 'docker build . -t myblog:latest -f Dockerfile'  }  }  stage('send-msg') {  steps {  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"我就是我, 是不一样的烟火\" } }' \"\"\"  }  }  } } 点击“立即构建”，同样的，我们可以配置触发器，使用webhook的方式接收项目的push事件，\n 构建触发器选择 Build when a change is pushed to GitLab. 生成 Secret token 配置gitlab，创建webhook，发送test push events测试  Blue Ocean: 官方文档\n我们需要知道的几点：\n 是一个插件， 旨在为Pipeline提供丰富的体验 ； 连续交付（CD）Pipeline的复杂可视化，允许快速和直观地了解Pipeline的状态； 目前支持的类型仅针对于Pipeline，尚不能替代Jenkins 经典版UI  思考：\n 每个项目都把大量的pipeline脚本写在Jenkins端，对于谁去维护及维护成本是一个问题 没法做版本控制    Jenkinsflie Jenkins Pipeline 提供了一套可扩展的工具，用于将“简单到复杂”的交付流程实现为“持续交付即代码”。Jenkins Pipeline 的定义通常被写入到一个文本文件（称为 Jenkinsfile ）中，该文件可以被放入项目的源代码控制库中。\n演示1：使用Jenkinsfile管理pipeline  在项目中新建Jenkinsfile文件，拷贝已有script内容 配置pipeline任务，流水线定义为Pipeline Script from SCM 执行push 代码测试  Jenkinsfile:\njenkins/pipelines/p2.yaml\npipeline {  agent { label '172.21.51.68'}   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitlab-user', url: 'http://gitlab.luffy.com/root/myblog.git']]])  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t myblog:latest'}  }  }  stage('send-msg') {  steps {  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"我就是我, 是不一样的烟火\" } }' \"\"\"  }  }  } } 演示2：优化及丰富流水线内容   优化代码检出阶段\n由于目前已经配置了使用git仓库地址，且使用SCM来检测项目，因此代码检出阶段完全没有必要再去指定一次\n  构建镜像的tag使用git的commit id\n  增加post阶段的消息通知，丰富通知内容\n  配置webhook，实现myblog代码推送后，触发Jenkinsfile任务执行\n  jenkins/pipelines/p3.yaml\npipeline {  agent { label '172.21.51.68'}   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout scm  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t myblog:${GIT_COMMIT}'}  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"😄👍构建成功👍😄\\n 关键字：luffy\\n 项目名称: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n 构建地址：${RUN_DISPLAY_URL}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"😖❌构建失败❌😖\\n 关键字：luffy\\n 项目名称: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n 构建地址：${RUN_DISPLAY_URL}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } 演示3：使用k8s部署服务   新建deploy目录，将k8s所需的文件放到deploy目录中\n  将镜像地址改成模板，在pipeline中使用新构建的镜像进行替换\n  执行kubectl apply -f deploy应用更改，需要配置kubectl认证\n$ scp -r k8s-master:/root/.kube /root   jenkins/pipelines/p4.yaml\npipeline {  agent { label '172.21.51.68'}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  }   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout scm  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"😄👍构建成功👍😄\\n 关键字：myblog\\n 项目名称: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n 构建地址：${RUN_DISPLAY_URL}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"😖❌构建失败❌😖\\n 关键字：luffy\\n 项目名称: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n 构建地址：${RUN_DISPLAY_URL}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } 演示4：使用凭据管理敏感信息 上述Jenkinsfile中存在的问题是敏感信息使用明文，暴漏在代码中，如何管理流水线中的敏感信息（包含账号密码），之前我们在对接gitlab的时候，需要账号密码，已经使用过凭据来管理这类敏感信息，同样的，我们可以使用凭据来存储钉钉的token信息，那么，创建好凭据后，如何在Jenkinsfile中获取已有凭据的内容？\nJenkins 的声明式流水线语法有一个 credentials() 辅助方法（在environment 指令中使用），它支持 secret 文本，带密码的用户名，以及 secret 文件凭据。\n下面的流水线代码片段展示了如何创建一个使用带密码的用户名凭据的环境变量的流水线。\n在该示例中，带密码的用户名凭据被分配了环境变量，用来使你的组织或团队以一个公用账户访问 Bitbucket 仓库；这些凭据已在 Jenkins 中配置了凭据 ID jenkins-bitbucket-common-creds。\n当在 environment 指令中设置凭据环境变量时：\nenvironment { BITBUCKET_COMMON_CREDS = credentials('jenkins-bitbucket-common-creds') } 这实际设置了下面的三个环境变量：\n BITBUCKET_COMMON_CREDS - 包含一个以冒号分隔的用户名和密码，格式为 username:password。 BITBUCKET_COMMON_CREDS_USR - 附加的一个仅包含用户名部分的变量。 BITBUCKET_COMMON_CREDS_PSW - 附加的一个仅包含密码部分的变量。  pipeline {  agent {  // 此处定义 agent 的细节  }  environment {  //顶层流水线块中使用的 environment 指令将适用于流水线中的所有步骤。  BITBUCKET_COMMON_CREDS = credentials('jenkins-bitbucket-common-creds')  }  stages {  stage('Example stage 1') {  //在一个 stage 中定义的 environment 指令只会将给定的环境变量应用于 stage 中的步骤。  environment {  BITBUCKET_COMMON_CREDS = credentials('another-credential-id')  }  steps {  //  }  }  stage('Example stage 2') {  steps {  //  }  }  } } 因此对Jenkinsfile做改造：\njenkins/pipelines/p5.yaml\npipeline {  agent { label '172.21.51.68'}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  }   stages {  stage('printenv') {  steps {  echo 'Hello World'  sh 'printenv'  }  }  stage('check') {  steps {  checkout scm  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"😄👍构建成功👍😄\\n 关键字：luffy\\n 项目名称: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n 构建地址：${RUN_DISPLAY_URL}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{\"msgtype\": \"text\", \"text\": { \"content\": \"😖❌构建失败❌😖\\n 关键字：luffy\\n 项目名称: ${JOB_BASE_NAME}\\n Commit Id: ${GIT_COMMIT}\\n 构建地址：${RUN_DISPLAY_URL}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } 本章小结 上面我们已经通过Jenkinsfile完成了最简单的项目的构建和部署，那么我们来思考目前的方式：\n 目前都是在项目的单一分支下进行操作，企业内一般会使用feature、develop、release、master等多个分支来管理整个代码提交流程，如何根据不同的分支来做构建？ 构建视图中如何区分不同的分支? 如何不配置webhook的方式实现构建？ 如何根据不同的分支选择发布到不同的环境(开发、测试、生产)？    多分支流水线 官方示例\n我们简化一下流程，假如使用develop分支作为开发分支，master分支作为集成测试分支，看一下如何使用多分支流水线来管理。\n演示1：多分支流水线的使用  提交develop分支：  $ git checkout -b develop $ git push --set-upstream origin develop  禁用pipeline项目\n  Jenkins端创建多分支流水线项目\n 增加git分支源 发现标签 根据名称过滤，develop|master|v.* 高级克隆，设置浅克隆    保存后，会自动检索项目中所有存在Jenkinsfile文件的分支和标签，若匹配我们设置的过滤正则表达式，则会添加到多分支的构建视图中。所有添加到视图中的分支和标签，会默认执行一次构建任务。\n演示2：美化消息通知内容  添加构建阶段记录 使用markdown格式，添加构建分支消息  jenkins/pipelines/p6.yaml\npipeline {  agent { label '172.21.51.68'}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('printenv') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  checkout scm  script{  env.BUILD_TASKS = env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😄👍 构建成功 👍😄 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${GIT_BRANCH} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😖❌ 构建失败 ❌😖 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${GIT_BRANCH} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } 演示3：通知gitlab构建状态 Jenkins端做了构建，可以通过gitlab通过的api将构建状态通知过去，作为开发人员发起Merge Request或者合并Merge Request的依据之一。\n注意一定要指定gitLabConnection(‘gitlab’)，不然没法认证到Gitlab端\njenkins/pipelines/p7.yaml\npipeline {  agent { label '172.21.51.68'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('printenv') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  checkout scm  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('build-image') {  steps {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😄👍 构建成功 👍😄 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😖❌ 构建失败 ❌😖 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } 我们可以访问gitlab，然后找到commit记录，查看同步状态\n提交merge request，也可以查看到相关的任务状态，可以作为项目owner合并代码的依据之一：\n本章小节 优势:\n 根据分支展示, 视图人性化 自动检测各分支的变更  思考：\n Jenkins的slave端，没有任务的时候处于闲置状态，slave节点多的话造成资源浪费 是否可以利用kubernetes的Pod来启动slave，动态slave pod来执行构建任务    工具集成与Jenkinsfile实践篇  Jenkins如何对接kubernetes集群 使用kubernetes的Pod-Template来作为动态的agent执行Jenkins任务 如何制作agent容器实现不同类型的业务的集成 集成代码扫描、docker镜像自动构建、k8s服务部署、自动化测试  集成Kubernetes 插件安装及配置 插件官方文档\n  [系统管理] - [插件管理] - [搜索kubernetes]-直接安装\n若安装失败，请先更新bouncycastle API Plugin并重新启动Jenkins\n  [系统管理] - [系统配置] - [Add a new cloud]\n  配置地址信息\n Kubernetes 地址: https://kubernetes.default（或者https://172.21.51.67:6443） Kubernetes 命名空间：jenkins 服务证书不用写（我们在安装Jenkins的时候已经指定过serviceAccount），均使用默认 连接测试，成功会提示：Connection test successful Jenkins地址：http://jenkins:8080 Jenkins 通道 ：jenkins:50000    配置Pod Template\n 名称：jnlp-slave 命名空间：jenkins 标签列表：jnlp-slave，作为agent的label选择用 连接 Jenkins 的超时时间（秒） ：300，设置连接jenkins超时时间 节点选择器：agent=true 工作空间卷：选择hostpath，设置/opt/jenkins_jobs/,注意需要设置chown -R 1000:1000 /opt/jenkins_jobs/权限，否则Pod没有权限    演示动态slave pod # 为准备运行jnlp-slave-agent的pod的节点打上label $ kubectl label node k8s-slave1 agent=true  ### 回放一次多分支流水线develop分支 agent { label 'jnlp-slave'} 执行任务，会下载默认的jnlp-slave镜像，地址为jenkins/inbound-agent:4.3-4，我们可以先在k8s-master节点拉取下来该镜像：\n$ docker pull jenkins/inbound-agent:4.3-4 保存jenkinsfile提交后，会出现报错，因为我们的agent已经不再是宿主机，而是Pod中的容器内，报错如下：\n因此我们需要将用到的命令行工具集成到Pod的容器内，但是思考如下问题：\n 目前是用的jnlp的容器，是java的环境，我们在此基础上需要集成很多工具，能不能创建一个新的容器，让新容器来做具体的任务，jnlp-slave容器只用来负责连接jenkins-master 针对不同的构建环境（java、python、go、nodejs），可以制作不同的容器，来执行对应的任务    Pod-Template中容器镜像的制作 为解决上述问题，我们制作一个tools镜像，集成常用的工具，来完成常见的构建任务，需要注意的几点：\n 使用alpine基础镜像，自身体积比较小 替换国内安装源 为了使用docker，安装了docker 为了克隆代码，安装git 为了后续做python的测试等任务，安装python环境 为了在容器中调用kubectl的命令，拷贝了kubectl的二进制文件 为了认证kubectl，需要在容器内部生成.kube目录及config文件  $ mkdir tools; $ cd tools; $ cp `which kubectl` . $ cp ~/.kube/config . Dockerfile\njenkins/custom-images/tools/Dockerfile\nFROMalpineLABEL maintainer=\"inspur_lyx@hotmail.com\"USERrootRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \u0026\u0026 \\  apk update \u0026\u0026 \\  apk add --no-cache openrc docker git curl tar gcc g++ make \\  bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \\  libstdc++ harfbuzz nss freetype ttf-freefont \u0026\u0026 \\  mkdir -p /root/.kube \u0026\u0026 \\  usermod -a -G docker rootCOPY config /root/.kube/RUN rm -rf /var/cache/apk/* #-----------------安装 kubectl--------------------#COPY kubectl /usr/local/bin/RUN chmod +x /usr/local/bin/kubectl# ------------------------------------------------#执行镜像构建并推送到仓库中：\n$ docker build . -t 172.21.51.67:5000/devops/tools:v1 $ docker push 172.21.51.67:5000/devops/tools:v1 我们可以直接使用该镜像做测试：\n## 启动临时镜像做测试 $ docker run --rm -ti 172.21.51.67:5000/devops/tools:v1 bash # / git clone http://xxxxxx.git # / kubectl get no # / python3 #/ docker  ## 重新挂载docker的sock文件 docker run -v /var/run/docker.sock:/var/run/docker.sock --rm -ti 172.21.51.67:5000/devops/tools:v1 bash 实践通过Jenkinsfile实现demo项目自动发布到kubenetes环境 更新Jenkins中的PodTemplate，添加tools镜像，注意同时要先添加名为jnlp的container，因为我们是使用自定义的PodTemplate覆盖掉默认的模板：\n在卷栏目，添加卷，Host Path Volume，不然在容器中使用docker会提示docker服务未启动\ntools容器做好后，我们需要对Jenkinsfile做如下调整：\njenkins/pipelines/p8.yaml\npipeline {  agent { label 'jnlp-slave'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('printenv') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  container('tools') {  checkout scm  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('build-image') {  steps {  container('tools') {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  container('tools') {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  container('tools') {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😄👍 构建成功 👍😄 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😖❌ 构建失败 ❌😖 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } }   集成sonarQube实现代码扫描 Sonar可以从以下七个维度检测代码质量，而作为开发人员至少需要处理前5种代码质量问题。\n 不遵循代码标准 sonar可以通过PMD,CheckStyle,Findbugs等等代码规则检测工具规范代码编写。 潜在的缺陷 sonar可以通过PMD,CheckStyle,Findbugs等等代码规则检测工具检 测出潜在的缺陷。 糟糕的复杂度分布 文件、类、方法等，如果复杂度过高将难以改变，这会使得开发人员 难以理解它们, 且如果没有自动化的单元测试，对于程序中的任何组件的改变都将可能导致需要全面的回归测试。 重复 显然程序中包含大量复制粘贴的代码是质量低下的，sonar可以展示 源码中重复严重的地方。 注释不足或者过多 没有注释将使代码可读性变差，特别是当不可避免地出现人员变动 时，程序的可读性将大幅下降 而过多的注释又会使得开发人员将精力过多地花费在阅读注释上，亦违背初衷。 缺乏单元测试 sonar可以很方便地统计并展示单元测试覆盖率。 糟糕的设计 通过sonar可以找出循环，展示包与包、类与类之间的相互依赖关系，可以检测自定义的架构规则 通过sonar可以管理第三方的jar包，可以利用LCOM4检测单个任务规则的应用情况， 检测耦合。  sonarqube架构简介  CS架构  sonarqube scanner sonarqube server   SonarQube Scanner 扫描仪在本地执行代码扫描任务 执行完后，将分析报告被发送到SonarQube服务器进行处理 SonarQube服务器处理和存储分析报告导致SonarQube数据库，并显示结果在UI中  sonarqube on kubernetes环境搭建  资源文件准备  sonar/sonar.yaml\n 和gitlab共享postgres数据库 使用ingress地址 sonar.luffy.com 进行访问 使用initContainers进行系统参数调整  apiVersion: v1 kind: Service metadata:  name: sonarqube  namespace: jenkins  labels:  app: sonarqube spec:  ports:  - name: sonarqube  port: 9000  targetPort: 9000  protocol: TCP  selector:  app: sonarqube --- apiVersion: apps/v1 kind: Deployment metadata:  namespace: jenkins  name: sonarqube  labels:  app: sonarqube spec:  replicas: 1  selector:  matchLabels:  app: sonarqube  template:  metadata:  labels:  app: sonarqube  spec:  nodeSelector:  sonar: \"true\"  initContainers:  - command:  - /sbin/sysctl  - -w  - vm.max_map_count=262144  image: alpine:3.6  imagePullPolicy: IfNotPresent  name: elasticsearch-logging-init  resources: {}  securityContext:  privileged: true  containers:  - name: sonarqube  image: 172.21.51.67:5000/sonarqube:7.9-community  ports:  - containerPort: 9000  env:  - name: SONARQUBE_JDBC_USERNAME  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.user.root  - name: SONARQUBE_JDBC_PASSWORD  valueFrom:  secretKeyRef:  name: gitlab-secret  key: postgres.pwd.root  - name: SONARQUBE_JDBC_URL  value: \"jdbc:postgresql://postgres:5432/sonar\"  livenessProbe:  httpGet:  path: /sessions/new  port: 9000  initialDelaySeconds: 60  periodSeconds: 30  readinessProbe:  httpGet:  path: /sessions/new  port: 9000  initialDelaySeconds: 60  periodSeconds: 30  failureThreshold: 6  resources:  limits:  cpu: 2000m  memory: 4096Mi  requests:  cpu: 300m  memory: 512Mi --- apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: sonarqube  namespace: jenkins spec:  rules:  - host: sonar.luffy.com  http:  paths:  - backend:  serviceName: sonarqube  servicePort: 9000  path: / status:  loadBalancer: {}  sonarqube服务端安装\n# 创建sonar数据库 $ kubectl -n jenkins exec -ti postgres-5859dc6f58-mgqz9 bash #/ psql  # create database sonar;  ## 创建sonarqube服务器 $ kubectl create -f sonar.yaml  ## 配置本地hosts解析 172.21.51.67 sonar.luffy.com  ## 访问sonarqube，初始用户名密码为 admin/admin $ curl http://sonar.luffy.com   sonar-scanner的安装\n下载地址： https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zip。该地址比较慢，可以在网盘下载（https://pan.baidu.com/s/1SiEhWyHikTiKl5lEMX1tJg 提取码: tqb9）。\n  演示sonar代码扫描功能\n  在项目根目录中准备配置文件 sonar-project.properties\nsonar.projectKey=myblog sonar.projectName=myblog # if you want disabled the DTD verification for a proxy problem for example, true by default sonar.coverage.dtdVerification=false # JUnit like test report, default value is test.xml sonar.sources=blog,myblog   配置sonarqube服务器地址\n由于sonar-scanner需要将扫描结果上报给sonarqube服务器做质量分析，因此我们需要在sonar-scanner中配置sonarqube的服务器地址：\n在集群宿主机中测试，先配置一下hosts文件，然后配置sonar的地址：\n$ cat /etc/hosts 172.21.51.67 sonar.luffy.com  $ cat sonar-scanner/conf/sonar-scanner.properties #----- Default SonarQube server #sonar.host.url=http://localhost:9000 sonar.host.url=http://sonar.luffy.com #----- Default source code encoding #sonar.sourceEncoding=UTF-8      - 为了使所有的pod都可以通过`sonar.luffy.com`访问，可以配置coredns的静态解析 ```powershell hosts { 172.21.51.67 jenkins.luffy.com gitlab.luffy.com sonar.luffy.com fallthrough }   执行扫描\n## 在项目的根目录下执行 $ /opt/sonar-scanner-4.0.0.1744-linux/bin/sonar-scanner -X   sonarqube界面查看结果\n登录sonarqube界面查看结果，Quality Gates说明\n  插件安装及配置   集成到tools容器中\n由于我们的代码拉取、构建任务均是在tools容器中进行，因此我们需要把scanner集成到我们的tools容器中，又因为scanner是一个cli客户端，因此我们直接把包解压好，拷贝到tools容器内部，配置一下PATH路径即可，注意两点：\n  直接在在tools镜像中配置http://sonar.luffy.com\n  由于tools已经集成了java环境，因此可以直接剔除scanner自带的jre\n  删掉sonar-scanner/jre目录\n  修改sonar-scanner/bin/sonar-scanner\nuse_embedded_jre=false\n    $ cd tools $ cp -r /opt/sonar-scanner-4.0.0.1744-linux/ sonar-scanner ## sonar配置，由于我们是在Pod中使用，也可以直接配置：sonar.host.url=http://sonarqube:9000 $ cat sonar-scanner/conf/sonar-scanner.properties #----- Default SonarQube server sonar.host.url=http://sonar.luffy.com  #----- Default source code encoding #sonar.sourceEncoding=UTF-8  $ rm -rf sonar-scanner/jre $ vi sonar-scanner/bin/sonar-scanner ... use_embedded_jre=false ... Dockerfile\njenkins/custom-images/tools/Dockerfile2\nFROMalpineLABEL maintainer=\"inspur_lyx@hotmail.com\"USERrootRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \u0026\u0026 \\  apk update \u0026\u0026 \\  apk add --no-cache openrc docker git curl tar gcc g++ make \\  bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \\  libstdc++ harfbuzz nss freetype ttf-freefont \u0026\u0026 \\  mkdir -p /root/.kube \u0026\u0026 \\  usermod -a -G docker rootCOPY config /root/.kube/RUN rm -rf /var/cache/apk/*#-----------------安装 kubectl--------------------#COPY kubectl /usr/local/bin/RUN chmod +x /usr/local/bin/kubectl# ------------------------------------------------##---------------安装 sonar-scanner-----------------#COPY sonar-scanner /usr/lib/sonar-scannerRUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner \u0026\u0026 chmod +x /usr/local/bin/sonar-scannerENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner# ------------------------------------------------#  重新构建镜像，并推送到仓库：\n $ docker build . -t 172.21.51.67:5000/devops/tools:v2  $ docker push 172.21.51.67:5000/devops/tools:v2   修改Jenkins PodTemplate\n为了在新的构建任务中可以拉取v2版本的tools镜像，需要更新PodTemplate\n  安装并配置sonar插件\n由于sonarqube的扫描的结果需要进行Quality Gates的检测，那么我们在容器中执行完代码扫描任务后，如何知道本次扫描是否通过了Quality Gates，那么就需要借助于sonarqube实现的jenkins的插件。\n  安装插件\n插件中心搜索sonarqube，直接安装\n  配置插件\n系统管理-系统配置- SonarQube servers -Add SonarQube\n  Name：sonarqube\n  Server URL：http://sonar.luffy.com\n  Server authentication token\n① 登录sonarqube - My Account - Security - Generate Token\n② 登录Jenkins，添加全局凭据，类型为Secret text\n    如何在jenkinsfile中使用\n我们在 https://jenkins.io/doc/pipeline/steps/sonar/ 官方介绍中可以看到：\n    Jenkinsfile集成sonarqube演示 jenkins/pipelines/p9.yaml\npipeline {  agent { label 'jnlp-slave'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('git-log') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  container('tools') {  checkout scm  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  withSonarQubeEnv('sonarqube') {  sh 'sonar-scanner -X'  sleep 3  }  script {  timeout(1) {  def qg = waitForQualityGate('sonarqube')  if (qg.status != 'OK') {  error \"未通过Sonarqube的代码质量阈检查，请及时修改！failure: ${qg.status}\"  }  }  }  }  }  }  }  }  stage('build-image') {  steps {  container('tools') {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  container('tools') {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  container('tools') {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/\"  }  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😄👍 构建成功 👍😄 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😖❌ 构建失败 ❌😖 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } }   集成RobotFramework实现验收测试 一个基于Python语言，用于验收测试和验收测试驱动开发（ATDD）的通用测试自动化框架，提供了一套特定的语法，并且有非常丰富的测试库 。\nrobot用例简介 robot/robot.txt\n*** Settings *** Library RequestsLibrary Library SeleniumLibrary  *** Variables *** ${demo_url} http://myblog.luffy/admin  *** Test Cases *** api  [Tags] critical  Create Session api ${demo_url}  ${alarm_system_info} RequestsLibrary.Get Request api /  log ${alarm_system_info.status_code}  log ${alarm_system_info.content}  should be true ${alarm_system_info.status_code} == 200  ui  [Tags] critical  ${chrome_options} = Evaluate sys.modules['selenium.webdriver'].ChromeOptions() sys, selenium.webdriver  Call Method ${chrome_options} add_argument headless  Call Method ${chrome_options} add_argument no-sandbox  ${options}= Call Method ${chrome_options} to_capabilities  Open Browser ${demo_url}/ browser=chrome desired_capabilities=${options}  sleep 2s  Capture Page Screenshot  Page Should Contain Django  close browser # 使用tools镜像启动容器，来验证手动使用robotframework来做验收测试 $ docker run --rm -ti 172.21.51.67:5000/devops/tools:v2 bash bash-5.0# apk add chromium chromium-chromedriver $ cat requirements.txt robotframework robotframework-seleniumlibrary robotframework-databaselibrary robotframework-requests  #pip安装必要的软件包 $ pip install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt  #使用robot命令做测试 $ robot -d artifacts/ robot.txt 与tools工具镜像集成 FROM alpine LABEL maintainer=\"inspur_lyx@hotmail.com\" USER root  RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \u0026\u0026 \\  apk update \u0026\u0026 \\  apk add --no-cache openrc docker git curl tar gcc g++ make \\  bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \\  libstdc++ harfbuzz nss freetype ttf-freefont chromium chromium-chromedriver \u0026\u0026 \\  mkdir -p /root/.kube \u0026\u0026 \\  usermod -a -G docker root   COPY config /root/.kube/  COPY requirements.txt /  RUN pip install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt   RUN rm -rf /var/cache/apk/* \u0026\u0026 \\  rm -rf ~/.cache/pip  #-----------------安装 kubectl--------------------# COPY kubectl /usr/local/bin/ RUN chmod +x /usr/local/bin/kubectl # ------------------------------------------------#  #---------------安装 sonar-scanner-----------------# COPY sonar-scanner /usr/lib/sonar-scanner RUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner \u0026\u0026 chmod +x /usr/local/bin/sonar-scanner ENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner # ------------------------------------------------# $ docker build . -t 172.21.51.67:5000/devops/tools:v3  $ docker push 172.21.51.67:5000/devops/tools:v3 更新Jenkins中kubernetes中的containers template\n插件安装及配置 为什么要安装robot插件？\n  安装robotFramework\n 插件中心搜索robotframework，直接安装 tools集成robot命令（之前已经安装）    与jenkinsfile的集成\n container('tools') {  sh 'robot -i critical -d artifacts/ robot.txt || echo ok'  echo \"R ${currentBuild.result}\"  step([  $class : 'RobotPublisher',  outputPath: 'artifacts/',  outputFileName : \"output.xml\",  disableArchiveOutput : false,  passThreshold : 80,  unstableThreshold: 20.0,  onlyCritical : true,  otherFiles : \"*.png\"  ])  echo \"R ${currentBuild.result}\"  archiveArtifacts artifacts: 'artifacts/*', fingerprint: true  }   实践通过Jenkinsfile实现demo项目的验收测试 python-demo项目添加robot.txt文件：\njenkins/pipelines/p10.yaml\npipeline {  agent { label 'jnlp-slave'}   options { \tbuildDiscarder(logRotator(numToKeepStr: '10')) \tdisableConcurrentBuilds() \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}   environment {  IMAGE_REPO = \"172.21.51.67:5000/myblog\"  DINGTALK_CREDS = credentials('dingTalk')  TAB_STR = \"\\n \\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\"  }   stages {  stage('git-log') {  steps {  script{  sh \"git log --oneline -n 1  gitlog.file\"  env.GIT_LOG = readFile(\"gitlog.file\").trim()  }  sh 'printenv'  }  }  stage('checkout') {  steps {  container('tools') {  checkout scm  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS = env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  withSonarQubeEnv('sonarqube') {  sh 'sonar-scanner -X'  sleep 3  }  script {  timeout(1) {  def qg = waitForQualityGate('sonarqube')  if (qg.status != 'OK') {  error \"未通过Sonarqube的代码质量阈检查，请及时修改！failure: ${qg.status}\"  }  }  }  }  }  }  }  }  stage('build-image') {  steps {  container('tools') {  retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('push-image') {  steps {  container('tools') {  retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('deploy') {  steps {  container('tools') {  sh \"sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' deploy/*\"  timeout(time: 1, unit: 'MINUTES') {  sh \"kubectl apply -f deploy/;sleep 20;\"  }  }  updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')  script{  env.BUILD_TASKS += env.STAGE_NAME + \"√...\" + env.TAB_STR  }  }  }  stage('Accept Test') {  steps {  container('tools') {  sh 'robot -i critical -d artifacts/ robot.txt|| echo ok'  echo \"R ${currentBuild.result}\"  step([  $class : 'RobotPublisher',  outputPath: 'artifacts/',  outputFileName : \"output.xml\",  disableArchiveOutput : false,  passThreshold : 80,  unstableThreshold: 20.0,  onlyCritical : true,  otherFiles : \"*.png\"  ])  echo \"R ${currentBuild.result}\"  archiveArtifacts artifacts: 'artifacts/*', fingerprint: true  }  }  }  }  post {  success {  echo 'Congratulations!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😄👍 构建成功 👍😄 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  failure {  echo 'Oh no!'  sh \"\"\" curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \\ -H 'Content-Type: application/json' \\ -d '{ \"msgtype\": \"markdown\", \"markdown\": { \"title\":\"myblog\", \"text\": \"😖❌ 构建失败 ❌😖 \\n**项目名称**：luffy \\n**Git log**: ${GIT_LOG} \\n**构建分支**: ${BRANCH_NAME} \\n**构建地址**：${RUN_DISPLAY_URL} \\n**构建任务**：${BUILD_TASKS}\" } }' \"\"\"  }  always {  echo 'I will always say Hello again!'  }  } } 在Jenkins中查看robot的构建结果。\n  小结 思路：\n 讲解最基础的Jenkins的使用 Pipeline流水线的使用 Jenkinsfile的使用 多分支流水线的使用 与Kubernetes集成，动态jnlp slave pod的使用 与sonarqube集成，实现代码扫描 与Robotframework集成，实现验收测试  问题：\n Jenkinsfile过于冗长 多个项目配置Jenkinsfile，存在很多重复内容 没有实现根据不同分支来部署到不同的环境 Java项目的构建 k8s部署后，采用等待的方式执行后续步骤，不合理  ",
  "wordCount" : "5025",
  "inLanguage": "zh",
  "datePublished": "2022-01-07T14:26:43Z",
  "dateModified": "2022-01-07T14:26:43Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8Ekubernetes%E7%9A%84devops%E5%B9%B3%E5%8F%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      从零开始构建基于Kubernetes的Devops平台
    </h1>
    <div class="post-meta"><span title='2022-01-07 14:26:43 +0000 UTC'>2022-01-07</span>&nbsp;·&nbsp;24 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%9f%ba%e4%ba%8ekubernetes%e7%9a%84devops%e5%b9%b3%e5%8f%b0%e5%ae%9e%e8%b7%b5" aria-label="基于Kubernetes的DevOps平台实践">基于Kubernetes的DevOps平台实践</a><ul>
                            
                    <li>
                        <a href="#devopscicd%e4%bb%8b%e7%bb%8d" aria-label="DevOps、CI、CD介绍">DevOps、CI、CD介绍</a><ul>
                            
                    <li>
                        <a href="#%e7%80%91%e5%b8%83%e5%bc%8f%e6%b5%81%e7%a8%8b" aria-label="瀑布式流程">瀑布式流程</a></li>
                    <li>
                        <a href="#%e6%95%8f%e6%8d%b7%e5%bc%80%e5%8f%91" aria-label="敏捷开发">敏捷开发</a></li>
                    <li>
                        <a href="#devops" aria-label="DevOps">DevOps</a></li></ul>
                    </li>
                    <li>
                        <a href="#jenkins%e5%88%9d%e4%bd%93%e9%aa%8c" aria-label="Jenkins初体验">Jenkins初体验</a><ul>
                            
                    <li>
                        <a href="#kubernetes%e7%8e%af%e5%a2%83%e4%b8%ad%e9%83%a8%e7%bd%b2jenkins" aria-label="Kubernetes环境中部署jenkins">Kubernetes环境中部署jenkins</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85%e6%b1%89%e5%8c%96%e6%8f%92%e4%bb%b6" aria-label="安装汉化插件">安装汉化插件</a></li>
                    <li>
                        <a href="#jenkins%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%bc%94%e7%a4%ba" aria-label="Jenkins基本使用演示">Jenkins基本使用演示</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e7%9b%ae%e6%a0%87" aria-label="演示目标">演示目标</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e5%87%86%e5%a4%87" aria-label="演示准备">演示准备</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e8%bf%87%e7%a8%8b" aria-label="演示过程">演示过程</a></li></ul>
                    </li>
                    <li>
                        <a href="#master-slavesagent%e6%a8%a1%e5%bc%8f" aria-label="Master-Slaves（agent）模式">Master-Slaves（agent）模式</a></li>
                    <li>
                        <a href="#jenkins%e5%ae%9a%e5%88%b6%e5%8c%96%e5%ae%b9%e5%99%a8" aria-label="Jenkins定制化容器">Jenkins定制化容器</a></li>
                    <li>
                        <a href="#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93" aria-label="本章小结">本章小结</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8" aria-label="流水线入门">流水线入门</a><ul>
                            
                    <li>
                        <a href="#%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%9f%ba%e7%a1%80%e8%af%ad%e6%b3%95" aria-label="流水线基础语法">流水线基础语法</a><ul>
                            
                    <li>
                        <a href="#%e8%84%9a%e6%9c%ac%e7%a4%ba%e4%be%8b" aria-label="脚本示例">脚本示例</a></li>
                    <li>
                        <a href="#%e8%84%9a%e6%9c%ac%e8%a7%a3%e9%87%8a" aria-label="脚本解释：">脚本解释：</a></li>
                    <li>
                        <a href="#blue-ocean" aria-label="Blue Ocean:">Blue Ocean:</a></li></ul>
                    </li>
                    <li>
                        <a href="#jenkinsflie" aria-label="Jenkinsflie">Jenkinsflie</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba1%e4%bd%bf%e7%94%a8jenkinsfile%e7%ae%a1%e7%90%86pipeline" aria-label="演示1：使用Jenkinsfile管理pipeline">演示1：使用Jenkinsfile管理<strong>pipeline</strong></a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba2%e4%bc%98%e5%8c%96%e5%8f%8a%e4%b8%b0%e5%af%8c%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%86%85%e5%ae%b9" aria-label="演示2：优化及丰富流水线内容">演示2：优化及丰富流水线内容</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba3%e4%bd%bf%e7%94%a8k8s%e9%83%a8%e7%bd%b2%e6%9c%8d%e5%8a%a1" aria-label="演示3：使用k8s部署服务">演示3：使用k8s部署服务</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba4%e4%bd%bf%e7%94%a8%e5%87%ad%e6%8d%ae%e7%ae%a1%e7%90%86%e6%95%8f%e6%84%9f%e4%bf%a1%e6%81%af" aria-label="演示4：使用凭据管理敏感信息">演示4：使用凭据管理敏感信息</a></li>
                    <li>
                        <a href="#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1" aria-label="本章小结">本章小结</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%a4%9a%e5%88%86%e6%94%af%e6%b5%81%e6%b0%b4%e7%ba%bf" aria-label="多分支流水线">多分支流水线</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba1%e5%a4%9a%e5%88%86%e6%94%af%e6%b5%81%e6%b0%b4%e7%ba%bf%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="演示1：多分支流水线的使用">演示1：多分支流水线的使用</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba2%e7%be%8e%e5%8c%96%e6%b6%88%e6%81%af%e9%80%9a%e7%9f%a5%e5%86%85%e5%ae%b9" aria-label="演示2：美化消息通知内容">演示2：美化消息通知内容</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba3%e9%80%9a%e7%9f%a5gitlab%e6%9e%84%e5%bb%ba%e7%8a%b6%e6%80%81" aria-label="演示3：通知gitlab构建状态">演示3：通知gitlab构建状态</a></li>
                    <li>
                        <a href="#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e8%8a%82" aria-label="本章小节">本章小节</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b7%a5%e5%85%b7%e9%9b%86%e6%88%90%e4%b8%8ejenkinsfile%e5%ae%9e%e8%b7%b5%e7%af%87" aria-label="工具集成与Jenkinsfile实践篇">工具集成与Jenkinsfile实践篇</a><ul>
                            
                    <li>
                        <a href="#%e9%9b%86%e6%88%90kubernetes" aria-label="集成Kubernetes">集成Kubernetes</a><ul>
                            
                    <li>
                        <a href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae" aria-label="插件安装及配置">插件安装及配置</a></li>
                    <li>
                        <a href="#%e6%bc%94%e7%a4%ba%e5%8a%a8%e6%80%81slave-pod" aria-label="演示动态slave pod">演示动态slave pod</a></li>
                    <li>
                        <a href="#pod-template%e4%b8%ad%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e7%9a%84%e5%88%b6%e4%bd%9c" aria-label="Pod-Template中容器镜像的制作">Pod-Template中容器镜像的制作</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5%e9%80%9a%e8%bf%87jenkinsfile%e5%ae%9e%e7%8e%b0demo%e9%a1%b9%e7%9b%ae%e8%87%aa%e5%8a%a8%e5%8f%91%e5%b8%83%e5%88%b0kubenetes%e7%8e%af%e5%a2%83" aria-label="实践通过Jenkinsfile实现demo项目自动发布到kubenetes环境">实践通过Jenkinsfile实现demo项目自动发布到kubenetes环境</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%9b%86%e6%88%90sonarqube%e5%ae%9e%e7%8e%b0%e4%bb%a3%e7%a0%81%e6%89%ab%e6%8f%8f" aria-label="集成sonarQube实现代码扫描">集成sonarQube实现代码扫描</a><ul>
                            
                    <li>
                        <a href="#sonarqube%e6%9e%b6%e6%9e%84%e7%ae%80%e4%bb%8b" aria-label="sonarqube架构简介">sonarqube架构简介</a></li>
                    <li>
                        <a href="#sonarqube-on-kubernetes%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="sonarqube on kubernetes环境搭建">sonarqube on kubernetes环境搭建</a></li>
                    <li>
                        <a href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae-1" aria-label="插件安装及配置">插件安装及配置</a></li>
                    <li>
                        <a href="#jenkinsfile%e9%9b%86%e6%88%90sonarqube%e6%bc%94%e7%a4%ba" aria-label="Jenkinsfile集成sonarqube演示">Jenkinsfile集成sonarqube演示</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%9b%86%e6%88%90robotframework%e5%ae%9e%e7%8e%b0%e9%aa%8c%e6%94%b6%e6%b5%8b%e8%af%95" aria-label="集成RobotFramework实现验收测试">集成RobotFramework实现验收测试</a><ul>
                            
                    <li>
                        <a href="#robot%e7%94%a8%e4%be%8b%e7%ae%80%e4%bb%8b" aria-label="robot用例简介">robot用例简介</a></li>
                    <li>
                        <a href="#%e4%b8%8etools%e5%b7%a5%e5%85%b7%e9%95%9c%e5%83%8f%e9%9b%86%e6%88%90" aria-label="与tools工具镜像集成">与tools工具镜像集成</a></li>
                    <li>
                        <a href="#%e6%8f%92%e4%bb%b6%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae-2" aria-label="插件安装及配置">插件安装及配置</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5%e9%80%9a%e8%bf%87jenkinsfile%e5%ae%9e%e7%8e%b0demo%e9%a1%b9%e7%9b%ae%e7%9a%84%e9%aa%8c%e6%94%b6%e6%b5%8b%e8%af%95" aria-label="实践通过Jenkinsfile实现demo项目的验收测试">实践通过Jenkinsfile实现demo项目的验收测试</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="基于kubernetes的devops平台实践">基于Kubernetes的DevOps平台实践<a hidden class="anchor" aria-hidden="true" href="#基于kubernetes的devops平台实践">#</a></h3>
<p>持续集成工具：</p>
<ul>
<li>Jenkins</li>
<li>gitlabci</li>
<li>Tekton</li>
</ul>
<p>本章基于k8s集群部署gitlab、sonarQube、Jenkins等工具，并把上述工具集成到Jenkins中，以Django项目和SpringBoot项目为例，通过多分支流水线及Jenkinsfile实现项目代码提交到不同的仓库分支，实现自动代码扫描、单元测试、docker容器构建、k8s服务的自动部署。</p>
<ul>
<li>DevOps、CI、CD介绍</li>
<li>Jenkins、sonarQube、gitlab的快速部署</li>
<li>Jenkins初体验</li>
<li>流水线入门及Jenkinsfile使用</li>
<li>Jenkins与Kubernetes的集成</li>
<li>sonarQube代码扫描与Jenkins的集成</li>
<li>实践Django项目的基于Jenkinsfile实现开发、测试环境的CI/CD</li>
</ul>
<h4 id="devopscicd介绍">DevOps、CI、CD介绍<a hidden class="anchor" aria-hidden="true" href="#devopscicd介绍">#</a></h4>
<p>Continuous Integration (<em>CI</em>) / Continuous Delivery (<em>CD</em>)</p>
<p>软件交付流程</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-roles.jpg" alt=""  />
</p>
<p>一个软件从零开始到最终交付，大概包括以下几个阶段：规划、编码、构建、测试、发布、部署和维护，基于这些阶段，我们的软件交付模型大致经历了几个阶段：</p>
<h5 id="瀑布式流程">瀑布式流程<a hidden class="anchor" aria-hidden="true" href="#瀑布式流程">#</a></h5>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-waterfall.jpg" alt=""  />
</p>
<p>前期需求确立之后，软件开发人员花费数周和数月编写代码，把所有需求一次性开发完，然后将代码交给QA（质量保障）团队进行测试，然后将最终的发布版交给运维团队去部署。瀑布模型，简单来说，就是等一个阶段所有工作完成之后，再进入下一个阶段。这种模式的问题也很明显，产品迭代周期长，灵活性差。一个周期动辄几周几个月，适应不了当下产品需要快速迭代的场景。</p>
<h5 id="敏捷开发">敏捷开发<a hidden class="anchor" aria-hidden="true" href="#敏捷开发">#</a></h5>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-agile.jpg" alt=""  />
</p>
<p>任务由大拆小，开发、测试协同工作，注重开发敏捷，不重视交付敏捷</p>
<h5 id="devops">DevOps<a hidden class="anchor" aria-hidden="true" href="#devops">#</a></h5>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-compire.jpg" alt=""  />
</p>
<p>开发、测试、运维协同工作, 持续开发+持续交付。</p>
<p>我们是否可以认为DevOps = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式？</p>
<p>大家想一下为什么最初的开发模式没有直接进入DevOps的时代？</p>
<p>原因是：沟通成本。</p>
<p>各角色人员去沟通协作的时候都是手动去做，交流靠嘴，靠人去指挥，很显然会出大问题。所以说不能认为DevOps就是一种交付模式，因为解决不了沟通协作成本，这种模式就不具备可落地性。</p>
<p>那DevOps时代如何解决角色之间的成本问题？DevOps的核心就是自动化。自动化的能力靠什么来支撑，工具和技术。</p>
<p>DevOps工具链</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/devops-tools.jpg" alt=""  />
</p>
<p>靠这些工具和技术，才实现了自动化流程，进而解决了协作成本，使得devops具备了可落地性。因此我们可以大致给devops一个定义：</p>
<p>devops = 提倡开发、测试、运维协同工作来实现持续开发、持续交付的一种软件交付模式 + 基于工具和技术支撑的自动化流程的落地实践。</p>
<p>因此devops不是某一个具体的技术，而是一种思想+自动化能力，来使得构建、测试、发布软件能够更加地便捷、频繁和可靠的落地实践。本次课程核心内容就是要教会大家如何利用工具和技术来实现完整的DevOps平台的建设。我们主要使用的工具有：</p>
<ol>
<li>gitlab，代码仓库，企业内部使用最多的代码版本管理工具。</li>
<li>Jenkins， 一个可扩展的持续集成引擎，用于自动化各种任务，包括构建、测试和部署软件。</li>
<li>robotFramework， 基于Python的自动化测试框架</li>
<li>sonarqube，代码质量管理平台</li>
<li>maven，java包构建管理工具</li>
<li>Kubernetes</li>
<li>Docker</li>
</ol>
<h4 id="jenkins初体验">Jenkins初体验<a hidden class="anchor" aria-hidden="true" href="#jenkins初体验">#</a></h4>
<h5 id="kubernetes环境中部署jenkins">Kubernetes环境中部署jenkins<a hidden class="anchor" aria-hidden="true" href="#kubernetes环境中部署jenkins">#</a></h5>
<p><a href="https://jenkins.io/zh/doc/book/installing/">其他部署方式</a></p>
<p>注意点：</p>
<ol>
<li>第一次启动很慢</li>
<li>因为后面Jenkins会与kubernetes集群进行集成，会需要调用kubernetes集群的api，因此安装的时候创建了ServiceAccount并赋予了cluster-admin的权限</li>
<li>默认部署到jenkins=true的节点</li>
<li>初始化容器来设置权限</li>
<li>ingress来外部访问</li>
<li>数据存储通过hostpath挂载到宿主机中</li>
</ol>
<p><code>jenkins/jenkins-all.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins-crb</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">devops</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">devops</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">jenkins</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">serviceAccount</span>: <span style="color:#ae81ff">jenkins</span> <span style="color:#75715e">#Pod 需要使用的服务账号</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fix-permissions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;chown -R 1000:1000 /var/jenkins_home&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkinshome</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/jenkins_home</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">jenkinsci/blueocean:1.23.2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span> <span style="color:#75715e">#Jenkins Master Web 服务端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slavelistener</span> <span style="color:#75715e">#Jenkins Master 供未来 Slave 连接的端口</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkinshome</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/jenkins_home</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;-Xms4096m -Xmx5120m -Duser.timezone=Asia/Shanghai -Dhudson.model.DirectoryBrowserSupport.CSP=&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkinshome</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/jenkins_home/</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">slavelistener</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">devops</span>: <span style="color:#ae81ff">jenkins-master</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">jenkins-web</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">jenkins.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span></code></pre></div><p>创建服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 为k8s-slave1打标签，将jenkins-master部署在k8s-slave1节点</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave1 jenkins=true
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 部署服务</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> jenkins-all.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看服务</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins get po
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>jenkins-master-767df9b574-lgdr5   1/1     Running   0          20s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看日志，第一次启动提示需要完成初始化设置</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins logs <span style="color:#f92672">-f</span> jenkins-master-767df9b574-lgdr5
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>*************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Jenkins initial setup is required. An admin user has been created and a password generated.
</span></span><span style="display:flex;"><span>Please use the following password to proceed to installation<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>5396b4e1c395450f8360efd8ee641b18
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This may also be found at<span style="color:#960050;background-color:#1e0010">:</span> /var/jenkins_home/secrets/initialAdminPassword
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*************************************************************
</span></span></code></pre></div><p>访问服务：</p>
<p>配置hosts解析，<code>172.21.51.67 jenkins.luffy.com</code>，然后使用浏览器域名访问服务。第一次访问需要大概几分钟的初始化时间。</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins_setup.jpg" alt=""  />
</p>
<p>使用jenkins启动日志中的密码，或者执行下面的命令获取解锁的管理员密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n jenkins exec jenkins-master-767df9b574-lgdr5 bash 
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># cat /var/jenkins_home/secrets/initialAdminPassword</span>
</span></span><span style="display:flex;"><span>35b083de1d25409eaef57255e0da481a
</span></span></code></pre></div><p>点击叉号，跳过选择安装推荐的插件环节，直接进入Jenkins。由于默认的插件地址安装非常慢，我们可以替换成国内清华的源，进入 jenkins 工作目录，目录下面有一个 <code>updates</code> 的目录，下面有一个 <code>default.json</code> 文件，我们执行下面的命令替换插件地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cd /var/jenkins_home/updates
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#39;</span> <span style="color:#66d9ef">default</span>.json 
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#39;</span> <span style="color:#66d9ef">default</span>.json
</span></span></code></pre></div><blockquote>
<p>暂时先不用重新启动pod，汉化后一起重启。</p>
</blockquote>
<p>选择右上角admin-&gt;configure-&gt;password重新设置管理员密码，设置完后，会退出要求重新登录，使用admin/xxxxxx(新密码)，登录即可。</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-mainpage.jpg" alt=""  />
</p>
<h5 id="安装汉化插件">安装汉化插件<a hidden class="anchor" aria-hidden="true" href="#安装汉化插件">#</a></h5>
<p>Jenkins -&gt; manage Jenkins -&gt; Plugin Manager -&gt; Avaliable，搜索 <code>chinese</code>关键字</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-install-plugins.jpg" alt=""  />
</p>
<p>选中后，选择[Install without restart]，等待下载完成，然后点击[ Restart Jenkins when installation is complete and no jobs are running ]，让Jenkins自动重启</p>
<p>启动后，界面默认变成中文。</p>
<h5 id="jenkins基本使用演示">Jenkins基本使用演示<a hidden class="anchor" aria-hidden="true" href="#jenkins基本使用演示">#</a></h5>
<h6 id="演示目标">演示目标<a hidden class="anchor" aria-hidden="true" href="#演示目标">#</a></h6>
<ul>
<li>代码提交gitlab，自动触发Jenkins任务</li>
<li>Jenkins任务完成后发送钉钉消息通知</li>
</ul>
<h6 id="演示准备">演示准备<a hidden class="anchor" aria-hidden="true" href="#演示准备">#</a></h6>
<p><em>gitlab代码仓库搭建</em></p>
<p><a href="https://github.com/sameersbn/docker-gitlab">https://github.com/sameersbn/docker-gitlab</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 全量部署的组件</span>
</span></span><span style="display:flex;"><span>$ gitlab-ctl status
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> alertmanager<span style="color:#960050;background-color:#1e0010">:</span> (pid 1987) 27s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1986) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> gitaly<span style="color:#960050;background-color:#1e0010">:</span> (pid 1950) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1949) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> gitlab-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1985) 27s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1984) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> gitlab-workhorse<span style="color:#960050;background-color:#1e0010">:</span> (pid 1956) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1955) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> logrotate<span style="color:#960050;background-color:#1e0010">:</span> (pid 1960) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1959) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> nginx<span style="color:#960050;background-color:#1e0010">:</span> (pid 2439) 1s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1990) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> node-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1963) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1962) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> postgres-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1989) 27s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1988) 27s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> postgresql<span style="color:#960050;background-color:#1e0010">:</span> (pid 1945) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1944) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> prometheus<span style="color:#960050;background-color:#1e0010">:</span> (pid 1973) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1972) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> puma<span style="color:#960050;background-color:#1e0010">:</span> (pid 1968) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1966) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> redis<span style="color:#960050;background-color:#1e0010">:</span> (pid 1952) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1951) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> redis-exporter<span style="color:#960050;background-color:#1e0010">:</span> (pid 1971) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1964) 28s
</span></span><span style="display:flex;"><span>run<span style="color:#960050;background-color:#1e0010">:</span> sidekiq<span style="color:#960050;background-color:#1e0010">:</span> (pid 1969) 28s; run<span style="color:#960050;background-color:#1e0010">:</span> log<span style="color:#960050;background-color:#1e0010">:</span> (pid 1967) 28s
</span></span></code></pre></div><p>部署分析：</p>
<ol>
<li>依赖postgres</li>
<li>依赖redis</li>
</ol>
<p>使用k8s部署：</p>
<ol>
<li>
<p>准备secret文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat gitlab-secret.txt
</span></span><span style="display:flex;"><span>postgres.user.root=root
</span></span><span style="display:flex;"><span>postgres.pwd.root=1qaz2wsx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins create secret generic gitlab-secret --from-env<span style="color:#f92672">-file</span>=gitlab-secret.txt
</span></span></code></pre></div></li>
<li>
<p>部署postgres</p>
<p>注意点：</p>
<ul>
<li>使用secret来引用账户密码</li>
<li>使用postgres=true来指定节点</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat postgres.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> server
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 5432
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 5432
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      nodeSelector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        postgres<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      tolerations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - operator<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> postgres
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span>  172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/postgres<span style="color:#960050;background-color:#1e0010">:</span>11.4 <span style="color:#75715e">#若本地没有启动该仓库，换成postgres:11.4</span>
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 5432
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> POSTGRES_USER           <span style="color:#75715e">#PostgreSQL 用户名</span>
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.user.root
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> POSTGRES_PASSWORD       <span style="color:#75715e">#PostgreSQL 密码</span>
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.pwd.root
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 1000m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 2048Mi
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>        volumeMounts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - mountPath<span style="color:#960050;background-color:#1e0010">:</span> /var/lib/postgresql/data
</span></span><span style="display:flex;"><span>          name<span style="color:#960050;background-color:#1e0010">:</span> postgredb
</span></span><span style="display:flex;"><span>      volumes<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> postgredb
</span></span><span style="display:flex;"><span>        hostPath<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          path<span style="color:#960050;background-color:#1e0010">:</span> /var/lib/postgres/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#部署到k8s-slave2节点</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave2 postgres=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#创建postgres</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> postgres.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建数据库gitlab,为后面部署gitlab组件使用</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins exec -ti postgres-7ff9b49f4c-nt8zh bash
</span></span><span style="display:flex;"><span>root@postgres-7ff9b49f4c-nt8zh<span style="color:#960050;background-color:#1e0010">:</span>/<span style="color:#75715e"># psql</span>
</span></span><span style="display:flex;"><span>root=<span style="color:#75715e"># create database gitlab;</span>
</span></span><span style="display:flex;"><span>CREATE DATABASE
</span></span></code></pre></div></li>
<li>
<p>部署redis</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat redis.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> server
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 6379
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 6379
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      tolerations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - operator<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> redis
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span>  sameersbn/redis<span style="color:#960050;background-color:#1e0010">:</span>4.0.9-2
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 6379
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 1000m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 2048Mi
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 50m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 100Mi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> redis.yaml
</span></span></code></pre></div></li>
<li>
<p>部署gitlab</p>
<p>注意点：</p>
<ul>
<li>使用ingress暴漏服务</li>
<li>添加annotation，指定nginx端上传大小限制，否则推送代码时会默认被限制1m大小，相当于给nginx设置client_max_body_size的限制大小</li>
<li>使用gitlab=true来选择节点</li>
<li>使用服务发现地址来访问postgres和redis</li>
<li>在secret中引用数据库账户和密码</li>
<li>数据库名称为gitlab</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat gitlab.yaml
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> extensions/v1beta1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Ingress
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  annotations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    nginx.ingress.kubernetes.io/proxy-body-size<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;50m&#34;</span>
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  rules<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - host<span style="color:#960050;background-color:#1e0010">:</span> gitlab.luffy.com
</span></span><span style="display:flex;"><span>    http<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      paths<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - backend<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          serviceName<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>          servicePort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        path<span style="color:#960050;background-color:#1e0010">:</span> /
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - name<span style="color:#960050;background-color:#1e0010">:</span> server
</span></span><span style="display:flex;"><span>    port<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> apps/v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Deployment
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> jenkins
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  replicas<span style="color:#960050;background-color:#1e0010">:</span> 1
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    matchLabels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>  template<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      labels<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        app<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      nodeSelector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        gitlab<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      tolerations<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - operator<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;Exists&#34;</span>
</span></span><span style="display:flex;"><span>      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> gitlab
</span></span><span style="display:flex;"><span>        image<span style="color:#960050;background-color:#1e0010">:</span>  sameersbn/gitlab<span style="color:#960050;background-color:#1e0010">:</span>13.2.2
</span></span><span style="display:flex;"><span>        imagePullPolicy<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;IfNotPresent&#34;</span>
</span></span><span style="display:flex;"><span>        env<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_HOST
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;gitlab.luffy.com&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_PORT
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_DB_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_DB_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_SECRET_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> GITLAB_SECRETS_OTP_KEY_BASE
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;long-and-random-alpha-numeric-string&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_HOST
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;postgres&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_NAME
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;gitlab&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_USER
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.user.root
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> DB_PASS
</span></span><span style="display:flex;"><span>          valueFrom<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            secretKeyRef<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>              name<span style="color:#960050;background-color:#1e0010">:</span> gitlab-secret
</span></span><span style="display:flex;"><span>              key<span style="color:#960050;background-color:#1e0010">:</span> postgres.pwd.root
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> REDIS_HOST
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;redis&#34;</span>
</span></span><span style="display:flex;"><span>        - name<span style="color:#960050;background-color:#1e0010">:</span> REDIS_PORT
</span></span><span style="display:flex;"><span>          value<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;6379&#34;</span>
</span></span><span style="display:flex;"><span>        ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - containerPort<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>        resources<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          limits<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 2000m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 5048Mi
</span></span><span style="display:flex;"><span>          requests<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>            cpu<span style="color:#960050;background-color:#1e0010">:</span> 100m
</span></span><span style="display:flex;"><span>            memory<span style="color:#960050;background-color:#1e0010">:</span> 500Mi
</span></span><span style="display:flex;"><span>        volumeMounts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>        - mountPath<span style="color:#960050;background-color:#1e0010">:</span> /home/git/data
</span></span><span style="display:flex;"><span>          name<span style="color:#960050;background-color:#1e0010">:</span> data
</span></span><span style="display:flex;"><span>      volumes<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>      - name<span style="color:#960050;background-color:#1e0010">:</span> data
</span></span><span style="display:flex;"><span>        hostPath<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          path<span style="color:#960050;background-color:#1e0010">:</span> /var/lib/gitlab/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#部署到k8s-slave2节点</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave2 gitlab=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> gitlab.yaml
</span></span></code></pre></div></li>
</ol>
<p>配置hosts解析：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>172.21.51.67 gitlab.luffy.com
</span></span></code></pre></div><p><em>设置root密码</em></p>
<p>访问http://gitlab.luffy.com，设置管理员密码</p>
<p><em>配置k8s-master节点的hosts</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;172.21.51.67 gitlab.luffy.com&#34;</span> &gt;&gt;/etc/hosts
</span></span></code></pre></div><p><em>myblog项目推送到gitlab</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mkdir demo
</span></span><span style="display:flex;"><span>cp -r myblog demo/
</span></span><span style="display:flex;"><span>cd demo/myblog
</span></span><span style="display:flex;"><span>git remote rename origin old-origin
</span></span><span style="display:flex;"><span>git remote add origin http<span style="color:#960050;background-color:#1e0010">:</span>//gitlab.luffy.com/root/myblog.git
</span></span><span style="display:flex;"><span>git push -u origin --all
</span></span><span style="display:flex;"><span>git push -u origin --tags
</span></span></code></pre></div><p><em>钉钉推送</em></p>
<p><a href="https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq">官方文档</a></p>
<ul>
<li>
<p>配置机器人</p>
</li>
<li>
<p>试验发送消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39;</span> \
</span></span><span style="display:flex;"><span>   -H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> \
</span></span><span style="display:flex;"><span>   -d <span style="color:#e6db74">&#39;{&#34;msgtype&#34;: &#34;text&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;text&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;content&#34;: &#34;我就是我, 是不一样的烟火&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h6 id="演示过程">演示过程<a hidden class="anchor" aria-hidden="true" href="#演示过程">#</a></h6>
<p>流程示意图：</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-gitlab.png" alt=""  />
</p>
<ol>
<li>
<p>安装gitlab plugin</p>
<p>插件中心搜索并安装gitlab，直接安装即可</p>
</li>
<li>
<p>配置Gitlab</p>
<p>系统管理-&gt;系统配置-&gt;Gitlab，其中的API Token，需要从下个步骤中获取</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-connection.jpg" alt=""  />
</p>
</li>
<li>
<p>获取AccessToken</p>
<p>登录gitlab，选择user-&gt;Settings-&gt;access tokens新建一个访问token</p>
</li>
<li>
<p>配置host解析</p>
<p>由于我们的Jenkins和gitlab域名是本地解析，因此需要让gitlab和Jenkins服务可以解析到对方的域名。两种方式：</p>
<ul>
<li>
<p>在容器内配置hosts</p>
</li>
<li>
<p>配置coredns的静态解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>        hosts {
</span></span><span style="display:flex;"><span>            172.21.51.67 jenkins.luffy.com  gitlab.luffy.com
</span></span><span style="display:flex;"><span>            fallthrough
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>创建自由风格项目</p>
<ul>
<li>gitlab connection 选择为刚创建的gitlab</li>
<li>源码管理选择Git，填项项目地址</li>
<li>新建一个 Credentials 认证，使用用户名密码方式，配置gitlab的用户和密码</li>
<li>构建触发器选择 Build when a change is pushed to GitLab</li>
<li>生成一个Secret token</li>
<li>保存</li>
</ul>
</li>
<li>
<p>到gitlab配置webhook</p>
<ul>
<li>进入项目下settings-&gt;Integrations</li>
<li>URL： <a href="http://jenkins.luffy.com/project/free">http://jenkins.luffy.com/project/free</a></li>
<li>Secret Token 填入在Jenkins端生成的token</li>
<li>Add webhook</li>
<li>test push events，报错：Requests to the local network are not allowed</li>
</ul>
</li>
<li>
<p>设置gitlab允许向本地网络发送webhook请求</p>
<p>访问 Admin Aera -&gt; Settings -&gt; Network ，展开Outbound requests</p>
<p>Collapse，勾选第一项即可。再次test push events，成功。</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-webhook-success.jpg" alt=""  />
</p>
</li>
<li>
<p>配置free项目，增加构建步骤，执行shell，将发送钉钉消息的shell保存</p>
</li>
<li>
<p>提交代码到gitlab仓库，查看构建是否自动执行</p>
</li>
</ol>
<blockquote>
</blockquote>
<h5 id="master-slavesagent模式">Master-Slaves（agent）模式<a hidden class="anchor" aria-hidden="true" href="#master-slavesagent模式">#</a></h5>
<p>上面演示的任务，默认都是在master节点执行的，多个任务都在master节点执行，对master节点的性能会造成一定影响，如何将任务分散到不同的节点，做成多slave的方式？</p>
<ol>
<li>
<p>添加slave节点</p>
<ul>
<li>
<p>系统管理 -&gt; 节点管理 -&gt; 新建节点</p>
</li>
<li>
<p>比如添加172.21.51.68，选择固定节点，保存</p>
</li>
<li>
<p>远程工作目录/opt/jenkins_jobs</p>
</li>
<li>
<p>标签为任务选择节点的依据，如172.21.51.68</p>
</li>
<li>
<p>启动方式选择通过java web启动代理，代理是运行jar包，通过JNLP（是一种允许客户端启动托管在远程Web服务器上的应用程序的协议 ）启动连接到master节点服务中</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-new-node.jpg" alt=""  />
</p>
</li>
</ul>
</li>
<li>
<p>执行java命令启动agent服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 登录172.21.51.68，下载agent.jar</span>
</span></span><span style="display:flex;"><span>$ wget http<span style="color:#960050;background-color:#1e0010">:</span>//jenkins.luffy.com/jnlpJars/agent.jar
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 会提示找不到agent错误，因为没有配置地址解析，由于连接jenkins master会通过50000端口，直接使用cluster-ip</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins get svc <span style="color:#75715e">#在master节点执行查询cluster-ip地址</span>
</span></span><span style="display:flex;"><span>NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)              AGE
</span></span><span style="display:flex;"><span>jenkins   ClusterIP   10.99.204.208   &lt;none&gt;        8080/TCP,50000/TCP   4h8m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 再次回到68节点</span>
</span></span><span style="display:flex;"><span>$ wget 10.99.204.208<span style="color:#960050;background-color:#1e0010">:</span>8080/jnlpJars/agent.jar
</span></span><span style="display:flex;"><span>$ java -jar agent.jar -jnlpUrl http<span style="color:#960050;background-color:#1e0010">:</span>//10.99.204.208<span style="color:#960050;background-color:#1e0010">:</span>8080/computer/172.21.51.68/slave-agent.jnlp -secret 4be4d164f861d2830835653567867a1e695b30c320d35eca2be9f5624f8712c8 -workDir <span style="color:#e6db74">&#34;/opt/jenkins_jobs&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Remoting server accepts the following protocols<span style="color:#960050;background-color:#1e0010">:</span> [JNLP4-connect, Ping]
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Agent discovery successful
</span></span><span style="display:flex;"><span>  Agent address<span style="color:#960050;background-color:#1e0010">:</span> 10.99.204.208
</span></span><span style="display:flex;"><span>  Agent port<span style="color:#960050;background-color:#1e0010">:</span>    50000
</span></span><span style="display:flex;"><span>  Identity<span style="color:#960050;background-color:#1e0010">:</span>      e4<span style="color:#960050;background-color:#1e0010">:</span>46<span style="color:#960050;background-color:#1e0010">:</span>3a<span style="color:#960050;background-color:#1e0010">🇩🇪</span>86<span style="color:#960050;background-color:#1e0010">:</span>24<span style="color:#960050;background-color:#1e0010">:</span>8e<span style="color:#960050;background-color:#1e0010">:</span>15<span style="color:#960050;background-color:#1e0010">:</span>09<span style="color:#960050;background-color:#1e0010">:</span>13<span style="color:#960050;background-color:#1e0010">:</span>3d<span style="color:#960050;background-color:#1e0010">:</span>a7<span style="color:#960050;background-color:#1e0010">:</span>4e<span style="color:#960050;background-color:#1e0010">:</span>07<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>37
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Handshaking
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Connecting to 10.99.204.208<span style="color:#960050;background-color:#1e0010">:</span>50000
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>03<span style="color:#960050;background-color:#1e0010">:</span>51 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Trying protocol<span style="color:#960050;background-color:#1e0010">:</span> JNLP4-connect
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>02 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Remote identity confirmed<span style="color:#960050;background-color:#1e0010">:</span> e4<span style="color:#960050;background-color:#1e0010">:</span>46<span style="color:#960050;background-color:#1e0010">:</span>3a<span style="color:#960050;background-color:#1e0010">🇩🇪</span>86<span style="color:#960050;background-color:#1e0010">:</span>24<span style="color:#960050;background-color:#1e0010">:</span>8e<span style="color:#960050;background-color:#1e0010">:</span>15<span style="color:#960050;background-color:#1e0010">:</span>09<span style="color:#960050;background-color:#1e0010">:</span>13<span style="color:#960050;background-color:#1e0010">:</span>3d<span style="color:#960050;background-color:#1e0010">:</span>a7<span style="color:#960050;background-color:#1e0010">:</span>4e<span style="color:#960050;background-color:#1e0010">:</span>07<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>37
</span></span><span style="display:flex;"><span>Apr 01, 2020 7<span style="color:#960050;background-color:#1e0010">:</span>04<span style="color:#960050;background-color:#1e0010">:</span>03 PM hudson.remoting.jnlp.Main$CuiListener status
</span></span><span style="display:flex;"><span>INFO<span style="color:#960050;background-color:#1e0010">:</span> Connected
</span></span></code></pre></div><p>若出现如下错误:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SEVERE<span style="color:#960050;background-color:#1e0010">:</span> http<span style="color:#960050;background-color:#1e0010">:</span>//jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity.
</span></span><span style="display:flex;"><span>java.io.IOException<span style="color:#960050;background-color:#1e0010">:</span> http<span style="color:#960050;background-color:#1e0010">:</span>//jenkins.luffy.com/tcpSlaveAgentListener/ appears to be publishing an invalid X-Instance-Identity.
</span></span><span style="display:flex;"><span>        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve(JnlpAgentEndpointResolver.java<span style="color:#960050;background-color:#1e0010">:</span>287)
</span></span><span style="display:flex;"><span>        at hudson.remoting.Engine.innerRun(Engine.java<span style="color:#960050;background-color:#1e0010">:</span>694)
</span></span><span style="display:flex;"><span>        at hudson.remoting.Engine.run(Engine.java<span style="color:#960050;background-color:#1e0010">:</span>519)
</span></span></code></pre></div><p>可以选择： 配置从节点 -&gt; 高级 -&gt; Tunnel连接位置，参考下图进行设置:</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/slave-tunnel.jpg" alt=""  />
</p>
</li>
<li>
<p>查看Jenkins节点列表，新节点已经处于可用状态</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-node-lists.jpg" alt=""  />
</p>
</li>
<li>
<p>测试使用新节点执行任务</p>
<ul>
<li>
<p>配置free项目</p>
</li>
<li>
<p>限制项目的运行节点 ，标签表达式选择172.21.51.68</p>
</li>
<li>
<p>立即构建</p>
</li>
<li>
<p>查看构建日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Started by user admin
</span></span><span style="display:flex;"><span>Running as SYSTEM
</span></span><span style="display:flex;"><span>Building remotely on 172.21.51.68 <span style="color:#66d9ef">in</span> workspace /opt/jenkins_jobs/workspace/free-demo
</span></span><span style="display:flex;"><span>using credential gitlab-user
</span></span><span style="display:flex;"><span>Cloning the remote Git repository
</span></span><span style="display:flex;"><span>Cloning repository http<span style="color:#960050;background-color:#1e0010">:</span>//gitlab.luffy.com/root/myblog.git
</span></span><span style="display:flex;"><span> &gt; git init /opt/jenkins_jobs/workspace/free-demo <span style="color:#75715e"># timeout=10</span>
</span></span><span style="display:flex;"><span> ...
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
<blockquote>
</blockquote>
<h5 id="jenkins定制化容器">Jenkins定制化容器<a hidden class="anchor" aria-hidden="true" href="#jenkins定制化容器">#</a></h5>
<p>由于每次新部署Jenkins环境，均需要安装很多必要的插件，因此考虑把插件提前做到镜像中</p>
<p><em>Dockerfile</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> jenkinsci/blueocean:1.23.2</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> maintainer<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">## 用最新的插件列表文件替换默认插件文件</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> plugins.txt /usr/share/jenkins/ref/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">## 执行插件安装</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> /usr/local/bin/install-plugins.sh &lt; /usr/share/jenkins/ref/plugins.txt<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><em>plugins.txt</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ace<span style="color:#f92672">-</span>editor:<span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span>allure<span style="color:#f92672">-</span>jenkins<span style="color:#f92672">-</span>plugin:<span style="color:#ae81ff">2.28.1</span>
</span></span><span style="display:flex;"><span>ant:<span style="color:#ae81ff">1.10</span>
</span></span><span style="display:flex;"><span>antisamy<span style="color:#f92672">-</span>markup<span style="color:#f92672">-</span>formatter:<span style="color:#ae81ff">1.6</span>
</span></span><span style="display:flex;"><span>apache<span style="color:#f92672">-</span>httpcomponents<span style="color:#f92672">-</span>client<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#f92672">-</span>api:<span style="color:#ae81ff">4.5.10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>authentication<span style="color:#f92672">-</span>tokens:<span style="color:#ae81ff">1.3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p><em>get_plugin.sh</em></p>
<blockquote>
<p>admin:123456@localhost 需要替换成Jenkins的用户名、密码及访问地址</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash</span>
</span></span><span style="display:flex;"><span>curl -sSL  <span style="color:#e6db74">&#34;http://admin:123456@localhost:8080/pluginManager/api/xml?depth=1&amp;xpath=/*/*/shortName|/*/*/version&amp;wrapper=plugins&#34;</span> | perl -pe <span style="color:#e6db74">&#39;s/.*?&lt;shortName&gt;([\w-]+).*?&lt;version&gt;([^&lt;]+)()(&lt;\/\w+&gt;)+/\1:\2\n/g&#39;</span>|sed <span style="color:#e6db74">&#39;s/ /:/&#39;</span> &gt; plugins.txt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 执行构建，定制jenkins容器</span>
</span></span><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/jenkins<span style="color:#960050;background-color:#1e0010">:</span>v20200414 <span style="color:#f92672">-f</span> Dockerfile
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/jenkins<span style="color:#960050;background-color:#1e0010">:</span>v20200414
</span></span></code></pre></div><p>至此，我们可以使用定制化的镜像启动jenkins服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 删掉当前服务</span>
</span></span><span style="display:flex;"><span>$ kubectl delete <span style="color:#f92672">-f</span> jenkins-all.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 删掉已挂载的数据</span>
</span></span><span style="display:flex;"><span>$ rm -rf /var/jenkins_home
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 替换使用定制化镜像</span>
</span></span><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#39;s#jenkinsci/blueocean#172.21.51.67:5000/jenkins:v20200404#g&#39;</span> jenkins-all.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 重新创建服务</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> jenkins-all.yaml
</span></span></code></pre></div><h5 id="本章小结">本章小结<a hidden class="anchor" aria-hidden="true" href="#本章小结">#</a></h5>
<p>自由风格项目弊端：</p>
<ul>
<li>任务的完成需要在Jenkins端维护大量的配置</li>
<li>没法做版本控制</li>
<li>可读性、可移植性很差，不够优雅</li>
</ul>
<blockquote>
</blockquote>
<h4 id="流水线入门">流水线入门<a hidden class="anchor" aria-hidden="true" href="#流水线入门">#</a></h4>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/pipeline-factory.jpeg" alt=""  />
</p>
<p><a href="https://jenkins.io/zh/doc/book/pipeline/getting-started/">官方文档</a></p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/realworld-pipeline-flow.png" alt=""  />
</p>
<p>为什么叫做流水线，和工厂产品的生产线类似，pipeline是从源码到发布到线上环境。关于流水线，需要知道的几个点：</p>
<ul>
<li>
<p>重要的功能插件，帮助Jenkins定义了一套工作流框架；</p>
</li>
<li>
<p>Pipeline 的实现方式是一套 Groovy DSL（ 领域专用语言 ），所有的发布流程都可以表述为一段 Groovy 脚本；</p>
</li>
<li>
<p>将WebUI上需要定义的任务，以脚本代码的方式表述出来；</p>
</li>
<li>
<p>帮助jenkins实现持续集成CI（Continue Integration）和持续部署CD（Continue Deliver）的重要手段；</p>
</li>
</ul>
<h5 id="流水线基础语法">流水线基础语法<a hidden class="anchor" aria-hidden="true" href="#流水线基础语法">#</a></h5>
<p><a href="https://jenkins.io/zh/doc/book/pipeline/syntax/">官方文档</a></p>
<p>两种语法类型：</p>
<ul>
<li>Scripted Pipeline，脚本式流水线，最初支持的类型</li>
<li>Declarative Pipeline，声明式流水线，为Pipeline plugin在2.5版本之后新增的一种脚本类型，后续Open Blue Ocean所支持的类型。与原先的Scripted Pipeline一样，都可以用来编写脚本。Declarative Pipeline 是后续Open Blue Ocean所支持的类型，写法简单，支持内嵌Scripted Pipeline代码</li>
</ul>
<p><em>为与BlueOcean脚本编辑器兼容，通常建议使用Declarative Pipeline的方式进行编写,从jenkins社区的动向来看，很明显这种语法结构也会是未来的趋势。</em></p>
<h6 id="脚本示例">脚本示例<a hidden class="anchor" aria-hidden="true" href="#脚本示例">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">pipeline</span> { 
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">agent</span> <span style="color:#960050;background-color:#1e0010">{label</span> <span style="color:#960050;background-color:#1e0010">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">environment</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">PROJECT</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">&#39;myblog&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">stages</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Checkout&#39;)</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">checkout</span> <span style="color:#960050;background-color:#1e0010">scm</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Build&#39;)</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">sh</span> <span style="color:#960050;background-color:#1e0010">&#39;make&#39;</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Test&#39;)</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">sh</span> <span style="color:#960050;background-color:#1e0010">&#39;make</span> <span style="color:#960050;background-color:#1e0010">check&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">junit</span> <span style="color:#960050;background-color:#1e0010">&#39;reports/**/*.xml&#39;</span> 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">stage(&#39;Deploy&#39;)</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">steps</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">sh</span> <span style="color:#960050;background-color:#1e0010">&#39;make</span> <span style="color:#960050;background-color:#1e0010">publish&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">post</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">success</span> <span style="color:#960050;background-color:#1e0010">{</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">failure</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;Oh</span> <span style="color:#960050;background-color:#1e0010">no!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">always</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;I</span> <span style="color:#960050;background-color:#1e0010">will</span> <span style="color:#960050;background-color:#1e0010">always</span> <span style="color:#960050;background-color:#1e0010">say</span> <span style="color:#960050;background-color:#1e0010">Hello</span> <span style="color:#960050;background-color:#1e0010">again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div><h6 id="脚本解释">脚本解释：<a hidden class="anchor" aria-hidden="true" href="#脚本解释">#</a></h6>
<ul>
<li>
<p><code>checkout</code>步骤为检出代码; <code>scm</code>是一个特殊变量，指示<code>checkout</code>步骤克隆触发此Pipeline运行的特定修订</p>
</li>
<li>
<p>agent：指明使用哪个agent节点来执行任务，定义于pipeline顶层或者stage内部</p>
<ul>
<li>
<p>any，可以使用任意可用的agent来执行</p>
</li>
<li>
<p>label，在提供了标签的 Jenkins 环境中可用的代理上执行流水线或阶段。 例如: <code>agent { label 'my-defined-label' }</code>，最常见的使用方式</p>
</li>
<li>
<p>none，当在 <code>pipeline</code> 块的顶部没有全局代理， 该参数将会被分配到整个流水线的运行中并且每个 <code>stage</code> 部分都需要包含他自己的 <code>agent</code> 部分。比如: <code>agent none</code></p>
</li>
<li>
<p>docker， 使用给定的容器执行流水线或阶段。 在指定的节点中，通过运行容器来执行任务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">agent</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">docker</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">image</span> <span style="color:#960050;background-color:#1e0010">&#39;maven:3-alpine&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">label</span> <span style="color:#960050;background-color:#1e0010">&#39;my-defined-label&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">args</span>  <span style="color:#960050;background-color:#1e0010">&#39;-v</span> <span style="color:#960050;background-color:#1e0010">/tmp:/tmp&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>options:  允许从流水线内部配置特定于流水线的选项。</p>
<ul>
<li>buildDiscarder , 为最近的流水线运行的特定数量保存组件和控制台输出。例如: <code>options { buildDiscarder(logRotator(numToKeepStr: '10')) }</code></li>
<li>disableConcurrentBuilds ,不允许同时执行流水线。 可被用来防止同时访问共享资源等。 例如: <code>options { disableConcurrentBuilds() }</code></li>
<li>timeout ,设置流水线运行的超时时间, 在此之后，Jenkins将中止流水线。例如: <code>options { timeout(time: 1, unit: 'HOURS') }</code></li>
<li>retry，在失败时, 重新尝试整个流水线的指定次数。 For example: <code>options { retry(3) }</code></li>
</ul>
</li>
<li>
<p>environment:  指令制定一个 键-值对序列，该序列将被定义为所有步骤的环境变量</p>
</li>
<li>
<p>stages: 包含一系列一个或多个 <a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#stage">stage</a>指令, <code>stages</code> 部分是流水线描述的大部分&quot;work&quot; 的位置。 建议 <code>stages</code> 至少包含一个 <a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#stage">stage</a> 指令用于连续交付过程的每个离散部分,比如构建, 测试, 和部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>steps: 在给定的 <code>stage</code> 指令中执行的定义了一系列的一个或多个<a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps">steps</a>。</p>
</li>
<li>
<p>post:  定义一个或多个<a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#declarative-steps">steps</a> ，这些阶段根据流水线或阶段的完成情况而运行<code>post</code> 支持以下 <a href="https://jenkins.io/zh/doc/book/pipeline/syntax/#post-conditions">post-condition</a> 块中的其中之一: <code>always</code>, <code>changed</code>, <code>failure</code>, <code>success</code>, <code>unstable</code>, 和 <code>aborted</code>。</p>
<ul>
<li>always, 无论流水线或阶段的完成状态如何，都允许在 <code>post</code> 部分运行该步骤</li>
<li>changed, 当前流水线或阶段的完成状态与它之前的运行不同时，才允许在 <code>post</code> 部分运行该步骤</li>
<li>failure,  当前流水线或阶段的完成状态为&quot;failure&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常web UI是红色</li>
<li>success,  当前流水线或阶段的完成状态为&quot;success&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常web UI是蓝色或绿色</li>
<li>unstable,  当前流水线或阶段的完成状态为&quot;unstable&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常由于测试失败,代码违规等造成。通常web UI是黄色</li>
<li>aborted， 只有当前流水线或阶段的完成状态为&quot;aborted&quot;，才允许在 <code>post</code> 部分运行该步骤, 通常由于流水线被手动的aborted。通常web UI是灰色</li>
</ul>
</li>
</ul>
<p>创建pipeline示意：</p>
<p>新建任务 -&gt; 流水线</p>
<p><code>jenkins/pipelines/p1.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>   agent {label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>   environment { 
</span></span><span style="display:flex;"><span>      PROJECT = <span style="color:#e6db74">&#39;myblog&#39;</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   stages {
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            checkout([$class<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;GitSCM&#39;</span>, branches<span style="color:#960050;background-color:#1e0010">:</span> [[name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;*/master&#39;</span>]], doGenerateSubmoduleConfigurations<span style="color:#960050;background-color:#1e0010">:</span> false, extensions<span style="color:#960050;background-color:#1e0010">:</span> [], submoduleCfg<span style="color:#960050;background-color:#1e0010">:</span> [], userRemoteConfigs<span style="color:#960050;background-color:#1e0010">:</span> [[credentialsId<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;gitlab-user&#39;</span>, url<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;http://gitlab.luffy.com/root/myblog.git&#39;</span>]]])
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;docker build . -t myblog:latest -f Dockerfile&#39;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;send-msg&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span>我就是我, 是不一样的烟火<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>点击“立即构建”，同样的，我们可以配置触发器，使用webhook的方式接收项目的push事件，</p>
<ul>
<li>构建触发器选择 Build when a change is pushed to GitLab.</li>
<li>生成 Secret token</li>
<li>配置gitlab，创建webhook，发送test push events测试</li>
</ul>
<h6 id="blue-ocean">Blue Ocean:<a hidden class="anchor" aria-hidden="true" href="#blue-ocean">#</a></h6>
<p><a href="https://jenkins.io/zh/doc/book/blueocean/getting-started/">官方文档</a></p>
<p>我们需要知道的几点：</p>
<ul>
<li>是一个插件， 旨在为Pipeline提供丰富的体验 ；</li>
<li>连续交付（CD）Pipeline的复杂可视化，允许快速和直观地了解Pipeline的状态；</li>
<li>目前支持的类型仅针对于Pipeline，尚不能替代Jenkins 经典版UI</li>
</ul>
<p>思考：</p>
<ol>
<li>每个项目都把大量的pipeline脚本写在Jenkins端，对于谁去维护及维护成本是一个问题</li>
<li>没法做版本控制</li>
</ol>
<blockquote>
</blockquote>
<h5 id="jenkinsflie">Jenkinsflie<a hidden class="anchor" aria-hidden="true" href="#jenkinsflie">#</a></h5>
<p>Jenkins Pipeline 提供了一套可扩展的工具，用于将“简单到复杂”的交付流程实现为“持续交付即代码”。Jenkins Pipeline 的定义通常被写入到一个文本文件（称为 <code>Jenkinsfile</code> ）中，该文件可以被放入项目的源代码控制库中。</p>
<h6 id="演示1使用jenkinsfile管理pipeline">演示1：使用Jenkinsfile管理<strong>pipeline</strong><a hidden class="anchor" aria-hidden="true" href="#演示1使用jenkinsfile管理pipeline">#</a></h6>
<ul>
<li>在项目中新建Jenkinsfile文件，拷贝已有script内容</li>
<li>配置pipeline任务，流水线定义为Pipeline Script from SCM</li>
<li>执行push 代码测试</li>
</ul>
<p>Jenkinsfile:</p>
<p><code>jenkins/pipelines/p2.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>   agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   stages {
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            checkout([$class<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;GitSCM&#39;</span>, branches<span style="color:#960050;background-color:#1e0010">:</span> [[name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;*/master&#39;</span>]], doGenerateSubmoduleConfigurations<span style="color:#960050;background-color:#1e0010">:</span> false, extensions<span style="color:#960050;background-color:#1e0010">:</span> [], submoduleCfg<span style="color:#960050;background-color:#1e0010">:</span> [], userRemoteConfigs<span style="color:#960050;background-color:#1e0010">:</span> [[credentialsId<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;gitlab-user&#39;</span>, url<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;http://gitlab.luffy.com/root/myblog.git&#39;</span>]]])
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t myblog:latest&#39;</span>}
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stage(<span style="color:#e6db74">&#39;send-msg&#39;</span>) {
</span></span><span style="display:flex;"><span>         steps {
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">             &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span>我就是我, 是不一样的烟火<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="演示2优化及丰富流水线内容">演示2：优化及丰富流水线内容<a hidden class="anchor" aria-hidden="true" href="#演示2优化及丰富流水线内容">#</a></h6>
<ul>
<li>
<p>优化代码检出阶段</p>
<p>由于目前已经配置了使用git仓库地址，且使用SCM来检测项目，因此代码检出阶段完全没有必要再去指定一次</p>
</li>
<li>
<p>构建镜像的tag使用git的commit id</p>
</li>
<li>
<p>增加post阶段的消息通知，丰富通知内容</p>
</li>
<li>
<p>配置webhook，实现myblog代码推送后，触发Jenkinsfile任务执行</p>
</li>
</ul>
<p><code>jenkins/pipelines/p3.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;printenv&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;check&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            	retry<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#39;docker build . -t myblog:${GIT_COMMIT}&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;msgtype&#34;: &#34;text&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;content&#34;: &#34;😄👍构建成功👍😄\n 关键字：luffy\n 项目名称: ${JOB_BASE_NAME}\n Commit Id: ${GIT_COMMIT}\n 构建地址：${RUN_DISPLAY_URL}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;msgtype&#34;: &#34;text&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;content&#34;: &#34;😖❌构建失败❌😖\n 关键字：luffy\n 项目名称: ${JOB_BASE_NAME}\n Commit Id: ${GIT_COMMIT}\n 构建地址：${RUN_DISPLAY_URL}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="演示3使用k8s部署服务">演示3：使用k8s部署服务<a hidden class="anchor" aria-hidden="true" href="#演示3使用k8s部署服务">#</a></h6>
<ul>
<li>
<p>新建deploy目录，将k8s所需的文件放到deploy目录中</p>
</li>
<li>
<p>将镜像地址改成模板，在pipeline中使用新构建的镜像进行替换</p>
</li>
<li>
<p>执行kubectl apply -f deploy应用更改，需要配置kubectl认证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ scp -r k8s-master<span style="color:#960050;background-color:#1e0010">:</span>/root/.kube /root
</span></span></code></pre></div></li>
</ul>
<p><code>jenkins/pipelines/p4.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>              echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>              sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😄👍</span>构建成功<span style="color:#960050;background-color:#1e0010">👍😄</span>\n 关键字<span style="color:#960050;background-color:#1e0010">：</span>myblog\n 项目名称<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n 构建地址<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=67e81175c6ebacb1307e83f62680f36fbcf4524e8f43971cf2fb2049bc58723d&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😖❌</span>构建失败<span style="color:#960050;background-color:#1e0010">❌😖</span>\n 关键字<span style="color:#960050;background-color:#1e0010">：</span>luffy\n 项目名称<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n 构建地址<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="演示4使用凭据管理敏感信息">演示4：使用凭据管理敏感信息<a hidden class="anchor" aria-hidden="true" href="#演示4使用凭据管理敏感信息">#</a></h6>
<p>上述Jenkinsfile中存在的问题是敏感信息使用明文，暴漏在代码中，如何管理流水线中的敏感信息（包含账号密码），之前我们在对接gitlab的时候，需要账号密码，已经使用过凭据来管理这类敏感信息，同样的，我们可以使用凭据来存储钉钉的token信息，那么，创建好凭据后，如何在Jenkinsfile中获取已有凭据的内容？</p>
<p>Jenkins 的声明式流水线语法有一个 <code>credentials()</code> 辅助方法（在<a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/#../syntax#environment"><code>environment</code></a> 指令中使用），它支持 <a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/##secret-text">secret 文本</a>，<a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/##usernames-and-passwords">带密码的用户名</a>，以及 <a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/##secret-files">secret 文件</a>凭据。</p>
<p>下面的流水线代码片段展示了如何创建一个使用带密码的用户名凭据的环境变量的流水线。</p>
<p>在该示例中，带密码的用户名凭据被分配了环境变量，用来使你的组织或团队以一个公用账户访问 Bitbucket 仓库；这些凭据已在 Jenkins 中配置了凭据 ID <code>jenkins-bitbucket-common-creds</code>。</p>
<p>当在 <a href="https://jenkins.io/zh/doc/book/pipeline/jenkinsfile/#../syntax#environment"><code>environment</code></a> 指令中设置凭据环境变量时：</p>
<pre tabindex="0"><code>environment {
    BITBUCKET_COMMON_CREDS = credentials(&#39;jenkins-bitbucket-common-creds&#39;)
}
</code></pre><p>这实际设置了下面的三个环境变量：</p>
<ul>
<li><code>BITBUCKET_COMMON_CREDS</code> - 包含一个以冒号分隔的用户名和密码，格式为 <code>username:password</code>。</li>
<li><code>BITBUCKET_COMMON_CREDS_USR</code> - 附加的一个仅包含用户名部分的变量。</li>
<li><code>BITBUCKET_COMMON_CREDS_PSW</code> - 附加的一个仅包含密码部分的变量。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 此处定义 agent 的细节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//顶层流水线块中使用的 environment 指令将适用于流水线中的所有步骤。 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        BITBUCKET_COMMON_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;jenkins-bitbucket-common-creds&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example stage 1&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> 			<span style="color:#75715e">//在一个 stage 中定义的 environment 指令只会将给定的环境变量应用于 stage 中的步骤。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                BITBUCKET_COMMON_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;another-credential-id&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example stage 2&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>因此对Jenkinsfile做改造：</p>
<p><code>jenkins/pipelines/p5.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Hello World&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;check&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😄👍</span>构建成功<span style="color:#960050;background-color:#1e0010">👍😄</span>\n 关键字<span style="color:#960050;background-color:#1e0010">：</span>luffy\n 项目名称<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n 构建地址<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{&#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>text<span style="color:#e6db74">&#34;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                &#34;</span>content<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😖❌</span>构建失败<span style="color:#960050;background-color:#1e0010">❌😖</span>\n 关键字<span style="color:#960050;background-color:#1e0010">：</span>luffy\n 项目名称<span style="color:#960050;background-color:#1e0010">:</span> ${JOB_BASE_NAME}\n Commit Id<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_COMMIT}\n 构建地址<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="本章小结-1">本章小结<a hidden class="anchor" aria-hidden="true" href="#本章小结-1">#</a></h6>
<p>上面我们已经通过Jenkinsfile完成了最简单的项目的构建和部署，那么我们来思考目前的方式：</p>
<ol>
<li>目前都是在项目的单一分支下进行操作，企业内一般会使用feature、develop、release、master等多个分支来管理整个代码提交流程，如何根据不同的分支来做构建？</li>
<li>构建视图中如何区分不同的分支?</li>
<li>如何不配置webhook的方式实现构建？</li>
<li>如何根据不同的分支选择发布到不同的环境(开发、测试、生产)？</li>
</ol>
<blockquote>
</blockquote>
<h5 id="多分支流水线">多分支流水线<a hidden class="anchor" aria-hidden="true" href="#多分支流水线">#</a></h5>
<p><a href="https://jenkins.io/zh/doc/tutorials/build-a-multibranch-pipeline-project/">官方示例</a></p>
<p>我们简化一下流程，假如使用develop分支作为开发分支，master分支作为集成测试分支，看一下如何使用多分支流水线来管理。</p>
<h6 id="演示1多分支流水线的使用">演示1：多分支流水线的使用<a hidden class="anchor" aria-hidden="true" href="#演示1多分支流水线的使用">#</a></h6>
<ol>
<li>提交develop分支：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ git checkout -b develop
</span></span><span style="display:flex;"><span>$ git push --set-upstream origin develop
</span></span></code></pre></div><ol start="2">
<li>
<p>禁用pipeline项目</p>
</li>
<li>
<p>Jenkins端创建多分支流水线项目</p>
<ul>
<li>增加git分支源</li>
<li>发现标签</li>
<li>根据名称过滤，develop|master|v.*</li>
<li>高级克隆，设置浅克隆</li>
</ul>
</li>
</ol>
<p>保存后，会自动检索项目中所有存在Jenkinsfile文件的分支和标签，若匹配我们设置的过滤正则表达式，则会添加到多分支的构建视图中。所有添加到视图中的分支和标签，会默认执行一次构建任务。</p>
<h6 id="演示2美化消息通知内容">演示2：美化消息通知内容<a hidden class="anchor" aria-hidden="true" href="#演示2美化消息通知内容">#</a></h6>
<ul>
<li>添加构建阶段记录</li>
<li>使用markdown格式，添加构建分支消息</li>
</ul>
<p><code>jenkins/pipelines/p6.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😄👍</span> 构建成功 <span style="color:#960050;background-color:#1e0010">👍😄</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_BRANCH}   \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😖❌</span> 构建失败 <span style="color:#960050;background-color:#1e0010">❌😖</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_BRANCH}  \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h6 id="演示3通知gitlab构建状态">演示3：通知gitlab构建状态<a hidden class="anchor" aria-hidden="true" href="#演示3通知gitlab构建状态">#</a></h6>
<p>Jenkins端做了构建，可以通过gitlab通过的api将构建状态通知过去，作为开发人员发起Merge Request或者合并Merge Request的依据之一。</p>
<p><em>注意一定要指定gitLabConnection(&lsquo;gitlab&rsquo;)，不然没法认证到Gitlab端</em></p>
<p><code>jenkins/pipelines/p7.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;172.21.51.68&#39;</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options {
</span></span><span style="display:flex;"><span>		buildDiscarder(logRotator(numToKeepStr<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10&#39;</span>))
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds()
</span></span><span style="display:flex;"><span>		timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 20, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>)
</span></span><span style="display:flex;"><span>		gitLabConnection(<span style="color:#e6db74">&#39;gitlab&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                checkout scm
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😄👍</span> 构建成功 <span style="color:#960050;background-color:#1e0010">👍😄</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}   \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😖❌</span> 构建失败 <span style="color:#960050;background-color:#1e0010">❌😖</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}  \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们可以访问gitlab，然后找到commit记录，查看同步状态</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-cicd.jpg" alt=""  />
</p>
<p>提交merge request，也可以查看到相关的任务状态，可以作为项目owner合并代码的依据之一：</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-merge-request.jpg" alt=""  />
</p>
<h6 id="本章小节">本章小节<a hidden class="anchor" aria-hidden="true" href="#本章小节">#</a></h6>
<p>优势:</p>
<ul>
<li>根据分支展示, 视图人性化</li>
<li>自动检测各分支的变更</li>
</ul>
<p>思考：</p>
<ul>
<li>Jenkins的slave端，没有任务的时候处于闲置状态，slave节点多的话造成资源浪费</li>
<li>是否可以利用kubernetes的Pod来启动slave，动态slave pod来执行构建任务</li>
</ul>
<blockquote>
</blockquote>
<h4 id="工具集成与jenkinsfile实践篇">工具集成与Jenkinsfile实践篇<a hidden class="anchor" aria-hidden="true" href="#工具集成与jenkinsfile实践篇">#</a></h4>
<ol>
<li>Jenkins如何对接kubernetes集群</li>
<li>使用kubernetes的Pod-Template来作为动态的agent执行Jenkins任务</li>
<li>如何制作agent容器实现不同类型的业务的集成</li>
<li>集成代码扫描、docker镜像自动构建、k8s服务部署、自动化测试</li>
</ol>
<h5 id="集成kubernetes">集成Kubernetes<a hidden class="anchor" aria-hidden="true" href="#集成kubernetes">#</a></h5>
<h6 id="插件安装及配置">插件安装及配置<a hidden class="anchor" aria-hidden="true" href="#插件安装及配置">#</a></h6>
<p><a href="https://plugins.jenkins.io/kubernetes/">插件官方文档</a></p>
<ol>
<li>
<p>[系统管理] -&gt; [插件管理] -&gt; [搜索kubernetes]-&gt;直接安装</p>
<p>若安装失败，请先更新<a href="https://plugins.jenkins.io/bouncycastle-api"> bouncycastle API Plugin</a>并重新启动Jenkins</p>
</li>
<li>
<p>[系统管理] -&gt; [系统配置] -&gt; [Add a new cloud]</p>
</li>
<li>
<p>配置地址信息</p>
<ul>
<li>Kubernetes 地址: <a href="https://kubernetes.default">https://kubernetes.default</a>（或者https://172.21.51.67:6443）</li>
<li>Kubernetes 命名空间：jenkins</li>
<li>服务证书不用写（我们在安装Jenkins的时候已经指定过serviceAccount），均使用默认</li>
<li>连接测试，成功会提示：Connection test successful</li>
<li>Jenkins地址：http://jenkins:8080</li>
<li>Jenkins 通道 ：jenkins:50000</li>
</ul>
</li>
<li>
<p>配置Pod Template</p>
<ul>
<li>名称：jnlp-slave</li>
<li>命名空间：jenkins</li>
<li>标签列表：jnlp-slave，作为agent的label选择用</li>
<li>连接 Jenkins 的超时时间（秒） ：300，设置连接jenkins超时时间</li>
<li>节点选择器：agent=true</li>
<li>工作空间卷：选择hostpath，设置/opt/jenkins_jobs/,注意需要设置chown -R 1000:1000 /opt/jenkins_jobs/权限，否则Pod没有权限</li>
</ul>
</li>
</ol>
<h6 id="演示动态slave-pod">演示动态slave pod<a hidden class="anchor" aria-hidden="true" href="#演示动态slave-pod">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 为准备运行jnlp-slave-agent的pod的节点打上label</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave1 agent=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### 回放一次多分支流水线develop分支</span>
</span></span><span style="display:flex;"><span>agent { label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>}
</span></span></code></pre></div><p>执行任务，会下载默认的jnlp-slave镜像，地址为jenkins/inbound-agent:4.3-4，我们可以先在k8s-master节点拉取下来该镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker pull jenkins/inbound-agent<span style="color:#960050;background-color:#1e0010">:</span>4.3-4
</span></span></code></pre></div><p>保存jenkinsfile提交后，会出现报错，因为我们的agent已经不再是宿主机，而是Pod中的容器内，报错如下：</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/gitlab-no-docker-err.png" alt=""  />
</p>
<p>因此我们需要将用到的命令行工具集成到Pod的容器内，但是思考如下问题：</p>
<ul>
<li>目前是用的jnlp的容器，是java的环境，我们在此基础上需要集成很多工具，能不能创建一个新的容器，让新容器来做具体的任务，jnlp-slave容器只用来负责连接jenkins-master</li>
<li>针对不同的构建环境（java、python、go、nodejs），可以制作不同的容器，来执行对应的任务</li>
</ul>
<blockquote>
</blockquote>
<h6 id="pod-template中容器镜像的制作">Pod-Template中容器镜像的制作<a hidden class="anchor" aria-hidden="true" href="#pod-template中容器镜像的制作">#</a></h6>
<p>为解决上述问题，我们制作一个tools镜像，集成常用的工具，来完成常见的构建任务，需要注意的几点：</p>
<ul>
<li>使用alpine基础镜像，自身体积比较小</li>
<li>替换国内安装源</li>
<li>为了使用docker，安装了docker</li>
<li>为了克隆代码，安装git</li>
<li>为了后续做python的测试等任务，安装python环境</li>
<li>为了在容器中调用kubectl的命令，拷贝了kubectl的二进制文件</li>
<li>为了认证kubectl，需要在容器内部生成.kube目录及config文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ mkdir tools;
</span></span><span style="display:flex;"><span>$ cd tools;
</span></span><span style="display:flex;"><span>$ cp `which kubectl` .
</span></span><span style="display:flex;"><span>$ cp ~/.kube/config .
</span></span></code></pre></div><p><em>Dockerfile</em></p>
<p><code>jenkins/custom-images/tools/Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> maintainer<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> root</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add  --no-cache openrc docker git curl tar gcc g++ make <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    libstdc++ harfbuzz nss freetype ttf-freefont <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir -p /root/.kube <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    usermod -a -G docker root<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> config /root/.kube/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf /var/cache/apk/* <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#-----------------安装 kubectl--------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> kubectl /usr/local/bin/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /usr/local/bin/kubectl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>执行镜像构建并推送到仓库中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1
</span></span></code></pre></div><p>我们可以直接使用该镜像做测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 启动临时镜像做测试</span>
</span></span><span style="display:flex;"><span>$ docker run --rm -ti 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1 bash
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / git clone http://xxxxxx.git</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / kubectl get no</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/ docker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 重新挂载docker的sock文件</span>
</span></span><span style="display:flex;"><span>docker run -v /var/run/docker.sock<span style="color:#960050;background-color:#1e0010">:</span>/var/run/docker.sock --rm -ti 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v1 bash
</span></span></code></pre></div><h6 id="实践通过jenkinsfile实现demo项目自动发布到kubenetes环境">实践通过Jenkinsfile实现demo项目自动发布到kubenetes环境<a hidden class="anchor" aria-hidden="true" href="#实践通过jenkinsfile实现demo项目自动发布到kubenetes环境">#</a></h6>
<p>更新Jenkins中的PodTemplate，添加tools镜像，注意同时要先添加名为jnlp的container，因为我们是使用自定义的PodTemplate覆盖掉默认的模板：</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/pod-template-jnlp.jpg" alt=""  />
</p>
<p>在卷栏目，添加卷，Host Path Volume，不然在容器中使用docker会提示docker服务未启动</p>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/jenkins-docker-sock.png" alt=""  />
</p>
<p>tools容器做好后，我们需要对Jenkinsfile做如下调整：</p>
<p><code>jenkins/pipelines/p8.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options {
</span></span><span style="display:flex;"><span>		buildDiscarder(logRotator(numToKeepStr<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10&#39;</span>))
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds()
</span></span><span style="display:flex;"><span>		timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 20, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>)
</span></span><span style="display:flex;"><span>		gitLabConnection(<span style="color:#e6db74">&#39;gitlab&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;printenv&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                    timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😄👍</span> 构建成功 <span style="color:#960050;background-color:#1e0010">👍😄</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}   \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😖❌</span> 构建失败 <span style="color:#960050;background-color:#1e0010">❌😖</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}  \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
</blockquote>
<h5 id="集成sonarqube实现代码扫描">集成sonarQube实现代码扫描<a hidden class="anchor" aria-hidden="true" href="#集成sonarqube实现代码扫描">#</a></h5>
<p>Sonar可以从以下七个维度检测代码质量，而作为开发人员至少需要处理前5种代码质量问题。</p>
<ol>
<li>不遵循代码标准
sonar可以通过PMD,CheckStyle,Findbugs等等代码规则检测工具规范代码编写。</li>
<li>潜在的缺陷
sonar可以通过PMD,CheckStyle,Findbugs等等代码规则检测工具检 测出潜在的缺陷。</li>
<li>糟糕的复杂度分布
文件、类、方法等，如果复杂度过高将难以改变，这会使得开发人员 难以理解它们, 且如果没有自动化的单元测试，对于程序中的任何组件的改变都将可能导致需要全面的回归测试。</li>
<li>重复
显然程序中包含大量复制粘贴的代码是质量低下的，sonar可以展示 源码中重复严重的地方。</li>
<li>注释不足或者过多
没有注释将使代码可读性变差，特别是当不可避免地出现人员变动 时，程序的可读性将大幅下降 而过多的注释又会使得开发人员将精力过多地花费在阅读注释上，亦违背初衷。</li>
<li>缺乏单元测试
sonar可以很方便地统计并展示单元测试覆盖率。</li>
<li>糟糕的设计
通过sonar可以找出循环，展示包与包、类与类之间的相互依赖关系，可以检测自定义的架构规则 通过sonar可以管理第三方的jar包，可以利用LCOM4检测单个任务规则的应用情况， 检测耦合。</li>
</ol>
<h6 id="sonarqube架构简介">sonarqube架构简介<a hidden class="anchor" aria-hidden="true" href="#sonarqube架构简介">#</a></h6>
<p><img loading="lazy" src="/images/%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8eKubernetes%e7%9a%84Devops%e5%b9%b3%e5%8f%b0/sonarqube.webp" alt=""  />
</p>
<ol>
<li>CS架构
<ul>
<li>sonarqube scanner</li>
<li>sonarqube server</li>
</ul>
</li>
<li>SonarQube Scanner 扫描仪在本地执行代码扫描任务</li>
<li>执行完后，将分析报告被发送到SonarQube服务器进行处理</li>
<li>SonarQube服务器处理和存储分析报告导致SonarQube数据库，并显示结果在UI中</li>
</ol>
<h6 id="sonarqube-on-kubernetes环境搭建">sonarqube on kubernetes环境搭建<a hidden class="anchor" aria-hidden="true" href="#sonarqube-on-kubernetes环境搭建">#</a></h6>
<ol>
<li>资源文件准备</li>
</ol>
<p><code>sonar/sonar.yaml</code></p>
<ul>
<li>和gitlab共享postgres数据库</li>
<li>使用ingress地址 <code>sonar.luffy.com</code> 进行访问</li>
<li>使用initContainers进行系统参数调整</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">sonar</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/sbin/sysctl</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">w</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">vm.max_map_count=262144</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">alpine:3.6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">elasticsearch-logging-init</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>: {}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/sonarqube:7.9-community</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SONARQUBE_JDBC_USERNAME</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gitlab-secret</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">postgres.user.root</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SONARQUBE_JDBC_PASSWORD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gitlab-secret</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">postgres.pwd.root</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SONARQUBE_JDBC_URL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;jdbc:postgresql://postgres:5432/sonar&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/sessions/new</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/sessions/new</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">2000m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">4096Mi</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">300m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">512Mi</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">jenkins</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">sonar.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">sonarqube</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><ol start="2">
<li>
<p>sonarqube服务端安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 创建sonar数据库</span>
</span></span><span style="display:flex;"><span>$ kubectl -n jenkins exec -ti postgres-5859dc6f58-mgqz9 bash
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/ psql </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create database sonar;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 创建sonarqube服务器</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> sonar.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 配置本地hosts解析</span>
</span></span><span style="display:flex;"><span>172.21.51.67 sonar.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 访问sonarqube，初始用户名密码为 admin/admin</span>
</span></span><span style="display:flex;"><span>$ curl http<span style="color:#960050;background-color:#1e0010">:</span>//sonar.luffy.com
</span></span></code></pre></div></li>
<li>
<p>sonar-scanner的安装</p>
<p>下载地址： <a href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zip">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zip</a>。该地址比较慢，可以在网盘下载（https://pan.baidu.com/s/1SiEhWyHikTiKl5lEMX1tJg 提取码: tqb9）。</p>
</li>
<li>
<p>演示sonar代码扫描功能</p>
<ul>
<li>
<p>在项目根目录中准备配置文件 <strong>sonar-project.properties</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>sonar.projectKey=myblog
</span></span><span style="display:flex;"><span>sonar.projectName=myblog
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if you want disabled the DTD verification for a proxy problem for example, true by default</span>
</span></span><span style="display:flex;"><span>sonar.coverage.dtdVerification=false
</span></span><span style="display:flex;"><span><span style="color:#75715e"># JUnit like test report, default value is test.xml</span>
</span></span><span style="display:flex;"><span>sonar.sources=blog,myblog
</span></span></code></pre></div></li>
<li>
<p>配置sonarqube服务器地址</p>
<p>由于sonar-scanner需要将扫描结果上报给sonarqube服务器做质量分析，因此我们需要在sonar-scanner中配置sonarqube的服务器地址：</p>
<p>在集群宿主机中测试，先配置一下hosts文件，然后配置sonar的地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat /etc/hosts
</span></span><span style="display:flex;"><span>172.21.51.67  sonar.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat sonar-scanner/conf/sonar-scanner.properties
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default SonarQube server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sonar.host.url=http://localhost:9000</span>
</span></span><span style="display:flex;"><span>sonar.host.url=http<span style="color:#960050;background-color:#1e0010">:</span>//sonar.luffy.com
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default source code encoding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sonar.sourceEncoding=UTF-8</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
<pre tabindex="0"><code> 
- 为了使所有的pod都可以通过`sonar.luffy.com`访问，可以配置coredns的静态解析
 
   ```powershell
           hosts {
               172.21.51.67 jenkins.luffy.com gitlab.luffy.com sonar.luffy.com
               fallthrough
        }
</code></pre><ul>
<li>
<p>执行扫描</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 在项目的根目录下执行</span>
</span></span><span style="display:flex;"><span>$ /opt/sonar-scanner-4.0.0.1744-linux/bin/sonar-scanner  -X 
</span></span></code></pre></div></li>
<li>
<p>sonarqube界面查看结果</p>
<p>登录sonarqube界面查看结果，Quality Gates说明</p>
</li>
</ul>
<h6 id="插件安装及配置-1">插件安装及配置<a hidden class="anchor" aria-hidden="true" href="#插件安装及配置-1">#</a></h6>
<ol>
<li>
<p>集成到tools容器中</p>
<p>由于我们的代码拉取、构建任务均是在tools容器中进行，因此我们需要把scanner集成到我们的tools容器中，又因为scanner是一个cli客户端，因此我们直接把包解压好，拷贝到tools容器内部，配置一下PATH路径即可，注意两点：</p>
<ul>
<li>
<p>直接在在tools镜像中配置<code>http://sonar.luffy.com</code></p>
</li>
<li>
<p>由于tools已经集成了java环境，因此可以直接剔除scanner自带的jre</p>
<ul>
<li>
<p>删掉sonar-scanner/jre目录</p>
</li>
<li>
<p>修改sonar-scanner/bin/sonar-scanner</p>
<p><code>use_embedded_jre=false</code></p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cd tools
</span></span><span style="display:flex;"><span>$ cp -r /opt/sonar-scanner-4.0.0.1744-linux/ sonar-scanner
</span></span><span style="display:flex;"><span><span style="color:#75715e">## sonar配置，由于我们是在Pod中使用，也可以直接配置：sonar.host.url=http://sonarqube:9000</span>
</span></span><span style="display:flex;"><span>$ cat sonar-scanner/conf/sonar-scanner.properties
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default SonarQube server</span>
</span></span><span style="display:flex;"><span>sonar.host.url=http<span style="color:#960050;background-color:#1e0010">:</span>//sonar.luffy.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----- Default source code encoding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sonar.sourceEncoding=UTF-8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rm -rf sonar-scanner/jre
</span></span><span style="display:flex;"><span>$ vi sonar-scanner/bin/sonar-scanner
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>use_embedded_jre=false
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><em>Dockerfile</em></p>
<p><code>jenkins/custom-images/tools/Dockerfile2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> maintainer<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> root</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/apk/repositories <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apk add  --no-cache openrc docker git curl tar gcc g++ make <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    libstdc++ harfbuzz nss freetype ttf-freefont <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir -p /root/.kube <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    usermod -a -G docker root<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> config /root/.kube/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf /var/cache/apk/*<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#-----------------安装 kubectl--------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> kubectl /usr/local/bin/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /usr/local/bin/kubectl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#---------------安装 sonar-scanner-----------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> sonar-scanner /usr/lib/sonar-scanner<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/sonar-scanner<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> SONAR_RUNNER_HOME<span style="color:#f92672">=</span>/usr/lib/sonar-scanner<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div></li>
</ol>
<p>重新构建镜像，并推送到仓库：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>   $ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v2
</span></span><span style="display:flex;"><span>   $ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v2
</span></span><span style="display:flex;"><span>   
</span></span></code></pre></div><ol start="2">
<li>
<p>修改Jenkins PodTemplate</p>
<p>为了在新的构建任务中可以拉取v2版本的tools镜像，需要更新PodTemplate</p>
</li>
<li>
<p>安装并配置sonar插件</p>
<p>由于sonarqube的扫描的结果需要进行Quality Gates的检测，那么我们在容器中执行完代码扫描任务后，如何知道本次扫描是否通过了Quality Gates，那么就需要借助于sonarqube实现的jenkins的插件。</p>
<ul>
<li>
<p>安装插件</p>
<p>插件中心搜索sonarqube，直接安装</p>
</li>
<li>
<p>配置插件</p>
<p>系统管理-&gt;系统配置-&gt; <strong>SonarQube servers</strong> -&gt;Add SonarQube</p>
<ul>
<li>
<p>Name：sonarqube</p>
</li>
<li>
<p>Server URL：http://sonar.luffy.com</p>
</li>
<li>
<p>Server authentication token</p>
<p>① 登录sonarqube -&gt; My Account -&gt; Security -&gt; Generate Token</p>
<p>② 登录Jenkins，添加全局凭据，类型为Secret text</p>
</li>
</ul>
</li>
<li>
<p>如何在jenkinsfile中使用</p>
<p>我们在 <a href="https://jenkins.io/doc/pipeline/steps/sonar/">https://jenkins.io/doc/pipeline/steps/sonar/</a> 官方介绍中可以看到：</p>
</li>
</ul>
</li>
</ol>
<h6 id="jenkinsfile集成sonarqube演示">Jenkinsfile集成sonarqube演示<a hidden class="anchor" aria-hidden="true" href="#jenkinsfile集成sonarqube演示">#</a></h6>
<p><code>jenkins/pipelines/p9.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		buildDiscarder<span style="color:#f92672">(</span>logRotator<span style="color:#f92672">(</span>numToKeepStr: <span style="color:#e6db74">&#39;10&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">20</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TAB_STR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;git-log&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">GIT_LOG</span> <span style="color:#f92672">=</span> readFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;gitlog.file&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>        
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;√...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            withSonarQubeEnv<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                sh <span style="color:#e6db74">&#39;sonar-scanner -X&#39;</span>
</span></span><span style="display:flex;"><span>                                sleep <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                timeout<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">def</span> qg <span style="color:#f92672">=</span> waitForQualityGate<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sonarqube&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>qg<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;OK&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                        error <span style="color:#e6db74">&#34;未通过Sonarqube的代码质量阈检查，请及时修改！failure: ${qg.status}&#34;</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    retry<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">+=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;√...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;push-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    retry<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">+=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;√...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                    timeout<span style="color:#f92672">(</span>time: <span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus<span style="color:#f92672">(</span>name: env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span><span style="color:#f92672">,</span> state: <span style="color:#e6db74">&#39;success&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">BUILD_TASKS</span> <span style="color:#f92672">+=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">STAGE_NAME</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;√...&#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">TAB_STR</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;markdown&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;title&#34;:&#34;myblog&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: &#34;😄👍 构建成功 👍😄  \n**项目名称**：luffy  \n**Git log**: ${GIT_LOG}   \n**构建分支**: ${BRANCH_NAME}   \n**构建地址**：${RUN_DISPLAY_URL}  \n**构建任务**：${BUILD_TASKS}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;msgtype&#34;: &#34;markdown&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;markdown&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;title&#34;:&#34;myblog&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;text&#34;: &#34;😖❌ 构建失败 ❌😖  \n**项目名称**：luffy  \n**Git log**: ${GIT_LOG}   \n**构建分支**: ${BRANCH_NAME}  \n**构建地址**：${RUN_DISPLAY_URL}  \n**构建任务**：${BUILD_TASKS}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
</blockquote>
<h5 id="集成robotframework实现验收测试">集成RobotFramework实现验收测试<a hidden class="anchor" aria-hidden="true" href="#集成robotframework实现验收测试">#</a></h5>
<p>一个基于Python语言，用于验收测试和验收测试驱动开发（ATDD）的通用测试自动化框架，提供了一套特定的语法，并且有非常丰富的测试库 。</p>
<h6 id="robot用例简介">robot用例简介<a hidden class="anchor" aria-hidden="true" href="#robot用例简介">#</a></h6>
<p><code>robot/robot.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*** Settings ***
</span></span><span style="display:flex;"><span>Library           RequestsLibrary
</span></span><span style="display:flex;"><span>Library           SeleniumLibrary
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*** Variables ***
</span></span><span style="display:flex;"><span>${demo_url}       http<span style="color:#960050;background-color:#1e0010">:</span>//myblog.luffy/admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*** Test Cases ***
</span></span><span style="display:flex;"><span>api
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[Tags]</span>  critical
</span></span><span style="display:flex;"><span>    Create Session    api    ${demo_url}
</span></span><span style="display:flex;"><span>    ${alarm_system_info}    RequestsLibrary.Get Request    api    /
</span></span><span style="display:flex;"><span>    log    ${alarm_system_info.status_code}
</span></span><span style="display:flex;"><span>    log    ${alarm_system_info.content}
</span></span><span style="display:flex;"><span>    should be true    ${alarm_system_info.status_code} == 200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ui
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">[Tags]</span>  critical
</span></span><span style="display:flex;"><span>    ${chrome_options} =     Evaluate    sys.modules[<span style="color:#e6db74">&#39;selenium.webdriver&#39;</span>].ChromeOptions()    sys, selenium.webdriver
</span></span><span style="display:flex;"><span>    Call Method    ${chrome_options}   add_argument    headless
</span></span><span style="display:flex;"><span>    Call Method    ${chrome_options}   add_argument    no-sandbox
</span></span><span style="display:flex;"><span>    ${options}=     Call Method     ${chrome_options}    to_capabilities
</span></span><span style="display:flex;"><span>    Open Browser    ${demo_url}/    browser=chrome       desired_capabilities=${options}
</span></span><span style="display:flex;"><span>    sleep    2s
</span></span><span style="display:flex;"><span>    Capture Page Screenshot
</span></span><span style="display:flex;"><span>    Page Should Contain    Django
</span></span><span style="display:flex;"><span>    close browser
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 使用tools镜像启动容器，来验证手动使用robotframework来做验收测试</span>
</span></span><span style="display:flex;"><span>$ docker run --rm -ti 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v2 bash
</span></span><span style="display:flex;"><span>bash-5.0<span style="color:#75715e"># apk add chromium chromium-chromedriver</span>
</span></span><span style="display:flex;"><span>$ cat requirements.txt
</span></span><span style="display:flex;"><span>robotframework
</span></span><span style="display:flex;"><span>robotframework-seleniumlibrary
</span></span><span style="display:flex;"><span>robotframework-databaselibrary
</span></span><span style="display:flex;"><span>robotframework-requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pip安装必要的软件包</span>
</span></span><span style="display:flex;"><span>$ pip install -i http<span style="color:#960050;background-color:#1e0010">:</span>//mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#使用robot命令做测试</span>
</span></span><span style="display:flex;"><span>$ robot -d artifacts/ robot.txt
</span></span></code></pre></div><h6 id="与tools工具镜像集成">与tools工具镜像集成<a hidden class="anchor" aria-hidden="true" href="#与tools工具镜像集成">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>FROM alpine
</span></span><span style="display:flex;"><span>LABEL maintainer=<span style="color:#e6db74">&#34;inspur_lyx@hotmail.com&#34;</span>
</span></span><span style="display:flex;"><span>USER root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN sed -i <span style="color:#e6db74">&#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/apk/repositories &amp;&amp; \
</span></span><span style="display:flex;"><span>    apk update &amp;&amp; \
</span></span><span style="display:flex;"><span>    apk add  --no-cache openrc docker git curl tar gcc g++ make \
</span></span><span style="display:flex;"><span>    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \
</span></span><span style="display:flex;"><span>    libstdc++ harfbuzz nss freetype ttf-freefont chromium chromium-chromedriver &amp;&amp; \
</span></span><span style="display:flex;"><span>    mkdir -p /root/.kube &amp;&amp; \
</span></span><span style="display:flex;"><span>    usermod -a -G docker root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY config /root/.kube/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY requirements.txt /
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN pip install -i http<span style="color:#960050;background-color:#1e0010">:</span>//mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN rm -rf /var/cache/apk/* &amp;&amp; \
</span></span><span style="display:flex;"><span>    rm -rf ~/.cache/pip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#-----------------安装 kubectl--------------------#</span>
</span></span><span style="display:flex;"><span>COPY kubectl /usr/local/bin/
</span></span><span style="display:flex;"><span>RUN chmod +x /usr/local/bin/kubectl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#---------------安装 sonar-scanner-----------------#</span>
</span></span><span style="display:flex;"><span>COPY sonar-scanner /usr/lib/sonar-scanner
</span></span><span style="display:flex;"><span>RUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner &amp;&amp; chmod +x /usr/local/bin/sonar-scanner
</span></span><span style="display:flex;"><span>ENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------------------------------------------------#</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/devops/tools<span style="color:#960050;background-color:#1e0010">:</span>v3
</span></span></code></pre></div><p>更新Jenkins中kubernetes中的containers template</p>
<h6 id="插件安装及配置-2">插件安装及配置<a hidden class="anchor" aria-hidden="true" href="#插件安装及配置-2">#</a></h6>
<p>为什么要安装robot插件？</p>
<ol>
<li>
<p>安装robotFramework</p>
<ul>
<li>插件中心搜索robotframework，直接安装</li>
<li>tools集成robot命令（之前已经安装）</li>
</ul>
</li>
<li>
<p>与jenkinsfile的集成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>    container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#39;robot -i critical  -d artifacts/ robot.txt || echo ok&#39;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>        step<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>            $class <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;RobotPublisher&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            outputPath: <span style="color:#e6db74">&#39;artifacts/&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            outputFileName <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;output.xml&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            disableArchiveOutput <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            passThreshold <span style="color:#f92672">:</span> <span style="color:#ae81ff">80</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            unstableThreshold: <span style="color:#ae81ff">20.0</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            onlyCritical <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            otherFiles <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>        archiveArtifacts artifacts: <span style="color:#e6db74">&#39;artifacts/*&#39;</span><span style="color:#f92672">,</span> fingerprint: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h6 id="实践通过jenkinsfile实现demo项目的验收测试">实践通过Jenkinsfile实现demo项目的验收测试<a hidden class="anchor" aria-hidden="true" href="#实践通过jenkinsfile实现demo项目的验收测试">#</a></h6>
<p>python-demo项目添加robot.txt文件：</p>
<p><code>jenkins/pipelines/p10.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pipeline {
</span></span><span style="display:flex;"><span>    agent { label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    options {
</span></span><span style="display:flex;"><span>		buildDiscarder(logRotator(numToKeepStr<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10&#39;</span>))
</span></span><span style="display:flex;"><span>		disableConcurrentBuilds()
</span></span><span style="display:flex;"><span>		timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 20, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>)
</span></span><span style="display:flex;"><span>		gitLabConnection(<span style="color:#e6db74">&#39;gitlab&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment {
</span></span><span style="display:flex;"><span>        IMAGE_REPO = <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS = credentials(<span style="color:#e6db74">&#39;dingTalk&#39;</span>)
</span></span><span style="display:flex;"><span>        TAB_STR = <span style="color:#e6db74">&#34;\n                    \n&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages {
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;git-log&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;git log --oneline -n 1 &gt; gitlog.file&#34;</span>
</span></span><span style="display:flex;"><span>                    env.GIT_LOG = readFile(<span style="color:#e6db74">&#34;gitlog.file&#34;</span>).trim()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;printenv&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }        
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;checkout&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS = env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;CI&#39;</span>){
</span></span><span style="display:flex;"><span>            failFast true
</span></span><span style="display:flex;"><span>            parallel {
</span></span><span style="display:flex;"><span>                stage(<span style="color:#e6db74">&#39;Unit Test&#39;</span>) {
</span></span><span style="display:flex;"><span>                    steps {
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                stage(<span style="color:#e6db74">&#39;Code Scan&#39;</span>) {
</span></span><span style="display:flex;"><span>                    steps {
</span></span><span style="display:flex;"><span>                        container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                            withSonarQubeEnv(<span style="color:#e6db74">&#39;sonarqube&#39;</span>) {
</span></span><span style="display:flex;"><span>                                sh <span style="color:#e6db74">&#39;sonar-scanner -X&#39;</span>
</span></span><span style="display:flex;"><span>                                sleep 3
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            script {
</span></span><span style="display:flex;"><span>                                timeout(1) {
</span></span><span style="display:flex;"><span>                                    def qg = waitForQualityGate(<span style="color:#e6db74">&#39;sonarqube&#39;</span>)
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">if</span> (qg.status != <span style="color:#e6db74">&#39;OK&#39;</span>) {
</span></span><span style="display:flex;"><span>                                        error <span style="color:#e6db74">&#34;未通过Sonarqube的代码质量阈检查，请及时修改！failure: ${qg.status}&#34;</span>
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;build-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;push-image&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    retry(2) { sh <span style="color:#e6db74">&#39;docker push ${IMAGE_REPO}:${GIT_COMMIT}&#39;</span>}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;deploy&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;sed -i &#39;s#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g&#39; deploy/*&#34;</span>
</span></span><span style="display:flex;"><span>                    timeout(time<span style="color:#960050;background-color:#1e0010">:</span> 1, unit<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MINUTES&#39;</span>) {
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;kubectl apply -f deploy/;sleep 20;&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                updateGitlabCommitStatus(name<span style="color:#960050;background-color:#1e0010">:</span> env.STAGE_NAME, state<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>                script{
</span></span><span style="display:flex;"><span>                    env.BUILD_TASKS += env.STAGE_NAME + <span style="color:#e6db74">&#34;√...&#34;</span> + env.TAB_STR
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        stage(<span style="color:#e6db74">&#39;Accept Test&#39;</span>) {
</span></span><span style="display:flex;"><span>            steps {
</span></span><span style="display:flex;"><span>                    container(<span style="color:#e6db74">&#39;tools&#39;</span>) {
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;robot -i critical  -d artifacts/ robot.txt|| echo ok&#39;</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>                        step([
</span></span><span style="display:flex;"><span>                            $class <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;RobotPublisher&#39;</span>,
</span></span><span style="display:flex;"><span>                            outputPath<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;artifacts/&#39;</span>,
</span></span><span style="display:flex;"><span>                            outputFileName <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;output.xml&#34;</span>,
</span></span><span style="display:flex;"><span>                            disableArchiveOutput <span style="color:#960050;background-color:#1e0010">:</span> false,
</span></span><span style="display:flex;"><span>                            passThreshold <span style="color:#960050;background-color:#1e0010">:</span> 80,
</span></span><span style="display:flex;"><span>                            unstableThreshold<span style="color:#960050;background-color:#1e0010">:</span> 20.0,
</span></span><span style="display:flex;"><span>                            onlyCritical <span style="color:#960050;background-color:#1e0010">:</span> true,
</span></span><span style="display:flex;"><span>                            otherFiles <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;*.png&#34;</span>
</span></span><span style="display:flex;"><span>                        ])
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;R ${currentBuild.result}&#34;</span>
</span></span><span style="display:flex;"><span>                        archiveArtifacts artifacts<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;artifacts/*&#39;</span>, fingerprint<span style="color:#960050;background-color:#1e0010">:</span> true
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    post {
</span></span><span style="display:flex;"><span>        success { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Congratulations!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😄👍</span> 构建成功 <span style="color:#960050;background-color:#1e0010">👍😄</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}   \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        failure {
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;Oh no!&#39;</span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                curl &#39;https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -H &#39;Content-Type: application/json&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    -d &#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>msgtype<span style="color:#e6db74">&#34;: &#34;</span>markdown<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span>markdown<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>title<span style="color:#e6db74">&#34;:&#34;</span>myblog<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;</span>text<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">😖❌</span> 构建失败 <span style="color:#960050;background-color:#1e0010">❌😖</span>  \n**项目名称**<span style="color:#960050;background-color:#1e0010">：</span>luffy  \n**Git log**<span style="color:#960050;background-color:#1e0010">:</span> ${GIT_LOG}   \n**构建分支**<span style="color:#960050;background-color:#1e0010">:</span> ${BRANCH_NAME}  \n**构建地址**<span style="color:#960050;background-color:#1e0010">：</span>${RUN_DISPLAY_URL}  \n**构建任务**<span style="color:#960050;background-color:#1e0010">：</span>${BUILD_TASKS}<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    }&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        always { 
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#39;I will always say Hello again!&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在Jenkins中查看robot的构建结果。</p>
<blockquote>
</blockquote>
<h4 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h4>
<p>思路：</p>
<ol>
<li>讲解最基础的Jenkins的使用</li>
<li>Pipeline流水线的使用</li>
<li>Jenkinsfile的使用</li>
<li>多分支流水线的使用</li>
<li>与Kubernetes集成，动态jnlp slave pod的使用</li>
<li>与sonarqube集成，实现代码扫描</li>
<li>与Robotframework集成，实现验收测试</li>
</ol>
<p>问题：</p>
<ol>
<li>Jenkinsfile过于冗长</li>
<li>多个项目配置Jenkinsfile，存在很多重复内容</li>
<li>没有实现根据不同分支来部署到不同的环境</li>
<li>Java项目的构建</li>
<li>k8s部署后，采用等待的方式执行后续步骤，不合理</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/">
    <span class="title">« 上一页</span>
    <br>
    <span>基于sharedLibrary进行CICD流程的优化</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/linux-iowait%E9%AB%98%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%8F%8A%E5%A4%84%E7%90%86/">
    <span class="title">下一页 »</span>
    <br>
    <span>Linux iowait高问题排查及处理</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
