<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kubernetes1.16安装[kubadm方式] | ylw&#39;s blog</title>
<meta name="keywords" content="k8s" />
<meta name="description" content="集群信息 1. 节点规划 部署k8s集群的节点按照用途可以划分为如下2类角色：
 master：集群的master节点，集群的初始化节点，基础配置不低于2C4G slave：集群的slave节点，可以多台，基础配置不低于2C4G  本例为了演示slave节点的添加，会部署一台master&#43;2台slave，节点规划如下：
   主机名 节点ip 角色 部署组件     k8s-master 192.168.136.128 master etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, flannel   k8s-slave1 192.168.136.131 slave kubectl, kubelet, kube-proxy, flannel   k8s-slave2 192.168.136.132 slave kubectl, kubelet, kube-proxy, flannel    2. 组件版本    组件 版本 说明     CentOS 7.6.1810    Kernel Linux 3.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/kubernetes1.16%E5%AE%89%E8%A3%85kubadm%E6%96%B9%E5%BC%8F/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="Kubernetes1.16安装[kubadm方式]" />
<meta property="og:description" content="集群信息 1. 节点规划 部署k8s集群的节点按照用途可以划分为如下2类角色：
 master：集群的master节点，集群的初始化节点，基础配置不低于2C4G slave：集群的slave节点，可以多台，基础配置不低于2C4G  本例为了演示slave节点的添加，会部署一台master&#43;2台slave，节点规划如下：
   主机名 节点ip 角色 部署组件     k8s-master 192.168.136.128 master etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, flannel   k8s-slave1 192.168.136.131 slave kubectl, kubelet, kube-proxy, flannel   k8s-slave2 192.168.136.132 slave kubectl, kubelet, kube-proxy, flannel    2. 组件版本    组件 版本 说明     CentOS 7.6.1810    Kernel Linux 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/kubernetes1.16%E5%AE%89%E8%A3%85kubadm%E6%96%B9%E5%BC%8F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-15T14:58:45&#43;00:00" />
<meta property="article:modified_time" content="2021-12-15T14:58:45&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes1.16安装[kubadm方式]"/>
<meta name="twitter:description" content="集群信息 1. 节点规划 部署k8s集群的节点按照用途可以划分为如下2类角色：
 master：集群的master节点，集群的初始化节点，基础配置不低于2C4G slave：集群的slave节点，可以多台，基础配置不低于2C4G  本例为了演示slave节点的添加，会部署一台master&#43;2台slave，节点规划如下：
   主机名 节点ip 角色 部署组件     k8s-master 192.168.136.128 master etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, flannel   k8s-slave1 192.168.136.131 slave kubectl, kubelet, kube-proxy, flannel   k8s-slave2 192.168.136.132 slave kubectl, kubelet, kube-proxy, flannel    2. 组件版本    组件 版本 说明     CentOS 7.6.1810    Kernel Linux 3."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Kubernetes1.16安装[kubadm方式]",
      "item": "https://iblog.zone/archives/kubernetes1.16%E5%AE%89%E8%A3%85kubadm%E6%96%B9%E5%BC%8F/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes1.16安装[kubadm方式]",
  "name": "Kubernetes1.16安装[kubadm方式]",
  "description": "集群信息 1. 节点规划 部署k8s集群的节点按照用途可以划分为如下2类角色：\n master：集群的master节点，集群的初始化节点，基础配置不低于2C4G slave：集群的slave节点，可以多台，基础配置不低于2C4G  本例为了演示slave节点的添加，会部署一台master+2台slave，节点规划如下：\n   主机名 节点ip 角色 部署组件     k8s-master 192.168.136.128 master etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, flannel   k8s-slave1 192.168.136.131 slave kubectl, kubelet, kube-proxy, flannel   k8s-slave2 192.168.136.132 slave kubectl, kubelet, kube-proxy, flannel    2. 组件版本    组件 版本 说明     CentOS 7.6.1810    Kernel Linux 3.",
  "keywords": [
    "k8s"
  ],
  "articleBody": "集群信息 1. 节点规划 部署k8s集群的节点按照用途可以划分为如下2类角色：\n master：集群的master节点，集群的初始化节点，基础配置不低于2C4G slave：集群的slave节点，可以多台，基础配置不低于2C4G  本例为了演示slave节点的添加，会部署一台master+2台slave，节点规划如下：\n   主机名 节点ip 角色 部署组件     k8s-master 192.168.136.128 master etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, flannel   k8s-slave1 192.168.136.131 slave kubectl, kubelet, kube-proxy, flannel   k8s-slave2 192.168.136.132 slave kubectl, kubelet, kube-proxy, flannel    2. 组件版本    组件 版本 说明     CentOS 7.6.1810    Kernel Linux 3.10.0-1062.9.1.el7.x86_64    etcd 3.3.15 使用容器方式部署，默认数据挂载到本地路径   coredns 1.6.2    kubeadm v1.16.2    kubectl v1.16.2    kubelet v1.16.2    kube-proxy v1.16.2    flannel v0.11.0     安装前准备工作 1. 设置hosts解析 操作节点：所有节点（k8s-master，k8s-slave）均需执行\n 修改hostname hostname必须只能包含小写字母、数字、\",\"、\"-\"，且开头结尾必须是小写字母或数字  # 在master节点 $ hostnamectl set-hostname k8s-master #设置master节点的hostname  # 在slave-1节点 $ hostnamectl set-hostname k8s-slave1 #设置slave1节点的hostname  # 在slave-2节点 $ hostnamectl set-hostname k8s-slave2 #设置slave2节点的hostname  添加hosts解析  $ cat /etc/hosts192.168.136.128 k8s-master 192.168.136.131 k8s-slave1 192.168.136.132 k8s-slave2 EOF 2. 调整系统配置 操作节点： 所有的master和slave节点（k8s-master,k8s-slave）需要执行\n 本章下述操作均以k8s-master为例，其他节点均是相同的操作（ip和hostname的值换成对应机器的真实值）\n  设置安全组开放端口  如果节点间无安全组限制（内网机器间可以任意访问），可以忽略，否则，至少保证如下端口可通： k8s-master节点：TCP：6443，2379，2380，60080，60081UDP协议端口全部打开 k8s-slave节点：UDP协议端口全部打开\n 设置iptables  iptables -P FORWARD ACCEPT  关闭swap  swapoff -a # 防止开机自动挂载 swap 分区 sed -i '/ swap / s/^\\(.*\\)$/#\\1/g' /etc/fstab  关闭selinux和防火墙  sed -ri 's#(SELINUX=).*#\\1disabled#' /etc/selinux/config setenforce 0 systemctl disable firewalld \u0026\u0026 systemctl stop firewalld  修改内核参数  cat /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward=1 vm.max_map_count=262144 EOF modprobe br_netfilter sysctl -p /etc/sysctl.d/k8s.conf  设置yum源  $ curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo $ curl -o /etc/yum.repos.d/docker-ce.repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo $ cat /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF $ yum clean all \u0026\u0026 yum makecache 3. 安装docker 操作节点： 所有节点\n ## 查看所有的可用版本 $ yum list docker-ce --showduplicates | sort -r $ yum install docker-ce-18.09.9  ## 配置docker加速 $ mkdir -p /etc/docker vi /etc/docker/daemon.json {  \"insecure-registries\": [  \"172.21.0.10:5000\"  ],  \"registry-mirrors\" : [  \"https://dockerhub.azk8s.cn\",  \"https://registry.docker-cn.com\",  \"https://ot2k4d59.mirror.aliyuncs.com/\"  ] } ## 启动docker $ systemctl enable docker \u0026\u0026 systemctl start docker 部署kubernetes 1. 安装 kubeadm, kubelet 和 kubectl 操作节点： 所有的master和slave节点(k8s-master,k8s-slave) 需要执行\n$ yum install -y kubelet-1.16.2 kubeadm-1.16.2 kubectl-1.16.2 --disableexcludes=kubernetes ## 查看kubeadm 版本 $ kubeadm version ## 设置kubelet开机启动 $ systemctl enable kubelet 2. 初始化配置文件 操作节点： 只在master节点（k8s-master）执行\n$ kubeadm config print init-defaults  kubeadm.yaml $ cat kubeadm.yaml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups:  - system:bootstrappers:kubeadm:default-node-token  token: abcdef.0123456789abcdef  ttl: 24h0m0s  usages:  - signing  - authentication kind: InitConfiguration localAPIEndpoint:  advertiseAddress: 172.21.0.10 # apiserver地址，因为单master，所以配置master的节点内网IP  bindPort: 6443 nodeRegistration:  criSocket: /var/run/dockershim.sock  name: k8s-master # 默认读取当前master节点的hostname  taints:  - effect: NoSchedule  key: node-role.kubernetes.io/master --- apiServer:  timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns:  type: CoreDNS etcd:  local:  dataDir: /var/lib/etcd imageRepository: gcr.azk8s.cn/google_containers # 修改成微软镜像源,或者registry.cn-shanghai.aliyuncs.com/gcr-k8s kind: ClusterConfiguration kubernetesVersion: v1.16.2 networking:  dnsDomain: cluster.local  podSubnet: 10.244.0.0/16 # Pod 网段，flannel插件需要使用这个网段  serviceSubnet: 10.96.0.0/12 scheduler: {}  对于上面的资源清单的文档比较杂，要想完整了解上面的资源对象对应的属性，可以查看对应的 godoc 文档，地址: https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2。\n 3. 提前下载镜像 操作节点：只在master节点（k8s-master）执行\n# 查看需要使用的镜像列表,若无问题，将得到如下列表 $ kubeadm config images list --config kubeadm.yaml gcr.azk8s.cn/google_containers/kube-apiserver:v1.16.2 gcr.azk8s.cn/google_containers/kube-controller-manager:v1.16.2 gcr.azk8s.cn/google_containers/kube-scheduler:v1.16.2 gcr.azk8s.cn/google_containers/kube-proxy:v1.16.2 gcr.azk8s.cn/google_containers/pause:3.1 gcr.azk8s.cn/google_containers/etcd:3.3.15-0 gcr.azk8s.cn/google_containers/coredns:1.6.2  # 提前下载镜像到本地 $ kubeadm config images pull --config kubeadm.yaml 4. 初始化master节点 操作节点：只在master节点（k8s-master）执行\nkubeadm init --config kubeadm.yaml 若初始化成功后，最后会提示如下信息：\n... Your Kubernetes master has initialized successfully!  To start using your cluster, you need to run the following as a regular user:   mkdir -p $HOME/.kube  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  sudo chown $(id -u):$(id -g) $HOME/.kube/config  You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:  https://kubernetes.io/docs/concepts/cluster-administration/addons/  Then you can join any number of worker nodes by running the following on each as root:  kubeadm join 172.21.0.10:6443 --token abcdef.0123456789abcdef \\  --discovery-token-ca-cert-hash sha256:1c4305f032f4bf534f628c32f5039084f4b103c922ff71b12a5f0f98d1ca9a4f 接下来按照上述提示信息操作，配置kubectl客户端的认证\n mkdir -p $HOME/.kube  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  sudo chown $(id -u):$(id -g) $HOME/.kube/config  ⚠️注意：此时使用 kubectl get nodes查看节点应该处于notReady状态，因为还未配置网络插件\n若执行初始化过程中出错，根据错误信息调整后，执行kubeadm reset后再次执行init操作即可\n 5. 添加slave节点到集群中 操作节点：所有的slave节点（k8s-slave）需要执行 在每台slave节点，执行如下命令，该命令是在kubeadm init成功后提示信息中打印出来的，需要替换成实际init后打印出的命令。\nkubeadm join 172.21.0.10:6443 --token abcdef.0123456789abcdef \\  --discovery-token-ca-cert-hash sha256:1c4305f032f4bf534f628c32f5039084f4b103c922ff71b12a5f0f98d1ca9a4f 6. 安装flannel插件 操作节点：只在master节点（k8s-master）执行\n 下载flannel的yaml文件  wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml  修改配置，指定网卡名称，大概在文件的190行，添加一行配置：  $ vi kube-flannel.yml ...  containers:  - name: kube-flannel  image: quay.io/coreos/flannel:v0.11.0-amd64  command:  - /opt/bin/flanneld  args:  - --ip-masq  - --kube-subnet-mgr  - --iface=eth0 # 如果机器存在多网卡的话，指定内网网卡的名称，默认不指定的话会找第一块网  resources:  requests:  cpu: \"100m\" ...  执行安装flannel网络插件  # 先拉取镜像,此过程国内速度比较慢 $ docker pull quay.io/coreos/flannel:v0.11.0-amd64 # 执行flannel安装 $ kubectl create -f kube-flannel.yaml 7. 设置master节点是否可调度（可选） 操作节点：k8s-master\n默认部署成功后，master节点无法调度业务pod，如需设置master节点也可以参与pod的调度，需执行：\n$ kubectl taint node k8s-master node-role.kubernetes.io/master:NoSchedule- 8. 验证集群 操作节点： 在master节点（k8s-master）执行\n$ kubectl get nodes #观察集群节点是否全部Ready NAME STATUS ROLES AGE VERSION k8s-master Ready master 22h v1.13.3 k8s-slave Ready  22h v1.13.3 创建测试nginx服务\n$ kubectl run test-nginx --image=nginx:alpine 查看pod是否创建成功，并访问pod ip测试是否可用\n$ kubectl get po -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES test-nginx-5bd8859b98-5nnnw 1/1 Running 0 9s 10.244.1.2 k8s-slave1   $ curl 10.244.1.2 ... Welcome to nginx! If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\n For online documentation and support please refer to =\"http://nginx.org/\"nginx.org. Commercial support is available at =\"http://nginx.com/\"nginx.com.\n Thank you for using nginx.\n  9. 部署dashboard  部署服务  # 推荐使用下面这种方式 $ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml $ vi recommended.yaml # 修改Service为NodePort类型 ...... kind: Service apiVersion: v1 metadata:  labels:  k8s-app: kubernetes-dashboard  name: kubernetes-dashboard  namespace: kubernetes-dashboard spec:  ports:  - port: 443  targetPort: 8443  selector:  k8s-app: kubernetes-dashboard  type: NodePort # 加上type=NodePort变成NodePort类型的服务 ......  查看访问地址，本例为30133端口  kubectl -n kubernetes-dashboard get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE dashboard-metrics-scraper ClusterIP 10.105.62.124  8000/TCP 31m kubernetes-dashboard NodePort 10.103.74.46  443:30133/TCP 31m  使用浏览器访问 https://62.234.133.177:30133，其中62.234.133.177为master节点的外网ip地址，chrome目前由于安全限制，测试访问不了，使用firefox可以进行访问。 创建ServiceAccount进行访问  $ vi admin.conf kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata:  name: admin  annotations:  rbac.authorization.kubernetes.io/autoupdate: \"true\" roleRef:  kind: ClusterRole  name: cluster-admin  apiGroup: rbac.authorization.k8s.io subjects: - kind: ServiceAccount  name: admin  namespace: kubernetes-dashboard  --- apiVersion: v1 kind: ServiceAccount metadata:  name: admin  namespace: kubernetes-dashboard  $ kubectl -n kubernetes-dashboard get secret |grep admin-token admin-token-fqdpf kubernetes.io/service-account-token 3 7m17s # 使用该命令拿到token，然后粘贴到 $ kubectl -n kubernetes-dashboard get secret admin-token-fqdpf -o jsonpath={.data.token}|base64 -d eyJhbGciOiJSUzI1NiIsImtpZCI6Ik1rb2xHWHMwbWFPMjJaRzhleGRqaExnVi1BLVNRc2txaEhETmVpRzlDeDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi1mcWRwZiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjYyNWMxNjJlLTQ1ZG... 10. 清理环境 如果你的集群安装过程中遇到了其他问题，我们可以使用下面的命令来进行重置：\n$ kubeadm reset $ ifconfig cni0 down \u0026\u0026 ip link delete cni0 $ ifconfig flannel.1 down \u0026\u0026 ip link delete flannel.1 $ rm -rf /var/lib/cni/ 11. 组件位置   etcd、apiserver、controller-manager、kube-scheduler\n静态Pod的方式\n$ kubectl -n kube-system get po  kubelet kubectl    ",
  "wordCount" : "856",
  "inLanguage": "zh",
  "datePublished": "2021-12-15T14:58:45Z",
  "dateModified": "2021-12-15T14:58:45Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/kubernetes1.16%E5%AE%89%E8%A3%85kubadm%E6%96%B9%E5%BC%8F/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      Kubernetes1.16安装[kubadm方式]
    </h1>
    <div class="post-meta"><span title='2021-12-15 14:58:45 +0000 UTC'>2021-12-15</span>&nbsp;·&nbsp;5 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e9%9b%86%e7%be%a4%e4%bf%a1%e6%81%af" aria-label="集群信息">集群信息</a><ul>
                            
                    <li>
                        <a href="#1-%e8%8a%82%e7%82%b9%e8%a7%84%e5%88%92" aria-label="1. 节点规划">1. 节点规划</a></li>
                    <li>
                        <a href="#2-%e7%bb%84%e4%bb%b6%e7%89%88%e6%9c%ac" aria-label="2. 组件版本">2. 组件版本</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85%e5%89%8d%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="安装前准备工作">安装前准备工作</a><ul>
                            
                    <li>
                        <a href="#1-%e8%ae%be%e7%bd%aehosts%e8%a7%a3%e6%9e%90" aria-label="1. 设置hosts解析">1. 设置hosts解析</a></li>
                    <li>
                        <a href="#2-%e8%b0%83%e6%95%b4%e7%b3%bb%e7%bb%9f%e9%85%8d%e7%bd%ae" aria-label="2. 调整系统配置">2. 调整系统配置</a></li>
                    <li>
                        <a href="#3-%e5%ae%89%e8%a3%85docker" aria-label="3. 安装docker">3. 安装docker</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%83%a8%e7%bd%b2kubernetes" aria-label="部署kubernetes">部署kubernetes</a><ul>
                            
                    <li>
                        <a href="#1-%e5%ae%89%e8%a3%85-kubeadm-kubelet-%e5%92%8c-kubectl" aria-label="1. 安装 kubeadm, kubelet 和 kubectl">1. 安装 kubeadm, kubelet 和 kubectl</a></li>
                    <li>
                        <a href="#2-%e5%88%9d%e5%a7%8b%e5%8c%96%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="2. 初始化配置文件">2. 初始化配置文件</a></li>
                    <li>
                        <a href="#3-%e6%8f%90%e5%89%8d%e4%b8%8b%e8%bd%bd%e9%95%9c%e5%83%8f" aria-label="3. 提前下载镜像">3. 提前下载镜像</a></li>
                    <li>
                        <a href="#4-%e5%88%9d%e5%a7%8b%e5%8c%96master%e8%8a%82%e7%82%b9" aria-label="4. 初始化master节点">4. 初始化master节点</a></li>
                    <li>
                        <a href="#5-%e6%b7%bb%e5%8a%a0slave%e8%8a%82%e7%82%b9%e5%88%b0%e9%9b%86%e7%be%a4%e4%b8%ad" aria-label="5. 添加slave节点到集群中">5. 添加slave节点到集群中</a></li>
                    <li>
                        <a href="#6-%e5%ae%89%e8%a3%85flannel%e6%8f%92%e4%bb%b6" aria-label="6. 安装flannel插件">6. 安装flannel插件</a></li>
                    <li>
                        <a href="#7--%e8%ae%be%e7%bd%aemaster%e8%8a%82%e7%82%b9%e6%98%af%e5%90%a6%e5%8f%af%e8%b0%83%e5%ba%a6%e5%8f%af%e9%80%89" aria-label="7.  设置master节点是否可调度（可选）">7.  设置master节点是否可调度（可选）</a></li>
                    <li>
                        <a href="#8-%e9%aa%8c%e8%af%81%e9%9b%86%e7%be%a4" aria-label="8. 验证集群">8. 验证集群</a></li>
                    <li>
                        <a href="#9-%e9%83%a8%e7%bd%b2dashboard" aria-label="9. 部署dashboard">9. 部署dashboard</a></li>
                    <li>
                        <a href="#10-%e6%b8%85%e7%90%86%e7%8e%af%e5%a2%83" aria-label="10. 清理环境">10. 清理环境</a></li>
                    <li>
                        <a href="#11-%e7%bb%84%e4%bb%b6%e4%bd%8d%e7%bd%ae" aria-label="11. 组件位置">11. 组件位置</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h2 id="集群信息">集群信息<a hidden class="anchor" aria-hidden="true" href="#集群信息">#</a></h2>
<h3 id="1-节点规划">1. 节点规划<a hidden class="anchor" aria-hidden="true" href="#1-节点规划">#</a></h3>
<p>部署k8s集群的节点按照用途可以划分为如下2类角色：</p>
<ul>
<li>master：集群的master节点，集群的初始化节点，基础配置不低于2C4G</li>
<li>slave：集群的slave节点，可以多台，基础配置不低于2C4G</li>
</ul>
<p>本例为了演示slave节点的添加，会部署一台master+2台slave，节点规划如下：</p>
<table>
<thead>
<tr>
<th><strong>主机名</strong></th>
<th><strong>节点ip</strong></th>
<th><strong>角色</strong></th>
<th><strong>部署组件</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-master</td>
<td>192.168.136.128</td>
<td>master</td>
<td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, flannel</td>
</tr>
<tr>
<td>k8s-slave1</td>
<td>192.168.136.131</td>
<td>slave</td>
<td>kubectl, kubelet, kube-proxy, flannel</td>
</tr>
<tr>
<td>k8s-slave2</td>
<td>192.168.136.132</td>
<td>slave</td>
<td>kubectl, kubelet, kube-proxy, flannel</td>
</tr>
</tbody>
</table>
<h3 id="2-组件版本">2. 组件版本<a hidden class="anchor" aria-hidden="true" href="#2-组件版本">#</a></h3>
<table>
<thead>
<tr>
<th><strong>组件</strong></th>
<th><strong>版本</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS</td>
<td>7.6.1810</td>
<td></td>
</tr>
<tr>
<td>Kernel</td>
<td>Linux 3.10.0-1062.9.1.el7.x86_64</td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td>3.3.15</td>
<td>使用容器方式部署，默认数据挂载到本地路径</td>
</tr>
<tr>
<td>coredns</td>
<td>1.6.2</td>
<td></td>
</tr>
<tr>
<td>kubeadm</td>
<td>v1.16.2</td>
<td></td>
</tr>
<tr>
<td>kubectl</td>
<td>v1.16.2</td>
<td></td>
</tr>
<tr>
<td>kubelet</td>
<td>v1.16.2</td>
<td></td>
</tr>
<tr>
<td>kube-proxy</td>
<td>v1.16.2</td>
<td></td>
</tr>
<tr>
<td>flannel</td>
<td>v0.11.0</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="安装前准备工作">安装前准备工作<a hidden class="anchor" aria-hidden="true" href="#安装前准备工作">#</a></h2>
<h3 id="1-设置hosts解析">1. 设置hosts解析<a hidden class="anchor" aria-hidden="true" href="#1-设置hosts解析">#</a></h3>
<p>操作节点：所有节点（k8s-master，k8s-slave）均需执行</p>
<ul>
<li>修改hostname
hostname必须只能包含小写字母、数字、&quot;,&quot;、&quot;-&quot;，且开头结尾必须是小写字母或数字</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 在master节点</span>
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-master <span style="color:#75715e">#设置master节点的hostname</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在slave-1节点</span>
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-slave1 <span style="color:#75715e">#设置slave1节点的hostname</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在slave-2节点</span>
</span></span><span style="display:flex;"><span>$ hostnamectl set-hostname k8s-slave2 <span style="color:#75715e">#设置slave2节点的hostname</span>
</span></span></code></pre></div><ul>
<li>添加hosts解析</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat &gt;&gt;/etc/hosts<span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.136.128 k8s-master
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.136.131 k8s-slave1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">192.168.136.132 k8s-slave2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h3 id="2-调整系统配置">2. 调整系统配置<a hidden class="anchor" aria-hidden="true" href="#2-调整系统配置">#</a></h3>
<p>操作节点： 所有的master和slave节点（k8s-master,k8s-slave）需要执行</p>
<blockquote>
<p>本章下述操作均以k8s-master为例，其他节点均是相同的操作（ip和hostname的值换成对应机器的真实值）</p>
</blockquote>
<ul>
<li>设置安全组开放端口</li>
</ul>
<p>如果节点间无安全组限制（内网机器间可以任意访问），可以忽略，否则，至少保证如下端口可通：
k8s-master节点：TCP：6443，2379，2380，60080，60081UDP协议端口全部打开
k8s-slave节点：UDP协议端口全部打开</p>
<ul>
<li>设置iptables</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>iptables -P FORWARD ACCEPT
</span></span></code></pre></div><ul>
<li>关闭swap</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 防止开机自动挂载 swap 分区</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span></code></pre></div><ul>
<li>关闭selinux和防火墙</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sed -ri <span style="color:#e6db74">&#39;s#(SELINUX=).*#\1disabled#&#39;</span> /etc/selinux/config
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>systemctl disable firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl stop firewalld
</span></span></code></pre></div><ul>
<li>修改内核参数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vm.max_map_count=262144
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></div><ul>
<li>设置yum源</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>$ curl -o /etc/yum.repos.d/docker-ce.repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>$ yum clean all <span style="color:#f92672">&amp;&amp;</span> yum makecache
</span></span></code></pre></div><h3 id="3-安装docker">3. 安装docker<a hidden class="anchor" aria-hidden="true" href="#3-安装docker">#</a></h3>
<p>操作节点： 所有节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#75715e">## 查看所有的可用版本</span>
</span></span><span style="display:flex;"><span>$ yum list docker-ce --showduplicates | sort -r
</span></span><span style="display:flex;"><span>$ yum install docker-ce-18.09.9
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 配置docker加速</span>
</span></span><span style="display:flex;"><span>$ mkdir -p /etc/docker
</span></span><span style="display:flex;"><span>vi /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;172.21.0.10:5000&#34;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,                          
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span> : <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://dockerhub.azk8s.cn&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://registry.docker-cn.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;https://ot2k4d59.mirror.aliyuncs.com/&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 启动docker</span>
</span></span><span style="display:flex;"><span>$ systemctl enable docker <span style="color:#f92672">&amp;&amp;</span> systemctl start docker
</span></span></code></pre></div><h2 id="部署kubernetes">部署kubernetes<a hidden class="anchor" aria-hidden="true" href="#部署kubernetes">#</a></h2>
<h3 id="1-安装-kubeadm-kubelet-和-kubectl">1. 安装 kubeadm, kubelet 和 kubectl<a hidden class="anchor" aria-hidden="true" href="#1-安装-kubeadm-kubelet-和-kubectl">#</a></h3>
<p>操作节点： 所有的master和slave节点(k8s-master,k8s-slave) 需要执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ yum install -y kubelet-1.16.2 kubeadm-1.16.2 kubectl-1.16.2 --disableexcludes<span style="color:#f92672">=</span>kubernetes
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看kubeadm 版本</span>
</span></span><span style="display:flex;"><span>$ kubeadm version
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 设置kubelet开机启动</span>
</span></span><span style="display:flex;"><span>$ systemctl enable kubelet
</span></span></code></pre></div><h3 id="2-初始化配置文件">2. 初始化配置文件<a hidden class="anchor" aria-hidden="true" href="#2-初始化配置文件">#</a></h3>
<p>操作节点： 只在master节点（k8s-master）执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ kubeadm config print init-defaults &gt; kubeadm.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ cat kubeadm.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">apiVersion: kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bootstrapTokens</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">- groups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">system:bootstrappers:kubeadm:default-node-token</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">token: abcdef.0123456789abcdef</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">ttl: 24h0m0s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">signing</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">authentication</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">kind: InitConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">localAPIEndpoint</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">advertiseAddress: 172.21.0.10  # apiserver地址，因为单master，所以配置master的节点内网IP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">bindPort: 6443</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nodeRegistration</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">criSocket: /var/run/dockershim.sock</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">name: k8s-master  # 默认读取当前master节点的hostname</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">taints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">effect: NoSchedule</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">key: node-role.kubernetes.io/master</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">timeoutForControlPlane: 4m0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">apiVersion: kubeadm.k8s.io/v1beta2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">certificatesDir: /etc/kubernetes/pki</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">clusterName: kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">controllerManager: {}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dns</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">type: CoreDNS</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">dataDir: /var/lib/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">imageRepository: gcr.azk8s.cn/google_containers  # 修改成微软镜像源,或者registry.cn-shanghai.aliyuncs.com/gcr-k8s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">kind: ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">kubernetesVersion: v1.16.2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">dnsDomain: cluster.local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">podSubnet: 10.244.0.0/16  # Pod 网段，flannel插件需要使用这个网段</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">serviceSubnet: 10.96.0.0/12</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">scheduler: {}</span>
</span></span></code></pre></div><blockquote>
<p>对于上面的资源清单的文档比较杂，要想完整了解上面的资源对象对应的属性，可以查看对应的 godoc 文档，地址: <a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2">https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</a>。</p>
</blockquote>
<h3 id="3-提前下载镜像">3. 提前下载镜像<a hidden class="anchor" aria-hidden="true" href="#3-提前下载镜像">#</a></h3>
<p>操作节点：只在master节点（k8s-master）执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看需要使用的镜像列表,若无问题，将得到如下列表</span>
</span></span><span style="display:flex;"><span>$ kubeadm config images list --config kubeadm.yaml
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/kube-apiserver:v1.16.2
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/kube-controller-manager:v1.16.2
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/kube-scheduler:v1.16.2
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/kube-proxy:v1.16.2
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/pause:3.1
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/etcd:3.3.15-0
</span></span><span style="display:flex;"><span>gcr.azk8s.cn/google_containers/coredns:1.6.2
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 提前下载镜像到本地</span>
</span></span><span style="display:flex;"><span>$ kubeadm config images pull --config kubeadm.yaml
</span></span></code></pre></div><h3 id="4-初始化master节点">4. 初始化master节点<a hidden class="anchor" aria-hidden="true" href="#4-初始化master节点">#</a></h3>
<p>操作节点：只在master节点（k8s-master）执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubeadm init --config kubeadm.yaml
</span></span></code></pre></div><p>若初始化成功后，最后会提示如下信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Your Kubernetes master has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join 172.21.0.10:6443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:1c4305f032f4bf534f628c32f5039084f4b103c922ff71b12a5f0f98d1ca9a4f
</span></span></code></pre></div><p>接下来按照上述提示信息操作，配置kubectl客户端的认证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><blockquote>
<p>⚠️注意：此时使用 kubectl get nodes查看节点应该处于notReady状态，因为还未配置网络插件</p>
<p>若执行初始化过程中出错，根据错误信息调整后，执行kubeadm reset后再次执行init操作即可</p>
</blockquote>
<h3 id="5-添加slave节点到集群中">5. 添加slave节点到集群中<a hidden class="anchor" aria-hidden="true" href="#5-添加slave节点到集群中">#</a></h3>
<p>操作节点：所有的slave节点（k8s-slave）需要执行
在每台slave节点，执行如下命令，该命令是在kubeadm init成功后提示信息中打印出来的，需要替换成实际init后打印出的命令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubeadm join 172.21.0.10:6443 --token abcdef.0123456789abcdef <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --discovery-token-ca-cert-hash sha256:1c4305f032f4bf534f628c32f5039084f4b103c922ff71b12a5f0f98d1ca9a4f
</span></span></code></pre></div><h3 id="6-安装flannel插件">6. 安装flannel插件<a hidden class="anchor" aria-hidden="true" href="#6-安装flannel插件">#</a></h3>
<p>操作节点：只在master节点（k8s-master）执行</p>
<ul>
<li>下载flannel的yaml文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml
</span></span></code></pre></div><ul>
<li>修改配置，指定网卡名称，大概在文件的190行，添加一行配置：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ vi kube-flannel.yml</span>
</span></span><span style="display:flex;"><span>...      
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">name: kube-flannel</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">image: quay.io/coreos/flannel:v0.11.0-amd64</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/opt/bin/flanneld</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">ip-masq</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">kube-subnet-mgr</span>
</span></span><span style="display:flex;"><span>        - --<span style="color:#ae81ff">iface=eth0  # 如果机器存在多网卡的话，指定内网网卡的名称，默认不指定的话会找第一块网</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">cpu: &#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><ul>
<li>执行安装flannel网络插件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 先拉取镜像,此过程国内速度比较慢</span>
</span></span><span style="display:flex;"><span>$ docker pull quay.io/coreos/flannel:v0.11.0-amd64
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行flannel安装</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f kube-flannel.yaml
</span></span></code></pre></div><h3 id="7--设置master节点是否可调度可选">7.  设置master节点是否可调度（可选）<a hidden class="anchor" aria-hidden="true" href="#7--设置master节点是否可调度可选">#</a></h3>
<p>操作节点：k8s-master</p>
<p>默认部署成功后，master节点无法调度业务pod，如需设置master节点也可以参与pod的调度，需执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl taint node k8s-master node-role.kubernetes.io/master:NoSchedule-
</span></span></code></pre></div><h3 id="8-验证集群">8. 验证集群<a hidden class="anchor" aria-hidden="true" href="#8-验证集群">#</a></h3>
<p>操作节点： 在master节点（k8s-master）执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get nodes  <span style="color:#75715e">#观察集群节点是否全部Ready</span>
</span></span><span style="display:flex;"><span>NAME                STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master   Ready    master   22h   v1.13.3
</span></span><span style="display:flex;"><span>k8s-slave   Ready    &lt;none&gt;   22h   v1.13.3
</span></span></code></pre></div><p>创建测试nginx服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl run  test-nginx --image<span style="color:#f92672">=</span>nginx:alpine
</span></span></code></pre></div><p>查看pod是否创建成功，并访问pod ip测试是否可用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get po -o wide
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>test-nginx-5bd8859b98-5nnnw   1/1     Running   0          9s    10.244.1.2   k8s-slave1   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>$ curl 10.244.1.2
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span style="display:flex;"><span>working. Further configuration is required.&lt;/p&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;p&gt;For online documentation and support please refer to
</span></span><span style="display:flex;"><span>&lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span style="display:flex;"><span>Commercial support is available at
</span></span><span style="display:flex;"><span>&lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;p&gt;&lt;em&gt;Thank you <span style="color:#66d9ef">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><h3 id="9-部署dashboard">9. 部署dashboard<a hidden class="anchor" aria-hidden="true" href="#9-部署dashboard">#</a></h3>
<ul>
<li>部署服务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 推荐使用下面这种方式</span>
</span></span><span style="display:flex;"><span>$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml
</span></span><span style="display:flex;"><span>$ vi recommended.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改Service为NodePort类型</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kubernetes-dashboard
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - port: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  type: NodePort  <span style="color:#75715e"># 加上type=NodePort变成NodePort类型的服务</span>
</span></span><span style="display:flex;"><span>......
</span></span></code></pre></div><ul>
<li>查看访问地址，本例为30133端口</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard get svc
</span></span><span style="display:flex;"><span>NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>         AGE
</span></span><span style="display:flex;"><span>dashboard-metrics-scraper   ClusterIP   10.105.62.124   &lt;none&gt;        8000/TCP        31m
</span></span><span style="display:flex;"><span>kubernetes-dashboard        NodePort    10.103.74.46    &lt;none&gt;        443:30133/TCP   31m
</span></span></code></pre></div><ul>
<li>使用浏览器访问 https://62.234.133.177:30133，其中62.234.133.177为master节点的外网ip地址，chrome目前由于安全限制，测试访问不了，使用firefox可以进行访问。</li>
<li>创建ServiceAccount进行访问</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ vi admin.conf
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: admin
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    rbac.authorization.kubernetes.io/autoupdate: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: cluster-admin
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: admin
</span></span><span style="display:flex;"><span>  namespace: kubernetes-dashboard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: admin
</span></span><span style="display:flex;"><span>  namespace: kubernetes-dashboard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n kubernetes-dashboard get secret |grep admin-token
</span></span><span style="display:flex;"><span>admin-token-fqdpf                  kubernetes.io/service-account-token   3      7m17s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用该命令拿到token，然后粘贴到</span>
</span></span><span style="display:flex;"><span>$ kubectl -n kubernetes-dashboard get secret admin-token-fqdpf -o jsonpath<span style="color:#f92672">={</span>.data.token<span style="color:#f92672">}</span>|base64 -d
</span></span><span style="display:flex;"><span>eyJhbGciOiJSUzI1NiIsImtpZCI6Ik1rb2xHWHMwbWFPMjJaRzhleGRqaExnVi1BLVNRc2txaEhETmVpRzlDeDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi1mcWRwZiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjYyNWMxNjJlLTQ1ZG...
</span></span></code></pre></div><h3 id="10-清理环境">10. 清理环境<a hidden class="anchor" aria-hidden="true" href="#10-清理环境">#</a></h3>
<p>如果你的集群安装过程中遇到了其他问题，我们可以使用下面的命令来进行重置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubeadm reset
</span></span><span style="display:flex;"><span>$ ifconfig cni0 down <span style="color:#f92672">&amp;&amp;</span> ip link delete cni0
</span></span><span style="display:flex;"><span>$ ifconfig flannel.1 down <span style="color:#f92672">&amp;&amp;</span> ip link delete flannel.1
</span></span><span style="display:flex;"><span>$ rm -rf /var/lib/cni/
</span></span></code></pre></div><h3 id="11-组件位置">11. 组件位置<a hidden class="anchor" aria-hidden="true" href="#11-组件位置">#</a></h3>
<ul>
<li>
<p>etcd、apiserver、controller-manager、kube-scheduler</p>
<p>静态Pod的方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n kube-system get po
</span></span></code></pre></div><ul>
<li>kubelet</li>
<li>kubectl</li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/%E9%85%8D%E7%BD%AEnginx%E8%AE%BF%E9%97%AE%E7%BD%91%E9%A1%B5%E9%9C%80%E8%A6%81%E5%AF%86%E7%A0%81/">
    <span class="title">« 上一页</span>
    <br>
    <span>配置Nginx访问网页需要密码</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/k8s%E6%90%AD%E5%BB%BAconsul%E9%9B%86%E7%BE%A4/">
    <span class="title">下一页 »</span>
    <br>
    <span>k8s搭建consul集群</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
