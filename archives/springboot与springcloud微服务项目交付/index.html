<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>SpringBoot与SpringCloud微服务项目交付 | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="Spring Cloud微服务项目交付 微服务扫盲篇 微服务并没有一个官方的定义，想要直接描述微服务比较困难，我们可以通过对比传统WEB应用，来理解什么是微服务。
单体应用架构 如下是传统打车软件架构图：
这种单体应用比较适合于小项目，优点是：
 开发简单直接，集中式管理 基本不会重复开发 功能都在本地，没有分布式的管理开销和调用开销  当然它的缺点也十分明显，特别对于互联网公司来说：
 开发效率低：所有的开发在一个项目改代码，递交代码相互等待，代码冲突不断 代码维护难：代码功能耦合在一起，新人不知道何从下手 部署不灵活：构建时间长，任何小修改必须重新构建整个项目，这个过程往往很长 稳定性不高：一个微不足道的小问题，可以导致整个应用挂掉 扩展性不够：无法满足高并发情况下的业务需求  微服务应用架构 微服务架构的设计思路不是开发一个巨大的单体式应用，而是将应用分解为小的、互相连接的微服务。一个微服务完成某个特定功能，比如乘客管理和下单管理等。每个微服务都有自己的业务逻辑和适配器。一些微服务还会提供API接口给其他微服务和应用客户端使用。
比如，前面描述的系统可被分解为：
每个业务逻辑都被分解为一个微服务，微服务之间通过REST API通信。一些微服务也会向终端用户或客户端开发API接口。但通常情况下，这些客户端并不能直接访问后台微服务，而是通过API Gateway来传递请求。API Gateway一般负责服务路由、负载均衡、缓存、访问控制和鉴权等任务。
微服务架构优点：
 解决了复杂性问题。它将单体应用分解为一组服务。虽然功能总量不变，但应用程序已被分解为可管理的模块或服务 体系结构使得每个服务都可以由专注于此服务的团队独立开发。只要符合服务API契约，开发人员可以自由选择开发技术。这就意味着开发人员可以采用新技术编写或重构服务，由于服务相对较小，所以这并不会对整体应用造成太大影响 微服务架构可以使每个微服务独立部署。这些更改可以在测试通过后立即部署。所以微服务架构也使得CI／CD成为可能  微服务架构问题及挑战 微服务的一个主要缺点是微服务的分布式特点带来的复杂性。开发人员需要基于RPC或者消息实现微服务之间的调用和通信，而这就使得服务之间的发现、服务调用链的跟踪和质量问题变得的相当棘手。
 微服务的一大挑战是跨多个服务的更改  比如在传统单体应用中，若有A、B、C三个服务需要更改，A依赖B，B依赖C。我们只需更改相应的模块，然后一次性部署即可。 在微服务架构中，我们需要仔细规划和协调每个服务的变更部署。我们需要先更新C，然后更新B，最后更新A。   部署基于微服务的应用也要复杂得多  单体应用可以简单的部署在一组相同的服务器上，然后前端使用负载均衡即可。 微服务由不同的大量服务构成。每种服务可能拥有自己的配置、应用实例数量以及基础服务地址。这里就需要不同的配置、部署、扩展和监控组件。此外，我们还需要服务发现机制，以便服务可以发现与其通信的其他服务的地址    以上问题和挑战可大体概括为：
 API Gateway 服务间调用 服务发现 服务容错 服务部署 数据调用  https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155，自助餐吃吃喝喝，竟然秒懂微服务
微服务框架 如何应对上述挑战，出现了如下微服务领域的框架：
  Spring Cloud（各个微服务基于Spring Boot实现）
  Dubbo">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="SpringBoot与SpringCloud微服务项目交付" />
<meta property="og:description" content="Spring Cloud微服务项目交付 微服务扫盲篇 微服务并没有一个官方的定义，想要直接描述微服务比较困难，我们可以通过对比传统WEB应用，来理解什么是微服务。
单体应用架构 如下是传统打车软件架构图：
这种单体应用比较适合于小项目，优点是：
 开发简单直接，集中式管理 基本不会重复开发 功能都在本地，没有分布式的管理开销和调用开销  当然它的缺点也十分明显，特别对于互联网公司来说：
 开发效率低：所有的开发在一个项目改代码，递交代码相互等待，代码冲突不断 代码维护难：代码功能耦合在一起，新人不知道何从下手 部署不灵活：构建时间长，任何小修改必须重新构建整个项目，这个过程往往很长 稳定性不高：一个微不足道的小问题，可以导致整个应用挂掉 扩展性不够：无法满足高并发情况下的业务需求  微服务应用架构 微服务架构的设计思路不是开发一个巨大的单体式应用，而是将应用分解为小的、互相连接的微服务。一个微服务完成某个特定功能，比如乘客管理和下单管理等。每个微服务都有自己的业务逻辑和适配器。一些微服务还会提供API接口给其他微服务和应用客户端使用。
比如，前面描述的系统可被分解为：
每个业务逻辑都被分解为一个微服务，微服务之间通过REST API通信。一些微服务也会向终端用户或客户端开发API接口。但通常情况下，这些客户端并不能直接访问后台微服务，而是通过API Gateway来传递请求。API Gateway一般负责服务路由、负载均衡、缓存、访问控制和鉴权等任务。
微服务架构优点：
 解决了复杂性问题。它将单体应用分解为一组服务。虽然功能总量不变，但应用程序已被分解为可管理的模块或服务 体系结构使得每个服务都可以由专注于此服务的团队独立开发。只要符合服务API契约，开发人员可以自由选择开发技术。这就意味着开发人员可以采用新技术编写或重构服务，由于服务相对较小，所以这并不会对整体应用造成太大影响 微服务架构可以使每个微服务独立部署。这些更改可以在测试通过后立即部署。所以微服务架构也使得CI／CD成为可能  微服务架构问题及挑战 微服务的一个主要缺点是微服务的分布式特点带来的复杂性。开发人员需要基于RPC或者消息实现微服务之间的调用和通信，而这就使得服务之间的发现、服务调用链的跟踪和质量问题变得的相当棘手。
 微服务的一大挑战是跨多个服务的更改  比如在传统单体应用中，若有A、B、C三个服务需要更改，A依赖B，B依赖C。我们只需更改相应的模块，然后一次性部署即可。 在微服务架构中，我们需要仔细规划和协调每个服务的变更部署。我们需要先更新C，然后更新B，最后更新A。   部署基于微服务的应用也要复杂得多  单体应用可以简单的部署在一组相同的服务器上，然后前端使用负载均衡即可。 微服务由不同的大量服务构成。每种服务可能拥有自己的配置、应用实例数量以及基础服务地址。这里就需要不同的配置、部署、扩展和监控组件。此外，我们还需要服务发现机制，以便服务可以发现与其通信的其他服务的地址    以上问题和挑战可大体概括为：
 API Gateway 服务间调用 服务发现 服务容错 服务部署 数据调用  https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155，自助餐吃吃喝喝，竟然秒懂微服务
微服务框架 如何应对上述挑战，出现了如下微服务领域的框架：
  Spring Cloud（各个微服务基于Spring Boot实现）
  Dubbo" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-11T15:30:27&#43;00:00" />
<meta property="article:modified_time" content="2022-01-11T15:30:27&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SpringBoot与SpringCloud微服务项目交付"/>
<meta name="twitter:description" content="Spring Cloud微服务项目交付 微服务扫盲篇 微服务并没有一个官方的定义，想要直接描述微服务比较困难，我们可以通过对比传统WEB应用，来理解什么是微服务。
单体应用架构 如下是传统打车软件架构图：
这种单体应用比较适合于小项目，优点是：
 开发简单直接，集中式管理 基本不会重复开发 功能都在本地，没有分布式的管理开销和调用开销  当然它的缺点也十分明显，特别对于互联网公司来说：
 开发效率低：所有的开发在一个项目改代码，递交代码相互等待，代码冲突不断 代码维护难：代码功能耦合在一起，新人不知道何从下手 部署不灵活：构建时间长，任何小修改必须重新构建整个项目，这个过程往往很长 稳定性不高：一个微不足道的小问题，可以导致整个应用挂掉 扩展性不够：无法满足高并发情况下的业务需求  微服务应用架构 微服务架构的设计思路不是开发一个巨大的单体式应用，而是将应用分解为小的、互相连接的微服务。一个微服务完成某个特定功能，比如乘客管理和下单管理等。每个微服务都有自己的业务逻辑和适配器。一些微服务还会提供API接口给其他微服务和应用客户端使用。
比如，前面描述的系统可被分解为：
每个业务逻辑都被分解为一个微服务，微服务之间通过REST API通信。一些微服务也会向终端用户或客户端开发API接口。但通常情况下，这些客户端并不能直接访问后台微服务，而是通过API Gateway来传递请求。API Gateway一般负责服务路由、负载均衡、缓存、访问控制和鉴权等任务。
微服务架构优点：
 解决了复杂性问题。它将单体应用分解为一组服务。虽然功能总量不变，但应用程序已被分解为可管理的模块或服务 体系结构使得每个服务都可以由专注于此服务的团队独立开发。只要符合服务API契约，开发人员可以自由选择开发技术。这就意味着开发人员可以采用新技术编写或重构服务，由于服务相对较小，所以这并不会对整体应用造成太大影响 微服务架构可以使每个微服务独立部署。这些更改可以在测试通过后立即部署。所以微服务架构也使得CI／CD成为可能  微服务架构问题及挑战 微服务的一个主要缺点是微服务的分布式特点带来的复杂性。开发人员需要基于RPC或者消息实现微服务之间的调用和通信，而这就使得服务之间的发现、服务调用链的跟踪和质量问题变得的相当棘手。
 微服务的一大挑战是跨多个服务的更改  比如在传统单体应用中，若有A、B、C三个服务需要更改，A依赖B，B依赖C。我们只需更改相应的模块，然后一次性部署即可。 在微服务架构中，我们需要仔细规划和协调每个服务的变更部署。我们需要先更新C，然后更新B，最后更新A。   部署基于微服务的应用也要复杂得多  单体应用可以简单的部署在一组相同的服务器上，然后前端使用负载均衡即可。 微服务由不同的大量服务构成。每种服务可能拥有自己的配置、应用实例数量以及基础服务地址。这里就需要不同的配置、部署、扩展和监控组件。此外，我们还需要服务发现机制，以便服务可以发现与其通信的其他服务的地址    以上问题和挑战可大体概括为：
 API Gateway 服务间调用 服务发现 服务容错 服务部署 数据调用  https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155，自助餐吃吃喝喝，竟然秒懂微服务
微服务框架 如何应对上述挑战，出现了如下微服务领域的框架：
  Spring Cloud（各个微服务基于Spring Boot实现）
  Dubbo"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "SpringBoot与SpringCloud微服务项目交付",
      "item": "https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SpringBoot与SpringCloud微服务项目交付",
  "name": "SpringBoot与SpringCloud微服务项目交付",
  "description": "Spring Cloud微服务项目交付 微服务扫盲篇 微服务并没有一个官方的定义，想要直接描述微服务比较困难，我们可以通过对比传统WEB应用，来理解什么是微服务。\n单体应用架构 如下是传统打车软件架构图：\n这种单体应用比较适合于小项目，优点是：\n 开发简单直接，集中式管理 基本不会重复开发 功能都在本地，没有分布式的管理开销和调用开销  当然它的缺点也十分明显，特别对于互联网公司来说：\n 开发效率低：所有的开发在一个项目改代码，递交代码相互等待，代码冲突不断 代码维护难：代码功能耦合在一起，新人不知道何从下手 部署不灵活：构建时间长，任何小修改必须重新构建整个项目，这个过程往往很长 稳定性不高：一个微不足道的小问题，可以导致整个应用挂掉 扩展性不够：无法满足高并发情况下的业务需求  微服务应用架构 微服务架构的设计思路不是开发一个巨大的单体式应用，而是将应用分解为小的、互相连接的微服务。一个微服务完成某个特定功能，比如乘客管理和下单管理等。每个微服务都有自己的业务逻辑和适配器。一些微服务还会提供API接口给其他微服务和应用客户端使用。\n比如，前面描述的系统可被分解为：\n每个业务逻辑都被分解为一个微服务，微服务之间通过REST API通信。一些微服务也会向终端用户或客户端开发API接口。但通常情况下，这些客户端并不能直接访问后台微服务，而是通过API Gateway来传递请求。API Gateway一般负责服务路由、负载均衡、缓存、访问控制和鉴权等任务。\n微服务架构优点：\n 解决了复杂性问题。它将单体应用分解为一组服务。虽然功能总量不变，但应用程序已被分解为可管理的模块或服务 体系结构使得每个服务都可以由专注于此服务的团队独立开发。只要符合服务API契约，开发人员可以自由选择开发技术。这就意味着开发人员可以采用新技术编写或重构服务，由于服务相对较小，所以这并不会对整体应用造成太大影响 微服务架构可以使每个微服务独立部署。这些更改可以在测试通过后立即部署。所以微服务架构也使得CI／CD成为可能  微服务架构问题及挑战 微服务的一个主要缺点是微服务的分布式特点带来的复杂性。开发人员需要基于RPC或者消息实现微服务之间的调用和通信，而这就使得服务之间的发现、服务调用链的跟踪和质量问题变得的相当棘手。\n 微服务的一大挑战是跨多个服务的更改  比如在传统单体应用中，若有A、B、C三个服务需要更改，A依赖B，B依赖C。我们只需更改相应的模块，然后一次性部署即可。 在微服务架构中，我们需要仔细规划和协调每个服务的变更部署。我们需要先更新C，然后更新B，最后更新A。   部署基于微服务的应用也要复杂得多  单体应用可以简单的部署在一组相同的服务器上，然后前端使用负载均衡即可。 微服务由不同的大量服务构成。每种服务可能拥有自己的配置、应用实例数量以及基础服务地址。这里就需要不同的配置、部署、扩展和监控组件。此外，我们还需要服务发现机制，以便服务可以发现与其通信的其他服务的地址    以上问题和挑战可大体概括为：\n API Gateway 服务间调用 服务发现 服务容错 服务部署 数据调用  https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155，自助餐吃吃喝喝，竟然秒懂微服务\n微服务框架 如何应对上述挑战，出现了如下微服务领域的框架：\n  Spring Cloud（各个微服务基于Spring Boot实现）\n  Dubbo",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "Spring Cloud微服务项目交付 微服务扫盲篇 微服务并没有一个官方的定义，想要直接描述微服务比较困难，我们可以通过对比传统WEB应用，来理解什么是微服务。\n单体应用架构 如下是传统打车软件架构图：\n这种单体应用比较适合于小项目，优点是：\n 开发简单直接，集中式管理 基本不会重复开发 功能都在本地，没有分布式的管理开销和调用开销  当然它的缺点也十分明显，特别对于互联网公司来说：\n 开发效率低：所有的开发在一个项目改代码，递交代码相互等待，代码冲突不断 代码维护难：代码功能耦合在一起，新人不知道何从下手 部署不灵活：构建时间长，任何小修改必须重新构建整个项目，这个过程往往很长 稳定性不高：一个微不足道的小问题，可以导致整个应用挂掉 扩展性不够：无法满足高并发情况下的业务需求  微服务应用架构 微服务架构的设计思路不是开发一个巨大的单体式应用，而是将应用分解为小的、互相连接的微服务。一个微服务完成某个特定功能，比如乘客管理和下单管理等。每个微服务都有自己的业务逻辑和适配器。一些微服务还会提供API接口给其他微服务和应用客户端使用。\n比如，前面描述的系统可被分解为：\n每个业务逻辑都被分解为一个微服务，微服务之间通过REST API通信。一些微服务也会向终端用户或客户端开发API接口。但通常情况下，这些客户端并不能直接访问后台微服务，而是通过API Gateway来传递请求。API Gateway一般负责服务路由、负载均衡、缓存、访问控制和鉴权等任务。\n微服务架构优点：\n 解决了复杂性问题。它将单体应用分解为一组服务。虽然功能总量不变，但应用程序已被分解为可管理的模块或服务 体系结构使得每个服务都可以由专注于此服务的团队独立开发。只要符合服务API契约，开发人员可以自由选择开发技术。这就意味着开发人员可以采用新技术编写或重构服务，由于服务相对较小，所以这并不会对整体应用造成太大影响 微服务架构可以使每个微服务独立部署。这些更改可以在测试通过后立即部署。所以微服务架构也使得CI／CD成为可能  微服务架构问题及挑战 微服务的一个主要缺点是微服务的分布式特点带来的复杂性。开发人员需要基于RPC或者消息实现微服务之间的调用和通信，而这就使得服务之间的发现、服务调用链的跟踪和质量问题变得的相当棘手。\n 微服务的一大挑战是跨多个服务的更改  比如在传统单体应用中，若有A、B、C三个服务需要更改，A依赖B，B依赖C。我们只需更改相应的模块，然后一次性部署即可。 在微服务架构中，我们需要仔细规划和协调每个服务的变更部署。我们需要先更新C，然后更新B，最后更新A。   部署基于微服务的应用也要复杂得多  单体应用可以简单的部署在一组相同的服务器上，然后前端使用负载均衡即可。 微服务由不同的大量服务构成。每种服务可能拥有自己的配置、应用实例数量以及基础服务地址。这里就需要不同的配置、部署、扩展和监控组件。此外，我们还需要服务发现机制，以便服务可以发现与其通信的其他服务的地址    以上问题和挑战可大体概括为：\n API Gateway 服务间调用 服务发现 服务容错 服务部署 数据调用  https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155，自助餐吃吃喝喝，竟然秒懂微服务\n微服务框架 如何应对上述挑战，出现了如下微服务领域的框架：\n  Spring Cloud（各个微服务基于Spring Boot实现）\n  Dubbo\n  Service Mesh\n  Linkerd\n  Envoy\n  Conduit\n  Istio\n    了解Spring Cloud https://spring.io\n核心项目及组件 https://spring.io/projects\n与Dubbo对比 做一个简单的功能对比：\n   核心要素 Dubbo Spring Cloud     服务注册中心 Zookeeper Spring Cloud Netflix Eureka   服务调用方式 RPC REST API   服务监控 Dubbo-monitor Spring Boot Admin   断路器 不完善 Spring Cloud Netflix Hystrix   服务网关 无 Spring Cloud Netflix Zuul   分布式配置 无 Spring Cloud Config   服务跟踪 无 Spring Cloud Sleuth   消息总线 无 Spring Cloud Bus   数据流 无 Spring Cloud Stream   批量任务 无 Spring Cloud Task   …… …… ……    从上图可以看出其实Dubbo的功能只是Spring Cloud体系的一部分。\n这样对比是不够公平的，首先Dubbo是SOA时代的产物，它的关注点主要在于服务的调用，流量分发、流量监控和熔断。而Spring Cloud诞生于微服务架构时代，考虑的是微服务治理的方方面面，另外由于依托了Spirng、Spirng Boot的优势之上，两个框架在开始目标就不一致，Dubbo定位服务治理、Spirng Cloud是一个生态。\nSpring Boot交付实践 从零开始创建Spring Boot项目 通过File  New  Project，新建工程，选择Spring Initializr\n配置Project Metadata：\n配置Dependencies依赖包：\n选择：Web分类中的Spring web和Template Engines中的Thymeleaf\n配置maven settings.xml：\n默认使用IDE自带的maven，换成自己下载的，下载地址：\n链接: https://pan.baidu.com/s/1z9dRGv_4bS1uxBtk5jsZ2Q 提取码: 3gva\n解压后放到D:\\software\\apache-maven-3.6.3,修改D:\\software\\apache-maven-3.6.3\\conf\\settings.xml 文件：\n  xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\"  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"  xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd\"  D:\\opt\\maven-repo                   \t  alimaven  central  aliyun maven  http://maven.aliyun.com/nexus/content/repositories/central/      nexus-aliyun  *  Nexus aliyun  http://maven.aliyun.com/nexus/content/groups/public        替换springboot版本为2.3.5.RELEASE\n 直接启动项目并访问本地服务：localhost:8080\n编写功能代码 创建controller包及HelloController.java文件\npackage com.luffy.demo.controller;  import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestMethod; import org.springframework.web.bind.annotation.RestController;  @RestController public class HelloController {   @RequestMapping(value = \"/hello\", method = RequestMethod.GET)  public String hello(String name) {  return \"Hello, \" + name;  } 保存并在浏览器中访问localhost:8080/hello?name=luffy\n如果页面复杂，如何实现？\n在resources/templates/目录下新建index.html\n html head  titleDevopstitle  meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" / head body div class=\"container\"  h3 th:text=\"${requestname}\"h3  a id=\"rightaway\" href=\"#\" th:href=\"@{/rightaway}\" 立即返回a  a id=\"sleep\" href=\"#\" th:href=\"@{/sleep}\"延时返回a div body html 完善HelloController.java的内容：\npackage com.luffy.demo.controller;  import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestMethod; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.servlet.ModelAndView;  @RestController public class HelloController {   @RequestMapping(value = \"/hello\", method = RequestMethod.GET)  public String hello(String name) {  return \"Hello, \" + name;  }   @RequestMapping(\"/\")  public ModelAndView index(ModelAndView mv) {  mv.setViewName(\"index\");  mv.addObject(\"requestname\", \"This is index\");  return mv;  }   @RequestMapping(\"/rightaway\")  public ModelAndView returnRightAway(ModelAndView mv) {  mv.setViewName(\"index\");  mv.addObject(\"requestname\",\"This request is RightawayApi\");  return mv;  }   @RequestMapping(\"/sleep\")  public ModelAndView returnSleep(ModelAndView mv) throws InterruptedException {  Thread.sleep(2*1000);  mv.setViewName(\"index\");  mv.addObject(\"requestname\",\"This request is SleepApi\"+\",it will sleep 2s !\");  return mv;  } } 如何在java项目中使用maven 为什么需要maven 考虑一个常见的场景：以项目A为例，开发过程中，需要依赖B-2.0.jar的包，如果没有maven，那么正常做法是把B-2.0.jar拷贝到项目A中，但是如果B-2.0.jar还依赖C.jar，我们还需要去找到C.jar的包，因此，在开发阶段需要花费在项目依赖方面的精力会很大。\n因此，开发人员需要找到一种方式，可以管理java包的依赖关系，并可以方便的引入到项目中。\nmaven如何工作 查看pom.xml\n   org.springframework.boot  spring-boot-starter-thymeleaf   可以直接在项目中添加上dependency ，这样来指定项目的依赖包。\n思考：如果spring-boot-starter-thymeleaf包依赖别的包，怎么办？\nspring-boot-starter-thymeleaf同时也是一个maven项目，也有自己的pom.xml\n查看一下：\n     org.springframework.boot  spring-boot-starter  2.3.3.RELEASE  compile      org.thymeleaf  thymeleaf-spring5  3.0.11.RELEASE  compile      org.thymeleaf.extras  thymeleaf-extras-java8time  3.0.4.RELEASE  compile     这样的话，使用maven的项目，只需要在自己的pom.xml中把所需的最直接的依赖包定义上，而不用关心这些被依赖的jar包自身是否还有别的依赖。剩下的都交给maven去搞定。\n如何搞定？maven可以根据pom.xml中定义的依赖实现包的查找\n去哪查找？maven仓库，存储jar包的地方。\n当我们执行 Maven 构建命令时，Maven 开始按照以下顺序查找依赖的库：\n本地仓库：\n  Maven 的本地仓库，在安装 Maven 后并不会创建，它是在第一次执行 maven 命令的时候才被创建。\n  运行 Maven 的时候，Maven 所需要的任何包都是直接从本地仓库获取的。如果本地仓库没有，它会首先尝试从远程仓库下载构件至本地仓库，然后再使用本地仓库的包。\n  默认情况下，不管Linux还是 Windows，每个用户在自己的用户目录下都有一个路径名为 .m2/respository/ 的仓库目录。\n  Maven 本地仓库默认被创建在 %USER_HOME% 目录下。要修改默认位置，在 %M2_HOME%\\conf 目录中的 Maven 的 settings.xml 文件中定义另一个路径。\n xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\"  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"  xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd\"  D:\\opt\\maven-repo    中央仓库：\nMaven 中央仓库是由 Maven 社区提供的仓库，中央仓库包含了绝大多数流行的开源Java构件，以及源码、作者信息、SCM、信息、许可证信息等。一般来说，简单的Java项目依赖的构件都可以在这里下载到。\n中央仓库的关键概念：\n 这个仓库由 Maven 社区管理。 不需要配置，maven中集成了地址 http://repo1.maven.org/maven2 需要通过网络才能访问。  私服仓库：\n通常使用 sonatype Nexus来搭建私服仓库。搭建完成后，需要在 setting.xml中进行配置，比如：\n  localRepository      myRepository  myRepository  http://127.0.0.1:8081/nexus/content/repositories/myRepository/    true      true        方便起见，我们直接使用国内ali提供的仓库，修改 maven 根目录下的 conf 文件夹中的 setting.xml 文件，在 mirrors 节点上，添加内容如下：\n    alimaven  aliyun maven  http://maven.aliyun.com/nexus/content/groups/public/  central    在执行构建的时候，maven会自动将所需的包下载到本地仓库中，所以第一次构建速度通常会慢一些，后面速度则很快。\n那么maven是如何找到对应的jar包的？\n我们可以访问 https://mvnrepository.com/ 查看在仓库中的jar包的样子。\n   commons-collections  commons-collections  3.2.2  刚才看到spring-boot-starter-thymeleaf的依赖同样有上述属性，因此maven就可以根据这三项属性，到对应的仓库中去查找到所需要的依赖包，并下载到本地。\n其中groupId、artifactId、version共同保证了包在仓库中的唯一性，这也就是为什么maven项目的pom.xml中都先配置这几项的原因，因为项目最终发布到远程仓库中，供别人调用。\n思考：我们项目的dependency中为什么没有写version ?\n是因为sprintboot项目的上面有人，来看一下项目parent的写法：\n   org.springframework.boot  spring-boot-starter-parent  2.3.3.RELEASE      parent模块中定义过的dependencies，在子项目中引用的话，不需要指定版本，这样可以保证所有的子项目都使用相同版本的依赖包。\n生命周期及mvn命令实践 Maven有三套相互独立的生命周期，分别是clean、default和site。每个生命周期包含一些阶段（phase），阶段是有顺序的，后面的阶段依赖于前面的阶段。\n clean生命周期，清理项目  清理：mvn clean　–删除target目录，也就是将class文件等删除   default生命周期，项目的构建等核心阶段  编译：mvn compile　–src/main/java目录java源码编译生成class （target目录下） 测试：mvn test　–src/test/java 执行目录下的测试用例 打包：mvn package　–生成压缩文件：java项目#jar包；web项目#war包，也是放在target目录下 安装：mvn install　–将压缩文件(jar或者war)上传到本地仓库 部署|发布：mvn deploy　–将压缩文件上传私服   site生命周期，建立和发布项目站点  站点 : mvn site –生成项目站点文档    各个生命周期相互独立，一个生命周期的阶段前后依赖。 生命周期阶段需要绑定到某个插件的目标才能完成真正的工作，比如test阶段正是与maven-surefire-plugin的test目标相绑定了 。\n举例如下：\n  mvn clean\n调用clean生命周期的clean阶段\n  mvn test\n调用default生命周期的test阶段，实际执行test以及之前所有阶段\n  mvn clean install\n调用clean生命周期的clean阶段和default的install阶段，实际执行clean，install以及之前所有阶段\n  在linux环境中演示：\n创建gitlab组，luffy-spring-cloud,在该组下创建项目springboot-demo\n  提交代码到git仓库\n$ git init $ git remote add origin http://gitlab.luffy.com/luffy-spring-cloud/springboot-demo.git $ git add . $ git commit -m \"Initial commit\" $ git push -u origin master   使用tools容器来运行\n$ docker run --rm -ti 172.21.51.67:5000/devops/tools:v3 bash bash-5.0# mvn -v bash: mvn: command not found # 由于idea工具自带了maven，所以可以直接在ide中执行mvn命令。在tools容器中，需要安装mvn命令 为tools镜像集成mvn：\n将本地的apache-maven-3.6.3放到tools项目中，修改settings.xml配置\n... /opt/maven-repo ... 然后修改Dockerfile，添加如下部分:\n#-----------------安装 maven--------------------#COPY apache-maven-3.6.3 /usr/lib/apache-maven-3.6.3RUN ln -s /usr/lib/apache-maven-3.6.3/bin/mvn /usr/local/bin/mvn \u0026\u0026 chmod +x /usr/local/bin/mvnENV MAVEN_HOME=/usr/lib/apache-maven-3.6.3#------------------------------------------------#  去master节点拉取最新代码，构建最新的tools镜像：\n # k8s-master节点  $ git pull  $ docker build . -t 172.21.51.67:5000/devops/tools:v4 -f Dockerfile  $ docker push 172.21.51.67:5000/devops/tools:v4 再次尝试mvn命令：\n$ docker run --rm -ti 172.21.51.67:5000/devops/tools:v4 bash  bash-5.0# mvn -v  bash-5.0# git clone http://gitlab.luffy.com/luffy-spring-cloud/springboot-demo.git  bash-5.0# cd springboot-demo  bash-5.0# mvn clean  # 观察/opt/maven目录  bash-5.0# mvn package  # 多阶段组合  bash-5.0# mvn clean package 想系统学习maven，可以参考： https://www.runoob.com/maven/maven-pom.html\nSpringboot服务镜像制作 通过mvn package命令拿到服务的jar包后，我们可以使用如下命令启动服务：\n$ java -jar demo-0.0.1-SNAPSHOT.jar 因此，需要准备Dockerfile来构建镜像：\nFROMopenjdk:8-jdk-alpineCOPY target/springboot-demo-0.0.1-SNAPSHOT.jar app.jarCMD [ \"sh\", \"-c\", \"java -jar /app.jar\" ]我们可以为构建出的镜像指定名称：\n   ${project.artifactId}  ... Dockerfile对应修改：\nFROMopenjdk:8-jdk-alpineCOPY target/springboot-demo.jar app.jarCMD [ \"sh\", \"-c\", \"java -jar /app.jar\" ]执行镜像构建，验证服务启动是否正常：\n$ docker build . -t springboot-demo:v1 -f Dockerfile  $ docker run -d --name springboot-demo -p 8080:8080 springboot-demo:v1  $ curl localhost:8080 接入CICD流程 之前已经实现了shared-library，并且把python项目接入到了CICD 流程中。因此，可以直接使用已有的流程，把spring boot项目接入进去。\n Jenkinsfile sonar-project.properties deploy/deployment.yaml deploy/service.yaml deploy/ingress.yaml configmap/devops-config  Jenkinsfile @Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/demo/springboot-demo\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  PROJECT = \"springboot-demo\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('mvn-package') {  steps {  container('tools') {  script{  sh 'mvn clean package'  }  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  }   stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",true,\"deploy/deployment.yaml\").start()  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(PROJECT,\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(PROJECT,\"dingTalk\")  }  }  } } sonar-project.properties sonar.projectKey=springboot-demo sonar.projectName=springboot-demo # if you want disabled the DTD verification for a proxy problem for example, true by default # JUnit like test report, default value is test.xml sonar.sources=src/main/java sonar.language=java sonar.tests=src/test/java sonar.java.binaries=target/classes deploy/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: springboot-demo  namespace: {{NAMESPACE}} spec:  replicas: 1  selector:  matchLabels:  app: springboot-demo  template:  metadata:  labels:  app: springboot-demo  spec:  containers:  - name: springboot-demo  image: {{IMAGE_URL}}  imagePullPolicy: IfNotPresent  ports:  - containerPort: 8080  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /  port: 8080  scheme: HTTP  initialDelaySeconds: 120  periodSeconds: 15  timeoutSeconds: 3  readinessProbe:  httpGet:  path: /  port: 8080  scheme: HTTP  initialDelaySeconds: 120  timeoutSeconds: 2  periodSeconds: 15 deploy/service.yaml apiVersion: v1 kind: Service metadata:  name: springboot-demo  namespace: {{NAMESPACE}} spec:  ports:  - port: 8080  protocol: TCP  targetPort: 8080  selector:  app: springboot-demo  sessionAffinity: None  type: ClusterIP status:  loadBalancer: {} deploy/ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: springboot-demo  namespace: {{NAMESPACE}} spec:  rules:  - host: {{INGRESS_SPRINGBOOTDEMO}}  http:  paths:  - backend:  serviceName: springboot-demo  servicePort: 8080  path: / status:  loadBalancer: {} 维护devops-config的configmap，添加INGRESS_SPRINGBOOTDEMO配置项：\n$ kubectl -n dev edit cm devops-config ... data:  INGRESS_MYBLOG: blog-dev.luffy.com  INGRESS_SPRINGBOOTDEMO: springboot-dev.luffy.com  NAMESPACE: dev ... 更新Jenkins中的jnlp-slave-pod模板镜像：\n172.21.51.67:5000/devops/tools:v4 由于镜像中maven的目录是/opt/maven-repo，而slave-pod是执行完任务后会销毁，因此需要将maven的数据目录挂载出来，不然每次构建都会重新拉取所有依赖的jar包：\n配置Jenkins流水线：\n添加单元测试覆盖率 单元测试这块内容一直没有把覆盖率统计到sonarqube端，本节看下怎么样将单元测试的结果及覆盖率展示到Jenkins及sonarqube平台中。\n为了展示效果，我们先添加一个单元测试文件HelloControllerTest：\npackage com.luffy.demo;  import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.Test; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.http.MediaType; import org.springframework.test.context.web.WebAppConfiguration; import org.springframework.test.web.servlet.MockMvc; import org.springframework.test.web.servlet.request.MockMvcRequestBuilders; import org.springframework.test.web.servlet.result.MockMvcResultHandlers; import org.springframework.test.web.servlet.result.MockMvcResultMatchers; import org.springframework.test.web.servlet.setup.MockMvcBuilders; import org.springframework.web.context.WebApplicationContext;  @SpringBootTest @WebAppConfiguration public class HelloControllerTests {   private static final Logger logger = LoggerFactory.getLogger(HelloControllerTests.class);  @Autowired  private WebApplicationContext webApplicationContext;   private MockMvc mockMvc;   @BeforeEach  public void setMockMvc() {  mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build();  }   @Test  public void index(){  try {  mockMvc.perform(MockMvcRequestBuilders.post(\"/\")  .contentType(MediaType.APPLICATION_JSON)  ).andExpect(MockMvcResultMatchers.status().isOk())  .andDo(MockMvcResultHandlers.print());  }catch (Exception e) {  e.printStackTrace();  }   }   @Test  public void rightaway(){  try {  mockMvc.perform(MockMvcRequestBuilders.post(\"/rightaway\")  .contentType(MediaType.APPLICATION_JSON)  ).andExpect(MockMvcResultMatchers.status().isOk())  .andDo(MockMvcResultHandlers.print());  }catch (Exception e) {  e.printStackTrace();  }   }   @Test  public void sleep(){  try {  mockMvc.perform(MockMvcRequestBuilders.post(\"/sleep\")  .contentType(MediaType.APPLICATION_JSON)  ).andExpect(MockMvcResultMatchers.status().isOk())  .andDo(MockMvcResultHandlers.print());  }catch (Exception e) {  e.printStackTrace();  }   } } jacoco：监控JVM中的调用，生成监控结果（默认保存在jacoco.exec文件中），然后分析此结果，配合源代码生成覆盖率报告。\n如何引入jacoco测试：\n   org.jacoco  jacoco-maven-plugin  0.7.8        prepare-agent      ${project.build.directory}/coverage-reports/jacoco.exec        default-report  test    report      ${project.build.directory}/coverage-reports/jacoco.exec  ${project.reporting.outputDirectory}/jacoco         其中：\n prepare-agent，会把agent准备好，这样在执行用例的时候，就会使用agent检测到代码执行的过程，通常将结果保存在jacoco.exec中 report，分析保存的jacoco.exec文件，生成报告  在IDE中添加，观察插件的goal，执行mvn test，观察执行过程。\n有了上述内容后，如何将结果发布到sonarqube中？\n提交最新代码，查看sonarqube的分析结果。\nSpring Cloud开发、交付实践 https://spring.io/projects/spring-cloud#overview\n1、Netflix是一家做视频的网站，可以这么说该网站上的美剧应该是最火的。\n2、Netflix是一家没有CTO的公司，正是这样的组织架构能使产品与技术无缝的沟通，从而能快速迭代出更优秀的产品。在当时软件敏捷开发中，Netflix的更新速度不亚于当年的微信后台变更，虽然微信比Netflix迟发展，但是当年微信的灰度发布和敏捷开发应该算是业界最猛的。\n3、Netflix由于做视频的原因，访问量非常的大，从而促使其技术快速的发展在背后支撑着，也正是如此，Netflix开始把整体的系统往微服务上迁移。\n4、Netflix的微服务做的不是最早的，但是确是最大规模的在生产级别微服务的尝试。也正是这种大规模的生产级别尝试，在服务器运维上依托AWS云。当然AWS云同样受益于Netflix的大规模业务不断的壮大。\n5、Netflix的微服务大规模的应用，在技术上毫无保留的把一整套微服务架构核心技术栈开源了出来，叫做Netflix OSS，也正是如此，在技术上依靠开源社区的力量不断的壮大。\n6、Spring Cloud是构建微服务的核心，而Spring Cloud是基于Spring Boot来开发的。\n7、Pivotal在Netflix开源的一整套核心技术产品线的同时，做了一系列的封装，就变成了Spring Cloud；虽然Spring Cloud到现在为止不只有Netflix提供的方案可以集成，还有很多方案，但Netflix是最成熟的。\n 本课程基于SpringBoot 2.3.6.RELEASE 和Spring Cloud Hoxton.SR9版本\n 微服务场景 开发APP，提供个人的花呗账单管理。\n 注册、登录、账单查询 用户服务，账单管理服务   Eureka服务注册中心 在SpringCloud体系中，我们知道服务之间的调用是通过http协议进行调用的。而注册中心的主要目的就是维护这些服务的服务列表。\nhttps://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/\n新建项目 pom中引入spring-cloud的依赖：\nhttps://spring.io/projects/spring-cloud#overview\n  Hoxton.SR9        org.springframework.cloud  spring-cloud-dependencies  ${spring.cloud-version}  pom  import      引入eureka-server的依赖：\n   org.springframework.cloud  spring-cloud-starter-netflix-eureka-server   启动eureka服务 https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/#spring-cloud-eureka-server-standalone-mode\napplication.yml\nserver: port: 8761 eureka: client: service-url: defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/ register-with-eureka: false fetch-registry: false instance: hostname: localhost 启动类：\npackage com.luffy.eureka;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;  @SpringBootApplication @EnableEurekaServer public class EurekaServerApplication {  public static void main(String[] args) {  SpringApplication.run(EurekaServerApplication.class, args);  } } 启动访问localhost:8761测试\n创建spring cloud项目三部曲：\n 引入依赖包 修改application.yml配置文件 启动类添加注解  eureka认证 没有认证，不安全，添加认证：\n   org.springframework.boot  spring-boot-starter-security   application.yml\nserver:  port: 8761 eureka:  client:  service-url:  defaultZone: http://${spring.security.user.name}:${spring.security.user.password}@${eureka.instance.hostname}:${server.port}/eureka/  register-with-eureka: false  fetch-registry: false  instance:  hostname: localhost spring:  security:  user:  name: ${EUREKA_USER:admin}  password: ${EUREKA_PASS:admin} 注册服务到eureka 新建项目，user-service（选择Spring Cloud依赖和SpringBoot Web依赖），用来提供用户查询功能。\n三部曲：\n pom.xml，并添加依赖 创建application.yml配置文件 创建Springboot启动类，并配置注解  pom.xml添加：\n   org.springframework.cloud  spring-cloud-starter-netflix-eureka-client      org.springframework.boot  spring-boot-starter-web   application.yml server:  port: 7000 eureka:  client:  serviceUrl:  defaultZone: http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@localhost:8761/eureka/ 启动类：\npackage com.luffy.user;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient;  //注意这里也可使用@EnableEurekaClient //但由于springcloud是灵活的，注册中心支持eureka、consul、zookeeper等 //若写了具体的注册中心注解，则当替换成其他注册中心时，又需要替换成对应的注解了。 //所以 直接使用@EnableDiscoveryClient 启动发现。 //这样在替换注册中心时，只需要替换相关依赖即可。 @EnableDiscoveryClient @SpringBootApplication public class UserServiceApplication {  public static void main(String[] args) {  SpringApplication.run(UserServiceApplication.class, args);  } } 报错：\nc.n.d.s.t.d.RetryableEurekaHttpClient : Request execution failed with message: com.fasterxml.jackson.databind.exc.MismatchedInputException: Root name 'timestamp' does not match expected ('instance') for type [simple type, class com.netflix.appinfo.InstanceInfo] 新版本的security默认开启csrf了，关掉，在注册中心新建一个类，继承WebSecurityConfigurerAdapter来关闭 , 注意，是在eureka server端关闭。\npackage com.luffy.eureka;  import org.springframework.context.annotation.Configuration; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;  @EnableWebSecurity @Configuration public class WebSecurityConfig extends WebSecurityConfigurerAdapter {   @Override  protected void configure(HttpSecurity http) throws Exception {  http.csrf().disable(); //关闭csrf  http.authorizeRequests().anyRequest().authenticated().and().httpBasic(); //开启认证  } } 再次启动发现可以注册，但是地址是\napplication.yaml\nserver:  port: 7000 eureka:  client:  serviceUrl:  defaultZone: http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@localhost:8761/eureka/  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: user-service spring:  application:  name: user-service Eurake有一个配置参数eureka.server.renewalPercentThreshold，定义了renews 和renews threshold的比值，默认值为0.85。当server在15分钟内，比值低于percent，即少了15%的微服务心跳，server会进入自我保护状态\n默认情况下，如果Eureka Server在一定时间内没有接收到某个微服务实例的心跳，Eureka Server将会注销该实例（默认90秒）。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，这就可能变得非常危险了，因为微服务本身是健康的，此时本不应该注销这个微服务。\nEureka Server通过“自我保护模式”来解决这个问题，当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式。\n自我保护模式是一种对网络异常的安全保护措施。使用自我保护模式，而让Eureka集群更加的健壮、稳定。\n开发阶段可以通过配置：eureka.server.enable-self-preservation=false关闭自我保护模式。\n生产阶段，理应以默认值进行配置。\n至于具体具体的配置参数，可至官网查看：http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html#_appendix_compendium_of_configuration_properties\n高可用 高可用：\n 优先保证可用性 各个节点都是平等的，1个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务 在向某个Eureka注册时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用(保证可用性)  注意点：\n  多实例的话eureka.instance.instance-id需要保持不一样，否则会当成同一个\n  eureka.instance.hostname要与defaultZone里的地址保持一致\n  各个eureka的spring.application.name相同\n  拷贝eureka服务，分别命名eureka-ha-peer1和eureka-ha-peer2\n修改模块的pom.xml\neureka-ha-peer1 修改配置文件application.yml，注意集群服务，需要各个eureka的spring.application.name相同\nserver:  port: ${EUREKA_PORT:8762} eureka:  client:  service-url:  defaultZone: ${EUREKA_SERVER:http://${spring.security.user.name}:${spring.security.user.password}@peer1:8762/eureka/,http://${spring.security.user.name}:${spring.security.user.password}@peer2:8763/eureka/}  fetch-registry: true  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  hostname: peer1 spring:  security:  user:  name: ${EUREKA_USER:admin}  password: ${EUREKA_PASS:admin}  application:  name: eureka-cluster 设置hosts文件\n127.0.0.1 peer1 peer2 服务提供者若想连接高可用的eureka，需要修改：\n defaultZone: http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@peer1:8762/eureka/,http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@peer2:8763/eureka/ k8s交付 分析：\n高可用互相注册，但是需要知道对方节点的地址。k8s中pod ip是不固定的，如何将高可用的eureka服务使用k8s交付？\n  方案一：创建三个Deployment+三个Service\n  方案二：使用statefulset管理\n  eureka-statefulset.yaml # eureka-statefulset.yaml apiVersion: apps/v1 kind: StatefulSet metadata:  name: eureka-cluster  namespace: dev spec:  serviceName: \"eureka\"  replicas: 3  selector:  matchLabels:  app: eureka-cluster  template:  metadata:  labels:  app: eureka-cluster  spec:  containers:  - name: eureka  image: 172.21.51.67:5000/spring-cloud/eureka-cluster:v1  ports:  - containerPort: 8761  resources:  requests:  memory: 400Mi  cpu: 50m  limits:  memory: 2Gi  cpu: 2000m  env:  - name: MY_POD_NAME  valueFrom:  fieldRef:  fieldPath: metadata.name  - name: JAVA_OPTS  value: -XX:+UnlockExperimentalVMOptions  -XX:+UseCGroupMemoryLimitForHeap  -XX:MaxRAMFraction=2  -XX:CICompilerCount=8  -XX:ActiveProcessorCount=8  -XX:+UseG1GC  -XX:+AggressiveOpts  -XX:+UseFastAccessorMethods  -XX:+UseStringDeduplication  -XX:+UseCompressedOops  -XX:+OptimizeStringConcat  - name: EUREKA_SERVER  value: \"http://admin:admin@eureka-cluster-0.eureka:8761/eureka/,http://admin:admin@eureka-cluster-1.eureka:8761/eureka/,http://admin:admin@eureka-cluster-2.eureka:8761/eureka/\"  - name: EUREKA_INSTANCE_HOSTNAME  value: ${MY_POD_NAME}.eureka  - name: EUREKA_PORT  value: \"8761\" eureka-headless-service.yaml apiVersion: v1 kind: Service metadata:  name: eureka  namespace: dev  labels:  app: eureka spec:  ports:  - port: 8761  name: eureka  clusterIP: None  selector:  app: eureka-cluster 想通过ingress访问eureka，需要使用有头服务\napiVersion: v1 kind: Service metadata:  name: eureka-ingress  namespace: dev  labels:  app: eureka-cluster spec:  ports:  - port: 8761  name: eureka-cluster  selector:  app: eureka-cluster --- apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: eureka-cluster  namespace: dev spec:  rules:  - host: eureka-cluster.luffy.com  http:  paths:  - backend:  serviceName: eureka-ingress  servicePort: 8761  path: / status:  loadBalancer: {} 使用StatefulSet管理有状态服务 使用StatefulSet创建多副本pod的情况：\napiVersion: apps/v1 kind: StatefulSet metadata:  name: nginx-statefulset  labels:  app: nginx-sts spec:  replicas: 3  serviceName: \"nginx\"  selector:  matchLabels:  app: nginx-sts  template:  metadata:  labels:  app: nginx-sts  spec:  containers:  - name: nginx  image: nginx:alpine  ports:  - containerPort: 80 无头服务Headless Service\nkind: Service apiVersion: v1 metadata:  name: nginx spec:  selector:  app: nginx-sts  ports:  - protocol: TCP  port: 80  targetPort: 80  clusterIP: None $ kubectl -n spring exec -ti nginx-statefulset-0 sh / # curl nginx-statefulset-2.nginx 接入CICD流程 所需的文件:\n   在pom.xml中重写jar包名称：\n${project.artifactId} Dockerfile FROM openjdk:8-jdk-alpine ADD target/eureka.jar app.jar ENV JAVA_OPTS=\"\" CMD [ \"sh\", \"-c\", \"java $JAVA_OPTS -jar /app.jar\" ] Jenkinsfile @Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/spring-cloud/eureka-cluster\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  PROJECT = \"eureka-cluster\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('mvn-package') {  steps {  container('tools') {  script{  sh 'mvn clean package'  }  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  }   stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",false,\"deploy/statefulset.yaml\").start()  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(PROJECT,\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(PROJECT,\"dingTalk\")  }  }  } } sonar-project.properties sonar.projectKey=eureka-cluster sonar.projectName=eureka-cluster # if you want disabled the DTD verification for a proxy problem for example, true by default # JUnit like test report, default value is test.xml sonar.sources=src/main/java sonar.language=java sonar.tests=src/test/java sonar.java.binaries=target/classes 模板化k8s资源清单：\n# eureka-statefulset.yaml apiVersion: apps/v1 kind: StatefulSet metadata:  name: eureka-cluster  namespace: {{NAMESPACE}} spec:  serviceName: \"eureka\"  replicas: 3  selector:  matchLabels:  app: eureka-cluster  template:  metadata:  labels:  app: eureka-cluster  spec:  containers:  - name: eureka  image: {{IMAGE_URL}} ... 维护新组件的ingress:\n$ kubectl -n dev edit configmap devops-config ...  INGRESS_EUREKA: eureka.luffy.com ... 部署k8s集群时，将eureka的集群地址通过参数的形式传递到pod内部，因此本地开发时，直接按照单点模式进行：\nserver:  port: ${EUREKA_PORT:8761} eureka:  client:  service-url:  defaultZone: ${EUREKA_SERVER:http://${spring.security.user.name}:${spring.security.user.password}@localhost:8761/eureka/}  fetch-registry: true  register-with-eureka: true  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  hostname: ${EUREKA_INSTANCE_HOSTNAME:localhost}  prefer-ip-address: true spring:  security:  user:  name: ${EUREKA_USER:admin}  password: ${EUREKA_PASS:admin}  application:  name: eureka-cluster 提交项目：\n创建develop分支，CICD部署开发环境\n 停掉eureka-ha\n 微服务间调用 服务提供者 前面已经将用户服务注册到了eureka注册中心，但是还没有暴漏任何API给服务消费者调用。\n新建controller类：\npackage com.luffy.userservice.controller;   import com.luffy.userservice.entity.User; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.RestController;  import java.util.Random;  @RestController public class UserController {   @GetMapping(\"/user\")  public String getUserService(){  return \"this is user-service\";  }   @GetMapping(\"/user-nums\")  public Integer getUserNums(){  return new Random().nextInt(100);  }   //{\"id\": 123, \"name\": \"张三\", \"age\": 20, \"sex\": \"male\"}  @GetMapping(\"/user/{id}\")  public User getUserInfo(@PathVariable(\"id\") int id){  User user = new User();  user.setId(id);  user.setAge(20);  user.setName(\"zhangsan\");  user.setSex(\"male\");  return user;  } } 实体类User.java\npackage com.luffy.userservice.entity;  public class User {  private int id;  private String name;  private int age;  private String sex;   public int getAge() {  return age;  }   public int getId() {  return id;  }   public String getName() {  return name;  }   public String getSex() {  return sex;  }   public void setAge(int age) {  this.age = age;  }   public void setId(int id) {  this.id = id;  }   public void setName(String name) {  this.name = name;  }   public void setSex(String sex) {  this.sex = sex;  } } application.yml 增加从环境变量中读取EUREKA_SERVER和EUREKA_INSTANCE_HOSTNAME配置\nserver:  port: 7000 eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:user-service} spring:  application:  name: user-service CICD持续交付服务提供者 deployment.yaml apiVersion: apps/v1 kind: Deployment metadata:  name: user-service  namespace: {{NAMESPACE}} spec:  replicas: 1  selector:  matchLabels:  app: user-service  template:  metadata:  labels:  app: user-service  spec:  containers:  - name: user-service  image: {{IMAGE_URL}}  imagePullPolicy: IfNotPresent  ports:  - containerPort: 7000  resources:  requests:  memory: 400Mi  cpu: 50m  limits:  memory: 2Gi  cpu: 2000m  env:  - name: JAVA_OPTS  value: -XX:+UnlockExperimentalVMOptions  -XX:+UseCGroupMemoryLimitForHeap  -XX:MaxRAMFraction=2  -XX:CICompilerCount=8  -XX:ActiveProcessorCount=8  -XX:+UseG1GC  -XX:+AggressiveOpts  -XX:+UseFastAccessorMethods  -XX:+UseStringDeduplication  -XX:+UseCompressedOops  -XX:+OptimizeStringConcat  - name: EUREKA_SERVER  value: \"http://admin:admin@eureka-cluster-0.eureka:8761/eureka/,http://admin:admin@eureka-cluster-1.eureka:8761/eureka/,http://admin:admin@eureka-cluster-2.eureka:8761/eureka/\"  - name: INSTANCE_HOSTNAME  valueFrom:  fieldRef:  fieldPath: metadata.name service.yaml apiVersion: v1 kind: Service metadata:  name: user-service  namespace: {{NAMESPACE}} spec:  ports:  - port: 7000  protocol: TCP  targetPort: 7000  selector:  app: user-service  sessionAffinity: None  type: ClusterIP status:  loadBalancer: {} ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: user-service  namespace: {{NAMESPACE}} spec:  rules:  - host: {{INGRESS_USER_SERVICE}}  http:  paths:  - backend:  serviceName: user-service  servicePort: 7000  path: / status:  loadBalancer: {} ingress配置：\n$ kubectl -n dev edit configmap devops-config ... data:  INGRESS_MYBLOG: blog-dev.luffy.com  INGRESS_SPRINGBOOTDEMO: springboot-dev.luffy.com  INGRESS_USER_SERVICE: user-service-dev.luffy.com  NAMESPACE: dev ... Jenkinsfile @Library('luffy-devops') _  pipeline {  agent { label 'jnlp-slave'}  options { \ttimeout(time: 20, unit: 'MINUTES') \tgitLabConnection('gitlab') \t}  environment {  IMAGE_REPO = \"172.21.51.67:5000/spring-cloud/user-service\"  IMAGE_CREDENTIAL = \"credential-registry\"  DINGTALK_CREDS = credentials('dingTalk')  PROJECT = \"user-service\"  }  stages {  stage('checkout') {  steps {  container('tools') {  checkout scm  }  }  }  stage('mvn-package') {  steps {  container('tools') {  script{  sh 'mvn clean package'  }  }  }  }  stage('CI'){  failFast true  parallel {  stage('Unit Test') {  steps {  echo \"Unit Test Stage Skip...\"  }  }  stage('Code Scan') {  steps {  container('tools') {  script {  devops.scan().start()  }  }  }  }  }  }   stage('docker-image') {  steps {  container('tools') {  script{  devops.docker(  \"${IMAGE_REPO}\",  \"${GIT_COMMIT}\",  IMAGE_CREDENTIAL  ).build().push()  }  }  }  }  stage('deploy') {  steps {  container('tools') {  script{  devops.deploy(\"deploy\",true,\"deploy/deployment.yaml\").start()  }  }  }  }  }  post {  success {  script{  devops.notificationSuccess(PROJECT,\"dingTalk\")  }  }  failure {  script{  devops.notificationFailure(PROJECT,\"dingTalk\")  }  }  } } pom.xml ${project.artifactId} Dockerfile FROM openjdk:8-jdk-alpine COPY target/user-service.jar app.jar ENV JAVA_OPTS=\"\" CMD [ \"sh\", \"-c\", \"java $JAVA_OPTS-jar /app.jar\" ] sonar-project.properties sonar.projectKey=user-service sonar.projectName=user-service # if you want disabled the DTD verification for a proxy problem for example, true by default # JUnit like test report, default value is test.xml sonar.sources=src/main/java sonar.language=java sonar.tests=src/test/java sonar.java.binaries=target/classes 创建user-service项目，提交代码：\ngit init git remote add origin http://gitlab.luffy.com/luffy-spring-cloud/user-service.git git add . git commit -m \"Initial commit\" git push -u origin master  # 提交到develop分支 git checkout -b develop git push -u origin develop 创建Jenkins任务，测试自动部署\n访问http://user-service-dev.luffy.com/ 验证\n服务消费者 RestTemplate 在Spring中，提供了RestTemplate。RestTemplate是Spring提供的用于访问Rest服务的客户端。而在SpringCloud中也是使用此服务进行服务调用的。\n创建bill-service模块 新的模块初始化三部曲：\n pom.xml 启动类 配置文件  pom.xml 添加如下内容:\n   org.springframework.cloud  spring-cloud-starter-netflix-eureka-client   全量内容如下:\n  xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"  4.0.0    org.springframework.boot  spring-boot-starter-parent  2.3.6.RELEASE       com.luffy  bill-service  0.0.1-SNAPSHOT  bill-service  bill-service     1.8  Hoxton.SR9         org.springframework.cloud  spring-cloud-starter      org.springframework.cloud  spring-cloud-starter-netflix-eureka-client      org.springframework.boot  spring-boot-starter-web      org.springframework.boot  spring-boot-starter-actuator      org.springframework.boot  spring-boot-starter-test  test      org.junit.vintage  junit-vintage-engine                 org.springframework.cloud  spring-cloud-dependencies  ${spring-cloud.version}  pom  import           ${project.artifactId}      org.springframework.boot  spring-boot-maven-plugin         BillServiceApplication package com.luffy.billservice;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient;  @SpringBootApplication @EnableDiscoveryClient public class BillServiceApplication {  public static void main(String[] args) {  SpringApplication.run(BillService.class, args);  } } application.yml\nserver:  port: 7001 eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:bill-service} spring:  application:  name: bill-service BillController\npackage com.luffy.billservice.controller;  import org.springframework.beans.factory.annotation.Autowired; import org.springframework.context.annotation.Bean; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.client.RestTemplate;  @RestController public class BillController {   @Bean  public RestTemplate restTemplate() {  return new RestTemplate();  }   @Autowired  private RestTemplate restTemplate;   @GetMapping(\"/bill/user\")  public String getUserInfo(){  return restTemplate.getForObject(\"http://localhost:7000/user\", String.class);  } } 问题：\n 服务调用采用指定IP+Port方式，注册中心未使用 多个服务负载均衡  使用注册中心实现服务调用 修改BillController\npackage com.luffy.billservice.controller;  import org.springframework.beans.factory.annotation.Autowired; import org.springframework.cloud.client.loadbalancer.LoadBalanced; import org.springframework.context.annotation.Bean; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.client.RestTemplate;  @RestController public class BillController {   @Bean  @LoadBalanced  public RestTemplate restTemplate() {  return new RestTemplate();  }   @Autowired  private RestTemplate restTemplate;   @GetMapping(\"/bill/user\")  public String getUserInfo(){  return restTemplate.getForObject(\"http://user-service/user\", String.class);  } } 访问测试\n总体来说，就是通过为加入@LoadBalanced注解的RestTemplate添加一个请求拦截器，在请求前通过拦截器获取真正的请求地址，最后进行服务调用。\n友情提醒：若被@LoadBalanced注解的RestTemplate访问正常的服务地址，如http://127.0.0.1:8080/hello时，是会提示无法找到此服务的。\n具体原因：serverid必须是我们访问的服务名称 ，当我们直接输入ip的时候获取的server是null，就会抛出异常。\n如果想继续调用，可以通过如下方式：\npackage com.luffy.billservice.controller;  import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.cloud.client.loadbalancer.LoadBalanced; import org.springframework.context.annotation.Bean; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.client.RestTemplate;  @RestController public class BillController {   @Bean  @LoadBalanced  public RestTemplate restTemplate() {  return new RestTemplate();  }   @Autowired  private RestTemplate restTemplate;   @Bean(\"normalRestTemplate\")  public RestTemplate normalRestTemplate() {  return new RestTemplate();  }   @Autowired  @Qualifier(\"normalRestTemplate\")  RestTemplate normalRestTemplate;    @GetMapping(\"/service/user\")  public String getUserInfo(){  return restTemplate.getForObject(\"http://user-service/user\", String.class);  }   @GetMapping(\"/normal\")  public String normal() {  return normalRestTemplate.getForObject(\"http://localhost:7000/user\", String.class);  } } Ribbon 负载均衡 再启动一个user-service-instance2，复制user-service项目\n修改user-service-instance2的application.yml的server.port\nserver:  port: 7002 eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@peer1:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:user-service} spring:  application:  name: user-service 修改user-service-instance2的UserController.java，为了可以区分是哪个服务提供者的实例提供的服务\npackage com.luffy.userservice.controller;   import com.luffy.userservice.entity.User; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.RestController;  import java.util.Random;  @RestController public class UserController {   @GetMapping(\"/user\")  public String getUserService(){  return \"this is user-service-instance2\";  }   @GetMapping(\"/user-nums\")  public Integer getUserNums(){  return new Random().nextInt(100);  }   //{\"id\": 123, \"name\": \"张三\", \"age\": 20, \"sex\": \"male\"}  @GetMapping(\"/user/{id}\")  public User getUserInfo(@PathVariable(\"id\") int id){  User user = new User();  user.setId(id);  user.setAge(20);  user.setName(\"zhangsan\");  user.setSex(\"male\");  return user;  } } 访问bill-service，查看调用结果（默认是轮询策略）\nSpring Cloud Ribbon是一个基于Http和TCP的客服端负载均衡工具，它是基于Netflix Ribbon实现的。与Eureka配合使用时，Ribbon可自动从Eureka Server (注册中心)获取服务提供者地址列表，并基于负载均衡算法，通过在客户端中配置ribbonServerList来设置服务端列表去轮询访问以达到均衡负载的作用。\n eureka-client中包含了ribbon的包，所以不需要单独引入\n 如何修改调用策略？\n 代码中指定rule的规则 配置文件配置  在bill-service中新建package，com.luffy.rule，注意不能被springboot扫描到，不然规则就成了全局规则，所有的ribbonclient都会应用到该规则。\npackage com.luffy.rule;  import com.netflix.loadbalancer.*; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration;  @Configuration public class RandomConfiguration {   @Bean  public IRule ribbonRule() {  // new BestAvailableRule();  // new WeightedResponseTimeRule();  return new RandomRule();  } } 修改BillController\nimport com.luffy.rule.RandomConfiguration; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.cloud.netflix.ribbon.RibbonClient;  @SpringBootApplication @EnableDiscoveryClient @RibbonClient(name = \"user-service\", configuration = RandomConfiguration.class) public class BillServiceApplication {  public static void main(String[] args) {  SpringApplication.run(BillServiceApplication.class, args);  } } 配置文件方式： https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/#customizing-the-ribbon-client-by-setting-properties\n注释掉代码：\npackage com.luffy.ticket;  import com.luffy.rule.RandomConfiguration; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.cloud.netflix.ribbon.RibbonClient;  @SpringBootApplication @EnableDiscoveryClient //@RibbonClient(name = \"USER-SERVICE\", configuration = RandomConfiguration.class) public class TicketApplication {  public static void main(String[] args) {  SpringApplication.run(TicketApplication.class, args);  } } 修改配置文件：\nserver:  port: ${SERVER_PORT:9000}  spring:  application:  name: bill-service  eureka:  client:  service-url:  defaultZone: ${EUREKA_SERVER:http://admin:admin@peer1:8762/eureka/,http://admin:admin@peer2:8763/eureka/}  instance:  prefer-ip-address: true  instance-id: ${spring.cloud.client.ip-address}:${server.port} user-service:  ribbon:  NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule 声明式服务Feign 从上一章节，我们知道，当我们要调用一个服务时，需要知道服务名和api地址，这样才能进行服务调用，服务少时，这样写觉得没有什么问题，但当服务一多，接口参数很多时，上面的写法就显得不够优雅了。所以，接下来，来说说一种更好更优雅的调用服务的方式：Feign。\n Feign是Netflix开发的声明式、模块化的HTTP客户端。Feign可帮助我们更好更快的便捷、优雅地调用HTTP API。\n 在Spring Cloud中，使用Feign非常简单——创建一个接口，并在接口上添加一些注解。Feign支持多种注释，例如Feign自带的注解或者JAX-RS注解等 Spring Cloud对Feign进行了增强，使Feign支持了Spring MVC注解，并整合了Ribbon和 Eureka,从而让Feign 的使用更加方便。只需要通过创建接口并用注解来配置它既可完成对Web服务接口的绑定。\nhttps://github.com/OpenFeign/feign\n对bill-service项目添加openfeign的依赖引入：\n   org.springframework.cloud  spring-cloud-starter-openfeign   启动类中引入Feign注解：\npackage com.luffy.billservice;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.cloud.openfeign.EnableFeignClients;  @SpringBootApplication @EnableDiscoveryClient @EnableFeignClients public class BillServiceApplication {   public static void main(String[] args) {  SpringApplication.run(BillServiceApplication.class, args);  }  } 建立interface\npackage com.luffy.billservice.interfaces;  import com.luffy.billservice.entity.User; import org.springframework.cloud.openfeign.FeignClient; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable;  @FeignClient(name=\"user-service\") public interface UserServiceCli {   @GetMapping(\"/user\")  public String getUserService();   @GetMapping(\"/user/{id}\")  public User getUserInfo(@PathVariable(\"id\") int id); } 拷贝User类到当前项目：\npackage com.luffy.billservice.entity;  public class User {  private int id;  private String name;  private int age;  private String sex;   public int getAge() {  return age;  }   public int getId() {  return id;  }   public String getName() {  return name;  }   public String getSex() {  return sex;  }   public void setAge(int age) {  this.age = age;  }   public void setId(int id) {  this.id = id;  }   public void setName(String name) {  this.name = name;  }   public void setSex(String sex) {  this.sex = sex;  } } 修改BillController\npackage com.luffy.billservice.controller;  import com.luffy.billservice.entity.User; import com.luffy.billservice.interfaces.UserServiceCli; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.RestController;  @RestController public class BillController {   @Autowired  private UserServiceCli userServiceCli;    @GetMapping(\"/bill/user\")  public String getUserInfo(){  return userServiceCli.getUserService();  }   @GetMapping(\"/bill/user/{id}\")  public User getUserInfo(@PathVariable(\"id\") int id){  return userServiceCli.getUserInfo(id);  //return restTemplate.getForObject(\"http://USER-SERVICE/user/\" + id, String.class);  } } CICD持续交付服务消费者 拷贝user-service的交付文件，替换如下：\n user-service - bill-service 7000 - 7001 INGRESS_USER_SERVICE - INGRESS_BILL_SERVICE  $ kubectl -n dev edit configmap devops-config ... data:  INGRESS_MYBLOG: blog-dev.luffy.com  INGRESS_SPRINGBOOTDEMO: springboot-dev.luffy.com  INGRESS_USER_SERVICE: user-service-dev.luffy.com  INGRESS_BILL_SERVICE: user-service-dev.luffy.com  NAMESPACE: dev ... 创建develop分支，提交代码到gitlab仓库，验证持续交付\n前面主要讲解了下服务消费者如何利用原生、ribbon、fegin三种方式进行服务调用的，其实每种调用方式都是使用restTemplate来进行调用的，只是有些进行了增强，目的是使用起来更简单高效。\nHystrix 断路器 为什么需要断路器？\nA作为服务提供者，B为A的服务消费者，C和D是B的服务消费者。A不可用引起了B的不可用，并将不可用像滚雪球一样放大到C和D时，雪崩效应就形成了。\n因此，需要实现一种机制，可以做到自动监控服务状态并根据调用情况进行自动处理。\n  记录时间周期内服务调用失败次数\n  维护断路器的打开、关闭、半开三种状态\n  提供fallback机制\n  修改bill-service项目：\npom.xml\n   org.springframework.cloud  spring-cloud-starter-netflix-hystrix   application.xml\nfeign:  hystrix:  enabled: true 启动类添加注解@EnableCircuitBreaker\npackage com.luffy.billservice;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.cloud.openfeign.EnableFeignClients;  @SpringBootApplication @EnableDiscoveryClient @EnableFeignClients @EnableCircuitBreaker public class BillServiceApplication {   public static void main(String[] args) {  SpringApplication.run(BillServiceApplication.class, args);  }  } UserServiceCli.java package com.luffy.bill.interfaces;  import com.luffy.bill.entity.User; import org.springframework.cloud.openfeign.FeignClient; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable;  @FeignClient(name=\"user-service\", fallback = UserServiceFallbackImpl.class) public interface UserServiceCli {   @GetMapping(\"/user\")  public String getUserService();   @GetMapping(\"/user/{id}\")  public User getUserInfo(@PathVariable(\"id\") int id); } UserServiceFallbackImpl.java package com.luffy.billservice.interfaces;  import com.luffy.billservice.entity.User; import org.springframework.stereotype.Component;  @Component(\"fallback\") public class UserServiceFallbackImpl implements UserServiceCli{   @Override  public String getUserService() {  return \"fallback user service\";  }   @Override  public User getUserInfo(int id) {  User user = new User();  user.setId(1);  user.setName(\"feign-fallback\");  return user;  } } 停止user-service测试熔断及fallback。\nHystrix Dashboard 前面一章，我们讲解了如何整合Hystrix。而在实际情况下，使用了Hystrix的同时,还会对其进行实时的数据监控，反馈各类指标数据。今天我们就将讲解下Hystrix Dashboard和Turbine.其中Hystrix Dashboard是一款针对Hystrix进行实时监控的工具，通过Hystrix Dashboard我们可以在直观地看到各Hystrix Command的请求响应时间, 请求成功率等数据,监控单个实例内的指标情况。后者Turbine，能够将多个实例指标数据进行聚合的工具。\n在eureka注册中心处访问bill-service的服务actuator地址: http://192.168.136.1:7001/actuator/info\n若访问不了,需要添加如下内容:\n  为服务消费者bill-service的pom.xml添加依赖:\n   org.springframework.boot  spring-boot-starter-actuator     修改application.yml配置:\nmanagement:  endpoints:  web:  exposure:  include: \"*\"   访问http://localhost:9000/actuator/hystrix.stream 即可访问到断路器的执行状态，但是显示不太友好，因此需要dashboard。\n新建项目，hystrix-dashboard\n Hystrix-dashboard(仪表盘)是一款针对Hystrix进行实时监控的工具，通过Hystrix Dashboard我们可以在直观地看到各Hystrix Command的请求响应时间, 请求成功率等数据。\n pom.xml引入依赖包：\n  xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"  4.0.0    org.springframework.boot  spring-boot-starter-parent  2.3.6.RELEASE       com.luffy  hystrix-dashboard  0.0.1-SNAPSHOT  hystrix-dashboard  hystrxi dashboard     1.8  Hoxton.SR9         org.springframework.cloud  spring-cloud-starter-netflix-hystrix-dashboard       org.springframework.boot  spring-boot-starter       org.springframework.boot  spring-boot-starter-test  test      org.junit.vintage  junit-vintage-engine                 org.springframework.cloud  spring-cloud-dependencies  ${spring.cloud-version}  pom  import               org.springframework.boot  spring-boot-maven-plugin         启动类加上@EnableHystrixDashboard注解：\npackage com.luffy.hystrixdashboard;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard;  @SpringBootApplication @EnableHystrixDashboard public class HystrixDashboardApplication {   public static void main(String[] args) {  SpringApplication.run(HystrixDashboardApplication.class, args);  }  } application.yml\n#应用名称 server:  port: 9696  spring:  application:  name: hystrix-dashboard hystrix:  dashboard:  proxy-stream-allow-list: \"*\" 访问localhost:9696/hystrix\n  实心圆：它有颜色和大小之分，分别代表实例的监控程度和流量大小。如上图所示，它的健康度从绿色、黄色、橙色、红色递减。通过该实心圆的展示，我们就可以在大量的实例中快速的发现故障实例和高压力实例。\n  曲线：用来记录 2 分钟内流量的相对变化，我们可以通过它来观察到流量的上升和下降趋势。\n  其他一些数量指标如下图所示\n   提交代码到gitlab仓库\n Turbine hystrix只能实现单个微服务的监控，可是一般项目中是微服务是以集群的形式搭建，一个一个的监控不现实。而Turbine的原理是，建立一个turbine服务，并注册到eureka中，并发现eureka上的hystrix服务。通过配置turbine会自动收集所需hystrix的监控信息，最后通过dashboard展现，以达到集群监控的效果。\n简单来说，就是通过注册到注册中心，发现其他服务的hystrix服务，然后进行聚合数据，最后通过自身的端点输出到仪表盘上进行个性化展示。这我们就监控一个turbine应用即可，当有新增的应用加入时，我们只需要配置下turbine参数即可。\n微服务网关 为什么需要网关 在微服务框架中，每个对外服务都是独立部署的，对外的api或者服务地址都不是不尽相同的。对于内部而言，很简单，通过注册中心自动感知即可。但我们大部分情况下，服务都是提供给外部系统进行调用的，不可能同享一个注册中心。同时一般上内部的微服务都是在内网的，和外界是不连通的。而且，就算我们每个微服务对外开放，对于调用者而言，调用不同的服务的地址或者参数也是不尽相同的，这样就会造成消费者客户端的复杂性，同时想想，可能微服务可能是不同的技术栈实现的，有的是http、rpc或者websocket等等，也会进一步加大客户端的调用难度。所以，一般上都有会有个api网关，根据请求的url不同，路由到不同的服务上去，同时入口统一了，还能进行统一的身份鉴权、日志记录、分流等操作。\n网关的功能   减少api请求次数\n  限流\n  缓存\n  统一认证\n  降低微服务的复杂度\n  支持混合通信协议(前端只和api通信，其他的由网关调用)\n  …\n  Zuul实践 新建模块，gateway-zuul,(spring cloud)\npom.xml中需要引入zuul和eureka服务发现的依赖\n   org.springframework.cloud  spring-cloud-starter-netflix-zuul      org.springframework.cloud  spring-cloud-starter-netflix-eureka-client   启动类添加注解\npackage com.luffy.gateway;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.cloud.netflix.zuul.EnableZuulProxy;  @SpringBootApplication @EnableZuulProxy @EnableDiscoveryClient public class ZuulGatewayApplication {  public static void main(String[] args) {  SpringApplication.run(ZuulGatewayApplication.class, args);  } } 配置文件：\nserver:  port: 10000  spring:  application:  name: gateway-zuul  eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:gateway-zuul} 启动后，访问：\nhttp://localhost:10000/bill-service/bill/user/1\nhttp://localhost:10000/user-service/user\n通过如下方式，配置短路径：\nzuul:  routes:  user-service: /users/**  bill-service:  path: /bill/**  service-id: bill-service http://localhost:10000/users/user/1  --- http://localhost:7000/user/2 http://localhost:10000/user-service/user/1    http://localhost:10000/bill/service/user/2   ---http://localhost:7001/service/user/2 http://localhost:10000/bill-service/service/user/2 zuul如何指定对外暴漏api的path，如：\n所有的api都是这样：http://zuul-host:zuul-port/apis/，可以添加zuul.prefix：/apis\n配置一下配置文件\nmanagement:  endpoints:  web:  exposure:  include: \"*\" 可以访问到zuul的route列表， http://localhost:10000/actuator/routes/ ，添加details可以访问到详细信息\n{ \"/apis/users/**\": \"user-service\", \"/apis/bill/**\": \"bill-service\", \"/apis/bill-service/**\": \"bill-service\", \"/apis/user-service/**\": \"user-service\" }  提交代码到代码仓库\n 集中配置中心 Spring Cloud Config 配置中心提供了一个中心化的外部配置，默认使用git存储配置信息，这样就可以对配置信息进行版本管理。\n实践  创建代码仓库configure-repo，用于集中存储配置文件 创建项目config-server，用于接受各项目的连接，提供配置文件读取服务 修改user-service服务，验证通过config-server读取集中配置库中的配置文件  代码仓库：\n  新建gitlab项目，http://gitlab.luffy.com/luffy-spring-cloud/configure-repo.git\n  准备配置文件\nconfigs/common-dev.yml\ndatasource:  url: jdbc:mysql://mysql-dev:3306/  driverClassName: com.mysql.jdbc.Driver  username: xxx  password: xxxxxx luffy: city configs/user-service-dev.yml\nlogging:  level:  org.springframework.cloud: debug env: dev configs/common-test.yml\nenv: test   提交代码到master分支\n  新建项目，config-server\n修改pom.xml（springboot和springcloud的版本）\n  springboot 版本\n2.3.6.RELEASE   spring-cloud 版本\n   1.8  Hoxton.SR9     添加config-server 的依赖\n   org.springframework.cloud  spring-cloud-config-server     修改application.yml\nserver:  port: 8088  spring:  application:  name: config-server  profiles:  active: git  cloud:  config:  server:  git:  uri: http://gitlab.luffy.com/luffy-spring-cloud/configure-repo.git  username: ${GIT_USER:root}  password: ${GIT_PSW:1qaz2wsx}  default-label: master  search-paths: configs  #native:  # searchLocations: classpath:/configs/{profile} 修改启动类，添加注解\npackage com.luffy.configserver;  import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.config.server.EnableConfigServer;  @SpringBootApplication @EnableConfigServer public class ConfigServerApplication {   public static void main(String[] args) {  SpringApplication.run(ConfigServerApplication.class, args);  }  } 启动config-server,访问:\nhttp://localhost:8088/common/dev http://localhost:8088/user-service/dev 修改user-service服务，从config-server读取配置\n  添加使用统一配置中心的依赖：\n   org.springframework.cloud  spring-cloud-starter-config     新建bootstrap.yml，不能放在application.yml中，因为bootstrap的加载早于应用程序bean启动的加载，因此，删掉application.yml，直接使用bootstrap.yml\nserver:  port: 7000   eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:user-service} spring:  application:  name: user-service  cloud:  config:  uri: http://localhost:8088  profile: dev  #当前读取dev环境的配置  name: user-service, common  # 从user-service-dev.yml,common-dev.yml中读取   新建ValueController.java\npackage com.luffy.userservice.controller;  import org.springframework.beans.factory.annotation.Value; import org.springframework.cloud.context.config.annotation.RefreshScope; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RestController;  @RestController public class ValueController {   @Value(\"${env}\")  private String env;   @Value(\"${datasource.url}\")  private String datasource;   @Value(\"${spring.application.name}\")  private String applicationName;   @GetMapping(\"/value/env\")  public String getValueEnv(){  return \"current env is \" + env;  }   @GetMapping(\"/value/application\")  public String getValueApplication(){  return \"current env is \" + applicationName;  }   @GetMapping(\"/value/datasource\")  public Object getDatasource(){  return datasource;  }  }   访问如下页面进行验证\n$ localhost:7000/value/env $ localhost:7000/value/application $ localhost:7000/value/datasource   高可用 config-server多个实例，如何配置客户端？\n config-server 作为服务提供者，注册到eureka服务注册中心 user-service配置从注册中心获取config-server的服务  config-server注册到服务注册中心\n  pom.xml添加eureka依赖包\n   org.springframework.cloud  spring-cloud-starter-netflix-eureka-client     application.yml中连接服务注册中心\neureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:config-server}   启动类添加注解\n@EnableDiscoveryClient   修改user-service，从注册中心发现服务\n  修改bootstrap.yml\nserver:  port: 7000  spring:  cloud:  config:  profile: dev  discovery:  enabled: true  service-id: config-server  name: user-service, common  eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@peer1:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:user-service}   客户端配置刷新 配置中心的配置变动后，客户端如何获取最新的配置。\n  修改ValueController.java，添加注解\n@RestController @RefreshScope public class ValueController   添加actuator包\n   org.springframework.boot  spring-boot-starter-actuator     开放显示所有管理接口\nmanagement:  endpoints:  web:  exposure:  include: \"*\"   重启user-service\n  修改configure-repo中的配置并提交，访问http://localhost:7000/value/env\n  执行刷新\n$ curl -XPOST http://localhost:7000/actuator/refresh   再次访问http://localhost:7000/value/env\n  调用链路追踪 介绍 服务追踪的追踪单元是从客户发起请求（request）抵达被追踪系统的边界开始，到被追踪系统向客户返回响应（response）为止的过程，称为一个 trace。每个 trace 中会调用若干个服务，为了记录调用了哪些服务，以及每次调用的消耗时间等信息，在每次调用服务时，埋入一个调用记录，称为一个 span。这样，若干个有序的 span 就组成了一个 trace。在系统向外界提供服务的过程中，会不断地有请求和响应发生，也就会不断生成 trace，把这些带有 span 的 trace 记录下来，就可以描绘出一幅系统的服务拓扑图。附带上 span 中的响应时间，以及请求成功与否等信息，就可以在发生问题的时候，找到异常的服务；根据历史数据，还可以从系统整体层面分析出哪里性能差，定位性能优化的目标。\nSpring Cloud Sleuth 为服务之间调用提供链路追踪。通过 Sleuth 可以很清楚的了解到一个服务请求经过了哪些服务，每个服务处理花费了多长。从而让我们可以很方便的理清各微服务间的调用关系。此外 Sleuth 可以帮助我们：\n 耗时分析: 通过 Sleuth 可以很方便的了解到每个采样请求的耗时，从而分析出哪些服务调用比较耗时; 链路优化: 对于调用比较频繁的服务，可以针对这些服务实施一些优化措施。 可视化错误: 对于程序未捕捉的异常，可以通过集成 Zipkin 服务界面上看到; Spring Cloud Sleuth 可以结合 Zipkin，将信息发送到 Zipkin，利用 Zipkin 的存储来存储信息，利用 Zipkin UI 来展示数据。  https://zipkin.io/pages/quickstart\n启动zipkin apiVersion: apps/v1 kind: Deployment metadata:  name: zipkin  namespace: dev spec:  replicas: 1  selector:  matchLabels:  app: zipkin  template:  metadata:  labels:  app: zipkin  spec:  containers:  - name: zipkin  image: openzipkin/zipkin:2.22  imagePullPolicy: IfNotPresent  ports:  - containerPort: 9411  resources:  requests:  memory: 400Mi  cpu: 50m  limits:  memory: 2Gi  cpu: 2000m --- apiVersion: v1 kind: Service metadata:  name: zipkin  namespace: dev spec:  ports:  - port: 9411  protocol: TCP  targetPort: 9411  selector:  app: zipkin  sessionAffinity: None  type: ClusterIP status:  loadBalancer: {} --- apiVersion: extensions/v1beta1 kind: Ingress metadata:  name: zipkin  namespace: dev spec:  rules:  - host: zipkin.luffy.com  http:  paths:  - backend:  serviceName: zipkin  servicePort: 9411  path: / status:  loadBalancer: {} 实践 分别对bill-service和user-service进行改造：\npom.xml中添加：\n   org.springframework.cloud  spring-cloud-starter-zipkin   application.yml\nspring:  zipkin:  base-url: http://zipkin.luffy.com  # zipkin服务器的地址  sender:  type: web  # 设置使用http的方式传输数据  sleuth:  sampler:  probability: 1 # 设置抽样采集为100%，默认为0.1，即10% logging:  level:  org.springframework.cloud: debug 访问zuul网关的接口http://localhost:10000/apis/bill-service/bill/user/2\n2020-11-14 19:28:49.274 DEBUG [bill-service,949aa3570daa1031,43ea952f1e5e36eb,true] 36852 — [-user-service-6] c.s.i.w.c.f.TraceLoadBalancerFeignClient : Before send\nbill-service,949aa3570daa1031,43ea952f1e5e36eb,true 说明：\n bill-service： 服务名称 949aa3570daa1031： 是TranceId，一条链路中，只有一个TranceId 43ea952f1e5e36eb：则是spanId，链路中的基本工作单元id true：表示是否将数据输出到其他服务，true则会把信息输出到其他可视化的服务上观察  SpringBoot Admin监控 新建项目，springboot-admin\npom.xml   xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"  4.0.0    org.springframework.boot  spring-boot-starter-parent  2.3.6.RELEASE       com.luffy  springboot-admin  0.0.1-SNAPSHOT  springboot-admin  Demo project for Spring Boot     1.8  Hoxton.SR9         de.codecentric  spring-boot-admin-starter-server  2.2.1      org.springframework.cloud  spring-cloud-starter-netflix-eureka-client       org.springframework.cloud  spring-cloud-starter       org.springframework.boot  spring-boot-starter-test  test      org.junit.vintage  junit-vintage-engine                 org.springframework.cloud  spring-cloud-dependencies  ${spring-cloud.version}  pom  import               org.springframework.boot  spring-boot-maven-plugin         配置文件\nserver:  port: 8769  spring:  application:  name: springboot-admin  eureka:  client:  serviceUrl:  defaultZone: ${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}  instance:  instance-id: ${eureka.instance.hostname}:${server.port}  prefer-ip-address: true  hostname: ${INSTANCE_HOSTNAME:springboot-admin} 启动类\npackage com.luffy.springbootadmin;  import de.codecentric.boot.admin.server.config.EnableAdminServer; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient;  @SpringBootApplication @EnableDiscoveryClient @EnableAdminServer public class SpringbootAdminApplication {   public static void main(String[] args) {  SpringApplication.run(SpringbootAdminApplication.class, args);  }  } 客户端，所有注册到eureka的服务，添加依赖即可\n   de.codecentric  spring-boot-admin-starter-client  2.2.1   小结   伴随着业务场景复杂度的提高，单体架构应用弊端显现，微服务的思想逐步盛行，微服务架构带来诸多便捷的同时，也带来了很多问题，最主要的是多个微服务的服务治理（服务发现、调用、负载均衡、跟踪）\n  为了解决服务治理问题，出现了微服务框架（Dubbo、Spring Cloud等）\n  Spring Cloud是一个大的生态，基于Java语言封装了一系列的工具，方便业务直接使用来解决上述服务治理相关的问题\n  Spring Cloud Netflix 体系下提供了eureka、ribbon、feign、hystrix、zuul等工具结合spring cloud sleuth合zipkin实现服务跟踪\n  SpringBoot是微服务的开发框架，通过maven与Spring Cloud生态中的组件集成，极大方便了java应用程序的交付\n  https://blog.csdn.net/smallsunl/article/details/78778790\n问题：\n 无论是Dubbo还是SpringCloud，均属于Java语言体系下的产物，跨语言没法共用，同时，通过走了一遍内部集成的过程，可以清楚的发现，服务治理过程中，各模块的集成，均需要对原始业务逻辑形成侵入。 在kubernetes的生态下，已经与生俱来带了很多好用的功能（自动服务发现与负载均衡） 服务治理的根本其实是网络节点通信的治理，因此，以istio为代表的第二代服务治理平台开始逐步兴起  ",
  "wordCount" : "4359",
  "inLanguage": "zh",
  "datePublished": "2022-01-11T15:30:27Z",
  "dateModified": "2022-01-11T15:30:27Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/springboot%E4%B8%8Espringcloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E4%BA%A4%E4%BB%98/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      SpringBoot与SpringCloud微服务项目交付
    </h1>
    <div class="post-meta"><span title='2022-01-11 15:30:27 +0000 UTC'>2022-01-11</span>&nbsp;·&nbsp;21 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#spring-cloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98" aria-label="Spring Cloud微服务项目交付">Spring Cloud微服务项目交付</a><ul>
                            
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%89%ab%e7%9b%b2%e7%af%87" aria-label="微服务扫盲篇">微服务扫盲篇</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#%e5%8d%95%e4%bd%93%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84" aria-label="单体应用架构">单体应用架构</a></li>
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84" aria-label="微服务应用架构">微服务应用架构</a></li>
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%9e%b6%e6%9e%84%e9%97%ae%e9%a2%98%e5%8f%8a%e6%8c%91%e6%88%98" aria-label="微服务架构问题及挑战">微服务架构问题及挑战</a></li></ul>
                        
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%a1%86%e6%9e%b6" aria-label="微服务框架">微服务框架</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%86%e8%a7%a3spring-cloud" aria-label="了解Spring Cloud">了解Spring Cloud</a><ul>
                            
                    <li>
                        <a href="#%e6%a0%b8%e5%bf%83%e9%a1%b9%e7%9b%ae%e5%8f%8a%e7%bb%84%e4%bb%b6" aria-label="核心项目及组件">核心项目及组件</a></li>
                    <li>
                        <a href="#%e4%b8%8edubbo%e5%af%b9%e6%af%94" aria-label="与Dubbo对比">与Dubbo对比</a></li></ul>
                    </li>
                    <li>
                        <a href="#spring-boot%e4%ba%a4%e4%bb%98%e5%ae%9e%e8%b7%b5" aria-label="Spring Boot交付实践">Spring Boot交付实践</a><ul>
                            
                    <li>
                        <a href="#%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e5%88%9b%e5%bb%baspring-boot%e9%a1%b9%e7%9b%ae" aria-label="从零开始创建Spring Boot项目">从零开始创建Spring Boot项目</a></li>
                    <li>
                        <a href="#%e7%bc%96%e5%86%99%e5%8a%9f%e8%83%bd%e4%bb%a3%e7%a0%81" aria-label="编写功能代码">编写功能代码</a></li>
                    <li>
                        <a href="#%e5%a6%82%e4%bd%95%e5%9c%a8java%e9%a1%b9%e7%9b%ae%e4%b8%ad%e4%bd%bf%e7%94%a8maven" aria-label="如何在java项目中使用maven">如何在java项目中使用maven</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81maven" aria-label="为什么需要maven">为什么需要maven</a></li>
                    <li>
                        <a href="#maven%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c" aria-label="maven如何工作">maven如何工作</a></li>
                    <li>
                        <a href="#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e5%8f%8amvn%e5%91%bd%e4%bb%a4%e5%ae%9e%e8%b7%b5" aria-label="生命周期及mvn命令实践">生命周期及mvn命令实践</a></li></ul>
                    </li>
                    <li>
                        <a href="#springboot%e6%9c%8d%e5%8a%a1%e9%95%9c%e5%83%8f%e5%88%b6%e4%bd%9c" aria-label="Springboot服务镜像制作">Springboot服务镜像制作</a></li>
                    <li>
                        <a href="#%e6%8e%a5%e5%85%a5cicd%e6%b5%81%e7%a8%8b" aria-label="接入CICD流程">接入CICD流程</a></li>
                    <li>
                        <a href="#%e6%b7%bb%e5%8a%a0%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96%e7%8e%87" aria-label="添加单元测试覆盖率">添加单元测试覆盖率</a></li></ul>
                    </li>
                    <li>
                        <a href="#spring-cloud%e5%bc%80%e5%8f%91%e4%ba%a4%e4%bb%98%e5%ae%9e%e8%b7%b5" aria-label="Spring Cloud开发、交付实践">Spring Cloud开发、交付实践</a></li>
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%9c%ba%e6%99%af" aria-label="微服务场景">微服务场景</a></li>
                    <li>
                        <a href="#eureka%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83" aria-label="Eureka服务注册中心">Eureka服务注册中心</a><ul>
                            
                    <li>
                        <a href="#%e6%96%b0%e5%bb%ba%e9%a1%b9%e7%9b%ae" aria-label="新建项目">新建项目</a></li>
                    <li>
                        <a href="#%e5%90%af%e5%8a%a8eureka%e6%9c%8d%e5%8a%a1" aria-label="启动eureka服务">启动eureka服务</a></li>
                    <li>
                        <a href="#eureka%e8%ae%a4%e8%af%81" aria-label="eureka认证">eureka认证</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%86%8c%e6%9c%8d%e5%8a%a1%e5%88%b0eureka" aria-label="注册服务到eureka">注册服务到eureka</a></li>
                    <li>
                        <a href="#%e9%ab%98%e5%8f%af%e7%94%a8" aria-label="高可用">高可用</a></li>
                    <li>
                        <a href="#k8s%e4%ba%a4%e4%bb%98" aria-label="k8s交付">k8s交付</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8statefulset%e7%ae%a1%e7%90%86%e6%9c%89%e7%8a%b6%e6%80%81%e6%9c%8d%e5%8a%a1" aria-label="使用StatefulSet管理有状态服务">使用StatefulSet管理有状态服务</a></li>
                    <li>
                        <a href="#%e6%8e%a5%e5%85%a5cicd%e6%b5%81%e7%a8%8b-1" aria-label="接入CICD流程">接入CICD流程</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%97%b4%e8%b0%83%e7%94%a8" aria-label="微服务间调用">微服务间调用</a><ul>
                            
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9b%e8%80%85" aria-label="服务提供者">服务提供者</a><ul>
                            
                    <li>
                        <a href="#cicd%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9b%e8%80%85" aria-label="CICD持续交付服务提供者">CICD持续交付服务提供者</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e6%b6%88%e8%b4%b9%e8%80%85" aria-label="服务消费者">服务消费者</a><ul>
                            
                    <li>
                        <a href="#resttemplate" aria-label="RestTemplate">RestTemplate</a></li>
                    <li>
                        <a href="#%e5%88%9b%e5%bb%babill-service%e6%a8%a1%e5%9d%97" aria-label="创建bill-service模块">创建bill-service模块</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e5%ae%9e%e7%8e%b0%e6%9c%8d%e5%8a%a1%e8%b0%83%e7%94%a8" aria-label="使用注册中心实现服务调用">使用注册中心实现服务调用</a></li>
                    <li>
                        <a href="#ribbon-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="Ribbon 负载均衡">Ribbon 负载均衡</a></li>
                    <li>
                        <a href="#%e5%a3%b0%e6%98%8e%e5%bc%8f%e6%9c%8d%e5%8a%a1feign" aria-label="声明式服务Feign">声明式服务Feign</a></li>
                    <li>
                        <a href="#cicd%e6%8c%81%e7%bb%ad%e4%ba%a4%e4%bb%98%e6%9c%8d%e5%8a%a1%e6%b6%88%e8%b4%b9%e8%80%85" aria-label="CICD持续交付服务消费者">CICD持续交付服务消费者</a></li></ul>
                    </li>
                    <li>
                        <a href="#hystrix-%e6%96%ad%e8%b7%af%e5%99%a8" aria-label="Hystrix 断路器">Hystrix 断路器</a><ul>
                            
                    <li>
                        <a href="#hystrix-dashboard" aria-label="Hystrix Dashboard">Hystrix Dashboard</a></li>
                    <li>
                        <a href="#turbine" aria-label="Turbine">Turbine</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e7%bd%91%e5%85%b3" aria-label="微服务网关">微服务网关</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e7%bd%91%e5%85%b3" aria-label="为什么需要网关">为什么需要网关</a></li>
                    <li>
                        <a href="#%e7%bd%91%e5%85%b3%e7%9a%84%e5%8a%9f%e8%83%bd" aria-label="网关的功能">网关的功能</a></li>
                    <li>
                        <a href="#zuul%e5%ae%9e%e8%b7%b5" aria-label="Zuul实践">Zuul实践</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%9b%86%e4%b8%ad%e9%85%8d%e7%bd%ae%e4%b8%ad%e5%bf%83" aria-label="集中配置中心">集中配置中心</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5" aria-label="实践">实践</a></li>
                    <li>
                        <a href="#%e9%ab%98%e5%8f%af%e7%94%a8-1" aria-label="高可用">高可用</a></li>
                    <li>
                        <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e9%85%8d%e7%bd%ae%e5%88%b7%e6%96%b0" aria-label="客户端配置刷新">客户端配置刷新</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8%e9%93%be%e8%b7%af%e8%bf%bd%e8%b8%aa" aria-label="调用链路追踪">调用链路追踪</a><ul>
                            
                    <li>
                        <a href="#%e4%bb%8b%e7%bb%8d" aria-label="介绍">介绍</a></li>
                    <li>
                        <a href="#%e5%90%af%e5%8a%a8zipkin" aria-label="启动zipkin">启动zipkin</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5-1" aria-label="实践">实践</a></li></ul>
                    </li>
                    <li>
                        <a href="#springboot-admin%e7%9b%91%e6%8e%a7" aria-label="SpringBoot Admin监控">SpringBoot Admin监控</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="spring-cloud微服务项目交付">Spring Cloud微服务项目交付<a hidden class="anchor" aria-hidden="true" href="#spring-cloud微服务项目交付">#</a></h3>
<h4 id="微服务扫盲篇">微服务扫盲篇<a hidden class="anchor" aria-hidden="true" href="#微服务扫盲篇">#</a></h4>
<p>微服务并没有一个官方的定义，想要直接描述微服务比较困难，我们可以通过对比传统WEB应用，来理解什么是微服务。</p>
<h6 id="单体应用架构">单体应用架构<a hidden class="anchor" aria-hidden="true" href="#单体应用架构">#</a></h6>
<p>如下是传统打车软件架构图：</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/single.jpg" alt=""  />
</p>
<p>这种单体应用比较适合于小项目，优点是：</p>
<ul>
<li>开发简单直接，集中式管理</li>
<li>基本不会重复开发</li>
<li>功能都在本地，没有分布式的管理开销和调用开销</li>
</ul>
<p>当然它的缺点也十分明显，特别对于互联网公司来说：</p>
<ul>
<li>开发效率低：所有的开发在一个项目改代码，递交代码相互等待，代码冲突不断</li>
<li>代码维护难：代码功能耦合在一起，新人不知道何从下手</li>
<li>部署不灵活：构建时间长，任何小修改必须重新构建整个项目，这个过程往往很长</li>
<li>稳定性不高：一个微不足道的小问题，可以导致整个应用挂掉</li>
<li>扩展性不够：无法满足高并发情况下的业务需求</li>
</ul>
<h6 id="微服务应用架构">微服务应用架构<a hidden class="anchor" aria-hidden="true" href="#微服务应用架构">#</a></h6>
<p>微服务架构的设计思路不是开发一个巨大的单体式应用，而是将应用分解为小的、互相连接的微服务。一个微服务完成某个特定功能，比如乘客管理和下单管理等。每个微服务都有自己的业务逻辑和适配器。一些微服务还会提供API接口给其他微服务和应用客户端使用。</p>
<p>比如，前面描述的系统可被分解为：</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/micro-svcs.jpg" alt=""  />
</p>
<p>每个业务逻辑都被分解为一个微服务，微服务之间通过REST API通信。一些微服务也会向终端用户或客户端开发API接口。但通常情况下，这些客户端并不能直接访问后台微服务，而是通过API Gateway来传递请求。API Gateway一般负责服务路由、负载均衡、缓存、访问控制和鉴权等任务。</p>
<p>微服务架构优点：</p>
<ul>
<li>解决了复杂性问题。它将单体应用分解为一组服务。虽然功能总量不变，但应用程序已被分解为可管理的模块或服务</li>
<li>体系结构使得每个服务都可以由专注于此服务的团队独立开发。只要符合服务API契约，开发人员可以自由选择开发技术。这就意味着开发人员可以采用新技术编写或重构服务，由于服务相对较小，所以这并不会对整体应用造成太大影响</li>
<li>微服务架构可以使每个微服务独立部署。这些更改可以在测试通过后立即部署。所以微服务架构也使得CI／CD成为可能</li>
</ul>
<h6 id="微服务架构问题及挑战">微服务架构问题及挑战<a hidden class="anchor" aria-hidden="true" href="#微服务架构问题及挑战">#</a></h6>
<p>微服务的一个主要缺点是微服务的分布式特点带来的复杂性。开发人员需要基于RPC或者消息实现微服务之间的调用和通信，而这就使得服务之间的发现、服务调用链的跟踪和质量问题变得的相当棘手。</p>
<ol>
<li>微服务的一大挑战是跨多个服务的更改
<ul>
<li>比如在传统单体应用中，若有A、B、C三个服务需要更改，A依赖B，B依赖C。我们只需更改相应的模块，然后一次性部署即可。</li>
<li>在微服务架构中，我们需要仔细规划和协调每个服务的变更部署。我们需要先更新C，然后更新B，最后更新A。</li>
</ul>
</li>
<li>部署基于微服务的应用也要复杂得多
<ul>
<li>单体应用可以简单的部署在一组相同的服务器上，然后前端使用负载均衡即可。</li>
<li>微服务由不同的大量服务构成。每种服务可能拥有自己的配置、应用实例数量以及基础服务地址。这里就需要不同的配置、部署、扩展和监控组件。此外，我们还需要服务发现机制，以便服务可以发现与其通信的其他服务的地址</li>
</ul>
</li>
</ol>
<p>以上问题和挑战可大体概括为：</p>
<ul>
<li>API Gateway</li>
<li>服务间调用</li>
<li>服务发现</li>
<li>服务容错</li>
<li>服务部署</li>
<li>数据调用</li>
</ul>
<p><a href="https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155">https://www.kancloud.cn/owenwangwen/open-capacity-platform/1480155</a>，自助餐吃吃喝喝，竟然秒懂微服务</p>
<h5 id="微服务框架">微服务框架<a hidden class="anchor" aria-hidden="true" href="#微服务框架">#</a></h5>
<p>如何应对上述挑战，出现了如下微服务领域的框架：</p>
<ul>
<li>
<p>Spring Cloud（各个微服务基于Spring Boot实现）</p>
</li>
<li>
<p>Dubbo</p>
</li>
<li>
<p>Service Mesh</p>
<ul>
<li>
<p>Linkerd</p>
</li>
<li>
<p>Envoy</p>
</li>
<li>
<p>Conduit</p>
</li>
<li>
<p>Istio</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/81805411.jpg" alt=""  />
</p>
</li>
</ul>
</li>
</ul>
<h4 id="了解spring-cloud">了解Spring Cloud<a hidden class="anchor" aria-hidden="true" href="#了解spring-cloud">#</a></h4>
<p><a href="https://spring.io/">https://spring.io</a></p>
<h5 id="核心项目及组件">核心项目及组件<a hidden class="anchor" aria-hidden="true" href="#核心项目及组件">#</a></h5>
<p><a href="https://spring.io/projects">https://spring.io/projects</a></p>
<h5 id="与dubbo对比">与Dubbo对比<a hidden class="anchor" aria-hidden="true" href="#与dubbo对比">#</a></h5>
<p>做一个简单的功能对比：</p>
<table>
<thead>
<tr>
<th>核心要素</th>
<th>Dubbo</th>
<th>Spring Cloud</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务注册中心</td>
<td>Zookeeper</td>
<td>Spring Cloud Netflix Eureka</td>
</tr>
<tr>
<td>服务调用方式</td>
<td>RPC</td>
<td>REST API</td>
</tr>
<tr>
<td>服务监控</td>
<td>Dubbo-monitor</td>
<td>Spring Boot Admin</td>
</tr>
<tr>
<td>断路器</td>
<td>不完善</td>
<td>Spring Cloud Netflix Hystrix</td>
</tr>
<tr>
<td>服务网关</td>
<td>无</td>
<td>Spring Cloud Netflix Zuul</td>
</tr>
<tr>
<td>分布式配置</td>
<td>无</td>
<td>Spring Cloud Config</td>
</tr>
<tr>
<td>服务跟踪</td>
<td>无</td>
<td>Spring Cloud Sleuth</td>
</tr>
<tr>
<td>消息总线</td>
<td>无</td>
<td>Spring Cloud Bus</td>
</tr>
<tr>
<td>数据流</td>
<td>无</td>
<td>Spring Cloud Stream</td>
</tr>
<tr>
<td>批量任务</td>
<td>无</td>
<td>Spring Cloud Task</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
<td>……</td>
</tr>
</tbody>
</table>
<p><strong>从上图可以看出其实Dubbo的功能只是Spring Cloud体系的一部分。</strong></p>
<p>这样对比是不够公平的，首先<code>Dubbo</code>是<code>SOA</code>时代的产物，它的关注点主要在于服务的调用，流量分发、流量监控和熔断。而<code>Spring Cloud</code>诞生于微服务架构时代，考虑的是微服务治理的方方面面，另外由于依托了<code>Spirng</code>、<code>Spirng Boot</code>的优势之上，两个框架在开始目标就不一致，<code>Dubbo</code>定位服务治理、<code>Spirng Cloud</code>是一个生态。</p>
<h4 id="spring-boot交付实践">Spring Boot交付实践<a hidden class="anchor" aria-hidden="true" href="#spring-boot交付实践">#</a></h4>
<h5 id="从零开始创建spring-boot项目">从零开始创建Spring Boot项目<a hidden class="anchor" aria-hidden="true" href="#从零开始创建spring-boot项目">#</a></h5>
<p>通过File &gt; New &gt; Project，新建工程，选择Spring Initializr</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/new-springboot-1.jpg" alt=""  />
</p>
<p>配置Project Metadata：</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/ew-springboot-2.jpg" alt=""  />
</p>
<p>配置Dependencies依赖包：</p>
<p>选择：Web分类中的Spring web和Template Engines中的Thymeleaf</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/new-springboot-3.jpg" alt=""  />
</p>
<p>配置maven settings.xml：</p>
<p>默认使用IDE自带的maven，换成自己下载的，下载地址：</p>
<p>链接: <a href="https://pan.baidu.com/s/1z9dRGv_4bS1uxBtk5jsZ2Q">https://pan.baidu.com/s/1z9dRGv_4bS1uxBtk5jsZ2Q</a> 提取码: 3gva</p>
<p>解压后放到<code>D:\software\apache-maven-3.6.3</code>,修改<code>D:\software\apache-maven-3.6.3\conf\settings.xml</code> 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;settings</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/SETTINGS/1.0.0&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;localRepository&gt;</span>D:\opt\maven-repo<span style="color:#f92672">&lt;/localRepository&gt;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;pluginGroups&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/pluginGroups&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;proxies&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/proxies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;servers&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/servers&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;mirrors&gt;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#f92672">&lt;mirror&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>alimaven<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;mirrorOf&gt;</span>central<span style="color:#f92672">&lt;/mirrorOf&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;name&gt;</span>aliyun maven<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/mirror&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;mirror&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>nexus-aliyun<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;mirrorOf&gt;</span>*<span style="color:#f92672">&lt;/mirrorOf&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;name&gt;</span>Nexus aliyun<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/mirror&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/mirrors&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/settings&gt;</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/new-springboot-4.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/new-springboot-5.jpg" alt=""  />
</p>
<blockquote>
<p>替换springboot版本为2.3.5.RELEASE</p>
</blockquote>
<p>直接启动项目并访问本地服务：<code>localhost:8080</code></p>
<h5 id="编写功能代码">编写功能代码<a hidden class="anchor" aria-hidden="true" href="#编写功能代码">#</a></h5>
<p>创建controller包及<code>HelloController.java</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.demo.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMethod<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">,</span> method <span style="color:#f92672">=</span> RequestMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">GET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello, &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>保存并在浏览器中访问<code>localhost:8080/hello?name=luffy</code></p>
<p>如果页面复杂，如何实现？</p>
<p>在<code>resources/templates/</code>目录下新建<code>index.html</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Devops&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Type&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/html; charset=UTF-8&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;container&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">h3</span> <span style="color:#a6e22e">th:text</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;${requestname}&#34;</span>&gt;&lt;/<span style="color:#f92672">h3</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rightaway&#34;</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#a6e22e">th:href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;@{/rightaway}&#34;</span> &gt;立即返回&lt;/<span style="color:#f92672">a</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sleep&#34;</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#a6e22e">th:href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;@{/sleep}&#34;</span>&gt;延时返回&lt;/<span style="color:#f92672">a</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>完善<code>HelloController.java</code>的内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.demo.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMethod<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.ModelAndView<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">,</span> method <span style="color:#f92672">=</span> RequestMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">GET</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">hello</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello, &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ModelAndView <span style="color:#a6e22e">index</span><span style="color:#f92672">(</span>ModelAndView mv<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">setViewName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;index&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">addObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;requestname&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;This is index&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> mv<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/rightaway&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ModelAndView <span style="color:#a6e22e">returnRightAway</span><span style="color:#f92672">(</span>ModelAndView mv<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">setViewName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;index&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">addObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;requestname&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;This request is RightawayApi&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> mv<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/sleep&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ModelAndView <span style="color:#a6e22e">returnSleep</span><span style="color:#f92672">(</span>ModelAndView mv<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>2<span style="color:#f92672">*</span>1000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">setViewName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;index&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        mv<span style="color:#f92672">.</span><span style="color:#a6e22e">addObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;requestname&#34;</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;This request is SleepApi&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;,it will sleep 2s !&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> mv<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="如何在java项目中使用maven">如何在java项目中使用maven<a hidden class="anchor" aria-hidden="true" href="#如何在java项目中使用maven">#</a></h5>
<h6 id="为什么需要maven">为什么需要maven<a hidden class="anchor" aria-hidden="true" href="#为什么需要maven">#</a></h6>
<p>考虑一个常见的场景：以项目A为例，开发过程中，需要依赖B-2.0.jar的包，如果没有maven，那么正常做法是把B-2.0.jar拷贝到项目A中，但是如果B-2.0.jar还依赖C.jar，我们还需要去找到C.jar的包，因此，在开发阶段需要花费在项目依赖方面的精力会很大。</p>
<p>因此，开发人员需要找到一种方式，可以管理java包的依赖关系，并可以方便的引入到项目中。</p>
<h6 id="maven如何工作">maven如何工作<a hidden class="anchor" aria-hidden="true" href="#maven如何工作">#</a></h6>
<p>查看<code>pom.xml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>可以直接在项目中添加上<code>dependency</code> ，这样来指定项目的依赖包。</p>
<p>思考：如果<code>spring-boot-starter-thymeleaf</code>包依赖别的包，怎么办？</p>
<p><code>spring-boot-starter-thymeleaf</code>同时也是一个maven项目，也有自己的pom.xml</p>
<p>查看一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>  <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;version&gt;</span>2.3.3.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;scope&gt;</span>compile<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;groupId&gt;</span>org.thymeleaf<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;artifactId&gt;</span>thymeleaf-spring5<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;version&gt;</span>3.0.11.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;scope&gt;</span>compile<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;groupId&gt;</span>org.thymeleaf.extras<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;artifactId&gt;</span>thymeleaf-extras-java8time<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;version&gt;</span>3.0.4.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;scope&gt;</span>compile<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>这样的话，使用maven的项目，只需要在自己的pom.xml中把所需的最直接的依赖包定义上，而不用关心这些被依赖的jar包自身是否还有别的依赖。剩下的都交给maven去搞定。</p>
<p>如何搞定？maven可以根据pom.xml中定义的依赖实现包的查找</p>
<p>去哪查找？maven仓库，存储jar包的地方。</p>
<p>当我们执行 Maven 构建命令时，Maven 开始按照以下顺序查找依赖的库：</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/maven-repo.png" alt=""  />
</p>
<p>本地仓库：</p>
<ul>
<li>
<p>Maven 的本地仓库，在安装 Maven 后并不会创建，它是在第一次执行 maven 命令的时候才被创建。</p>
</li>
<li>
<p>运行 Maven 的时候，Maven 所需要的任何包都是直接从本地仓库获取的。如果本地仓库没有，它会首先尝试从远程仓库下载构件至本地仓库，然后再使用本地仓库的包。</p>
</li>
<li>
<p>默认情况下，不管Linux还是 Windows，每个用户在自己的用户目录下都有一个路径名为 .m2/respository/ 的仓库目录。</p>
</li>
<li>
<p>Maven 本地仓库默认被创建在 %USER_HOME% 目录下。要修改默认位置，在 %M2_HOME%\conf 目录中的 Maven 的 settings.xml 文件中定义另一个路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;settings</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/SETTINGS/1.0.0&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;localRepository&gt;</span>D:\opt\maven-repo<span style="color:#f92672">&lt;/localRepository&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/settings&gt;</span>
</span></span></code></pre></div></li>
</ul>
<p>中央仓库：</p>
<p>Maven 中央仓库是由 Maven 社区提供的仓库，中央仓库包含了绝大多数流行的开源Java构件，以及源码、作者信息、SCM、信息、许可证信息等。一般来说，简单的Java项目依赖的构件都可以在这里下载到。</p>
<p>中央仓库的关键概念：</p>
<ul>
<li>这个仓库由 Maven 社区管理。</li>
<li>不需要配置，maven中集成了地址 <a href="http://repo1.maven.org/maven2">http://repo1.maven.org/maven2</a></li>
<li>需要通过网络才能访问。</li>
</ul>
<p>私服仓库：</p>
<p>通常使用 sonatype Nexus来搭建私服仓库。搭建完成后，需要在 setting.xml中进行配置，比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;profile&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;id&gt;</span>localRepository<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;repositories&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;repository&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;id&gt;</span>myRepository<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;name&gt;</span>myRepository<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;url&gt;</span>http://127.0.0.1:8081/nexus/content/repositories/myRepository/<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;releases&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;enabled&gt;</span>true<span style="color:#f92672">&lt;/enabled&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/releases&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;snapshots&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;enabled&gt;</span>true<span style="color:#f92672">&lt;/enabled&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/snapshots&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/repository&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/repositories&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/profile&gt;</span>
</span></span></code></pre></div><p>方便起见，我们直接使用国内ali提供的仓库，修改 maven 根目录下的 conf 文件夹中的 setting.xml 文件，在 mirrors 节点上，添加内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;mirrors&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;mirror&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;id&gt;</span>alimaven<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;name&gt;</span>aliyun maven<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;mirrorOf&gt;</span>central<span style="color:#f92672">&lt;/mirrorOf&gt;</span>        
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/mirror&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/mirrors&gt;</span>
</span></span></code></pre></div><p>在执行构建的时候，maven会自动将所需的包下载到本地仓库中，所以第一次构建速度通常会慢一些，后面速度则很快。</p>
<p>那么maven是如何找到对应的jar包的？</p>
<p>我们可以访问 <a href="https://mvnrepository.com/">https://mvnrepository.com/</a> 查看在仓库中的jar包的样子。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>commons-collections<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>commons-collections<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>3.2.2<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>刚才看到<code>spring-boot-starter-thymeleaf</code>的依赖同样有上述属性，因此maven就可以根据这三项属性，到对应的仓库中去查找到所需要的依赖包，并下载到本地。</p>
<p>其中<code>groupId、artifactId、version</code>共同保证了包在仓库中的唯一性，这也就是为什么maven项目的pom.xml中都先配置这几项的原因，因为项目最终发布到远程仓库中，供别人调用。</p>
<p>思考：我们项目的<code>dependency</code>中为什么没有写<code>version</code> ?</p>
<p>是因为sprintboot项目的<code>上面有人</code>，来看一下项目<code>parent</code>的写法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#f92672">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>2.3.3.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;relativePath/&gt;</span> <span style="color:#75715e">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/parent&gt;</span>
</span></span></code></pre></div><p>parent模块中定义过的<code>dependencies</code>，在子项目中引用的话，不需要指定版本，这样可以保证所有的子项目都使用相同版本的依赖包。</p>
<h6 id="生命周期及mvn命令实践">生命周期及mvn命令实践<a hidden class="anchor" aria-hidden="true" href="#生命周期及mvn命令实践">#</a></h6>
<p>Maven有三套相互独立的生命周期，分别是clean、default和site。每个生命周期包含一些阶段（phase），阶段是有顺序的，后面的阶段依赖于前面的阶段。</p>
<ul>
<li>clean生命周期，清理项目
<ul>
<li>清理：mvn clean　　　 &ndash;删除target目录，也就是将class文件等删除</li>
</ul>
</li>
<li>default生命周期，项目的构建等核心阶段
<ul>
<li>编译：mvn compile　　&ndash;src/main/java目录java源码编译生成class （target目录下）</li>
<li>测试：mvn test　　　　&ndash;src/test/java 执行目录下的测试用例</li>
<li>打包：mvn package　　&ndash;生成压缩文件：java项目#jar包；web项目#war包，也是放在target目录下</li>
<li>安装：mvn install　　　&ndash;将压缩文件(jar或者war)上传到本地仓库</li>
<li>部署|发布：mvn deploy　　&ndash;将压缩文件上传私服</li>
</ul>
</li>
<li>site生命周期，建立和发布项目站点
<ul>
<li>站点 : mvn site      &ndash;生成项目站点文档</li>
</ul>
</li>
</ul>
<p>各个生命周期相互独立，一个生命周期的阶段前后依赖。 生命周期阶段需要绑定到某个插件的目标才能完成真正的工作，比如test阶段正是与maven-surefire-plugin的test目标相绑定了 。</p>
<p>举例如下：</p>
<ul>
<li>
<p>mvn clean</p>
<p>调用clean生命周期的clean阶段</p>
</li>
<li>
<p>mvn test</p>
<p>调用default生命周期的test阶段，实际执行test以及之前所有阶段</p>
</li>
<li>
<p>mvn clean install</p>
<p>调用clean生命周期的clean阶段和default的install阶段，实际执行clean，install以及之前所有阶段</p>
</li>
</ul>
<p>在linux环境中演示：</p>
<p>创建gitlab组，<code>luffy-spring-cloud</code>,在该组下创建项目<code>springboot-demo</code></p>
<ul>
<li>
<p>提交代码到git仓库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git init
</span></span><span style="display:flex;"><span>$ git remote add origin http://gitlab.luffy.com/luffy-spring-cloud/springboot-demo.git
</span></span><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#34;Initial commit&#34;</span>
</span></span><span style="display:flex;"><span>$ git push -u origin master
</span></span></code></pre></div></li>
<li>
<p>使用tools容器来运行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run --rm -ti 172.21.51.67:5000/devops/tools:v3 bash
</span></span><span style="display:flex;"><span>bash-5.0# mvn -v
</span></span><span style="display:flex;"><span>bash: mvn: command not found
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 由于idea工具自带了maven，所以可以直接在ide中执行mvn命令。在tools容器中，需要安装mvn命令</span>
</span></span></code></pre></div><p>为tools镜像集成mvn：</p>
<p>将本地的<code>apache-maven-3.6.3</code>放到<code>tools</code>项目中，修改<code>settings.xml</code>配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;localRepository&gt;</span>/opt/maven-repo<span style="color:#f92672">&lt;/localRepository&gt;</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>然后修改Dockerfile，添加如下部分:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e">#-----------------安装 maven--------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> apache-maven-3.6.3 /usr/lib/apache-maven-3.6.3<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ln -s /usr/lib/apache-maven-3.6.3/bin/mvn /usr/local/bin/mvn <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/mvn<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> MAVEN_HOME<span style="color:#f92672">=</span>/usr/lib/apache-maven-3.6.3<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#------------------------------------------------#</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div></li>
</ul>
<p>去master节点拉取最新代码，构建最新的tools镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  <span style="color:#75715e"># k8s-master节点</span>
</span></span><span style="display:flex;"><span>  $ git pull
</span></span><span style="display:flex;"><span>  $ docker build . -t 172.21.51.67:5000/devops/tools:v4 -f Dockerfile
</span></span><span style="display:flex;"><span>  $ docker push 172.21.51.67:5000/devops/tools:v4
</span></span></code></pre></div><p>再次尝试mvn命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker run --rm -ti 172.21.51.67:5000/devops/tools:v4 bash
</span></span><span style="display:flex;"><span>  bash-5.0# mvn -v
</span></span><span style="display:flex;"><span>  bash-5.0# git clone http://gitlab.luffy.com/luffy-spring-cloud/springboot-demo.git
</span></span><span style="display:flex;"><span>  bash-5.0# cd springboot-demo
</span></span><span style="display:flex;"><span>  bash-5.0# mvn clean
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 观察/opt/maven目录</span>
</span></span><span style="display:flex;"><span>  bash-5.0# mvn package
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 多阶段组合</span>
</span></span><span style="display:flex;"><span>  bash-5.0# mvn clean package
</span></span></code></pre></div><p>想系统学习maven，可以参考： <a href="https://www.runoob.com/maven/maven-pom.html">https://www.runoob.com/maven/maven-pom.html</a></p>
<h5 id="springboot服务镜像制作">Springboot服务镜像制作<a hidden class="anchor" aria-hidden="true" href="#springboot服务镜像制作">#</a></h5>
<p>通过<code>mvn package</code>命令拿到服务的jar包后，我们可以使用如下命令启动服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ java -jar demo-0.0.1-SNAPSHOT.jar
</span></span></code></pre></div><p>因此，需要准备Dockerfile来构建镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk:8-jdk-alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> target/springboot-demo-0.0.1-SNAPSHOT.jar app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [ <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;java -jar /app.jar&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>我们可以为构建出的镜像指定名称：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;finalName&gt;</span>${project.artifactId}<span style="color:#f92672">&lt;/finalName&gt;</span><span style="color:#75715e">&lt;!--打jar包去掉版本号--&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p><code>Dockerfile</code>对应修改：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk:8-jdk-alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> target/springboot-demo.jar app.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [ <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;java -jar /app.jar&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>执行镜像构建，验证服务启动是否正常：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker build . -t springboot-demo:v1 -f Dockerfile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker run -d --name springboot-demo -p 8080:8080 springboot-demo:v1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl localhost:8080
</span></span></code></pre></div><h5 id="接入cicd流程">接入CICD流程<a hidden class="anchor" aria-hidden="true" href="#接入cicd流程">#</a></h5>
<p>之前已经实现了shared-library，并且把python项目接入到了CICD 流程中。因此，可以直接使用已有的流程，把spring boot项目接入进去。</p>
<ul>
<li><code>Jenkinsfile</code></li>
<li><code>sonar-project.properties</code></li>
<li><code>deploy/deployment.yaml</code></li>
<li><code>deploy/service.yaml</code></li>
<li><code>deploy/ingress.yaml</code></li>
<li><code>configmap/devops-config</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Jenkinsfile
</span></span><span style="display:flex;"><span>@Library<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: 20, unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/demo/springboot-demo&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        PROJECT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;springboot-demo&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mvn-package&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;mvn clean package&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast true
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops.scan<span style="color:#f92672">()</span>.start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops.docker<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>IMAGE_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_COMMIT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">)</span>.build<span style="color:#f92672">()</span>.push<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops.deploy<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span>,true,<span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span><span style="color:#f92672">)</span>.start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops.notificationSuccess<span style="color:#f92672">(</span>PROJECT,<span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops.notificationFailure<span style="color:#f92672">(</span>PROJECT,<span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><pre tabindex="0"><code class="language-properties" data-lang="properties">sonar-project.properties
sonar.projectKey=springboot-demo
sonar.projectName=springboot-demo
# if you want disabled the DTD verification for a proxy problem for example, true by default
# JUnit like test report, default value is test.xml
sonar.sources=src/main/java
sonar.language=java
sonar.tests=src/test/java
sonar.java.binaries=target/classes
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">deploy/deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: {{<span style="color:#ae81ff">IMAGE_URL}}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">deploy/service.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">deploy/ingress.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: {{<span style="color:#ae81ff">INGRESS_SPRINGBOOTDEMO}}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">springboot-demo</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><p>维护<code>devops-config</code>的<code>configmap</code>，添加<code>INGRESS_SPRINGBOOTDEMO</code>配置项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n dev edit cm devops-config
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  INGRESS_MYBLOG: blog-dev.luffy.com
</span></span><span style="display:flex;"><span>  INGRESS_SPRINGBOOTDEMO: springboot-dev.luffy.com
</span></span><span style="display:flex;"><span>  NAMESPACE: dev
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>更新Jenkins中的jnlp-slave-pod模板镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>172.21.51.67:5000/devops/tools:v4
</span></span></code></pre></div><p>由于镜像中maven的目录是<code>/opt/maven-repo</code>，而slave-pod是执行完任务后会销毁，因此需要将maven的数据目录挂载出来，不然每次构建都会重新拉取所有依赖的jar包：</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/maven-repo-vols.jpg" alt=""  />
</p>
<p>配置Jenkins流水线：</p>
<h5 id="添加单元测试覆盖率">添加单元测试覆盖率<a hidden class="anchor" aria-hidden="true" href="#添加单元测试覆盖率">#</a></h5>
<p>单元测试这块内容一直没有把覆盖率统计到<code>sonarqube</code>端，本节看下怎么样将单元测试的结果及覆盖率展示到Jenkins及<code>sonarqube</code>平台中。</p>
<p>为了展示效果，我们先添加一个单元测试文件<code>HelloControllerTest</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.demo<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.junit.jupiter.api.BeforeEach<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.junit.jupiter.api.Test<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.test.context.SpringBootTest<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.http.MediaType<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.test.context.web.WebAppConfiguration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.test.web.servlet.MockMvc<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.test.web.servlet.result.MockMvcResultHandlers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.test.web.servlet.setup.MockMvcBuilders<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.WebApplicationContext<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootTest</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@WebAppConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloControllerTests</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>HelloControllerTests<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> WebApplicationContext webApplicationContext<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> MockMvc mockMvc<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@BeforeEach</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setMockMvc</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        mockMvc <span style="color:#f92672">=</span> MockMvcBuilders<span style="color:#f92672">.</span><span style="color:#a6e22e">webAppContextSetup</span><span style="color:#f92672">(</span>webApplicationContext<span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">index</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            mockMvc<span style="color:#f92672">.</span><span style="color:#a6e22e">perform</span><span style="color:#f92672">(</span>MockMvcRequestBuilders<span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">contentType</span><span style="color:#f92672">(</span>MediaType<span style="color:#f92672">.</span><span style="color:#a6e22e">APPLICATION_JSON</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">).</span><span style="color:#a6e22e">andExpect</span><span style="color:#f92672">(</span>MockMvcResultMatchers<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isOk</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">andDo</span><span style="color:#f92672">(</span>MockMvcResultHandlers<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rightaway</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            mockMvc<span style="color:#f92672">.</span><span style="color:#a6e22e">perform</span><span style="color:#f92672">(</span>MockMvcRequestBuilders<span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/rightaway&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">contentType</span><span style="color:#f92672">(</span>MediaType<span style="color:#f92672">.</span><span style="color:#a6e22e">APPLICATION_JSON</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">).</span><span style="color:#a6e22e">andExpect</span><span style="color:#f92672">(</span>MockMvcResultMatchers<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isOk</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">andDo</span><span style="color:#f92672">(</span>MockMvcResultHandlers<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sleep</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            mockMvc<span style="color:#f92672">.</span><span style="color:#a6e22e">perform</span><span style="color:#f92672">(</span>MockMvcRequestBuilders<span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/sleep&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">contentType</span><span style="color:#f92672">(</span>MediaType<span style="color:#f92672">.</span><span style="color:#a6e22e">APPLICATION_JSON</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">).</span><span style="color:#a6e22e">andExpect</span><span style="color:#f92672">(</span>MockMvcResultMatchers<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isOk</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">.</span><span style="color:#a6e22e">andDo</span><span style="color:#f92672">(</span>MockMvcResultHandlers<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>jacoco</code>：监控JVM中的调用，生成监控结果（默认保存在<code>jacoco.exec</code>文件中），然后分析此结果，配合源代码生成覆盖率报告。</p>
<p>如何引入<code>jacoco</code>测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.jacoco<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>jacoco-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>0.7.8<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;goal&gt;</span>prepare-agent<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;destFile&gt;</span>${project.build.directory}/coverage-reports/jacoco.exec<span style="color:#f92672">&lt;/destFile&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;id&gt;</span>default-report<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;phase&gt;</span>test<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;goal&gt;</span>report<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;dataFile&gt;</span>${project.build.directory}/coverage-reports/jacoco.exec<span style="color:#f92672">&lt;/dataFile&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;outputDirectory&gt;</span>${project.reporting.outputDirectory}/jacoco<span style="color:#f92672">&lt;/outputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>其中：</p>
<ul>
<li><code>prepare-agent</code>，会把agent准备好，这样在执行用例的时候，就会使用agent检测到代码执行的过程，通常将结果保存在<code>jacoco.exec</code>中</li>
<li><code>report</code>，分析保存的<code>jacoco.exec</code>文件，生成报告</li>
</ul>
<p>在IDE中添加，观察插件的goal，执行<code>mvn test</code>，观察执行过程。</p>
<p>有了上述内容后，如何将结果发布到<code>sonarqube</code>中？</p>
<p>提交最新代码，查看<code>sonarqube</code>的分析结果。</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/sonar-coverage.jpg" alt=""  />
</p>
<h4 id="spring-cloud开发交付实践">Spring Cloud开发、交付实践<a hidden class="anchor" aria-hidden="true" href="#spring-cloud开发交付实践">#</a></h4>
<p><a href="https://spring.io/projects/spring-cloud#overview">https://spring.io/projects/spring-cloud#overview</a></p>
<p>1、Netflix是一家做视频的网站，可以这么说该网站上的美剧应该是最火的。</p>
<p>2、Netflix是一家没有CTO的公司，正是这样的组织架构能使产品与技术无缝的沟通，从而能快速迭代出更优秀的产品。在当时软件敏捷开发中，Netflix的更新速度不亚于当年的微信后台变更，虽然微信比Netflix迟发展，但是当年微信的灰度发布和敏捷开发应该算是业界最猛的。</p>
<p>3、Netflix由于做视频的原因，访问量非常的大，从而促使其技术快速的发展在背后支撑着，也正是如此，Netflix开始把整体的系统往微服务上迁移。</p>
<p>4、Netflix的微服务做的不是最早的，但是确是最大规模的在生产级别微服务的尝试。也正是这种大规模的生产级别尝试，在服务器运维上依托AWS云。当然AWS云同样受益于Netflix的大规模业务不断的壮大。</p>
<p>5、Netflix的微服务大规模的应用，在技术上毫无保留的把一整套微服务架构核心技术栈开源了出来，叫做Netflix OSS，也正是如此，在技术上依靠开源社区的力量不断的壮大。</p>
<p>6、Spring Cloud是构建微服务的核心，而Spring Cloud是基于Spring Boot来开发的。</p>
<p>7、Pivotal在Netflix开源的一整套核心技术产品线的同时，做了一系列的封装，就变成了Spring Cloud；虽然Spring Cloud到现在为止不只有Netflix提供的方案可以集成，还有很多方案，但Netflix是最成熟的。</p>
<blockquote>
<p>本课程基于SpringBoot 2.3.6.RELEASE 和Spring Cloud Hoxton.SR9版本</p>
</blockquote>
<h4 id="微服务场景">微服务场景<a hidden class="anchor" aria-hidden="true" href="#微服务场景">#</a></h4>
<p>开发APP，提供个人的花呗账单管理。</p>
<ul>
<li>注册、登录、账单查询</li>
<li>用户服务，账单管理服务</li>
<li><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/demo-project.png" alt=""  />
</li>
</ul>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/arch.png" alt=""  />
</p>
<h4 id="eureka服务注册中心">Eureka服务注册中心<a hidden class="anchor" aria-hidden="true" href="#eureka服务注册中心">#</a></h4>
<p>在<code>SpringCloud</code>体系中，我们知道服务之间的调用是通过<code>http</code>协议进行调用的。而注册中心的主要目的就是维护这些服务的服务列表。</p>
<p><a href="https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/">https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/</a></p>
<h5 id="新建项目">新建项目<a hidden class="anchor" aria-hidden="true" href="#新建项目">#</a></h5>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/new-eureka.jpg" alt=""  />
</p>
<p>pom中引入spring-cloud的依赖：</p>
<p><a href="https://spring.io/projects/spring-cloud#overview">https://spring.io/projects/spring-cloud#overview</a></p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/devops-roles.jpg" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;spring.cloud-version&gt;</span>Hoxton.SR9<span style="color:#f92672">&lt;/spring.cloud-version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>${spring.cloud-version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span></code></pre></div><p>引入eureka-server的依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id="启动eureka服务">启动eureka服务<a hidden class="anchor" aria-hidden="true" href="#启动eureka服务">#</a></h5>
<p><a href="https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/#spring-cloud-eureka-server-standalone-mode">https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/#spring-cloud-eureka-server-standalone-mode</a></p>
<p>application.yml</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">server:
  port: 8761
  
eureka:
  client:
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
    register-with-eureka: false
    fetch-registry: false
  instance:
    hostname: localhost
</code></pre><p>启动类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.eureka<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableEurekaServer</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EurekaServerApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>EurekaServerApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>启动访问localhost:8761测试</p>
<p>创建spring cloud项目三部曲：</p>
<ul>
<li>引入依赖包</li>
<li>修改application.yml配置文件</li>
<li>启动类添加注解</li>
</ul>
<h5 id="eureka认证">eureka认证<a hidden class="anchor" aria-hidden="true" href="#eureka认证">#</a></h5>
<p>没有认证，不安全，添加认证：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-security<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8761</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://${spring.security.user.name}:${spring.security.user.password}@${eureka.instance.hostname}:${server.port}/eureka/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">${EUREKA_USER:admin}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">${EUREKA_PASS:admin}</span>
</span></span></code></pre></div><h5 id="注册服务到eureka">注册服务到eureka<a hidden class="anchor" aria-hidden="true" href="#注册服务到eureka">#</a></h5>
<p>新建项目，user-service（选择Spring Cloud依赖和SpringBoot Web依赖），用来提供用户查询功能。</p>
<p>三部曲：</p>
<ul>
<li>pom.xml，并添加依赖</li>
<li>创建application.yml配置文件</li>
<li>创建Springboot启动类，并配置注解</li>
</ul>
<p><code>pom.xml</code>添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">application.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@localhost:8761/eureka/</span>
</span></span></code></pre></div><p>启动类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//注意这里也可使用@EnableEurekaClient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//但由于springcloud是灵活的，注册中心支持eureka、consul、zookeeper等
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//若写了具体的注册中心注解，则当替换成其他注册中心时，又需要替换成对应的注解了。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//所以 直接使用@EnableDiscoveryClient 启动发现。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//这样在替换注册中心时，只需要替换相关依赖即可。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>UserServiceApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>c.n.d.s.t.d.RetryableEurekaHttpClient    : Request execution failed with message: com.fasterxml.jackson.databind.exc.MismatchedInputException: Root name <span style="color:#e6db74">&#39;timestamp&#39;</span> does not match expected <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;instance&#39;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> type <span style="color:#f92672">[</span>simple type, class com.netflix.appinfo.InstanceInfo<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>新版本的security默认开启csrf了，关掉，在注册中心新建一个类，继承WebSecurityConfigurerAdapter来关闭 ,&gt; 注意，是在eureka server端关闭。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.eureka<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Configuration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebSecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">(</span>HttpSecurity http<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">csrf</span><span style="color:#f92672">().</span><span style="color:#a6e22e">disable</span><span style="color:#f92672">();</span> <span style="color:#75715e">//关闭csrf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        http<span style="color:#f92672">.</span><span style="color:#a6e22e">authorizeRequests</span><span style="color:#f92672">().</span><span style="color:#a6e22e">anyRequest</span><span style="color:#f92672">().</span><span style="color:#a6e22e">authenticated</span><span style="color:#f92672">().</span><span style="color:#a6e22e">and</span><span style="color:#f92672">().</span><span style="color:#a6e22e">httpBasic</span><span style="color:#f92672">();</span> <span style="color:#75715e">//开启认证
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>再次启动发现可以注册，但是地址是</p>
<p>application.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@localhost:8761/eureka/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span></code></pre></div><p>Eurake有一个配置参数eureka.server.renewalPercentThreshold，定义了renews 和renews threshold的比值，默认值为0.85。当server在15分钟内，比值低于percent，即少了15%的微服务心跳，server会进入自我保护状态</p>
<p>默认情况下，如果<code>Eureka Server</code>在一定时间内没有接收到某个微服务实例的心跳，<code>Eureka Server</code>将会注销该实例（默认90秒）。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，这就可能变得非常危险了，因为微服务本身是健康的，此时本不应该注销这个微服务。</p>
<p><code>Eureka Server</code>通过“自我保护模式”来解决这个问题，当<code>Eureka Server</code>节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，<code>Eureka Server</code>就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该<code>Eureka Server</code>节点会自动退出自我保护模式。</p>
<p><strong>自我保护模式是一种对网络异常的安全保护措施。使用自我保护模式，而让Eureka集群更加的健壮、稳定。</strong></p>
<p>开发阶段可以通过配置：<code>eureka.server.enable-self-preservation=false</code>关闭自我保护模式。</p>
<p><strong>生产阶段，理应以默认值进行配置。</strong></p>
<p>至于具体具体的配置参数，可至官网查看：http://cloud.spring.io/spring-cloud-static/Finchley.RELEASE/single/spring-cloud.html#_appendix_compendium_of_configuration_properties</p>
<h5 id="高可用">高可用<a hidden class="anchor" aria-hidden="true" href="#高可用">#</a></h5>
<p>高可用：</p>
<ul>
<li>优先保证可用性</li>
<li>各个节点都是平等的，1个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务</li>
<li>在向某个Eureka注册时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用(保证可用性)</li>
</ul>
<p>注意点：</p>
<ul>
<li>
<p>多实例的话eureka.instance.instance-id需要保持不一样，否则会当成同一个</p>
</li>
<li>
<p>eureka.instance.hostname要与defaultZone里的地址保持一致</p>
</li>
<li>
<p>各个eureka的spring.application.name相同</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/eureka-cluster.jpg" alt=""  />
</p>
</li>
</ul>
<p>拷贝<code>eureka</code>服务，分别命名<code>eureka-ha-peer1</code>和<code>eureka-ha-peer2</code></p>
<p>修改模块的<code>pom.xml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;artifactId&gt;</span>eureka-ha-peer1<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span></code></pre></div><p>修改配置文件<code>application.yml</code>，注意集群服务，需要各个eureka的spring.application.name相同</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">${EUREKA_PORT:8762}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://${spring.security.user.name}:${spring.security.user.password}@peer1:8762/eureka/,http://${spring.security.user.name}:${spring.security.user.password}@peer2:8763/eureka/}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">peer1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">${EUREKA_USER:admin}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">${EUREKA_PASS:admin}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span></code></pre></div><p>设置hosts文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>127.0.0.1 peer1 peer2
</span></span></code></pre></div><p>服务提供者若想连接高可用的eureka，需要修改：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@peer1:8762/eureka/,http://${EUREKA_USER:admin}:${EUREKA_PASS:admin}@peer2:8763/eureka/</span>
</span></span></code></pre></div><h5 id="k8s交付">k8s交付<a hidden class="anchor" aria-hidden="true" href="#k8s交付">#</a></h5>
<p>分析：</p>
<p>高可用互相注册，但是需要知道对方节点的地址。k8s中pod ip是不固定的，如何将高可用的eureka服务使用k8s交付？</p>
<ul>
<li>
<p>方案一：创建三个Deployment+三个Service</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/eureka-ha-deploy.jpg" alt=""  />
</p>
</li>
<li>
<p>方案二：使用statefulset管理</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/eureka-sts.jpg" alt=""  />
</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">eureka-statefulset.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eureka-statefulset.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#e6db74">&#34;eureka&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/spring-cloud/eureka-cluster:v1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8761</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">400Mi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">2000m</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MY_POD_NAME</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.name</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: -<span style="color:#ae81ff">XX:+UnlockExperimentalVMOptions</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseCGroupMemoryLimitForHeap</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:MaxRAMFraction=2</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:CICompilerCount=8</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:ActiveProcessorCount=8</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseG1GC</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+AggressiveOpts</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseFastAccessorMethods</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseStringDeduplication</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseCompressedOops</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+OptimizeStringConcat</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">EUREKA_SERVER</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;http://admin:admin@eureka-cluster-0.eureka:8761/eureka/,http://admin:admin@eureka-cluster-1.eureka:8761/eureka/,http://admin:admin@eureka-cluster-2.eureka:8761/eureka/&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">EUREKA_INSTANCE_HOSTNAME</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#ae81ff">${MY_POD_NAME}.eureka</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">EUREKA_PORT</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;8761&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">eureka-headless-service.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8761</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span></code></pre></div><p>想通过ingress访问eureka，需要使用有头服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-ingress</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8761</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">eureka-cluster.luffy.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">eureka-ingress</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8761</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><h5 id="使用statefulset管理有状态服务">使用StatefulSet管理有状态服务<a hidden class="anchor" aria-hidden="true" href="#使用statefulset管理有状态服务">#</a></h5>
<p>使用StatefulSet创建多副本pod的情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-statefulset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-sts</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-sts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-sts</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>无头服务Headless Service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-sts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ kubectl -n spring exec  -ti nginx-statefulset-0 sh</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">/</span> <span style="color:#75715e"># curl nginx-statefulset-2.nginx</span>
</span></span></code></pre></div><h5 id="接入cicd流程-1">接入CICD流程<a hidden class="anchor" aria-hidden="true" href="#接入cicd流程-1">#</a></h5>
<p>所需的文件:</p>
<ul>
<li></li>
</ul>
<p>在pom.xml中重写jar包名称：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;finalName&gt;</span>${project.artifactId}<span style="color:#f92672">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>Dockerfile
</span></span><span style="display:flex;"><span>FROM openjdk:8-jdk-alpine
</span></span><span style="display:flex;"><span>ADD target/eureka.jar app.jar
</span></span><span style="display:flex;"><span>ENV JAVA_OPTS=&#34;&#34;
</span></span><span style="display:flex;"><span>CMD [ &#34;sh&#34;, &#34;-c&#34;, &#34;java $JAVA_OPTS -jar /app.jar&#34; ]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Jenkinsfile
</span></span><span style="display:flex;"><span>@Library<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: 20, unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/spring-cloud/eureka-cluster&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        PROJECT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;eureka-cluster&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mvn-package&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;mvn clean package&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast true
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops.scan<span style="color:#f92672">()</span>.start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops.docker<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>IMAGE_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_COMMIT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">)</span>.build<span style="color:#f92672">()</span>.push<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops.deploy<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span>,false,<span style="color:#e6db74">&#34;deploy/statefulset.yaml&#34;</span><span style="color:#f92672">)</span>.start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops.notificationSuccess<span style="color:#f92672">(</span>PROJECT,<span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops.notificationFailure<span style="color:#f92672">(</span>PROJECT,<span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>sonar-project.properties
</span></span><span style="display:flex;"><span>sonar.projectKey<span style="color:#f92672">=</span>eureka-cluster
</span></span><span style="display:flex;"><span>sonar.projectName<span style="color:#f92672">=</span>eureka-cluster
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if you want disabled the DTD verification for a proxy problem for example, true by default</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># JUnit like test report, default value is test.xml</span>
</span></span><span style="display:flex;"><span>sonar.sources<span style="color:#f92672">=</span>src/main/java
</span></span><span style="display:flex;"><span>sonar.language<span style="color:#f92672">=</span>java
</span></span><span style="display:flex;"><span>sonar.tests<span style="color:#f92672">=</span>src/test/java
</span></span><span style="display:flex;"><span>sonar.java.binaries<span style="color:#f92672">=</span>target/classes
</span></span></code></pre></div><p>模板化k8s资源清单：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># eureka-statefulset.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceName</span>: <span style="color:#e6db74">&#34;eureka&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: {{<span style="color:#ae81ff">IMAGE_URL}}</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>维护新组件的ingress:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n dev edit configmap devops-config
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  INGRESS_EUREKA: eureka.luffy.com
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>部署k8s集群时，将eureka的集群地址通过参数的形式传递到pod内部，因此本地开发时，直接按照单点模式进行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">${EUREKA_PORT:8761}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://${spring.security.user.name}:${spring.security.user.password}@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">fetch-registry</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">register-with-eureka</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${EUREKA_INSTANCE_HOSTNAME:localhost}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">${EUREKA_USER:admin}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">${EUREKA_PASS:admin}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-cluster</span>
</span></span></code></pre></div><p>提交项目：</p>
<p>创建develop分支，CICD部署开发环境</p>
<blockquote>
<p>停掉eureka-ha</p>
</blockquote>
<h4 id="微服务间调用">微服务间调用<a hidden class="anchor" aria-hidden="true" href="#微服务间调用">#</a></h4>
<h5 id="服务提供者">服务提供者<a hidden class="anchor" aria-hidden="true" href="#服务提供者">#</a></h5>
<p>前面已经将用户服务注册到了eureka注册中心，但是还没有暴漏任何API给服务消费者调用。</p>
<p>新建controller类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.userservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.userservice.entity.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PathVariable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Random<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserService</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;this is user-service&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user-nums&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">getUserNums</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">().</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>100<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//{&#34;id&#34;: 123, &#34;name&#34;: &#34;张三&#34;, &#34;age&#34;: 20, &#34;sex&#34;: &#34;male&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setAge</span><span style="color:#f92672">(</span>20<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;zhangsan&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setSex</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;male&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>实体类User.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.userservice.entity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String sex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getAge</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getSex</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAge</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> age<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">age</span> <span style="color:#f92672">=</span> age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSex</span><span style="color:#f92672">(</span>String sex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sex</span> <span style="color:#f92672">=</span> sex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>application<span style="color:#f92672">.</span><span style="color:#a6e22e">yml</span>
</span></span></code></pre></div><p>增加从环境变量中读取<code>EUREKA_SERVER</code>和<code>EUREKA_INSTANCE_HOSTNAME</code>配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:user-service}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span></code></pre></div><h6 id="cicd持续交付服务提供者">CICD持续交付服务提供者<a hidden class="anchor" aria-hidden="true" href="#cicd持续交付服务提供者">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: {{<span style="color:#ae81ff">IMAGE_URL}}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">400Mi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">2000m</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">JAVA_OPTS</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: -<span style="color:#ae81ff">XX:+UnlockExperimentalVMOptions</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseCGroupMemoryLimitForHeap</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:MaxRAMFraction=2</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:CICompilerCount=8</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:ActiveProcessorCount=8</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseG1GC</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+AggressiveOpts</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseFastAccessorMethods</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseStringDeduplication</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+UseCompressedOops</span>
</span></span><span style="display:flex;"><span>                -<span style="color:#ae81ff">XX:+OptimizeStringConcat</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">EUREKA_SERVER</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;http://admin:admin@eureka-cluster-0.eureka:8761/eureka/,http://admin:admin@eureka-cluster-1.eureka:8761/eureka/,http://admin:admin@eureka-cluster-2.eureka:8761/eureka/&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INSTANCE_HOSTNAME</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">fieldRef</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">metadata.name</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">service.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">ingress.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{<span style="color:#ae81ff">NAMESPACE}}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: {{<span style="color:#ae81ff">INGRESS_USER_SERVICE}}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><p>ingress配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n dev edit configmap devops-config
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  INGRESS_MYBLOG: blog-dev.luffy.com
</span></span><span style="display:flex;"><span>  INGRESS_SPRINGBOOTDEMO: springboot-dev.luffy.com
</span></span><span style="display:flex;"><span>  INGRESS_USER_SERVICE: user-service-dev.luffy.com
</span></span><span style="display:flex;"><span>  NAMESPACE: dev
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Jenkinsfile
</span></span><span style="display:flex;"><span>@Library<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;luffy-devops&#39;</span><span style="color:#f92672">)</span> _
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span> label <span style="color:#e6db74">&#39;jnlp-slave&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		timeout<span style="color:#f92672">(</span>time: 20, unit: <span style="color:#e6db74">&#39;MINUTES&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		gitLabConnection<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gitlab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        IMAGE_REPO <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;172.21.51.67:5000/spring-cloud/user-service&#34;</span>
</span></span><span style="display:flex;"><span>        IMAGE_CREDENTIAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;credential-registry&#34;</span>
</span></span><span style="display:flex;"><span>        DINGTALK_CREDS <span style="color:#f92672">=</span> credentials<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dingTalk&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        PROJECT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user-service&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;checkout&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout scm
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mvn-package&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#39;mvn clean package&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;CI&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            failFast true
</span></span><span style="display:flex;"><span>            parallel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unit Test&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        echo <span style="color:#e6db74">&#34;Unit Test Stage Skip...&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Code Scan&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                               devops.scan<span style="color:#f92672">()</span>.start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;docker-image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        devops.docker<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>IMAGE_REPO<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_COMMIT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                            IMAGE_CREDENTIAL
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">)</span>.build<span style="color:#f92672">()</span>.push<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                container<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tools&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    	devops.deploy<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deploy&#34;</span>,true,<span style="color:#e6db74">&#34;deploy/deployment.yaml&#34;</span><span style="color:#f92672">)</span>.start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        success <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops.notificationSuccess<span style="color:#f92672">(</span>PROJECT,<span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        failure <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            script<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                devops.notificationFailure<span style="color:#f92672">(</span>PROJECT,<span style="color:#e6db74">&#34;dingTalk&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>pom.xml
</span></span><span style="display:flex;"><span>&lt;finalName&gt;<span style="color:#e6db74">${</span>project.artifactId<span style="color:#e6db74">}</span>&lt;/finalName&gt;
</span></span><span style="display:flex;"><span>Dockerfile
</span></span><span style="display:flex;"><span>FROM openjdk:8-jdk-alpine
</span></span><span style="display:flex;"><span>COPY target/user-service.jar app.jar
</span></span><span style="display:flex;"><span>ENV JAVA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>CMD <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;java </span>$JAVA_OPTS<span style="color:#e6db74"> -jar /app.jar&#34;</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>sonar-project.properties
</span></span><span style="display:flex;"><span>sonar.projectKey<span style="color:#f92672">=</span>user-service
</span></span><span style="display:flex;"><span>sonar.projectName<span style="color:#f92672">=</span>user-service
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if you want disabled the DTD verification for a proxy problem for example, true by default</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># JUnit like test report, default value is test.xml</span>
</span></span><span style="display:flex;"><span>sonar.sources<span style="color:#f92672">=</span>src/main/java
</span></span><span style="display:flex;"><span>sonar.language<span style="color:#f92672">=</span>java
</span></span><span style="display:flex;"><span>sonar.tests<span style="color:#f92672">=</span>src/test/java
</span></span><span style="display:flex;"><span>sonar.java.binaries<span style="color:#f92672">=</span>target/classes
</span></span></code></pre></div><p>创建user-service项目，提交代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git init
</span></span><span style="display:flex;"><span>git remote add origin http://gitlab.luffy.com/luffy-spring-cloud/user-service.git
</span></span><span style="display:flex;"><span>git add .
</span></span><span style="display:flex;"><span>git commit -m <span style="color:#e6db74">&#34;Initial commit&#34;</span>
</span></span><span style="display:flex;"><span>git push -u origin master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 提交到develop分支</span>
</span></span><span style="display:flex;"><span>git checkout -b develop
</span></span><span style="display:flex;"><span>git push -u origin develop
</span></span></code></pre></div><p>创建Jenkins任务，测试自动部署</p>
<p>访问<code>http://user-service-dev.luffy.com/</code> 验证</p>
<h5 id="服务消费者">服务消费者<a hidden class="anchor" aria-hidden="true" href="#服务消费者">#</a></h5>
<h6 id="resttemplate">RestTemplate<a hidden class="anchor" aria-hidden="true" href="#resttemplate">#</a></h6>
<p>在<code>Spring</code>中，提供了<code>RestTemplate</code>。<code>RestTemplate</code>是<code>Spring</code>提供的用于访问Rest服务的客户端。而在<code>SpringCloud</code>中也是使用此服务进行服务调用的。</p>
<h6 id="创建bill-service模块">创建bill-service模块<a hidden class="anchor" aria-hidden="true" href="#创建bill-service模块">#</a></h6>
<p>新的模块初始化三部曲：</p>
<ul>
<li>pom.xml</li>
<li>启动类</li>
<li>配置文件</li>
</ul>
<p><code>pom.xml</code> 添加如下内容:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>全量内容如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;project</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;modelVersion&gt;</span>4.0.0<span style="color:#f92672">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>2.3.6.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;relativePath/&gt;</span> <span style="color:#75715e">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.luffy<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>bill-service<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.0.1-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;name&gt;</span>bill-service<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;description&gt;</span>bill-service<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;java.version&gt;</span>1.8<span style="color:#f92672">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;spring-cloud.version&gt;</span>Hoxton.SR9<span style="color:#f92672">&lt;/spring-cloud.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;groupId&gt;</span>org.junit.vintage<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;artifactId&gt;</span>junit-vintage-engine<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>${spring-cloud.version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;finalName&gt;</span>${project.artifactId}<span style="color:#f92672">&lt;/finalName&gt;</span><span style="color:#75715e">&lt;!--打jar包去掉版本号--&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/project&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>BillServiceApplication
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillServiceApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>BillService<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7001</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:bill-service}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service</span>
</span></span></code></pre></div><p>BillController</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.client.RestTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RestTemplate restTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bill/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://localhost:7000/user&#34;</span><span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>问题：</p>
<ul>
<li>服务调用采用指定IP+Port方式，注册中心未使用</li>
<li>多个服务负载均衡</li>
</ul>
<h6 id="使用注册中心实现服务调用">使用注册中心实现服务调用<a hidden class="anchor" aria-hidden="true" href="#使用注册中心实现服务调用">#</a></h6>
<p>修改BillController</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.client.RestTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@LoadBalanced</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RestTemplate restTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bill/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://user-service/user&#34;</span><span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>访问测试</p>
<p><strong>总体来说，就是通过为加入<code>@LoadBalanced</code>注解的<code>RestTemplate</code>添加一个请求拦截器，在请求前通过拦截器获取真正的请求地址，最后进行服务调用。</strong></p>
<p><strong>友情提醒：若被<code>@LoadBalanced</code>注解的<code>RestTemplate</code>访问正常的服务地址，如<code>http://127.0.0.1:8080/hello</code>时，是会提示无法找到此服务的。</strong></p>
<p>具体原因：<code>serverid</code>必须是我们访问的<code>服务名称</code> ，当我们直接输入<code>ip</code>的时候获取的<code>server</code>是<code>null</code>，就会抛出异常。</p>
<p>如果想继续调用，可以通过如下方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Qualifier<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.client.RestTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@LoadBalanced</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RestTemplate restTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;normalRestTemplate&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">normalRestTemplate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Qualifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;normalRestTemplate&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    RestTemplate normalRestTemplate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/service/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> restTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://user-service/user&#34;</span><span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/normal&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">normal</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> normalRestTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">getForObject</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://localhost:7000/user&#34;</span><span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="ribbon-负载均衡">Ribbon 负载均衡<a hidden class="anchor" aria-hidden="true" href="#ribbon-负载均衡">#</a></h6>
<p>再启动一个user-service-instance2，复制user-service项目</p>
<p>修改user-service-instance2的application.yml的server.port</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7002</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@peer1:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:user-service}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span></code></pre></div><p>修改user-service-instance2的UserController.java，为了可以区分是哪个服务提供者的实例提供的服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.userservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.userservice.entity.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PathVariable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Random<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserService</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;this is user-service-instance2&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user-nums&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">getUserNums</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">().</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>100<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//{&#34;id&#34;: 123, &#34;name&#34;: &#34;张三&#34;, &#34;age&#34;: 20, &#34;sex&#34;: &#34;male&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setAge</span><span style="color:#f92672">(</span>20<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;zhangsan&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setSex</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;male&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>访问bill-service，查看调用结果（默认是轮询策略）</p>
<p><code>Spring Cloud Ribbon</code>是一个基于Http和TCP的客服端负载均衡工具，它是基于<code>Netflix Ribbon</code>实现的。与<code>Eureka</code>配合使用时，<code>Ribbon</code>可自动从<code>Eureka Server (注册中心)</code>获取服务提供者地址列表，并基于<code>负载均衡</code>算法，通过在客户端中配置<code>ribbonServerList</code>来设置服务端列表去轮询访问以达到均衡负载的作用。</p>
<blockquote>
<p>eureka-client中包含了ribbon的包，所以不需要单独引入</p>
</blockquote>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/ribbon-lb.jpg" alt=""  />
</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/lb-cli.jpg" alt=""  />
</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/lb-server.jpg" alt=""  />
</p>
<p>如何修改调用策略？</p>
<ul>
<li>代码中指定rule的规则</li>
<li>配置文件配置</li>
</ul>
<p>在bill-service中新建package，com.luffy.rule，注意不能被springboot扫描到，不然规则就成了全局规则，所有的ribbonclient都会应用到该规则。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.rule<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.netflix.loadbalancer.*<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Configuration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomConfiguration</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IRule <span style="color:#a6e22e">ribbonRule</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// new BestAvailableRule();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// new WeightedResponseTimeRule();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RandomRule<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改BillController</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.rule.RandomConfiguration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.netflix.ribbon.RibbonClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RibbonClient</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user-service&#34;</span><span style="color:#f92672">,</span> configuration <span style="color:#f92672">=</span> RandomConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillServiceApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>BillServiceApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/ribbon-rules.jpg" alt=""  />
</p>
<p>配置文件方式： <a href="https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/#customizing-the-ribbon-client-by-setting-properties">https://docs.spring.io/spring-cloud-netflix/docs/2.2.5.RELEASE/reference/html/#customizing-the-ribbon-client-by-setting-properties</a></p>
<p>注释掉代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.ticket<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.rule.RandomConfiguration<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.netflix.ribbon.RibbonClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//@RibbonClient(name = &#34;USER-SERVICE&#34;, configuration = RandomConfiguration.class)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TicketApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>TicketApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">${SERVER_PORT:9000}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@peer1:8762/eureka/,http://admin:admin@peer2:8763/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${spring.cloud.client.ip-address}:${server.port}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">user-service</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ribbon</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NFLoadBalancerRuleClassName</span>: <span style="color:#ae81ff">com.netflix.loadbalancer.RandomRule</span>
</span></span></code></pre></div><h6 id="声明式服务feign">声明式服务Feign<a hidden class="anchor" aria-hidden="true" href="#声明式服务feign">#</a></h6>
<p>从上一章节，我们知道，当我们要调用一个服务时，需要知道服务名和api地址，这样才能进行服务调用，服务少时，这样写觉得没有什么问题，但当服务一多，接口参数很多时，上面的写法就显得不够优雅了。所以，接下来，来说说一种更好更优雅的调用服务的方式：<strong>Feign</strong>。</p>
<blockquote>
<p><code>Feign</code>是<code>Netflix</code>开发的声明式、模块化的HTTP客户端。<code>Feign</code>可帮助我们更好更快的便捷、优雅地调用<code>HTTP API</code>。</p>
</blockquote>
<p>在<code>Spring Cloud</code>中，使用<code>Feign</code>非常简单——创建一个接口，并在接口上添加一些注解。<code>Feign</code>支持多种注释，例如Feign自带的注解或者JAX-RS注解等 Spring Cloud对Feign进行了增强，使Feign支持了Spring MVC注解，并整合了Ribbon和 Eureka,从而让Feign 的使用更加方便。<strong>只需要通过创建接口并用注解来配置它既可完成对Web服务接口的绑定。</strong></p>
<p><a href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>对bill-service项目添加openfeign的依赖引入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>启动类中引入Feign注解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.openfeign.EnableFeignClients<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillServiceApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>BillServiceApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>建立interface</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.interfaces<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.billservice.entity.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.openfeign.FeignClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PathVariable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@FeignClient</span><span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user-service&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserServiceCli</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserService</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>拷贝User类到当前项目：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.entity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String sex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getAge</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getSex</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAge</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> age<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">age</span> <span style="color:#f92672">=</span> age<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSex</span><span style="color:#f92672">(</span>String sex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sex</span> <span style="color:#f92672">=</span> sex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>修改BillController</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.billservice.entity.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.billservice.interfaces.UserServiceCli<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PathVariable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserServiceCli userServiceCli<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bill/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> userServiceCli<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserService</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bill/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> userServiceCli<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//return restTemplate.getForObject(&#34;http://USER-SERVICE/user/&#34; + id, String.class);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="cicd持续交付服务消费者">CICD持续交付服务消费者<a hidden class="anchor" aria-hidden="true" href="#cicd持续交付服务消费者">#</a></h6>
<p>拷贝user-service的交付文件，替换如下：</p>
<ul>
<li>user-service  -&gt; bill-service</li>
<li>7000 -&gt; 7001</li>
<li>INGRESS_USER_SERVICE -&gt; INGRESS_BILL_SERVICE</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl -n dev edit configmap devops-config
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  INGRESS_MYBLOG: blog-dev.luffy.com
</span></span><span style="display:flex;"><span>  INGRESS_SPRINGBOOTDEMO: springboot-dev.luffy.com
</span></span><span style="display:flex;"><span>  INGRESS_USER_SERVICE: user-service-dev.luffy.com
</span></span><span style="display:flex;"><span>  INGRESS_BILL_SERVICE: user-service-dev.luffy.com
</span></span><span style="display:flex;"><span>  NAMESPACE: dev
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>创建develop分支，提交代码到gitlab仓库，验证持续交付</p>
<p>前面主要讲解了下服务消费者如何利用原生、ribbon、fegin三种方式进行服务调用的，其实每种调用方式都是使用<code>restTemplate</code>来进行调用的，只是有些进行了增强，目的是使用起来更简单高效。</p>
<h5 id="hystrix-断路器">Hystrix 断路器<a hidden class="anchor" aria-hidden="true" href="#hystrix-断路器">#</a></h5>
<p>为什么需要断路器？</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/hystrix.jpg" alt=""  />
</p>
<p>A作为服务提供者，B为A的服务消费者，C和D是B的服务消费者。A不可用引起了B的不可用，并将不可用像滚雪球一样放大到C和D时，雪崩效应就形成了。</p>
<p>因此，需要实现一种机制，可以做到自动监控服务状态并根据调用情况进行自动处理。</p>
<ul>
<li>
<p>记录时间周期内服务调用失败次数</p>
</li>
<li>
<p>维护断路器的打开、关闭、半开三种状态</p>
</li>
<li>
<p>提供fallback机制</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/netflix-hystrix.jpg" alt=""  />
</p>
</li>
</ul>
<p>修改bill-service项目：</p>
<p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>feign:
</span></span><span style="display:flex;"><span>  hystrix:
</span></span><span style="display:flex;"><span>    enabled: true
</span></span></code></pre></div><p>启动类添加注解<code>@EnableCircuitBreaker</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.openfeign.EnableFeignClients<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableCircuitBreaker</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BillServiceApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>BillServiceApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UserServiceCli<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.bill.interfaces<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.bill.entity.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.openfeign.FeignClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.PathVariable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@FeignClient</span><span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user-service&#34;</span><span style="color:#f92672">,</span> fallback <span style="color:#f92672">=</span> UserServiceFallbackImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserServiceCli</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserService</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user/{id}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UserServiceFallbackImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.billservice.interfaces<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.luffy.billservice.entity.User<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Component<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fallback&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceFallbackImpl</span> <span style="color:#66d9ef">implements</span> UserServiceCli<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUserService</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;fallback user service&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserInfo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> User<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;feign-fallback&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>停止user-service测试熔断及fallback。</p>
<h6 id="hystrix-dashboard">Hystrix Dashboard<a hidden class="anchor" aria-hidden="true" href="#hystrix-dashboard">#</a></h6>
<p>前面一章，我们讲解了如何整合<code>Hystrix</code>。而在实际情况下，使用了<code>Hystrix</code>的同时,还会对其进行实时的数据监控，反馈各类指标数据。今天我们就将讲解下<code>Hystrix Dashboard</code>和<code>Turbine</code>.其中<code>Hystrix Dashboard</code>是一款针对<code>Hystrix</code>进行实时监控的工具，通过<code>Hystrix Dashboard</code>我们可以在直观地看到各<code>Hystrix Command</code>的<strong>请求响应时间</strong>, <strong>请求成功率</strong>等数据,监控单个实例内的指标情况。后者<code>Turbine</code>，能够将多个实例指标数据进行聚合的工具。</p>
<p>在eureka注册中心处访问<code>bill-service</code>的服务<code>actuator</code>地址: <code>http://192.168.136.1:7001/actuator/info</code></p>
<p>若访问不了,需要添加如下内容:</p>
<ul>
<li>
<p>为服务消费者bill-service的pom.xml添加依赖:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>修改application.yml配置:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">management</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">endpoints</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">web</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exposure</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">include</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div></li>
</ul>
<p>访问<code>http://localhost:9000/actuator/hystrix.stream</code> 即可访问到断路器的执行状态，但是显示不太友好，因此需要dashboard。</p>
<p>新建项目，hystrix-dashboard</p>
<blockquote>
<p><code>Hystrix-dashboard(仪表盘)</code>是一款针对Hystrix进行实时监控的工具，通过<code>Hystrix Dashboard</code>我们可以在直观地看到各<code>Hystrix Command</code>的请求响应时间, 请求成功率等数据。</p>
</blockquote>
<p><code>pom.xml</code>引入依赖包：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;project</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;modelVersion&gt;</span>4.0.0<span style="color:#f92672">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>2.3.6.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;relativePath/&gt;</span> <span style="color:#75715e">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.luffy<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>hystrix-dashboard<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.0.1-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;name&gt;</span>hystrix-dashboard<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;description&gt;</span>hystrxi dashboard<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;java.version&gt;</span>1.8<span style="color:#f92672">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;spring.cloud-version&gt;</span>Hoxton.SR9<span style="color:#f92672">&lt;/spring.cloud-version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;groupId&gt;</span>org.junit.vintage<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;artifactId&gt;</span>junit-vintage-engine<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>${spring.cloud-version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/project&gt;</span>
</span></span></code></pre></div><p>启动类加上<code>@EnableHystrixDashboard</code>注解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.hystrixdashboard<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableHystrixDashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HystrixDashboardApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>HystrixDashboardApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e">#应用名称</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9696</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hystrix-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">hystrix</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dashboard</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy-stream-allow-list</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><p>访问<code>localhost:9696/hystrix</code></p>
<ul>
<li>
<p>实心圆：它有颜色和大小之分，分别代表实例的监控程度和流量大小。如上图所示，它的健康度从绿色、黄色、橙色、红色递减。通过该实心圆的展示，我们就可以在大量的实例中快速的发现故障实例和高压力实例。</p>
</li>
<li>
<p>曲线：用来记录 2 分钟内流量的相对变化，我们可以通过它来观察到流量的上升和下降趋势。</p>
</li>
<li>
<p>其他一些数量指标如下图所示</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/hystric-dashboard.jpg" alt=""  />
</p>
</li>
</ul>
<blockquote>
<p>提交代码到gitlab仓库</p>
</blockquote>
<h6 id="turbine">Turbine<a hidden class="anchor" aria-hidden="true" href="#turbine">#</a></h6>
<p><code>hystrix</code>只能实现单个微服务的监控，可是一般项目中是微服务是以集群的形式搭建，一个一个的监控不现实。而<code>Turbine</code>的原理是，<strong>建立一个<code>turbine</code>服务，并注册到<code>eureka</code>中，并发现<code>eureka</code>上的<code>hystrix</code>服务。通过配置<code>turbine</code>会自动收集所需<code>hystrix</code>的监控信息，最后通过<code>dashboard</code>展现，以达到集群监控的效果。</strong></p>
<p><strong>简单来说，就是通过注册到注册中心，发现其他服务的<code>hystrix</code>服务，然后进行聚合数据，最后通过自身的端点输出到仪表盘上进行个性化展示。这我们就监控一个<code>turbine</code>应用即可，当有新增的应用加入时，我们只需要配置下<code>turbine</code>参数即可。</strong></p>
<h5 id="微服务网关">微服务网关<a hidden class="anchor" aria-hidden="true" href="#微服务网关">#</a></h5>
<h6 id="为什么需要网关">为什么需要网关<a hidden class="anchor" aria-hidden="true" href="#为什么需要网关">#</a></h6>
<p>在微服务框架中，每个对外服务都是独立部署的，对外的api或者服务地址都不是不尽相同的。对于内部而言，很简单，通过注册中心自动感知即可。但我们大部分情况下，服务都是提供给外部系统进行调用的，不可能同享一个注册中心。同时一般上内部的微服务都是在内网的，和外界是不连通的。而且，就算我们每个微服务对外开放，对于调用者而言，调用不同的服务的地址或者参数也是不尽相同的，这样就会造成消费者客户端的复杂性，同时想想，可能微服务可能是不同的技术栈实现的，有的是<code>http</code>、<code>rpc</code>或者<code>websocket</code>等等，也会进一步加大客户端的调用难度。所以，<strong>一般上都有会有个api网关，根据请求的url不同，路由到不同的服务上去，同时入口统一了，还能进行统一的身份鉴权、日志记录、分流等操作</strong>。</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/before-gateway.png" alt=""  />
</p>
<h6 id="网关的功能">网关的功能<a hidden class="anchor" aria-hidden="true" href="#网关的功能">#</a></h6>
<ul>
<li>
<p>减少api请求次数</p>
</li>
<li>
<p>限流</p>
</li>
<li>
<p>缓存</p>
</li>
<li>
<p>统一认证</p>
</li>
<li>
<p>降低微服务的复杂度</p>
</li>
<li>
<p>支持混合通信协议(前端只和api通信，其他的由网关调用)</p>
</li>
<li>
<p>&hellip;</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/gateway-zuul.png" alt=""  />
</p>
</li>
</ul>
<h6 id="zuul实践">Zuul实践<a hidden class="anchor" aria-hidden="true" href="#zuul实践">#</a></h6>
<p>新建模块，gateway-zuul,(spring cloud)</p>
<p>pom.xml中需要引入zuul和eureka服务发现的依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-zuul<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>启动类添加注解</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.gateway<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableZuulProxy</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ZuulGatewayApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ZuulGatewayApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gateway-zuul</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:gateway-zuul}</span>
</span></span></code></pre></div><p>启动后，访问：</p>
<p>http://localhost:10000/bill-service/bill/user/1</p>
<p>http://localhost:10000/user-service/user</p>
<p>通过如下方式，配置短路径：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">zuul</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user-service</span>: <span style="color:#ae81ff">/users/**</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">bill-service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/bill/**</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service-id</span>: <span style="color:#ae81ff">bill-service</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">http://localhost:10000/users/user/1</span>
</span></span><span style="display:flex;"><span>                                                 ---<span style="color:#ae81ff">&gt;  http://localhost:7000/user/2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">http://localhost:10000/user-service/user/1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">http://localhost:10000/bill/service/user/2 </span>
</span></span><span style="display:flex;"><span>                                                 ---<span style="color:#ae81ff">&gt;http://localhost:7001/service/user/2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">http://localhost:10000/bill-service/service/user/2</span>
</span></span></code></pre></div><p>zuul如何指定对外暴漏api的path，如：</p>
<p>所有的api都是这样：<code>http://zuul-host:zuul-port/apis/</code>，可以添加<code>zuul.prefix：/apis</code></p>
<p>配置一下配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">management</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">endpoints</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">web</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exposure</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">include</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><p>可以访问到zuul的route列表， http://localhost:10000/actuator/routes/ ，添加details可以访问到详细信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/apis/users/**&#34;</span>: <span style="color:#e6db74">&#34;user-service&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/apis/bill/**&#34;</span>: <span style="color:#e6db74">&#34;bill-service&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/apis/bill-service/**&#34;</span>: <span style="color:#e6db74">&#34;bill-service&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/apis/user-service/**&#34;</span>: <span style="color:#e6db74">&#34;user-service&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>提交代码到代码仓库</p>
</blockquote>
<h5 id="集中配置中心">集中配置中心<a hidden class="anchor" aria-hidden="true" href="#集中配置中心">#</a></h5>
<p>Spring Cloud Config 配置中心提供了一个中心化的外部配置，默认使用git存储配置信息，这样就可以对配置信息进行版本管理。</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/config-server.png" alt=""  />
</p>
<h6 id="实践">实践<a hidden class="anchor" aria-hidden="true" href="#实践">#</a></h6>
<ul>
<li>创建代码仓库<code>configure-repo</code>，用于集中存储配置文件</li>
<li>创建项目<code>config-server</code>，用于接受各项目的连接，提供配置文件读取服务</li>
<li>修改<code>user-service</code>服务，验证通过<code>config-server</code>读取集中配置库中的配置文件</li>
</ul>
<p>代码仓库：</p>
<ul>
<li>
<p>新建gitlab项目，<code>http://gitlab.luffy.com/luffy-spring-cloud/configure-repo.git</code></p>
</li>
<li>
<p>准备配置文件</p>
<p><code>configs/common-dev.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">datasource</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://mysql-dev:3306/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">driverClassName</span>: <span style="color:#ae81ff">com.mysql.jdbc.Driver</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">xxx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">xxxxxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">luffy</span>: <span style="color:#ae81ff">city</span>
</span></span></code></pre></div><p><code>configs/user-service-dev.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">logging</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">level</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">org.springframework.cloud</span>: <span style="color:#ae81ff">debug</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">env</span>: <span style="color:#ae81ff">dev</span>
</span></span></code></pre></div><p><code>configs/common-test.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">env</span>: <span style="color:#ae81ff">test</span>
</span></span></code></pre></div></li>
<li>
<p>提交代码到master分支</p>
</li>
</ul>
<p>新建项目，<code>config-server</code></p>
<p>修改<code>pom.xml</code>（springboot和springcloud的版本）</p>
<ol>
<li>
<p><code>springboot</code> 版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;version&gt;</span>2.3.6.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span></code></pre></div></li>
<li>
<p><code>spring-cloud</code> 版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;java.version&gt;</span>1.8<span style="color:#f92672">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;spring-cloud.version&gt;</span>Hoxton.SR9<span style="color:#f92672">&lt;/spring-cloud.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>添加<code>config-server</code> 的依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-config-server<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
</ol>
<p>修改<code>application.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8088</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">profiles</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">active</span>: <span style="color:#ae81ff">git</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">git</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">http://gitlab.luffy.com/luffy-spring-cloud/configure-repo.git</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">username</span>: <span style="color:#ae81ff">${GIT_USER:root}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">password</span>: <span style="color:#ae81ff">${GIT_PSW:1qaz2wsx}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">default-label</span>: <span style="color:#ae81ff">master</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">search-paths</span>: <span style="color:#ae81ff">configs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#native:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#  searchLocations: classpath:/configs/{profile}</span>
</span></span></code></pre></div><p>修改启动类，添加注解</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.configserver<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.config.server.EnableConfigServer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableConfigServer</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConfigServerApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>ConfigServerApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>启动config-server,访问:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http://localhost:8088/common/dev
</span></span><span style="display:flex;"><span>http://localhost:8088/user-service/dev
</span></span></code></pre></div><p>修改<code>user-service</code>服务，从<code>config-server</code>读取配置</p>
<ul>
<li>
<p>添加使用统一配置中心的依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-config<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>新建<code>bootstrap.yml</code>，不能放在application.yml中，因为bootstrap的加载早于应用程序bean启动的加载，因此，删掉application.yml，直接使用bootstrap.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:user-service}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">http://localhost:8088</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">profile</span>: <span style="color:#ae81ff">dev </span> <span style="color:#75715e">#当前读取dev环境的配置</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service, common </span> <span style="color:#75715e"># 从user-service-dev.yml,common-dev.yml中读取</span>
</span></span></code></pre></div></li>
<li>
<p>新建<code>ValueController.java</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.userservice.controller<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.context.config.annotation.RefreshScope<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ValueController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${env}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String env<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${datasource.url}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String datasource<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${spring.application.name}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String applicationName<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/value/env&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getValueEnv</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;current env is &#34;</span> <span style="color:#f92672">+</span> env<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/value/application&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getValueApplication</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;current env is &#34;</span> <span style="color:#f92672">+</span> applicationName<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/value/datasource&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getDatasource</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> datasource<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>访问如下页面进行验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ localhost:7000/value/env
</span></span><span style="display:flex;"><span>$ localhost:7000/value/application
</span></span><span style="display:flex;"><span>$ localhost:7000/value/datasource
</span></span></code></pre></div></li>
</ul>
<h6 id="高可用-1">高可用<a hidden class="anchor" aria-hidden="true" href="#高可用-1">#</a></h6>
<p><code>config-server</code>多个实例，如何配置客户端？</p>
<ul>
<li><code>config-server</code> 作为服务提供者，注册到eureka服务注册中心</li>
<li><code>user-service</code>配置从注册中心获取config-server的服务</li>
</ul>
<p><code>config-server</code>注册到服务注册中心</p>
<ul>
<li>
<p>pom.xml添加eureka依赖包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>application.yml中连接服务注册中心</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:config-server}</span>
</span></span></code></pre></div></li>
<li>
<p>启动类添加注解</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span></code></pre></div></li>
</ul>
<p>修改<code>user-service</code>，从注册中心发现服务</p>
<ul>
<li>
<p>修改bootstrap.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">profile</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">service-id</span>: <span style="color:#ae81ff">config-server</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service, common</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@peer1:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:user-service}</span>
</span></span></code></pre></div></li>
</ul>
<h6 id="客户端配置刷新">客户端配置刷新<a hidden class="anchor" aria-hidden="true" href="#客户端配置刷新">#</a></h6>
<p>配置中心的配置变动后，客户端如何获取最新的配置。</p>
<ul>
<li>
<p>修改<code>ValueController.java</code>，添加注解</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RefreshScope</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ValueController</span> 
</span></span></code></pre></div></li>
<li>
<p>添加actuator包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>开放显示所有管理接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">management</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">endpoints</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">web</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exposure</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">include</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>重启<code>user-service</code></p>
</li>
<li>
<p>修改<code>configure-repo中的配置并提交</code>，访问<code>http://localhost:7000/value/env</code></p>
</li>
<li>
<p>执行刷新</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -XPOST http://localhost:7000/actuator/refresh
</span></span></code></pre></div></li>
<li>
<p>再次访问<code>http://localhost:7000/value/env</code></p>
</li>
</ul>
<h5 id="调用链路追踪">调用链路追踪<a hidden class="anchor" aria-hidden="true" href="#调用链路追踪">#</a></h5>
<h6 id="介绍">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍">#</a></h6>
<p>服务追踪的追踪单元是从客户发起请求（request）抵达被追踪系统的边界开始，到被追踪系统向客户返回响应（response）为止的过程，称为一个 trace。每个 trace 中会调用若干个服务，为了记录调用了哪些服务，以及每次调用的消耗时间等信息，在每次调用服务时，埋入一个调用记录，称为一个 span。这样，若干个有序的 span 就组成了一个 trace。在系统向外界提供服务的过程中，会不断地有请求和响应发生，也就会不断生成 trace，把这些带有 span 的 trace 记录下来，就可以描绘出一幅系统的服务拓扑图。附带上 span 中的响应时间，以及请求成功与否等信息，就可以在发生问题的时候，找到异常的服务；根据历史数据，还可以从系统整体层面分析出哪里性能差，定位性能优化的目标。</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/640.jpeg" alt=""  />
</p>
<p>Spring Cloud Sleuth 为服务之间调用提供链路追踪。通过 Sleuth 可以很清楚的了解到一个服务请求经过了哪些服务，每个服务处理花费了多长。从而让我们可以很方便的理清各微服务间的调用关系。此外 Sleuth 可以帮助我们：</p>
<ul>
<li>耗时分析: 通过 Sleuth 可以很方便的了解到每个采样请求的耗时，从而分析出哪些服务调用比较耗时;</li>
<li>链路优化: 对于调用比较频繁的服务，可以针对这些服务实施一些优化措施。</li>
<li>可视化错误: 对于程序未捕捉的异常，可以通过集成 Zipkin 服务界面上看到;  Spring Cloud Sleuth 可以结合 Zipkin，将信息发送到 Zipkin，利用 Zipkin 的存储来存储信息，利用 Zipkin UI 来展示数据。</li>
</ul>
<p><a href="https://zipkin.io/pages/quickstart">https://zipkin.io/pages/quickstart</a></p>
<h6 id="启动zipkin">启动zipkin<a hidden class="anchor" aria-hidden="true" href="#启动zipkin">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">openzipkin/zipkin:2.22</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9411</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">400Mi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">2000m</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9411</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9411</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">zipkin.luffy.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">zipkin</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">9411</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">loadBalancer</span>: {}
</span></span></code></pre></div><h6 id="实践-1">实践<a hidden class="anchor" aria-hidden="true" href="#实践-1">#</a></h6>
<p>分别对<code>bill-service</code>和<code>user-service</code>进行改造：</p>
<p>pom.xml中添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zipkin</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">base-url</span>: <span style="color:#ae81ff">http://zipkin.luffy.com </span> <span style="color:#75715e"># zipkin服务器的地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sender</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">web </span> <span style="color:#75715e"># 设置使用http的方式传输数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sleuth</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sampler</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">probability</span>: <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># 设置抽样采集为100%，默认为0.1，即10%</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">logging</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">level</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">org.springframework.cloud</span>: <span style="color:#ae81ff">debug</span>
</span></span></code></pre></div><p>访问zuul网关的接口<code>http://localhost:10000/apis/bill-service/bill/user/2</code></p>
<p>2020-11-14 19:28:49.274 DEBUG [bill-service,949aa3570daa1031,43ea952f1e5e36eb,true] 36852 &mdash; [-user-service-6] c.s.i.w.c.f.TraceLoadBalancerFeignClient : Before send</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>bill-service,949aa3570daa1031,43ea952f1e5e36eb,true
</span></span></code></pre></div><p>说明：</p>
<ul>
<li>bill-service： 服务名称</li>
<li>949aa3570daa1031： 是TranceId，一条链路中，只有一个TranceId</li>
<li>43ea952f1e5e36eb：则是spanId，链路中的基本工作单元id</li>
<li>true：表示是否将数据输出到其他服务，true则会把信息输出到其他可视化的服务上观察</li>
</ul>
<h5 id="springboot-admin监控">SpringBoot Admin监控<a hidden class="anchor" aria-hidden="true" href="#springboot-admin监控">#</a></h5>
<p>新建项目，<code>springboot-admin</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>pom.xml
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;project</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;modelVersion&gt;</span>4.0.0<span style="color:#f92672">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>2.3.6.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;relativePath/&gt;</span> <span style="color:#75715e">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.luffy<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>springboot-admin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.0.1-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;name&gt;</span>springboot-admin<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;description&gt;</span>Demo project for Spring Boot<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;java.version&gt;</span>1.8<span style="color:#f92672">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;spring-cloud.version&gt;</span>Hoxton.SR9<span style="color:#f92672">&lt;/spring-cloud.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>de.codecentric<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-admin-starter-server<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>2.2.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;exclusions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;exclusion&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;groupId&gt;</span>org.junit.vintage<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;artifactId&gt;</span>junit-vintage-engine<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/exclusion&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/exclusions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>${spring-cloud.version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencyManagement&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/project&gt;</span>
</span></span></code></pre></div><p>配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8769</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">springboot-admin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">serviceUrl</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">${EUREKA_SERVER:http://admin:admin@localhost:8761/eureka/}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">${eureka.instance.hostname}:${server.port}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">${INSTANCE_HOSTNAME:springboot-admin}</span>
</span></span></code></pre></div><p>启动类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.luffy.springbootadmin<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> de.codecentric.boot.admin.server.config.EnableAdminServer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableAdminServer</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringbootAdminApplication</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>SpringbootAdminApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>客户端，所有注册到eureka的服务，添加依赖即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>de.codecentric<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-admin-starter-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>2.2.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h4>
<ol>
<li>
<p>伴随着业务场景复杂度的提高，单体架构应用弊端显现，微服务的思想逐步盛行，微服务架构带来诸多便捷的同时，也带来了很多问题，最主要的是多个微服务的服务治理（服务发现、调用、负载均衡、跟踪）</p>
</li>
<li>
<p>为了解决服务治理问题，出现了微服务框架（Dubbo、Spring Cloud等）</p>
</li>
<li>
<p>Spring Cloud是一个大的生态，基于Java语言封装了一系列的工具，方便业务直接使用来解决上述服务治理相关的问题</p>
</li>
<li>
<p>Spring Cloud Netflix 体系下提供了eureka、ribbon、feign、hystrix、zuul等工具结合spring cloud sleuth合zipkin实现服务跟踪</p>
</li>
<li>
<p>SpringBoot是微服务的开发框架，通过maven与Spring Cloud生态中的组件集成，极大方便了java应用程序的交付</p>
<p><img loading="lazy" src="/images/SpringBoot%e4%b8%8eSpringCloud%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%bb%98/arch.png" alt=""  />
</p>
</li>
</ol>
<p><a href="https://blog.csdn.net/smallsunl/article/details/78778790">https://blog.csdn.net/smallsunl/article/details/78778790</a></p>
<p>问题：</p>
<ol>
<li>无论是Dubbo还是SpringCloud，均属于Java语言体系下的产物，跨语言没法共用，同时，通过走了一遍内部集成的过程，可以清楚的发现，服务治理过程中，各模块的集成，均需要对原始业务逻辑形成侵入。</li>
<li>在kubernetes的生态下，已经与生俱来带了很多好用的功能（自动服务发现与负载均衡）</li>
<li>服务治理的根本其实是网络节点通信的治理，因此，以istio为代表的第二代服务治理平台开始逐步兴起</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Eistio%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/">
    <span class="title">« 上一页</span>
    <br>
    <span>基于Istio实现微服务治理</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/%E5%9F%BA%E4%BA%8Esharedlibrary%E8%BF%9B%E8%A1%8Ccicd%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96/">
    <span class="title">下一页 »</span>
    <br>
    <span>基于sharedLibrary进行CICD流程的优化</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
