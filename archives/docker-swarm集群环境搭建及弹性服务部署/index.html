<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Docker Swarm集群环境搭建及弹性服务部署 | ylw&#39;s blog</title>
<meta name="keywords" content="docker swarm" />
<meta name="description" content="一、集群搭建 1、环境准备  五台安装了 Docker 的 CentOS 机器，版本为：CentOS 7.8.2003 Docker Engine 1.12&#43;（最低要求 1.12，本文使用 19.03.12） 防火墙开启以下端口或者关闭防火墙：  TCP 端口 2377，用于集群管理通信； TCP 和 UDP 端口 7946，用于节点之间通信； UDP 端口 4789，用于覆盖网络。　    2、机器分布    角色 IP HOSTNAME Docker 版本     Manager 192.168.10.101 manager1 19.03.12   Manager 192.168.10.102 manager2 19.03.12   Manager 192.168.10.103 manager3 19.03.12   Worker 192.168.10.10 worker1 19.03.12   Worker 192.168.10.11 worker2 19.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/docker-swarm%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%BC%B9%E6%80%A7%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="Docker Swarm集群环境搭建及弹性服务部署" />
<meta property="og:description" content="一、集群搭建 1、环境准备  五台安装了 Docker 的 CentOS 机器，版本为：CentOS 7.8.2003 Docker Engine 1.12&#43;（最低要求 1.12，本文使用 19.03.12） 防火墙开启以下端口或者关闭防火墙：  TCP 端口 2377，用于集群管理通信； TCP 和 UDP 端口 7946，用于节点之间通信； UDP 端口 4789，用于覆盖网络。　    2、机器分布    角色 IP HOSTNAME Docker 版本     Manager 192.168.10.101 manager1 19.03.12   Manager 192.168.10.102 manager2 19.03.12   Manager 192.168.10.103 manager3 19.03.12   Worker 192.168.10.10 worker1 19.03.12   Worker 192.168.10.11 worker2 19." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/docker-swarm%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%BC%B9%E6%80%A7%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-08T11:19:06&#43;08:00" />
<meta property="article:modified_time" content="2022-04-08T11:19:06&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker Swarm集群环境搭建及弹性服务部署"/>
<meta name="twitter:description" content="一、集群搭建 1、环境准备  五台安装了 Docker 的 CentOS 机器，版本为：CentOS 7.8.2003 Docker Engine 1.12&#43;（最低要求 1.12，本文使用 19.03.12） 防火墙开启以下端口或者关闭防火墙：  TCP 端口 2377，用于集群管理通信； TCP 和 UDP 端口 7946，用于节点之间通信； UDP 端口 4789，用于覆盖网络。　    2、机器分布    角色 IP HOSTNAME Docker 版本     Manager 192.168.10.101 manager1 19.03.12   Manager 192.168.10.102 manager2 19.03.12   Manager 192.168.10.103 manager3 19.03.12   Worker 192.168.10.10 worker1 19.03.12   Worker 192.168.10.11 worker2 19."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Docker Swarm集群环境搭建及弹性服务部署",
      "item": "https://iblog.zone/archives/docker-swarm%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%BC%B9%E6%80%A7%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Docker Swarm集群环境搭建及弹性服务部署",
  "name": "Docker Swarm集群环境搭建及弹性服务部署",
  "description": "一、集群搭建 1、环境准备  五台安装了 Docker 的 CentOS 机器，版本为：CentOS 7.8.2003 Docker Engine 1.12+（最低要求 1.12，本文使用 19.03.12） 防火墙开启以下端口或者关闭防火墙：  TCP 端口 2377，用于集群管理通信； TCP 和 UDP 端口 7946，用于节点之间通信； UDP 端口 4789，用于覆盖网络。　    2、机器分布    角色 IP HOSTNAME Docker 版本     Manager 192.168.10.101 manager1 19.03.12   Manager 192.168.10.102 manager2 19.03.12   Manager 192.168.10.103 manager3 19.03.12   Worker 192.168.10.10 worker1 19.03.12   Worker 192.168.10.11 worker2 19.",
  "keywords": [
    "docker swarm"
  ],
  "articleBody": "一、集群搭建 1、环境准备  五台安装了 Docker 的 CentOS 机器，版本为：CentOS 7.8.2003 Docker Engine 1.12+（最低要求 1.12，本文使用 19.03.12） 防火墙开启以下端口或者关闭防火墙：  TCP 端口 2377，用于集群管理通信； TCP 和 UDP 端口 7946，用于节点之间通信； UDP 端口 4789，用于覆盖网络。　    2、机器分布    角色 IP HOSTNAME Docker 版本     Manager 192.168.10.101 manager1 19.03.12   Manager 192.168.10.102 manager2 19.03.12   Manager 192.168.10.103 manager3 19.03.12   Worker 192.168.10.10 worker1 19.03.12   Worker 192.168.10.11 worker2 19.03.12     可以通过 hostname 主机名 修改机器的主机名（立即生效，重启后失效）； 或者 hostnamectl set-hostname 主机名 修改机器的主机名（立即生效，重启也生效）； 或者 vi /etc/hosts 编辑 hosts 文件，如下所示， 给 127.0.0.1 添加主机名（重启生效）。  127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 manager1 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 3、创建集群 　在任意节点下通过 docker swarm init 命令创建一个新的 Swarm 集群并加入，且该节点会默认成为 Manager 节点。根据我们预先定义的角色，在 101 ~ 103 的任意一台机器上运行该命令即可。\n　通常，第一个加入集群的管理节点将成为 Leader，后来加入的管理节点都是 Reachable。当前的 Leader 如果挂掉，所有的 Reachable 将重新选举一个新的 Leader。\n[root@localhost ~]# docker swarm init --advertise-addr 192.168.10.101 Swarm initialized: current node (clumstpieg0qzzxt1caeazg8g) is now a manager.  To add a worker to this swarm, run the following command:   docker swarm join --token SWMTKN-1-5ob7jlej85qsygxubqypjuftiwruvew8e2cr4u3iuo4thxyrhg-3hbf2u3i1iagurdprl3n3yra1 192.168.10.101:2377  To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions. 4、加入集群 　Docker 中内置的集群模式自带了公钥基础设施(PKI)系统，使得安全部署容器变得简单。集群中的节点使用传输层安全协议(TLS)对集群中其他节点的通信进行身份验证、授权和加密。\n　默认情况下，通过 docker swarm init 命令创建一个新的 Swarm 集群时，Manager 节点会生成新的根证书颁发机构（CA）和密钥对，用于保护与加入群集的其他节点之间的通信安全。\n　Manager 节点会生成两个令牌，供其他节点加入集群时使用：一个 Worker 令牌，一个 Manager 令牌。每个令牌都包括根 CA 证书的摘要和随机生成的密钥。当节点加入群集时，加入的节点使用摘要来验证来自远程管理节点的根 CA 证书。远程管理节点使用密钥来确保加入的节点是批准的节点。\nManager\n　若要向该集群添加 Manager 节点，管理节点先运行 docker swarm join-token manager 命令查看管理节点的令牌信息。\ndocker swarm join-token manager 　然后在其他节点上运行 docker swarm join 并携带令牌参数加入 Swarm 集群，该节点角色为 Manager。\nWorker\n　通过创建集群时返回的结果可以得知，要向这个集群添加一个 Worker 节点，运行下图中的命令即可。或者管理节点先运行 docker swarm join-token worker 命令查看工作节点的令牌信息。\n　然后在其他节点上运行 docker swarm join 并携带令牌参数加入 Swarm 集群，该节点角色为 Worker。\n5、查看集群信息 　在任意 Manager 节点中运行 docker info 可以查看当前集群的信息。\n6、查看集群节点 　在任意 Manager 节点中运行 docker node ls 可以查看当前集群节点信息。\ndocker node ls  * 代表当前节点，现在的环境为 3 个管理节点构成 1 主 2 从，以及 2 个工作节点。\n 　节点 MANAGER STATUS 说明：表示节点是属于 Manager 还是 Worker，没有值则属于 Worker 节点。\n Leader：该节点是管理节点中的主节点，负责该集群的集群管理和编排决策； Reachable：该节点是管理节点中的从节点，如果 Leader 节点不可用，该节点有资格被选为新的 Leader； Unavailable：该管理节点已不能与其他管理节点通信。如果管理节点不可用，应该将新的管理节点加入群集，或者将工作节点升级为管理节点。　  　节点 AVAILABILITY 说明：表示调度程序是否可以将任务分配给该节点。\n Active：调度程序可以将任务分配给该节点； Pause：调度程序不会将新任务分配给该节点，但现有任务仍可以运行； Drain：调度程序不会将新任务分配给该节点，并且会关闭该节点所有现有任务，并将它们调度在可用的节点上。  7、删除节点　 Manager\n　删除节点之前需要先将该节点的 AVAILABILITY 改为 Drain。其目的是为了将该节点的服务迁移到其他可用节点上，确保服务正常。最好检查一下容器迁移情况，确保这一步已经处理完成再继续往下。\ndocker node update --availability drain 节点名称|节点ID 　然后，将该 Manager 节点进行降级处理，降级为 Worker 节点。\ndocker node demote 节点名称|节点ID 　然后，在已经降级为 Worker 的节点中运行以下命令，离开集群。\ndocker swarm leave 　最后，在管理节点中对刚才离开的节点进行删除。\ndocker node rm 节点名称|节点ID Worker　　删除节点之前需要先将该节点的 AVAILABILITY 改为 Drain。其目的是为了将该节点的服务迁移到其他可用节点上，确保服务正常。最好检查一下容器迁移情况，确保这一步已经处理完成再继续往下。\ndocker node update --availability drain 节点名称|节点ID 　然后，在准备删除的 Worker 节点中运行以下命令，离开集群。\ndocker swarm leave 　最后，在管理节点中对刚才离开的节点进行删除。\ndocker node rm 节点名称|节点ID 二、服务部署  注意：跟集群管理有关的任何操作，都是在 Manager 节点上操作的。\n 1、创建服务 　下面这个案例，使用 nginx 镜像创建了一个名为 mynginx 的服务，该服务会被随机指派给一个工作节点运行。\ndocker service create --replicas 1 --name mynginx -p 80:80 nginx  docker service create：创建服务； --replicas：指定一个服务有几个实例运行； --name：服务名称。  2、查看服务 　可以通过 docker service ls 查看运行的服务。\n[root@manager1 ~]# docker service ls ID NAME MODE REPLICAS IMAGE PORTS hepx06k5ik5n mynginx replicated 1/1 nginx:latest *:80-80/tcp 　可以通过 docker service inspect 服务名称|服务ID 查看服务的详细信息。\n[root@manager1 ~]# docker service inspect mynginx [  {  \"ID\": \"k0dbjg1zzy3l3g71kdwa56ect\",  \"Version\": {  \"Index\": 127  },  \"CreatedAt\": \"2020-09-16T10:05:55.627974095Z\",  \"UpdatedAt\": \"2020-09-16T10:05:55.629507771Z\",  \"Spec\": {  \"Name\": \"mynginx\",  \"Labels\": {},  \"TaskTemplate\": {  \"ContainerSpec\": {  \"Image\": \"nginx:latest@sha256:c628b67d21744fce822d22fdcc0389f6bd763daac23a6b77147d0712ea7102d0\",  \"Init\": false,  \"StopGracePeriod\": 10000000000,  \"DNSConfig\": {},  \"Isolation\": \"default\"  },  \"Resources\": {  \"Limits\": {},  \"Reservations\": {}  },  \"RestartPolicy\": {  \"Condition\": \"any\",  \"Delay\": 5000000000,  \"MaxAttempts\": 0  },  \"Placement\": {  \"Platforms\": [  {  \"Architecture\": \"amd64\",  \"OS\": \"linux\"  },  {  \"OS\": \"linux\"  },  {  \"OS\": \"linux\"  },  {  \"Architecture\": \"arm64\",  \"OS\": \"linux\"  },  {  \"Architecture\": \"386\",  \"OS\": \"linux\"  },  {  \"Architecture\": \"mips64le\",  \"OS\": \"linux\"  },  {  \"Architecture\": \"ppc64le\",  \"OS\": \"linux\"  },  {  \"Architecture\": \"s390x\",  \"OS\": \"linux\"  }  ]  },  \"ForceUpdate\": 0,  \"Runtime\": \"container\"  },  \"Mode\": {  \"Replicated\": {  \"Replicas\": 1  }  },  \"UpdateConfig\": {  \"Parallelism\": 1,  \"FailureAction\": \"pause\",  \"Monitor\": 5000000000,  \"MaxFailureRatio\": 0,  \"Order\": \"stop-first\"  },  \"RollbackConfig\": {  \"Parallelism\": 1,  \"FailureAction\": \"pause\",  \"Monitor\": 5000000000,  \"MaxFailureRatio\": 0,  \"Order\": \"stop-first\"  },  \"EndpointSpec\": {  \"Mode\": \"vip\",  \"Ports\": [  {  \"Protocol\": \"tcp\",  \"TargetPort\": 80,  \"PublishedPort\": 80,  \"PublishMode\": \"ingress\"  }  ]  }  },  \"Endpoint\": {  \"Spec\": {  \"Mode\": \"vip\",  \"Ports\": [  {  \"Protocol\": \"tcp\",  \"TargetPort\": 80,  \"PublishedPort\": 80,  \"PublishMode\": \"ingress\"  }  ]  },  \"Ports\": [  {  \"Protocol\": \"tcp\",  \"TargetPort\": 80,  \"PublishedPort\": 80,  \"PublishMode\": \"ingress\"  }  ],  \"VirtualIPs\": [  {  \"NetworkID\": \"st2xiy7pjzap093wz4w4u6nbs\",  \"Addr\": \"10.0.0.15/24\"  }  ]  }  } ]　　可以通过 docker service ps 服务名称|服务ID 查看服务运行在哪些节点上。\n　在对应的任务节点上运行 docker ps 可以查看该服务对应容器的相关信息。\n3、调用服务 　接下来我们测试一下服务是否能被正常访问，并且该集群下任意节点的 IP 地址都要能访问到该服务才行。\n　测试结果：5 台机器均可正常访问到该服务。\n4、弹性服务 　将 service 部署到集群以后，可以通过命令弹性扩缩容 service 中的容器数量。在 service 中运行的容器被称为 task（任务）。\n　通过 docker service scale 服务名称|服务ID=n 可以将 service 运行的任务扩缩容为 n 个。\n　通过 docker service update --replicas n 服务名称|服务ID 也可以达到扩缩容的效果。\n　将 mynginx service 运行的任务扩展为 5 个：\n[root@manager1 ~]# docker service scale mynginx=5 mynginx scaled to 5 overall progress: 5 out of 5 tasks 1/5: running [==================================================] 2/5: running [==================================================] 3/5: running [==================================================] 4/5: running [==================================================] 5/5: running [==================================================] verify: Service converged 　通过 docker service ps 服务名称|服务ID 查看服务运行在哪些节点上。\n　我们再来一波缩容的操作，命令如下：\n[root@manager1 ~]# docker service update --replicas 3 mynginx mynginx overall progress: 3 out of 3 tasks 1/3: running [==================================================] 2/3: running [==================================================] 3/3: running [==================================================] verify: Service converged 　通过 docker service ps 服务名称|服务ID 查看服务运行在哪些节点上。\n　在 Swarm 集群模式下真正意义实现了所谓的弹性服务，动态扩缩容一行命令搞定，简单、便捷、强大。\n5、删除服务 　通过 docker service rm 服务名称|服务ID 即可删除服务。\n[root@manager1 ~]# docker service rm mynginx mynginx [root@manager1 ~]# docker service ls ID NAME MODE REPLICAS IMAGE PORTS 三、滚动更新及回滚 　以下案例将演示 Redis 版本如何滚动升级至更高版本再回滚至上一次的操作。\n　首先，创建 5 个 Redis 服务副本，版本为 5，详细命令如下：\n# 创建 5 个副本，每次更新 2 个，更新间隔 10s，20% 任务失败继续执行，超出 20% 执行回滚，每次回滚 2 个 docker service create --replicas 5 --name redis \\ --update-delay 10s \\ --update-parallelism 2 \\ --update-failure-action continue \\ --rollback-monitor 20s \\ --rollback-parallelism 2 \\ --rollback-max-failure-ratio 0.2 \\ redis:5  --update-delay：定义滚动更新的时间间隔； --update-parallelism：定义并行更新的副本数量，默认为 1； --update-failure-action：定义容器启动失败之后所执行的动作； --rollback-monitor：定义回滚的监控时间； --rollback-parallelism：定义并行回滚的副本数量； --rollback-max-failure-ratio：任务失败回滚比率，超过该比率执行回滚操作，0.2 表示 20%。  　然后通过以下命令实现服务的滚动更新。\ndocker service update --image redis:6 redis 　回滚服务，只能回滚到上一次操作的状态，并不能连续回滚到指定操作。\ndocker service update --rollback redis 四、常用命令 1、docker swarm    命令 说明     docker swarm init 初始化集群   docker swarm join-token worker 查看工作节点的 token   docker swarm join-token manager 查看管理节点的 token   docker swarm join 加入集群    2、docker node    命令 说明     docker node ls 查看集群所有节点   docker node ps 查看当前节点所有任务   docker node rm 节点名称|节点ID 删除节点（-f强制删除）   docker node inspect 节点名称|节点ID 查看节点详情   docker node demote 节点名称|节点ID 节点降级，由管理节点降级为工作节点   docker node promote 节点名称|节点ID 节点升级，由工作节点升级为管理节点   docker node update 节点名称|节点ID 更新节点    3、docker service    命令 说明     docker service create 创建服务   docker service ls 查看所有服务   docker service inspect 服务名称|服务ID 查看服务详情   docker service logs 服务名称|服务ID 查看服务日志   docker service rm 服务名称|服务ID 删除服务（-f强制删除）   docker service scale 服务名称|服务ID=n 设置服务数量   docker service update 服务名称|服务ID 更新服务    五、参考资料  https://docs.docker.com/engine/swarm/swarm-tutorial/ https://docs.docker.com/engine/swarm/swarm-mode/ https://docs.docker.com/engine/swarm/how-swarm-mode-works/pki/ https://docs.docker.com/engine/swarm/join-nodes/ https://docs.docker.com/engine/swarm/swarm-tutorial/rolling-update/  ",
  "wordCount" : "905",
  "inLanguage": "zh",
  "datePublished": "2022-04-08T11:19:06+08:00",
  "dateModified": "2022-04-08T11:19:06+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/docker-swarm%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%BC%B9%E6%80%A7%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      Docker Swarm集群环境搭建及弹性服务部署
    </h1>
    <div class="post-meta"><span title='2022-04-08 11:19:06 +0800 CST'>2022-04-08</span>&nbsp;·&nbsp;5 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e4%b8%80%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba" aria-label="一、集群搭建">一、集群搭建</a><ul>
                            
                    <li>
                        <a href="#1%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" aria-label="1、环境准备">1、环境准备</a></li>
                    <li>
                        <a href="#2%e6%9c%ba%e5%99%a8%e5%88%86%e5%b8%83" aria-label="2、机器分布">2、机器分布</a></li>
                    <li>
                        <a href="#3%e5%88%9b%e5%bb%ba%e9%9b%86%e7%be%a4" aria-label="3、创建集群">3、创建集群</a></li>
                    <li>
                        <a href="#4%e5%8a%a0%e5%85%a5%e9%9b%86%e7%be%a4" aria-label="4、加入集群">4、加入集群</a></li>
                    <li>
                        <a href="#5%e6%9f%a5%e7%9c%8b%e9%9b%86%e7%be%a4%e4%bf%a1%e6%81%af" aria-label="5、查看集群信息">5、查看集群信息</a></li>
                    <li>
                        <a href="#6%e6%9f%a5%e7%9c%8b%e9%9b%86%e7%be%a4%e8%8a%82%e7%82%b9" aria-label="6、查看集群节点">6、查看集群节点</a></li>
                    <li>
                        <a href="#7%e5%88%a0%e9%99%a4%e8%8a%82%e7%82%b9" aria-label="7、删除节点　">7、删除节点　</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%8c%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2" aria-label="二、服务部署">二、服务部署</a><ul>
                            
                    <li>
                        <a href="#1%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1" aria-label="1、创建服务">1、创建服务</a></li>
                    <li>
                        <a href="#2%e6%9f%a5%e7%9c%8b%e6%9c%8d%e5%8a%a1" aria-label="2、查看服务">2、查看服务</a></li>
                    <li>
                        <a href="#3%e8%b0%83%e7%94%a8%e6%9c%8d%e5%8a%a1" aria-label="3、调用服务">3、调用服务</a></li>
                    <li>
                        <a href="#4%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1" aria-label="4、弹性服务">4、弹性服务</a></li>
                    <li>
                        <a href="#5%e5%88%a0%e9%99%a4%e6%9c%8d%e5%8a%a1" aria-label="5、删除服务">5、删除服务</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%89%e6%bb%9a%e5%8a%a8%e6%9b%b4%e6%96%b0%e5%8f%8a%e5%9b%9e%e6%bb%9a" aria-label="三、滚动更新及回滚">三、滚动更新及回滚</a></li>
                    <li>
                        <a href="#%e5%9b%9b%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4" aria-label="四、常用命令">四、常用命令</a><ul>
                            
                    <li>
                        <a href="#1docker-swarm" aria-label="1、docker swarm">1、docker swarm</a></li>
                    <li>
                        <a href="#2docker-node" aria-label="2、docker node">2、docker node</a></li>
                    <li>
                        <a href="#3docker-service" aria-label="3、docker service">3、docker service</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%ba%94%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" aria-label="五、参考资料">五、参考资料</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h2 id="一集群搭建">一、集群搭建<a hidden class="anchor" aria-hidden="true" href="#一集群搭建">#</a></h2>
<h3 id="1环境准备">1、环境准备<a hidden class="anchor" aria-hidden="true" href="#1环境准备">#</a></h3>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/4652b366ab674e25b0859db1fe2c8381_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<ul>
<li>五台安装了 Docker 的 CentOS 机器，版本为：<code>CentOS 7.8.2003</code></li>
<li>Docker Engine 1.12+（最低要求 1.12，本文使用 19.03.12）</li>
<li>防火墙开启以下端口或者关闭防火墙：
<ul>
<li>TCP 端口 2377，用于集群管理通信；</li>
<li>TCP 和 UDP 端口 7946，用于节点之间通信；</li>
<li>UDP 端口 4789，用于覆盖网络。　</li>
</ul>
</li>
</ul>
<h3 id="2机器分布">2、机器分布<a hidden class="anchor" aria-hidden="true" href="#2机器分布">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">角色</th>
<th style="text-align:left">IP</th>
<th style="text-align:left">HOSTNAME</th>
<th style="text-align:left">Docker 版本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Manager</td>
<td style="text-align:left">192.168.10.101</td>
<td style="text-align:left">manager1</td>
<td style="text-align:left">19.03.12</td>
</tr>
<tr>
<td style="text-align:left">Manager</td>
<td style="text-align:left">192.168.10.102</td>
<td style="text-align:left">manager2</td>
<td style="text-align:left">19.03.12</td>
</tr>
<tr>
<td style="text-align:left">Manager</td>
<td style="text-align:left">192.168.10.103</td>
<td style="text-align:left">manager3</td>
<td style="text-align:left">19.03.12</td>
</tr>
<tr>
<td style="text-align:left">Worker</td>
<td style="text-align:left">192.168.10.10</td>
<td style="text-align:left">worker1</td>
<td style="text-align:left">19.03.12</td>
</tr>
<tr>
<td style="text-align:left">Worker</td>
<td style="text-align:left">192.168.10.11</td>
<td style="text-align:left">worker2</td>
<td style="text-align:left">19.03.12</td>
</tr>
</tbody>
</table>
<ul>
<li>可以通过 <code>hostname 主机名</code> 修改机器的主机名（立即生效，重启后失效）；</li>
<li>或者 <code>hostnamectl set-hostname 主机名</code> 修改机器的主机名（立即生效，重启也生效）；</li>
<li>或者 <code>vi /etc/hosts</code> 编辑 hosts 文件，如下所示， 给 127.0.0.1 添加主机名（重启生效）。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 manager1
</span></span><span style="display:flex;"><span>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span></code></pre></div><h3 id="3创建集群">3、创建集群<a hidden class="anchor" aria-hidden="true" href="#3创建集群">#</a></h3>
<p>　　在任意节点下通过 <code>docker swarm init</code> 命令创建一个新的 Swarm 集群并加入，且该节点会默认成为 Manager 节点。根据我们预先定义的角色，在 101 ~ 103 的任意一台机器上运行该命令即可。</p>
<p>　　通常，第一个加入集群的管理节点将成为 <code>Leader</code>，后来加入的管理节点都是 <code>Reachable</code>。当前的 Leader 如果挂掉，所有的 Reachable 将重新选举一个新的 Leader。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@localhost ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker swarm init --advertise-addr 192.168.10.101</span>
</span></span><span style="display:flex;"><span>Swarm initialized: current node <span style="color:#f92672">(</span>clumstpieg0qzzxt1caeazg8g<span style="color:#f92672">)</span> is now a manager.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a worker to this swarm, run the following command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    docker swarm join --token SWMTKN-1-5ob7jlej85qsygxubqypjuftiwruvew8e2cr4u3iuo4thxyrhg-3hbf2u3i1iagurdprl3n3yra1 192.168.10.101:2377
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a manager to this swarm, run <span style="color:#e6db74">&#39;docker swarm join-token manager&#39;</span> and follow the instructions.
</span></span></code></pre></div><p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/4a2bba0743504b14a4b3a96ce06bb534_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<h3 id="4加入集群">4、加入集群<a hidden class="anchor" aria-hidden="true" href="#4加入集群">#</a></h3>
<p>　　Docker 中内置的集群模式自带了公钥基础设施(PKI)系统，使得安全部署容器变得简单。集群中的节点使用传输层安全协议(TLS)对集群中其他节点的通信进行身份验证、授权和加密。</p>
<p>　　默认情况下，通过 <code>docker swarm init</code> 命令创建一个新的 Swarm 集群时，Manager 节点会生成新的根证书颁发机构（CA）和密钥对，用于保护与加入群集的其他节点之间的通信安全。</p>
<p>　　Manager 节点会生成两个令牌，供其他节点加入集群时使用：一个 Worker 令牌，一个 Manager 令牌。每个令牌都包括根 CA 证书的摘要和随机生成的密钥。当节点加入群集时，加入的节点使用摘要来验证来自远程管理节点的根 CA 证书。远程管理节点使用密钥来确保加入的节点是批准的节点。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/b2ef66975e154909bb9e86e9281ebd41_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
　　</p>
<p><strong>Manager</strong></p>
<p>　　若要向该集群添加 Manager 节点，管理节点先运行 <code>docker swarm join-token manager</code> 命令查看管理节点的令牌信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker swarm join-token manager
</span></span></code></pre></div><p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/2b6d03076e304b3a8a321044cbc8c85a_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/420a31db7d9145fe9905a32f94f73fa8_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
　　</p>
<p>　　然后在其他节点上运行 <code>docker swarm join</code> 并携带令牌参数加入 Swarm 集群，该节点角色为 Manager。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/aeeb38860ef84940a5fa5464cca8f217_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/520968b3dc3e434c8221afdfee0403ba_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<p><strong>Worker</strong></p>
<p>　　通过创建集群时返回的结果可以得知，要向这个集群添加一个 Worker 节点，运行下图中的命令即可。或者管理节点先运行 <code>docker swarm join-token worker</code> 命令查看工作节点的令牌信息。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/5df1108aa50b4cf994d9cb38b1273d56_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
　</p>
<p>　　然后在其他节点上运行 <code>docker swarm join</code> 并携带令牌参数加入 Swarm 集群，该节点角色为 Worker。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/2f1f4ef9d23b4546a1f183190218e4e9_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/d7ee43717c4843f4b5ce71037fd4092b_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<h3 id="5查看集群信息">5、查看集群信息<a hidden class="anchor" aria-hidden="true" href="#5查看集群信息">#</a></h3>
<p>　　在任意 Manager 节点中运行 <code>docker info</code> 可以查看当前集群的信息。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/335d15d8e7704c7db789a37f024c990e_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<h3 id="6查看集群节点">6、查看集群节点<a hidden class="anchor" aria-hidden="true" href="#6查看集群节点">#</a></h3>
<p>　　在任意 Manager 节点中运行 <code>docker node ls</code> 可以查看当前集群节点信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker node ls
</span></span></code></pre></div><p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/7e1d31dea43d4b05af8ea9bcdb93baeb_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<blockquote>
<p><code>*</code> 代表当前节点，现在的环境为 3 个管理节点构成 1 主 2 从，以及 2 个工作节点。</p>
</blockquote>
<p>　　节点 <code>MANAGER STATUS</code> 说明：表示节点是属于 Manager 还是 Worker，没有值则属于 Worker 节点。</p>
<ul>
<li><code>Leader</code>：该节点是管理节点中的主节点，负责该集群的集群管理和编排决策；</li>
<li><code>Reachable</code>：该节点是管理节点中的从节点，如果 Leader 节点不可用，该节点有资格被选为新的 Leader；</li>
<li><code>Unavailable</code>：该管理节点已不能与其他管理节点通信。如果管理节点不可用，应该将新的管理节点加入群集，或者将工作节点升级为管理节点。　</li>
</ul>
<p>　　节点 <code>AVAILABILITY</code> 说明：表示调度程序是否可以将任务分配给该节点。</p>
<ul>
<li><code>Active</code>：调度程序可以将任务分配给该节点；</li>
<li><code>Pause</code>：调度程序不会将新任务分配给该节点，但现有任务仍可以运行；</li>
<li><code>Drain</code>：调度程序不会将新任务分配给该节点，并且会关闭该节点所有现有任务，并将它们调度在可用的节点上。</li>
</ul>
<h3 id="7删除节点">7、删除节点　<a hidden class="anchor" aria-hidden="true" href="#7删除节点">#</a></h3>
<p><strong>Manager</strong></p>
<p>　　删除节点之前需要先将该节点的 <code>AVAILABILITY</code> 改为 <code>Drain</code>。其目的是为了将该节点的服务迁移到其他可用节点上，确保服务正常。最好检查一下容器迁移情况，确保这一步已经处理完成再继续往下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker node update --availability drain 节点名称|节点ID
</span></span></code></pre></div><p>　　然后，将该 Manager 节点进行降级处理，降级为 Worker 节点。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker node demote 节点名称|节点ID
</span></span></code></pre></div><p>　　然后，在已经降级为 Worker 的节点中运行以下命令，离开集群。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker swarm leave
</span></span></code></pre></div><p>　　最后，在管理节点中对刚才离开的节点进行删除。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker node rm 节点名称|节点ID
</span></span></code></pre></div><p><strong>Worker</strong>　　</p>
<p>　　删除节点之前需要先将该节点的 <code>AVAILABILITY</code> 改为 <code>Drain</code>。其目的是为了将该节点的服务迁移到其他可用节点上，确保服务正常。最好检查一下容器迁移情况，确保这一步已经处理完成再继续往下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker node update --availability drain 节点名称|节点ID
</span></span></code></pre></div><p>　　然后，在准备删除的 Worker 节点中运行以下命令，离开集群。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker swarm leave
</span></span></code></pre></div><p>　　最后，在管理节点中对刚才离开的节点进行删除。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker node rm 节点名称|节点ID
</span></span></code></pre></div><h2 id="二服务部署">二、服务部署<a hidden class="anchor" aria-hidden="true" href="#二服务部署">#</a></h2>
<blockquote>
<p>注意：跟集群管理有关的任何操作，都是在 Manager 节点上操作的。</p>
</blockquote>
<h3 id="1创建服务">1、创建服务<a hidden class="anchor" aria-hidden="true" href="#1创建服务">#</a></h3>
<p>　　下面这个案例，使用 nginx 镜像创建了一个名为 mynginx 的服务，该服务会被随机指派给一个工作节点运行。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker service create --replicas <span style="color:#ae81ff">1</span> --name mynginx -p 80:80 nginx
</span></span></code></pre></div><p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/aad553ce2562402bb0bd2fca5a63418e_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<ul>
<li><code>docker service create</code>：创建服务；</li>
<li><code>--replicas</code>：指定一个服务有几个实例运行；</li>
<li><code>--name</code>：服务名称。</li>
</ul>
<h3 id="2查看服务">2、查看服务<a hidden class="anchor" aria-hidden="true" href="#2查看服务">#</a></h3>
<p>　　可以通过 <code>docker service ls</code> 查看运行的服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@manager1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service ls</span>
</span></span><span style="display:flex;"><span>ID                NAME           MODE              REPLICAS        IMAGE              PORTS
</span></span><span style="display:flex;"><span>hepx06k5ik5n      mynginx        replicated        1/1             nginx:latest       *:80-&gt;80/tcp
</span></span></code></pre></div><p>　　可以通过 <code>docker service inspect 服务名称|服务ID</code> 查看服务的详细信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@manager1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service inspect mynginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ID&#34;</span>: <span style="color:#e6db74">&#34;k0dbjg1zzy3l3g71kdwa56ect&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Index&#34;</span>: <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2020-09-16T10:05:55.627974095Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;UpdatedAt&#34;</span>: <span style="color:#e6db74">&#34;2020-09-16T10:05:55.629507771Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Spec&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mynginx&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;TaskTemplate&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ContainerSpec&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Image&#34;</span>: <span style="color:#e6db74">&#34;nginx:latest@sha256:c628b67d21744fce822d22fdcc0389f6bd763daac23a6b77147d0712ea7102d0&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Init&#34;</span>: false,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;StopGracePeriod&#34;</span>: 10000000000,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;DNSConfig&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Isolation&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Resources&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Limits&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Reservations&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;RestartPolicy&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Condition&#34;</span>: <span style="color:#e6db74">&#34;any&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Delay&#34;</span>: 5000000000,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;MaxAttempts&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Placement&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Platforms&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;Architecture&#34;</span>: <span style="color:#e6db74">&#34;amd64&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;Architecture&#34;</span>: <span style="color:#e6db74">&#34;arm64&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;Architecture&#34;</span>: <span style="color:#e6db74">&#34;386&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;Architecture&#34;</span>: <span style="color:#e6db74">&#34;mips64le&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;Architecture&#34;</span>: <span style="color:#e6db74">&#34;ppc64le&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;Architecture&#34;</span>: <span style="color:#e6db74">&#34;s390x&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;OS&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ForceUpdate&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Runtime&#34;</span>: <span style="color:#e6db74">&#34;container&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Mode&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Replicated&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Replicas&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;UpdateConfig&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Parallelism&#34;</span>: 1,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;FailureAction&#34;</span>: <span style="color:#e6db74">&#34;pause&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Monitor&#34;</span>: 5000000000,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MaxFailureRatio&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Order&#34;</span>: <span style="color:#e6db74">&#34;stop-first&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;RollbackConfig&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Parallelism&#34;</span>: 1,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;FailureAction&#34;</span>: <span style="color:#e6db74">&#34;pause&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Monitor&#34;</span>: 5000000000,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MaxFailureRatio&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Order&#34;</span>: <span style="color:#e6db74">&#34;stop-first&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;EndpointSpec&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Mode&#34;</span>: <span style="color:#e6db74">&#34;vip&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Ports&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;Protocol&#34;</span>: <span style="color:#e6db74">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;TargetPort&#34;</span>: 80,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;PublishedPort&#34;</span>: 80,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;PublishMode&#34;</span>: <span style="color:#e6db74">&#34;ingress&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Endpoint&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Spec&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Mode&#34;</span>: <span style="color:#e6db74">&#34;vip&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Ports&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;Protocol&#34;</span>: <span style="color:#e6db74">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;TargetPort&#34;</span>: 80,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;PublishedPort&#34;</span>: 80,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;PublishMode&#34;</span>: <span style="color:#e6db74">&#34;ingress&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Ports&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Protocol&#34;</span>: <span style="color:#e6db74">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;TargetPort&#34;</span>: 80,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;PublishedPort&#34;</span>: 80,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;PublishMode&#34;</span>: <span style="color:#e6db74">&#34;ingress&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;VirtualIPs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;NetworkID&#34;</span>: <span style="color:#e6db74">&#34;st2xiy7pjzap093wz4w4u6nbs&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Addr&#34;</span>: <span style="color:#e6db74">&#34;10.0.0.15/24&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>　
</span></span></code></pre></div><p>　　可以通过 <code>docker service ps 服务名称|服务ID</code> 查看服务运行在哪些节点上。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/1d008646799b4725a0e03e0a695ea9fe_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<p>　　在对应的任务节点上运行 <code>docker ps</code> 可以查看该服务对应容器的相关信息。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/e0b363efa08943e2b37c453a11bcb5ca_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<h3 id="3调用服务">3、调用服务<a hidden class="anchor" aria-hidden="true" href="#3调用服务">#</a></h3>
<p>　　接下来我们测试一下服务是否能被正常访问，并且该集群下任意节点的 IP 地址都要能访问到该服务才行。</p>
<p>　　测试结果：5 台机器均可正常访问到该服务。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/d5fc6e8278734897a5c1e26a6d9fee84_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<h3 id="4弹性服务">4、弹性服务<a hidden class="anchor" aria-hidden="true" href="#4弹性服务">#</a></h3>
<p>　　将 service 部署到集群以后，可以通过命令弹性扩缩容 service 中的容器数量。在 service 中运行的容器被称为 task（任务）。</p>
<p>　　通过 <code>docker service scale 服务名称|服务ID=n</code> 可以将 service 运行的任务扩缩容为 n 个。</p>
<p>　　通过 <code>docker service update --replicas n 服务名称|服务ID</code> 也可以达到扩缩容的效果。</p>
<p>　　将 mynginx service 运行的任务扩展为 5 个：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@manager1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service scale mynginx=5</span>
</span></span><span style="display:flex;"><span>mynginx scaled to <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">5</span> out of <span style="color:#ae81ff">5</span> tasks 
</span></span><span style="display:flex;"><span>1/5: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>2/5: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>3/5: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>4/5: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>5/5: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span></code></pre></div><p>　　通过 <code>docker service ps 服务名称|服务ID</code> 查看服务运行在哪些节点上。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/723dacc2444743f2869d2d049d874999_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
　　</p>
<p>　　我们再来一波缩容的操作，命令如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@manager1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service update --replicas 3 mynginx</span>
</span></span><span style="display:flex;"><span>mynginx
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">3</span> out of <span style="color:#ae81ff">3</span> tasks 
</span></span><span style="display:flex;"><span>1/3: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>2/3: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>3/3: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span></code></pre></div><p>　　通过 <code>docker service ps 服务名称|服务ID</code> 查看服务运行在哪些节点上。</p>
<p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/2e4143a1a803412eb628447807b05bd9_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<p>　　在 Swarm 集群模式下真正意义实现了所谓的<strong>弹性服务</strong>，动态扩缩容一行命令搞定，简单、便捷、强大。</p>
<h3 id="5删除服务">5、删除服务<a hidden class="anchor" aria-hidden="true" href="#5删除服务">#</a></h3>
<p>　　通过 <code>docker service rm 服务名称|服务ID</code> 即可删除服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@manager1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service rm mynginx</span>
</span></span><span style="display:flex;"><span>mynginx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@manager1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># docker service ls</span>
</span></span><span style="display:flex;"><span>ID                NAME              MODE              REPLICAS          IMAGE             PORTS
</span></span></code></pre></div><h2 id="三滚动更新及回滚">三、滚动更新及回滚<a hidden class="anchor" aria-hidden="true" href="#三滚动更新及回滚">#</a></h2>
<p>　　以下案例将演示 Redis 版本如何滚动升级至更高版本再回滚至上一次的操作。</p>
<p>　　首先，创建 5 个 Redis 服务副本，版本为 5，详细命令如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建 5 个副本，每次更新 2 个，更新间隔 10s，20% 任务失败继续执行，超出 20% 执行回滚，每次回滚 2 个</span>
</span></span><span style="display:flex;"><span>docker service create --replicas <span style="color:#ae81ff">5</span> --name redis <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--update-delay 10s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--update-parallelism <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--update-failure-action <span style="color:#66d9ef">continue</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--rollback-monitor 20s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--rollback-parallelism <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--rollback-max-failure-ratio 0.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>redis:5
</span></span></code></pre></div><ul>
<li><code>--update-delay</code>：定义滚动更新的时间间隔；</li>
<li><code>--update-parallelism</code>：定义并行更新的副本数量，默认为 1；</li>
<li><code>--update-failure-action</code>：定义容器启动失败之后所执行的动作；</li>
<li><code>--rollback-monitor</code>：定义回滚的监控时间；</li>
<li><code>--rollback-parallelism</code>：定义并行回滚的副本数量；</li>
<li><code>--rollback-max-failure-ratio</code>：任务失败回滚比率，超过该比率执行回滚操作，0.2 表示 20%。</li>
</ul>
<p>　　然后通过以下命令实现服务的滚动更新。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker service update --image redis:6 redis
</span></span></code></pre></div><p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/220aab1a3f494362ac18385f5fb4f467_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
　</p>
<p>　　回滚服务，只能回滚到上一次操作的状态，并不能连续回滚到指定操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker service update --rollback redis
</span></span></code></pre></div><p><img loading="lazy" src="/images/Docker-Swarm%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%8f%8a%e5%bc%b9%e6%80%a7%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2/ba0dba7e3e204eef98603df2e5e675d4_tplv-k3u1fbpfcp-zoom-1.png" alt=""  />
</p>
<h2 id="四常用命令">四、常用命令<a hidden class="anchor" aria-hidden="true" href="#四常用命令">#</a></h2>
<h3 id="1docker-swarm">1、docker swarm<a hidden class="anchor" aria-hidden="true" href="#1docker-swarm">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">docker swarm init</td>
<td style="text-align:left">初始化集群</td>
</tr>
<tr>
<td style="text-align:left">docker swarm join-token worker</td>
<td style="text-align:left">查看工作节点的 token</td>
</tr>
<tr>
<td style="text-align:left">docker swarm join-token manager</td>
<td style="text-align:left">查看管理节点的 token</td>
</tr>
<tr>
<td style="text-align:left">docker swarm join</td>
<td style="text-align:left">加入集群</td>
</tr>
</tbody>
</table>
<h3 id="2docker-node">2、docker node<a hidden class="anchor" aria-hidden="true" href="#2docker-node">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">docker node ls</td>
<td style="text-align:left">查看集群所有节点</td>
</tr>
<tr>
<td style="text-align:left">docker node ps</td>
<td style="text-align:left">查看当前节点所有任务</td>
</tr>
<tr>
<td style="text-align:left">docker node rm 节点名称|节点ID</td>
<td style="text-align:left">删除节点（<code>-f</code>强制删除）</td>
</tr>
<tr>
<td style="text-align:left">docker node inspect 节点名称|节点ID</td>
<td style="text-align:left">查看节点详情</td>
</tr>
<tr>
<td style="text-align:left">docker node demote 节点名称|节点ID</td>
<td style="text-align:left">节点降级，由管理节点降级为工作节点</td>
</tr>
<tr>
<td style="text-align:left">docker node promote 节点名称|节点ID</td>
<td style="text-align:left">节点升级，由工作节点升级为管理节点</td>
</tr>
<tr>
<td style="text-align:left">docker node update 节点名称|节点ID</td>
<td style="text-align:left">更新节点</td>
</tr>
</tbody>
</table>
<h3 id="3docker-service">3、docker service<a hidden class="anchor" aria-hidden="true" href="#3docker-service">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">docker service create</td>
<td style="text-align:left">创建服务</td>
</tr>
<tr>
<td style="text-align:left">docker service ls</td>
<td style="text-align:left">查看所有服务</td>
</tr>
<tr>
<td style="text-align:left">docker service inspect 服务名称|服务ID</td>
<td style="text-align:left">查看服务详情</td>
</tr>
<tr>
<td style="text-align:left">docker service logs 服务名称|服务ID</td>
<td style="text-align:left">查看服务日志</td>
</tr>
<tr>
<td style="text-align:left">docker service rm 服务名称|服务ID</td>
<td style="text-align:left">删除服务（<code>-f</code>强制删除）</td>
</tr>
<tr>
<td style="text-align:left">docker service scale 服务名称|服务ID=n</td>
<td style="text-align:left">设置服务数量</td>
</tr>
<tr>
<td style="text-align:left">docker service update 服务名称|服务ID</td>
<td style="text-align:left">更新服务</td>
</tr>
</tbody>
</table>
<h2 id="五参考资料">五、参考资料<a hidden class="anchor" aria-hidden="true" href="#五参考资料">#</a></h2>
<ul>
<li><a href="https://docs.docker.com/engine/swarm/swarm-tutorial/">https://docs.docker.com/engine/swarm/swarm-tutorial/</a></li>
<li><a href="https://docs.docker.com/engine/swarm/swarm-mode/">https://docs.docker.com/engine/swarm/swarm-mode/</a></li>
<li><a href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/pki/">https://docs.docker.com/engine/swarm/how-swarm-mode-works/pki/</a></li>
<li><a href="https://docs.docker.com/engine/swarm/join-nodes/">https://docs.docker.com/engine/swarm/join-nodes/</a></li>
<li><a href="https://docs.docker.com/engine/swarm/swarm-tutorial/rolling-update/">https://docs.docker.com/engine/swarm/swarm-tutorial/rolling-update/</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker-swarm/">docker swarm</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/docker-swarm-%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%BA%A6%E6%9D%9F/">
    <span class="title">« 上一页</span>
    <br>
    <span>Docker Swarm 节点标签与服务约束</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/docker-swarm%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%88%A9%E5%99%A8%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E6%89%AB%E7%9B%B2/">
    <span class="title">下一页 »</span>
    <br>
    <span>Docker Swarm集群管理利器核心概念扫盲</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
