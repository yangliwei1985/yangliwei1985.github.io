<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kubernetes落地实践之旅 | ylw&#39;s blog</title>
<meta name="keywords" content="docker, k8s" />
<meta name="description" content="第二天 Kubernetes落地实践之旅 本章学习kubernetes的架构及工作流程，重点介绍如何使用Workload管理业务应用的生命周期，实现服务不中断的滚动更新，通过服务发现和集群内负载均衡来实现集群内部的服务间访问，并通过ingress实现外部使用域名访问集群内部的服务。
学习过程中会逐步对Django项目做k8s改造，从零开始编写所需的资源文件。通过本章的学习，学员会掌握高可用k8s集群的搭建，同时Django demo项目已经可以利用k8s的控制器、服务发现、负载均衡、配置管理等特性来实现生命周期的管理。
纯容器模式的问题  业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？ 跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？ 跨主机容器间互相调用，配置如何写？写死固定IP&#43;端口？ 如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？ 容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器? 如何实现滚动升级保证业务的连续性？ &hellip;&hellip;  容器调度管理平台 Docker Swarm Mesos Google Kubernetes
2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀
https://kubernetes.io/
架构图 分布式系统，两类角色：管理节点和工作节点
核心组件   ETCD：分布式高性能键值数据库,存储整个集群的所有元数据
  ApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制
  Scheduler：调度器,负责把业务容器调度到最合适的Node节点
  Controller Manager：控制器管理,确保集群资源按照期望的方式运行
 Replication Controller Node controller ResourceQuota Controller Namespace Controller ServiceAccount Controller Token Controller Service Controller Endpoints Controller    kubelet：运行在每个节点上的主要的“节点代理”，脏活累活
 pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。 容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理.">
<meta name="author" content="">
<link rel="canonical" href="https://iblog.zone/archives/kubernetes%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%B9%8B%E6%97%85/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7af5e4f048c756d5896f15b3f7cd7ee898ea1b3b101fcb40abfb5216ca230ecf.css" integrity="sha256-evXk8EjHVtWJbxWz981&#43;6JjqGzsQH8tAq/tSFsojDs8=" rel="preload stylesheet" as="style">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://iblog.zone/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://iblog.zone/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel='stylesheet' href='//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css'>

<meta property="og:title" content="Kubernetes落地实践之旅" />
<meta property="og:description" content="第二天 Kubernetes落地实践之旅 本章学习kubernetes的架构及工作流程，重点介绍如何使用Workload管理业务应用的生命周期，实现服务不中断的滚动更新，通过服务发现和集群内负载均衡来实现集群内部的服务间访问，并通过ingress实现外部使用域名访问集群内部的服务。
学习过程中会逐步对Django项目做k8s改造，从零开始编写所需的资源文件。通过本章的学习，学员会掌握高可用k8s集群的搭建，同时Django demo项目已经可以利用k8s的控制器、服务发现、负载均衡、配置管理等特性来实现生命周期的管理。
纯容器模式的问题  业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？ 跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？ 跨主机容器间互相调用，配置如何写？写死固定IP&#43;端口？ 如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？ 容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器? 如何实现滚动升级保证业务的连续性？ &hellip;&hellip;  容器调度管理平台 Docker Swarm Mesos Google Kubernetes
2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀
https://kubernetes.io/
架构图 分布式系统，两类角色：管理节点和工作节点
核心组件   ETCD：分布式高性能键值数据库,存储整个集群的所有元数据
  ApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制
  Scheduler：调度器,负责把业务容器调度到最合适的Node节点
  Controller Manager：控制器管理,确保集群资源按照期望的方式运行
 Replication Controller Node controller ResourceQuota Controller Namespace Controller ServiceAccount Controller Token Controller Service Controller Endpoints Controller    kubelet：运行在每个节点上的主要的“节点代理”，脏活累活
 pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。 容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iblog.zone/archives/kubernetes%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%B9%8B%E6%97%85/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-04T15:11:03&#43;00:00" />
<meta property="article:modified_time" content="2022-01-04T15:11:03&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes落地实践之旅"/>
<meta name="twitter:description" content="第二天 Kubernetes落地实践之旅 本章学习kubernetes的架构及工作流程，重点介绍如何使用Workload管理业务应用的生命周期，实现服务不中断的滚动更新，通过服务发现和集群内负载均衡来实现集群内部的服务间访问，并通过ingress实现外部使用域名访问集群内部的服务。
学习过程中会逐步对Django项目做k8s改造，从零开始编写所需的资源文件。通过本章的学习，学员会掌握高可用k8s集群的搭建，同时Django demo项目已经可以利用k8s的控制器、服务发现、负载均衡、配置管理等特性来实现生命周期的管理。
纯容器模式的问题  业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？ 跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？ 跨主机容器间互相调用，配置如何写？写死固定IP&#43;端口？ 如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？ 容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器? 如何实现滚动升级保证业务的连续性？ &hellip;&hellip;  容器调度管理平台 Docker Swarm Mesos Google Kubernetes
2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀
https://kubernetes.io/
架构图 分布式系统，两类角色：管理节点和工作节点
核心组件   ETCD：分布式高性能键值数据库,存储整个集群的所有元数据
  ApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制
  Scheduler：调度器,负责把业务容器调度到最合适的Node节点
  Controller Manager：控制器管理,确保集群资源按照期望的方式运行
 Replication Controller Node controller ResourceQuota Controller Namespace Controller ServiceAccount Controller Token Controller Service Controller Endpoints Controller    kubelet：运行在每个节点上的主要的“节点代理”，脏活累活
 pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。 容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://iblog.zone/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Kubernetes落地实践之旅",
      "item": "https://iblog.zone/archives/kubernetes%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%B9%8B%E6%97%85/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes落地实践之旅",
  "name": "Kubernetes落地实践之旅",
  "description": "第二天 Kubernetes落地实践之旅 本章学习kubernetes的架构及工作流程，重点介绍如何使用Workload管理业务应用的生命周期，实现服务不中断的滚动更新，通过服务发现和集群内负载均衡来实现集群内部的服务间访问，并通过ingress实现外部使用域名访问集群内部的服务。\n学习过程中会逐步对Django项目做k8s改造，从零开始编写所需的资源文件。通过本章的学习，学员会掌握高可用k8s集群的搭建，同时Django demo项目已经可以利用k8s的控制器、服务发现、负载均衡、配置管理等特性来实现生命周期的管理。\n纯容器模式的问题  业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？ 跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？ 跨主机容器间互相调用，配置如何写？写死固定IP+端口？ 如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？ 容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器? 如何实现滚动升级保证业务的连续性？ \u0026hellip;\u0026hellip;  容器调度管理平台 Docker Swarm Mesos Google Kubernetes\n2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀\nhttps://kubernetes.io/\n架构图 分布式系统，两类角色：管理节点和工作节点\n核心组件   ETCD：分布式高性能键值数据库,存储整个集群的所有元数据\n  ApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制\n  Scheduler：调度器,负责把业务容器调度到最合适的Node节点\n  Controller Manager：控制器管理,确保集群资源按照期望的方式运行\n Replication Controller Node controller ResourceQuota Controller Namespace Controller ServiceAccount Controller Token Controller Service Controller Endpoints Controller    kubelet：运行在每个节点上的主要的“节点代理”，脏活累活\n pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。 容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理.",
  "keywords": [
    "docker", "k8s"
  ],
  "articleBody": "第二天 Kubernetes落地实践之旅 本章学习kubernetes的架构及工作流程，重点介绍如何使用Workload管理业务应用的生命周期，实现服务不中断的滚动更新，通过服务发现和集群内负载均衡来实现集群内部的服务间访问，并通过ingress实现外部使用域名访问集群内部的服务。\n学习过程中会逐步对Django项目做k8s改造，从零开始编写所需的资源文件。通过本章的学习，学员会掌握高可用k8s集群的搭建，同时Django demo项目已经可以利用k8s的控制器、服务发现、负载均衡、配置管理等特性来实现生命周期的管理。\n纯容器模式的问题  业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？ 跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？ 跨主机容器间互相调用，配置如何写？写死固定IP+端口？ 如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？ 容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器? 如何实现滚动升级保证业务的连续性？ ……  容器调度管理平台 Docker Swarm Mesos Google Kubernetes\n2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀\nhttps://kubernetes.io/\n架构图 分布式系统，两类角色：管理节点和工作节点\n核心组件   ETCD：分布式高性能键值数据库,存储整个集群的所有元数据\n  ApiServer: API服务器,集群资源访问控制入口,提供restAPI及安全访问控制\n  Scheduler：调度器,负责把业务容器调度到最合适的Node节点\n  Controller Manager：控制器管理,确保集群资源按照期望的方式运行\n Replication Controller Node controller ResourceQuota Controller Namespace Controller ServiceAccount Controller Token Controller Service Controller Endpoints Controller    kubelet：运行在每个节点上的主要的“节点代理”，脏活累活\n pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。 容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理. 容器监控：kubelet 会监控所在节点的资源使用情况，并定时向 master 报告，资源使用数据都是通过 cAdvisor 获取的。知道整个集群所有节点的资源情况，对于 pod 的调度和正常运行至关重要    kube-proxy：维护节点中的iptables或者ipvs规则\n  kubectl: 命令行接口，用于对 Kubernetes 集群运行命令 https://kubernetes.io/zh/docs/reference/kubectl/\n  工作流程  用户准备一个资源文件（记录了业务应用的名称、镜像地址等信息），通过调用APIServer执行创建Pod APIServer收到用户的Pod创建请求，将Pod信息写入到etcd中 调度器通过list-watch的方式，发现有新的pod数据，但是这个pod还没有绑定到某一个节点中 调度器通过调度算法，计算出最适合该pod运行的节点，并调用APIServer，把信息更新到etcd中 kubelet同样通过list-watch方式，发现有新的pod调度到本机的节点了，因此调用容器运行时，去根据pod的描述信息，拉取镜像，启动容器，同时生成事件信息 同时，把容器的信息、事件及状态也通过APIServer写入到etcd中  架构设计的几点思考  系统各个组件分工明确(APIServer是所有请求入口，CM是控制中枢，Scheduler主管调度，而Kubelet负责运行)，配合流畅，整个运行机制一气呵成。 除了配置管理和持久化组件ETCD，其他组件并不保存数据。意味除ETCD外其他组件都是无状态的。因此从架构设计上对kubernetes系统高可用部署提供了支撑。 同时因为组件无状态，组件的升级，重启，故障等并不影响集群最终状态，只要组件恢复后就可以从中断处继续运行。 各个组件和kube-apiserver之间的数据推送都是通过list-watch机制来实现。  实践–集群安装 k8s集群主流安装方式对比分析  minikube 二进制安装 kubeadm等安装工具  kubeadm https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/\n《Kubernetes安装手册（非高可用版）》\n核心组件 静态Pod的方式：\n## etcd、apiserver、controller-manager、kube-scheduler $ kubectl -n kube-system get po systemd服务方式：\n$ systemctl status kubelet kubectl：二进制命令行工具\n理解集群资源 组件是为了支撑k8s平台的运行，安装好的软件。\n资源是如何去使用k8s的能力的定义。比如，k8s可以使用Pod来管理业务应用，那么Pod就是k8s集群中的一类资源，集群中的所有资源可以提供如下方式查看：\n$ kubectl api-resources 如何理解namespace：\n命名空间，集群内一个虚拟的概念，类似于资源池的概念，一个池子里可以有各种资源类型，绝大多数的资源都必须属于某一个namespace。集群初始化安装好之后，会默认有如下几个namespace：\n$ kubectl get namespaces NAME STATUS AGE default Active 84m kube-node-lease Active 84m kube-public Active 84m kube-system Active 84m kubernetes-dashboard Active 71m  所有NAMESPACED的资源，在创建的时候都需要指定namespace，若不指定，默认会在default命名空间下 相同namespace下的同类资源不可以重名，不同类型的资源可以重名 不同namespace下的同类资源可以重名 通常在项目使用的时候，我们会创建带有业务含义的namespace来做逻辑上的整合  kubectl的使用 类似于docker，kubectl是命令行工具，用于与APIServer交互，内置了丰富的子命令，功能极其强大。 https://kubernetes.io/docs/reference/kubectl/overview/\n$ kubectl -h $ kubectl get -h $ kubectl create -h $ kubectl create namespace -h 实践–使用k8s管理业务应用 最小调度单元 Pod docker调度的是容器，在k8s集群中，最小的调度单元是Pod（豆荚）\n为什么引入Pod   与容器引擎解耦\nDocker、Rkt。平台设计与引擎的具体的实现解耦\n  多容器共享网络|存储|进程 空间, 支持的业务场景更加灵活\n  使用yaml格式定义Pod myblog/one-pod/pod.yaml\napiVersion: v1 kind: Pod metadata:  name: myblog  namespace: luffy  labels:  component: myblog spec:  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  env:  - name: MYSQL_HOST  # 指定root用户的用户名  value: \"127.0.0.1\"  - name: MYSQL_PASSWD  value: \"123456\"  ports:  - containerPort: 8002  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_ROOT_PASSWORD  value: \"123456\"  - name: MYSQL_DATABASE  value: \"myblog\" { \t\"apiVersion\": \"v1\",\t\t\"kind\": \"Pod\", \t\"metadata\": { \t\"name\": \"myblog\",  \"namespace\": \"luffy\",  \"labels\": {  \"component\": \"myblog\"  } \t}, \t\"spec\": { \t\"containers\": [ \t{ \t\"name\": \"myblog\", \t\"image\": \"172.21.51.67:5000/myblog\",  \"env\": [  {  \"name\": \"MYSQL_HOST\",  \"value\": \"127.0.0.1\"  },  {  \"name\": \"MYSQL_PASSWD\",  \"value\": \"123456\"  }  ], \t\"ports\": [ \t{ \t\"containerPort\": 8002 \t} \t] \t},  {  \"name\": \"mysql\",  ... \t} \t] \t} }    apiVersion 含义     alpha 进入K8s功能的早期候选版本，可能包含Bug，最终不一定进入K8s   beta 已经过测试的版本，最终会进入K8s，但功能、对象定义可能会发生变更。   stable 可安全使用的稳定版本   v1 stable 版本之后的首个版本，包含了更多的核心对象   apps/v1 使用最广泛的版本，像Deployment、ReplicaSets都已进入该版本    资源类型与apiVersion对照表\n   Kind apiVersion     ClusterRoleBinding rbac.authorization.k8s.io/v1   ClusterRole rbac.authorization.k8s.io/v1   ConfigMap v1   CronJob batch/v1beta1   DaemonSet extensions/v1beta1   Node v1   Namespace v1   Secret v1   PersistentVolume v1   PersistentVolumeClaim v1   Pod v1   Deployment v1、apps/v1、apps/v1beta1、apps/v1beta2   Service v1   Ingress extensions/v1beta1   ReplicaSet apps/v1、apps/v1beta2   Job batch/v1   StatefulSet apps/v1、apps/v1beta1、apps/v1beta2    快速获得资源和版本\n$ kubectl explain pod $ kubectl explain Pod.apiVersion 创建和访问Pod ## 创建namespace, namespace是逻辑上的资源池 $ kubectl create namespace luffy  ## 使用指定文件创建Pod $ kubectl create -f pod.yaml  ## 查看pod，可以简写po ## 所有的操作都需要指定namespace，如果是在default命名空间下，则可以省略 $ kubectl -n luffy get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE myblog 2/2 Running 0 3m 10.244.1.146 k8s-slave1  ## 使用Pod Ip访问服务,3306和8002 $ curl 10.244.1.146:8002/blog/index/  ## 进入容器,执行初始化, 不必到对应的主机执行docker exec $ kubectl -n luffy exec -ti myblog -c myblog bash / # env / # python3 manage.py migrate $ kubectl -n luffy exec -ti myblog -c mysql bash / # mysql -p123456  ## 再次访问服务,3306和8002 $ curl 10.244.1.146:8002/blog/index/ Infra容器 登录k8s-slave1节点\n$ docker ps -a |grep myblog ## 发现有三个容器 ## 其中包含mysql和myblog程序以及Infra容器 ## 为了实现Pod内部的容器可以通过localhost通信，每个Pod都会启动Infra容器，然后Pod内部的其他容器的网络空间会共享该Infra容器的网络空间(Docker网络的container模式)，Infra容器只需要hang住网络空间，不需要额外的功能，因此资源消耗极低。  ## 登录master节点，查看pod内部的容器ip均相同，为pod ip $ kubectl -n luffy exec -ti myblog -c myblog bash / # ifconfig $ kubectl -n luffy exec -ti myblog -c mysql bash / # ifconfig pod容器命名: k8s____\n查看pod详细信息 ## 查看pod调度节点及pod_ip $ kubectl -n luffy get pods -o wide ## 查看完整的yaml $ kubectl -n luffy get po myblog -o yaml ## 查看pod的明细信息及事件 $ kubectl -n luffy describe pod myblog Troubleshooting and Debugging #进入Pod内的容器 $ kubectl -n  exec  -c  -ti /bin/sh  #查看Pod内容器日志,显示标准或者错误输出日志 $ kubectl -n  logs -f  -c  更新服务版本 $ kubectl apply -f demo-pod.yaml 删除Pod服务 #根据文件删除 $ kubectl delete -f demo-pod.yaml  #根据pod_name删除 $ kubectl -n  delete pod  Pod数据持久化 若删除了Pod，由于mysql的数据都在容器内部，会造成数据丢失，因此需要数据进行持久化。\n  定点使用hostpath挂载，nodeSelector定点\nmyblog/one-pod/pod-with-volume.yaml\napiVersion: v1 kind: Pod metadata:  name: myblog  namespace: luffy  labels:  component: myblog spec:  volumes:  - name: mysql-data  hostPath:  path: /opt/mysql/data  nodeSelector: # 使用节点选择器将Pod调度到指定label的节点  component: mysql  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  env:  - name: MYSQL_HOST  # 指定root用户的用户名  value: \"127.0.0.1\"  - name: MYSQL_PASSWD  value: \"123456\"  ports:  - containerPort: 8002  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_ROOT_PASSWORD  value: \"123456\"  - name: MYSQL_DATABASE  value: \"myblog\"  volumeMounts:  - name: mysql-data  mountPath: /var/lib/mysql 保存文件为pod-with-volume.yaml，执行创建\n## 若存在旧的同名服务，先删除掉，后创建 $ kubectl -n luffy delete pod myblog ## 创建 $ kubectl create -f pod-with-volume.yaml  ## 此时pod状态Pending $ kubectl -n luffy get po NAME READY STATUS RESTARTS AGE myblog 0/2 Pending 0 32s  ## 查看原因，提示调度失败，因为节点不满足node selector $ kubectl -n luffy describe po myblog Events:  Type Reason Age From Message  ---- ------ ---- ---- -------  Warning FailedScheduling 12s (x2 over 12s) default-scheduler 0/3 nodes are available: 3 node(s) didn't match node selector.  ## 为节点打标签 $ kubectl label node k8s-slave1 component=mysql  ## 再次查看，已经运行成功 $ kubectl -n luffy get po NAME READY STATUS RESTARTS AGE IP NODE myblog 2/2 Running 0 3m54s 10.244.1.150 k8s-slave1  ## 到k8s-slave1节点，查看/opt/mysql/data $ ll /opt/mysql/data/ total 188484 -rw-r----- 1 polkitd input 56 Mar 29 09:20 auto.cnf -rw------- 1 polkitd input 1676 Mar 29 09:20 ca-key.pem -rw-r--r-- 1 polkitd input 1112 Mar 29 09:20 ca.pem drwxr-x--- 2 polkitd input 8192 Mar 29 09:20 sys ...  ## 执行migrate，创建数据库表，然后删掉pod，再次创建后验证数据是否存在 $ kubectl -n luffy exec -ti myblog python3 manage.py migrate  ## 访问服务，正常 $ curl 10.244.1.150:8002/blog/index/  ## 删除pod $ kubectl delete -f pod-with-volume.yaml  ## 再次创建Pod $ kubectl create -f pod-with-volume.yaml  ## 查看pod ip并访问服务 $ kubectl -n luffy get po -o wide NAME READY STATUS RESTARTS AGE IP NODE myblog 2/2 Running 0 7s 10.244.1.151 k8s-slave1  ## 未重新做migrate，服务正常 $ curl 10.244.1.151:8002/blog/index/   使用PV+PVC连接分布式存储解决方案\n ceph glusterfs nfs    服务健康检查 检测容器服务是否健康的手段，若不健康，会根据设置的重启策略（restartPolicy）进行操作，两种检测机制可以分别单独设置，若不设置，默认认为Pod是健康的。\n两种机制：\n  LivenessProbe探针 存活性探测：用于判断容器是否存活，即Pod是否为running状态，如果LivenessProbe探针探测到容器不健康，则kubelet将kill掉容器，并根据容器的重启策略是否重启，如果一个容器不包含LivenessProbe探针，则Kubelet认为容器的LivenessProbe探针的返回值永远成功。\n...  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 10 # 执行探测的频率  timeoutSeconds: 2\t# 探测超时时间 ...   ReadinessProbe探针 可用性探测：用于判断容器是否正常提供服务，即容器的Ready是否为True，是否可以接收请求，如果ReadinessProbe探测失败，则容器的Ready将为False， Endpoint Controller 控制器将此Pod的Endpoint从对应的service的Endpoint列表中移除，不再将任何请求调度此Pod上，直到下次探测成功。（剔除此pod不参与接收请求不会将流量转发给此Pod）。\n...  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 10 ...   三种类型：\n exec：通过执行命令来检查服务是否正常，返回值为0则表示容器健康 httpGet方式：通过发送http请求检查服务是否正常，返回200-399状态码则表明容器健康 tcpSocket：通过容器的IP和Port执行TCP检查，如果能够建立TCP连接，则表明容器健康  示例：\n完整文件路径 myblog/one-pod/pod-with-healthcheck.yaml\n containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  env:  - name: MYSQL_HOST  # 指定root用户的用户名  value: \"127.0.0.1\"  - name: MYSQL_PASSWD  value: \"123456\"  ports:  - containerPort: 8002  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 10 # 执行探测的频率  timeoutSeconds: 2\t# 探测超时时间  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 10  initialDelaySeconds：容器启动后第一次执行探测时需要等待多少秒。 periodSeconds：执行探测的频率。默认是10秒，最小1秒。 timeoutSeconds：探测超时时间。默认1秒，最小1秒。 successThreshold：探测失败后，最少连续探测成功多少次才被认定为成功。默认是1。 failureThreshold：探测成功后，最少连续探测失败多少次才被认定为失败。默认是3，最小值是1。  K8S将在Pod开始启动10s(initialDelaySeconds)后利用HTTP访问8002端口的/blog/index/，如果超过2s或者返回码不在200~399内，则健康检查失败\n重启策略 Pod的重启策略（RestartPolicy）应用于Pod内的所有容器，并且仅在Pod所处的Node上由kubelet进行判断和重启操作。当某个容器异常退出或者健康检查失败时，kubelet将根据RestartPolicy的设置来进行相应的操作。 Pod的重启策略包括Always、OnFailure和Never，默认值为Always。\n Always：当容器进程退出后，由kubelet自动重启该容器； OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器； Never：不论容器运行状态如何，kubelet都不会重启该容器。  演示重启策略：\napiVersion: v1 kind: Pod metadata:  name: test-restart-policy spec:  restartPolicy: OnFailure  containers:  - name: busybox  image: busybox  args:  - /bin/sh  - -c  - sleep 10 \u0026\u0026 exit 0  使用默认的重启策略，即 restartPolicy: Always ，无论容器是否是正常退出，都会自动重启容器 使用OnFailure的策略时  如果把exit 1，去掉，即让容器的进程正常退出的话，则不会重启 只有非正常退出状态才会重启   使用Never时，退出了就不再重启  可以看出，若容器正常退出，Pod的状态会是Completed，非正常退出，状态为CrashLoopBackOff\n镜像拉取策略 spec:  containers:  - name: myblog  image: 172.21.51.67:5000/demo/myblog  imagePullPolicy: IfNotPresent 设置镜像的拉取策略，默认为IfNotPresent\n Always，总是拉取镜像，即使本地有镜像也从仓库拉取 IfNotPresent ，本地有则使用本地镜像，本地没有则去仓库拉取 Never，只使用本地镜像，本地没有则报错  Pod资源限制 为了保证充分利用集群资源，且确保重要容器在运行周期内能够分配到足够的资源稳定运行，因此平台需要具备\nPod的资源限制的能力。 对于一个pod来说，资源最基础的2个的指标就是：CPU和内存。\nKubernetes提供了个采用requests和limits 两种类型参数对资源进行预分配和使用限制。\n完整文件路径：myblog/one-pod/pod-with-resourcelimits.yaml\n...  containers:  - name: myblog  image: 172.21.51.67:5000/myblog  env:  - name: MYSQL_HOST  # 指定root用户的用户名  value: \"127.0.0.1\"  - name: MYSQL_PASSWD  value: \"123456\"  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m ... requests：\n 容器使用的最小资源需求,作用于schedule阶段，作为容器调度时资源分配的判断依赖 只有当前节点上可分配的资源量 = request 时才允许将容器调度到该节点 request参数不限制容器的最大可使用资源 requests.cpu被转成docker的–cpu-shares参数，与cgroup cpu.shares功能相同 (无论宿主机有多少个cpu或者内核，–cpu-shares选项都会按照比例分配cpu资源） requests.memory没有对应的docker参数，仅作为k8s调度依据  limits：\n 容器能使用资源的最大值 设置为0表示对使用的资源不做限制, 可无限的使用 当pod 内存超过limit时，会被oom 当cpu超过limit时，不会被kill，但是会限制不超过limit值 limits.cpu会被转换成docker的–cpu-quota参数。与cgroup cpu.cfs_quota_us功能相同 limits.memory会被转换成docker的–memory参数。用来限制容器使用的最大内存  对于 CPU，我们知道计算机里 CPU 的资源是按“时间片”的方式来进行分配的，系统里的每一个操作都需要 CPU 的处理，所以，哪个任务要是申请的 CPU 时间片越多，那么它得到的 CPU 资源就越多。\n然后还需要了解下 CGroup 里面对于 CPU 资源的单位换算：\n1 CPU = 1000 millicpu（1 Core = 1000m） 这里的 m 就是毫、毫核的意思，Kubernetes 集群中的每一个节点可以通过操作系统的命令来确认本节点的 CPU 内核数量，然后将这个数量乘以1000，得到的就是节点总 CPU 总毫数。比如一个节点有四核，那么该节点的 CPU 总毫量为 4000m。\ndocker run命令和 CPU 限制相关的所有选项如下：\n   选项 描述     --cpuset-cpus=\"\" 允许使用的 CPU 集，值可以为 0-3,0,1   -c,--cpu-shares=0 CPU 共享权值（相对权重）   cpu-period=0 限制 CPU CFS 的周期，范围从 100ms~1s，即[1000, 1000000]   --cpu-quota=0 限制 CPU CFS 配额，必须不小于1ms，即 = 1000，绝对限制    docker run -it --cpu-period=50000 --cpu-quota=25000 ubuntu:16.04 /bin/bash 将 CFS 调度的周期设为 50000，将容器在每个周期内的 CPU 配额设置为 25000，表示该容器每 50ms 可以得到 50% 的 CPU 运行时间。\n 注意：若内存使用超出限制，会引发系统的OOM机制，因CPU是可压缩资源，不会引发Pod退出或重建\n yaml优化 目前完善后的yaml，myblog/one-pod/pod-completed.yaml\napiVersion: v1 kind: Pod metadata:  name: myblog  namespace: luffy  labels:  component: myblog spec:  volumes:  - name: mysql-data  hostPath:  path: /opt/mysql/data  nodeSelector: # 使用节点选择器将Pod调度到指定label的节点  component: mysql  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  env:  - name: MYSQL_HOST  # 指定root用户的用户名  value: \"127.0.0.1\"  - name: MYSQL_PASSWD  value: \"123456\"  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 15 # 执行探测的频率  timeoutSeconds: 2\t# 探测超时时间  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 15  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_ROOT_PASSWORD  value: \"123456\"  - name: MYSQL_DATABASE  value: \"myblog\"  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  readinessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 5  periodSeconds: 10  livenessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 15  periodSeconds: 20  volumeMounts:  - name: mysql-data  mountPath: /var/lib/mysql 为什么要优化\n 考虑真实的使用场景，像数据库这类中间件，是作为公共资源，为多个项目提供服务，不适合和业务容器绑定在同一个Pod中，因为业务容器是经常变更的，而数据库不需要频繁迭代 yaml的环境变量中存在敏感信息（账号、密码），存在安全隐患  解决问题一，需要拆分yaml\nmyblog/two-pod/mysql.yaml\napiVersion: v1 kind: Pod metadata:  name: mysql  namespace: luffy  labels:  component: mysql spec:  hostNetwork: true\t# 声明pod的网络模式为host模式，效果同docker run --net=host  volumes:  - name: mysql-data  hostPath:  path: /opt/mysql/data  nodeSelector: # 使用节点选择器将Pod调度到指定label的节点  component: mysql  containers:  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_ROOT_PASSWORD  value: \"123456\"  - name: MYSQL_DATABASE  value: \"myblog\"  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  readinessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 5  periodSeconds: 10  livenessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 15  periodSeconds: 20  volumeMounts:  - name: mysql-data  mountPath: /var/lib/mysql myblog.yaml\napiVersion: v1 kind: Pod metadata:  name: myblog  namespace: luffy  labels:  component: myblog spec:  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  imagePullPolicy: IfNotPresent  env:  - name: MYSQL_HOST  # 指定root用户的用户名  value: \"172.21.51.68\"  - name: MYSQL_PASSWD  value: \"123456\"  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 15 # 执行探测的频率  timeoutSeconds: 2\t# 探测超时时间  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 15 创建测试\n## 先删除旧pod $ kubectl -n luffy delete po myblog  ## 分别创建mysql和myblog $ kubectl create -f mysql.yaml $ kubectl create -f myblog.yaml  ## 查看pod，注意mysqlIP为宿主机IP，因为网络模式为host $ kubectl -n luffy get po -o wide NAME READY STATUS RESTARTS AGE IP NODE myblog 1/1 Running 0 41s 10.244.1.152 k8s-slave1 mysql 1/1 Running 0 52s 172.21.51.68 k8s-slave1  ## 访问myblog服务正常 $ curl 10.244.1.152:8002/blog/index/ 解决问题二，环境变量中敏感信息带来的安全隐患\n为什么要统一管理环境变量\n 环境变量中有很多敏感的信息，比如账号密码，直接暴漏在yaml文件中存在安全性问题 团队内部一般存在多个项目，这些项目直接存在配置相同环境变量的情况，因此可以统一维护管理 对于开发、测试、生产环境，由于配置均不同，每套环境部署的时候都要修改yaml，带来额外的开销  k8s提供两类资源，configMap和Secret，可以用来实现业务配置的统一管理， 允许将配置文件与镜像文件分离，以使容器化的应用程序具有可移植性 。\n  configMap，通常用来管理应用的配置文件或者环境变量，myblog/two-pod/configmap.yaml\napiVersion: v1 kind: ConfigMap metadata:  name: myblog  namespace: luffy data:  MYSQL_HOST: \"172.21.51.68\"  MYSQL_PORT: \"3306\" 创建并查看configMap：\n$ kubectl create -f configmap.yaml $ kubectl -n luffy get cm myblog -oyaml 或者可以使用命令的方式，从文件中创建，比如：\nconfigmap.txt\n$ cat configmap.txt MYSQL_HOST=172.21.51.68 MYSQL_PORT=3306 $ kubectl create configmap myblog --from-env-file=configmap.txt   Secret，管理敏感类的信息，默认会base64编码存储，有三种类型\n Service Account ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；创建ServiceAccount后，Pod中指定serviceAccount后，自动创建该ServiceAccount对应的secret； Opaque ： base64编码格式的Secret，用来存储密码、密钥等； kubernetes.io/dockerconfigjson ：用来存储私有docker registry的认证信息。  myblog/two-pod/secret.yaml\napiVersion: v1 kind: Secret metadata:  name: myblog  namespace: luffy type: Opaque data:  MYSQL_USER: cm9vdA==\t#注意加-n参数， echo -n root|base64  MYSQL_PASSWD: MTIzNDU2 创建并查看：\n$ kubectl create -f secret.yaml $ kubectl -n luffy get secret 如果不习惯这种方式，可以通过如下方式：\n$ cat secret.txt MYSQL_USER=root MYSQL_PASSWD=123456 $ kubectl -n luffy create secret generic myblog --from-env-file=secret.txt   修改后的mysql的yaml，资源路径：myblog/two-pod/mysql-with-config.yaml\n... spec:  containers:  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  env:  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_ROOT_PASSWORD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  - name: MYSQL_DATABASE  value: \"myblog\" ... 整体修改后的myblog的yaml，资源路径：myblog/two-pod/myblog-with-config.yaml\napiVersion: v1 kind: Pod metadata:  name: myblog  namespace: luffy  labels:  component: myblog spec:  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  imagePullPolicy: IfNotPresent  env:  - name: MYSQL_HOST  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_HOST  - name: MYSQL_PORT  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_PORT  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_PASSWD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 15 # 执行探测的频率  timeoutSeconds: 2\t# 探测超时时间  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 15 在部署不同的环境时，pod的yaml无须再变化，只需要在每套环境中维护一套ConfigMap和Secret即可。但是注意configmap和secret不能跨namespace使用，且更新后，pod内的env不会自动更新，重建后方可更新。\n如何编写资源yaml   拿来主义，从机器中已有的资源中拿\n$ kubectl -n kube-system get po,deployment,ds   学会在官网查找， https://kubernetes.io/docs/home/\n  从kubernetes-api文档中查找， https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core\n  kubectl explain 查看具体字段含义\n  pod状态与生命周期 Pod的状态如下表所示：\n   状态值 描述     Pending API Server已经创建该Pod，等待调度器调度   ContainerCreating 拉取镜像启动容器中   Running Pod内容器均已创建，且至少有一个容器处于运行状态、正在启动状态或正在重启状态   Succeeded|Completed Pod内所有容器均已成功执行退出，且不再重启   Failed|Error Pod内所有容器均已退出，但至少有一个容器退出为失败状态   CrashLoopBackOff Pod内有容器启动失败，比如配置文件丢失导致主进程启动失败   Unknown 由于某种原因无法获取该Pod的状态，可能由于网络通信不畅导致    生命周期示意图：\n启动和关闭示意：\n初始化容器：\n 验证业务应用依赖的组件是否均已启动 修改目录的权限 调整系统参数  ...  initContainers:  - command:  - /sbin/sysctl  - -w  - vm.max_map_count=262144  image: alpine:3.6  imagePullPolicy: IfNotPresent  name: elasticsearch-logging-init  resources: {}  securityContext:  privileged: true  - name: fix-permissions  image: alpine:3.6  command: [\"sh\", \"-c\", \"chown -R 1000:1000 /usr/share/elasticsearch/data\"]  securityContext:  privileged: true  volumeMounts:  - name: elasticsearch-logging  mountPath: /usr/share/elasticsearch/data ... 验证Pod生命周期：\napiVersion: v1 kind: Pod metadata:  name: demo-start-stop  namespace: luffy  labels:  component: demo-start-stop spec:  initContainers:  - name: init  image: busybox  command: ['sh', '-c', 'echo $(date +%s): INIT  /loap/timing']  volumeMounts:  - mountPath: /loap  name: timing  containers:  - name: main  image: busybox  command: ['sh', '-c', 'echo $(date +%s): START  /loap/timing; sleep 10; echo $(date +%s): END  /loap/timing;']  volumeMounts:  - mountPath: /loap   name: timing  livenessProbe:  exec:  command: ['sh', '-c', 'echo $(date +%s): LIVENESS  /loap/timing']  readinessProbe:  exec:  command: ['sh', '-c', 'echo $(date +%s): READINESS  /loap/timing']  lifecycle:  postStart:  exec:  command: ['sh', '-c', 'echo $(date +%s): POST-START  /loap/timing']  preStop:  exec:  command: ['sh', '-c', 'echo $(date +%s): PRE-STOP  /loap/timing']  volumes:  - name: timing  hostPath:  path: /tmp/loap 创建pod测试：\n$ kubectl create -f demo-pod-start.yaml  ## 查看demo状态 $ kubectl -n luffy get po -o wide -w  ## 查看调度节点的/tmp/loap/timing $ cat /tmp/loap/timing 1585424708: INIT 1585424746: START 1585424746: POST-START 1585424754: READINESS 1585424756: LIVENESS 1585424756: END  须主动杀掉 Pod 才会触发 pre-stop hook，如果是 Pod 自己 Down 掉，则不会执行 pre-stop hook\n 小结  实现k8s平台与特定的容器运行时解耦，提供更加灵活的业务部署方式，引入了Pod概念 k8s使用yaml格式定义资源文件，yaml中Map与List的语法，与json做类比 通过kubectl create | get | exec | logs | delete 等操作k8s资源，必须指定namespace 每启动一个Pod，为了实现网络空间共享，会先创建Infra容器，并把其他容器网络加入该容器 通过livenessProbe和readinessProbe实现Pod的存活性和就绪健康检查 通过requests和limit分别限定容器初始资源申请与最高上限资源申请 Pod通过initContainer和lifecycle分别来执行初始化、pod启动和删除时候的操作，使得功能更加全面和灵活 编写yaml讲究方法，学习k8s，养成从官方网站查询知识的习惯  做了哪些工作：\n 定义Pod.yaml，将myblog和mysql打包在同一个Pod中，使用myblog使用localhost访问mysql mysql数据持久化，为myblog业务应用添加了健康检查和资源限制 将myblog与mysql拆分，使用独立的Pod管理 yaml文件中的环境变量存在账号密码明文等敏感信息，使用configMap和Secret来统一配置，优化部署  只使用Pod, 面临的问题:\n 业务应用启动多个副本 Pod重建后IP会变化，外部如何访问Pod服务 运行业务Pod的某个节点挂了，可以自动帮我把Pod转移到集群中的可用节点启动起来 我的业务应用功能是收集节点监控数据,需要把Pod运行在k8集群的各个节点上  Pod控制器 Workload (工作负载) 控制器又称工作负载是用于实现管理pod的中间层，确保pod资源符合预期的状态，pod的资源出现故障时，会尝试 进行重启，当根据重启策略无效，则会重新新建pod的资源。\n ReplicaSet: 代用户创建指定数量的pod副本数量，确保pod副本数量符合预期状态，并且支持滚动式自动扩容和缩容功能 Deployment：工作在ReplicaSet之上，用于管理无状态应用，目前来说最好的控制器。支持滚动更新和回滚功能，提供声明式配置 DaemonSet：用于确保集群中的每一个节点只运行特定的pod副本，通常用于实现系统级后台任务。比如EFK服务 Job：只要完成就立即退出，不需要重启或重建 Cronjob：周期性任务控制，不需要持续后台运行 StatefulSet：管理有状态应用  Deployment myblog/deployment/deploy-mysql.yaml\napiVersion: apps/v1 kind: Deployment metadata:  name: mysql  namespace: luffy spec:  replicas: 1\t#指定Pod副本数  selector:\t#指定Pod的选择器  matchLabels:  app: mysql  template:  metadata:  labels:\t#给Pod打label  app: mysql  spec:  volumes:  - name: mysql-data  hostPath:  path: /opt/mysql/data  nodeSelector: # 使用节点选择器将Pod调度到指定label的节点  component: mysql  containers:  - name: mysql  image: 172.21.51.67:5000/mysql:5.7-utf8  ports:  - containerPort: 3306  env:  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_ROOT_PASSWORD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  - name: MYSQL_DATABASE  value: \"myblog\"  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  readinessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 5  periodSeconds: 10  livenessProbe:  tcpSocket:  port: 3306  initialDelaySeconds: 15  periodSeconds: 20  volumeMounts:  - name: mysql-data  mountPath: /var/lib/mysql deploy-myblog.yaml:\napiVersion: apps/v1 kind: Deployment metadata:  name: myblog  namespace: luffy spec:  replicas: 1\t#指定Pod副本数  selector:\t#指定Pod的选择器  matchLabels:  app: myblog  template:  metadata:  labels:\t#给Pod打label  app: myblog  spec:  containers:  - name: myblog  image: 172.21.51.67:5000/myblog:v1  imagePullPolicy: IfNotPresent  env:  - name: MYSQL_HOST  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_HOST  - name: MYSQL_PORT  valueFrom:  configMapKeyRef:  name: myblog  key: MYSQL_PORT  - name: MYSQL_USER  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_USER  - name: MYSQL_PASSWD  valueFrom:  secretKeyRef:  name: myblog  key: MYSQL_PASSWD  ports:  - containerPort: 8002  resources:  requests:  memory: 100Mi  cpu: 50m  limits:  memory: 500Mi  cpu: 100m  livenessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10 # 容器启动后第一次执行探测是需要等待多少秒  periodSeconds: 15 # 执行探测的频率  timeoutSeconds: 2\t# 探测超时时间  readinessProbe:  httpGet:  path: /blog/index/  port: 8002  scheme: HTTP  initialDelaySeconds: 10  timeoutSeconds: 2  periodSeconds: 15 创建Deployment $ kubectl create -f deploy.yaml 查看Deployment # kubectl api-resources $ kubectl -n luffy get deploy NAME READY UP-TO-DATE AVAILABLE AGE myblog 1/1 1 1 2m22s mysql 1/1 1 1 2d11h   * `NAME` 列出了集群中 Deployments 的名称。  * `READY`显示当前正在运行的副本数/期望的副本数。  * `UP-TO-DATE`显示已更新以实现期望状态的副本数。  * `AVAILABLE`显示应用程序可供用户使用的副本数。  * `AGE` 显示应用程序运行的时间量。  # 查看pod $ kubectl -n luffy get po NAME READY STATUS RESTARTS AGE myblog-7c96c9f76b-qbbg7 1/1 Running 0 109s mysql-85f4f65f99-w6jkj 1/1 Running 0 2m28s  # 查看replicaSet $ kubectl -n luffy get rs 副本保障机制 controller实时检测pod状态，并保障副本数一直处于期望的值。\n## 删除pod，观察pod状态变化 $ kubectl -n luffy delete pod myblog-7c96c9f76b-qbbg7  # 观察pod $ kubectl get pods -o wide  ## 设置两个副本, 或者通过kubectl -n luffy edit deploy myblog的方式，最好通过修改文件，然后apply的方式，这样yaml文件可以保持同步 $ kubectl -n luffy scale deploy myblog --replicas=2 deployment.extensions/myblog scaled  # 观察pod $ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE myblog-7c96c9f76b-qbbg7 1/1 Running 0 11m myblog-7c96c9f76b-s6brm 1/1 Running 0 55s mysql-85f4f65f99-w6jkj 1/1 Running 0 11m Pod驱逐策略 K8S 有个特色功能叫 pod eviction，它在某些场景下如节点 NotReady，或者资源不足时，把 pod 驱逐至其它节点，这也是出于业务保护的角度去考虑的。\n Kube-controller-manager: 周期性检查所有节点状态，当节点处于 NotReady 状态超过一段时间后，驱逐该节点上所有 pod。    pod-eviction-timeout：NotReady 状态节点超过该时间后，执行驱逐，默认 5 min，适用于k8s 1.13版本之前\n  1.13版本后，集群开启 TaintBasedEvictions 与TaintNodesByCondition 功能，即taint-based-evictions，即节点若失联或者出现各种异常情况，k8s会自动为node打上污点，同时为pod默认添加如下容忍设置：\n tolerations:  - effect: NoExecute  key: node.kubernetes.io/not-ready  operator: Exists  tolerationSeconds: 300  - effect: NoExecute  key: node.kubernetes.io/unreachable  operator: Exists  tolerationSeconds: 300 即各pod可以独立设置驱逐容忍时间。\n    Kubelet: 周期性检查本节点资源，当资源不足时，按照优先级驱逐部分 pod  memory.available：节点可用内存 nodefs.available：节点根盘可用存储空间 nodefs.inodesFree：节点inodes可用数量 imagefs.available：镜像存储盘的可用空间 imagefs.inodesFree：镜像存储盘的inodes可用数量    服务更新 修改服务，重新打tag模拟服务更新。\n更新方式：\n  修改yaml文件，使用kubectl apply -f deploy-myblog.yaml来应用更新\n  kubectl -n luffy edit deploy myblog在线更新\n  kubectl -n luffy set image deploy myblog myblog=172.21.51.67:5000/myblog:v2 --record\n  修改文件测试：\n$ vi mybolg/blog/template/index.html  $ docker build . -t 172.21.51.67:5000/myblog:v2 -f Dockerfile $ docker push 172.21.51.67:5000/myblog:v2 更新策略 ... spec:  replicas: 2\t#指定Pod副本数  selector:\t#指定Pod的选择器  matchLabels:  app: myblog  strategy:  rollingUpdate:  maxSurge: 1  maxUnavailable: 25%  type: RollingUpdate\t#指定更新方式为滚动更新，默认策略，通过get deploy yaml查看  ... 策略控制：\n maxSurge：最大激增数, 指更新过程中, 最多可以比replicas预先设定值多出的pod数量, 可以为固定值或百分比,默认为desired Pods数的25%。计算时向上取整(比如3.4，取4)，更新过程中最多会有replicas + maxSurge个pod maxUnavailable： 指更新过程中, 最多有几个pod处于无法服务状态 , 可以为固定值或百分比，默认为desired Pods数的25%。计算时向下取整(比如3.6，取3)  在Deployment rollout时，需要保证Available(Ready) Pods数不低于 desired pods number - maxUnavailable; 保证所有的非异常状态Pods数不多于 desired pods number + maxSurge。\nreplicas=3\nrunning状态pod最大不超过3+1=4个，\nrunning状态的Pod数不低于3-0=3个\n 先新增一个v2版本的pod，目前3个v1版本+1个v2版本，共4个pod 删掉一个v1版本的pod，目前2个v1版本+1个v2版本，共3个pod 先新增一个v2版本的pod，目前2个v1版本+2个v2版本，共4个pod 删掉一个v1版本的pod，目前1个v1版本+2个v2版本，共3个pod 先新增一个v2版本的pod，目前1个v1版本+3个v2版本，共4个pod 删掉一个v1版本的pod，目前0个v1版本+3个v2版本，共3个pod  以myblog为例，使用默认的策略，更新过程:\n maxSurge 25%，2个实例，向上取整，则maxSurge为1，意味着最多可以有2+1=3个Pod，那么此时会新创建1个ReplicaSet，RS-new，把副本数置为1，此时呢，副本控制器就去创建这个新的Pod 同时，maxUnavailable是25%，副本数2*25%，向下取整，则为0，意味着，滚动更新的过程中，不能有少于2个可用的Pod，因此，旧的Replica（RS-old）会先保持不动，等RS-new管理的Pod状态Ready后，此时已经有3个Ready状态的Pod了，那么由于只要保证有2个可用的Pod即可，因此，RS-old的副本数会有2个变成1个，此时，会删掉一个旧的Pod 删掉旧的Pod的时候，由于总的Pod数量又变成2个了，因此，距离最大的3个还有1个Pod可以创建，所以，RS-new把管理的副本数由1改成2，此时又会创建1个新的Pod，等RS-new管理了2个Pod都ready后，那么就可以把RS-old的副本数由1置为0了，这样就完成了滚动更新  #查看滚动更新事件 $ kubectl -n luffy describe deploy myblog ... Events:  Type Reason Age From Message  ---- ------ ---- ---- -------  Normal ScalingReplicaSet 11s deployment-controller Scaled up replica set myblog-6cf56fc848 to 1  Normal ScalingReplicaSet 11s deployment-controller Scaled down replica set myblog-6fdcf98f9 to 1  Normal ScalingReplicaSet 11s deployment-controller Scaled up replica set myblog-6cf56fc848 to 2  Normal ScalingReplicaSet 6s deployment-controller Scaled down replica set myblog-6fdcf98f9 to 0 $ kubectl get rs NAME DESIRED CURRENT READY AGE myblog-6cf56fc848 2 2 2 16h myblog-6fdcf98f9 0 0 0 16h 服务回滚 通过滚动升级的策略可以平滑的升级Deployment，若升级出现问题，需要最快且最好的方式回退到上一次能够提供正常工作的版本。为此K8S提供了回滚机制。\nrevision：更新应用时，K8S都会记录当前的版本号，即为revision，当升级出现问题时，可通过回滚到某个特定的revision，默认配置下，K8S只会保留最近的几个revision，可以通过Deployment配置文件中的spec.revisionHistoryLimit属性增加revision数量，默认是10。\n查看当前：\n$ kubectl -n luffy rollout history deploy myblog ##CHANGE-CAUSE为空 $ kubectl delete -f deploy-myblog.yaml ## 方便演示到具体效果，删掉已有deployment 记录回滚：\n$ kubectl create -f deploy-myblog.yaml --record  $ kubectl -n luffy set image deploy myblog myblog=172.21.51.67:5000/myblog:v2 --record=true 查看deployment更新历史：\n$ kubectl -n luffy rollout history deploy myblog deployment.extensions/myblog REVISION CHANGE-CAUSE 1 kubectl create --filename=deploy-myblog.yaml --record=true 2 kubectl set image deploy myblog myblog=172.21.51.67:5000/demo/myblog:v1 --record=true 回滚到具体的REVISION:\n$ kubectl -n luffy rollout undo deploy myblog --to-revision=1 deployment.extensions/myblog rolled back  # 访问应用测试 Kubernetes服务访问之Service 通过以前的学习，我们已经能够通过Deployment来创建一组Pod来提供具有高可用性的服务。虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两个问题：\n Pod IP仅仅是集群内可见的虚拟IP，外部无法访问。 Pod IP会随着Pod的销毁而消失，当ReplicaSet对Pod进行动态伸缩时，Pod IP可能随时随地都会变化，这样对于我们访问这个服务带来了难度。  Service 负载均衡之Cluster IP service是一组pod的服务抽象，相当于一组pod的LB，负责将请求分发给对应的pod。service会为这个LB提供一个IP，一般称为cluster IP 。使用Service对象，通过selector进行标签选择，找到对应的Pod:\nmyblog/deployment/svc-myblog.yaml\napiVersion: v1 kind: Service metadata:  name: myblog  namespace: luffy spec:  ports:  - port: 80  protocol: TCP  targetPort: 8002  selector:  app: myblog  type: ClusterIP 操作演示：\n## 别名 $ alias kd='kubectl -n luffy'  ## 创建服务 $ kd create -f svc-myblog.yaml $ kd get po --show-labels NAME READY STATUS RESTARTS AGE LABELS myblog-5c97d79cdb-jn7km 1/1 Running 0 6m5s app=myblog mysql-85f4f65f99-w6jkj 1/1 Running 0 176m app=mysql  $ kd get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93  80/TCP 7m50s  $ kd describe svc myblog Name: myblog Namespace: demo Labels:  Annotations:  Selector: app=myblog Type: ClusterIP IP: 10.99.174.93 Port:  80/TCP TargetPort: 8002/TCP Endpoints: 10.244.0.68:8002 Session Affinity: None Events:   ## 扩容myblog服务 $ kd scale deploy myblog --replicas=2 deployment.extensions/myblog scaled  ## 再次查看 $ kd describe svc myblog Name: myblog Namespace: demo Labels:  Annotations:  Selector: app=myblog Type: ClusterIP IP: 10.99.174.93 Port:  80/TCP TargetPort: 8002/TCP Endpoints: 10.244.0.68:8002,10.244.1.158:8002 Session Affinity: None Events:  Service与Pod如何关联:\nservice对象创建的同时，会创建同名的endpoints对象，若服务设置了readinessProbe, 当readinessProbe检测失败时，endpoints列表中会剔除掉对应的pod_ip，这样流量就不会分发到健康检测失败的Pod中\n$ kd get endpoints myblog NAME ENDPOINTS AGE myblog 10.244.0.68:8002,10.244.1.158:8002 7m Service Cluster-IP如何访问:\n$ kd get svc myblog NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93  80/TCP 13m $ curl 10.99.174.93/blog/index/ 为mysql服务创建service：\napiVersion: v1 kind: Service metadata:  name: mysql  namespace: luffy spec:  ports:  - port: 3306  protocol: TCP  targetPort: 3306  selector:  app: mysql  type: ClusterIP 访问mysql：\n$ kd get svc mysql mysql ClusterIP 10.108.214.84  3306/TCP 3s $ curl 10.108.214.84:3306 目前使用hostNetwork部署，通过宿主机ip+port访问，弊端：\n 服务使用hostNetwork，使得宿主机的端口大量暴漏，存在安全隐患 容易引发端口冲突  服务均属于k8s集群，尽可能使用k8s的网络访问，因此可以对目前myblog访问mysql的方式做改造：\n 为mysql创建一个固定clusterIp的Service，把clusterIp配置在myblog的环境变量中 利用集群服务发现的能力，组件之间通过service name来访问  服务发现 在k8s集群中，组件之间可以通过定义的Service名称实现通信。\n演示服务发现：\n## 演示思路：在myblog的容器中直接通过service名称访问服务，观察是否可以访问通  # 先查看服务 $ kd get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93  80/TCP 59m mysql ClusterIP 10.108.214.84  3306/TCP 35m  # 进入myblog容器 $ kd exec -ti myblog-5c97d79cdb-j485f bash [root@myblog-5c97d79cdb-j485f myblog]# curl mysql:3306 5.7.29 )→ (mysql_native_password ot packets out of order [root@myblog-5c97d79cdb-j485f myblog]# curl myblog/blog/index/ 我的博客列表 虽然podip和clusterip都不固定，但是service name是固定的，而且具有完全的跨集群可移植性，因此组件之间调用的同时，完全可以通过service name去通信，这样避免了大量的ip维护成本，使得服务的yaml模板更加简单。因此可以对mysql和myblog的部署进行优化改造：\n mysql可以去掉hostNetwork部署，使得服务只暴漏在k8s集群内部网络 configMap中数据库地址可以换成Service名称，这样跨环境的时候，配置内容基本上可以保持不用变化  修改deploy-mysql.yaml\n spec:  hostNetwork: true\t# 去掉此行  volumes:  - name: mysql-data  hostPath:  path: /opt/mysql/data 修改configmap.yaml\napiVersion: v1 kind: ConfigMap metadata:  name: myblog  namespace: luffy data:  MYSQL_HOST: \"mysql\"\t# 此处替换为mysql  MYSQL_PORT: \"3306\" 应用修改：\n$ kubectl delete -f deployment-mysql.yaml  ## myblog不用动，会自动因健康检测不过而重启 服务发现实现：\nCoreDNS是一个Go语言实现的链式插件DNS服务端，是CNCF成员，是一个高性能、易扩展的DNS服务端。\n$ kubectl -n kube-system get po -o wide|grep dns coredns-d4475785-2w4hk 1/1 Running 0 4d22h 10.244.0.64 coredns-d4475785-s49hq 1/1 Running 0 4d22h 10.244.0.65  # 查看myblog的pod解析配置 $ kubectl -n luffy exec -ti myblog-5c97d79cdb-j485f bash [root@myblog-5c97d79cdb-j485f myblog]# cat /etc/resolv.conf nameserver 10.96.0.10 search luffy.svc.cluster.local svc.cluster.local cluster.local options ndots:5  ## 10.96.0.10 从哪来 $ kubectl -n kube-system get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.96.0.10  53/UDP,53/TCP 51d  ## 启动pod的时候，会把kube-dns服务的cluster-ip地址注入到pod的resolve解析配置中，同时添加对应的namespace的search域。 因此跨namespace通过service name访问的话，需要添加对应的namespace名称， service_name.namespace $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1  443/TCP 26h Service负载均衡之NodePort cluster-ip为虚拟地址，只能在k8s集群内部进行访问，集群外部如果访问内部服务，实现方式之一为使用NodePort方式。NodePort会默认在 30000-32767 ，不指定的会随机使用其中一个。\nmyblog/deployment/svc-myblog-nodeport.yaml\napiVersion: v1 kind: Service metadata:  name: myblog-np  namespace: luffy spec:  ports:  - port: 80  protocol: TCP  targetPort: 8002  selector:  app: myblog  type: NodePort 查看并访问服务：\n$ kd create -f svc-myblog-nodeport.yaml service/myblog-np created $ kd get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE myblog ClusterIP 10.99.174.93  80/TCP 102m myblog-np NodePort 10.105.228.101  80:30647/TCP 4s mysql ClusterIP 10.108.214.84  3306/TCP 77m  #集群内每个节点的NodePort端口都会进行监听 $ curl 172.21.51.67:30647/blog/index/ 我的博客列表 $ curl 172.21.51.68:30647/blog/index/ 我的博客列表 ## 浏览器访问 思考：\n  NodePort的端口监听如何转发到对应的Pod服务？\n  CLUSTER-IP为虚拟IP，集群内如何通过虚拟IP访问到具体的Pod服务？\n  kube-proxy 运行在每个节点上，监听 API Server 中服务对象的变化，再通过创建流量路由规则来实现网络的转发。参照\n有三种模式：\n User space, 让 Kube-Proxy 在用户空间监听一个端口，所有的 Service 都转发到这个端口，然后 Kube-Proxy 在内部应用层对其进行转发 ， 所有报文都走一遍用户态，性能不高，k8s v1.2版本后废弃。 Iptables， 当前默认模式，完全由 IPtables 来实现， 通过各个node节点上的iptables规则来实现service的负载均衡，但是随着service数量的增大，iptables模式由于线性查找匹配、全量更新等特点，其性能会显著下降。 IPVS， 与iptables同样基于Netfilter，但是采用的hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。 k8s 1.8版本开始引入，1.11版本开始稳定，需要开启宿主机的ipvs模块。  IPtables模式示意图：\n$ iptables-save |grep -v myblog-np|grep \"luffy/myblog\" -A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.99.174.93/32 -p tcp -m comment --comment \"demo/myblog: cluster IP\" -m tcp --dport 80 -j KUBE-MARK-MASQ -A KUBE-SERVICES -d 10.99.174.93/32 -p tcp -m comment --comment \"demo/myblog: cluster IP\" -m tcp --dport 80 -j KUBE-SVC-WQNGJ7YFZKCTKPZK  $ iptables-save |grep KUBE-SVC-WQNGJ7YFZKCTKPZK -A KUBE-SVC-WQNGJ7YFZKCTKPZK -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-GB5GNOM5CZH7ICXZ -A KUBE-SVC-WQNGJ7YFZKCTKPZK -j KUBE-SEP-7GWC3FN2JI5KLE47  $ iptables-save |grep KUBE-SEP-GB5GNOM5CZH7ICXZ -A KUBE-SEP-GB5GNOM5CZH7ICXZ -p tcp -m tcp -j DNAT --to-destination 10.244.1.158:8002  $ iptables-save |grep KUBE-SEP-7GWC3FN2JI5KLE47 -A KUBE-SEP-7GWC3FN2JI5KLE47 -p tcp -m tcp -j DNAT --to-destination 10.244.1.159:8002 Kubernetes服务访问之Ingress 对于Kubernetes的Service，无论是Cluster-Ip和NodePort均是四层的负载，集群内的服务如何实现七层的负载均衡，这就需要借助于Ingress，Ingress控制器的实现方式有很多，比如nginx, Contour, Haproxy, trafik, Istio。几种常用的ingress功能对比和选型可以参考这里\nIngress-nginx是7层的负载均衡器 ，负责统一管理外部对k8s cluster中Service的请求。主要包含：\n  ingress-nginx-controller：根据用户编写的ingress规则（创建的ingress的yaml文件），动态的去更改nginx服务的配置文件，并且reload重载使其生效（是自动化的，通过lua脚本来实现）；\n  Ingress资源对象：将Nginx的配置抽象成一个Ingress对象\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata:  name: simple-example spec:  rules:  - host: foo.bar.com  http:  paths:  - path: /  backend:  serviceName: service1  servicePort: 8080   示意图： 实现逻辑 1）ingress controller通过和kubernetes api交互，动态的去感知集群中ingress规则变化 2）然后读取ingress规则(规则就是写明了哪个域名对应哪个service)，按照自定义的规则，生成一段nginx配置 3）再写到nginx-ingress-controller的pod里，这个Ingress controller的pod里运行着一个Nginx服务，控制器把生成的nginx配置写入/etc/nginx/nginx.conf文件中 4）然后reload一下使配置生效。以此达到域名分别配置和动态更新的问题。\n安装 官方文档\n$ wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml ## 或者使用myblog/deployment/ingress/mandatory.yaml ## 修改部署节点 $ grep -n5 nodeSelector mandatory.yaml 212- spec: 213- hostNetwork: true #添加为host模式 214- # wait up to five minutes for the drain of connections 215- terminationGracePeriodSeconds: 300 216- serviceAccountName: nginx-ingress-serviceaccount 217: nodeSelector: 218- ingress: \"true\"\t#替换此处，来决定将ingress部署在哪些机器 219- containers: 220- - name: nginx-ingress-controller 221- image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0 222- args: 创建ingress\n# 为k8s-master节点添加label $ kubectl label node k8s-master ingress=true  $ kubectl create -f mandatory.yaml 使用示例：myblog/deployment/ingress.yaml \napiVersion: extensions/v1beta1 kind: Ingress metadata:  name: myblog  namespace: luffy spec:  rules:  - host: myblog.luffy.com  http:  paths:  - path: /  backend:  serviceName: myblog  servicePort: 80 ingress-nginx动态生成upstream配置：\n...  server_name myblog.luffy.com ;   listen 80 ;  listen [::]:80 ;  listen 443 ssl http2 ;  listen [::]:443 ssl http2 ;   set $proxy_upstream_name \"-\";   ssl_certificate_by_lua_block {  certificate.call()  }   location / {   set $namespace \"luffy\";  set $ingress_name \"myblog\";  ... 访问 域名解析服务，将 myblog.luffy.com解析到ingress的地址上。ingress是支持多副本的，高可用的情况下，生产的配置是使用lb服务（内网F5设备，公网elb、slb、clb，解析到各ingress的机器，如何域名指向lb地址）\n本机，添加如下hosts记录来演示效果。\n172.21.51.67 myblog.luffy.com 然后，访问 http://myblog.luffy.com/blog/index/\nHTTPS访问：\n#自签名证书 $ openssl req -x509 -nodes -days 2920 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=*.luffy.com/O=ingress-nginx\"  # 证书信息保存到secret对象中，ingress-nginx会读取secret对象解析出证书加载到nginx配置中 $ kubectl -n luffy create secret tls https-secret --key tls.key --cert tls.crt 修改yaml\napiVersion: extensions/v1beta1 kind: Ingress metadata:  name: myblog-tls  namespace: luffy spec:  rules:  - host: myblog.luffy.com  http:  paths:  - path: /  backend:  serviceName: myblog  servicePort: 80  tls:  - hosts:  - myblog.luffy.com  secretName: https-secret 然后，访问 https://myblog.luffy.com/blog/index/\n多路径转发及重写的实现   多path转发示例：\n目标：\n  myblog.luffy.com - 172.21.51.67 - /foo service1:4200 /bar service2:8080 /\tmyblog:80 ​\t实现：\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata:  name: simple-fanout-example  namespace: luffy spec:  rules:  - host: myblog.luffy.com  http:  paths:  - path: /foo  backend:  serviceName: service1  servicePort: 4200  - path: /bar  backend:  serviceName: service2  servicePort: 8080  - path: /  backend:  serviceName: myblog  servicePort: 80  nginx的URL重写\n目标：\nmyblog.luffy.com - 172.21.51.67 - /foo/ myblog:80/admin/   实现：\n apiVersion: networking.k8s.io/v1beta1  kind: Ingress  metadata:  name: rewrite-path  namespace: luffy  annotations:  nginx.ingress.kubernetes.io/rewrite-target: /admin/$1  spec:  rules:  - host: myblog.luffy.com  http:  paths:  - path: /foo/(.*)  backend:  serviceName: myblog  servicePort: 80 小结  核心讲如何通过k8s管理业务应用 介绍k8s的架构、核心组件和工作流程，使用kubeadm快速安装k8s集群 定义Pod.yaml，将myblog和mysql打包在同一个Pod中，myblog使用localhost访问mysql mysql数据持久化，为myblog业务应用添加了健康检查和资源限制 将myblog与mysql拆分，使用独立的Pod管理 yaml文件中的环境变量存在账号密码明文等敏感信息，使用configMap和Secret来统一配置，优化部署 只用Pod去直接管理业务应用，对于多副本的需求，很难实现，因此使用Deployment Workload 有了多副本，多个Pod如何去实现LB入口，因此引入了Service的资源类型，有CLusterIp和NodePort ClusterIP是四层的IP地址，不固定，不具备跨环境迁移，因此利用coredns实现集群内服务发现，组件之间直接通过Service名称通信，实现配置的去IP化 对Django应用做改造，django直接使用mysql:3306实现数据库访问 为了实现在集群外部对集群内服务的访问，因此创建NodePort类型的Service 介绍了Service的实现原理，通过kube-proxy利用iptables或者ipvs维护服务访问规则，实现虚拟IP转发到具体Pod的需求 为了实现集群外使用域名访问myblog，因此引入Ingress资源，通过定义访问规则，实现七层代理 考虑真实的场景，对Ingress的使用做了拓展，介绍多path转发及nginx URL重写的实现  ",
  "wordCount" : "3762",
  "inLanguage": "zh",
  "datePublished": "2022-01-04T15:11:03Z",
  "dateModified": "2022-01-04T15:11:03Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iblog.zone/archives/kubernetes%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5%E4%B9%8B%E6%97%85/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ylw's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iblog.zone/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iblog.zone" accesskey="h" title="ylw&#39;s blog (Alt + H)">ylw&#39;s blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iblog.zone/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://iblog.zone/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://iblog.zone">主页</a>&nbsp;»&nbsp;<a href="https://iblog.zone/posts/">Posts</a></div>
    <h1 class="post-title">
      Kubernetes落地实践之旅
    </h1>
    <div class="post-meta"><span title='2022-01-04 15:11:03 +0000 UTC'>2022-01-04</span>&nbsp;·&nbsp;18 分钟

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e7%ac%ac%e4%ba%8c%e5%a4%a9--kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85" aria-label="第二天  Kubernetes落地实践之旅">第二天  Kubernetes落地实践之旅</a><ul>
                            
                    <li>
                        <a href="#%e7%ba%af%e5%ae%b9%e5%99%a8%e6%a8%a1%e5%bc%8f%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="纯容器模式的问题">纯容器模式的问题</a></li>
                    <li>
                        <a href="#%e5%ae%b9%e5%99%a8%e8%b0%83%e5%ba%a6%e7%ae%a1%e7%90%86%e5%b9%b3%e5%8f%b0" aria-label="容器调度管理平台">容器调度管理平台</a></li>
                    <li>
                        <a href="#%e6%9e%b6%e6%9e%84%e5%9b%be" aria-label="架构图">架构图</a></li>
                    <li>
                        <a href="#%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6" aria-label="核心组件">核心组件</a></li>
                    <li>
                        <a href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" aria-label="工作流程">工作流程</a></li>
                    <li>
                        <a href="#%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e7%9a%84%e5%87%a0%e7%82%b9%e6%80%9d%e8%80%83" aria-label="架构设计的几点思考">架构设计的几点思考</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5--%e9%9b%86%e7%be%a4%e5%ae%89%e8%a3%85" aria-label="实践&amp;ndash;集群安装">实践&ndash;集群安装</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#k8s%e9%9b%86%e7%be%a4%e4%b8%bb%e6%b5%81%e5%ae%89%e8%a3%85%e6%96%b9%e5%bc%8f%e5%af%b9%e6%af%94%e5%88%86%e6%9e%90" aria-label="k8s集群主流安装方式对比分析">k8s集群主流安装方式对比分析</a></li>
                    <li>
                        <a href="#%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6-1" aria-label="核心组件">核心组件</a></li>
                    <li>
                        <a href="#%e7%90%86%e8%a7%a3%e9%9b%86%e7%be%a4%e8%b5%84%e6%ba%90" aria-label="理解集群资源">理解集群资源</a></li>
                    <li>
                        <a href="#kubectl%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="kubectl的使用">kubectl的使用</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%9e%e8%b7%b5--%e4%bd%bf%e7%94%a8k8s%e7%ae%a1%e7%90%86%e4%b8%9a%e5%8a%a1%e5%ba%94%e7%94%a8" aria-label="实践&amp;ndash;使用k8s管理业务应用">实践&ndash;使用k8s管理业务应用</a><ul>
                            
                    <li>
                        <a href="#%e6%9c%80%e5%b0%8f%e8%b0%83%e5%ba%a6%e5%8d%95%e5%85%83-pod" aria-label="最小调度单元 Pod">最小调度单元 Pod</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%bc%95%e5%85%a5pod" aria-label="为什么引入Pod">为什么引入Pod</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8yaml%e6%a0%bc%e5%bc%8f%e5%ae%9a%e4%b9%89pod" aria-label="使用yaml格式定义Pod">使用yaml格式定义Pod</a></li>
                    <li>
                        <a href="#%e5%88%9b%e5%bb%ba%e5%92%8c%e8%ae%bf%e9%97%aepod" aria-label="创建和访问Pod">创建和访问Pod</a></li>
                    <li>
                        <a href="#infra%e5%ae%b9%e5%99%a8" aria-label="Infra容器">Infra容器</a></li>
                    <li>
                        <a href="#%e6%9f%a5%e7%9c%8bpod%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af" aria-label="查看pod详细信息">查看pod详细信息</a></li>
                    <li>
                        <a href="#troubleshooting-and-debugging" aria-label="Troubleshooting and Debugging">Troubleshooting and Debugging</a></li>
                    <li>
                        <a href="#%e6%9b%b4%e6%96%b0%e6%9c%8d%e5%8a%a1%e7%89%88%e6%9c%ac" aria-label="更新服务版本">更新服务版本</a></li>
                    <li>
                        <a href="#%e5%88%a0%e9%99%a4pod%e6%9c%8d%e5%8a%a1" aria-label="删除Pod服务">删除Pod服务</a></li>
                    <li>
                        <a href="#pod%e6%95%b0%e6%8d%ae%e6%8c%81%e4%b9%85%e5%8c%96" aria-label="Pod数据持久化">Pod数据持久化</a></li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5" aria-label="服务健康检查">服务健康检查</a></li>
                    <li>
                        <a href="#%e9%87%8d%e5%90%af%e7%ad%96%e7%95%a5" aria-label="重启策略">重启策略</a></li>
                    <li>
                        <a href="#%e9%95%9c%e5%83%8f%e6%8b%89%e5%8f%96%e7%ad%96%e7%95%a5" aria-label="镜像拉取策略">镜像拉取策略</a></li>
                    <li>
                        <a href="#pod%e8%b5%84%e6%ba%90%e9%99%90%e5%88%b6" aria-label="Pod资源限制">Pod资源限制</a></li>
                    <li>
                        <a href="#yaml%e4%bc%98%e5%8c%96" aria-label="yaml优化">yaml优化</a></li>
                    <li>
                        <a href="#%e5%a6%82%e4%bd%95%e7%bc%96%e5%86%99%e8%b5%84%e6%ba%90yaml" aria-label="如何编写资源yaml">如何编写资源yaml</a></li>
                    <li>
                        <a href="#pod%e7%8a%b6%e6%80%81%e4%b8%8e%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="pod状态与生命周期">pod状态与生命周期</a></li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a></li></ul>
                    </li>
                    <li>
                        <a href="#pod%e6%8e%a7%e5%88%b6%e5%99%a8" aria-label="Pod控制器">Pod控制器</a><ul>
                            
                    <li>
                        <a href="#workload-%e5%b7%a5%e4%bd%9c%e8%b4%9f%e8%bd%bd" aria-label="Workload (工作负载)">Workload (工作负载)</a></li>
                    <li>
                        <a href="#deployment" aria-label="Deployment">Deployment</a></li>
                    <li>
                        <a href="#%e5%88%9b%e5%bb%badeployment" aria-label="创建Deployment">创建Deployment</a></li>
                    <li>
                        <a href="#%e6%9f%a5%e7%9c%8bdeployment" aria-label="查看Deployment">查看Deployment</a></li>
                    <li>
                        <a href="#%e5%89%af%e6%9c%ac%e4%bf%9d%e9%9a%9c%e6%9c%ba%e5%88%b6" aria-label="副本保障机制">副本保障机制</a></li>
                    <li>
                        <a href="#pod%e9%a9%b1%e9%80%90%e7%ad%96%e7%95%a5" aria-label="Pod驱逐策略">Pod驱逐策略</a></li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e6%9b%b4%e6%96%b0" aria-label="服务更新">服务更新</a></li>
                    <li>
                        <a href="#%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5" aria-label="更新策略">更新策略</a></li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e5%9b%9e%e6%bb%9a" aria-label="服务回滚">服务回滚</a></li></ul>
                    </li>
                    <li>
                        <a href="#kubernetes%e6%9c%8d%e5%8a%a1%e8%ae%bf%e9%97%ae%e4%b9%8bservice" aria-label="Kubernetes服务访问之Service">Kubernetes服务访问之Service</a><ul>
                            
                    <li>
                        <a href="#service-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e4%b9%8bcluster-ip" aria-label="Service 负载均衡之Cluster IP">Service 负载均衡之Cluster IP</a></li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0" aria-label="服务发现">服务发现</a></li>
                    <li>
                        <a href="#service%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e4%b9%8bnodeport" aria-label="Service负载均衡之NodePort">Service负载均衡之NodePort</a></li>
                    <li>
                        <a href="#kube-proxy" aria-label="kube-proxy">kube-proxy</a></li></ul>
                    </li>
                    <li>
                        <a href="#kubernetes%e6%9c%8d%e5%8a%a1%e8%ae%bf%e9%97%ae%e4%b9%8bingress" aria-label="Kubernetes服务访问之Ingress">Kubernetes服务访问之Ingress</a><ul>
                            
                    <li>
                        <a href="#%e7%a4%ba%e6%84%8f%e5%9b%be" aria-label="示意图：">示意图：</a></li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0%e9%80%bb%e8%be%91" aria-label="实现逻辑">实现逻辑</a></li>
                    <li>
                        <a href="#%e5%ae%89%e8%a3%85" aria-label="安装">安装</a></li>
                    <li>
                        <a href="#%e8%ae%bf%e9%97%ae" aria-label="访问">访问</a></li>
                    <li>
                        <a href="#%e5%a4%9a%e8%b7%af%e5%be%84%e8%bd%ac%e5%8f%91%e5%8f%8a%e9%87%8d%e5%86%99%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="多路径转发及重写的实现">多路径转发及重写的实现</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93-1" aria-label="小结">小结</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script data-cfasync="false">
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><h3 id="第二天--kubernetes落地实践之旅">第二天  Kubernetes落地实践之旅<a hidden class="anchor" aria-hidden="true" href="#第二天--kubernetes落地实践之旅">#</a></h3>
<p>本章学习kubernetes的架构及工作流程，重点介绍如何使用Workload管理业务应用的生命周期，实现服务不中断的滚动更新，通过服务发现和集群内负载均衡来实现集群内部的服务间访问，并通过ingress实现外部使用域名访问集群内部的服务。</p>
<p>学习过程中会逐步对Django项目做k8s改造，从零开始编写所需的资源文件。通过本章的学习，学员会掌握高可用k8s集群的搭建，同时Django demo项目已经可以利用k8s的控制器、服务发现、负载均衡、配置管理等特性来实现生命周期的管理。</p>
<h4 id="纯容器模式的问题">纯容器模式的问题<a hidden class="anchor" aria-hidden="true" href="#纯容器模式的问题">#</a></h4>
<ol>
<li>业务容器数量庞大，哪些容器部署在哪些节点，使用了哪些端口，如何记录、管理，需要登录到每台机器去管理？</li>
<li>跨主机通信，多个机器中的容器之间相互调用如何做，iptables规则手动维护？</li>
<li>跨主机容器间互相调用，配置如何写？写死固定IP+端口？</li>
<li>如何实现业务高可用？多个容器对外提供服务如何实现负载均衡？</li>
<li>容器的业务中断了，如何可以感知到，感知到以后，如何自动启动新的容器?</li>
<li>如何实现滚动升级保证业务的连续性？</li>
<li>&hellip;&hellip;</li>
</ol>
<h4 id="容器调度管理平台">容器调度管理平台<a hidden class="anchor" aria-hidden="true" href="#容器调度管理平台">#</a></h4>
<p>Docker Swarm       Mesos        Google Kubernetes</p>
<p>2017年开始Kubernetes凭借强大的容器集群管理功能, 逐步占据市场,目前在容器编排领域一枝独秀</p>
<p><a href="https://kubernetes.io/">https://kubernetes.io/</a></p>
<h4 id="架构图">架构图<a hidden class="anchor" aria-hidden="true" href="#架构图">#</a></h4>
<p>分布式系统，两类角色：管理节点和工作节点</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/architecture.png" alt=""  />
</p>
<h4 id="核心组件">核心组件<a hidden class="anchor" aria-hidden="true" href="#核心组件">#</a></h4>
<ul>
<li>
<p>ETCD：分布式高性能键值数据库,存储整个集群的所有元数据</p>
</li>
<li>
<p>ApiServer:  API服务器,集群资源访问控制入口,提供restAPI及安全访问控制</p>
</li>
<li>
<p>Scheduler：调度器,负责把业务容器调度到最合适的Node节点</p>
</li>
<li>
<p>Controller Manager：控制器管理,确保集群资源按照期望的方式运行</p>
<ul>
<li>Replication Controller</li>
<li>Node controller</li>
<li>ResourceQuota Controller</li>
<li>Namespace Controller</li>
<li>ServiceAccount Controller</li>
<li>Token Controller</li>
<li>Service Controller</li>
<li>Endpoints Controller</li>
</ul>
</li>
<li>
<p>kubelet：运行在每个节点上的主要的“节点代理”，脏活累活</p>
<ul>
<li>pod 管理：kubelet 定期从所监听的数据源获取节点上 pod/container 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。</li>
<li>容器健康检查：kubelet 创建了容器之后还要查看容器是否正常运行，如果容器运行出错，就要根据 pod 设置的重启策略进行处理.</li>
<li>容器监控：kubelet 会监控所在节点的资源使用情况，并定时向 master 报告，资源使用数据都是通过 cAdvisor 获取的。知道整个集群所有节点的资源情况，对于 pod 的调度和正常运行至关重要</li>
</ul>
</li>
<li>
<p>kube-proxy：维护节点中的iptables或者ipvs规则</p>
</li>
<li>
<p>kubectl: 命令行接口，用于对 Kubernetes 集群运行命令  <a href="https://kubernetes.io/zh/docs/reference/kubectl/">https://kubernetes.io/zh/docs/reference/kubectl/</a></p>
</li>
</ul>
<h4 id="工作流程">工作流程<a hidden class="anchor" aria-hidden="true" href="#工作流程">#</a></h4>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/process.png" alt=""  />
</p>
<ol>
<li>用户准备一个资源文件（记录了业务应用的名称、镜像地址等信息），通过调用APIServer执行创建Pod</li>
<li>APIServer收到用户的Pod创建请求，将Pod信息写入到etcd中</li>
<li>调度器通过list-watch的方式，发现有新的pod数据，但是这个pod还没有绑定到某一个节点中</li>
<li>调度器通过调度算法，计算出最适合该pod运行的节点，并调用APIServer，把信息更新到etcd中</li>
<li>kubelet同样通过list-watch方式，发现有新的pod调度到本机的节点了，因此调用容器运行时，去根据pod的描述信息，拉取镜像，启动容器，同时生成事件信息</li>
<li>同时，把容器的信息、事件及状态也通过APIServer写入到etcd中</li>
</ol>
<h4 id="架构设计的几点思考">架构设计的几点思考<a hidden class="anchor" aria-hidden="true" href="#架构设计的几点思考">#</a></h4>
<ol>
<li>系统各个组件分工明确(APIServer是所有请求入口，CM是控制中枢，Scheduler主管调度，而Kubelet负责运行)，配合流畅，整个运行机制一气呵成。</li>
<li>除了配置管理和持久化组件ETCD，其他组件并不保存数据。意味<code>除ETCD外</code>其他组件都是无状态的。因此从架构设计上对kubernetes系统高可用部署提供了支撑。</li>
<li>同时因为组件无状态，组件的升级，重启，故障等并不影响集群最终状态，只要组件恢复后就可以从中断处继续运行。</li>
<li>各个组件和kube-apiserver之间的数据推送都是通过list-watch机制来实现。</li>
</ol>
<h4 id="实践--集群安装">实践&ndash;集群安装<a hidden class="anchor" aria-hidden="true" href="#实践--集群安装">#</a></h4>
<h6 id="k8s集群主流安装方式对比分析">k8s集群主流安装方式对比分析<a hidden class="anchor" aria-hidden="true" href="#k8s集群主流安装方式对比分析">#</a></h6>
<ul>
<li>minikube</li>
<li>二进制安装</li>
<li>kubeadm等安装工具</li>
</ul>
<p>kubeadm  <a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/</a></p>
<p>《Kubernetes安装手册（非高可用版）》</p>
<h6 id="核心组件-1">核心组件<a hidden class="anchor" aria-hidden="true" href="#核心组件-1">#</a></h6>
<p>静态Pod的方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## etcd、apiserver、controller-manager、kube-scheduler</span>
</span></span><span style="display:flex;"><span>$ kubectl -n kube-system get po
</span></span></code></pre></div><p>systemd服务方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ systemctl status kubelet
</span></span></code></pre></div><p>kubectl：二进制命令行工具</p>
<h6 id="理解集群资源">理解集群资源<a hidden class="anchor" aria-hidden="true" href="#理解集群资源">#</a></h6>
<p>组件是为了支撑k8s平台的运行，安装好的软件。</p>
<p>资源是如何去使用k8s的能力的定义。比如，k8s可以使用Pod来管理业务应用，那么Pod就是k8s集群中的一类资源，集群中的所有资源可以提供如下方式查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl api-resources
</span></span></code></pre></div><p>如何理解namespace：</p>
<p>命名空间，集群内一个虚拟的概念，类似于资源池的概念，一个池子里可以有各种资源类型，绝大多数的资源都必须属于某一个namespace。集群初始化安装好之后，会默认有如下几个namespace：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl get namespaces
</span></span><span style="display:flex;"><span>NAME                   STATUS   AGE
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">default</span>                Active   84m
</span></span><span style="display:flex;"><span>kube-node-lease        Active   84m
</span></span><span style="display:flex;"><span>kube-public            Active   84m
</span></span><span style="display:flex;"><span>kube-system            Active   84m
</span></span><span style="display:flex;"><span>kubernetes-dashboard   Active   71m
</span></span></code></pre></div><ul>
<li>所有NAMESPACED的资源，在创建的时候都需要指定namespace，若不指定，默认会在default命名空间下</li>
<li>相同namespace下的同类资源不可以重名，不同类型的资源可以重名</li>
<li>不同namespace下的同类资源可以重名</li>
<li>通常在项目使用的时候，我们会创建带有业务含义的namespace来做逻辑上的整合</li>
</ul>
<h6 id="kubectl的使用">kubectl的使用<a hidden class="anchor" aria-hidden="true" href="#kubectl的使用">#</a></h6>
<p>类似于docker，kubectl是命令行工具，用于与APIServer交互，内置了丰富的子命令，功能极其强大。 <a href="https://kubernetes.io/docs/reference/kubectl/overview/">https://kubernetes.io/docs/reference/kubectl/overview/</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -h
</span></span><span style="display:flex;"><span>$ kubectl get -h
</span></span><span style="display:flex;"><span>$ kubectl create -h
</span></span><span style="display:flex;"><span>$ kubectl create namespace -h
</span></span></code></pre></div><h4 id="实践--使用k8s管理业务应用">实践&ndash;使用k8s管理业务应用<a hidden class="anchor" aria-hidden="true" href="#实践--使用k8s管理业务应用">#</a></h4>
<h5 id="最小调度单元-pod">最小调度单元 Pod<a hidden class="anchor" aria-hidden="true" href="#最小调度单元-pod">#</a></h5>
<p>docker调度的是容器，在k8s集群中，最小的调度单元是Pod（豆荚）</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/pod-demo.png" alt=""  />
</p>
<h6 id="为什么引入pod">为什么引入Pod<a hidden class="anchor" aria-hidden="true" href="#为什么引入pod">#</a></h6>
<ul>
<li>
<p>与容器引擎解耦</p>
<p>Docker、Rkt。平台设计与引擎的具体的实现解耦</p>
</li>
<li>
<p>多容器共享网络|存储|进程 空间, 支持的业务场景更加灵活</p>
</li>
</ul>
<h6 id="使用yaml格式定义pod">使用yaml格式定义Pod<a hidden class="anchor" aria-hidden="true" href="#使用yaml格式定义pod">#</a></h6>
<p><em>myblog/one-pod/pod.yaml</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST  </span> <span style="color:#75715e">#  指定root用户的用户名</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/mysql:5.7-utf8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>,		
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;Pod&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;metadata&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;namespace&#34;</span>: <span style="color:#e6db74">&#34;luffy&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;labels&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;component&#34;</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;spec&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&#34;containers&#34;</span>: [
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&#34;image&#34;</span>: <span style="color:#e6db74">&#34;172.21.51.67:5000/myblog&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;env&#34;</span>: [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;MYSQL_HOST&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;MYSQL_PASSWD&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                ],
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">&#34;ports&#34;</span>: [
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">&#34;containerPort&#34;</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				]
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>    		{
</span></span><span style="display:flex;"><span>    			<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;mysql&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">apiVersion</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">alpha</td>
<td style="text-align:left">进入K8s功能的早期候选版本，可能包含Bug，最终不一定进入K8s</td>
</tr>
<tr>
<td style="text-align:left">beta</td>
<td style="text-align:left">已经过测试的版本，最终会进入K8s，但功能、对象定义可能会发生变更。</td>
</tr>
<tr>
<td style="text-align:left">stable</td>
<td style="text-align:left">可安全使用的稳定版本</td>
</tr>
<tr>
<td style="text-align:left">v1</td>
<td style="text-align:left">stable 版本之后的首个版本，包含了更多的核心对象</td>
</tr>
<tr>
<td style="text-align:left">apps/v1</td>
<td style="text-align:left">使用最广泛的版本，像Deployment、ReplicaSets都已进入该版本</td>
</tr>
</tbody>
</table>
<p>资源类型与apiVersion对照表</p>
<table>
<thead>
<tr>
<th style="text-align:left">Kind</th>
<th style="text-align:left">apiVersion</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ClusterRoleBinding</td>
<td style="text-align:left">rbac.authorization.k8s.io/v1</td>
</tr>
<tr>
<td style="text-align:left">ClusterRole</td>
<td style="text-align:left">rbac.authorization.k8s.io/v1</td>
</tr>
<tr>
<td style="text-align:left">ConfigMap</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">CronJob</td>
<td style="text-align:left">batch/v1beta1</td>
</tr>
<tr>
<td style="text-align:left">DaemonSet</td>
<td style="text-align:left">extensions/v1beta1</td>
</tr>
<tr>
<td style="text-align:left">Node</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">Namespace</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">Secret</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">PersistentVolume</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">PersistentVolumeClaim</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">Pod</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">Deployment</td>
<td style="text-align:left">v1、apps/v1、apps/v1beta1、apps/v1beta2</td>
</tr>
<tr>
<td style="text-align:left">Service</td>
<td style="text-align:left">v1</td>
</tr>
<tr>
<td style="text-align:left">Ingress</td>
<td style="text-align:left">extensions/v1beta1</td>
</tr>
<tr>
<td style="text-align:left">ReplicaSet</td>
<td style="text-align:left">apps/v1、apps/v1beta2</td>
</tr>
<tr>
<td style="text-align:left">Job</td>
<td style="text-align:left">batch/v1</td>
</tr>
<tr>
<td style="text-align:left">StatefulSet</td>
<td style="text-align:left">apps/v1、apps/v1beta1、apps/v1beta2</td>
</tr>
</tbody>
</table>
<p>快速获得资源和版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl explain pod
</span></span><span style="display:flex;"><span>$ kubectl explain Pod.apiVersion
</span></span></code></pre></div><h6 id="创建和访问pod">创建和访问Pod<a hidden class="anchor" aria-hidden="true" href="#创建和访问pod">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 创建namespace, namespace是逻辑上的资源池</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace luffy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 使用指定文件创建Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> pod.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看pod，可以简写po</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 所有的操作都需要指定namespace，如果是在default命名空间下，则可以省略</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get pods -o wide
</span></span><span style="display:flex;"><span>NAME     READY   STATUS    RESTARTS   AGE    IP             NODE
</span></span><span style="display:flex;"><span>myblog   2/2     Running   0          3m     10.244.1.146   k8s-slave1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 使用Pod Ip访问服务,3306和8002</span>
</span></span><span style="display:flex;"><span>$ curl 10.244.1.146<span style="color:#960050;background-color:#1e0010">:</span>8002/blog/index/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 进入容器,执行初始化, 不必到对应的主机执行docker exec</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy exec -ti myblog -c myblog bash
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># env</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># python3 manage.py migrate</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy exec -ti myblog -c mysql bash
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># mysql -p123456</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 再次访问服务,3306和8002</span>
</span></span><span style="display:flex;"><span>$ curl 10.244.1.146<span style="color:#960050;background-color:#1e0010">:</span>8002/blog/index/
</span></span></code></pre></div><h6 id="infra容器">Infra容器<a hidden class="anchor" aria-hidden="true" href="#infra容器">#</a></h6>
<p>登录<code>k8s-slave1</code>节点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ docker ps -a |grep myblog  <span style="color:#75715e">## 发现有三个容器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 其中包含mysql和myblog程序以及Infra容器</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 为了实现Pod内部的容器可以通过localhost通信，每个Pod都会启动Infra容器，然后Pod内部的其他容器的网络空间会共享该Infra容器的网络空间(Docker网络的container模式)，Infra容器只需要hang住网络空间，不需要额外的功能，因此资源消耗极低。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 登录master节点，查看pod内部的容器ip均相同，为pod ip</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy exec -ti myblog -c myblog bash
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># ifconfig</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy exec -ti myblog -c mysql bash
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># ifconfig</span>
</span></span></code></pre></div><p>pod容器命名: <code>k8s_&lt;container_name&gt;_&lt;pod_name&gt;_&lt;namespace&gt;_&lt;random_string&gt;</code></p>
<h6 id="查看pod详细信息">查看pod详细信息<a hidden class="anchor" aria-hidden="true" href="#查看pod详细信息">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 查看pod调度节点及pod_ip</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get pods -o wide
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看完整的yaml</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po myblog -o yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看pod的明细信息及事件</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy describe pod myblog
</span></span></code></pre></div><h6 id="troubleshooting-and-debugging">Troubleshooting and Debugging<a hidden class="anchor" aria-hidden="true" href="#troubleshooting-and-debugging">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#进入Pod内的容器</span>
</span></span><span style="display:flex;"><span>$ kubectl -n &lt;namespace&gt; exec &lt;pod_name&gt; -c &lt;container_name&gt; -ti /bin/sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#查看Pod内容器日志,显示标准或者错误输出日志</span>
</span></span><span style="display:flex;"><span>$ kubectl -n &lt;namespace&gt; logs <span style="color:#f92672">-f</span> &lt;pod_name&gt; -c &lt;container_name&gt;
</span></span></code></pre></div><h6 id="更新服务版本">更新服务版本<a hidden class="anchor" aria-hidden="true" href="#更新服务版本">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl apply <span style="color:#f92672">-f</span> demo-pod.yaml
</span></span></code></pre></div><h6 id="删除pod服务">删除Pod服务<a hidden class="anchor" aria-hidden="true" href="#删除pod服务">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#根据文件删除</span>
</span></span><span style="display:flex;"><span>$ kubectl delete <span style="color:#f92672">-f</span> demo-pod.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#根据pod_name删除</span>
</span></span><span style="display:flex;"><span>$ kubectl -n &lt;namespace&gt; delete pod &lt;pod_name&gt;
</span></span></code></pre></div><h6 id="pod数据持久化">Pod数据持久化<a hidden class="anchor" aria-hidden="true" href="#pod数据持久化">#</a></h6>
<p>若删除了Pod，由于mysql的数据都在容器内部，会造成数据丢失，因此需要数据进行持久化。</p>
<ul>
<li>
<p>定点使用hostpath挂载，nodeSelector定点</p>
<p><code>myblog/one-pod/pod-with-volume.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/mysql/data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>:   <span style="color:#75715e"># 使用节点选择器将Pod调度到指定label的节点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST  </span> <span style="color:#75715e">#  指定root用户的用户名</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/mysql:5.7-utf8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/mysql</span>
</span></span></code></pre></div><p>保存文件为<code>pod-with-volume.yaml</code>，执行创建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 若存在旧的同名服务，先删除掉，后创建</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy delete pod myblog
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 创建</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> pod-with-volume.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 此时pod状态Pending</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po
</span></span><span style="display:flex;"><span>NAME     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>myblog   0/2     Pending   0          32s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看原因，提示调度失败，因为节点不满足node selector</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy describe po myblog
</span></span><span style="display:flex;"><span>Events<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  Type     Reason            Age                From               Message
</span></span><span style="display:flex;"><span>  ----     ------            ----               ----               -------
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling  12s (x2 over 12s)  default-scheduler  0/3 nodes are available<span style="color:#960050;background-color:#1e0010">:</span> 3 node(s) didn<span style="color:#960050;background-color:#1e0010">&#39;</span>t match node selector.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 为节点打标签</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-slave1 component=mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 再次查看，已经运行成功</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po
</span></span><span style="display:flex;"><span>NAME     READY   STATUS    RESTARTS   AGE     IP             NODE
</span></span><span style="display:flex;"><span>myblog   2/2     Running   0          3m54s   10.244.1.150   k8s-slave1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 到k8s-slave1节点，查看/opt/mysql/data</span>
</span></span><span style="display:flex;"><span>$ ll /opt/mysql/data/
</span></span><span style="display:flex;"><span>total 188484
</span></span><span style="display:flex;"><span>-rw-r----- 1 polkitd input       56 Mar 29 09<span style="color:#960050;background-color:#1e0010">:</span>20 auto.cnf
</span></span><span style="display:flex;"><span>-rw------- 1 polkitd input     1676 Mar 29 09<span style="color:#960050;background-color:#1e0010">:</span>20 ca-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 polkitd input     1112 Mar 29 09<span style="color:#960050;background-color:#1e0010">:</span>20 ca.pem
</span></span><span style="display:flex;"><span>drwxr-x--- 2 polkitd input     8192 Mar 29 09<span style="color:#960050;background-color:#1e0010">:</span>20 sys
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 执行migrate，创建数据库表，然后删掉pod，再次创建后验证数据是否存在</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy exec -ti myblog python3 manage.py migrate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 访问服务，正常</span>
</span></span><span style="display:flex;"><span>$ curl 10.244.1.150<span style="color:#960050;background-color:#1e0010">:</span>8002/blog/index/ 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 删除pod</span>
</span></span><span style="display:flex;"><span>$ kubectl delete <span style="color:#f92672">-f</span> pod-with-volume.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 再次创建Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> pod-with-volume.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看pod ip并访问服务</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -o wide
</span></span><span style="display:flex;"><span>NAME     READY   STATUS    RESTARTS   AGE   IP             NODE  
</span></span><span style="display:flex;"><span>myblog   2/2     Running   0          7s    10.244.1.151   k8s-slave1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 未重新做migrate，服务正常</span>
</span></span><span style="display:flex;"><span>$ curl 10.244.1.151<span style="color:#960050;background-color:#1e0010">:</span>8002/blog/index/
</span></span></code></pre></div></li>
<li>
<p>使用PV+PVC连接分布式存储解决方案</p>
<ul>
<li>ceph</li>
<li>glusterfs</li>
<li>nfs</li>
</ul>
</li>
</ul>
<h6 id="服务健康检查">服务健康检查<a hidden class="anchor" aria-hidden="true" href="#服务健康检查">#</a></h6>
<p>检测容器服务是否健康的手段，若不健康，会根据设置的重启策略（restartPolicy）进行操作，两种检测机制可以分别单独设置，若不设置，默认认为Pod是健康的。</p>
<p>两种机制：</p>
<ul>
<li>
<p>LivenessProbe探针
存活性探测：用于判断容器是否存活，即Pod是否为running状态，如果LivenessProbe探针探测到容器不健康，则kubelet将kill掉容器，并根据容器的重启策略是否重启，如果一个容器不包含LivenessProbe探针，则Kubelet认为容器的LivenessProbe探针的返回值永远成功。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span> 	<span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>		<span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/livenessprobe.webp" alt=""  />
</p>
</li>
<li>
<p>ReadinessProbe探针
可用性探测：用于判断容器是否正常提供服务，即容器的Ready是否为True，是否可以接收请求，如果ReadinessProbe探测失败，则容器的Ready将为False， Endpoint Controller 控制器将此Pod的Endpoint从对应的service的Endpoint列表中移除，不再将任何请求调度此Pod上，直到下次探测成功。（剔除此pod不参与接收请求不会将流量转发给此Pod）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/readnessprobe.webp" alt=""  />
</p>
</li>
</ul>
<p>三种类型：</p>
<ul>
<li>exec：通过执行命令来检查服务是否正常，返回值为0则表示容器健康</li>
<li>httpGet方式：通过发送http请求检查服务是否正常，返回200-399状态码则表明容器健康</li>
<li>tcpSocket：通过容器的IP和Port执行TCP检查，如果能够建立TCP连接，则表明容器健康</li>
</ul>
<p>示例：</p>
<p>完整文件路径 <code>myblog/one-pod/pod-with-healthcheck.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST  </span> <span style="color:#75715e">#  指定root用户的用户名</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span> 	<span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>		<span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><ul>
<li>initialDelaySeconds：容器启动后第一次执行探测时需要等待多少秒。</li>
<li>periodSeconds：执行探测的频率。默认是10秒，最小1秒。</li>
<li>timeoutSeconds：探测超时时间。默认1秒，最小1秒。</li>
<li>successThreshold：探测失败后，最少连续探测成功多少次才被认定为成功。默认是1。</li>
<li>failureThreshold：探测成功后，最少连续探测失败多少次才被认定为失败。默认是3，最小值是1。</li>
</ul>
<p>K8S将在Pod开始<strong>启动10s(initialDelaySeconds)后</strong>利用HTTP访问8002端口的/blog/index/，如果<strong>超过2s</strong>或者返回码不在200~399内，则健康检查失败</p>
<h6 id="重启策略">重启策略<a hidden class="anchor" aria-hidden="true" href="#重启策略">#</a></h6>
<p>Pod的重启策略（RestartPolicy）应用于Pod内的所有容器，并且仅在Pod所处的Node上由kubelet进行判断和重启操作。当某个容器异常退出或者健康检查失败时，kubelet将根据RestartPolicy的设置来进行相应的操作。
Pod的重启策略包括Always、OnFailure和Never，默认值为Always。</p>
<ul>
<li>Always：当容器进程退出后，由kubelet自动重启该容器；</li>
<li>OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器；</li>
<li>Never：不论容器运行状态如何，kubelet都不会重启该容器。</li>
</ul>
<p>演示重启策略：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-restart-policy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">OnFailure</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/bin/sh</span>
</span></span><span style="display:flex;"><span>    - -<span style="color:#ae81ff">c</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">sleep 10 &amp;&amp; exit 0</span>
</span></span></code></pre></div><ol>
<li>使用默认的重启策略，即 restartPolicy: Always ，无论容器是否是正常退出，都会自动重启容器</li>
<li>使用OnFailure的策略时
<ul>
<li>如果把exit 1，去掉，即让容器的进程正常退出的话，则不会重启</li>
<li>只有非正常退出状态才会重启</li>
</ul>
</li>
<li>使用Never时，退出了就不再重启</li>
</ol>
<p>可以看出，若容器正常退出，Pod的状态会是Completed，非正常退出，状态为CrashLoopBackOff</p>
<h6 id="镜像拉取策略">镜像拉取策略<a hidden class="anchor" aria-hidden="true" href="#镜像拉取策略">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/demo/myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span></code></pre></div><p>设置镜像的拉取策略，默认为IfNotPresent</p>
<ul>
<li>Always，总是拉取镜像，即使本地有镜像也从仓库拉取</li>
<li>IfNotPresent ，本地有则使用本地镜像，本地没有则去仓库拉取</li>
<li>Never，只使用本地镜像，本地没有则报错</li>
</ul>
<h6 id="pod资源限制">Pod资源限制<a hidden class="anchor" aria-hidden="true" href="#pod资源限制">#</a></h6>
<p>为了保证充分利用集群资源，且确保重要容器在运行周期内能够分配到足够的资源稳定运行，因此平台需要具备</p>
<p>Pod的资源限制的能力。 对于一个pod来说，资源最基础的2个的指标就是：CPU和内存。</p>
<p>Kubernetes提供了个采用requests和limits 两种类型参数对资源进行预分配和使用限制。</p>
<p>完整文件路径：<code>myblog/one-pod/pod-with-resourcelimits.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST  </span> <span style="color:#75715e">#  指定root用户的用户名</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>requests：</p>
<ul>
<li>容器使用的最小资源需求,作用于schedule阶段，作为容器调度时资源分配的判断依赖</li>
<li>只有当前节点上可分配的资源量 &gt;= request 时才允许将容器调度到该节点</li>
<li>request参数不限制容器的最大可使用资源</li>
<li>requests.cpu被转成docker的&ndash;cpu-shares参数，与cgroup cpu.shares功能相同 (无论宿主机有多少个cpu或者内核，&ndash;cpu-shares选项都会按照比例分配cpu资源）</li>
<li>requests.memory没有对应的docker参数，仅作为k8s调度依据</li>
</ul>
<p>limits：</p>
<ul>
<li>容器能使用资源的最大值</li>
<li>设置为0表示对使用的资源不做限制, 可无限的使用</li>
<li>当pod 内存超过limit时，会被oom</li>
<li>当cpu超过limit时，不会被kill，但是会限制不超过limit值</li>
<li>limits.cpu会被转换成docker的–cpu-quota参数。与cgroup cpu.cfs_quota_us功能相同</li>
<li>limits.memory会被转换成docker的–memory参数。用来限制容器使用的最大内存</li>
</ul>
<p>对于 CPU，我们知道计算机里 CPU 的资源是按<code>“时间片”</code>的方式来进行分配的，系统里的每一个操作都需要 CPU 的处理，所以，哪个任务要是申请的 CPU 时间片越多，那么它得到的 CPU 资源就越多。</p>
<p>然后还需要了解下 CGroup 里面对于 CPU 资源的单位换算：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">1</span> CPU <span style="color:#f92672">=</span>  <span style="color:#ae81ff">1000</span> millicpu（1 Core <span style="color:#f92672">=</span> 1000m）
</span></span></code></pre></div><p>这里的 <code>m</code> 就是毫、毫核的意思，Kubernetes 集群中的每一个节点可以通过操作系统的命令来确认本节点的 CPU 内核数量，然后将这个数量乘以1000，得到的就是节点总 CPU 总毫数。比如一个节点有四核，那么该节点的 CPU 总毫量为 4000m。</p>
<p><code>docker run</code>命令和 CPU 限制相关的所有选项如下：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--cpuset-cpus=&quot;&quot;</code></td>
<td>允许使用的 CPU 集，值可以为 0-3,0,1</td>
</tr>
<tr>
<td><code>-c</code>,<code>--cpu-shares=0</code></td>
<td>CPU 共享权值（相对权重）</td>
</tr>
<tr>
<td><code>cpu-period=0</code></td>
<td>限制 CPU CFS 的周期，范围从 100ms~1s，即[1000, 1000000]</td>
</tr>
<tr>
<td><code>--cpu-quota=0</code></td>
<td>限制 CPU CFS 配额，必须不小于1ms，即 &gt;= 1000，绝对限制</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -it --cpu-period<span style="color:#f92672">=</span><span style="color:#ae81ff">50000</span> --cpu-quota<span style="color:#f92672">=</span><span style="color:#ae81ff">25000</span> ubuntu:16.04 /bin/bash
</span></span></code></pre></div><p>将 CFS 调度的周期设为 50000，将容器在每个周期内的 CPU 配额设置为 25000，表示该容器每 50ms 可以得到 50% 的 CPU 运行时间。</p>
<blockquote>
<p>注意：若内存使用超出限制，会引发系统的OOM机制，因CPU是可压缩资源，不会引发Pod退出或重建</p>
</blockquote>
<h6 id="yaml优化">yaml优化<a hidden class="anchor" aria-hidden="true" href="#yaml优化">#</a></h6>
<p>目前完善后的yaml，<code>myblog/one-pod/pod-completed.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/mysql/data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>:   <span style="color:#75715e"># 使用节点选择器将Pod调度到指定label的节点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST  </span> <span style="color:#75715e">#  指定root用户的用户名</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span> 	<span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>		<span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/mysql:5.7-utf8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/mysql</span>
</span></span></code></pre></div><p>为什么要优化</p>
<ul>
<li>考虑真实的使用场景，像数据库这类中间件，是作为公共资源，为多个项目提供服务，不适合和业务容器绑定在同一个Pod中，因为业务容器是经常变更的，而数据库不需要频繁迭代</li>
<li>yaml的环境变量中存在敏感信息（账号、密码），存在安全隐患</li>
</ul>
<p>解决问题一，需要拆分yaml</p>
<p><code>myblog/two-pod/mysql.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>	<span style="color:#75715e"># 声明pod的网络模式为host模式，效果同docker run --net=host</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/mysql/data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>:   <span style="color:#75715e"># 使用节点选择器将Pod调度到指定label的节点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/mysql:5.7-utf8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/mysql</span>
</span></span></code></pre></div><p>myblog.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST  </span> <span style="color:#75715e">#  指定root用户的用户名</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;172.21.51.68&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span> 	<span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>		<span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span>
</span></span></code></pre></div><p>创建测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 先删除旧pod</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy delete po myblog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 分别创建mysql和myblog</span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> mysql.yaml
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> myblog.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看pod，注意mysqlIP为宿主机IP，因为网络模式为host</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -o wide 
</span></span><span style="display:flex;"><span>NAME     READY   STATUS    RESTARTS   AGE   IP                NODE
</span></span><span style="display:flex;"><span>myblog   1/1     Running   0          41s   10.244.1.152      k8s-slave1
</span></span><span style="display:flex;"><span>mysql    1/1     Running   0          52s   172.21.51.68   k8s-slave1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 访问myblog服务正常</span>
</span></span><span style="display:flex;"><span>$ curl 10.244.1.152<span style="color:#960050;background-color:#1e0010">:</span>8002/blog/index/
</span></span></code></pre></div><p>解决问题二，环境变量中敏感信息带来的安全隐患</p>
<p>为什么要统一管理环境变量</p>
<ul>
<li>环境变量中有很多敏感的信息，比如账号密码，直接暴漏在yaml文件中存在安全性问题</li>
<li>团队内部一般存在多个项目，这些项目直接存在配置相同环境变量的情况，因此可以统一维护管理</li>
<li>对于开发、测试、生产环境，由于配置均不同，每套环境部署的时候都要修改yaml，带来额外的开销</li>
</ul>
<p>k8s提供两类资源，configMap和Secret，可以用来实现业务配置的统一管理， 允许将配置文件与镜像文件分离，以使容器化的应用程序具有可移植性 。</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/configmap.png" alt=""  />
</p>
<ul>
<li>
<p>configMap，通常用来管理应用的配置文件或者环境变量，<code>myblog/two-pod/configmap.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MYSQL_HOST</span>: <span style="color:#e6db74">&#34;172.21.51.68&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MYSQL_PORT</span>: <span style="color:#e6db74">&#34;3306&#34;</span>
</span></span></code></pre></div><p>创建并查看configMap：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> configmap.yaml
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get cm myblog -oyaml
</span></span></code></pre></div><p>或者可以使用命令的方式，从文件中创建，比如：</p>
<p>configmap.txt</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat configmap.txt
</span></span><span style="display:flex;"><span>MYSQL_HOST=172.21.51.68
</span></span><span style="display:flex;"><span>MYSQL_PORT=3306
</span></span><span style="display:flex;"><span>$ kubectl create configmap myblog --from-env<span style="color:#f92672">-file</span>=configmap.txt
</span></span></code></pre></div></li>
<li>
<p>Secret，管理敏感类的信息，默认会base64编码存储，有三种类型</p>
<ul>
<li>Service Account ：用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；创建ServiceAccount后，Pod中指定serviceAccount后，自动创建该ServiceAccount对应的secret；</li>
<li>Opaque ： base64编码格式的Secret，用来存储密码、密钥等；</li>
<li>kubernetes.io/dockerconfigjson ：用来存储私有docker registry的认证信息。</li>
</ul>
<p><code>myblog/two-pod/secret.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MYSQL_USER</span>: <span style="color:#ae81ff">cm9vdA==		#注意加-n参数， echo -n root|base64</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MYSQL_PASSWD</span>: <span style="color:#ae81ff">MTIzNDU2</span>
</span></span></code></pre></div><p>创建并查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> secret.yaml
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get secret
</span></span></code></pre></div><p>如果不习惯这种方式，可以通过如下方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ cat secret.txt
</span></span><span style="display:flex;"><span>MYSQL_USER=root
</span></span><span style="display:flex;"><span>MYSQL_PASSWD=123456
</span></span><span style="display:flex;"><span>$ kubectl -n luffy create secret generic myblog --from-env<span style="color:#f92672">-file</span>=secret.txt 
</span></span></code></pre></div></li>
</ul>
<p>修改后的mysql的yaml，资源路径：<code>myblog/two-pod/mysql-with-config.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/mysql:5.7-utf8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>整体修改后的myblog的yaml，资源路径：<code>myblog/two-pod/myblog-with-config.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_HOST</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PORT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_PORT</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span> 	<span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>		<span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span>
</span></span></code></pre></div><p>在部署不同的环境时，pod的yaml无须再变化，只需要在每套环境中维护一套ConfigMap和Secret即可。但是注意configmap和secret不能跨namespace使用，且更新后，pod内的env不会自动更新，重建后方可更新。</p>
<h6 id="如何编写资源yaml">如何编写资源yaml<a hidden class="anchor" aria-hidden="true" href="#如何编写资源yaml">#</a></h6>
<ol>
<li>
<p>拿来主义，从机器中已有的资源中拿</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n kube-system get po,deployment,ds
</span></span></code></pre></div></li>
<li>
<p>学会在官网查找， <a href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a></p>
</li>
<li>
<p>从kubernetes-api文档中查找， <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/#pod-v1-core</a></p>
</li>
<li>
<p>kubectl explain 查看具体字段含义</p>
</li>
</ol>
<h6 id="pod状态与生命周期">pod状态与生命周期<a hidden class="anchor" aria-hidden="true" href="#pod状态与生命周期">#</a></h6>
<p>Pod的状态如下表所示：</p>
<table>
<thead>
<tr>
<th>状态值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pending</td>
<td>API Server已经创建该Pod，等待调度器调度</td>
</tr>
<tr>
<td>ContainerCreating</td>
<td>拉取镜像启动容器中</td>
</tr>
<tr>
<td>Running</td>
<td>Pod内容器均已创建，且至少有一个容器处于运行状态、正在启动状态或正在重启状态</td>
</tr>
<tr>
<td>Succeeded|Completed</td>
<td>Pod内所有容器均已成功执行退出，且不再重启</td>
</tr>
<tr>
<td>Failed|Error</td>
<td>Pod内所有容器均已退出，但至少有一个容器退出为失败状态</td>
</tr>
<tr>
<td>CrashLoopBackOff</td>
<td>Pod内有容器启动失败，比如配置文件丢失导致主进程启动失败</td>
</tr>
<tr>
<td>Unknown</td>
<td>由于某种原因无法获取该Pod的状态，可能由于网络通信不畅导致</td>
</tr>
</tbody>
</table>
<p>生命周期示意图：</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/fcachl.jpg" alt=""  />
</p>
<p>启动和关闭示意：</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/AOQgQj.jpg" alt=""  />
</p>
<p>初始化容器：</p>
<ul>
<li>验证业务应用依赖的组件是否均已启动</li>
<li>修改目录的权限</li>
<li>调整系统参数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/sbin/sysctl</span>
</span></span><span style="display:flex;"><span>        - -<span style="color:#ae81ff">w</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">vm.max_map_count=262144</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">alpine:3.6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">elasticsearch-logging-init</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>: {}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fix-permissions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">alpine:3.6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;chown -R 1000:1000 /usr/share/elasticsearch/data&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">elasticsearch-logging</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/usr/share/elasticsearch/data</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>验证Pod生命周期：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">demo-start-stop</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">demo-start-stop</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">init</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span>: <span style="color:#ae81ff">INIT &gt;&gt; /loap/timing&#39;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/loap</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">timing</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span>: <span style="color:#ae81ff">START &gt;&gt; /loap/timing;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sleep 10; echo $(date +%s)</span>: <span style="color:#ae81ff">END &gt;&gt; /loap/timing;&#39;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/loap </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">timing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span>: <span style="color:#ae81ff">LIVENESS &gt;&gt; /loap/timing&#39;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span>: <span style="color:#ae81ff">READINESS &gt;&gt; /loap/timing&#39;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span>: <span style="color:#ae81ff">POST-START &gt;&gt; /loap/timing&#39;]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preStop</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo $(date +%s)</span>: <span style="color:#ae81ff">PRE-STOP &gt;&gt; /loap/timing&#39;]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">timing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/tmp/loap</span>
</span></span></code></pre></div><p>创建pod测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> demo-pod-start.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看demo状态</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po -o wide -w
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 查看调度节点的/tmp/loap/timing</span>
</span></span><span style="display:flex;"><span>$ cat /tmp/loap/timing
</span></span><span style="display:flex;"><span>1585424708<span style="color:#960050;background-color:#1e0010">:</span> INIT
</span></span><span style="display:flex;"><span>1585424746<span style="color:#960050;background-color:#1e0010">:</span> START
</span></span><span style="display:flex;"><span>1585424746<span style="color:#960050;background-color:#1e0010">:</span> POST-START
</span></span><span style="display:flex;"><span>1585424754<span style="color:#960050;background-color:#1e0010">:</span> READINESS
</span></span><span style="display:flex;"><span>1585424756<span style="color:#960050;background-color:#1e0010">:</span> LIVENESS
</span></span><span style="display:flex;"><span>1585424756<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#66d9ef">END</span>
</span></span></code></pre></div><blockquote>
<p>须主动杀掉 Pod 才会触发 <code>pre-stop hook</code>，如果是 Pod 自己 Down 掉，则不会执行 <code>pre-stop hook</code></p>
</blockquote>
<h6 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h6>
<ol>
<li>实现k8s平台与特定的容器运行时解耦，提供更加灵活的业务部署方式，引入了Pod概念</li>
<li>k8s使用yaml格式定义资源文件，yaml中Map与List的语法，与json做类比</li>
<li>通过kubectl create | get | exec | logs | delete 等操作k8s资源，必须指定namespace</li>
<li>每启动一个Pod，为了实现网络空间共享，会先创建Infra容器，并把其他容器网络加入该容器</li>
<li>通过livenessProbe和readinessProbe实现Pod的存活性和就绪健康检查</li>
<li>通过requests和limit分别限定容器初始资源申请与最高上限资源申请</li>
<li>Pod通过initContainer和lifecycle分别来执行初始化、pod启动和删除时候的操作，使得功能更加全面和灵活</li>
<li>编写yaml讲究方法，学习k8s，养成从官方网站查询知识的习惯</li>
</ol>
<p>做了哪些工作：</p>
<ol>
<li>定义Pod.yaml，将myblog和mysql打包在同一个Pod中，使用myblog使用localhost访问mysql</li>
<li>mysql数据持久化，为myblog业务应用添加了健康检查和资源限制</li>
<li>将myblog与mysql拆分，使用独立的Pod管理</li>
<li>yaml文件中的环境变量存在账号密码明文等敏感信息，使用configMap和Secret来统一配置，优化部署</li>
</ol>
<p>只使用Pod, 面临的问题:</p>
<ol>
<li>业务应用启动多个副本</li>
<li>Pod重建后IP会变化，外部如何访问Pod服务</li>
<li>运行业务Pod的某个节点挂了，可以自动帮我把Pod转移到集群中的可用节点启动起来</li>
<li>我的业务应用功能是收集节点监控数据,需要把Pod运行在k8集群的各个节点上</li>
</ol>
<h5 id="pod控制器">Pod控制器<a hidden class="anchor" aria-hidden="true" href="#pod控制器">#</a></h5>
<h6 id="workload-工作负载">Workload (工作负载)<a hidden class="anchor" aria-hidden="true" href="#workload-工作负载">#</a></h6>
<p>控制器又称工作负载是用于实现管理pod的中间层，确保pod资源符合预期的状态，pod的资源出现故障时，会尝试 进行重启，当根据重启策略无效，则会重新新建pod的资源。</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/workload.png" alt=""  />
</p>
<ul>
<li>ReplicaSet: 代用户创建指定数量的pod副本数量，确保pod副本数量符合预期状态，并且支持滚动式自动扩容和缩容功能</li>
<li>Deployment：工作在ReplicaSet之上，用于管理无状态应用，目前来说最好的控制器。支持滚动更新和回滚功能，提供声明式配置</li>
<li>DaemonSet：用于确保集群中的每一个节点只运行特定的pod副本，通常用于实现系统级后台任务。比如EFK服务</li>
<li>Job：只要完成就立即退出，不需要重启或重建</li>
<li>Cronjob：周期性任务控制，不需要持续后台运行</li>
<li>StatefulSet：管理有状态应用</li>
</ul>
<h6 id="deployment">Deployment<a hidden class="anchor" aria-hidden="true" href="#deployment">#</a></h6>
<p><code>myblog/deployment/deploy-mysql.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>	<span style="color:#75715e">#指定Pod副本数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">selector:		#指定Pod的选择器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">labels:	#给Pod打label</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>: 
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/mysql/data</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelector</span>:   <span style="color:#75715e"># 使用节点选择器将Pod调度到指定label的节点</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">component</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/mysql:5.7-utf8</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;myblog&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/mysql</span>
</span></span></code></pre></div><p>deploy-myblog.yaml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>	<span style="color:#75715e">#指定Pod副本数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">selector:		#指定Pod的选择器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">labels:	#给Pod打label</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">172.21.51.67</span>:<span style="color:#ae81ff">5000</span><span style="color:#ae81ff">/myblog:v1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_HOST</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_HOST</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PORT</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">configMapKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_PORT</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretKeyRef</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">key</span>: <span style="color:#ae81ff">MYSQL_PASSWD</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># 容器启动后第一次执行探测是需要等待多少秒</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span> 	<span style="color:#75715e"># 执行探测的频率</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>		<span style="color:#75715e"># 探测超时时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>: 
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>: 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/blog/index/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">periodSeconds</span>: <span style="color:#ae81ff">15</span>
</span></span></code></pre></div><h6 id="创建deployment">创建Deployment<a hidden class="anchor" aria-hidden="true" href="#创建deployment">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> deploy.yaml
</span></span></code></pre></div><h6 id="查看deployment">查看Deployment<a hidden class="anchor" aria-hidden="true" href="#查看deployment">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># kubectl api-resources</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get deploy
</span></span><span style="display:flex;"><span>NAME     READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>myblog   1/1     1            1           2m22s
</span></span><span style="display:flex;"><span>mysql    1/1     1            1           2d11h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * `NAME` 列出了集群中 Deployments 的名称<span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>  * `READY`显示当前正在运行的副本数/期望的副本数<span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>  * `UP-TO-DATE`显示已更新以实现期望状态的副本数<span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>  * `AVAILABLE`显示应用程序可供用户使用的副本数<span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>  * `AGE` 显示应用程序运行的时间量<span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get po
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>myblog-7c96c9f76b-qbbg7   1/1     Running   0          109s
</span></span><span style="display:flex;"><span>mysql-85f4f65f99-w6jkj    1/1     Running   0          2m28s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看replicaSet</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy get rs
</span></span></code></pre></div><h6 id="副本保障机制">副本保障机制<a hidden class="anchor" aria-hidden="true" href="#副本保障机制">#</a></h6>
<p>controller实时检测pod状态，并保障副本数一直处于期望的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 删除pod，观察pod状态变化</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy delete pod myblog-7c96c9f76b-qbbg7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 观察pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 设置两个副本, 或者通过kubectl -n luffy edit deploy myblog的方式，最好通过修改文件，然后apply的方式，这样yaml文件可以保持同步</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy scale deploy myblog --replicas=2
</span></span><span style="display:flex;"><span>deployment.extensions/myblog scaled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 观察pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pods -o wide
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>myblog-7c96c9f76b-qbbg7   1/1     Running   0          11m
</span></span><span style="display:flex;"><span>myblog-7c96c9f76b-s6brm   1/1     Running   0          55s
</span></span><span style="display:flex;"><span>mysql-85f4f65f99-w6jkj    1/1     Running   0          11m
</span></span></code></pre></div><h6 id="pod驱逐策略">Pod驱逐策略<a hidden class="anchor" aria-hidden="true" href="#pod驱逐策略">#</a></h6>
<p>K8S 有个特色功能叫 pod eviction，它在某些场景下如节点 NotReady，或者资源不足时，把 pod 驱逐至其它节点，这也是出于业务保护的角度去考虑的。</p>
<ol>
<li>Kube-controller-manager: 周期性检查所有节点状态，当节点处于 NotReady 状态超过一段时间后，驱逐该节点上所有 pod。</li>
</ol>
<ul>
<li>
<p><code>pod-eviction-timeout</code>：NotReady 状态节点超过该时间后，执行驱逐，默认 5 min，适用于k8s 1.13版本之前</p>
<ul>
<li>
<p>1.13版本后，集群开启<code> TaintBasedEvictions 与TaintNodesByCondition</code> 功能，即<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">taint-based-evictions</a>，即节点若失联或者出现各种异常情况，k8s会自动为node打上污点，同时为pod默认添加如下容忍设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">effect</span>: <span style="color:#ae81ff">NoExecute</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#ae81ff">node.kubernetes.io/not-ready</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">Exists</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tolerationSeconds</span>: <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">effect</span>: <span style="color:#ae81ff">NoExecute</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">key</span>: <span style="color:#ae81ff">node.kubernetes.io/unreachable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">Exists</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tolerationSeconds</span>: <span style="color:#ae81ff">300</span>
</span></span></code></pre></div><p>即各pod可以独立设置驱逐容忍时间。</p>
</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Kubelet: 周期性检查本节点资源，当资源不足时，按照优先级驱逐部分 pod
<ul>
<li><code>memory.available</code>：节点可用内存</li>
<li><code>nodefs.available</code>：节点根盘可用存储空间</li>
<li><code>nodefs.inodesFree</code>：节点inodes可用数量</li>
<li><code>imagefs.available</code>：镜像存储盘的可用空间</li>
<li><code>imagefs.inodesFree</code>：镜像存储盘的inodes可用数量</li>
</ul>
</li>
</ol>
<h6 id="服务更新">服务更新<a hidden class="anchor" aria-hidden="true" href="#服务更新">#</a></h6>
<p>修改服务，重新打tag模拟服务更新。</p>
<p>更新方式：</p>
<ol>
<li>
<p>修改yaml文件，使用<code>kubectl apply -f deploy-myblog.yaml</code>来应用更新</p>
</li>
<li>
<p><code>kubectl -n luffy edit deploy myblog</code>在线更新</p>
</li>
<li>
<p><code>kubectl -n luffy set image deploy myblog myblog=172.21.51.67:5000/myblog:v2 --record</code></p>
</li>
</ol>
<p>修改文件测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ vi mybolg/blog/template/index.html
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker build . -t 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/myblog<span style="color:#960050;background-color:#1e0010">:</span>v2 <span style="color:#f92672">-f</span> Dockerfile
</span></span><span style="display:flex;"><span>$ docker push 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/myblog<span style="color:#960050;background-color:#1e0010">:</span>v2
</span></span></code></pre></div><h6 id="更新策略">更新策略<a hidden class="anchor" aria-hidden="true" href="#更新策略">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>	<span style="color:#75715e">#指定Pod副本数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">selector:		#指定Pod的选择器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate		#指定更新方式为滚动更新，默认策略，通过get deploy yaml查看</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">...</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/update.png" alt=""  />
</p>
<p>策略控制：</p>
<ul>
<li>maxSurge：最大激增数, 指更新过程中, 最多可以比replicas预先设定值多出的pod数量, 可以为固定值或百分比,默认为desired Pods数的25%。计算时向上取整(比如3.4，取4)，更新过程中最多会有replicas + maxSurge个pod</li>
<li>maxUnavailable： 指更新过程中, 最多有几个pod处于无法服务状态 , 可以为固定值或百分比，默认为desired Pods数的25%。计算时向下取整(比如3.6，取3)</li>
</ul>
<p><em>在Deployment rollout时，需要保证Available(Ready) Pods数不低于 desired pods number - maxUnavailable; 保证所有的非异常状态Pods数不多于 desired pods number + maxSurge</em>。</p>
<p>replicas=3</p>
<p>running状态pod最大不超过3+1=4个，</p>
<p>running状态的Pod数不低于3-0=3个</p>
<ol>
<li>先新增一个v2版本的pod，目前3个v1版本+1个v2版本，共4个pod</li>
<li>删掉一个v1版本的pod，目前2个v1版本+1个v2版本，共3个pod</li>
<li>先新增一个v2版本的pod，目前2个v1版本+2个v2版本，共4个pod</li>
<li>删掉一个v1版本的pod，目前1个v1版本+2个v2版本，共3个pod</li>
<li>先新增一个v2版本的pod，目前1个v1版本+3个v2版本，共4个pod</li>
<li>删掉一个v1版本的pod，目前0个v1版本+3个v2版本，共3个pod</li>
</ol>
<p>以myblog为例，使用默认的策略，更新过程:</p>
<ol>
<li>maxSurge 25%，2个实例，向上取整，则maxSurge为1，意味着最多可以有2+1=3个Pod，那么此时会新创建1个ReplicaSet，RS-new，把副本数置为1，此时呢，副本控制器就去创建这个新的Pod</li>
<li>同时，maxUnavailable是25%，副本数2*25%，向下取整，则为0，意味着，滚动更新的过程中，不能有少于2个可用的Pod，因此，旧的Replica（RS-old）会先保持不动，等RS-new管理的Pod状态Ready后，此时已经有3个Ready状态的Pod了，那么由于只要保证有2个可用的Pod即可，因此，RS-old的副本数会有2个变成1个，此时，会删掉一个旧的Pod</li>
<li>删掉旧的Pod的时候，由于总的Pod数量又变成2个了，因此，距离最大的3个还有1个Pod可以创建，所以，RS-new把管理的副本数由1改成2，此时又会创建1个新的Pod，等RS-new管理了2个Pod都ready后，那么就可以把RS-old的副本数由1置为0了，这样就完成了滚动更新</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#查看滚动更新事件</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy describe deploy myblog
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Events<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  Type    Reason             Age   From                   Message
</span></span><span style="display:flex;"><span>  ----    ------             ----  ----                   -------
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  11s   deployment-controller  Scaled up replica set myblog-6cf56fc848 to 1
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  11s   deployment-controller  Scaled down replica set myblog-6fdcf98f9 to 1
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  11s   deployment-controller  Scaled up replica set myblog-6cf56fc848 to 2
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  6s    deployment-controller  Scaled down replica set myblog-6fdcf98f9 to 0
</span></span><span style="display:flex;"><span>$ kubectl get rs
</span></span><span style="display:flex;"><span>NAME                     DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>myblog-6cf56fc848   2         2         2       16h
</span></span><span style="display:flex;"><span>myblog-6fdcf98f9    0         0         0       16h
</span></span></code></pre></div><h6 id="服务回滚">服务回滚<a hidden class="anchor" aria-hidden="true" href="#服务回滚">#</a></h6>
<p>通过滚动升级的策略可以平滑的升级Deployment，若升级出现问题，需要最快且最好的方式回退到上一次能够提供正常工作的版本。为此K8S提供了回滚机制。</p>
<p><strong>revision</strong>：更新应用时，K8S都会记录当前的版本号，即为revision，当升级出现问题时，可通过回滚到某个特定的revision，默认配置下，K8S只会保留最近的几个revision，可以通过Deployment配置文件中的spec.revisionHistoryLimit属性增加revision数量，默认是10。</p>
<p>查看当前：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n luffy rollout history deploy myblog <span style="color:#75715e">##CHANGE-CAUSE为空</span>
</span></span><span style="display:flex;"><span>$ kubectl delete <span style="color:#f92672">-f</span> deploy-myblog.yaml    <span style="color:#75715e">## 方便演示到具体效果，删掉已有deployment</span>
</span></span></code></pre></div><p>记录回滚：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> deploy-myblog.yaml --record
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy set image deploy myblog myblog=172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/myblog<span style="color:#960050;background-color:#1e0010">:</span>v2 --record=true
</span></span></code></pre></div><p>查看deployment更新历史：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n luffy rollout history deploy myblog
</span></span><span style="display:flex;"><span>deployment.extensions/myblog
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span>1         kubectl create --filename=deploy-myblog.yaml --record=true
</span></span><span style="display:flex;"><span>2         kubectl set image deploy myblog myblog=172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>5000/demo/myblog<span style="color:#960050;background-color:#1e0010">:</span>v1 --record=true
</span></span></code></pre></div><p>回滚到具体的REVISION:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n luffy rollout undo deploy myblog --to-revision=1
</span></span><span style="display:flex;"><span>deployment.extensions/myblog rolled back
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 访问应用测试</span>
</span></span></code></pre></div><h5 id="kubernetes服务访问之service">Kubernetes服务访问之Service<a hidden class="anchor" aria-hidden="true" href="#kubernetes服务访问之service">#</a></h5>
<p>通过以前的学习，我们已经能够通过Deployment来创建一组Pod来提供具有高可用性的服务。虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两个问题：</p>
<ul>
<li>Pod IP仅仅是集群内可见的虚拟IP，外部无法访问。</li>
<li>Pod IP会随着Pod的销毁而消失，当ReplicaSet对Pod进行动态伸缩时，Pod IP可能随时随地都会变化，这样对于我们访问这个服务带来了难度。</li>
</ul>
<h6 id="service-负载均衡之cluster-ip">Service 负载均衡之Cluster IP<a hidden class="anchor" aria-hidden="true" href="#service-负载均衡之cluster-ip">#</a></h6>
<p>service是一组pod的服务抽象，相当于一组pod的LB，负责将请求分发给对应的pod。service会为这个LB提供一个IP，一般称为cluster IP 。使用Service对象，通过selector进行标签选择，找到对应的Pod:</p>
<p><code>myblog/deployment/svc-myblog.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8002</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span></code></pre></div><p>操作演示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 别名</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#66d9ef">alias</span> kd=<span style="color:#e6db74">&#39;kubectl -n luffy&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 创建服务</span>
</span></span><span style="display:flex;"><span>$ kd create <span style="color:#f92672">-f</span> svc-myblog.yaml
</span></span><span style="display:flex;"><span>$ kd get po --show-labels
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE    LABELS
</span></span><span style="display:flex;"><span>myblog-5c97d79cdb-jn7km   1/1     Running   0          6m5s   app=myblog
</span></span><span style="display:flex;"><span>mysql-85f4f65f99-w6jkj    1/1     Running   0          176m   app=mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kd get svc
</span></span><span style="display:flex;"><span>NAME     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
</span></span><span style="display:flex;"><span>myblog   ClusterIP   10.99.174.93   &lt;none&gt;        80/TCP    7m50s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kd describe svc myblog
</span></span><span style="display:flex;"><span>Name<span style="color:#960050;background-color:#1e0010">:</span>              myblog
</span></span><span style="display:flex;"><span>Namespace<span style="color:#960050;background-color:#1e0010">:</span>         demo
</span></span><span style="display:flex;"><span>Labels<span style="color:#960050;background-color:#1e0010">:</span>            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations<span style="color:#960050;background-color:#1e0010">:</span>       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector<span style="color:#960050;background-color:#1e0010">:</span>          app=myblog
</span></span><span style="display:flex;"><span>Type<span style="color:#960050;background-color:#1e0010">:</span>              ClusterIP
</span></span><span style="display:flex;"><span>IP<span style="color:#960050;background-color:#1e0010">:</span>                10.99.174.93
</span></span><span style="display:flex;"><span>Port<span style="color:#960050;background-color:#1e0010">:</span>              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort<span style="color:#960050;background-color:#1e0010">:</span>        8002/TCP
</span></span><span style="display:flex;"><span>Endpoints<span style="color:#960050;background-color:#1e0010">:</span>         10.244.0.68<span style="color:#960050;background-color:#1e0010">:</span>8002
</span></span><span style="display:flex;"><span>Session Affinity<span style="color:#960050;background-color:#1e0010">:</span>  None
</span></span><span style="display:flex;"><span>Events<span style="color:#960050;background-color:#1e0010">:</span>            &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 扩容myblog服务</span>
</span></span><span style="display:flex;"><span>$ kd scale deploy myblog --replicas=2
</span></span><span style="display:flex;"><span>deployment.extensions/myblog scaled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 再次查看</span>
</span></span><span style="display:flex;"><span>$ kd describe svc myblog
</span></span><span style="display:flex;"><span>Name<span style="color:#960050;background-color:#1e0010">:</span>              myblog
</span></span><span style="display:flex;"><span>Namespace<span style="color:#960050;background-color:#1e0010">:</span>         demo
</span></span><span style="display:flex;"><span>Labels<span style="color:#960050;background-color:#1e0010">:</span>            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations<span style="color:#960050;background-color:#1e0010">:</span>       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector<span style="color:#960050;background-color:#1e0010">:</span>          app=myblog
</span></span><span style="display:flex;"><span>Type<span style="color:#960050;background-color:#1e0010">:</span>              ClusterIP
</span></span><span style="display:flex;"><span>IP<span style="color:#960050;background-color:#1e0010">:</span>                10.99.174.93
</span></span><span style="display:flex;"><span>Port<span style="color:#960050;background-color:#1e0010">:</span>              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort<span style="color:#960050;background-color:#1e0010">:</span>        8002/TCP
</span></span><span style="display:flex;"><span>Endpoints<span style="color:#960050;background-color:#1e0010">:</span>         10.244.0.68<span style="color:#960050;background-color:#1e0010">:</span>8002,10.244.1.158<span style="color:#960050;background-color:#1e0010">:</span>8002
</span></span><span style="display:flex;"><span>Session Affinity<span style="color:#960050;background-color:#1e0010">:</span>  None
</span></span><span style="display:flex;"><span>Events<span style="color:#960050;background-color:#1e0010">:</span>            &lt;none&gt;
</span></span></code></pre></div><p>Service与Pod如何关联:</p>
<p>service对象创建的同时，会创建同名的endpoints对象，若服务设置了readinessProbe, 当readinessProbe检测失败时，endpoints列表中会剔除掉对应的pod_ip，这样流量就不会分发到健康检测失败的Pod中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kd get endpoints myblog
</span></span><span style="display:flex;"><span>NAME     ENDPOINTS                            AGE
</span></span><span style="display:flex;"><span>myblog   10.244.0.68<span style="color:#960050;background-color:#1e0010">:</span>8002,10.244.1.158<span style="color:#960050;background-color:#1e0010">:</span>8002   7m
</span></span></code></pre></div><p>Service Cluster-IP如何访问:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kd get svc myblog
</span></span><span style="display:flex;"><span>NAME   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
</span></span><span style="display:flex;"><span>myblog   ClusterIP   10.99.174.93   &lt;none&gt;        80/TCP    13m
</span></span><span style="display:flex;"><span>$ curl 10.99.174.93/blog/index/
</span></span></code></pre></div><p>为mysql服务创建service：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span></code></pre></div><p>访问mysql：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kd get svc mysql
</span></span><span style="display:flex;"><span>mysql    ClusterIP   10.108.214.84   &lt;none&gt;        3306/TCP   3s
</span></span><span style="display:flex;"><span>$ curl 10.108.214.84<span style="color:#960050;background-color:#1e0010">:</span>3306
</span></span></code></pre></div><p>目前使用hostNetwork部署，通过宿主机ip+port访问，弊端：</p>
<ul>
<li>服务使用hostNetwork，使得宿主机的端口大量暴漏，存在安全隐患</li>
<li>容易引发端口冲突</li>
</ul>
<p>服务均属于k8s集群，尽可能使用k8s的网络访问，因此可以对目前myblog访问mysql的方式做改造：</p>
<ul>
<li>为mysql创建一个固定clusterIp的Service，把clusterIp配置在myblog的环境变量中</li>
<li>利用集群服务发现的能力，组件之间通过service name来访问</li>
</ul>
<h6 id="服务发现">服务发现<a hidden class="anchor" aria-hidden="true" href="#服务发现">#</a></h6>
<p>在k8s集群中，组件之间可以通过定义的Service名称实现通信。</p>
<p>演示服务发现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## 演示思路：在myblog的容器中直接通过service名称访问服务，观察是否可以访问通</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 先查看服务</span>
</span></span><span style="display:flex;"><span>$ kd get svc
</span></span><span style="display:flex;"><span>NAME     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
</span></span><span style="display:flex;"><span>myblog   ClusterIP   10.99.174.93    &lt;none&gt;        80/TCP     59m
</span></span><span style="display:flex;"><span>mysql    ClusterIP   10.108.214.84   &lt;none&gt;        3306/TCP   35m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入myblog容器</span>
</span></span><span style="display:flex;"><span>$ kd exec -ti myblog-5c97d79cdb-j485f bash
</span></span><span style="display:flex;"><span>[root@myblog-5c97d79cdb-j485f myblog]<span style="color:#75715e"># curl mysql:3306</span>
</span></span><span style="display:flex;"><span>5.7.29 )<span style="color:#960050;background-color:#1e0010">→</span>  (mysql_native_password ot packets out of order
</span></span><span style="display:flex;"><span>[root@myblog-5c97d79cdb-j485f myblog]<span style="color:#75715e"># curl myblog/blog/index/</span>
</span></span><span style="display:flex;"><span>我的博客列表
</span></span></code></pre></div><p>虽然podip和clusterip都不固定，但是service name是固定的，而且具有完全的跨集群可移植性，因此组件之间调用的同时，完全可以通过service name去通信，这样避免了大量的ip维护成本，使得服务的yaml模板更加简单。因此可以对mysql和myblog的部署进行优化改造：</p>
<ol>
<li>mysql可以去掉hostNetwork部署，使得服务只暴漏在k8s集群内部网络</li>
<li>configMap中数据库地址可以换成Service名称，这样跨环境的时候，配置内容基本上可以保持不用变化</li>
</ol>
<p>修改deploy-mysql.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>	<span style="color:#75715e"># 去掉此行</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql-data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">hostPath</span>: 
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/opt/mysql/data</span>
</span></span></code></pre></div><p>修改configmap.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MYSQL_HOST</span>: <span style="color:#e6db74">&#34;mysql&#34;</span>	<span style="color:#75715e"># 此处替换为mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">MYSQL_PORT</span>: <span style="color:#e6db74">&#34;3306&#34;</span>
</span></span></code></pre></div><p>应用修改：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl delete <span style="color:#f92672">-f</span> deployment-mysql.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## myblog不用动，会自动因健康检测不过而重启</span>
</span></span></code></pre></div><p>服务发现实现：</p>
<p><code>CoreDNS</code>是一个<code>Go</code>语言实现的链式插件<code>DNS服务端</code>，是CNCF成员，是一个高性能、易扩展的<code>DNS服务端</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kubectl -n kube-system get po -o wide|grep dns
</span></span><span style="display:flex;"><span>coredns-d4475785-2w4hk             1/1     Running   0          4d22h   10.244.0.64       
</span></span><span style="display:flex;"><span>coredns-d4475785-s49hq             1/1     Running   0          4d22h   10.244.0.65
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看myblog的pod解析配置</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy exec -ti myblog-5c97d79cdb-j485f bash
</span></span><span style="display:flex;"><span>[root@myblog-5c97d79cdb-j485f myblog]<span style="color:#75715e"># cat /etc/resolv.conf</span>
</span></span><span style="display:flex;"><span>nameserver 10.96.0.10
</span></span><span style="display:flex;"><span>search luffy.svc.cluster.local svc.cluster.local cluster.local
</span></span><span style="display:flex;"><span>options ndots<span style="color:#960050;background-color:#1e0010">:</span>5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 10.96.0.10 从哪来</span>
</span></span><span style="display:flex;"><span>$ kubectl -n kube-system get svc
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE
</span></span><span style="display:flex;"><span>kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP   51d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 启动pod的时候，会把kube-dns服务的cluster-ip地址注入到pod的resolve解析配置中，同时添加对应的namespace的search域。 因此跨namespace通过service name访问的话，需要添加对应的namespace名称，</span>
</span></span><span style="display:flex;"><span>service_name.namespace
</span></span><span style="display:flex;"><span>$ kubectl get svc
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   26h
</span></span></code></pre></div><h6 id="service负载均衡之nodeport">Service负载均衡之NodePort<a hidden class="anchor" aria-hidden="true" href="#service负载均衡之nodeport">#</a></h6>
<p>cluster-ip为虚拟地址，只能在k8s集群内部进行访问，集群外部如果访问内部服务，实现方式之一为使用NodePort方式。NodePort会默认在 30000-32767 ，不指定的会随机使用其中一个。</p>
<p><code>myblog/deployment/svc-myblog-nodeport.yaml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>apiVersion<span style="color:#960050;background-color:#1e0010">:</span> v1
</span></span><span style="display:flex;"><span>kind<span style="color:#960050;background-color:#1e0010">:</span> Service
</span></span><span style="display:flex;"><span>metadata<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> myblog-np
</span></span><span style="display:flex;"><span>  namespace<span style="color:#960050;background-color:#1e0010">:</span> luffy
</span></span><span style="display:flex;"><span>spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  ports<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>  - port<span style="color:#960050;background-color:#1e0010">:</span> 80
</span></span><span style="display:flex;"><span>    protocol<span style="color:#960050;background-color:#1e0010">:</span> TCP
</span></span><span style="display:flex;"><span>    targetPort<span style="color:#960050;background-color:#1e0010">:</span> 8002
</span></span><span style="display:flex;"><span>  selector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#960050;background-color:#1e0010">:</span> myblog
</span></span><span style="display:flex;"><span>  type<span style="color:#960050;background-color:#1e0010">:</span> NodePort
</span></span></code></pre></div><p>查看并访问服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ kd create <span style="color:#f92672">-f</span> svc-myblog-nodeport.yaml
</span></span><span style="display:flex;"><span>service/myblog-np created
</span></span><span style="display:flex;"><span>$ kd get svc
</span></span><span style="display:flex;"><span>NAME        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
</span></span><span style="display:flex;"><span>myblog      ClusterIP   10.99.174.93     &lt;none&gt;        80/TCP         102m
</span></span><span style="display:flex;"><span>myblog-np   NodePort    10.105.228.101   &lt;none&gt;        80<span style="color:#960050;background-color:#1e0010">:</span>30647/TCP   4s
</span></span><span style="display:flex;"><span>mysql       ClusterIP   10.108.214.84    &lt;none&gt;        3306/TCP       77m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#集群内每个节点的NodePort端口都会进行监听</span>
</span></span><span style="display:flex;"><span>$ curl 172.21.51.67<span style="color:#960050;background-color:#1e0010">:</span>30647/blog/index/
</span></span><span style="display:flex;"><span>我的博客列表
</span></span><span style="display:flex;"><span>$ curl 172.21.51.68<span style="color:#960050;background-color:#1e0010">:</span>30647/blog/index/
</span></span><span style="display:flex;"><span>我的博客列表
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 浏览器访问</span>
</span></span></code></pre></div><p>思考：</p>
<ol>
<li>
<p>NodePort的端口监听如何转发到对应的Pod服务？</p>
</li>
<li>
<p>CLUSTER-IP为虚拟IP，集群内如何通过虚拟IP访问到具体的Pod服务？</p>
</li>
</ol>
<h6 id="kube-proxy">kube-proxy<a hidden class="anchor" aria-hidden="true" href="#kube-proxy">#</a></h6>
<p>运行在每个节点上，监听 API Server 中服务对象的变化，再通过创建流量路由规则来实现网络的转发。<a href="https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies">参照</a></p>
<p>有三种模式：</p>
<ul>
<li>User space, 让 Kube-Proxy 在用户空间监听一个端口，所有的 Service 都转发到这个端口，然后 Kube-Proxy 在内部应用层对其进行转发 ， 所有报文都走一遍用户态，性能不高，k8s v1.2版本后废弃。</li>
<li>Iptables， 当前默认模式，完全由 IPtables 来实现， 通过各个node节点上的iptables规则来实现service的负载均衡，但是随着service数量的增大，iptables模式由于线性查找匹配、全量更新等特点，其性能会显著下降。</li>
<li>IPVS， 与iptables同样基于Netfilter，但是采用的hash表，因此当service数量达到一定规模时，hash查表的速度优势就会显现出来，从而提高service的服务性能。 k8s 1.8版本开始引入，1.11版本开始稳定，需要开启宿主机的ipvs模块。</li>
</ul>
<p>IPtables模式示意图：</p>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/services-iptables-overview.svg" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ iptables-save |grep -v myblog-np|grep  <span style="color:#e6db74">&#34;luffy/myblog&#34;</span>
</span></span><span style="display:flex;"><span>-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.99.174.93/32 -p tcp -m comment --comment <span style="color:#e6db74">&#34;demo/myblog: cluster IP&#34;</span> -m tcp --dport 80 -j KUBE-MARK-MASQ
</span></span><span style="display:flex;"><span>-A KUBE-SERVICES -d 10.99.174.93/32 -p tcp -m comment --comment <span style="color:#e6db74">&#34;demo/myblog: cluster IP&#34;</span> -m tcp --dport 80 -j KUBE-SVC-WQNGJ7YFZKCTKPZK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables-save |grep KUBE-SVC-WQNGJ7YFZKCTKPZK
</span></span><span style="display:flex;"><span>-A KUBE-SVC-WQNGJ7YFZKCTKPZK -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-GB5GNOM5CZH7ICXZ
</span></span><span style="display:flex;"><span>-A KUBE-SVC-WQNGJ7YFZKCTKPZK -j KUBE-SEP-7GWC3FN2JI5KLE47
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$  iptables-save |grep KUBE-SEP-GB5GNOM5CZH7ICXZ
</span></span><span style="display:flex;"><span>-A KUBE-SEP-GB5GNOM5CZH7ICXZ -p tcp -m tcp -j DNAT --to-destination 10.244.1.158<span style="color:#960050;background-color:#1e0010">:</span>8002
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ iptables-save |grep KUBE-SEP-7GWC3FN2JI5KLE47
</span></span><span style="display:flex;"><span>-A KUBE-SEP-7GWC3FN2JI5KLE47 -p tcp -m tcp -j DNAT --to-destination 10.244.1.159<span style="color:#960050;background-color:#1e0010">:</span>8002
</span></span></code></pre></div><h5 id="kubernetes服务访问之ingress">Kubernetes服务访问之Ingress<a hidden class="anchor" aria-hidden="true" href="#kubernetes服务访问之ingress">#</a></h5>
<p>对于Kubernetes的Service，无论是Cluster-Ip和NodePort均是四层的负载，集群内的服务如何实现七层的负载均衡，这就需要借助于Ingress，Ingress控制器的实现方式有很多，比如nginx, Contour, Haproxy, trafik, Istio。几种常用的ingress功能对比和选型可以参考<a href="https://www.kubernetes.org.cn/5948.html">这里</a></p>
<p>Ingress-nginx是7层的负载均衡器 ，负责统一管理外部对k8s cluster中Service的请求。主要包含：</p>
<ul>
<li>
<p>ingress-nginx-controller：根据用户编写的ingress规则（创建的ingress的yaml文件），动态的去更改nginx服务的配置文件，并且reload重载使其生效（是自动化的，通过lua脚本来实现）；</p>
</li>
<li>
<p>Ingress资源对象：将Nginx的配置抽象成一个Ingress对象</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">simple-example</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">foo.bar.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div></li>
</ul>
<h6 id="示意图">示意图：<a hidden class="anchor" aria-hidden="true" href="#示意图">#</a></h6>
<p><img loading="lazy" src="/images/Kubernetes%e8%90%bd%e5%9c%b0%e5%ae%9e%e8%b7%b5%e4%b9%8b%e6%97%85/ingress.webp" alt=""  />
</p>
<h6 id="实现逻辑">实现逻辑<a hidden class="anchor" aria-hidden="true" href="#实现逻辑">#</a></h6>
<p>1）ingress controller通过和kubernetes api交互，动态的去感知集群中ingress规则变化
2）然后读取ingress规则(规则就是写明了哪个域名对应哪个service)，按照自定义的规则，生成一段nginx配置
3）再写到nginx-ingress-controller的pod里，这个Ingress controller的pod里运行着一个Nginx服务，控制器把生成的nginx配置写入/etc/nginx/nginx.conf文件中
4）然后reload一下使配置生效。以此达到域名分别配置和动态更新的问题。</p>
<h6 id="安装">安装<a hidden class="anchor" aria-hidden="true" href="#安装">#</a></h6>
<p><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md">官方文档</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ wget https<span style="color:#960050;background-color:#1e0010">:</span>//raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/<span style="color:#66d9ef">mandatory</span>.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 或者使用myblog/deployment/ingress/mandatory.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 修改部署节点</span>
</span></span><span style="display:flex;"><span>$ grep -n5 nodeSelector <span style="color:#66d9ef">mandatory</span>.yaml
</span></span><span style="display:flex;"><span>212-    spec<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>213-      hostNetwork<span style="color:#960050;background-color:#1e0010">:</span> true <span style="color:#75715e">#添加为host模式</span>
</span></span><span style="display:flex;"><span>214-      <span style="color:#75715e"># wait up to five minutes for the drain of connections</span>
</span></span><span style="display:flex;"><span>215-      terminationGracePeriodSeconds<span style="color:#960050;background-color:#1e0010">:</span> 300
</span></span><span style="display:flex;"><span>216-      serviceAccountName<span style="color:#960050;background-color:#1e0010">:</span> nginx-ingress-serviceaccount
</span></span><span style="display:flex;"><span>217<span style="color:#960050;background-color:#1e0010">:</span>      nodeSelector<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>218-        ingress<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#34;true&#34;</span>		<span style="color:#75715e">#替换此处，来决定将ingress部署在哪些机器</span>
</span></span><span style="display:flex;"><span>219-      containers<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>220-        - name<span style="color:#960050;background-color:#1e0010">:</span> nginx-ingress-controller
</span></span><span style="display:flex;"><span>221-          image<span style="color:#960050;background-color:#1e0010">:</span> quay.io/kubernetes-ingress-controller/nginx-ingress-controller<span style="color:#960050;background-color:#1e0010">:</span>0.30.0
</span></span><span style="display:flex;"><span>222-          args<span style="color:#960050;background-color:#1e0010">:</span>
</span></span></code></pre></div><p>创建ingress</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 为k8s-master节点添加label</span>
</span></span><span style="display:flex;"><span>$ kubectl label node k8s-master ingress=true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create <span style="color:#f92672">-f</span> <span style="color:#66d9ef">mandatory</span>.yaml
</span></span></code></pre></div><p>使用示例：<code>myblog/deployment/ingress.yaml </code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">myblog.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>ingress-nginx动态生成upstream配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">server_name myblog.luffy.com ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">listen 80  ;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">listen [::]:80  ;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">listen 443  ssl http2 ;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">listen [::]:443  ssl http2 ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">set $proxy_upstream_name &#34;-&#34;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">ssl_certificate_by_lua_block {</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">certificate.call()</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">location / {</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">set $namespace      &#34;luffy&#34;;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ae81ff">set $ingress_name   &#34;myblog&#34;;</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">...</span>
</span></span></code></pre></div><h6 id="访问">访问<a hidden class="anchor" aria-hidden="true" href="#访问">#</a></h6>
<p>域名解析服务，将 <code>myblog.luffy.com</code>解析到ingress的地址上。ingress是支持多副本的，高可用的情况下，生产的配置是使用lb服务（内网F5设备，公网elb、slb、clb，解析到各ingress的机器，如何域名指向lb地址）</p>
<p>本机，添加如下hosts记录来演示效果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#ae81ff">172.21</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#ae81ff">51.67</span> <span style="color:#960050;background-color:#1e0010">myblog.luffy.com</span>
</span></span></code></pre></div><p>然后，访问 <a href="http://myblog.luffy.com/blog/index/">http://myblog.luffy.com/blog/index/</a></p>
<p>HTTPS访问：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#自签名证书</span>
</span></span><span style="display:flex;"><span>$ openssl req -x509 -nodes -days 2920 -newkey rsa<span style="color:#960050;background-color:#1e0010">:</span>2048 -keyout tls.key -out tls.crt -subj <span style="color:#e6db74">&#34;/CN=*.luffy.com/O=ingress-nginx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 证书信息保存到secret对象中，ingress-nginx会读取secret对象解析出证书加载到nginx配置中</span>
</span></span><span style="display:flex;"><span>$ kubectl -n luffy create secret tls https-secret --key tls.key --cert tls.crt
</span></span></code></pre></div><p>修改yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myblog-tls</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">myblog.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">myblog.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">https-secret</span>
</span></span></code></pre></div><p>然后，访问 <a href="https://myblog.luffy.com/blog/index/">https://myblog.luffy.com/blog/index/</a></p>
<h6 id="多路径转发及重写的实现">多路径转发及重写的实现<a hidden class="anchor" aria-hidden="true" href="#多路径转发及重写的实现">#</a></h6>
<ol>
<li>
<p>多path转发示例：</p>
<p>目标：</p>
</li>
</ol>
<pre tabindex="0"><code class="language-none" data-lang="none">myblog.luffy.com -&gt; 172.21.51.67 -&gt; /foo   service1:4200
                                      /bar   service2:8080
                                      /		 myblog:80
</code></pre><p>​	 实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">simple-fanout-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">myblog.luffy.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/foo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">4200</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/bar</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">service2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><ol start="2">
<li>
<p>nginx的URL重写</p>
<p>目标：</p>
<pre tabindex="0"><code>myblog.luffy.com -&gt; 172.21.51.67 -&gt; /foo/    myblog:80/admin/
</code></pre></li>
</ol>
<p>实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>   <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">name</span>: <span style="color:#ae81ff">rewrite-path</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">luffy</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/admin/$1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">myblog.luffy.com</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/foo/(.*)</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">myblog</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h4 id="小结-1">小结<a hidden class="anchor" aria-hidden="true" href="#小结-1">#</a></h4>
<ol>
<li>核心讲如何通过k8s管理业务应用</li>
<li>介绍k8s的架构、核心组件和工作流程，使用kubeadm快速安装k8s集群</li>
<li>定义Pod.yaml，将myblog和mysql打包在同一个Pod中，myblog使用localhost访问mysql</li>
<li>mysql数据持久化，为myblog业务应用添加了健康检查和资源限制</li>
<li>将myblog与mysql拆分，使用独立的Pod管理</li>
<li>yaml文件中的环境变量存在账号密码明文等敏感信息，使用configMap和Secret来统一配置，优化部署</li>
<li>只用Pod去直接管理业务应用，对于多副本的需求，很难实现，因此使用Deployment Workload</li>
<li>有了多副本，多个Pod如何去实现LB入口，因此引入了Service的资源类型，有CLusterIp和NodePort</li>
<li>ClusterIP是四层的IP地址，不固定，不具备跨环境迁移，因此利用coredns实现集群内服务发现，组件之间直接通过Service名称通信，实现配置的去IP化</li>
<li>对Django应用做改造，django直接使用mysql:3306实现数据库访问</li>
<li>为了实现在集群外部对集群内服务的访问，因此创建NodePort类型的Service</li>
<li>介绍了Service的实现原理，通过kube-proxy利用iptables或者ipvs维护服务访问规则，实现虚拟IP转发到具体Pod的需求</li>
<li>为了实现集群外使用域名访问myblog，因此引入Ingress资源，通过定义访问规则，实现七层代理</li>
<li>考虑真实的场景，对Ingress的使用做了拓展，介绍多path转发及nginx URL重写的实现</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iblog.zone/tags/docker/">docker</a></li>
      <li><a href="https://iblog.zone/tags/k8s/">k8s</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://iblog.zone/archives/kubernetes%E8%BF%9B%E9%98%B6%E5%AE%9E%E8%B7%B5/">
    <span class="title">« 上一页</span>
    <br>
    <span>Kubernetes进阶实践</span>
  </a>
  <a class="next" href="https://iblog.zone/archives/etcd-v3%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/">
    <span class="title">下一页 »</span>
    <br>
    <span>Etcd v3备份与恢复</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://iblog.zone">ylw&#39;s blog</a></span>
    <span>
	& <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021039488号</a>
    </span>

    总访客：<span id="busuanzi_value_site_uv"></span>
    总浏览量：<span id="busuanzi_value_site_pv"></span>
    页面访问量：<span id="busuanzi_value_page_pv"></span>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
